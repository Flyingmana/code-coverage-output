<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - tests.info - pdo/pdo_stmt.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">pdo</a> - pdo_stmt.c<span style="font-size: 80%;"> (source / <a href="pdo_stmt.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">tests.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">962</td>
            <td class="headerCovTableEntry">1329</td>
            <td class="headerCovTableEntryLo">72.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-11-29 14:13:02</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">61</td>
            <td class="headerCovTableEntry">65</td>
            <td class="headerCovTableEntryHi">93.8 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<a name="2"><span class="lineNum">       2 </span>            :   +----------------------------------------------------------------------+</a>
<a name="3"><span class="lineNum">       3 </span>            :   | Copyright (c) The PHP Group                                          |</a>
<a name="4"><span class="lineNum">       4 </span>            :   +----------------------------------------------------------------------+</a>
<a name="5"><span class="lineNum">       5 </span>            :   | This source file is subject to version 3.01 of the PHP license,      |</a>
<a name="6"><span class="lineNum">       6 </span>            :   | that is bundled with this package in the file LICENSE, and is        |</a>
<a name="7"><span class="lineNum">       7 </span>            :   | available through the world-wide-web at the following url:           |</a>
<a name="8"><span class="lineNum">       8 </span>            :   | https://www.php.net/license/3_01.txt                                 |</a>
<a name="9"><span class="lineNum">       9 </span>            :   | If you did not receive a copy of the PHP license and are unable to   |</a>
<a name="10"><span class="lineNum">      10 </span>            :   | obtain it through the world-wide-web, please send a note to          |</a>
<a name="11"><span class="lineNum">      11 </span>            :   | license@php.net so we can mail you a copy immediately.               |</a>
<a name="12"><span class="lineNum">      12 </span>            :   +----------------------------------------------------------------------+</a>
<a name="13"><span class="lineNum">      13 </span>            :   | Author: Wez Furlong &lt;wez@php.net&gt;                                    |</a>
<a name="14"><span class="lineNum">      14 </span>            :   |         Marcus Boerger &lt;helly@php.net&gt;                               |</a>
<a name="15"><span class="lineNum">      15 </span>            :   |         Sterling Hughes &lt;sterling@php.net&gt;                           |</a>
<a name="16"><span class="lineNum">      16 </span>            :   +----------------------------------------------------------------------+</a>
<a name="17"><span class="lineNum">      17 </span>            : */</a>
<a name="18"><span class="lineNum">      18 </span>            : </a>
<a name="19"><span class="lineNum">      19 </span>            : /* The PDO Statement Handle Class */</a>
<a name="20"><span class="lineNum">      20 </span>            : </a>
<a name="21"><span class="lineNum">      21 </span>            : #ifdef HAVE_CONFIG_H</a>
<a name="22"><span class="lineNum">      22 </span>            : #include &quot;config.h&quot;</a>
<a name="23"><span class="lineNum">      23 </span>            : #endif</a>
<a name="24"><span class="lineNum">      24 </span>            : </a>
<a name="25"><span class="lineNum">      25 </span>            : #include &quot;php.h&quot;</a>
<a name="26"><span class="lineNum">      26 </span>            : #include &quot;php_ini.h&quot;</a>
<a name="27"><span class="lineNum">      27 </span>            : #include &quot;ext/standard/info.h&quot;</a>
<a name="28"><span class="lineNum">      28 </span>            : #include &quot;ext/standard/php_var.h&quot;</a>
<a name="29"><span class="lineNum">      29 </span>            : #include &quot;php_pdo.h&quot;</a>
<a name="30"><span class="lineNum">      30 </span>            : #include &quot;php_pdo_driver.h&quot;</a>
<a name="31"><span class="lineNum">      31 </span>            : #include &quot;php_pdo_int.h&quot;</a>
<a name="32"><span class="lineNum">      32 </span>            : #include &quot;zend_exceptions.h&quot;</a>
<a name="33"><span class="lineNum">      33 </span>            : #include &quot;zend_interfaces.h&quot;</a>
<a name="34"><span class="lineNum">      34 </span>            : #include &quot;php_memory_streams.h&quot;</a>
<a name="35"><span class="lineNum">      35 </span>            : #include &quot;pdo_stmt_arginfo.h&quot;</a>
<a name="36"><span class="lineNum">      36 </span>            : </a>
<a name="37"><span class="lineNum">      37 </span>            : #define PHP_STMT_GET_OBJ \</a>
<a name="38"><span class="lineNum">      38 </span>            :         pdo_stmt_t *stmt = Z_PDO_STMT_P(ZEND_THIS); \</a>
<a name="39"><span class="lineNum">      39 </span>            :         if (!stmt-&gt;dbh) { \</a>
<a name="40"><span class="lineNum">      40 </span>            :                 zend_throw_error(NULL, &quot;PDO object is uninitialized&quot;); \</a>
<a name="41"><span class="lineNum">      41 </span>            :                 RETURN_THROWS(); \</a>
<a name="42"><span class="lineNum">      42 </span>            :         } \</a>
<a name="43"><span class="lineNum">      43 </span>            : </a>
<a name="44"><span class="lineNum">      44 </span><span class="lineCov">        480 : static inline bool rewrite_name_to_position(pdo_stmt_t *stmt, struct pdo_bound_param_data *param) /* {{{ */</span></a>
<a name="45"><span class="lineNum">      45 </span>            : {</a>
<a name="46"><span class="lineNum">      46 </span><span class="lineCov">        480 :         if (stmt-&gt;bound_param_map) {</span></a>
<a name="47"><span class="lineNum">      47 </span>            :                 /* rewriting :name to ? style.</a>
<a name="48"><span class="lineNum">      48 </span>            :                  * We need to fixup the parameter numbers on the parameters.</a>
<a name="49"><span class="lineNum">      49 </span>            :                  * If we find that a given named parameter has been used twice,</a>
<a name="50"><span class="lineNum">      50 </span>            :                  * we will raise an error, as we can't be sure that it is safe</a>
<a name="51"><span class="lineNum">      51 </span>            :                  * to bind multiple parameters onto the same zval in the underlying</a>
<a name="52"><span class="lineNum">      52 </span>            :                  * driver */</a>
<a name="53"><span class="lineNum">      53 </span>            :                 zend_string *name;</a>
<a name="54"><span class="lineNum">      54 </span><span class="lineNoCov">          0 :                 int position = 0;</span></a>
<a name="55"><span class="lineNum">      55 </span>            : </a>
<a name="56"><span class="lineNum">      56 </span><span class="lineNoCov">          0 :                 if (stmt-&gt;named_rewrite_template) {</span></a>
<a name="57"><span class="lineNum">      57 </span>            :                         /* this is not an error here */</a>
<a name="58"><span class="lineNum">      58 </span><span class="lineNoCov">          0 :                         return 1;</span></a>
<a name="59"><span class="lineNum">      59 </span>            :                 }</a>
<a name="60"><span class="lineNum">      60 </span><span class="lineNoCov">          0 :                 if (!param-&gt;name) {</span></a>
<a name="61"><span class="lineNum">      61 </span>            :                         /* do the reverse; map the parameter number to the name */</a>
<a name="62"><span class="lineNum">      62 </span><span class="lineNoCov">          0 :                         if ((name = zend_hash_index_find_ptr(stmt-&gt;bound_param_map, param-&gt;paramno)) != NULL) {</span></a>
<a name="63"><span class="lineNum">      63 </span><span class="lineNoCov">          0 :                                 param-&gt;name = zend_string_copy(name);</span></a>
<a name="64"><span class="lineNum">      64 </span><span class="lineNoCov">          0 :                                 return 1;</span></a>
<a name="65"><span class="lineNum">      65 </span>            :                         }</a>
<a name="66"><span class="lineNum">      66 </span>            :                         /* TODO Error? */</a>
<a name="67"><span class="lineNum">      67 </span><span class="lineNoCov">          0 :                         pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY093&quot;, &quot;parameter was not defined&quot;);</span></a>
<a name="68"><span class="lineNum">      68 </span><span class="lineNoCov">          0 :                         return 0;</span></a>
<a name="69"><span class="lineNum">      69 </span>            :                 }</a>
<a name="70"><span class="lineNum">      70 </span>            : </a>
<a name="71"><span class="lineNum">      71 </span><span class="lineNoCov">          0 :                 ZEND_HASH_FOREACH_PTR(stmt-&gt;bound_param_map, name) {</span></a>
<a name="72"><span class="lineNum">      72 </span><span class="lineNoCov">          0 :                         if (!zend_string_equals(name, param-&gt;name)) {</span></a>
<a name="73"><span class="lineNum">      73 </span><span class="lineNoCov">          0 :                                 position++;</span></a>
<a name="74"><span class="lineNum">      74 </span><span class="lineNoCov">          0 :                                 continue;</span></a>
<a name="75"><span class="lineNum">      75 </span>            :                         }</a>
<a name="76"><span class="lineNum">      76 </span><span class="lineNoCov">          0 :                         if (param-&gt;paramno &gt;= 0) {</span></a>
<a name="77"><span class="lineNum">      77 </span>            :                                 /* TODO Error? */</a>
<a name="78"><span class="lineNum">      78 </span><span class="lineNoCov">          0 :                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;IM001&quot;, &quot;PDO refuses to handle repeating the same :named parameter for multiple positions with this driver, as it might be unsafe to do so.  Consider using a separate name for each parameter instead&quot;);</span></a>
<a name="79"><span class="lineNum">      79 </span><span class="lineNoCov">          0 :                                 return -1;</span></a>
<a name="80"><span class="lineNum">      80 </span>            :                         }</a>
<a name="81"><span class="lineNum">      81 </span><span class="lineNoCov">          0 :                         param-&gt;paramno = position;</span></a>
<a name="82"><span class="lineNum">      82 </span><span class="lineNoCov">          0 :                         return 1;</span></a>
<a name="83"><span class="lineNum">      83 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="84"><span class="lineNum">      84 </span>            :                 /* TODO Error? */</a>
<a name="85"><span class="lineNum">      85 </span><span class="lineNoCov">          0 :                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY093&quot;, &quot;parameter was not defined&quot;);</span></a>
<a name="86"><span class="lineNum">      86 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="87"><span class="lineNum">      87 </span>            :         }</a>
<a name="88"><span class="lineNum">      88 </span><span class="lineCov">        480 :         return 1;</span></a>
<a name="89"><span class="lineNum">      89 </span>            : }</a>
<a name="90"><span class="lineNum">      90 </span>            : /* }}} */</a>
<a name="91"><span class="lineNum">      91 </span>            : </a>
<a name="92"><span class="lineNum">      92 </span>            : /* trigger callback hook for parameters */</a>
<a name="93"><span class="lineNum">      93 </span><span class="lineCov">       3189 : static bool dispatch_param_event(pdo_stmt_t *stmt, enum pdo_param_event event_type) /* {{{ */</span></a>
<a name="94"><span class="lineNum">      94 </span>            : {</a>
<a name="95"><span class="lineNum">      95 </span><span class="lineCov">       3189 :         bool ret = 1, is_param = 1;</span></a>
<a name="96"><span class="lineNum">      96 </span>            :         struct pdo_bound_param_data *param;</a>
<a name="97"><span class="lineNum">      97 </span>            :         HashTable *ht;</a>
<a name="98"><span class="lineNum">      98 </span>            : </a>
<a name="99"><span class="lineNum">      99 </span><span class="lineCov">       3189 :         if (stmt-&gt;dbh-&gt;skip_param_evt &amp; (1 &lt;&lt; event_type)) {</span></a>
<a name="100"><span class="lineNum">     100 </span><span class="lineCov">       2652 :                 return 1;</span></a>
<a name="101"><span class="lineNum">     101 </span>            :         }</a>
<a name="102"><span class="lineNum">     102 </span>            : </a>
<a name="103"><span class="lineNum">     103 </span><span class="lineCov">        537 :         if (!stmt-&gt;methods-&gt;param_hook) {</span></a>
<a name="104"><span class="lineNum">     104 </span><span class="lineNoCov">          0 :                 return 1;</span></a>
<a name="105"><span class="lineNum">     105 </span>            :         }</a>
<a name="106"><span class="lineNum">     106 </span>            : </a>
<a name="107"><span class="lineNum">     107 </span><span class="lineCov">        537 :         ht = stmt-&gt;bound_params;</span></a>
<a name="108"><span class="lineNum">     108 </span>            : </a>
<a name="109"><span class="lineNum">     109 </span><span class="lineCov">       1059 : iterate:</span></a>
<a name="110"><span class="lineNum">     110 </span><span class="lineCov">       1059 :         if (ht) {</span></a>
<a name="111"><span class="lineNum">     111 </span><span class="lineCov">       1719 :                 ZEND_HASH_FOREACH_PTR(ht, param) {</span></a>
<a name="112"><span class="lineNum">     112 </span><span class="lineCov">        678 :                         if (!stmt-&gt;methods-&gt;param_hook(stmt, param, event_type)) {</span></a>
<a name="113"><span class="lineNum">     113 </span><span class="lineCov">         15 :                                 ret = 0;</span></a>
<a name="114"><span class="lineNum">     114 </span><span class="lineCov">         15 :                                 break;</span></a>
<a name="115"><span class="lineNum">     115 </span>            :                         }</a>
<a name="116"><span class="lineNum">     116 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="117"><span class="lineNum">     117 </span>            :         }</a>
<a name="118"><span class="lineNum">     118 </span><span class="lineCov">       1059 :         if (ret &amp;&amp; is_param) {</span></a>
<a name="119"><span class="lineNum">     119 </span><span class="lineCov">        522 :                 ht = stmt-&gt;bound_columns;</span></a>
<a name="120"><span class="lineNum">     120 </span><span class="lineCov">        522 :                 is_param = 0;</span></a>
<a name="121"><span class="lineNum">     121 </span><span class="lineCov">        522 :                 goto iterate;</span></a>
<a name="122"><span class="lineNum">     122 </span>            :         }</a>
<a name="123"><span class="lineNum">     123 </span>            : </a>
<a name="124"><span class="lineNum">     124 </span><span class="lineCov">        537 :         return ret;</span></a>
<a name="125"><span class="lineNum">     125 </span>            : }</a>
<a name="126"><span class="lineNum">     126 </span>            : /* }}} */</a>
<a name="127"><span class="lineNum">     127 </span>            : </a>
<a name="128"><span class="lineNum">     128 </span><span class="lineCov">        591 : bool pdo_stmt_describe_columns(pdo_stmt_t *stmt) /* {{{ */</span></a>
<a name="129"><span class="lineNum">     129 </span>            : {</a>
<a name="130"><span class="lineNum">     130 </span>            :         int col;</a>
<a name="131"><span class="lineNum">     131 </span>            : </a>
<a name="132"><span class="lineNum">     132 </span><span class="lineCov">        591 :         stmt-&gt;columns = ecalloc(stmt-&gt;column_count, sizeof(struct pdo_column_data));</span></a>
<a name="133"><span class="lineNum">     133 </span>            : </a>
<a name="134"><span class="lineNum">     134 </span><span class="lineCov">       1326 :         for (col = 0; col &lt; stmt-&gt;column_count; col++) {</span></a>
<a name="135"><span class="lineNum">     135 </span><span class="lineCov">        735 :                 if (!stmt-&gt;methods-&gt;describer(stmt, col)) {</span></a>
<a name="136"><span class="lineNum">     136 </span><span class="lineNoCov">          0 :                         return false;</span></a>
<a name="137"><span class="lineNum">     137 </span>            :                 }</a>
<a name="138"><span class="lineNum">     138 </span>            : </a>
<a name="139"><span class="lineNum">     139 </span>            :                 /* if we are applying case conversions on column names, do so now */</a>
<a name="140"><span class="lineNum">     140 </span><span class="lineCov">        735 :                 if (stmt-&gt;dbh-&gt;native_case != stmt-&gt;dbh-&gt;desired_case &amp;&amp; stmt-&gt;dbh-&gt;desired_case != PDO_CASE_NATURAL) {</span></a>
<a name="141"><span class="lineNum">     141 </span><span class="lineCov">        549 :                         zend_string *orig_name = stmt-&gt;columns[col].name;</span></a>
<a name="142"><span class="lineNum">     142 </span><span class="lineCov">        549 :                         switch (stmt-&gt;dbh-&gt;desired_case) {</span></a>
<a name="143"><span class="lineNum">     143 </span><span class="lineCov">        543 :                                 case PDO_CASE_LOWER:</span></a>
<a name="144"><span class="lineNum">     144 </span><span class="lineCov">        543 :                                         stmt-&gt;columns[col].name = zend_string_tolower(orig_name);</span></a>
<a name="145"><span class="lineNum">     145 </span>            :                                         zend_string_release(orig_name);</a>
<a name="146"><span class="lineNum">     146 </span><span class="lineCov">        543 :                                         break;</span></a>
<a name="147"><span class="lineNum">     147 </span><span class="lineCov">          6 :                                 case PDO_CASE_UPPER: {</span></a>
<a name="148"><span class="lineNum">     148 </span><span class="lineCov">          6 :                                         stmt-&gt;columns[col].name = zend_string_separate(orig_name, 0);</span></a>
<a name="149"><span class="lineNum">     149 </span><span class="lineCov">          6 :                                         char *s = ZSTR_VAL(stmt-&gt;columns[col].name);</span></a>
<a name="150"><span class="lineNum">     150 </span><span class="lineCov">         21 :                                         while (*s != '\0') {</span></a>
<a name="151"><span class="lineNum">     151 </span><span class="lineCov">         15 :                                                 *s = toupper(*s);</span></a>
<a name="152"><span class="lineNum">     152 </span><span class="lineCov">         15 :                                                 s++;</span></a>
<a name="153"><span class="lineNum">     153 </span>            :                                         }</a>
<a name="154"><span class="lineNum">     154 </span><span class="lineCov">          6 :                                         break;</span></a>
<a name="155"><span class="lineNum">     155 </span>            :                                 }</a>
<a name="156"><span class="lineNum">     156 </span><span class="lineNoCov">          0 :                                 EMPTY_SWITCH_DEFAULT_CASE()</span></a>
<a name="157"><span class="lineNum">     157 </span>            :                         }</a>
<a name="158"><span class="lineNum">     158 </span><span class="lineCov">        186 :                 }</span></a>
<a name="159"><span class="lineNum">     159 </span>            : </a>
<a name="160"><span class="lineNum">     160 </span>            :                 /* update the column index on named bound parameters */</a>
<a name="161"><span class="lineNum">     161 </span><span class="lineCov">        735 :                 if (stmt-&gt;bound_columns) {</span></a>
<a name="162"><span class="lineNum">     162 </span>            :                         struct pdo_bound_param_data *param;</a>
<a name="163"><span class="lineNum">     163 </span>            : </a>
<a name="164"><span class="lineNum">     164 </span><span class="lineNoCov">          0 :                         if ((param = zend_hash_find_ptr(stmt-&gt;bound_columns,</span></a>
<a name="165"><span class="lineNum">     165 </span><span class="lineNoCov">          0 :                                         stmt-&gt;columns[col].name)) != NULL) {</span></a>
<a name="166"><span class="lineNum">     166 </span><span class="lineNoCov">          0 :                                 param-&gt;paramno = col;</span></a>
<a name="167"><span class="lineNum">     167 </span>            :                         }</a>
<a name="168"><span class="lineNum">     168 </span>            :                 }</a>
<a name="169"><span class="lineNum">     169 </span>            : </a>
<a name="170"><span class="lineNum">     170 </span>            :         }</a>
<a name="171"><span class="lineNum">     171 </span><span class="lineCov">        591 :         return true;</span></a>
<a name="172"><span class="lineNum">     172 </span>            : }</a>
<a name="173"><span class="lineNum">     173 </span>            : /* }}} */</a>
<a name="174"><span class="lineNum">     174 </span>            : </a>
<a name="175"><span class="lineNum">     175 </span><span class="lineCov">        690 : static void pdo_stmt_reset_columns(pdo_stmt_t *stmt) {</span></a>
<a name="176"><span class="lineNum">     176 </span><span class="lineCov">        690 :         if (stmt-&gt;columns) {</span></a>
<a name="177"><span class="lineNum">     177 </span>            :                 int i;</a>
<a name="178"><span class="lineNum">     178 </span><span class="lineCov">        591 :                 struct pdo_column_data *cols = stmt-&gt;columns;</span></a>
<a name="179"><span class="lineNum">     179 </span>            : </a>
<a name="180"><span class="lineNum">     180 </span><span class="lineCov">       1326 :                 for (i = 0; i &lt; stmt-&gt;column_count; i++) {</span></a>
<a name="181"><span class="lineNum">     181 </span><span class="lineCov">        735 :                         if (cols[i].name) {</span></a>
<a name="182"><span class="lineNum">     182 </span><span class="lineCov">        735 :                                 zend_string_release_ex(cols[i].name, 0);</span></a>
<a name="183"><span class="lineNum">     183 </span>            :                         }</a>
<a name="184"><span class="lineNum">     184 </span>            :                 }</a>
<a name="185"><span class="lineNum">     185 </span><span class="lineCov">        591 :                 efree(stmt-&gt;columns);</span></a>
<a name="186"><span class="lineNum">     186 </span>            :         }</a>
<a name="187"><span class="lineNum">     187 </span><span class="lineCov">        690 :         stmt-&gt;columns = NULL;</span></a>
<a name="188"><span class="lineNum">     188 </span><span class="lineCov">        690 :         stmt-&gt;column_count = 0;</span></a>
<a name="189"><span class="lineNum">     189 </span><span class="lineCov">        690 : }</span></a>
<a name="190"><span class="lineNum">     190 </span>            : </a>
<a name="191"><span class="lineNum">     191 </span>            : /**</a>
<a name="192"><span class="lineNum">     192 </span>            :  * Change the column count on the statement. If it differs from the previous one,</a>
<a name="193"><span class="lineNum">     193 </span>            :  * discard existing columns information.</a>
<a name="194"><span class="lineNum">     194 </span>            :  */</a>
<a name="195"><span class="lineNum">     195 </span><span class="lineCov">        846 : PDO_API void php_pdo_stmt_set_column_count(pdo_stmt_t *stmt, int new_count)</span></a>
<a name="196"><span class="lineNum">     196 </span>            : {</a>
<a name="197"><span class="lineNum">     197 </span>            :         /* Columns not yet &quot;described&quot;. */</a>
<a name="198"><span class="lineNum">     198 </span><span class="lineCov">        846 :         if (!stmt-&gt;columns) {</span></a>
<a name="199"><span class="lineNum">     199 </span><span class="lineCov">        588 :                 stmt-&gt;column_count = new_count;</span></a>
<a name="200"><span class="lineNum">     200 </span><span class="lineCov">        588 :                 return;</span></a>
<a name="201"><span class="lineNum">     201 </span>            :         }</a>
<a name="202"><span class="lineNum">     202 </span>            : </a>
<a name="203"><span class="lineNum">     203 </span>            :         /* The column count has not changed: No need to reload columns description.</a>
<a name="204"><span class="lineNum">     204 </span>            :          * Note: Do not handle attribute name change, without column count change. */</a>
<a name="205"><span class="lineNum">     205 </span><span class="lineCov">        258 :         if (new_count == stmt-&gt;column_count) {</span></a>
<a name="206"><span class="lineNum">     206 </span><span class="lineCov">        255 :                 return;</span></a>
<a name="207"><span class="lineNum">     207 </span>            :         }</a>
<a name="208"><span class="lineNum">     208 </span>            : </a>
<a name="209"><span class="lineNum">     209 </span>            :         /* Free previous columns to force reload description. */</a>
<a name="210"><span class="lineNum">     210 </span><span class="lineCov">          3 :         pdo_stmt_reset_columns(stmt);</span></a>
<a name="211"><span class="lineNum">     211 </span><span class="lineCov">          3 :         stmt-&gt;column_count = new_count;</span></a>
<a name="212"><span class="lineNum">     212 </span>            : }</a>
<a name="213"><span class="lineNum">     213 </span>            : </a>
<a name="214"><span class="lineNum">     214 </span><span class="lineCov">         18 : static void get_lazy_object(pdo_stmt_t *stmt, zval *return_value) /* {{{ */</span></a>
<a name="215"><span class="lineNum">     215 </span>            : {</a>
<a name="216"><span class="lineNum">     216 </span><span class="lineCov">         36 :         if (Z_ISUNDEF(stmt-&gt;lazy_object_ref)) {</span></a>
<a name="217"><span class="lineNum">     217 </span><span class="lineCov">         15 :                 pdo_row_t *row = ecalloc(1, sizeof(pdo_row_t));</span></a>
<a name="218"><span class="lineNum">     218 </span><span class="lineCov">         15 :                 row-&gt;stmt = stmt;</span></a>
<a name="219"><span class="lineNum">     219 </span><span class="lineCov">         15 :                 zend_object_std_init(&amp;row-&gt;std, pdo_row_ce);</span></a>
<a name="220"><span class="lineNum">     220 </span><span class="lineCov">         15 :                 ZVAL_OBJ(&amp;stmt-&gt;lazy_object_ref, &amp;row-&gt;std);</span></a>
<a name="221"><span class="lineNum">     221 </span><span class="lineCov">         15 :                 row-&gt;std.handlers = &amp;pdo_row_object_handlers;</span></a>
<a name="222"><span class="lineNum">     222 </span><span class="lineCov">         15 :                 GC_ADDREF(&amp;stmt-&gt;std);</span></a>
<a name="223"><span class="lineNum">     223 </span><span class="lineCov">         15 :                 GC_DELREF(&amp;row-&gt;std);</span></a>
<a name="224"><span class="lineNum">     224 </span>            :         }</a>
<a name="225"><span class="lineNum">     225 </span><span class="lineCov">         18 :         ZVAL_COPY(return_value, &amp;stmt-&gt;lazy_object_ref);</span></a>
<a name="226"><span class="lineNum">     226 </span><span class="lineCov">         18 : }</span></a>
<a name="227"><span class="lineNum">     227 </span>            : /* }}} */</a>
<a name="228"><span class="lineNum">     228 </span>            : </a>
<a name="229"><span class="lineNum">     229 </span><span class="lineCov">        540 : static void param_dtor(zval *el) /* {{{ */</span></a>
<a name="230"><span class="lineNum">     230 </span>            : {</a>
<a name="231"><span class="lineNum">     231 </span><span class="lineCov">        540 :         struct pdo_bound_param_data *param = (struct pdo_bound_param_data *)Z_PTR_P(el);</span></a>
<a name="232"><span class="lineNum">     232 </span>            : </a>
<a name="233"><span class="lineNum">     233 </span>            :         /* tell the driver that it is going away */</a>
<a name="234"><span class="lineNum">     234 </span><span class="lineCov">        540 :         if (param-&gt;stmt-&gt;methods-&gt;param_hook) {</span></a>
<a name="235"><span class="lineNum">     235 </span><span class="lineCov">        540 :                 param-&gt;stmt-&gt;methods-&gt;param_hook(param-&gt;stmt, param, PDO_PARAM_EVT_FREE);</span></a>
<a name="236"><span class="lineNum">     236 </span>            :         }</a>
<a name="237"><span class="lineNum">     237 </span>            : </a>
<a name="238"><span class="lineNum">     238 </span><span class="lineCov">        540 :         if (param-&gt;name) {</span></a>
<a name="239"><span class="lineNum">     239 </span><span class="lineCov">        246 :                 zend_string_release_ex(param-&gt;name, 0);</span></a>
<a name="240"><span class="lineNum">     240 </span>            :         }</a>
<a name="241"><span class="lineNum">     241 </span>            : </a>
<a name="242"><span class="lineNum">     242 </span><span class="lineCov">       1080 :         if (!Z_ISUNDEF(param-&gt;parameter)) {</span></a>
<a name="243"><span class="lineNum">     243 </span><span class="lineCov">        540 :                 zval_ptr_dtor(&amp;param-&gt;parameter);</span></a>
<a name="244"><span class="lineNum">     244 </span><span class="lineCov">        540 :                 ZVAL_UNDEF(&amp;param-&gt;parameter);</span></a>
<a name="245"><span class="lineNum">     245 </span>            :         }</a>
<a name="246"><span class="lineNum">     246 </span><span class="lineCov">       1080 :         if (!Z_ISUNDEF(param-&gt;driver_params)) {</span></a>
<a name="247"><span class="lineNum">     247 </span><span class="lineNoCov">          0 :                 zval_ptr_dtor(&amp;param-&gt;driver_params);</span></a>
<a name="248"><span class="lineNum">     248 </span>            :         }</a>
<a name="249"><span class="lineNum">     249 </span><span class="lineCov">        540 :         efree(param);</span></a>
<a name="250"><span class="lineNum">     250 </span><span class="lineCov">        540 : }</span></a>
<a name="251"><span class="lineNum">     251 </span>            : /* }}} */</a>
<a name="252"><span class="lineNum">     252 </span>            : </a>
<a name="253"><span class="lineNum">     253 </span><span class="lineCov">        540 : static bool really_register_bound_param(struct pdo_bound_param_data *param, pdo_stmt_t *stmt, bool is_param) /* {{{ */</span></a>
<a name="254"><span class="lineNum">     254 </span>            : {</a>
<a name="255"><span class="lineNum">     255 </span>            :         HashTable *hash;</a>
<a name="256"><span class="lineNum">     256 </span>            :         zval *parameter;</a>
<a name="257"><span class="lineNum">     257 </span><span class="lineCov">        540 :         struct pdo_bound_param_data *pparam = NULL;</span></a>
<a name="258"><span class="lineNum">     258 </span>            : </a>
<a name="259"><span class="lineNum">     259 </span><span class="lineCov">        540 :         hash = is_param ? stmt-&gt;bound_params : stmt-&gt;bound_columns;</span></a>
<a name="260"><span class="lineNum">     260 </span>            : </a>
<a name="261"><span class="lineNum">     261 </span><span class="lineCov">        540 :         if (!hash) {</span></a>
<a name="262"><span class="lineNum">     262 </span><span class="lineCov">        231 :                 ALLOC_HASHTABLE(hash);</span></a>
<a name="263"><span class="lineNum">     263 </span><span class="lineCov">        231 :                 zend_hash_init(hash, 13, NULL, param_dtor, 0);</span></a>
<a name="264"><span class="lineNum">     264 </span>            : </a>
<a name="265"><span class="lineNum">     265 </span><span class="lineCov">        231 :                 if (is_param) {</span></a>
<a name="266"><span class="lineNum">     266 </span><span class="lineCov">        207 :                         stmt-&gt;bound_params = hash;</span></a>
<a name="267"><span class="lineNum">     267 </span>            :                 } else {</a>
<a name="268"><span class="lineNum">     268 </span><span class="lineCov">         24 :                         stmt-&gt;bound_columns = hash;</span></a>
<a name="269"><span class="lineNum">     269 </span>            :                 }</a>
<a name="270"><span class="lineNum">     270 </span>            :         }</a>
<a name="271"><span class="lineNum">     271 </span>            : </a>
<a name="272"><span class="lineNum">     272 </span><span class="lineCov">       1080 :         if (!Z_ISREF(param-&gt;parameter)) {</span></a>
<a name="273"><span class="lineNum">     273 </span><span class="lineCov">        441 :                 parameter = &amp;param-&gt;parameter;</span></a>
<a name="274"><span class="lineNum">     274 </span>            :         } else {</a>
<a name="275"><span class="lineNum">     275 </span><span class="lineCov">         99 :                 parameter = Z_REFVAL(param-&gt;parameter);</span></a>
<a name="276"><span class="lineNum">     276 </span>            :         }</a>
<a name="277"><span class="lineNum">     277 </span>            : </a>
<a name="278"><span class="lineNum">     278 </span><span class="lineCov">       1047 :         if (PDO_PARAM_TYPE(param-&gt;param_type) == PDO_PARAM_STR &amp;&amp; param-&gt;max_value_len &lt;= 0 &amp;&amp; !Z_ISNULL_P(parameter)) {</span></a>
<a name="279"><span class="lineNum">     279 </span><span class="lineCov">        450 :                 if (!try_convert_to_string(parameter)) {</span></a>
<a name="280"><span class="lineNum">     280 </span><span class="lineNoCov">          0 :                         return 0;</span></a>
<a name="281"><span class="lineNum">     281 </span>            :                 }</a>
<a name="282"><span class="lineNum">     282 </span><span class="lineCov">        126 :         } else if (PDO_PARAM_TYPE(param-&gt;param_type) == PDO_PARAM_INT &amp;&amp; (Z_TYPE_P(parameter) == IS_FALSE || Z_TYPE_P(parameter) == IS_TRUE)) {</span></a>
<a name="283"><span class="lineNum">     283 </span><span class="lineCov">          3 :                 convert_to_long(parameter);</span></a>
<a name="284"><span class="lineNum">     284 </span><span class="lineCov">         87 :         } else if (PDO_PARAM_TYPE(param-&gt;param_type) == PDO_PARAM_BOOL &amp;&amp; Z_TYPE_P(parameter) == IS_LONG) {</span></a>
<a name="285"><span class="lineNum">     285 </span><span class="lineNoCov">          0 :                 convert_to_boolean(parameter);</span></a>
<a name="286"><span class="lineNum">     286 </span>            :         }</a>
<a name="287"><span class="lineNum">     287 </span>            : </a>
<a name="288"><span class="lineNum">     288 </span><span class="lineCov">        540 :         param-&gt;stmt = stmt;</span></a>
<a name="289"><span class="lineNum">     289 </span><span class="lineCov">        540 :         param-&gt;is_param = is_param;</span></a>
<a name="290"><span class="lineNum">     290 </span>            : </a>
<a name="291"><span class="lineNum">     291 </span><span class="lineCov">        540 :         if (Z_REFCOUNTED(param-&gt;driver_params)) {</span></a>
<a name="292"><span class="lineNum">     292 </span><span class="lineNoCov">          0 :                 Z_ADDREF(param-&gt;driver_params);</span></a>
<a name="293"><span class="lineNum">     293 </span>            :         }</a>
<a name="294"><span class="lineNum">     294 </span>            : </a>
<a name="295"><span class="lineNum">     295 </span><span class="lineCov">        540 :         if (!is_param &amp;&amp; param-&gt;name &amp;&amp; stmt-&gt;columns) {</span></a>
<a name="296"><span class="lineNum">     296 </span>            :                 /* try to map the name to the column */</a>
<a name="297"><span class="lineNum">     297 </span>            :                 int i;</a>
<a name="298"><span class="lineNum">     298 </span>            : </a>
<a name="299"><span class="lineNum">     299 </span><span class="lineCov">         75 :                 for (i = 0; i &lt; stmt-&gt;column_count; i++) {</span></a>
<a name="300"><span class="lineNum">     300 </span><span class="lineCov">        150 :                         if (zend_string_equals(stmt-&gt;columns[i].name, param-&gt;name)) {</span></a>
<a name="301"><span class="lineNum">     301 </span><span class="lineCov">         60 :                                 param-&gt;paramno = i;</span></a>
<a name="302"><span class="lineNum">     302 </span><span class="lineCov">         60 :                                 break;</span></a>
<a name="303"><span class="lineNum">     303 </span>            :                         }</a>
<a name="304"><span class="lineNum">     304 </span>            :                 }</a>
<a name="305"><span class="lineNum">     305 </span>            : </a>
<a name="306"><span class="lineNum">     306 </span>            :                 /* if you prepare and then execute passing an array of params keyed by names,</a>
<a name="307"><span class="lineNum">     307 </span>            :                  * then this will trigger, and we don't want that */</a>
<a name="308"><span class="lineNum">     308 </span><span class="lineCov">         60 :                 if (param-&gt;paramno == -1) {</span></a>
<a name="309"><span class="lineNum">     309 </span>            :                         /* Should this always be an Error? */</a>
<a name="310"><span class="lineNum">     310 </span>            :                         char *tmp;</a>
<a name="311"><span class="lineNum">     311 </span>            :                         /* TODO Error? */</a>
<a name="312"><span class="lineNum">     312 </span><span class="lineNoCov">          0 :                         spprintf(&amp;tmp, 0, &quot;Did not find column name '%s' in the defined columns; it will not be bound&quot;, ZSTR_VAL(param-&gt;name));</span></a>
<a name="313"><span class="lineNum">     313 </span><span class="lineNoCov">          0 :                         pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, tmp);</span></a>
<a name="314"><span class="lineNum">     314 </span><span class="lineNoCov">          0 :                         efree(tmp);</span></a>
<a name="315"><span class="lineNum">     315 </span>            :                 }</a>
<a name="316"><span class="lineNum">     316 </span>            :         }</a>
<a name="317"><span class="lineNum">     317 </span>            : </a>
<a name="318"><span class="lineNum">     318 </span><span class="lineCov">        540 :         if (param-&gt;name) {</span></a>
<a name="319"><span class="lineNum">     319 </span><span class="lineCov">        246 :                 if (is_param &amp;&amp; ZSTR_VAL(param-&gt;name)[0] != ':') {</span></a>
<a name="320"><span class="lineNum">     320 </span><span class="lineCov">         60 :                         zend_string *temp = zend_string_alloc(ZSTR_LEN(param-&gt;name) + 1, 0);</span></a>
<a name="321"><span class="lineNum">     321 </span><span class="lineCov">         60 :                         ZSTR_VAL(temp)[0] = ':';</span></a>
<a name="322"><span class="lineNum">     322 </span><span class="lineCov">         60 :                         memmove(ZSTR_VAL(temp) + 1, ZSTR_VAL(param-&gt;name), ZSTR_LEN(param-&gt;name) + 1);</span></a>
<a name="323"><span class="lineNum">     323 </span><span class="lineCov">         60 :                         param-&gt;name = temp;</span></a>
<a name="324"><span class="lineNum">     324 </span>            :                 } else {</a>
<a name="325"><span class="lineNum">     325 </span><span class="lineCov">        372 :                         param-&gt;name = zend_string_init(ZSTR_VAL(param-&gt;name), ZSTR_LEN(param-&gt;name), 0);</span></a>
<a name="326"><span class="lineNum">     326 </span>            :                 }</a>
<a name="327"><span class="lineNum">     327 </span>            :         }</a>
<a name="328"><span class="lineNum">     328 </span>            : </a>
<a name="329"><span class="lineNum">     329 </span><span class="lineCov">        540 :         if (is_param &amp;&amp; !rewrite_name_to_position(stmt, param)) {</span></a>
<a name="330"><span class="lineNum">     330 </span><span class="lineNoCov">          0 :                 if (param-&gt;name) {</span></a>
<a name="331"><span class="lineNum">     331 </span><span class="lineNoCov">          0 :                         zend_string_release_ex(param-&gt;name, 0);</span></a>
<a name="332"><span class="lineNum">     332 </span><span class="lineNoCov">          0 :                         param-&gt;name = NULL;</span></a>
<a name="333"><span class="lineNum">     333 </span>            :                 }</a>
<a name="334"><span class="lineNum">     334 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="335"><span class="lineNum">     335 </span>            :         }</a>
<a name="336"><span class="lineNum">     336 </span>            : </a>
<a name="337"><span class="lineNum">     337 </span>            :         /* ask the driver to perform any normalization it needs on the</a>
<a name="338"><span class="lineNum">     338 </span>            :          * parameter name.  Note that it is illegal for the driver to take</a>
<a name="339"><span class="lineNum">     339 </span>            :          * a reference to param, as it resides in transient storage only</a>
<a name="340"><span class="lineNum">     340 </span>            :          * at this time. */</a>
<a name="341"><span class="lineNum">     341 </span><span class="lineCov">        540 :         if (stmt-&gt;methods-&gt;param_hook) {</span></a>
<a name="342"><span class="lineNum">     342 </span><span class="lineCov">        540 :                 if (!stmt-&gt;methods-&gt;param_hook(stmt, param, PDO_PARAM_EVT_NORMALIZE)) {</span></a>
<a name="343"><span class="lineNum">     343 </span><span class="lineNoCov">          0 :                         PDO_HANDLE_STMT_ERR();</span></a>
<a name="344"><span class="lineNum">     344 </span><span class="lineNoCov">          0 :                         if (param-&gt;name) {</span></a>
<a name="345"><span class="lineNum">     345 </span><span class="lineNoCov">          0 :                                 zend_string_release_ex(param-&gt;name, 0);</span></a>
<a name="346"><span class="lineNum">     346 </span><span class="lineNoCov">          0 :                                 param-&gt;name = NULL;</span></a>
<a name="347"><span class="lineNum">     347 </span>            :                         }</a>
<a name="348"><span class="lineNum">     348 </span><span class="lineNoCov">          0 :                         return 0;</span></a>
<a name="349"><span class="lineNum">     349 </span>            :                 }</a>
<a name="350"><span class="lineNum">     350 </span>            :         }</a>
<a name="351"><span class="lineNum">     351 </span>            : </a>
<a name="352"><span class="lineNum">     352 </span>            :         /* delete any other parameter registered with this number.</a>
<a name="353"><span class="lineNum">     353 </span>            :          * If the parameter is named, it will be removed and correctly</a>
<a name="354"><span class="lineNum">     354 </span>            :          * disposed of by the hash_update call that follows */</a>
<a name="355"><span class="lineNum">     355 </span><span class="lineCov">        540 :         if (param-&gt;paramno &gt;= 0) {</span></a>
<a name="356"><span class="lineNum">     356 </span><span class="lineCov">        354 :                 zend_hash_index_del(hash, param-&gt;paramno);</span></a>
<a name="357"><span class="lineNum">     357 </span>            :         }</a>
<a name="358"><span class="lineNum">     358 </span>            : </a>
<a name="359"><span class="lineNum">     359 </span>            :         /* allocate storage for the parameter, keyed by its &quot;canonical&quot; name */</a>
<a name="360"><span class="lineNum">     360 </span><span class="lineCov">        540 :         if (param-&gt;name) {</span></a>
<a name="361"><span class="lineNum">     361 </span><span class="lineCov">        492 :                 pparam = zend_hash_update_mem(hash, param-&gt;name, param, sizeof(struct pdo_bound_param_data));</span></a>
<a name="362"><span class="lineNum">     362 </span>            :         } else {</a>
<a name="363"><span class="lineNum">     363 </span><span class="lineCov">        588 :                 pparam = zend_hash_index_update_mem(hash, param-&gt;paramno, param, sizeof(struct pdo_bound_param_data));</span></a>
<a name="364"><span class="lineNum">     364 </span>            :         }</a>
<a name="365"><span class="lineNum">     365 </span>            : </a>
<a name="366"><span class="lineNum">     366 </span>            :         /* tell the driver we just created a parameter */</a>
<a name="367"><span class="lineNum">     367 </span><span class="lineCov">        540 :         if (stmt-&gt;methods-&gt;param_hook) {</span></a>
<a name="368"><span class="lineNum">     368 </span><span class="lineCov">        540 :                 if (!stmt-&gt;methods-&gt;param_hook(stmt, pparam, PDO_PARAM_EVT_ALLOC)) {</span></a>
<a name="369"><span class="lineNum">     369 </span><span class="lineNoCov">          0 :                         PDO_HANDLE_STMT_ERR();</span></a>
<a name="370"><span class="lineNum">     370 </span>            :                         /* undo storage allocation; the hash will free the parameter</a>
<a name="371"><span class="lineNum">     371 </span>            :                          * name if required */</a>
<a name="372"><span class="lineNum">     372 </span><span class="lineNoCov">          0 :                         if (pparam-&gt;name) {</span></a>
<a name="373"><span class="lineNum">     373 </span><span class="lineNoCov">          0 :                                 zend_hash_del(hash, pparam-&gt;name);</span></a>
<a name="374"><span class="lineNum">     374 </span>            :                         } else {</a>
<a name="375"><span class="lineNum">     375 </span><span class="lineNoCov">          0 :                                 zend_hash_index_del(hash, pparam-&gt;paramno);</span></a>
<a name="376"><span class="lineNum">     376 </span>            :                         }</a>
<a name="377"><span class="lineNum">     377 </span>            :                         /* param-&gt;parameter is freed by hash dtor */</a>
<a name="378"><span class="lineNum">     378 </span><span class="lineNoCov">          0 :                         ZVAL_UNDEF(&amp;param-&gt;parameter);</span></a>
<a name="379"><span class="lineNum">     379 </span><span class="lineNoCov">          0 :                         return 0;</span></a>
<a name="380"><span class="lineNum">     380 </span>            :                 }</a>
<a name="381"><span class="lineNum">     381 </span>            :         }</a>
<a name="382"><span class="lineNum">     382 </span><span class="lineCov">        540 :         return 1;</span></a>
<a name="383"><span class="lineNum">     383 </span>            : }</a>
<a name="384"><span class="lineNum">     384 </span>            : /* }}} */</a>
<a name="385"><span class="lineNum">     385 </span>            : </a>
<a name="386"><span class="lineNum">     386 </span>            : /* {{{ Execute a prepared statement, optionally binding parameters */</a>
<a name="387"><span class="lineNum">     387 </span><span class="lineCov">        591 : PHP_METHOD(PDOStatement, execute)</span></a>
<a name="388"><span class="lineNum">     388 </span>            : {</a>
<a name="389"><span class="lineNum">     389 </span><span class="lineCov">        591 :         zval *input_params = NULL;</span></a>
<a name="390"><span class="lineNum">     390 </span><span class="lineCov">        591 :         int ret = 1;</span></a>
<a name="391"><span class="lineNum">     391 </span>            : </a>
<a name="392"><span class="lineNum">     392 </span><span class="lineCov">        591 :         ZEND_PARSE_PARAMETERS_START(0, 1)</span></a>
<a name="393"><span class="lineNum">     393 </span><span class="lineCov">        549 :                 Z_PARAM_OPTIONAL</span></a>
<a name="394"><span class="lineNum">     394 </span><span class="lineCov">        705 :                 Z_PARAM_ARRAY_OR_NULL(input_params)</span></a>
<a name="395"><span class="lineNum">     395 </span><span class="lineCov">        591 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="396"><span class="lineNum">     396 </span>            : </a>
<a name="397"><span class="lineNum">     397 </span><span class="lineCov">        549 :         PHP_STMT_GET_OBJ;</span></a>
<a name="398"><span class="lineNum">     398 </span><span class="lineCov">        537 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="399"><span class="lineNum">     399 </span>            : </a>
<a name="400"><span class="lineNum">     400 </span><span class="lineCov">        537 :         if (input_params) {</span></a>
<a name="401"><span class="lineNum">     401 </span>            :                 struct pdo_bound_param_data param;</a>
<a name="402"><span class="lineNum">     402 </span>            :                 zval *tmp;</a>
<a name="403"><span class="lineNum">     403 </span><span class="lineCov">        150 :                 zend_string *key = NULL;</span></a>
<a name="404"><span class="lineNum">     404 </span>            :                 zend_ulong num_index;</a>
<a name="405"><span class="lineNum">     405 </span>            : </a>
<a name="406"><span class="lineNum">     406 </span><span class="lineCov">        150 :                 if (stmt-&gt;bound_params) {</span></a>
<a name="407"><span class="lineNum">     407 </span><span class="lineCov">         93 :                         zend_hash_destroy(stmt-&gt;bound_params);</span></a>
<a name="408"><span class="lineNum">     408 </span><span class="lineCov">         93 :                         FREE_HASHTABLE(stmt-&gt;bound_params);</span></a>
<a name="409"><span class="lineNum">     409 </span><span class="lineCov">         93 :                         stmt-&gt;bound_params = NULL;</span></a>
<a name="410"><span class="lineNum">     410 </span>            :                 }</a>
<a name="411"><span class="lineNum">     411 </span>            : </a>
<a name="412"><span class="lineNum">     412 </span><span class="lineCov">        942 :                 ZEND_HASH_FOREACH_KEY_VAL(Z_ARRVAL_P(input_params), num_index, key, tmp) {</span></a>
<a name="413"><span class="lineNum">     413 </span><span class="lineCov">        396 :                         memset(&amp;param, 0, sizeof(param));</span></a>
<a name="414"><span class="lineNum">     414 </span>            : </a>
<a name="415"><span class="lineNum">     415 </span><span class="lineCov">        396 :                         if (key) {</span></a>
<a name="416"><span class="lineNum">     416 </span>            :                                 /* yes this is correct.  we don't want to count the null byte.  ask wez */</a>
<a name="417"><span class="lineNum">     417 </span><span class="lineCov">        117 :                                 param.name = key;</span></a>
<a name="418"><span class="lineNum">     418 </span><span class="lineCov">        117 :                                 param.paramno = -1;</span></a>
<a name="419"><span class="lineNum">     419 </span>            :                         } else {</a>
<a name="420"><span class="lineNum">     420 </span>            :                                 /* we're okay to be zero based here */</a>
<a name="421"><span class="lineNum">     421 </span>            :                                 /* num_index is unsignend */</a>
<a name="422"><span class="lineNum">     422 </span><span class="lineCov">        279 :                                 param.paramno = num_index;</span></a>
<a name="423"><span class="lineNum">     423 </span>            :                         }</a>
<a name="424"><span class="lineNum">     424 </span>            : </a>
<a name="425"><span class="lineNum">     425 </span><span class="lineCov">        396 :                         param.param_type = PDO_PARAM_STR;</span></a>
<a name="426"><span class="lineNum">     426 </span><span class="lineCov">        396 :                         ZVAL_COPY(&amp;param.parameter, tmp);</span></a>
<a name="427"><span class="lineNum">     427 </span>            : </a>
<a name="428"><span class="lineNum">     428 </span><span class="lineCov">        396 :                         if (!really_register_bound_param(&amp;param, stmt, 1)) {</span></a>
<a name="429"><span class="lineNum">     429 </span><span class="lineNoCov">          0 :                                 if (!Z_ISUNDEF(param.parameter)) {</span></a>
<a name="430"><span class="lineNum">     430 </span><span class="lineNoCov">          0 :                                         zval_ptr_dtor(&amp;param.parameter);</span></a>
<a name="431"><span class="lineNum">     431 </span>            :                                 }</a>
<a name="432"><span class="lineNum">     432 </span><span class="lineNoCov">          0 :                                 RETURN_FALSE;</span></a>
<a name="433"><span class="lineNum">     433 </span>            :                         }</a>
<a name="434"><span class="lineNum">     434 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="435"><span class="lineNum">     435 </span>            :         }</a>
<a name="436"><span class="lineNum">     436 </span>            : </a>
<a name="437"><span class="lineNum">     437 </span><span class="lineCov">        537 :         if (PDO_PLACEHOLDER_NONE == stmt-&gt;supports_placeholders) {</span></a>
<a name="438"><span class="lineNum">     438 </span>            :                 /* handle the emulated parameter binding,</a>
<a name="439"><span class="lineNum">     439 </span>            :                  * stmt-&gt;active_query_string holds the query with binds expanded and</a>
<a name="440"><span class="lineNum">     440 </span>            :                  * quoted.</a>
<a name="441"><span class="lineNum">     441 </span>            :                  */</a>
<a name="442"><span class="lineNum">     442 </span>            : </a>
<a name="443"><span class="lineNum">     443 </span>            :                 /* string is leftover from previous calls so PDOStatement::debugDumpParams() can access */</a>
<a name="444"><span class="lineNum">     444 </span><span class="lineNoCov">          0 :                 if (stmt-&gt;active_query_string) {</span></a>
<a name="445"><span class="lineNum">     445 </span><span class="lineNoCov">          0 :                         zend_string_release(stmt-&gt;active_query_string);</span></a>
<a name="446"><span class="lineNum">     446 </span><span class="lineNoCov">          0 :                         stmt-&gt;active_query_string = NULL;</span></a>
<a name="447"><span class="lineNum">     447 </span>            :                 }</a>
<a name="448"><span class="lineNum">     448 </span>            : </a>
<a name="449"><span class="lineNum">     449 </span><span class="lineNoCov">          0 :                 ret = pdo_parse_params(stmt, stmt-&gt;query_string, &amp;stmt-&gt;active_query_string);</span></a>
<a name="450"><span class="lineNum">     450 </span>            : </a>
<a name="451"><span class="lineNum">     451 </span><span class="lineNoCov">          0 :                 if (ret == 0) {</span></a>
<a name="452"><span class="lineNum">     452 </span>            :                         /* no changes were made */</a>
<a name="453"><span class="lineNum">     453 </span><span class="lineNoCov">          0 :                         stmt-&gt;active_query_string = zend_string_copy(stmt-&gt;query_string);</span></a>
<a name="454"><span class="lineNum">     454 </span><span class="lineNoCov">          0 :                         ret = 1;</span></a>
<a name="455"><span class="lineNum">     455 </span><span class="lineNoCov">          0 :                 } else if (ret == -1) {</span></a>
<a name="456"><span class="lineNum">     456 </span>            :                         /* something broke */</a>
<a name="457"><span class="lineNum">     457 </span><span class="lineNoCov">          0 :                         RETURN_FALSE;</span></a>
<a name="458"><span class="lineNum">     458 </span>            :                 }</a>
<a name="459"><span class="lineNum">     459 </span><span class="lineCov">        537 :         } else if (!dispatch_param_event(stmt, PDO_PARAM_EVT_EXEC_PRE)) {</span></a>
<a name="460"><span class="lineNum">     460 </span><span class="lineCov">         15 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="461"><span class="lineNum">     461 </span><span class="lineCov">         15 :                 RETURN_FALSE;</span></a>
<a name="462"><span class="lineNum">     462 </span>            :         }</a>
<a name="463"><span class="lineNum">     463 </span><span class="lineCov">        522 :         if (stmt-&gt;methods-&gt;executer(stmt)) {</span></a>
<a name="464"><span class="lineNum">     464 </span><span class="lineCov">        522 :                 if (!stmt-&gt;executed) {</span></a>
<a name="465"><span class="lineNum">     465 </span>            :                         /* this is the first execute */</a>
<a name="466"><span class="lineNum">     466 </span>            : </a>
<a name="467"><span class="lineNum">     467 </span><span class="lineCov">        324 :                         if (stmt-&gt;dbh-&gt;alloc_own_columns &amp;&amp; !stmt-&gt;columns) {</span></a>
<a name="468"><span class="lineNum">     468 </span>            :                                 /* for &quot;big boy&quot; drivers, we need to allocate memory to fetch</a>
<a name="469"><span class="lineNum">     469 </span>            :                                  * the results into, so lets do that now */</a>
<a name="470"><span class="lineNum">     470 </span><span class="lineCov">        264 :                                 ret = pdo_stmt_describe_columns(stmt);</span></a>
<a name="471"><span class="lineNum">     471 </span>            :                         }</a>
<a name="472"><span class="lineNum">     472 </span>            : </a>
<a name="473"><span class="lineNum">     473 </span><span class="lineCov">        324 :                         stmt-&gt;executed = 1;</span></a>
<a name="474"><span class="lineNum">     474 </span>            :                 }</a>
<a name="475"><span class="lineNum">     475 </span>            : </a>
<a name="476"><span class="lineNum">     476 </span><span class="lineCov">        522 :                 if (ret &amp;&amp; !dispatch_param_event(stmt, PDO_PARAM_EVT_EXEC_POST)) {</span></a>
<a name="477"><span class="lineNum">     477 </span><span class="lineNoCov">          0 :                         PDO_HANDLE_STMT_ERR();</span></a>
<a name="478"><span class="lineNum">     478 </span><span class="lineNoCov">          0 :                         RETURN_FALSE;</span></a>
<a name="479"><span class="lineNum">     479 </span>            :                 }</a>
<a name="480"><span class="lineNum">     480 </span>            : </a>
<a name="481"><span class="lineNum">     481 </span><span class="lineCov">        522 :                 RETURN_BOOL(ret);</span></a>
<a name="482"><span class="lineNum">     482 </span>            :         }</a>
<a name="483"><span class="lineNum">     483 </span><span class="lineNoCov">          0 :         PDO_HANDLE_STMT_ERR();</span></a>
<a name="484"><span class="lineNum">     484 </span><span class="lineNoCov">          0 :         RETURN_FALSE;</span></a>
<a name="485"><span class="lineNum">     485 </span>            : }</a>
<a name="486"><span class="lineNum">     486 </span>            : /* }}} */</a>
<a name="487"><span class="lineNum">     487 </span>            : </a>
<a name="488"><span class="lineNum">     488 </span><span class="lineCov">       1743 : static inline void fetch_value(pdo_stmt_t *stmt, zval *dest, int colno, enum pdo_param_type *type_override) /* {{{ */</span></a>
<a name="489"><span class="lineNum">     489 </span>            : {</a>
<a name="490"><span class="lineNum">     490 </span><span class="lineCov">       1743 :         if (colno &lt; 0) {</span></a>
<a name="491"><span class="lineNum">     491 </span><span class="lineCov">          3 :                 zend_value_error(&quot;Column index must be greater than or equal to 0&quot;);</span></a>
<a name="492"><span class="lineNum">     492 </span><span class="lineCov">          3 :                 ZVAL_NULL(dest);</span></a>
<a name="493"><span class="lineNum">     493 </span><span class="lineCov">          6 :                 return;</span></a>
<a name="494"><span class="lineNum">     494 </span>            :         }</a>
<a name="495"><span class="lineNum">     495 </span>            : </a>
<a name="496"><span class="lineNum">     496 </span><span class="lineCov">       1740 :         if (colno &gt;= stmt-&gt;column_count) {</span></a>
<a name="497"><span class="lineNum">     497 </span><span class="lineCov">          3 :                 zend_value_error(&quot;Invalid column index&quot;);</span></a>
<a name="498"><span class="lineNum">     498 </span><span class="lineCov">          3 :                 ZVAL_NULL(dest);</span></a>
<a name="499"><span class="lineNum">     499 </span><span class="lineCov">          3 :                 return;</span></a>
<a name="500"><span class="lineNum">     500 </span>            :         }</a>
<a name="501"><span class="lineNum">     501 </span>            : </a>
<a name="502"><span class="lineNum">     502 </span><span class="lineCov">       1737 :         ZVAL_NULL(dest);</span></a>
<a name="503"><span class="lineNum">     503 </span><span class="lineCov">       1737 :         stmt-&gt;methods-&gt;get_col(stmt, colno, dest, type_override);</span></a>
<a name="504"><span class="lineNum">     504 </span>            : </a>
<a name="505"><span class="lineNum">     505 </span><span class="lineCov">       1737 :         if (Z_TYPE_P(dest) == IS_STRING &amp;&amp; Z_STRLEN_P(dest) == 0</span></a>
<a name="506"><span class="lineNum">     506 </span><span class="lineCov">         18 :                         &amp;&amp; stmt-&gt;dbh-&gt;oracle_nulls == PDO_NULL_EMPTY_STRING) {</span></a>
<a name="507"><span class="lineNum">     507 </span>            :                 zval_ptr_dtor_str(dest);</a>
<a name="508"><span class="lineNum">     508 </span><span class="lineNoCov">          0 :                 ZVAL_NULL(dest);</span></a>
<a name="509"><span class="lineNum">     509 </span>            :         }</a>
<a name="510"><span class="lineNum">     510 </span>            : </a>
<a name="511"><span class="lineNum">     511 </span>            :         /* If stringification is requested, override with PDO_PARAM_STR. */</a>
<a name="512"><span class="lineNum">     512 </span><span class="lineCov">       1737 :         enum pdo_param_type pdo_param_str = PDO_PARAM_STR;</span></a>
<a name="513"><span class="lineNum">     513 </span><span class="lineCov">       1737 :         if (stmt-&gt;dbh-&gt;stringify) {</span></a>
<a name="514"><span class="lineNum">     514 </span><span class="lineCov">       1608 :                 type_override = &amp;pdo_param_str;</span></a>
<a name="515"><span class="lineNum">     515 </span>            :         }</a>
<a name="516"><span class="lineNum">     516 </span>            : </a>
<a name="517"><span class="lineNum">     517 </span><span class="lineCov">       3345 :         if (type_override &amp;&amp; Z_TYPE_P(dest) != IS_NULL) {</span></a>
<a name="518"><span class="lineNum">     518 </span><span class="lineCov">       1575 :                 switch (*type_override) {</span></a>
<a name="519"><span class="lineNum">     519 </span><span class="lineNoCov">          0 :                         case PDO_PARAM_INT:</span></a>
<a name="520"><span class="lineNum">     520 </span><span class="lineNoCov">          0 :                                 convert_to_long(dest);</span></a>
<a name="521"><span class="lineNum">     521 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="522"><span class="lineNum">     522 </span><span class="lineNoCov">          0 :                         case PDO_PARAM_BOOL:</span></a>
<a name="523"><span class="lineNum">     523 </span><span class="lineNoCov">          0 :                                 convert_to_boolean(dest);</span></a>
<a name="524"><span class="lineNum">     524 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="525"><span class="lineNum">     525 </span><span class="lineCov">       1575 :                         case PDO_PARAM_STR:</span></a>
<a name="526"><span class="lineNum">     526 </span><span class="lineCov">       1575 :                                 if (Z_TYPE_P(dest) == IS_FALSE) {</span></a>
<a name="527"><span class="lineNum">     527 </span>            :                                         /* Return &quot;0&quot; rather than &quot;&quot;, because this is what database drivers that</a>
<a name="528"><span class="lineNum">     528 </span>            :                                          * don't have a dedicated boolean type would return. */</a>
<a name="529"><span class="lineNum">     529 </span>            :                                         zval_ptr_dtor_nogc(dest);</a>
<a name="530"><span class="lineNum">     530 </span><span class="lineNoCov">          0 :                                         ZVAL_INTERNED_STR(dest, ZSTR_CHAR('0'));</span></a>
<a name="531"><span class="lineNum">     531 </span><span class="lineCov">       1575 :                                 } else if (Z_TYPE_P(dest) == IS_RESOURCE) {</span></a>
<a name="532"><span class="lineNum">     532 </span>            :                                         /* Convert LOB stream to string */</a>
<a name="533"><span class="lineNum">     533 </span>            :                                         php_stream *stream;</a>
<a name="534"><span class="lineNum">     534 </span><span class="lineNoCov">          0 :                                         php_stream_from_zval_no_verify(stream, dest);</span></a>
<a name="535"><span class="lineNum">     535 </span><span class="lineNoCov">          0 :                                         zend_string *str = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);</span></a>
<a name="536"><span class="lineNum">     536 </span>            :                                         zval_ptr_dtor_nogc(dest);</a>
<a name="537"><span class="lineNum">     537 </span><span class="lineNoCov">          0 :                                         if (str == NULL) {</span></a>
<a name="538"><span class="lineNum">     538 </span><span class="lineNoCov">          0 :                                                 ZVAL_EMPTY_STRING(dest);</span></a>
<a name="539"><span class="lineNum">     539 </span>            :                                         } else {</a>
<a name="540"><span class="lineNum">     540 </span><span class="lineNoCov">          0 :                                                 ZVAL_STR(dest, str);</span></a>
<a name="541"><span class="lineNum">     541 </span>            :                                         }</a>
<a name="542"><span class="lineNum">     542 </span>            :                                 } else {</a>
<a name="543"><span class="lineNum">     543 </span><span class="lineCov">       1575 :                                         convert_to_string(dest);</span></a>
<a name="544"><span class="lineNum">     544 </span>            :                                 }</a>
<a name="545"><span class="lineNum">     545 </span><span class="lineCov">       1575 :                                 break;</span></a>
<a name="546"><span class="lineNum">     546 </span><span class="lineNoCov">          0 :                         case PDO_PARAM_NULL:</span></a>
<a name="547"><span class="lineNum">     547 </span><span class="lineNoCov">          0 :                                 convert_to_null(dest);</span></a>
<a name="548"><span class="lineNum">     548 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="549"><span class="lineNum">     549 </span><span class="lineNoCov">          0 :                         case PDO_PARAM_LOB:</span></a>
<a name="550"><span class="lineNum">     550 </span><span class="lineNoCov">          0 :                                 if (Z_TYPE_P(dest) == IS_STRING) {</span></a>
<a name="551"><span class="lineNum">     551 </span>            :                                         php_stream *stream =</a>
<a name="552"><span class="lineNum">     552 </span><span class="lineNoCov">          0 :                                                 php_stream_memory_open(TEMP_STREAM_READONLY, Z_STR_P(dest));</span></a>
<a name="553"><span class="lineNum">     553 </span>            :                                         zval_ptr_dtor_str(dest);</a>
<a name="554"><span class="lineNum">     554 </span><span class="lineNoCov">          0 :                                         php_stream_to_zval(stream, dest);</span></a>
<a name="555"><span class="lineNum">     555 </span>            :                                 }</a>
<a name="556"><span class="lineNum">     556 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="557"><span class="lineNum">     557 </span><span class="lineNoCov">          0 :                         default:</span></a>
<a name="558"><span class="lineNum">     558 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="559"><span class="lineNum">     559 </span>            :                 }</a>
<a name="560"><span class="lineNum">     560 </span><span class="lineCov">        162 :         }</span></a>
<a name="561"><span class="lineNum">     561 </span>            : </a>
<a name="562"><span class="lineNum">     562 </span><span class="lineCov">       1737 :         if (Z_TYPE_P(dest) == IS_NULL &amp;&amp; stmt-&gt;dbh-&gt;oracle_nulls == PDO_NULL_TO_STRING) {</span></a>
<a name="563"><span class="lineNum">     563 </span><span class="lineNoCov">          0 :                 ZVAL_EMPTY_STRING(dest);</span></a>
<a name="564"><span class="lineNum">     564 </span>            :         }</a>
<a name="565"><span class="lineNum">     565 </span>            : }</a>
<a name="566"><span class="lineNum">     566 </span>            : /* }}} */</a>
<a name="567"><span class="lineNum">     567 </span>            : </a>
<a name="568"><span class="lineNum">     568 </span><span class="lineCov">       1215 : static bool do_fetch_common(pdo_stmt_t *stmt, enum pdo_fetch_orientation ori, zend_long offset) /* {{{ */</span></a>
<a name="569"><span class="lineNum">     569 </span>            : {</a>
<a name="570"><span class="lineNum">     570 </span><span class="lineCov">       1215 :         if (!stmt-&gt;executed) {</span></a>
<a name="571"><span class="lineNum">     571 </span><span class="lineCov">          3 :                 return 0;</span></a>
<a name="572"><span class="lineNum">     572 </span>            :         }</a>
<a name="573"><span class="lineNum">     573 </span>            : </a>
<a name="574"><span class="lineNum">     574 </span><span class="lineCov">       1212 :         if (!dispatch_param_event(stmt, PDO_PARAM_EVT_FETCH_PRE)) {</span></a>
<a name="575"><span class="lineNum">     575 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="576"><span class="lineNum">     576 </span>            :         }</a>
<a name="577"><span class="lineNum">     577 </span>            : </a>
<a name="578"><span class="lineNum">     578 </span><span class="lineCov">       1212 :         if (!stmt-&gt;methods-&gt;fetcher(stmt, ori, offset)) {</span></a>
<a name="579"><span class="lineNum">     579 </span><span class="lineCov">        294 :                 return 0;</span></a>
<a name="580"><span class="lineNum">     580 </span>            :         }</a>
<a name="581"><span class="lineNum">     581 </span>            : </a>
<a name="582"><span class="lineNum">     582 </span>            :         /* some drivers might need to describe the columns now */</a>
<a name="583"><span class="lineNum">     583 </span><span class="lineCov">        918 :         if (!stmt-&gt;columns &amp;&amp; !pdo_stmt_describe_columns(stmt)) {</span></a>
<a name="584"><span class="lineNum">     584 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="585"><span class="lineNum">     585 </span>            :         }</a>
<a name="586"><span class="lineNum">     586 </span>            : </a>
<a name="587"><span class="lineNum">     587 </span><span class="lineCov">        918 :         if (!dispatch_param_event(stmt, PDO_PARAM_EVT_FETCH_POST)) {</span></a>
<a name="588"><span class="lineNum">     588 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="589"><span class="lineNum">     589 </span>            :         }</a>
<a name="590"><span class="lineNum">     590 </span>            : </a>
<a name="591"><span class="lineNum">     591 </span><span class="lineCov">        918 :         if (stmt-&gt;bound_columns) {</span></a>
<a name="592"><span class="lineNum">     592 </span>            :                 /* update those bound column variables now */</a>
<a name="593"><span class="lineNum">     593 </span>            :                 struct pdo_bound_param_data *param;</a>
<a name="594"><span class="lineNum">     594 </span>            : </a>
<a name="595"><span class="lineNum">     595 </span><span class="lineCov">        483 :                 ZEND_HASH_FOREACH_PTR(stmt-&gt;bound_columns, param) {</span></a>
<a name="596"><span class="lineNum">     596 </span><span class="lineCov">        177 :                         if (param-&gt;paramno &gt;= 0) {</span></a>
<a name="597"><span class="lineNum">     597 </span><span class="lineCov">        354 :                                 if (!Z_ISREF(param-&gt;parameter)) {</span></a>
<a name="598"><span class="lineNum">     598 </span><span class="lineNoCov">          0 :                                         continue;</span></a>
<a name="599"><span class="lineNum">     599 </span>            :                                 }</a>
<a name="600"><span class="lineNum">     600 </span>            : </a>
<a name="601"><span class="lineNum">     601 </span>            :                                 /* delete old value */</a>
<a name="602"><span class="lineNum">     602 </span><span class="lineCov">        177 :                                 zval_ptr_dtor(Z_REFVAL(param-&gt;parameter));</span></a>
<a name="603"><span class="lineNum">     603 </span>            : </a>
<a name="604"><span class="lineNum">     604 </span>            :                                 /* set new value */</a>
<a name="605"><span class="lineNum">     605 </span><span class="lineCov">        177 :                                 fetch_value(stmt, Z_REFVAL(param-&gt;parameter), param-&gt;paramno, &amp;param-&gt;param_type);</span></a>
<a name="606"><span class="lineNum">     606 </span>            : </a>
<a name="607"><span class="lineNum">     607 </span>            :                                 /* TODO: some smart thing that avoids duplicating the value in the</a>
<a name="608"><span class="lineNum">     608 </span>            :                                  * general loop below.  For now, if you're binding output columns,</a>
<a name="609"><span class="lineNum">     609 </span>            :                                  * it's better to use LAZY or BOUND fetches if you want to shave</a>
<a name="610"><span class="lineNum">     610 </span>            :                                  * off those cycles */</a>
<a name="611"><span class="lineNum">     611 </span>            :                         }</a>
<a name="612"><span class="lineNum">     612 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="613"><span class="lineNum">     613 </span>            :         }</a>
<a name="614"><span class="lineNum">     614 </span>            : </a>
<a name="615"><span class="lineNum">     615 </span><span class="lineCov">        918 :         return 1;</span></a>
<a name="616"><span class="lineNum">     616 </span>            : }</a>
<a name="617"><span class="lineNum">     617 </span>            : /* }}} */</a>
<a name="618"><span class="lineNum">     618 </span>            : </a>
<a name="619"><span class="lineNum">     619 </span><span class="lineCov">        114 : static bool do_fetch_class_prepare(pdo_stmt_t *stmt) /* {{{ */</span></a>
<a name="620"><span class="lineNum">     620 </span>            : {</a>
<a name="621"><span class="lineNum">     621 </span><span class="lineCov">        114 :         zend_class_entry *ce = stmt-&gt;fetch.cls.ce;</span></a>
<a name="622"><span class="lineNum">     622 </span><span class="lineCov">        114 :         zend_fcall_info *fci = &amp;stmt-&gt;fetch.cls.fci;</span></a>
<a name="623"><span class="lineNum">     623 </span><span class="lineCov">        114 :         zend_fcall_info_cache *fcc = &amp;stmt-&gt;fetch.cls.fcc;</span></a>
<a name="624"><span class="lineNum">     624 </span>            : </a>
<a name="625"><span class="lineNum">     625 </span><span class="lineCov">        114 :         fci-&gt;size = sizeof(zend_fcall_info);</span></a>
<a name="626"><span class="lineNum">     626 </span>            : </a>
<a name="627"><span class="lineNum">     627 </span><span class="lineCov">        114 :         if (!ce) {</span></a>
<a name="628"><span class="lineNum">     628 </span><span class="lineNoCov">          0 :                 stmt-&gt;fetch.cls.ce = ZEND_STANDARD_CLASS_DEF_PTR;</span></a>
<a name="629"><span class="lineNum">     629 </span><span class="lineNoCov">          0 :                 ce = ZEND_STANDARD_CLASS_DEF_PTR;</span></a>
<a name="630"><span class="lineNum">     630 </span>            :         }</a>
<a name="631"><span class="lineNum">     631 </span>            : </a>
<a name="632"><span class="lineNum">     632 </span><span class="lineCov">        114 :         if (ce-&gt;constructor) {</span></a>
<a name="633"><span class="lineNum">     633 </span><span class="lineCov">         78 :                 ZVAL_UNDEF(&amp;fci-&gt;function_name);</span></a>
<a name="634"><span class="lineNum">     634 </span><span class="lineCov">         78 :                 fci-&gt;retval = &amp;stmt-&gt;fetch.cls.retval;</span></a>
<a name="635"><span class="lineNum">     635 </span><span class="lineCov">         78 :                 fci-&gt;param_count = 0;</span></a>
<a name="636"><span class="lineNum">     636 </span><span class="lineCov">         78 :                 fci-&gt;params = NULL;</span></a>
<a name="637"><span class="lineNum">     637 </span>            : </a>
<a name="638"><span class="lineNum">     638 </span><span class="lineCov">         78 :                 zend_fcall_info_args_ex(fci, ce-&gt;constructor, &amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="639"><span class="lineNum">     639 </span>            : </a>
<a name="640"><span class="lineNum">     640 </span><span class="lineCov">         78 :                 fcc-&gt;function_handler = ce-&gt;constructor;</span></a>
<a name="641"><span class="lineNum">     641 </span><span class="lineCov">         78 :                 fcc-&gt;called_scope = ce;</span></a>
<a name="642"><span class="lineNum">     642 </span><span class="lineCov">         78 :                 return 1;</span></a>
<a name="643"><span class="lineNum">     643 </span><span class="lineCov">         72 :         } else if (!Z_ISUNDEF(stmt-&gt;fetch.cls.ctor_args)) {</span></a>
<a name="644"><span class="lineNum">     644 </span><span class="lineNoCov">          0 :                 zend_throw_error(NULL, &quot;User-supplied statement does not accept constructor arguments&quot;);</span></a>
<a name="645"><span class="lineNum">     645 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="646"><span class="lineNum">     646 </span>            :         } else {</a>
<a name="647"><span class="lineNum">     647 </span><span class="lineCov">         36 :                 return 1; /* no ctor no args is also ok */</span></a>
<a name="648"><span class="lineNum">     648 </span>            :         }</a>
<a name="649"><span class="lineNum">     649 </span>            : }</a>
<a name="650"><span class="lineNum">     650 </span>            : /* }}} */</a>
<a name="651"><span class="lineNum">     651 </span>            : </a>
<a name="652"><span class="lineNum">     652 </span><span class="lineCov">         60 : static bool make_callable_ex(pdo_stmt_t *stmt, zval *callable, zend_fcall_info * fci, zend_fcall_info_cache * fcc, int num_args) /* {{{ */</span></a>
<a name="653"><span class="lineNum">     653 </span>            : {</a>
<a name="654"><span class="lineNum">     654 </span><span class="lineCov">         60 :         char *is_callable_error = NULL;</span></a>
<a name="655"><span class="lineNum">     655 </span>            : </a>
<a name="656"><span class="lineNum">     656 </span><span class="lineCov">         60 :         if (zend_fcall_info_init(callable, 0, fci, fcc, NULL, &amp;is_callable_error) == FAILURE) {</span></a>
<a name="657"><span class="lineNum">     657 </span><span class="lineCov">         21 :                 if (is_callable_error) {</span></a>
<a name="658"><span class="lineNum">     658 </span><span class="lineCov">         21 :                         zend_type_error(&quot;%s&quot;, is_callable_error);</span></a>
<a name="659"><span class="lineNum">     659 </span><span class="lineCov">         21 :                         efree(is_callable_error);</span></a>
<a name="660"><span class="lineNum">     660 </span>            :                 } else {</a>
<a name="661"><span class="lineNum">     661 </span><span class="lineNoCov">          0 :                         zend_type_error(&quot;User-supplied function must be a valid callback&quot;);</span></a>
<a name="662"><span class="lineNum">     662 </span>            :                 }</a>
<a name="663"><span class="lineNum">     663 </span><span class="lineCov">         21 :                 return false;</span></a>
<a name="664"><span class="lineNum">     664 </span>            :         }</a>
<a name="665"><span class="lineNum">     665 </span><span class="lineCov">         39 :         if (is_callable_error) {</span></a>
<a name="666"><span class="lineNum">     666 </span>            :                 /* Possible error message */</a>
<a name="667"><span class="lineNum">     667 </span><span class="lineNoCov">          0 :                 efree(is_callable_error);</span></a>
<a name="668"><span class="lineNum">     668 </span>            :         }</a>
<a name="669"><span class="lineNum">     669 </span>            : </a>
<a name="670"><span class="lineNum">     670 </span><span class="lineCov">         39 :         fci-&gt;param_count = num_args; /* probably less */</span></a>
<a name="671"><span class="lineNum">     671 </span><span class="lineCov">         39 :         fci-&gt;params = safe_emalloc(sizeof(zval), num_args, 0);</span></a>
<a name="672"><span class="lineNum">     672 </span>            : </a>
<a name="673"><span class="lineNum">     673 </span><span class="lineCov">         39 :         return true;</span></a>
<a name="674"><span class="lineNum">     674 </span>            : }</a>
<a name="675"><span class="lineNum">     675 </span>            : /* }}} */</a>
<a name="676"><span class="lineNum">     676 </span>            : </a>
<a name="677"><span class="lineNum">     677 </span><span class="lineCov">         60 : static bool do_fetch_func_prepare(pdo_stmt_t *stmt) /* {{{ */</span></a>
<a name="678"><span class="lineNum">     678 </span>            : {</a>
<a name="679"><span class="lineNum">     679 </span><span class="lineCov">         60 :         zend_fcall_info *fci = &amp;stmt-&gt;fetch.cls.fci;</span></a>
<a name="680"><span class="lineNum">     680 </span><span class="lineCov">         60 :         zend_fcall_info_cache *fcc = &amp;stmt-&gt;fetch.cls.fcc;</span></a>
<a name="681"><span class="lineNum">     681 </span>            : </a>
<a name="682"><span class="lineNum">     682 </span><span class="lineCov">         60 :         if (!make_callable_ex(stmt, &amp;stmt-&gt;fetch.func.function, fci, fcc, stmt-&gt;column_count)) {</span></a>
<a name="683"><span class="lineNum">     683 </span><span class="lineCov">         21 :                 return false;</span></a>
<a name="684"><span class="lineNum">     684 </span>            :         } else {</a>
<a name="685"><span class="lineNum">     685 </span><span class="lineCov">         39 :                 stmt-&gt;fetch.func.values = safe_emalloc(sizeof(zval), stmt-&gt;column_count, 0);</span></a>
<a name="686"><span class="lineNum">     686 </span><span class="lineCov">         39 :                 return true;</span></a>
<a name="687"><span class="lineNum">     687 </span>            :         }</a>
<a name="688"><span class="lineNum">     688 </span>            : }</a>
<a name="689"><span class="lineNum">     689 </span>            : /* }}} */</a>
<a name="690"><span class="lineNum">     690 </span>            : </a>
<a name="691"><span class="lineNum">     691 </span><span class="lineCov">       1338 : static void do_fetch_opt_finish(pdo_stmt_t *stmt, int free_ctor_agrs) /* {{{ */</span></a>
<a name="692"><span class="lineNum">     692 </span>            : {</a>
<a name="693"><span class="lineNum">     693 </span>            :         /* fci.size is used to check if it is valid */</a>
<a name="694"><span class="lineNum">     694 </span><span class="lineCov">       1338 :         if (stmt-&gt;fetch.cls.fci.size &amp;&amp; stmt-&gt;fetch.cls.fci.params) {</span></a>
<a name="695"><span class="lineNum">     695 </span><span class="lineCov">        114 :                 if (!Z_ISUNDEF(stmt-&gt;fetch.cls.ctor_args)) {</span></a>
<a name="696"><span class="lineNum">     696 </span>            :                         /* Added to free constructor arguments */</a>
<a name="697"><span class="lineNum">     697 </span><span class="lineCov">         18 :                         zend_fcall_info_args_clear(&amp;stmt-&gt;fetch.cls.fci, 1);</span></a>
<a name="698"><span class="lineNum">     698 </span>            :                 } else {</a>
<a name="699"><span class="lineNum">     699 </span><span class="lineCov">         39 :                         efree(stmt-&gt;fetch.cls.fci.params);</span></a>
<a name="700"><span class="lineNum">     700 </span>            :                 }</a>
<a name="701"><span class="lineNum">     701 </span><span class="lineCov">         57 :                 stmt-&gt;fetch.cls.fci.params = NULL;</span></a>
<a name="702"><span class="lineNum">     702 </span>            :         }</a>
<a name="703"><span class="lineNum">     703 </span>            : </a>
<a name="704"><span class="lineNum">     704 </span><span class="lineCov">       1338 :         stmt-&gt;fetch.cls.fci.size = 0;</span></a>
<a name="705"><span class="lineNum">     705 </span><span class="lineCov">       2676 :         if (!Z_ISUNDEF(stmt-&gt;fetch.cls.ctor_args) &amp;&amp; free_ctor_agrs) {</span></a>
<a name="706"><span class="lineNum">     706 </span><span class="lineCov">         39 :                 zval_ptr_dtor(&amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="707"><span class="lineNum">     707 </span><span class="lineCov">         39 :                 ZVAL_UNDEF(&amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="708"><span class="lineNum">     708 </span><span class="lineCov">         39 :                 stmt-&gt;fetch.cls.fci.param_count = 0;</span></a>
<a name="709"><span class="lineNum">     709 </span>            :         }</a>
<a name="710"><span class="lineNum">     710 </span><span class="lineCov">       1338 :         if (stmt-&gt;fetch.func.values) {</span></a>
<a name="711"><span class="lineNum">     711 </span><span class="lineCov">         39 :                 efree(stmt-&gt;fetch.func.values);</span></a>
<a name="712"><span class="lineNum">     712 </span><span class="lineCov">         39 :                 stmt-&gt;fetch.func.values = NULL;</span></a>
<a name="713"><span class="lineNum">     713 </span>            :         }</a>
<a name="714"><span class="lineNum">     714 </span><span class="lineCov">       1338 : }</span></a>
<a name="715"><span class="lineNum">     715 </span>            : /* }}} */</a>
<a name="716"><span class="lineNum">     716 </span>            : </a>
<a name="717"><span class="lineNum">     717 </span>            : /* perform a fetch.</a>
<a name="718"><span class="lineNum">     718 </span>            :  * If return_value is not null, store values into it according to HOW. */</a>
<a name="719"><span class="lineNum">     719 </span><span class="lineCov">       1143 : static bool do_fetch(pdo_stmt_t *stmt, zval *return_value, enum pdo_fetch_type how, enum pdo_fetch_orientation ori, zend_long offset, zval *return_all) /* {{{ */</span></a>
<a name="720"><span class="lineNum">     720 </span>            : {</a>
<a name="721"><span class="lineNum">     721 </span><span class="lineCov">       1143 :         int flags, idx, old_arg_count = 0;</span></a>
<a name="722"><span class="lineNum">     722 </span><span class="lineCov">       1143 :         zend_class_entry *ce = NULL, *old_ce = NULL;</span></a>
<a name="723"><span class="lineNum">     723 </span><span class="lineCov">       1143 :         zval grp_val, *pgrp, retval, old_ctor_args = {{0}, {0}, {0}};</span></a>
<a name="724"><span class="lineNum">     724 </span>            :         int colno;</a>
<a name="725"><span class="lineNum">     725 </span><span class="lineCov">       1143 :         int i = 0;</span></a>
<a name="726"><span class="lineNum">     726 </span>            : </a>
<a name="727"><span class="lineNum">     727 </span><span class="lineCov">       1143 :         if (how == PDO_FETCH_USE_DEFAULT) {</span></a>
<a name="728"><span class="lineNum">     728 </span><span class="lineCov">        177 :                 how = stmt-&gt;default_fetch_type;</span></a>
<a name="729"><span class="lineNum">     729 </span>            :         }</a>
<a name="730"><span class="lineNum">     730 </span><span class="lineCov">       1143 :         flags = how &amp; PDO_FETCH_FLAGS;</span></a>
<a name="731"><span class="lineNum">     731 </span><span class="lineCov">       1143 :         how = how &amp; ~PDO_FETCH_FLAGS;</span></a>
<a name="732"><span class="lineNum">     732 </span>            : </a>
<a name="733"><span class="lineNum">     733 </span><span class="lineCov">       1143 :         if (!do_fetch_common(stmt, ori, offset)) {</span></a>
<a name="734"><span class="lineNum">     734 </span><span class="lineCov">        297 :                 return 0;</span></a>
<a name="735"><span class="lineNum">     735 </span>            :         }</a>
<a name="736"><span class="lineNum">     736 </span>            : </a>
<a name="737"><span class="lineNum">     737 </span><span class="lineCov">        846 :         if (how == PDO_FETCH_BOUND) {</span></a>
<a name="738"><span class="lineNum">     738 </span><span class="lineCov">        129 :                 RETVAL_TRUE;</span></a>
<a name="739"><span class="lineNum">     739 </span><span class="lineCov">        129 :                 return 1;</span></a>
<a name="740"><span class="lineNum">     740 </span>            :         }</a>
<a name="741"><span class="lineNum">     741 </span>            : </a>
<a name="742"><span class="lineNum">     742 </span><span class="lineCov">        717 :         if ((flags &amp; PDO_FETCH_GROUP) &amp;&amp; stmt-&gt;fetch.column == -1) {</span></a>
<a name="743"><span class="lineNum">     743 </span><span class="lineCov">         63 :                 colno = 1;</span></a>
<a name="744"><span class="lineNum">     744 </span>            :         } else {</a>
<a name="745"><span class="lineNum">     745 </span><span class="lineCov">        654 :                 colno = stmt-&gt;fetch.column;</span></a>
<a name="746"><span class="lineNum">     746 </span>            :         }</a>
<a name="747"><span class="lineNum">     747 </span>            : </a>
<a name="748"><span class="lineNum">     748 </span>            :         /* If no return value we are done */</a>
<a name="749"><span class="lineNum">     749 </span><span class="lineCov">        717 :         if (!return_value) {</span></a>
<a name="750"><span class="lineNum">     750 </span><span class="lineNoCov">          0 :                 return true;</span></a>
<a name="751"><span class="lineNum">     751 </span>            :         }</a>
<a name="752"><span class="lineNum">     752 </span>            : </a>
<a name="753"><span class="lineNum">     753 </span><span class="lineCov">        717 :         if (how == PDO_FETCH_LAZY) {</span></a>
<a name="754"><span class="lineNum">     754 </span><span class="lineCov">         18 :                 get_lazy_object(stmt, return_value);</span></a>
<a name="755"><span class="lineNum">     755 </span><span class="lineCov">         18 :                 return 1;</span></a>
<a name="756"><span class="lineNum">     756 </span>            :         }</a>
<a name="757"><span class="lineNum">     757 </span>            : </a>
<a name="758"><span class="lineNum">     758 </span><span class="lineCov">        699 :         RETVAL_FALSE;</span></a>
<a name="759"><span class="lineNum">     759 </span>            : </a>
<a name="760"><span class="lineNum">     760 </span><span class="lineCov">        699 :         switch (how) {</span></a>
<a name="761"><span class="lineNum">     761 </span><span class="lineCov">        267 :                 case PDO_FETCH_USE_DEFAULT:</span></a>
<a name="762"><span class="lineNum">     762 </span>            :                 case PDO_FETCH_ASSOC:</a>
<a name="763"><span class="lineNum">     763 </span>            :                 case PDO_FETCH_BOTH:</a>
<a name="764"><span class="lineNum">     764 </span>            :                 case PDO_FETCH_NUM:</a>
<a name="765"><span class="lineNum">     765 </span>            :                 case PDO_FETCH_NAMED:</a>
<a name="766"><span class="lineNum">     766 </span><span class="lineCov">        267 :                         if (!return_all) {</span></a>
<a name="767"><span class="lineNum">     767 </span><span class="lineCov">        219 :                                 array_init_size(return_value, stmt-&gt;column_count);</span></a>
<a name="768"><span class="lineNum">     768 </span>            :                         } else {</a>
<a name="769"><span class="lineNum">     769 </span><span class="lineCov">         48 :                                 array_init(return_value);</span></a>
<a name="770"><span class="lineNum">     770 </span>            :                         }</a>
<a name="771"><span class="lineNum">     771 </span><span class="lineCov">        267 :                         break;</span></a>
<a name="772"><span class="lineNum">     772 </span>            : </a>
<a name="773"><span class="lineNum">     773 </span><span class="lineCov">         51 :                 case PDO_FETCH_KEY_PAIR:</span></a>
<a name="774"><span class="lineNum">     774 </span><span class="lineCov">         51 :                         if (stmt-&gt;column_count != 2) {</span></a>
<a name="775"><span class="lineNum">     775 </span>            :                                 /* TODO: Error? */</a>
<a name="776"><span class="lineNum">     776 </span><span class="lineCov">          3 :                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;PDO::FETCH_KEY_PAIR fetch mode requires the result set to contain exactly 2 columns.&quot;);</span></a>
<a name="777"><span class="lineNum">     777 </span><span class="lineCov">          3 :                                 return 0;</span></a>
<a name="778"><span class="lineNum">     778 </span>            :                         }</a>
<a name="779"><span class="lineNum">     779 </span><span class="lineCov">         48 :                         if (!return_all) {</span></a>
<a name="780"><span class="lineNum">     780 </span><span class="lineCov">          3 :                                 array_init(return_value);</span></a>
<a name="781"><span class="lineNum">     781 </span>            :                         }</a>
<a name="782"><span class="lineNum">     782 </span><span class="lineCov">         48 :                         break;</span></a>
<a name="783"><span class="lineNum">     783 </span>            : </a>
<a name="784"><span class="lineNum">     784 </span><span class="lineCov">        108 :                 case PDO_FETCH_COLUMN:</span></a>
<a name="785"><span class="lineNum">     785 </span><span class="lineCov">        108 :                         if (colno &lt; 0 ) {</span></a>
<a name="786"><span class="lineNum">     786 </span><span class="lineNoCov">          0 :                                 zend_value_error(&quot;Column index must be greater than or equal to 0&quot;);</span></a>
<a name="787"><span class="lineNum">     787 </span><span class="lineNoCov">          0 :                                 return false;</span></a>
<a name="788"><span class="lineNum">     788 </span>            :                         }</a>
<a name="789"><span class="lineNum">     789 </span>            : </a>
<a name="790"><span class="lineNum">     790 </span><span class="lineCov">        108 :                         if (colno &gt;= stmt-&gt;column_count) {</span></a>
<a name="791"><span class="lineNum">     791 </span><span class="lineNoCov">          0 :                                 zend_value_error(&quot;Invalid column index&quot;);</span></a>
<a name="792"><span class="lineNum">     792 </span><span class="lineNoCov">          0 :                                 return false;</span></a>
<a name="793"><span class="lineNum">     793 </span>            :                         }</a>
<a name="794"><span class="lineNum">     794 </span>            : </a>
<a name="795"><span class="lineNum">     795 </span><span class="lineCov">        108 :                         if (flags == PDO_FETCH_GROUP &amp;&amp; stmt-&gt;fetch.column == -1) {</span></a>
<a name="796"><span class="lineNum">     796 </span><span class="lineCov">         12 :                                 fetch_value(stmt, return_value, 1, NULL);</span></a>
<a name="797"><span class="lineNum">     797 </span><span class="lineCov">         96 :                         } else if (flags == PDO_FETCH_GROUP &amp;&amp; colno) {</span></a>
<a name="798"><span class="lineNum">     798 </span><span class="lineNoCov">          0 :                                 fetch_value(stmt, return_value, 0, NULL);</span></a>
<a name="799"><span class="lineNum">     799 </span>            :                         } else {</a>
<a name="800"><span class="lineNum">     800 </span><span class="lineCov">         96 :                                 fetch_value(stmt, return_value, colno, NULL);</span></a>
<a name="801"><span class="lineNum">     801 </span>            :                         }</a>
<a name="802"><span class="lineNum">     802 </span><span class="lineCov">        108 :                         if (!return_all) {</span></a>
<a name="803"><span class="lineNum">     803 </span><span class="lineCov">         27 :                                 return 1;</span></a>
<a name="804"><span class="lineNum">     804 </span>            :                         }</a>
<a name="805"><span class="lineNum">     805 </span><span class="lineCov">         81 :                         break;</span></a>
<a name="806"><span class="lineNum">     806 </span>            : </a>
<a name="807"><span class="lineNum">     807 </span><span class="lineCov">          9 :                 case PDO_FETCH_OBJ:</span></a>
<a name="808"><span class="lineNum">     808 </span><span class="lineCov">          9 :                         object_init_ex(return_value, ZEND_STANDARD_CLASS_DEF_PTR);</span></a>
<a name="809"><span class="lineNum">     809 </span><span class="lineCov">          9 :                         break;</span></a>
<a name="810"><span class="lineNum">     810 </span>            : </a>
<a name="811"><span class="lineNum">     811 </span><span class="lineCov">        126 :                 case PDO_FETCH_CLASS:</span></a>
<a name="812"><span class="lineNum">     812 </span><span class="lineCov">        126 :                         if (flags &amp; PDO_FETCH_CLASSTYPE) {</span></a>
<a name="813"><span class="lineNum">     813 </span>            :                                 zval val;</a>
<a name="814"><span class="lineNum">     814 </span>            :                                 zend_class_entry *cep;</a>
<a name="815"><span class="lineNum">     815 </span>            : </a>
<a name="816"><span class="lineNum">     816 </span><span class="lineCov">         48 :                                 old_ce = stmt-&gt;fetch.cls.ce;</span></a>
<a name="817"><span class="lineNum">     817 </span><span class="lineCov">         48 :                                 ZVAL_COPY_VALUE(&amp;old_ctor_args, &amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="818"><span class="lineNum">     818 </span><span class="lineCov">         48 :                                 old_arg_count = stmt-&gt;fetch.cls.fci.param_count;</span></a>
<a name="819"><span class="lineNum">     819 </span><span class="lineCov">         48 :                                 do_fetch_opt_finish(stmt, 0);</span></a>
<a name="820"><span class="lineNum">     820 </span>            : </a>
<a name="821"><span class="lineNum">     821 </span><span class="lineCov">         48 :                                 fetch_value(stmt, &amp;val, i++, NULL);</span></a>
<a name="822"><span class="lineNum">     822 </span><span class="lineCov">         48 :                                 if (Z_TYPE(val) != IS_NULL) {</span></a>
<a name="823"><span class="lineNum">     823 </span><span class="lineCov">         36 :                                         if (!try_convert_to_string(&amp;val)) {</span></a>
<a name="824"><span class="lineNum">     824 </span><span class="lineNoCov">          0 :                                                 return 0;</span></a>
<a name="825"><span class="lineNum">     825 </span>            :                                         }</a>
<a name="826"><span class="lineNum">     826 </span><span class="lineCov">         36 :                                         if ((cep = zend_lookup_class(Z_STR(val))) == NULL) {</span></a>
<a name="827"><span class="lineNum">     827 </span><span class="lineNoCov">          0 :                                                 stmt-&gt;fetch.cls.ce = ZEND_STANDARD_CLASS_DEF_PTR;</span></a>
<a name="828"><span class="lineNum">     828 </span>            :                                         } else {</a>
<a name="829"><span class="lineNum">     829 </span><span class="lineCov">         36 :                                                 stmt-&gt;fetch.cls.ce = cep;</span></a>
<a name="830"><span class="lineNum">     830 </span>            :                                         }</a>
<a name="831"><span class="lineNum">     831 </span>            :                                 }</a>
<a name="832"><span class="lineNum">     832 </span>            : </a>
<a name="833"><span class="lineNum">     833 </span><span class="lineCov">         48 :                                 do_fetch_class_prepare(stmt);</span></a>
<a name="834"><span class="lineNum">     834 </span>            :                                 zval_ptr_dtor_str(&amp;val);</a>
<a name="835"><span class="lineNum">     835 </span>            :                         }</a>
<a name="836"><span class="lineNum">     836 </span><span class="lineCov">        126 :                         ce = stmt-&gt;fetch.cls.ce;</span></a>
<a name="837"><span class="lineNum">     837 </span>            :                         /* TODO: Make this an assertion and ensure this is true higher up? */</a>
<a name="838"><span class="lineNum">     838 </span><span class="lineCov">        126 :                         if (!ce) {</span></a>
<a name="839"><span class="lineNum">     839 </span>            :                                 /* TODO Error? */</a>
<a name="840"><span class="lineNum">     840 </span><span class="lineCov">          3 :                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;No fetch class specified&quot;);</span></a>
<a name="841"><span class="lineNum">     841 </span><span class="lineCov">          3 :                                 return 0;</span></a>
<a name="842"><span class="lineNum">     842 </span>            :                         }</a>
<a name="843"><span class="lineNum">     843 </span><span class="lineCov">        123 :                         if ((flags &amp; PDO_FETCH_SERIALIZE) == 0) {</span></a>
<a name="844"><span class="lineNum">     844 </span><span class="lineCov">        108 :                                 if (UNEXPECTED(object_init_ex(return_value, ce) != SUCCESS)) {</span></a>
<a name="845"><span class="lineNum">     845 </span><span class="lineNoCov">          0 :                                         return 0;</span></a>
<a name="846"><span class="lineNum">     846 </span>            :                                 }</a>
<a name="847"><span class="lineNum">     847 </span><span class="lineCov">        108 :                                 if (!stmt-&gt;fetch.cls.fci.size) {</span></a>
<a name="848"><span class="lineNum">     848 </span><span class="lineCov">          9 :                                         if (!do_fetch_class_prepare(stmt)) {</span></a>
<a name="849"><span class="lineNum">     849 </span><span class="lineNoCov">          0 :                                                 zval_ptr_dtor(return_value);</span></a>
<a name="850"><span class="lineNum">     850 </span><span class="lineNoCov">          0 :                                                 return 0;</span></a>
<a name="851"><span class="lineNum">     851 </span>            :                                         }</a>
<a name="852"><span class="lineNum">     852 </span>            :                                 }</a>
<a name="853"><span class="lineNum">     853 </span><span class="lineCov">        108 :                                 if (ce-&gt;constructor &amp;&amp; (flags &amp; PDO_FETCH_PROPS_LATE)) {</span></a>
<a name="854"><span class="lineNum">     854 </span><span class="lineCov">         12 :                                         stmt-&gt;fetch.cls.fci.object = Z_OBJ_P(return_value);</span></a>
<a name="855"><span class="lineNum">     855 </span><span class="lineCov">         12 :                                         stmt-&gt;fetch.cls.fcc.object = Z_OBJ_P(return_value);</span></a>
<a name="856"><span class="lineNum">     856 </span><span class="lineCov">         12 :                                         if (zend_call_function(&amp;stmt-&gt;fetch.cls.fci, &amp;stmt-&gt;fetch.cls.fcc) == FAILURE) {</span></a>
<a name="857"><span class="lineNum">     857 </span>            :                                                 /* TODO Error? */</a>
<a name="858"><span class="lineNum">     858 </span><span class="lineNoCov">          0 :                                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;could not call class constructor&quot;);</span></a>
<a name="859"><span class="lineNum">     859 </span><span class="lineNoCov">          0 :                                                 return 0;</span></a>
<a name="860"><span class="lineNum">     860 </span>            :                                         } else {</a>
<a name="861"><span class="lineNum">     861 </span><span class="lineCov">         24 :                                                 if (!Z_ISUNDEF(stmt-&gt;fetch.cls.retval)) {</span></a>
<a name="862"><span class="lineNum">     862 </span><span class="lineCov">         12 :                                                         zval_ptr_dtor(&amp;stmt-&gt;fetch.cls.retval);</span></a>
<a name="863"><span class="lineNum">     863 </span><span class="lineCov">         12 :                                                         ZVAL_UNDEF(&amp;stmt-&gt;fetch.cls.retval);</span></a>
<a name="864"><span class="lineNum">     864 </span>            :                                                 }</a>
<a name="865"><span class="lineNum">     865 </span>            :                                         }</a>
<a name="866"><span class="lineNum">     866 </span>            :                                 }</a>
<a name="867"><span class="lineNum">     867 </span>            :                         }</a>
<a name="868"><span class="lineNum">     868 </span><span class="lineCov">        123 :                         break;</span></a>
<a name="869"><span class="lineNum">     869 </span>            : </a>
<a name="870"><span class="lineNum">     870 </span><span class="lineCov">         21 :                 case PDO_FETCH_INTO:</span></a>
<a name="871"><span class="lineNum">     871 </span>            :                         /* TODO: Make this an assertion and ensure this is true higher up? */</a>
<a name="872"><span class="lineNum">     872 </span><span class="lineCov">         42 :                         if (Z_ISUNDEF(stmt-&gt;fetch.into)) {</span></a>
<a name="873"><span class="lineNum">     873 </span>            :                                 /* TODO ArgumentCountError? */</a>
<a name="874"><span class="lineNum">     874 </span><span class="lineNoCov">          0 :                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;No fetch-into object specified.&quot;);</span></a>
<a name="875"><span class="lineNum">     875 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="876"><span class="lineNum">     876 </span>            :                                 break;</a>
<a name="877"><span class="lineNum">     877 </span>            :                         }</a>
<a name="878"><span class="lineNum">     878 </span>            : </a>
<a name="879"><span class="lineNum">     879 </span><span class="lineCov">         21 :                         ZVAL_COPY(return_value, &amp;stmt-&gt;fetch.into);</span></a>
<a name="880"><span class="lineNum">     880 </span>            : </a>
<a name="881"><span class="lineNum">     881 </span><span class="lineCov">         21 :                         if (Z_OBJ_P(return_value)-&gt;ce == ZEND_STANDARD_CLASS_DEF_PTR) {</span></a>
<a name="882"><span class="lineNum">     882 </span><span class="lineNoCov">          0 :                                 how = PDO_FETCH_OBJ;</span></a>
<a name="883"><span class="lineNum">     883 </span>            :                         }</a>
<a name="884"><span class="lineNum">     884 </span><span class="lineCov">         21 :                         break;</span></a>
<a name="885"><span class="lineNum">     885 </span>            : </a>
<a name="886"><span class="lineNum">     886 </span><span class="lineCov">        117 :                 case PDO_FETCH_FUNC:</span></a>
<a name="887"><span class="lineNum">     887 </span>            :                         /* TODO: Make this an assertion and ensure this is true higher up? */</a>
<a name="888"><span class="lineNum">     888 </span><span class="lineCov">        234 :                         if (Z_ISUNDEF(stmt-&gt;fetch.func.function)) {</span></a>
<a name="889"><span class="lineNum">     889 </span>            :                                 /* TODO ArgumentCountError? */</a>
<a name="890"><span class="lineNum">     890 </span><span class="lineCov">          3 :                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;No fetch function specified&quot;);</span></a>
<a name="891"><span class="lineNum">     891 </span><span class="lineCov">          3 :                                 return 0;</span></a>
<a name="892"><span class="lineNum">     892 </span>            :                         }</a>
<a name="893"><span class="lineNum">     893 </span><span class="lineCov">        114 :                         if (!stmt-&gt;fetch.func.fci.size) {</span></a>
<a name="894"><span class="lineNum">     894 </span><span class="lineNoCov">          0 :                                 if (!do_fetch_func_prepare(stmt))</span></a>
<a name="895"><span class="lineNum">     895 </span>            :                                 {</a>
<a name="896"><span class="lineNum">     896 </span><span class="lineNoCov">          0 :                                         return 0;</span></a>
<a name="897"><span class="lineNum">     897 </span>            :                                 }</a>
<a name="898"><span class="lineNum">     898 </span>            :                         }</a>
<a name="899"><span class="lineNum">     899 </span><span class="lineCov">        114 :                         break;</span></a>
<a name="900"><span class="lineNum">     900 </span><span class="lineNoCov">          0 :                 EMPTY_SWITCH_DEFAULT_CASE();</span></a>
<a name="901"><span class="lineNum">     901 </span>            :         }</a>
<a name="902"><span class="lineNum">     902 </span>            : </a>
<a name="903"><span class="lineNum">     903 </span><span class="lineCov">        663 :         if (return_all &amp;&amp; how != PDO_FETCH_KEY_PAIR) {</span></a>
<a name="904"><span class="lineNum">     904 </span><span class="lineCov">        165 :                 if (flags == PDO_FETCH_GROUP &amp;&amp; how == PDO_FETCH_COLUMN &amp;&amp; stmt-&gt;fetch.column &gt; 0) {</span></a>
<a name="905"><span class="lineNum">     905 </span><span class="lineNoCov">          0 :                         fetch_value(stmt, &amp;grp_val, colno, NULL);</span></a>
<a name="906"><span class="lineNum">     906 </span>            :                 } else {</a>
<a name="907"><span class="lineNum">     907 </span><span class="lineCov">        165 :                         fetch_value(stmt, &amp;grp_val, i, NULL);</span></a>
<a name="908"><span class="lineNum">     908 </span>            :                 }</a>
<a name="909"><span class="lineNum">     909 </span><span class="lineCov">        165 :                 convert_to_string(&amp;grp_val);</span></a>
<a name="910"><span class="lineNum">     910 </span><span class="lineCov">        165 :                 if (how == PDO_FETCH_COLUMN) {</span></a>
<a name="911"><span class="lineNum">     911 </span><span class="lineCov">         81 :                         i = stmt-&gt;column_count; /* no more data to fetch */</span></a>
<a name="912"><span class="lineNum">     912 </span>            :                 } else {</a>
<a name="913"><span class="lineNum">     913 </span><span class="lineCov">         84 :                         i++;</span></a>
<a name="914"><span class="lineNum">     914 </span>            :                 }</a>
<a name="915"><span class="lineNum">     915 </span>            :         }</a>
<a name="916"><span class="lineNum">     916 </span>            : </a>
<a name="917"><span class="lineNum">     917 </span><span class="lineCov">       1701 :         for (idx = 0; i &lt; stmt-&gt;column_count; i++, idx++) {</span></a>
<a name="918"><span class="lineNum">     918 </span>            :                 zval val;</a>
<a name="919"><span class="lineNum">     919 </span><span class="lineCov">       1089 :                 fetch_value(stmt, &amp;val, i, NULL);</span></a>
<a name="920"><span class="lineNum">     920 </span>            : </a>
<a name="921"><span class="lineNum">     921 </span><span class="lineCov">       1089 :                 switch (how) {</span></a>
<a name="922"><span class="lineNum">     922 </span><span class="lineCov">        297 :                         case PDO_FETCH_ASSOC:</span></a>
<a name="923"><span class="lineNum">     923 </span><span class="lineCov">        297 :                                 zend_symtable_update(Z_ARRVAL_P(return_value), stmt-&gt;columns[i].name, &amp;val);</span></a>
<a name="924"><span class="lineNum">     924 </span><span class="lineCov">        297 :                                 break;</span></a>
<a name="925"><span class="lineNum">     925 </span>            : </a>
<a name="926"><span class="lineNum">     926 </span><span class="lineCov">         48 :                         case PDO_FETCH_KEY_PAIR:</span></a>
<a name="927"><span class="lineNum">     927 </span>            :                                 {</a>
<a name="928"><span class="lineNum">     928 </span>            :                                         zval tmp;</a>
<a name="929"><span class="lineNum">     929 </span><span class="lineCov">         48 :                                         fetch_value(stmt, &amp;tmp, ++i, NULL);</span></a>
<a name="930"><span class="lineNum">     930 </span>            : </a>
<a name="931"><span class="lineNum">     931 </span><span class="lineCov">         48 :                                         if (Z_TYPE(val) == IS_LONG) {</span></a>
<a name="932"><span class="lineNum">     932 </span><span class="lineNoCov">          0 :                                                 zend_hash_index_update((return_all ? Z_ARRVAL_P(return_all) : Z_ARRVAL_P(return_value)), Z_LVAL(val), &amp;tmp);</span></a>
<a name="933"><span class="lineNum">     933 </span>            :                                         } else {</a>
<a name="934"><span class="lineNum">     934 </span><span class="lineCov">         48 :                                                 convert_to_string(&amp;val);</span></a>
<a name="935"><span class="lineNum">     935 </span><span class="lineCov">         48 :                                                 zend_symtable_update((return_all ? Z_ARRVAL_P(return_all) : Z_ARRVAL_P(return_value)), Z_STR(val), &amp;tmp);</span></a>
<a name="936"><span class="lineNum">     936 </span>            :                                         }</a>
<a name="937"><span class="lineNum">     937 </span><span class="lineCov">         48 :                                         zval_ptr_dtor(&amp;val);</span></a>
<a name="938"><span class="lineNum">     938 </span><span class="lineCov">         48 :                                         return 1;</span></a>
<a name="939"><span class="lineNum">     939 </span>            :                                 }</a>
<a name="940"><span class="lineNum">     940 </span>            :                                 break;</a>
<a name="941"><span class="lineNum">     941 </span>            : </a>
<a name="942"><span class="lineNum">     942 </span><span class="lineCov">         84 :                         case PDO_FETCH_USE_DEFAULT:</span></a>
<a name="943"><span class="lineNum">     943 </span>            :                         case PDO_FETCH_BOTH:</a>
<a name="944"><span class="lineNum">     944 </span><span class="lineCov">         84 :                                 zend_symtable_update(Z_ARRVAL_P(return_value), stmt-&gt;columns[i].name, &amp;val);</span></a>
<a name="945"><span class="lineNum">     945 </span><span class="lineCov">         84 :                                 if (zend_hash_index_add(Z_ARRVAL_P(return_value), i, &amp;val) != NULL) {</span></a>
<a name="946"><span class="lineNum">     946 </span><span class="lineCov">         81 :                                         Z_TRY_ADDREF(val);</span></a>
<a name="947"><span class="lineNum">     947 </span>            :                                 }</a>
<a name="948"><span class="lineNum">     948 </span><span class="lineCov">         84 :                                 break;</span></a>
<a name="949"><span class="lineNum">     949 </span>            : </a>
<a name="950"><span class="lineNum">     950 </span><span class="lineNoCov">          0 :                         case PDO_FETCH_NAMED:</span></a>
<a name="951"><span class="lineNum">     951 </span>            :                                 /* already have an item with this name? */</a>
<a name="952"><span class="lineNum">     952 </span>            :                                 {</a>
<a name="953"><span class="lineNum">     953 </span>            :                                         zval *curr_val;</a>
<a name="954"><span class="lineNum">     954 </span><span class="lineNoCov">          0 :                                         if ((curr_val = zend_hash_find(Z_ARRVAL_P(return_value), stmt-&gt;columns[i].name))) {</span></a>
<a name="955"><span class="lineNum">     955 </span>            :                                                 zval arr;</a>
<a name="956"><span class="lineNum">     956 </span><span class="lineNoCov">          0 :                                                 if (Z_TYPE_P(curr_val) != IS_ARRAY) {</span></a>
<a name="957"><span class="lineNum">     957 </span>            :                                                         /* a little bit of black magic here:</a>
<a name="958"><span class="lineNum">     958 </span>            :                                                          * we're creating a new array and swapping it for the</a>
<a name="959"><span class="lineNum">     959 </span>            :                                                          * zval that's already stored in the hash under the name</a>
<a name="960"><span class="lineNum">     960 </span>            :                                                          * we want.  We then add that zval to the array.</a>
<a name="961"><span class="lineNum">     961 </span>            :                                                          * This is effectively the same thing as:</a>
<a name="962"><span class="lineNum">     962 </span>            :                                                          * if (!is_array($hash[$name])) {</a>
<a name="963"><span class="lineNum">     963 </span>            :                                                          *   $hash[$name] = array($hash[$name]);</a>
<a name="964"><span class="lineNum">     964 </span>            :                                                          * }</a>
<a name="965"><span class="lineNum">     965 </span>            :                                                          * */</a>
<a name="966"><span class="lineNum">     966 </span>            :                                                         zval cur;</a>
<a name="967"><span class="lineNum">     967 </span>            : </a>
<a name="968"><span class="lineNum">     968 </span><span class="lineNoCov">          0 :                                                         array_init(&amp;arr);</span></a>
<a name="969"><span class="lineNum">     969 </span>            : </a>
<a name="970"><span class="lineNum">     970 </span><span class="lineNoCov">          0 :                                                         ZVAL_COPY_VALUE(&amp;cur, curr_val);</span></a>
<a name="971"><span class="lineNum">     971 </span><span class="lineNoCov">          0 :                                                         ZVAL_COPY_VALUE(curr_val, &amp;arr);</span></a>
<a name="972"><span class="lineNum">     972 </span>            : </a>
<a name="973"><span class="lineNum">     973 </span><span class="lineNoCov">          0 :                                                         zend_hash_next_index_insert_new(Z_ARRVAL(arr), &amp;cur);</span></a>
<a name="974"><span class="lineNum">     974 </span>            :                                                 } else {</a>
<a name="975"><span class="lineNum">     975 </span><span class="lineNoCov">          0 :                                                         ZVAL_COPY_VALUE(&amp;arr, curr_val);</span></a>
<a name="976"><span class="lineNum">     976 </span>            :                                                 }</a>
<a name="977"><span class="lineNum">     977 </span><span class="lineNoCov">          0 :                                                 zend_hash_next_index_insert_new(Z_ARRVAL(arr), &amp;val);</span></a>
<a name="978"><span class="lineNum">     978 </span>            :                                         } else {</a>
<a name="979"><span class="lineNum">     979 </span><span class="lineNoCov">          0 :                                                 zend_hash_update(Z_ARRVAL_P(return_value), stmt-&gt;columns[i].name, &amp;val);</span></a>
<a name="980"><span class="lineNum">     980 </span>            :                                         }</a>
<a name="981"><span class="lineNum">     981 </span>            :                                 }</a>
<a name="982"><span class="lineNum">     982 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="983"><span class="lineNum">     983 </span>            : </a>
<a name="984"><span class="lineNum">     984 </span><span class="lineCov">        120 :                         case PDO_FETCH_NUM:</span></a>
<a name="985"><span class="lineNum">     985 </span><span class="lineCov">        120 :                                 zend_hash_next_index_insert_new(Z_ARRVAL_P(return_value), &amp;val);</span></a>
<a name="986"><span class="lineNum">     986 </span><span class="lineCov">        120 :                                 break;</span></a>
<a name="987"><span class="lineNum">     987 </span>            : </a>
<a name="988"><span class="lineNum">     988 </span><span class="lineCov">         81 :                         case PDO_FETCH_OBJ:</span></a>
<a name="989"><span class="lineNum">     989 </span>            :                         case PDO_FETCH_INTO:</a>
<a name="990"><span class="lineNum">     990 </span><span class="lineCov">         81 :                                 zend_update_property_ex(NULL, Z_OBJ_P(return_value),</span></a>
<a name="991"><span class="lineNum">     991 </span><span class="lineCov">         81 :                                         stmt-&gt;columns[i].name,</span></a>
<a name="992"><span class="lineNum">     992 </span>            :                                         &amp;val);</a>
<a name="993"><span class="lineNum">     993 </span><span class="lineCov">         81 :                                 zval_ptr_dtor(&amp;val);</span></a>
<a name="994"><span class="lineNum">     994 </span><span class="lineCov">         81 :                                 break;</span></a>
<a name="995"><span class="lineNum">     995 </span>            : </a>
<a name="996"><span class="lineNum">     996 </span><span class="lineCov">        255 :                         case PDO_FETCH_CLASS:</span></a>
<a name="997"><span class="lineNum">     997 </span><span class="lineCov">        255 :                                 if ((flags &amp; PDO_FETCH_SERIALIZE) == 0 || idx) {</span></a>
<a name="998"><span class="lineNum">     998 </span><span class="lineCov">        240 :                                         zend_update_property_ex(ce, Z_OBJ_P(return_value),</span></a>
<a name="999"><span class="lineNum">     999 </span><span class="lineCov">        240 :                                                 stmt-&gt;columns[i].name,</span></a>
<a name="1000"><span class="lineNum">    1000 </span>            :                                                 &amp;val);</a>
<a name="1001"><span class="lineNum">    1001 </span><span class="lineCov">        240 :                                         zval_ptr_dtor(&amp;val);</span></a>
<a name="1002"><span class="lineNum">    1002 </span>            :                                 } else {</a>
<a name="1003"><span class="lineNum">    1003 </span><span class="lineCov">         15 :                                         if (!ce-&gt;unserialize) {</span></a>
<a name="1004"><span class="lineNum">    1004 </span><span class="lineCov">          3 :                                                 zval_ptr_dtor(&amp;val);</span></a>
<a name="1005"><span class="lineNum">    1005 </span><span class="lineCov">          3 :                                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;cannot unserialize class&quot;);</span></a>
<a name="1006"><span class="lineNum">    1006 </span><span class="lineCov">          3 :                                                 return 0;</span></a>
<a name="1007"><span class="lineNum">    1007 </span><span class="lineCov">         36 :                                         } else if (ce-&gt;unserialize(return_value, ce, (unsigned char *)(Z_TYPE(val) == IS_STRING ? Z_STRVAL(val) : &quot;&quot;), Z_TYPE(val) == IS_STRING ? Z_STRLEN(val) : 0, NULL) == FAILURE) {</span></a>
<a name="1008"><span class="lineNum">    1008 </span><span class="lineNoCov">          0 :                                                 zval_ptr_dtor(&amp;val);</span></a>
<a name="1009"><span class="lineNum">    1009 </span><span class="lineNoCov">          0 :                                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;cannot unserialize class&quot;);</span></a>
<a name="1010"><span class="lineNum">    1010 </span><span class="lineNoCov">          0 :                                                 zval_ptr_dtor(return_value);</span></a>
<a name="1011"><span class="lineNum">    1011 </span><span class="lineNoCov">          0 :                                                 ZVAL_NULL(return_value);</span></a>
<a name="1012"><span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                                                 return 0;</span></a>
<a name="1013"><span class="lineNum">    1013 </span>            :                                         } else {</a>
<a name="1014"><span class="lineNum">    1014 </span><span class="lineCov">         12 :                                                 zval_ptr_dtor(&amp;val);</span></a>
<a name="1015"><span class="lineNum">    1015 </span>            :                                         }</a>
<a name="1016"><span class="lineNum">    1016 </span>            :                                 }</a>
<a name="1017"><span class="lineNum">    1017 </span><span class="lineCov">        252 :                                 break;</span></a>
<a name="1018"><span class="lineNum">    1018 </span>            : </a>
<a name="1019"><span class="lineNum">    1019 </span><span class="lineCov">        204 :                         case PDO_FETCH_FUNC:</span></a>
<a name="1020"><span class="lineNum">    1020 </span><span class="lineCov">        204 :                                 ZVAL_COPY_VALUE(&amp;stmt-&gt;fetch.func.values[idx], &amp;val);</span></a>
<a name="1021"><span class="lineNum">    1021 </span><span class="lineCov">        204 :                                 ZVAL_COPY_VALUE(&amp;stmt-&gt;fetch.cls.fci.params[idx], &amp;stmt-&gt;fetch.func.values[idx]);</span></a>
<a name="1022"><span class="lineNum">    1022 </span><span class="lineCov">        204 :                                 break;</span></a>
<a name="1023"><span class="lineNum">    1023 </span>            : </a>
<a name="1024"><span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                         default:</span></a>
<a name="1025"><span class="lineNum">    1025 </span><span class="lineNoCov">          0 :                                 zval_ptr_dtor(&amp;val);</span></a>
<a name="1026"><span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                                 zend_value_error(&quot;Fetch mode must be a bitmask of PDO::FETCH_* constants&quot;);</span></a>
<a name="1027"><span class="lineNum">    1027 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="1028"><span class="lineNum">    1028 </span>            :                 }</a>
<a name="1029"><span class="lineNum">    1029 </span>            :         }</a>
<a name="1030"><span class="lineNum">    1030 </span>            : </a>
<a name="1031"><span class="lineNum">    1031 </span><span class="lineCov">        612 :         switch (how) {</span></a>
<a name="1032"><span class="lineNum">    1032 </span><span class="lineCov">        120 :                 case PDO_FETCH_CLASS:</span></a>
<a name="1033"><span class="lineNum">    1033 </span><span class="lineCov">        120 :                         if (ce-&gt;constructor &amp;&amp; !(flags &amp; (PDO_FETCH_PROPS_LATE | PDO_FETCH_SERIALIZE))) {</span></a>
<a name="1034"><span class="lineNum">    1034 </span><span class="lineCov">         66 :                                 stmt-&gt;fetch.cls.fci.object = Z_OBJ_P(return_value);</span></a>
<a name="1035"><span class="lineNum">    1035 </span><span class="lineCov">         66 :                                 stmt-&gt;fetch.cls.fcc.object = Z_OBJ_P(return_value);</span></a>
<a name="1036"><span class="lineNum">    1036 </span><span class="lineCov">         66 :                                 if (zend_call_function(&amp;stmt-&gt;fetch.cls.fci, &amp;stmt-&gt;fetch.cls.fcc) == FAILURE) {</span></a>
<a name="1037"><span class="lineNum">    1037 </span>            :                                         /* TODO Error? */</a>
<a name="1038"><span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                                         pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;could not call class constructor&quot;);</span></a>
<a name="1039"><span class="lineNum">    1039 </span><span class="lineNoCov">          0 :                                         return 0;</span></a>
<a name="1040"><span class="lineNum">    1040 </span>            :                                 } else {</a>
<a name="1041"><span class="lineNum">    1041 </span><span class="lineCov">        132 :                                         if (!Z_ISUNDEF(stmt-&gt;fetch.cls.retval)) {</span></a>
<a name="1042"><span class="lineNum">    1042 </span><span class="lineCov">         66 :                                                 zval_ptr_dtor(&amp;stmt-&gt;fetch.cls.retval);</span></a>
<a name="1043"><span class="lineNum">    1043 </span>            :                                         }</a>
<a name="1044"><span class="lineNum">    1044 </span>            :                                 }</a>
<a name="1045"><span class="lineNum">    1045 </span>            :                         }</a>
<a name="1046"><span class="lineNum">    1046 </span><span class="lineCov">        120 :                         if (flags &amp; PDO_FETCH_CLASSTYPE) {</span></a>
<a name="1047"><span class="lineNum">    1047 </span><span class="lineCov">         45 :                                 do_fetch_opt_finish(stmt, 0);</span></a>
<a name="1048"><span class="lineNum">    1048 </span><span class="lineCov">         45 :                                 stmt-&gt;fetch.cls.ce = old_ce;</span></a>
<a name="1049"><span class="lineNum">    1049 </span><span class="lineCov">         45 :                                 ZVAL_COPY_VALUE(&amp;stmt-&gt;fetch.cls.ctor_args, &amp;old_ctor_args);</span></a>
<a name="1050"><span class="lineNum">    1050 </span><span class="lineCov">         45 :                                 stmt-&gt;fetch.cls.fci.param_count = old_arg_count;</span></a>
<a name="1051"><span class="lineNum">    1051 </span>            :                         }</a>
<a name="1052"><span class="lineNum">    1052 </span><span class="lineCov">        120 :                         break;</span></a>
<a name="1053"><span class="lineNum">    1053 </span>            : </a>
<a name="1054"><span class="lineNum">    1054 </span><span class="lineCov">        114 :                 case PDO_FETCH_FUNC:</span></a>
<a name="1055"><span class="lineNum">    1055 </span><span class="lineCov">        114 :                         stmt-&gt;fetch.func.fci.param_count = idx;</span></a>
<a name="1056"><span class="lineNum">    1056 </span><span class="lineCov">        114 :                         stmt-&gt;fetch.func.fci.retval = &amp;retval;</span></a>
<a name="1057"><span class="lineNum">    1057 </span><span class="lineCov">        114 :                         if (zend_call_function(&amp;stmt-&gt;fetch.func.fci, &amp;stmt-&gt;fetch.func.fcc) == FAILURE) {</span></a>
<a name="1058"><span class="lineNum">    1058 </span>            :                                 /* TODO Error? */</a>
<a name="1059"><span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;HY000&quot;, &quot;could not call user-supplied function&quot;);</span></a>
<a name="1060"><span class="lineNum">    1060 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="1061"><span class="lineNum">    1061 </span>            :                         } else {</a>
<a name="1062"><span class="lineNum">    1062 </span><span class="lineCov">        114 :                                 if (return_all) {</span></a>
<a name="1063"><span class="lineNum">    1063 </span><span class="lineCov">         12 :                                         zval_ptr_dtor(return_value); /* we don't need that */</span></a>
<a name="1064"><span class="lineNum">    1064 </span><span class="lineCov">         12 :                                         ZVAL_COPY_VALUE(return_value, &amp;retval);</span></a>
<a name="1065"><span class="lineNum">    1065 </span><span class="lineCov">        102 :                                 } else if (!Z_ISUNDEF(retval)) {</span></a>
<a name="1066"><span class="lineNum">    1066 </span><span class="lineCov">        102 :                                         ZVAL_COPY_VALUE(return_value, &amp;retval);</span></a>
<a name="1067"><span class="lineNum">    1067 </span>            :                                 }</a>
<a name="1068"><span class="lineNum">    1068 </span>            :                         }</a>
<a name="1069"><span class="lineNum">    1069 </span><span class="lineCov">        318 :                         while (idx--) {</span></a>
<a name="1070"><span class="lineNum">    1070 </span><span class="lineCov">        204 :                                 zval_ptr_dtor(&amp;stmt-&gt;fetch.func.values[idx]);</span></a>
<a name="1071"><span class="lineNum">    1071 </span>            :                         }</a>
<a name="1072"><span class="lineNum">    1072 </span><span class="lineCov">        114 :                         break;</span></a>
<a name="1073"><span class="lineNum">    1073 </span>            : </a>
<a name="1074"><span class="lineNum">    1074 </span><span class="lineCov">        378 :                 default:</span></a>
<a name="1075"><span class="lineNum">    1075 </span><span class="lineCov">        378 :                         break;</span></a>
<a name="1076"><span class="lineNum">    1076 </span>            :         }</a>
<a name="1077"><span class="lineNum">    1077 </span>            : </a>
<a name="1078"><span class="lineNum">    1078 </span><span class="lineCov">        612 :         if (return_all) {</span></a>
<a name="1079"><span class="lineNum">    1079 </span><span class="lineCov">        165 :                 if ((flags &amp; PDO_FETCH_UNIQUE) == PDO_FETCH_UNIQUE) {</span></a>
<a name="1080"><span class="lineNum">    1080 </span><span class="lineCov">        108 :                         zend_symtable_update(Z_ARRVAL_P(return_all), Z_STR(grp_val), return_value);</span></a>
<a name="1081"><span class="lineNum">    1081 </span>            :                 } else {</a>
<a name="1082"><span class="lineNum">    1082 </span>            :                         zval grp;</a>
<a name="1083"><span class="lineNum">    1083 </span><span class="lineCov">        114 :                         if ((pgrp = zend_symtable_find(Z_ARRVAL_P(return_all), Z_STR(grp_val))) == NULL) {</span></a>
<a name="1084"><span class="lineNum">    1084 </span><span class="lineCov">         36 :                                 array_init(&amp;grp);</span></a>
<a name="1085"><span class="lineNum">    1085 </span><span class="lineCov">         36 :                                 zend_symtable_update(Z_ARRVAL_P(return_all), Z_STR(grp_val), &amp;grp);</span></a>
<a name="1086"><span class="lineNum">    1086 </span>            :                         } else {</a>
<a name="1087"><span class="lineNum">    1087 </span><span class="lineCov">         21 :                                 ZVAL_COPY_VALUE(&amp;grp, pgrp);</span></a>
<a name="1088"><span class="lineNum">    1088 </span>            :                         }</a>
<a name="1089"><span class="lineNum">    1089 </span><span class="lineCov">         57 :                         zend_hash_next_index_insert(Z_ARRVAL(grp), return_value);</span></a>
<a name="1090"><span class="lineNum">    1090 </span>            :                 }</a>
<a name="1091"><span class="lineNum">    1091 </span>            :                 zval_ptr_dtor_str(&amp;grp_val);</a>
<a name="1092"><span class="lineNum">    1092 </span>            :         }</a>
<a name="1093"><span class="lineNum">    1093 </span>            : </a>
<a name="1094"><span class="lineNum">    1094 </span><span class="lineCov">        612 :         return 1;</span></a>
<a name="1095"><span class="lineNum">    1095 </span>            : }</a>
<a name="1096"><span class="lineNum">    1096 </span>            : /* }}} */</a>
<a name="1097"><span class="lineNum">    1097 </span>            : </a>
<a name="1098"><span class="lineNum">    1098 </span><span class="lineCov">        552 : static bool pdo_stmt_verify_mode(pdo_stmt_t *stmt, zend_long mode, uint32_t mode_arg_num, bool fetch_all) /* {{{ */</span></a>
<a name="1099"><span class="lineNum">    1099 </span>            : {</a>
<a name="1100"><span class="lineNum">    1100 </span><span class="lineCov">        552 :         int flags = mode &amp; PDO_FETCH_FLAGS;</span></a>
<a name="1101"><span class="lineNum">    1101 </span>            : </a>
<a name="1102"><span class="lineNum">    1102 </span><span class="lineCov">        552 :         mode = mode &amp; ~PDO_FETCH_FLAGS;</span></a>
<a name="1103"><span class="lineNum">    1103 </span>            : </a>
<a name="1104"><span class="lineNum">    1104 </span><span class="lineCov">        552 :         if (mode &lt; 0 || mode &gt; PDO_FETCH__MAX) {</span></a>
<a name="1105"><span class="lineNum">    1105 </span><span class="lineNoCov">          0 :                 zend_argument_value_error(mode_arg_num, &quot;must be a bitmask of PDO::FETCH_* constants&quot;);</span></a>
<a name="1106"><span class="lineNum">    1106 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="1107"><span class="lineNum">    1107 </span>            :         }</a>
<a name="1108"><span class="lineNum">    1108 </span>            : </a>
<a name="1109"><span class="lineNum">    1109 </span><span class="lineCov">        552 :         if (mode == PDO_FETCH_USE_DEFAULT) {</span></a>
<a name="1110"><span class="lineNum">    1110 </span><span class="lineCov">         51 :                 flags = stmt-&gt;default_fetch_type &amp; PDO_FETCH_FLAGS;</span></a>
<a name="1111"><span class="lineNum">    1111 </span><span class="lineCov">         51 :                 mode = stmt-&gt;default_fetch_type &amp; ~PDO_FETCH_FLAGS;</span></a>
<a name="1112"><span class="lineNum">    1112 </span>            :         }</a>
<a name="1113"><span class="lineNum">    1113 </span>            : </a>
<a name="1114"><span class="lineNum">    1114 </span><span class="lineCov">        552 :         switch(mode) {</span></a>
<a name="1115"><span class="lineNum">    1115 </span><span class="lineCov">         66 :                 case PDO_FETCH_FUNC:</span></a>
<a name="1116"><span class="lineNum">    1116 </span><span class="lineCov">         66 :                         if (!fetch_all) {</span></a>
<a name="1117"><span class="lineNum">    1117 </span><span class="lineNoCov">          0 :                                 zend_value_error(&quot;Can only use PDO::FETCH_FUNC in PDOStatement::fetchAll()&quot;);</span></a>
<a name="1118"><span class="lineNum">    1118 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="1119"><span class="lineNum">    1119 </span>            :                         }</a>
<a name="1120"><span class="lineNum">    1120 </span><span class="lineCov">         66 :                         return 1;</span></a>
<a name="1121"><span class="lineNum">    1121 </span>            : </a>
<a name="1122"><span class="lineNum">    1122 </span><span class="lineCov">         18 :                 case PDO_FETCH_LAZY:</span></a>
<a name="1123"><span class="lineNum">    1123 </span><span class="lineCov">         18 :                         if (fetch_all) {</span></a>
<a name="1124"><span class="lineNum">    1124 </span><span class="lineNoCov">          0 :                                 zend_argument_value_error(mode_arg_num, &quot;cannot be PDO::FETCH_LAZY in PDOStatement::fetchAll()&quot;);</span></a>
<a name="1125"><span class="lineNum">    1125 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="1126"><span class="lineNum">    1126 </span>            :                         }</a>
<a name="1127"><span class="lineNum">    1127 </span>            :                         ZEND_FALLTHROUGH;</a>
<a name="1128"><span class="lineNum">    1128 </span>            :                 default:</a>
<a name="1129"><span class="lineNum">    1129 </span><span class="lineCov">        405 :                         if ((flags &amp; PDO_FETCH_SERIALIZE) == PDO_FETCH_SERIALIZE) {</span></a>
<a name="1130"><span class="lineNum">    1130 </span><span class="lineNoCov">          0 :                                 zend_argument_value_error(mode_arg_num, &quot;must use PDO::FETCH_SERIALIZE with PDO::FETCH_CLASS&quot;);</span></a>
<a name="1131"><span class="lineNum">    1131 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="1132"><span class="lineNum">    1132 </span>            :                         }</a>
<a name="1133"><span class="lineNum">    1133 </span><span class="lineCov">        405 :                         if ((flags &amp; PDO_FETCH_CLASSTYPE) == PDO_FETCH_CLASSTYPE) {</span></a>
<a name="1134"><span class="lineNum">    1134 </span><span class="lineNoCov">          0 :                                 zend_argument_value_error(mode_arg_num, &quot;must use PDO::FETCH_CLASSTYPE with PDO::FETCH_CLASS&quot;);</span></a>
<a name="1135"><span class="lineNum">    1135 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="1136"><span class="lineNum">    1136 </span>            :                         }</a>
<a name="1137"><span class="lineNum">    1137 </span><span class="lineCov">        405 :                         if (mode &gt;= PDO_FETCH__MAX) {</span></a>
<a name="1138"><span class="lineNum">    1138 </span><span class="lineNoCov">          0 :                                 zend_argument_value_error(mode_arg_num, &quot;must be a bitmask of PDO::FETCH_* constants&quot;);</span></a>
<a name="1139"><span class="lineNum">    1139 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="1140"><span class="lineNum">    1140 </span>            :                         }</a>
<a name="1141"><span class="lineNum">    1141 </span>            :                         ZEND_FALLTHROUGH;</a>
<a name="1142"><span class="lineNum">    1142 </span>            : </a>
<a name="1143"><span class="lineNum">    1143 </span>            :                 case PDO_FETCH_CLASS:</a>
<a name="1144"><span class="lineNum">    1144 </span><span class="lineCov">        486 :                         if (flags &amp; PDO_FETCH_SERIALIZE) {</span></a>
<a name="1145"><span class="lineNum">    1145 </span><span class="lineCov">          9 :                                 php_error_docref(NULL, E_DEPRECATED, &quot;The PDO::FETCH_SERIALIZE mode is deprecated&quot;);</span></a>
<a name="1146"><span class="lineNum">    1146 </span>            :                         }</a>
<a name="1147"><span class="lineNum">    1147 </span><span class="lineCov">        486 :                         return 1;</span></a>
<a name="1148"><span class="lineNum">    1148 </span>            :         }</a>
<a name="1149"><span class="lineNum">    1149 </span>            : }</a>
<a name="1150"><span class="lineNum">    1150 </span>            : /* }}} */</a>
<a name="1151"><span class="lineNum">    1151 </span>            : </a>
<a name="1152"><span class="lineNum">    1152 </span>            : /* {{{ Fetches the next row and returns it, or false if there are no more rows */</a>
<a name="1153"><span class="lineNum">    1153 </span><span class="lineCov">        252 : PHP_METHOD(PDOStatement, fetch)</span></a>
<a name="1154"><span class="lineNum">    1154 </span>            : {</a>
<a name="1155"><span class="lineNum">    1155 </span><span class="lineCov">        252 :         zend_long how = PDO_FETCH_USE_DEFAULT;</span></a>
<a name="1156"><span class="lineNum">    1156 </span><span class="lineCov">        252 :         zend_long ori = PDO_FETCH_ORI_NEXT;</span></a>
<a name="1157"><span class="lineNum">    1157 </span><span class="lineCov">        252 :         zend_long off = 0;</span></a>
<a name="1158"><span class="lineNum">    1158 </span>            : </a>
<a name="1159"><span class="lineNum">    1159 </span><span class="lineCov">        252 :         ZEND_PARSE_PARAMETERS_START(0, 3)</span></a>
<a name="1160"><span class="lineNum">    1160 </span><span class="lineCov">        222 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1161"><span class="lineNum">    1161 </span><span class="lineCov">        420 :                 Z_PARAM_LONG(how)</span></a>
<a name="1162"><span class="lineNum">    1162 </span><span class="lineCov">        195 :                 Z_PARAM_LONG(ori)</span></a>
<a name="1163"><span class="lineNum">    1163 </span><span class="lineCov">          9 :                 Z_PARAM_LONG(off)</span></a>
<a name="1164"><span class="lineNum">    1164 </span><span class="lineCov">        252 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1165"><span class="lineNum">    1165 </span>            : </a>
<a name="1166"><span class="lineNum">    1166 </span><span class="lineCov">        213 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1167"><span class="lineNum">    1167 </span><span class="lineCov">        192 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1168"><span class="lineNum">    1168 </span>            : </a>
<a name="1169"><span class="lineNum">    1169 </span><span class="lineCov">        192 :         if (!pdo_stmt_verify_mode(stmt, how, 1, false)) {</span></a>
<a name="1170"><span class="lineNum">    1170 </span><span class="lineNoCov">          0 :                 RETURN_THROWS();</span></a>
<a name="1171"><span class="lineNum">    1171 </span>            :         }</a>
<a name="1172"><span class="lineNum">    1172 </span>            : </a>
<a name="1173"><span class="lineNum">    1173 </span><span class="lineCov">        192 :         if (!do_fetch(stmt, return_value, how, ori, off, NULL)) {</span></a>
<a name="1174"><span class="lineNum">    1174 </span><span class="lineCov">         27 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="1175"><span class="lineNum">    1175 </span><span class="lineCov">         27 :                 RETURN_FALSE;</span></a>
<a name="1176"><span class="lineNum">    1176 </span>            :         }</a>
<a name="1177"><span class="lineNum">    1177 </span>            : }</a>
<a name="1178"><span class="lineNum">    1178 </span>            : /* }}} */</a>
<a name="1179"><span class="lineNum">    1179 </span>            : </a>
<a name="1180"><span class="lineNum">    1180 </span>            : /* {{{ Fetches the next row and returns it as an object. */</a>
<a name="1181"><span class="lineNum">    1181 </span><span class="lineCov">         57 : PHP_METHOD(PDOStatement, fetchObject)</span></a>
<a name="1182"><span class="lineNum">    1182 </span>            : {</a>
<a name="1183"><span class="lineNum">    1183 </span><span class="lineCov">         57 :         zend_class_entry *ce = NULL;</span></a>
<a name="1184"><span class="lineNum">    1184 </span>            :         zend_class_entry *old_ce;</a>
<a name="1185"><span class="lineNum">    1185 </span><span class="lineCov">         57 :         zval old_ctor_args, *ctor_args = NULL;</span></a>
<a name="1186"><span class="lineNum">    1186 </span>            :         int old_arg_count;</a>
<a name="1187"><span class="lineNum">    1187 </span>            : </a>
<a name="1188"><span class="lineNum">    1188 </span><span class="lineCov">         57 :         ZEND_PARSE_PARAMETERS_START(0, 2)</span></a>
<a name="1189"><span class="lineNum">    1189 </span><span class="lineCov">         21 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1190"><span class="lineNum">    1190 </span><span class="lineCov">         21 :                 Z_PARAM_CLASS_OR_NULL(ce)</span></a>
<a name="1191"><span class="lineNum">    1191 </span><span class="lineCov">         18 :                 Z_PARAM_ARRAY(ctor_args)</span></a>
<a name="1192"><span class="lineNum">    1192 </span><span class="lineCov">         69 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1193"><span class="lineNum">    1193 </span>            : </a>
<a name="1194"><span class="lineNum">    1194 </span><span class="lineCov">         12 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1195"><span class="lineNum">    1195 </span><span class="lineNoCov">          0 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1196"><span class="lineNum">    1196 </span>            : </a>
<a name="1197"><span class="lineNum">    1197 </span><span class="lineNoCov">          0 :         old_ce = stmt-&gt;fetch.cls.ce;</span></a>
<a name="1198"><span class="lineNum">    1198 </span><span class="lineNoCov">          0 :         ZVAL_COPY_VALUE(&amp;old_ctor_args, &amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="1199"><span class="lineNum">    1199 </span><span class="lineNoCov">          0 :         old_arg_count = stmt-&gt;fetch.cls.fci.param_count;</span></a>
<a name="1200"><span class="lineNum">    1200 </span>            : </a>
<a name="1201"><span class="lineNum">    1201 </span><span class="lineNoCov">          0 :         do_fetch_opt_finish(stmt, 0);</span></a>
<a name="1202"><span class="lineNum">    1202 </span>            : </a>
<a name="1203"><span class="lineNum">    1203 </span><span class="lineNoCov">          0 :         if (ctor_args &amp;&amp; zend_hash_num_elements(Z_ARRVAL_P(ctor_args))) {</span></a>
<a name="1204"><span class="lineNum">    1204 </span><span class="lineNoCov">          0 :                 ZVAL_ARR(&amp;stmt-&gt;fetch.cls.ctor_args, zend_array_dup(Z_ARRVAL_P(ctor_args)));</span></a>
<a name="1205"><span class="lineNum">    1205 </span>            :         } else {</a>
<a name="1206"><span class="lineNum">    1206 </span><span class="lineNoCov">          0 :                 ZVAL_UNDEF(&amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="1207"><span class="lineNum">    1207 </span>            :         }</a>
<a name="1208"><span class="lineNum">    1208 </span><span class="lineNoCov">          0 :         if (ce) {</span></a>
<a name="1209"><span class="lineNum">    1209 </span><span class="lineNoCov">          0 :                 stmt-&gt;fetch.cls.ce = ce;</span></a>
<a name="1210"><span class="lineNum">    1210 </span>            :         } else {</a>
<a name="1211"><span class="lineNum">    1211 </span><span class="lineNoCov">          0 :                 stmt-&gt;fetch.cls.ce = zend_standard_class_def;</span></a>
<a name="1212"><span class="lineNum">    1212 </span>            :         }</a>
<a name="1213"><span class="lineNum">    1213 </span>            : </a>
<a name="1214"><span class="lineNum">    1214 </span><span class="lineNoCov">          0 :         if (!do_fetch(stmt, return_value, PDO_FETCH_CLASS, PDO_FETCH_ORI_NEXT, /* offset */ 0, NULL)) {</span></a>
<a name="1215"><span class="lineNum">    1215 </span><span class="lineNoCov">          0 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="1216"><span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                 RETVAL_FALSE;</span></a>
<a name="1217"><span class="lineNum">    1217 </span>            :         }</a>
<a name="1218"><span class="lineNum">    1218 </span><span class="lineNoCov">          0 :         do_fetch_opt_finish(stmt, 1);</span></a>
<a name="1219"><span class="lineNum">    1219 </span>            : </a>
<a name="1220"><span class="lineNum">    1220 </span><span class="lineNoCov">          0 :         stmt-&gt;fetch.cls.ce = old_ce;</span></a>
<a name="1221"><span class="lineNum">    1221 </span><span class="lineNoCov">          0 :         ZVAL_COPY_VALUE(&amp;stmt-&gt;fetch.cls.ctor_args, &amp;old_ctor_args);</span></a>
<a name="1222"><span class="lineNum">    1222 </span><span class="lineNoCov">          0 :         stmt-&gt;fetch.cls.fci.param_count = old_arg_count;</span></a>
<a name="1223"><span class="lineNum">    1223 </span>            : }</a>
<a name="1224"><span class="lineNum">    1224 </span>            : /* }}} */</a>
<a name="1225"><span class="lineNum">    1225 </span>            : </a>
<a name="1226"><span class="lineNum">    1226 </span>            : /* {{{ Returns a data of the specified column in the result set. */</a>
<a name="1227"><span class="lineNum">    1227 </span><span class="lineCov">        126 : PHP_METHOD(PDOStatement, fetchColumn)</span></a>
<a name="1228"><span class="lineNum">    1228 </span>            : {</a>
<a name="1229"><span class="lineNum">    1229 </span><span class="lineCov">        126 :         zend_long col_n = 0;</span></a>
<a name="1230"><span class="lineNum">    1230 </span>            : </a>
<a name="1231"><span class="lineNum">    1231 </span><span class="lineCov">        126 :         ZEND_PARSE_PARAMETERS_START(0, 1)</span></a>
<a name="1232"><span class="lineNum">    1232 </span><span class="lineCov">         84 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1233"><span class="lineNum">    1233 </span><span class="lineCov">        102 :                 Z_PARAM_LONG(col_n)</span></a>
<a name="1234"><span class="lineNum">    1234 </span><span class="lineCov">        126 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1235"><span class="lineNum">    1235 </span>            : </a>
<a name="1236"><span class="lineNum">    1236 </span><span class="lineCov">         81 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1237"><span class="lineNum">    1237 </span><span class="lineCov">         72 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1238"><span class="lineNum">    1238 </span>            : </a>
<a name="1239"><span class="lineNum">    1239 </span><span class="lineCov">         72 :         if (!do_fetch_common(stmt, PDO_FETCH_ORI_NEXT, 0)) {</span></a>
<a name="1240"><span class="lineNum">    1240 </span><span class="lineNoCov">          0 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="1241"><span class="lineNum">    1241 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1242"><span class="lineNum">    1242 </span>            :         }</a>
<a name="1243"><span class="lineNum">    1243 </span>            : </a>
<a name="1244"><span class="lineNum">    1244 </span><span class="lineCov">         72 :         fetch_value(stmt, return_value, col_n, NULL);</span></a>
<a name="1245"><span class="lineNum">    1245 </span>            : }</a>
<a name="1246"><span class="lineNum">    1246 </span>            : /* }}} */</a>
<a name="1247"><span class="lineNum">    1247 </span>            : </a>
<a name="1248"><span class="lineNum">    1248 </span>            : /* {{{ Returns an array of all of the results. */</a>
<a name="1249"><span class="lineNum">    1249 </span><span class="lineCov">        312 : PHP_METHOD(PDOStatement, fetchAll)</span></a>
<a name="1250"><span class="lineNum">    1250 </span>            : {</a>
<a name="1251"><span class="lineNum">    1251 </span><span class="lineCov">        312 :         zend_long how = PDO_FETCH_USE_DEFAULT;</span></a>
<a name="1252"><span class="lineNum">    1252 </span><span class="lineCov">        312 :         zval data, *return_all = NULL;</span></a>
<a name="1253"><span class="lineNum">    1253 </span><span class="lineCov">        312 :         zval *arg2 = NULL;</span></a>
<a name="1254"><span class="lineNum">    1254 </span>            :         zend_class_entry *old_ce;</a>
<a name="1255"><span class="lineNum">    1255 </span><span class="lineCov">        312 :         zval old_ctor_args, *ctor_args = NULL;</span></a>
<a name="1256"><span class="lineNum">    1256 </span><span class="lineCov">        312 :         bool error = false;</span></a>
<a name="1257"><span class="lineNum">    1257 </span>            :         int flags, old_arg_count;</a>
<a name="1258"><span class="lineNum">    1258 </span>            : </a>
<a name="1259"><span class="lineNum">    1259 </span><span class="lineCov">        312 :         ZEND_PARSE_PARAMETERS_START(0, 3)</span></a>
<a name="1260"><span class="lineNum">    1260 </span><span class="lineCov">        282 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1261"><span class="lineNum">    1261 </span><span class="lineCov">        522 :                 Z_PARAM_LONG(how)</span></a>
<a name="1262"><span class="lineNum">    1262 </span><span class="lineCov">        231 :                 Z_PARAM_ZVAL_OR_NULL(arg2)</span></a>
<a name="1263"><span class="lineNum">    1263 </span><span class="lineCov">        123 :                 Z_PARAM_ARRAY_OR_NULL(ctor_args)</span></a>
<a name="1264"><span class="lineNum">    1264 </span><span class="lineCov">        312 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1265"><span class="lineNum">    1265 </span>            : </a>
<a name="1266"><span class="lineNum">    1266 </span><span class="lineCov">        273 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1267"><span class="lineNum">    1267 </span><span class="lineCov">        258 :         if (!pdo_stmt_verify_mode(stmt, how, 1, true)) {</span></a>
<a name="1268"><span class="lineNum">    1268 </span><span class="lineNoCov">          0 :                 RETURN_THROWS();</span></a>
<a name="1269"><span class="lineNum">    1269 </span>            :         }</a>
<a name="1270"><span class="lineNum">    1270 </span>            : </a>
<a name="1271"><span class="lineNum">    1271 </span><span class="lineCov">        258 :         old_ce = stmt-&gt;fetch.cls.ce;</span></a>
<a name="1272"><span class="lineNum">    1272 </span><span class="lineCov">        258 :         ZVAL_COPY_VALUE(&amp;old_ctor_args, &amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="1273"><span class="lineNum">    1273 </span><span class="lineCov">        258 :         old_arg_count = stmt-&gt;fetch.cls.fci.param_count;</span></a>
<a name="1274"><span class="lineNum">    1274 </span>            : </a>
<a name="1275"><span class="lineNum">    1275 </span><span class="lineCov">        258 :         do_fetch_opt_finish(stmt, 0);</span></a>
<a name="1276"><span class="lineNum">    1276 </span>            : </a>
<a name="1277"><span class="lineNum">    1277 </span>            :         /* TODO Would be good to reuse part of pdo_stmt_setup_fetch_mode() in some way */</a>
<a name="1278"><span class="lineNum">    1278 </span>            : </a>
<a name="1279"><span class="lineNum">    1279 </span><span class="lineCov">        258 :         switch (how &amp; ~PDO_FETCH_FLAGS) {</span></a>
<a name="1280"><span class="lineNum">    1280 </span><span class="lineCov">         33 :                 case PDO_FETCH_CLASS:</span></a>
<a name="1281"><span class="lineNum">    1281 </span>            :                         /* Figure out correct class */</a>
<a name="1282"><span class="lineNum">    1282 </span><span class="lineCov">         33 :                         if (arg2) {</span></a>
<a name="1283"><span class="lineNum">    1283 </span><span class="lineCov">         60 :                                 if (Z_TYPE_P(arg2) != IS_STRING) {</span></a>
<a name="1284"><span class="lineNum">    1284 </span><span class="lineNoCov">          0 :                                         zend_argument_type_error(2, &quot;must be of type string, %s given&quot;, zend_zval_type_name(arg2));</span></a>
<a name="1285"><span class="lineNum">    1285 </span><span class="lineNoCov">          0 :                                         RETURN_THROWS();</span></a>
<a name="1286"><span class="lineNum">    1286 </span>            :                                 }</a>
<a name="1287"><span class="lineNum">    1287 </span><span class="lineCov">         30 :                                 stmt-&gt;fetch.cls.ce = zend_fetch_class(Z_STR_P(arg2), ZEND_FETCH_CLASS_AUTO);</span></a>
<a name="1288"><span class="lineNum">    1288 </span><span class="lineCov">         30 :                                 if (!stmt-&gt;fetch.cls.ce) {</span></a>
<a name="1289"><span class="lineNum">    1289 </span><span class="lineNoCov">          0 :                                         zend_argument_type_error(2, &quot;must be a valid class&quot;);</span></a>
<a name="1290"><span class="lineNum">    1290 </span><span class="lineNoCov">          0 :                                         RETURN_THROWS();</span></a>
<a name="1291"><span class="lineNum">    1291 </span>            :                                 }</a>
<a name="1292"><span class="lineNum">    1292 </span>            :                         } else {</a>
<a name="1293"><span class="lineNum">    1293 </span><span class="lineCov">          3 :                                 stmt-&gt;fetch.cls.ce = zend_standard_class_def;</span></a>
<a name="1294"><span class="lineNum">    1294 </span>            :                         }</a>
<a name="1295"><span class="lineNum">    1295 </span>            : </a>
<a name="1296"><span class="lineNum">    1296 </span><span class="lineCov">         33 :                         if (ctor_args &amp;&amp; zend_hash_num_elements(Z_ARRVAL_P(ctor_args)) &gt; 0) {</span></a>
<a name="1297"><span class="lineNum">    1297 </span><span class="lineCov">          6 :                                 ZVAL_COPY_VALUE(&amp;stmt-&gt;fetch.cls.ctor_args, ctor_args); /* we're not going to free these */</span></a>
<a name="1298"><span class="lineNum">    1298 </span>            :                         } else {</a>
<a name="1299"><span class="lineNum">    1299 </span><span class="lineCov">         27 :                                 ZVAL_UNDEF(&amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="1300"><span class="lineNum">    1300 </span>            :                         }</a>
<a name="1301"><span class="lineNum">    1301 </span>            : </a>
<a name="1302"><span class="lineNum">    1302 </span><span class="lineCov">         33 :                         do_fetch_class_prepare(stmt);</span></a>
<a name="1303"><span class="lineNum">    1303 </span><span class="lineCov">         33 :                         break;</span></a>
<a name="1304"><span class="lineNum">    1304 </span>            : </a>
<a name="1305"><span class="lineNum">    1305 </span><span class="lineCov">         63 :                 case PDO_FETCH_FUNC: /* Cannot be a default fetch mode */</span></a>
<a name="1306"><span class="lineNum">    1306 </span><span class="lineCov">         63 :                         if (ZEND_NUM_ARGS() != 2) {</span></a>
<a name="1307"><span class="lineNum">    1307 </span><span class="lineNoCov">          0 :                                 zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1308"><span class="lineNum">    1308 </span><span class="lineNoCov">          0 :                                 zend_argument_count_error(&quot;%s() expects exactly 2 argument for PDO::FETCH_FUNC, %d given&quot;,</span></a>
<a name="1309"><span class="lineNum">    1309 </span><span class="lineNoCov">          0 :                                         ZSTR_VAL(func), ZEND_NUM_ARGS());</span></a>
<a name="1310"><span class="lineNum">    1310 </span>            :                                 zend_string_release(func);</a>
<a name="1311"><span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                                 RETURN_THROWS();</span></a>
<a name="1312"><span class="lineNum">    1312 </span>            :                         }</a>
<a name="1313"><span class="lineNum">    1313 </span><span class="lineCov">         63 :                         if (arg2 == NULL) {</span></a>
<a name="1314"><span class="lineNum">    1314 </span>            :                                 /* TODO use &quot;must be of type callable&quot; format? */</a>
<a name="1315"><span class="lineNum">    1315 </span><span class="lineCov">          3 :                                 zend_argument_type_error(2, &quot;must be a callable, null given&quot;);</span></a>
<a name="1316"><span class="lineNum">    1316 </span><span class="lineCov">          3 :                                 RETURN_THROWS();</span></a>
<a name="1317"><span class="lineNum">    1317 </span>            :                         }</a>
<a name="1318"><span class="lineNum">    1318 </span>            :                         /* TODO Check it is a callable? */</a>
<a name="1319"><span class="lineNum">    1319 </span><span class="lineCov">         60 :                         ZVAL_COPY_VALUE(&amp;stmt-&gt;fetch.func.function, arg2);</span></a>
<a name="1320"><span class="lineNum">    1320 </span><span class="lineCov">         60 :                         if (do_fetch_func_prepare(stmt) == false) {</span></a>
<a name="1321"><span class="lineNum">    1321 </span><span class="lineCov">         21 :                                 RETURN_THROWS();</span></a>
<a name="1322"><span class="lineNum">    1322 </span>            :                         }</a>
<a name="1323"><span class="lineNum">    1323 </span><span class="lineCov">         39 :                         break;</span></a>
<a name="1324"><span class="lineNum">    1324 </span>            : </a>
<a name="1325"><span class="lineNum">    1325 </span><span class="lineCov">         45 :                 case PDO_FETCH_COLUMN:</span></a>
<a name="1326"><span class="lineNum">    1326 </span><span class="lineCov">         45 :                         if (ZEND_NUM_ARGS() &gt; 2) {</span></a>
<a name="1327"><span class="lineNum">    1327 </span><span class="lineNoCov">          0 :                                 zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1328"><span class="lineNum">    1328 </span><span class="lineNoCov">          0 :                                 zend_argument_count_error(&quot;%s() expects at most 2 argument for the fetch mode provided, %d given&quot;,</span></a>
<a name="1329"><span class="lineNum">    1329 </span><span class="lineNoCov">          0 :                                         ZSTR_VAL(func), ZEND_NUM_ARGS());</span></a>
<a name="1330"><span class="lineNum">    1330 </span>            :                                 zend_string_release(func);</a>
<a name="1331"><span class="lineNum">    1331 </span><span class="lineNoCov">          0 :                                 RETURN_THROWS();</span></a>
<a name="1332"><span class="lineNum">    1332 </span>            :                         }</a>
<a name="1333"><span class="lineNum">    1333 </span>            :                         /* Is column index passed? */</a>
<a name="1334"><span class="lineNum">    1334 </span><span class="lineCov">         45 :                         if (arg2) {</span></a>
<a name="1335"><span class="lineNum">    1335 </span>            :                                 // Reuse convert_to_long(arg2); ?</a>
<a name="1336"><span class="lineNum">    1336 </span><span class="lineCov">         24 :                                 if (Z_TYPE_P(arg2) != IS_LONG) {</span></a>
<a name="1337"><span class="lineNum">    1337 </span><span class="lineNoCov">          0 :                                         zend_argument_type_error(2, &quot;must be of type int, %s given&quot;, zend_zval_type_name(arg2));</span></a>
<a name="1338"><span class="lineNum">    1338 </span><span class="lineNoCov">          0 :                                         RETURN_THROWS();</span></a>
<a name="1339"><span class="lineNum">    1339 </span>            :                                 }</a>
<a name="1340"><span class="lineNum">    1340 </span><span class="lineCov">         12 :                                 if (Z_LVAL_P(arg2) &lt; 0) {</span></a>
<a name="1341"><span class="lineNum">    1341 </span><span class="lineNoCov">          0 :                                         zend_argument_value_error(2, &quot;must be greater than or equal to 0&quot;);</span></a>
<a name="1342"><span class="lineNum">    1342 </span><span class="lineNoCov">          0 :                                         RETURN_THROWS();</span></a>
<a name="1343"><span class="lineNum">    1343 </span>            :                                 }</a>
<a name="1344"><span class="lineNum">    1344 </span><span class="lineCov">         12 :                                 stmt-&gt;fetch.column = Z_LVAL_P(arg2);</span></a>
<a name="1345"><span class="lineNum">    1345 </span>            :                         } else {</a>
<a name="1346"><span class="lineNum">    1346 </span><span class="lineCov">         33 :                                 stmt-&gt;fetch.column = how &amp; PDO_FETCH_GROUP ? -1 : 0;</span></a>
<a name="1347"><span class="lineNum">    1347 </span>            :                         }</a>
<a name="1348"><span class="lineNum">    1348 </span><span class="lineCov">         45 :                         break;</span></a>
<a name="1349"><span class="lineNum">    1349 </span>            : </a>
<a name="1350"><span class="lineNum">    1350 </span><span class="lineCov">        117 :                 default:</span></a>
<a name="1351"><span class="lineNum">    1351 </span>            :                         /* No support for PDO_FETCH_INTO which takes 2 args??? */</a>
<a name="1352"><span class="lineNum">    1352 </span><span class="lineCov">        117 :                         if (ZEND_NUM_ARGS() &gt; 1) {</span></a>
<a name="1353"><span class="lineNum">    1353 </span><span class="lineNoCov">          0 :                                 zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1354"><span class="lineNum">    1354 </span><span class="lineNoCov">          0 :                                 zend_argument_count_error(&quot;%s() expects exactly 1 argument for the fetch mode provided, %d given&quot;,</span></a>
<a name="1355"><span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                                 ZSTR_VAL(func), ZEND_NUM_ARGS());</span></a>
<a name="1356"><span class="lineNum">    1356 </span>            :                                 zend_string_release(func);</a>
<a name="1357"><span class="lineNum">    1357 </span><span class="lineNoCov">          0 :                                 RETURN_THROWS();</span></a>
<a name="1358"><span class="lineNum">    1358 </span>            :                         }</a>
<a name="1359"><span class="lineNum">    1359 </span>            :         }</a>
<a name="1360"><span class="lineNum">    1360 </span>            : </a>
<a name="1361"><span class="lineNum">    1361 </span><span class="lineCov">        234 :         flags = how &amp; PDO_FETCH_FLAGS;</span></a>
<a name="1362"><span class="lineNum">    1362 </span>            : </a>
<a name="1363"><span class="lineNum">    1363 </span><span class="lineCov">        234 :         if ((how &amp; ~PDO_FETCH_FLAGS) == PDO_FETCH_USE_DEFAULT) {</span></a>
<a name="1364"><span class="lineNum">    1364 </span><span class="lineCov">         39 :                 flags |= stmt-&gt;default_fetch_type &amp; PDO_FETCH_FLAGS;</span></a>
<a name="1365"><span class="lineNum">    1365 </span><span class="lineCov">         39 :                 how |= stmt-&gt;default_fetch_type &amp; ~PDO_FETCH_FLAGS;</span></a>
<a name="1366"><span class="lineNum">    1366 </span>            :         }</a>
<a name="1367"><span class="lineNum">    1367 </span>            : </a>
<a name="1368"><span class="lineNum">    1368 </span><span class="lineCov">        234 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1369"><span class="lineNum">    1369 </span><span class="lineCov">        234 :         if ((how &amp; PDO_FETCH_GROUP) || how == PDO_FETCH_KEY_PAIR ||</span></a>
<a name="1370"><span class="lineNum">    1370 </span><span class="lineCov">        165 :                 (how == PDO_FETCH_USE_DEFAULT &amp;&amp; stmt-&gt;default_fetch_type == PDO_FETCH_KEY_PAIR)</span></a>
<a name="1371"><span class="lineNum">    1371 </span>            :         ) {</a>
<a name="1372"><span class="lineNum">    1372 </span><span class="lineCov">         69 :                 array_init(return_value);</span></a>
<a name="1373"><span class="lineNum">    1373 </span><span class="lineCov">         69 :                 return_all = return_value;</span></a>
<a name="1374"><span class="lineNum">    1374 </span>            :         }</a>
<a name="1375"><span class="lineNum">    1375 </span><span class="lineCov">        234 :         if (!do_fetch(stmt, &amp;data, how | flags, PDO_FETCH_ORI_NEXT, /* offset */ 0, return_all)) {</span></a>
<a name="1376"><span class="lineNum">    1376 </span><span class="lineCov">          9 :                 error = true;</span></a>
<a name="1377"><span class="lineNum">    1377 </span>            :         }</a>
<a name="1378"><span class="lineNum">    1378 </span>            : </a>
<a name="1379"><span class="lineNum">    1379 </span><span class="lineCov">        234 :         if (!error) {</span></a>
<a name="1380"><span class="lineNum">    1380 </span><span class="lineCov">        225 :                 if ((how &amp; PDO_FETCH_GROUP) || how == PDO_FETCH_KEY_PAIR ||</span></a>
<a name="1381"><span class="lineNum">    1381 </span><span class="lineCov">        156 :                         (how == PDO_FETCH_USE_DEFAULT &amp;&amp; stmt-&gt;default_fetch_type == PDO_FETCH_KEY_PAIR)</span></a>
<a name="1382"><span class="lineNum">    1382 </span>            :                 ) {</a>
<a name="1383"><span class="lineNum">    1383 </span><span class="lineCov">        210 :                         while (do_fetch(stmt, &amp;data, how | flags, PDO_FETCH_ORI_NEXT, /* offset */ 0, return_all));</span></a>
<a name="1384"><span class="lineNum">    1384 </span>            :                 } else {</a>
<a name="1385"><span class="lineNum">    1385 </span><span class="lineCov">        156 :                         array_init(return_value);</span></a>
<a name="1386"><span class="lineNum">    1386 </span>            :                         do {</a>
<a name="1387"><span class="lineNum">    1387 </span><span class="lineCov">        342 :                                 zend_hash_next_index_insert_new(Z_ARRVAL_P(return_value), &amp;data);</span></a>
<a name="1388"><span class="lineNum">    1388 </span><span class="lineCov">        342 :                         } while (do_fetch(stmt, &amp;data, how | flags, PDO_FETCH_ORI_NEXT, /* offset */ 0, NULL));</span></a>
<a name="1389"><span class="lineNum">    1389 </span>            :                 }</a>
<a name="1390"><span class="lineNum">    1390 </span>            :         }</a>
<a name="1391"><span class="lineNum">    1391 </span>            : </a>
<a name="1392"><span class="lineNum">    1392 </span><span class="lineCov">        234 :         do_fetch_opt_finish(stmt, 0);</span></a>
<a name="1393"><span class="lineNum">    1393 </span>            : </a>
<a name="1394"><span class="lineNum">    1394 </span>            :         /* Restore defaults which were changed by PDO_FETCH_CLASS mode */</a>
<a name="1395"><span class="lineNum">    1395 </span><span class="lineCov">        234 :         stmt-&gt;fetch.cls.ce = old_ce;</span></a>
<a name="1396"><span class="lineNum">    1396 </span><span class="lineCov">        234 :         ZVAL_COPY_VALUE(&amp;stmt-&gt;fetch.cls.ctor_args, &amp;old_ctor_args);</span></a>
<a name="1397"><span class="lineNum">    1397 </span><span class="lineCov">        234 :         stmt-&gt;fetch.cls.fci.param_count = old_arg_count;</span></a>
<a name="1398"><span class="lineNum">    1398 </span>            : </a>
<a name="1399"><span class="lineNum">    1399 </span>            :         /* on no results, return an empty array */</a>
<a name="1400"><span class="lineNum">    1400 </span><span class="lineCov">        234 :         if (error) {</span></a>
<a name="1401"><span class="lineNum">    1401 </span><span class="lineCov">          9 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="1402"><span class="lineNum">    1402 </span><span class="lineCov">          9 :                 if (Z_TYPE_P(return_value) != IS_ARRAY) {</span></a>
<a name="1403"><span class="lineNum">    1403 </span><span class="lineCov">          9 :                         array_init(return_value);</span></a>
<a name="1404"><span class="lineNum">    1404 </span>            :                 }</a>
<a name="1405"><span class="lineNum">    1405 </span>            :         }</a>
<a name="1406"><span class="lineNum">    1406 </span>            : }</a>
<a name="1407"><span class="lineNum">    1407 </span>            : /* }}} */</a>
<a name="1408"><span class="lineNum">    1408 </span>            : </a>
<a name="1409"><span class="lineNum">    1409 </span><span class="lineCov">        123 : static void register_bound_param(INTERNAL_FUNCTION_PARAMETERS, int is_param) /* {{{ */</span></a>
<a name="1410"><span class="lineNum">    1410 </span>            : {</a>
<a name="1411"><span class="lineNum">    1411 </span>            :         struct pdo_bound_param_data param;</a>
<a name="1412"><span class="lineNum">    1412 </span><span class="lineCov">        123 :         zend_long param_type = PDO_PARAM_STR;</span></a>
<a name="1413"><span class="lineNum">    1413 </span><span class="lineCov">        123 :         zval *parameter, *driver_params = NULL;</span></a>
<a name="1414"><span class="lineNum">    1414 </span>            : </a>
<a name="1415"><span class="lineNum">    1415 </span><span class="lineCov">        123 :         memset(&amp;param, 0, sizeof(param));</span></a>
<a name="1416"><span class="lineNum">    1416 </span>            : </a>
<a name="1417"><span class="lineNum">    1417 </span><span class="lineCov">        123 :         ZEND_PARSE_PARAMETERS_START(2, 5)</span></a>
<a name="1418"><span class="lineNum">    1418 </span><span class="lineCov">        198 :                 Z_PARAM_STR_OR_LONG(param.name, param.paramno)</span></a>
<a name="1419"><span class="lineNum">    1419 </span><span class="lineCov">         99 :                 Z_PARAM_ZVAL(parameter)</span></a>
<a name="1420"><span class="lineNum">    1420 </span><span class="lineCov">         99 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1421"><span class="lineNum">    1421 </span><span class="lineCov">        105 :                 Z_PARAM_LONG(param_type)</span></a>
<a name="1422"><span class="lineNum">    1422 </span><span class="lineCov">          6 :                 Z_PARAM_LONG(param.max_value_len)</span></a>
<a name="1423"><span class="lineNum">    1423 </span><span class="lineNoCov">          0 :                 Z_PARAM_ZVAL_OR_NULL(driver_params)</span></a>
<a name="1424"><span class="lineNum">    1424 </span><span class="lineCov">        123 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1425"><span class="lineNum">    1425 </span>            : </a>
<a name="1426"><span class="lineNum">    1426 </span><span class="lineCov">         99 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1427"><span class="lineNum">    1427 </span>            : </a>
<a name="1428"><span class="lineNum">    1428 </span><span class="lineCov">         99 :         param.param_type = (int) param_type;</span></a>
<a name="1429"><span class="lineNum">    1429 </span>            : </a>
<a name="1430"><span class="lineNum">    1430 </span><span class="lineCov">         99 :         if (param.name) {</span></a>
<a name="1431"><span class="lineNum">    1431 </span><span class="lineCov">         99 :                 if (ZSTR_LEN(param.name) == 0) {</span></a>
<a name="1432"><span class="lineNum">    1432 </span><span class="lineNoCov">          0 :                         zend_argument_value_error(1, &quot;cannot be empty&quot;);</span></a>
<a name="1433"><span class="lineNum">    1433 </span><span class="lineNoCov">          0 :                         RETURN_THROWS();</span></a>
<a name="1434"><span class="lineNum">    1434 </span>            :                 }</a>
<a name="1435"><span class="lineNum">    1435 </span><span class="lineCov">         99 :                 param.paramno = -1;</span></a>
<a name="1436"><span class="lineNum">    1436 </span><span class="lineNoCov">          0 :         } else if (param.paramno &gt; 0) {</span></a>
<a name="1437"><span class="lineNum">    1437 </span><span class="lineNoCov">          0 :                 --param.paramno; /* make it zero-based internally */</span></a>
<a name="1438"><span class="lineNum">    1438 </span>            :         } else {</a>
<a name="1439"><span class="lineNum">    1439 </span><span class="lineNoCov">          0 :                 zend_argument_value_error(1, &quot;must be greater than or equal to 1&quot;);</span></a>
<a name="1440"><span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                 RETURN_THROWS();</span></a>
<a name="1441"><span class="lineNum">    1441 </span>            :         }</a>
<a name="1442"><span class="lineNum">    1442 </span>            : </a>
<a name="1443"><span class="lineNum">    1443 </span><span class="lineCov">         99 :         if (driver_params) {</span></a>
<a name="1444"><span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                 ZVAL_COPY(&amp;param.driver_params, driver_params);</span></a>
<a name="1445"><span class="lineNum">    1445 </span>            :         }</a>
<a name="1446"><span class="lineNum">    1446 </span>            : </a>
<a name="1447"><span class="lineNum">    1447 </span><span class="lineCov">         99 :         ZVAL_COPY(&amp;param.parameter, parameter);</span></a>
<a name="1448"><span class="lineNum">    1448 </span><span class="lineCov">         99 :         if (!really_register_bound_param(&amp;param, stmt, is_param)) {</span></a>
<a name="1449"><span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                 if (!Z_ISUNDEF(param.parameter)) {</span></a>
<a name="1450"><span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                         zval_ptr_dtor(&amp;(param.parameter));</span></a>
<a name="1451"><span class="lineNum">    1451 </span>            :                 }</a>
<a name="1452"><span class="lineNum">    1452 </span>            : </a>
<a name="1453"><span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1454"><span class="lineNum">    1454 </span>            :         }</a>
<a name="1455"><span class="lineNum">    1455 </span>            : </a>
<a name="1456"><span class="lineNum">    1456 </span><span class="lineCov">         99 :         RETURN_TRUE;</span></a>
<a name="1457"><span class="lineNum">    1457 </span>            : } /* }}} */</a>
<a name="1458"><span class="lineNum">    1458 </span>            : </a>
<a name="1459"><span class="lineNum">    1459 </span>            : /* {{{ bind an input parameter to the value of a PHP variable.  $paramno is the 1-based position of the placeholder in the SQL statement (but can be the parameter name for drivers that support named placeholders).  It should be called prior to execute(). */</a>
<a name="1460"><span class="lineNum">    1460 </span><span class="lineCov">         99 : PHP_METHOD(PDOStatement, bindValue)</span></a>
<a name="1461"><span class="lineNum">    1461 </span>            : {</a>
<a name="1462"><span class="lineNum">    1462 </span>            :         struct pdo_bound_param_data param;</a>
<a name="1463"><span class="lineNum">    1463 </span><span class="lineCov">         99 :         zend_long param_type = PDO_PARAM_STR;</span></a>
<a name="1464"><span class="lineNum">    1464 </span>            :         zval *parameter;</a>
<a name="1465"><span class="lineNum">    1465 </span>            : </a>
<a name="1466"><span class="lineNum">    1466 </span><span class="lineCov">         99 :         memset(&amp;param, 0, sizeof(param));</span></a>
<a name="1467"><span class="lineNum">    1467 </span>            : </a>
<a name="1468"><span class="lineNum">    1468 </span><span class="lineCov">         99 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="1469"><span class="lineNum">    1469 </span><span class="lineCov">        114 :                 Z_PARAM_STR_OR_LONG(param.name, param.paramno)</span></a>
<a name="1470"><span class="lineNum">    1470 </span><span class="lineCov">         51 :                 Z_PARAM_ZVAL(parameter)</span></a>
<a name="1471"><span class="lineNum">    1471 </span><span class="lineCov">         51 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1472"><span class="lineNum">    1472 </span><span class="lineCov">         81 :                 Z_PARAM_LONG(param_type)</span></a>
<a name="1473"><span class="lineNum">    1473 </span><span class="lineCov">         99 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1474"><span class="lineNum">    1474 </span>            : </a>
<a name="1475"><span class="lineNum">    1475 </span><span class="lineCov">         51 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1476"><span class="lineNum">    1476 </span><span class="lineCov">         45 :         param.param_type = (int) param_type;</span></a>
<a name="1477"><span class="lineNum">    1477 </span>            : </a>
<a name="1478"><span class="lineNum">    1478 </span><span class="lineCov">         45 :         if (param.name) {</span></a>
<a name="1479"><span class="lineNum">    1479 </span><span class="lineCov">         30 :                 if (ZSTR_LEN(param.name) == 0) {</span></a>
<a name="1480"><span class="lineNum">    1480 </span><span class="lineNoCov">          0 :                         zend_argument_value_error(1, &quot;cannot be empty&quot;);</span></a>
<a name="1481"><span class="lineNum">    1481 </span><span class="lineNoCov">          0 :                         RETURN_THROWS();</span></a>
<a name="1482"><span class="lineNum">    1482 </span>            :                 }</a>
<a name="1483"><span class="lineNum">    1483 </span><span class="lineCov">         30 :                 param.paramno = -1;</span></a>
<a name="1484"><span class="lineNum">    1484 </span><span class="lineCov">         15 :         } else if (param.paramno &gt; 0) {</span></a>
<a name="1485"><span class="lineNum">    1485 </span><span class="lineCov">         15 :                 --param.paramno; /* make it zero-based internally */</span></a>
<a name="1486"><span class="lineNum">    1486 </span>            :         } else {</a>
<a name="1487"><span class="lineNum">    1487 </span><span class="lineNoCov">          0 :                 zend_argument_value_error(1, &quot;must be greater than or equal to 1&quot;);</span></a>
<a name="1488"><span class="lineNum">    1488 </span><span class="lineNoCov">          0 :                 RETURN_THROWS();</span></a>
<a name="1489"><span class="lineNum">    1489 </span>            :         }</a>
<a name="1490"><span class="lineNum">    1490 </span>            : </a>
<a name="1491"><span class="lineNum">    1491 </span><span class="lineCov">         45 :         ZVAL_COPY(&amp;param.parameter, parameter);</span></a>
<a name="1492"><span class="lineNum">    1492 </span><span class="lineCov">         45 :         if (!really_register_bound_param(&amp;param, stmt, TRUE)) {</span></a>
<a name="1493"><span class="lineNum">    1493 </span><span class="lineNoCov">          0 :                 if (!Z_ISUNDEF(param.parameter)) {</span></a>
<a name="1494"><span class="lineNum">    1494 </span><span class="lineNoCov">          0 :                         zval_ptr_dtor(&amp;(param.parameter));</span></a>
<a name="1495"><span class="lineNum">    1495 </span><span class="lineNoCov">          0 :                         ZVAL_UNDEF(&amp;param.parameter);</span></a>
<a name="1496"><span class="lineNum">    1496 </span>            :                 }</a>
<a name="1497"><span class="lineNum">    1497 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1498"><span class="lineNum">    1498 </span>            :         }</a>
<a name="1499"><span class="lineNum">    1499 </span><span class="lineCov">         45 :         RETURN_TRUE;</span></a>
<a name="1500"><span class="lineNum">    1500 </span>            : }</a>
<a name="1501"><span class="lineNum">    1501 </span>            : /* }}} */</a>
<a name="1502"><span class="lineNum">    1502 </span>            : </a>
<a name="1503"><span class="lineNum">    1503 </span>            : /* {{{ bind a parameter to a PHP variable.  $paramno is the 1-based position of the placeholder in the SQL statement (but can be the parameter name for drivers that support named placeholders).  This isn't supported by all drivers.  It should be called prior to execute(). */</a>
<a name="1504"><span class="lineNum">    1504 </span><span class="lineCov">         51 : PHP_METHOD(PDOStatement, bindParam)</span></a>
<a name="1505"><span class="lineNum">    1505 </span>            : {</a>
<a name="1506"><span class="lineNum">    1506 </span><span class="lineCov">         51 :         register_bound_param(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1);</span></a>
<a name="1507"><span class="lineNum">    1507 </span><span class="lineCov">         51 : }</span></a>
<a name="1508"><span class="lineNum">    1508 </span>            : /* }}} */</a>
<a name="1509"><span class="lineNum">    1509 </span>            : </a>
<a name="1510"><span class="lineNum">    1510 </span>            : /* {{{ bind a column to a PHP variable.  On each row fetch $param will contain the value of the corresponding column.  $column is the 1-based offset of the column, or the column name.  For portability, don't call this before execute(). */</a>
<a name="1511"><span class="lineNum">    1511 </span><span class="lineCov">         72 : PHP_METHOD(PDOStatement, bindColumn)</span></a>
<a name="1512"><span class="lineNum">    1512 </span>            : {</a>
<a name="1513"><span class="lineNum">    1513 </span><span class="lineCov">         72 :         register_bound_param(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0);</span></a>
<a name="1514"><span class="lineNum">    1514 </span><span class="lineCov">         72 : }</span></a>
<a name="1515"><span class="lineNum">    1515 </span>            : /* }}} */</a>
<a name="1516"><span class="lineNum">    1516 </span>            : </a>
<a name="1517"><span class="lineNum">    1517 </span>            : /* {{{ Returns the number of rows in a result set, or the number of rows affected by the last execute().  It is not always meaningful. */</a>
<a name="1518"><span class="lineNum">    1518 </span><span class="lineCov">         63 : PHP_METHOD(PDOStatement, rowCount)</span></a>
<a name="1519"><span class="lineNum">    1519 </span>            : {</a>
<a name="1520"><span class="lineNum">    1520 </span><span class="lineCov">         63 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1521"><span class="lineNum">    1521 </span>            : </a>
<a name="1522"><span class="lineNum">    1522 </span><span class="lineCov">         15 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1523"><span class="lineNum">    1523 </span><span class="lineCov">          9 :         RETURN_LONG(stmt-&gt;row_count);</span></a>
<a name="1524"><span class="lineNum">    1524 </span>            : }</a>
<a name="1525"><span class="lineNum">    1525 </span>            : /* }}} */</a>
<a name="1526"><span class="lineNum">    1526 </span>            : </a>
<a name="1527"><span class="lineNum">    1527 </span>            : /* {{{ Fetch the error code associated with the last operation on the statement handle */</a>
<a name="1528"><span class="lineNum">    1528 </span><span class="lineCov">         60 : PHP_METHOD(PDOStatement, errorCode)</span></a>
<a name="1529"><span class="lineNum">    1529 </span>            : {</a>
<a name="1530"><span class="lineNum">    1530 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1531"><span class="lineNum">    1531 </span>            : </a>
<a name="1532"><span class="lineNum">    1532 </span><span class="lineCov">         12 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1533"><span class="lineNum">    1533 </span><span class="lineCov">          6 :         if (stmt-&gt;error_code[0] == '\0') {</span></a>
<a name="1534"><span class="lineNum">    1534 </span><span class="lineCov">          3 :                 RETURN_NULL();</span></a>
<a name="1535"><span class="lineNum">    1535 </span>            :         }</a>
<a name="1536"><span class="lineNum">    1536 </span>            : </a>
<a name="1537"><span class="lineNum">    1537 </span><span class="lineCov">          6 :         RETURN_STRING(stmt-&gt;error_code);</span></a>
<a name="1538"><span class="lineNum">    1538 </span>            : }</a>
<a name="1539"><span class="lineNum">    1539 </span>            : /* }}} */</a>
<a name="1540"><span class="lineNum">    1540 </span>            : </a>
<a name="1541"><span class="lineNum">    1541 </span>            : /* {{{ Fetch extended error information associated with the last operation on the statement handle */</a>
<a name="1542"><span class="lineNum">    1542 </span><span class="lineCov">         54 : PHP_METHOD(PDOStatement, errorInfo)</span></a>
<a name="1543"><span class="lineNum">    1543 </span>            : {</a>
<a name="1544"><span class="lineNum">    1544 </span>            :         int error_count;</a>
<a name="1545"><span class="lineNum">    1545 </span><span class="lineCov">         54 :         int error_count_diff = 0;</span></a>
<a name="1546"><span class="lineNum">    1546 </span><span class="lineCov">         54 :         int error_expected_count = 3;</span></a>
<a name="1547"><span class="lineNum">    1547 </span>            : </a>
<a name="1548"><span class="lineNum">    1548 </span><span class="lineCov">         54 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1549"><span class="lineNum">    1549 </span>            : </a>
<a name="1550"><span class="lineNum">    1550 </span><span class="lineCov">          6 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1551"><span class="lineNum">    1551 </span><span class="lineNoCov">          0 :         array_init(return_value);</span></a>
<a name="1552"><span class="lineNum">    1552 </span><span class="lineNoCov">          0 :         add_next_index_string(return_value, stmt-&gt;error_code);</span></a>
<a name="1553"><span class="lineNum">    1553 </span>            : </a>
<a name="1554"><span class="lineNum">    1554 </span><span class="lineNoCov">          0 :         if (stmt-&gt;dbh-&gt;methods-&gt;fetch_err) {</span></a>
<a name="1555"><span class="lineNum">    1555 </span><span class="lineNoCov">          0 :                 stmt-&gt;dbh-&gt;methods-&gt;fetch_err(stmt-&gt;dbh, stmt, return_value);</span></a>
<a name="1556"><span class="lineNum">    1556 </span>            :         }</a>
<a name="1557"><span class="lineNum">    1557 </span>            : </a>
<a name="1558"><span class="lineNum">    1558 </span><span class="lineNoCov">          0 :         error_count = zend_hash_num_elements(Z_ARRVAL_P(return_value));</span></a>
<a name="1559"><span class="lineNum">    1559 </span>            : </a>
<a name="1560"><span class="lineNum">    1560 </span><span class="lineNoCov">          0 :         if (error_expected_count &gt; error_count) {</span></a>
<a name="1561"><span class="lineNum">    1561 </span>            :                 int current_index;</a>
<a name="1562"><span class="lineNum">    1562 </span>            : </a>
<a name="1563"><span class="lineNum">    1563 </span><span class="lineNoCov">          0 :                 error_count_diff = error_expected_count - error_count;</span></a>
<a name="1564"><span class="lineNum">    1564 </span><span class="lineNoCov">          0 :                 for (current_index = 0; current_index &lt; error_count_diff; current_index++) {</span></a>
<a name="1565"><span class="lineNum">    1565 </span><span class="lineNoCov">          0 :                         add_next_index_null(return_value);</span></a>
<a name="1566"><span class="lineNum">    1566 </span>            :                 }</a>
<a name="1567"><span class="lineNum">    1567 </span>            :         }</a>
<a name="1568"><span class="lineNum">    1568 </span>            : }</a>
<a name="1569"><span class="lineNum">    1569 </span>            : /* }}} */</a>
<a name="1570"><span class="lineNum">    1570 </span>            : </a>
<a name="1571"><span class="lineNum">    1571 </span>            : /* {{{ Set an attribute */</a>
<a name="1572"><span class="lineNum">    1572 </span><span class="lineCov">         54 : PHP_METHOD(PDOStatement, setAttribute)</span></a>
<a name="1573"><span class="lineNum">    1573 </span>            : {</a>
<a name="1574"><span class="lineNum">    1574 </span>            :         zend_long attr;</a>
<a name="1575"><span class="lineNum">    1575 </span><span class="lineCov">         54 :         zval *value = NULL;</span></a>
<a name="1576"><span class="lineNum">    1576 </span>            : </a>
<a name="1577"><span class="lineNum">    1577 </span><span class="lineCov">         54 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="1578"><span class="lineNum">    1578 </span><span class="lineCov">         12 :                 Z_PARAM_LONG(attr)</span></a>
<a name="1579"><span class="lineNum">    1579 </span><span class="lineCov">          3 :                 Z_PARAM_ZVAL_OR_NULL(value)</span></a>
<a name="1580"><span class="lineNum">    1580 </span><span class="lineCov">         54 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1581"><span class="lineNum">    1581 </span>            : </a>
<a name="1582"><span class="lineNum">    1582 </span><span class="lineCov">          3 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1583"><span class="lineNum">    1583 </span>            : </a>
<a name="1584"><span class="lineNum">    1584 </span>            :         /* Driver hasn't registered a function for setting attributes */</a>
<a name="1585"><span class="lineNum">    1585 </span><span class="lineNoCov">          0 :         if (!stmt-&gt;methods-&gt;set_attribute) {</span></a>
<a name="1586"><span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;IM001&quot;, &quot;This driver doesn't support setting attributes&quot;);</span></a>
<a name="1587"><span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1588"><span class="lineNum">    1588 </span>            :         }</a>
<a name="1589"><span class="lineNum">    1589 </span>            : </a>
<a name="1590"><span class="lineNum">    1590 </span><span class="lineNoCov">          0 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1591"><span class="lineNum">    1591 </span><span class="lineNoCov">          0 :         if (stmt-&gt;methods-&gt;set_attribute(stmt, attr, value)) {</span></a>
<a name="1592"><span class="lineNum">    1592 </span><span class="lineNoCov">          0 :                 RETURN_TRUE;</span></a>
<a name="1593"><span class="lineNum">    1593 </span>            :         }</a>
<a name="1594"><span class="lineNum">    1594 </span>            : </a>
<a name="1595"><span class="lineNum">    1595 </span>            :         /* Error while setting attribute */</a>
<a name="1596"><span class="lineNum">    1596 </span><span class="lineNoCov">          0 :         PDO_HANDLE_STMT_ERR();</span></a>
<a name="1597"><span class="lineNum">    1597 </span><span class="lineNoCov">          0 :         RETURN_FALSE;</span></a>
<a name="1598"><span class="lineNum">    1598 </span>            : }</a>
<a name="1599"><span class="lineNum">    1599 </span>            : /* }}} */</a>
<a name="1600"><span class="lineNum">    1600 </span>            : </a>
<a name="1601"><span class="lineNum">    1601 </span>            : /* {{{ Get an attribute */</a>
<a name="1602"><span class="lineNum">    1602 </span>            : </a>
<a name="1603"><span class="lineNum">    1603 </span><span class="lineNoCov">          0 : static bool generic_stmt_attr_get(pdo_stmt_t *stmt, zval *return_value, zend_long attr)</span></a>
<a name="1604"><span class="lineNum">    1604 </span>            : {</a>
<a name="1605"><span class="lineNum">    1605 </span><span class="lineNoCov">          0 :         switch (attr) {</span></a>
<a name="1606"><span class="lineNum">    1606 </span><span class="lineNoCov">          0 :                 case PDO_ATTR_EMULATE_PREPARES:</span></a>
<a name="1607"><span class="lineNum">    1607 </span><span class="lineNoCov">          0 :                         RETVAL_BOOL(stmt-&gt;supports_placeholders == PDO_PLACEHOLDER_NONE);</span></a>
<a name="1608"><span class="lineNum">    1608 </span><span class="lineNoCov">          0 :                         return 1;</span></a>
<a name="1609"><span class="lineNum">    1609 </span>            :         }</a>
<a name="1610"><span class="lineNum">    1610 </span><span class="lineNoCov">          0 :         return 0;</span></a>
<a name="1611"><span class="lineNum">    1611 </span>            : }</a>
<a name="1612"><span class="lineNum">    1612 </span>            : </a>
<a name="1613"><span class="lineNum">    1613 </span><span class="lineCov">         60 : PHP_METHOD(PDOStatement, getAttribute)</span></a>
<a name="1614"><span class="lineNum">    1614 </span>            : {</a>
<a name="1615"><span class="lineNum">    1615 </span>            :         zend_long attr;</a>
<a name="1616"><span class="lineNum">    1616 </span>            : </a>
<a name="1617"><span class="lineNum">    1617 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="1618"><span class="lineNum">    1618 </span><span class="lineCov">         24 :                 Z_PARAM_LONG(attr)</span></a>
<a name="1619"><span class="lineNum">    1619 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1620"><span class="lineNum">    1620 </span>            : </a>
<a name="1621"><span class="lineNum">    1621 </span><span class="lineCov">          9 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1622"><span class="lineNum">    1622 </span><span class="lineCov">          6 :         if (!stmt-&gt;methods-&gt;get_attribute) {</span></a>
<a name="1623"><span class="lineNum">    1623 </span><span class="lineNoCov">          0 :                 if (!generic_stmt_attr_get(stmt, return_value, attr)) {</span></a>
<a name="1624"><span class="lineNum">    1624 </span><span class="lineNoCov">          0 :                         pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;IM001&quot;,</span></a>
<a name="1625"><span class="lineNum">    1625 </span>            :                                 &quot;This driver doesn't support getting attributes&quot;);</a>
<a name="1626"><span class="lineNum">    1626 </span><span class="lineNoCov">          0 :                         RETURN_FALSE;</span></a>
<a name="1627"><span class="lineNum">    1627 </span>            :                 }</a>
<a name="1628"><span class="lineNum">    1628 </span><span class="lineNoCov">          0 :                 return;</span></a>
<a name="1629"><span class="lineNum">    1629 </span>            :         }</a>
<a name="1630"><span class="lineNum">    1630 </span>            : </a>
<a name="1631"><span class="lineNum">    1631 </span><span class="lineCov">          6 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1632"><span class="lineNum">    1632 </span><span class="lineCov">          6 :         switch (stmt-&gt;methods-&gt;get_attribute(stmt, attr, return_value)) {</span></a>
<a name="1633"><span class="lineNum">    1633 </span><span class="lineNoCov">          0 :                 case -1:</span></a>
<a name="1634"><span class="lineNum">    1634 </span><span class="lineNoCov">          0 :                         PDO_HANDLE_STMT_ERR();</span></a>
<a name="1635"><span class="lineNum">    1635 </span><span class="lineNoCov">          0 :                         RETURN_FALSE;</span></a>
<a name="1636"><span class="lineNum">    1636 </span>            : </a>
<a name="1637"><span class="lineNum">    1637 </span><span class="lineNoCov">          0 :                 case 0:</span></a>
<a name="1638"><span class="lineNum">    1638 </span><span class="lineNoCov">          0 :                         if (!generic_stmt_attr_get(stmt, return_value, attr)) {</span></a>
<a name="1639"><span class="lineNum">    1639 </span>            :                                 /* XXX: should do something better here */</a>
<a name="1640"><span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;IM001&quot;,</span></a>
<a name="1641"><span class="lineNum">    1641 </span>            :                                         &quot;driver doesn't support getting that attribute&quot;);</a>
<a name="1642"><span class="lineNum">    1642 </span><span class="lineNoCov">          0 :                                 RETURN_FALSE;</span></a>
<a name="1643"><span class="lineNum">    1643 </span>            :                         }</a>
<a name="1644"><span class="lineNum">    1644 </span><span class="lineNoCov">          0 :                         return;</span></a>
<a name="1645"><span class="lineNum">    1645 </span>            : </a>
<a name="1646"><span class="lineNum">    1646 </span><span class="lineCov">          6 :                 default:</span></a>
<a name="1647"><span class="lineNum">    1647 </span><span class="lineCov">          6 :                         return;</span></a>
<a name="1648"><span class="lineNum">    1648 </span>            :         }</a>
<a name="1649"><span class="lineNum">    1649 </span>            : }</a>
<a name="1650"><span class="lineNum">    1650 </span>            : /* }}} */</a>
<a name="1651"><span class="lineNum">    1651 </span>            : </a>
<a name="1652"><span class="lineNum">    1652 </span>            : /* {{{ Returns the number of columns in the result set */</a>
<a name="1653"><span class="lineNum">    1653 </span><span class="lineCov">         66 : PHP_METHOD(PDOStatement, columnCount)</span></a>
<a name="1654"><span class="lineNum">    1654 </span>            : {</a>
<a name="1655"><span class="lineNum">    1655 </span><span class="lineCov">         66 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1656"><span class="lineNum">    1656 </span>            : </a>
<a name="1657"><span class="lineNum">    1657 </span><span class="lineCov">         18 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1658"><span class="lineNum">    1658 </span><span class="lineCov">         12 :         RETURN_LONG(stmt-&gt;column_count);</span></a>
<a name="1659"><span class="lineNum">    1659 </span>            : }</a>
<a name="1660"><span class="lineNum">    1660 </span>            : /* }}} */</a>
<a name="1661"><span class="lineNum">    1661 </span>            : </a>
<a name="1662"><span class="lineNum">    1662 </span>            : /* {{{ Returns meta data for a numbered column */</a>
<a name="1663"><span class="lineNum">    1663 </span><span class="lineCov">         75 : PHP_METHOD(PDOStatement, getColumnMeta)</span></a>
<a name="1664"><span class="lineNum">    1664 </span>            : {</a>
<a name="1665"><span class="lineNum">    1665 </span>            :         zend_long colno;</a>
<a name="1666"><span class="lineNum">    1666 </span>            :         struct pdo_column_data *col;</a>
<a name="1667"><span class="lineNum">    1667 </span>            : </a>
<a name="1668"><span class="lineNum">    1668 </span><span class="lineCov">         75 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="1669"><span class="lineNum">    1669 </span><span class="lineCov">         54 :                 Z_PARAM_LONG(colno)</span></a>
<a name="1670"><span class="lineNum">    1670 </span><span class="lineCov">         75 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1671"><span class="lineNum">    1671 </span>            : </a>
<a name="1672"><span class="lineNum">    1672 </span><span class="lineCov">         24 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1673"><span class="lineNum">    1673 </span><span class="lineCov">         21 :         if (colno &lt; 0) {</span></a>
<a name="1674"><span class="lineNum">    1674 </span><span class="lineNoCov">          0 :                 zend_argument_value_error(1, &quot;must be greater than or equal to 0&quot;);</span></a>
<a name="1675"><span class="lineNum">    1675 </span><span class="lineNoCov">          0 :                 RETURN_THROWS();</span></a>
<a name="1676"><span class="lineNum">    1676 </span>            :         }</a>
<a name="1677"><span class="lineNum">    1677 </span>            : </a>
<a name="1678"><span class="lineNum">    1678 </span><span class="lineCov">         21 :         if (!stmt-&gt;methods-&gt;get_column_meta) {</span></a>
<a name="1679"><span class="lineNum">    1679 </span><span class="lineNoCov">          0 :                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;IM001&quot;, &quot;driver doesn't support meta data&quot;);</span></a>
<a name="1680"><span class="lineNum">    1680 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1681"><span class="lineNum">    1681 </span>            :         }</a>
<a name="1682"><span class="lineNum">    1682 </span>            : </a>
<a name="1683"><span class="lineNum">    1683 </span><span class="lineCov">         21 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1684"><span class="lineNum">    1684 </span><span class="lineCov">         21 :         if (FAILURE == stmt-&gt;methods-&gt;get_column_meta(stmt, colno, return_value)) {</span></a>
<a name="1685"><span class="lineNum">    1685 </span><span class="lineNoCov">          0 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="1686"><span class="lineNum">    1686 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1687"><span class="lineNum">    1687 </span>            :         }</a>
<a name="1688"><span class="lineNum">    1688 </span>            : </a>
<a name="1689"><span class="lineNum">    1689 </span>            :         /* add stock items */</a>
<a name="1690"><span class="lineNum">    1690 </span><span class="lineCov">         21 :         col = &amp;stmt-&gt;columns[colno];</span></a>
<a name="1691"><span class="lineNum">    1691 </span><span class="lineCov">         42 :         add_assoc_str(return_value, &quot;name&quot;, zend_string_copy(col-&gt;name));</span></a>
<a name="1692"><span class="lineNum">    1692 </span><span class="lineCov">         21 :         add_assoc_long(return_value, &quot;len&quot;, col-&gt;maxlen); /* FIXME: unsigned ? */</span></a>
<a name="1693"><span class="lineNum">    1693 </span><span class="lineCov">         21 :         add_assoc_long(return_value, &quot;precision&quot;, col-&gt;precision);</span></a>
<a name="1694"><span class="lineNum">    1694 </span>            : }</a>
<a name="1695"><span class="lineNum">    1695 </span>            : /* }}} */</a>
<a name="1696"><span class="lineNum">    1696 </span>            : </a>
<a name="1697"><span class="lineNum">    1697 </span>            : /* {{{ Changes the default fetch mode for subsequent fetches (params have different meaning for different fetch modes) */</a>
<a name="1698"><span class="lineNum">    1698 </span>            : </a>
<a name="1699"><span class="lineNum">    1699 </span><span class="lineCov">        102 : bool pdo_stmt_setup_fetch_mode(pdo_stmt_t *stmt, zend_long mode, uint32_t mode_arg_num,</span></a>
<a name="1700"><span class="lineNum">    1700 </span>            :         zval *args, uint32_t variadic_num_args)</a>
<a name="1701"><span class="lineNum">    1701 </span>            : {</a>
<a name="1702"><span class="lineNum">    1702 </span><span class="lineCov">        102 :         int flags = 0;</span></a>
<a name="1703"><span class="lineNum">    1703 </span><span class="lineCov">        102 :         uint32_t arg1_arg_num = mode_arg_num + 1;</span></a>
<a name="1704"><span class="lineNum">    1704 </span><span class="lineCov">        102 :         uint32_t constructor_arg_num = mode_arg_num + 2;</span></a>
<a name="1705"><span class="lineNum">    1705 </span><span class="lineCov">        102 :         uint32_t total_num_args = mode_arg_num + variadic_num_args;</span></a>
<a name="1706"><span class="lineNum">    1706 </span>            : </a>
<a name="1707"><span class="lineNum">    1707 </span><span class="lineCov">        102 :         switch (stmt-&gt;default_fetch_type) {</span></a>
<a name="1708"><span class="lineNum">    1708 </span><span class="lineCov">         30 :                 case PDO_FETCH_INTO:</span></a>
<a name="1709"><span class="lineNum">    1709 </span><span class="lineCov">         60 :                         if (!Z_ISUNDEF(stmt-&gt;fetch.into)) {</span></a>
<a name="1710"><span class="lineNum">    1710 </span><span class="lineNoCov">          0 :                                 zval_ptr_dtor(&amp;stmt-&gt;fetch.into);</span></a>
<a name="1711"><span class="lineNum">    1711 </span><span class="lineNoCov">          0 :                                 ZVAL_UNDEF(&amp;stmt-&gt;fetch.into);</span></a>
<a name="1712"><span class="lineNum">    1712 </span>            :                         }</a>
<a name="1713"><span class="lineNum">    1713 </span><span class="lineCov">         30 :                         break;</span></a>
<a name="1714"><span class="lineNum">    1714 </span><span class="lineCov">        102 :                 default:</span></a>
<a name="1715"><span class="lineNum">    1715 </span>            :                         ;</a>
<a name="1716"><span class="lineNum">    1716 </span>            :         }</a>
<a name="1717"><span class="lineNum">    1717 </span>            : </a>
<a name="1718"><span class="lineNum">    1718 </span><span class="lineCov">        102 :         stmt-&gt;default_fetch_type = PDO_FETCH_BOTH;</span></a>
<a name="1719"><span class="lineNum">    1719 </span>            : </a>
<a name="1720"><span class="lineNum">    1720 </span><span class="lineCov">        102 :         flags = mode &amp; PDO_FETCH_FLAGS;</span></a>
<a name="1721"><span class="lineNum">    1721 </span>            : </a>
<a name="1722"><span class="lineNum">    1722 </span><span class="lineCov">        102 :         if (!pdo_stmt_verify_mode(stmt, mode, mode_arg_num, false)) {</span></a>
<a name="1723"><span class="lineNum">    1723 </span><span class="lineNoCov">          0 :                 return false;</span></a>
<a name="1724"><span class="lineNum">    1724 </span>            :         }</a>
<a name="1725"><span class="lineNum">    1725 </span>            : </a>
<a name="1726"><span class="lineNum">    1726 </span><span class="lineCov">        102 :         switch (mode &amp; ~PDO_FETCH_FLAGS) {</span></a>
<a name="1727"><span class="lineNum">    1727 </span><span class="lineCov">         30 :                 case PDO_FETCH_USE_DEFAULT:</span></a>
<a name="1728"><span class="lineNum">    1728 </span>            :                 case PDO_FETCH_LAZY:</a>
<a name="1729"><span class="lineNum">    1729 </span>            :                 case PDO_FETCH_ASSOC:</a>
<a name="1730"><span class="lineNum">    1730 </span>            :                 case PDO_FETCH_NUM:</a>
<a name="1731"><span class="lineNum">    1731 </span>            :                 case PDO_FETCH_BOTH:</a>
<a name="1732"><span class="lineNum">    1732 </span>            :                 case PDO_FETCH_OBJ:</a>
<a name="1733"><span class="lineNum">    1733 </span>            :                 case PDO_FETCH_BOUND:</a>
<a name="1734"><span class="lineNum">    1734 </span>            :                 case PDO_FETCH_NAMED:</a>
<a name="1735"><span class="lineNum">    1735 </span>            :                 case PDO_FETCH_KEY_PAIR:</a>
<a name="1736"><span class="lineNum">    1736 </span><span class="lineCov">         30 :                         if (variadic_num_args != 0) {</span></a>
<a name="1737"><span class="lineNum">    1737 </span><span class="lineCov">          3 :                                 zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1738"><span class="lineNum">    1738 </span><span class="lineCov">          3 :                                 zend_argument_count_error(&quot;%s() expects exactly %d arguments for the fetch mode provided, %d given&quot;,</span></a>
<a name="1739"><span class="lineNum">    1739 </span><span class="lineCov">          3 :                                         ZSTR_VAL(func), mode_arg_num, total_num_args);</span></a>
<a name="1740"><span class="lineNum">    1740 </span>            :                                 zend_string_release(func);</a>
<a name="1741"><span class="lineNum">    1741 </span><span class="lineCov">          3 :                                 return false;</span></a>
<a name="1742"><span class="lineNum">    1742 </span>            :                         }</a>
<a name="1743"><span class="lineNum">    1743 </span><span class="lineCov">         27 :                         break;</span></a>
<a name="1744"><span class="lineNum">    1744 </span>            : </a>
<a name="1745"><span class="lineNum">    1745 </span><span class="lineCov">          3 :                 case PDO_FETCH_COLUMN:</span></a>
<a name="1746"><span class="lineNum">    1746 </span><span class="lineCov">          3 :                         if (variadic_num_args != 1) {</span></a>
<a name="1747"><span class="lineNum">    1747 </span><span class="lineCov">          3 :                                 zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1748"><span class="lineNum">    1748 </span><span class="lineCov">          3 :                                 zend_argument_count_error(&quot;%s() expects exactly %d arguments for the fetch mode provided, %d given&quot;,</span></a>
<a name="1749"><span class="lineNum">    1749 </span><span class="lineCov">          3 :                                         ZSTR_VAL(func), arg1_arg_num, total_num_args);</span></a>
<a name="1750"><span class="lineNum">    1750 </span>            :                                 zend_string_release(func);</a>
<a name="1751"><span class="lineNum">    1751 </span><span class="lineCov">          3 :                                 return false;</span></a>
<a name="1752"><span class="lineNum">    1752 </span>            :                         }</a>
<a name="1753"><span class="lineNum">    1753 </span><span class="lineNoCov">          0 :                         if (Z_TYPE(args[0]) != IS_LONG) {</span></a>
<a name="1754"><span class="lineNum">    1754 </span><span class="lineNoCov">          0 :                                 zend_argument_type_error(arg1_arg_num, &quot;must be of type int, %s given&quot;, zend_zval_type_name(&amp;args[0]));</span></a>
<a name="1755"><span class="lineNum">    1755 </span><span class="lineNoCov">          0 :                                 return false;</span></a>
<a name="1756"><span class="lineNum">    1756 </span>            :                         }</a>
<a name="1757"><span class="lineNum">    1757 </span><span class="lineNoCov">          0 :                         if (Z_LVAL(args[0]) &lt; 0) {</span></a>
<a name="1758"><span class="lineNum">    1758 </span><span class="lineNoCov">          0 :                                 zend_argument_value_error(arg1_arg_num, &quot;must be greater than or equal to 0&quot;);</span></a>
<a name="1759"><span class="lineNum">    1759 </span><span class="lineNoCov">          0 :                                 return false;</span></a>
<a name="1760"><span class="lineNum">    1760 </span>            :                         }</a>
<a name="1761"><span class="lineNum">    1761 </span><span class="lineNoCov">          0 :                         stmt-&gt;fetch.column = Z_LVAL(args[0]);</span></a>
<a name="1762"><span class="lineNum">    1762 </span><span class="lineNoCov">          0 :                         break;</span></a>
<a name="1763"><span class="lineNum">    1763 </span>            : </a>
<a name="1764"><span class="lineNum">    1764 </span><span class="lineCov">         30 :                 case PDO_FETCH_CLASS: {</span></a>
<a name="1765"><span class="lineNum">    1765 </span><span class="lineCov">         30 :                         HashTable *constructor_args = NULL;</span></a>
<a name="1766"><span class="lineNum">    1766 </span>            :                         /* Undef constructor arguments */</a>
<a name="1767"><span class="lineNum">    1767 </span><span class="lineCov">         30 :                         ZVAL_UNDEF(&amp;stmt-&gt;fetch.cls.ctor_args);</span></a>
<a name="1768"><span class="lineNum">    1768 </span>            :                         /* Gets its class name from 1st column */</a>
<a name="1769"><span class="lineNum">    1769 </span><span class="lineCov">         30 :                         if ((flags &amp; PDO_FETCH_CLASSTYPE) == PDO_FETCH_CLASSTYPE) {</span></a>
<a name="1770"><span class="lineNum">    1770 </span><span class="lineNoCov">          0 :                                 if (variadic_num_args != 0) {</span></a>
<a name="1771"><span class="lineNum">    1771 </span><span class="lineNoCov">          0 :                                         zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1772"><span class="lineNum">    1772 </span><span class="lineNoCov">          0 :                                         zend_argument_count_error(&quot;%s() expects exactly %d arguments for the fetch mode provided, %d given&quot;,</span></a>
<a name="1773"><span class="lineNum">    1773 </span><span class="lineNoCov">          0 :                                                 ZSTR_VAL(func), mode_arg_num, total_num_args);</span></a>
<a name="1774"><span class="lineNum">    1774 </span>            :                                         zend_string_release(func);</a>
<a name="1775"><span class="lineNum">    1775 </span><span class="lineNoCov">          0 :                                         return false;</span></a>
<a name="1776"><span class="lineNum">    1776 </span>            :                                 }</a>
<a name="1777"><span class="lineNum">    1777 </span><span class="lineNoCov">          0 :                                 stmt-&gt;fetch.cls.ce = NULL;</span></a>
<a name="1778"><span class="lineNum">    1778 </span>            :                         } else {</a>
<a name="1779"><span class="lineNum">    1779 </span>            :                                 zend_class_entry *cep;</a>
<a name="1780"><span class="lineNum">    1780 </span><span class="lineCov">         30 :                                 if (variadic_num_args == 0) {</span></a>
<a name="1781"><span class="lineNum">    1781 </span><span class="lineCov">          3 :                                         zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1782"><span class="lineNum">    1782 </span><span class="lineCov">          3 :                                         zend_argument_count_error(&quot;%s() expects at least %d arguments for the fetch mode provided, %d given&quot;,</span></a>
<a name="1783"><span class="lineNum">    1783 </span><span class="lineCov">          3 :                                                 ZSTR_VAL(func), arg1_arg_num, total_num_args);</span></a>
<a name="1784"><span class="lineNum">    1784 </span>            :                                         zend_string_release(func);</a>
<a name="1785"><span class="lineNum">    1785 </span><span class="lineCov">          3 :                                         return false;</span></a>
<a name="1786"><span class="lineNum">    1786 </span>            :                                 }</a>
<a name="1787"><span class="lineNum">    1787 </span>            :                                 /* constructor_arguments can be null/not passed */</a>
<a name="1788"><span class="lineNum">    1788 </span><span class="lineCov">         27 :                                 if (variadic_num_args &gt; 2) {</span></a>
<a name="1789"><span class="lineNum">    1789 </span><span class="lineCov">          3 :                                         zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1790"><span class="lineNum">    1790 </span><span class="lineCov">          3 :                                         zend_argument_count_error(&quot;%s() expects at most %d arguments for the fetch mode provided, %d given&quot;,</span></a>
<a name="1791"><span class="lineNum">    1791 </span><span class="lineCov">          3 :                                                 ZSTR_VAL(func), constructor_arg_num, total_num_args);</span></a>
<a name="1792"><span class="lineNum">    1792 </span>            :                                         zend_string_release(func);</a>
<a name="1793"><span class="lineNum">    1793 </span><span class="lineCov">          3 :                                         return false;</span></a>
<a name="1794"><span class="lineNum">    1794 </span>            :                                 }</a>
<a name="1795"><span class="lineNum">    1795 </span><span class="lineCov">         24 :                                 if (Z_TYPE(args[0]) != IS_STRING) {</span></a>
<a name="1796"><span class="lineNum">    1796 </span><span class="lineNoCov">          0 :                                         zend_argument_type_error(arg1_arg_num, &quot;must be of type string, %s given&quot;, zend_zval_type_name(&amp;args[0]));</span></a>
<a name="1797"><span class="lineNum">    1797 </span><span class="lineNoCov">          0 :                                         return false;</span></a>
<a name="1798"><span class="lineNum">    1798 </span>            :                                 }</a>
<a name="1799"><span class="lineNum">    1799 </span><span class="lineCov">         24 :                                 cep = zend_lookup_class(Z_STR(args[0]));</span></a>
<a name="1800"><span class="lineNum">    1800 </span><span class="lineCov">         24 :                                 if (!cep) {</span></a>
<a name="1801"><span class="lineNum">    1801 </span><span class="lineNoCov">          0 :                                         zend_argument_type_error(arg1_arg_num, &quot;must be a valid class&quot;);</span></a>
<a name="1802"><span class="lineNum">    1802 </span><span class="lineNoCov">          0 :                                         return false;</span></a>
<a name="1803"><span class="lineNum">    1803 </span>            :                                 }</a>
<a name="1804"><span class="lineNum">    1804 </span>            :                                 /* Verify constructor_args (args[1]) is ?array */</a>
<a name="1805"><span class="lineNum">    1805 </span>            :                                 /* TODO: Improve logic? */</a>
<a name="1806"><span class="lineNum">    1806 </span><span class="lineCov">         24 :                                 if (variadic_num_args == 2) {</span></a>
<a name="1807"><span class="lineNum">    1807 </span><span class="lineCov">         27 :                                         if (Z_TYPE(args[1]) != IS_NULL &amp;&amp; Z_TYPE(args[1]) != IS_ARRAY) {</span></a>
<a name="1808"><span class="lineNum">    1808 </span><span class="lineNoCov">          0 :                                                 zend_argument_type_error(constructor_arg_num, &quot;must be of type ?array, %s given&quot;,</span></a>
<a name="1809"><span class="lineNum">    1809 </span><span class="lineNoCov">          0 :                                                         zend_zval_type_name(&amp;args[1]));</span></a>
<a name="1810"><span class="lineNum">    1810 </span><span class="lineNoCov">          0 :                                                 return false;</span></a>
<a name="1811"><span class="lineNum">    1811 </span>            :                                         }</a>
<a name="1812"><span class="lineNum">    1812 </span><span class="lineCov">         18 :                                         if (Z_TYPE(args[1]) == IS_ARRAY &amp;&amp; zend_hash_num_elements(Z_ARRVAL(args[1]))) {</span></a>
<a name="1813"><span class="lineNum">    1813 </span><span class="lineCov">          9 :                                                 constructor_args = Z_ARRVAL(args[1]);</span></a>
<a name="1814"><span class="lineNum">    1814 </span>            :                                         }</a>
<a name="1815"><span class="lineNum">    1815 </span>            :                                 }</a>
<a name="1816"><span class="lineNum">    1816 </span><span class="lineCov">         24 :                                 stmt-&gt;fetch.cls.ce = cep;</span></a>
<a name="1817"><span class="lineNum">    1817 </span>            : </a>
<a name="1818"><span class="lineNum">    1818 </span>            :                                 /* If constructor arguments are present and not empty */</a>
<a name="1819"><span class="lineNum">    1819 </span><span class="lineCov">         24 :                                 if (constructor_args) {</span></a>
<a name="1820"><span class="lineNum">    1820 </span><span class="lineCov">          9 :                                         ZVAL_ARR(&amp;stmt-&gt;fetch.cls.ctor_args, zend_array_dup(constructor_args));</span></a>
<a name="1821"><span class="lineNum">    1821 </span>            :                                 }</a>
<a name="1822"><span class="lineNum">    1822 </span>            :                         }</a>
<a name="1823"><span class="lineNum">    1823 </span>            : </a>
<a name="1824"><span class="lineNum">    1824 </span><span class="lineCov">         24 :                         do_fetch_class_prepare(stmt);</span></a>
<a name="1825"><span class="lineNum">    1825 </span><span class="lineCov">         24 :                         break;</span></a>
<a name="1826"><span class="lineNum">    1826 </span>            :                 }</a>
<a name="1827"><span class="lineNum">    1827 </span><span class="lineCov">         39 :                 case PDO_FETCH_INTO:</span></a>
<a name="1828"><span class="lineNum">    1828 </span><span class="lineCov">         39 :                         if (total_num_args != arg1_arg_num) {</span></a>
<a name="1829"><span class="lineNum">    1829 </span><span class="lineCov">          3 :                                 zend_string *func = get_active_function_or_method_name();</span></a>
<a name="1830"><span class="lineNum">    1830 </span><span class="lineCov">          3 :                                 zend_argument_count_error(&quot;%s() expects exactly %d arguments for the fetch mode provided, %d given&quot;,</span></a>
<a name="1831"><span class="lineNum">    1831 </span><span class="lineCov">          3 :                                         ZSTR_VAL(func), arg1_arg_num, total_num_args);</span></a>
<a name="1832"><span class="lineNum">    1832 </span>            :                                 zend_string_release(func);</a>
<a name="1833"><span class="lineNum">    1833 </span><span class="lineCov">          3 :                                 return false;</span></a>
<a name="1834"><span class="lineNum">    1834 </span>            :                         }</a>
<a name="1835"><span class="lineNum">    1835 </span><span class="lineCov">         36 :                         if (Z_TYPE(args[0]) != IS_OBJECT) {</span></a>
<a name="1836"><span class="lineNum">    1836 </span><span class="lineNoCov">          0 :                                 zend_argument_type_error(arg1_arg_num, &quot;must be of type object, %s given&quot;, zend_zval_type_name(&amp;args[0]));</span></a>
<a name="1837"><span class="lineNum">    1837 </span><span class="lineNoCov">          0 :                                 return false;</span></a>
<a name="1838"><span class="lineNum">    1838 </span>            :                         }</a>
<a name="1839"><span class="lineNum">    1839 </span>            : </a>
<a name="1840"><span class="lineNum">    1840 </span><span class="lineCov">         36 :                         ZVAL_COPY(&amp;stmt-&gt;fetch.into, &amp;args[0]);</span></a>
<a name="1841"><span class="lineNum">    1841 </span><span class="lineCov">         36 :                         break;</span></a>
<a name="1842"><span class="lineNum">    1842 </span><span class="lineNoCov">          0 :                 default:</span></a>
<a name="1843"><span class="lineNum">    1843 </span><span class="lineNoCov">          0 :                         zend_argument_value_error(mode_arg_num, &quot;must be one of the PDO::FETCH_* constants&quot;);</span></a>
<a name="1844"><span class="lineNum">    1844 </span><span class="lineNoCov">          0 :                         return false;</span></a>
<a name="1845"><span class="lineNum">    1845 </span>            :         }</a>
<a name="1846"><span class="lineNum">    1846 </span>            : </a>
<a name="1847"><span class="lineNum">    1847 </span><span class="lineCov">         87 :         stmt-&gt;default_fetch_type = mode;</span></a>
<a name="1848"><span class="lineNum">    1848 </span>            : </a>
<a name="1849"><span class="lineNum">    1849 </span><span class="lineCov">         87 :         return true;</span></a>
<a name="1850"><span class="lineNum">    1850 </span>            : }</a>
<a name="1851"><span class="lineNum">    1851 </span>            : </a>
<a name="1852"><span class="lineNum">    1852 </span><span class="lineCov">        120 : PHP_METHOD(PDOStatement, setFetchMode)</span></a>
<a name="1853"><span class="lineNum">    1853 </span>            : {</a>
<a name="1854"><span class="lineNum">    1854 </span>            :         zend_long fetch_mode;</a>
<a name="1855"><span class="lineNum">    1855 </span><span class="lineCov">        120 :         zval *args = NULL;</span></a>
<a name="1856"><span class="lineNum">    1856 </span><span class="lineCov">        120 :         uint32_t num_args = 0;</span></a>
<a name="1857"><span class="lineNum">    1857 </span>            : </a>
<a name="1858"><span class="lineNum">    1858 </span><span class="lineCov">        120 :         if (zend_parse_parameters(ZEND_NUM_ARGS(), &quot;l*&quot;, &amp;fetch_mode, &amp;args, &amp;num_args) == FAILURE) {</span></a>
<a name="1859"><span class="lineNum">    1859 </span><span class="lineCov">         30 :                 RETURN_THROWS();</span></a>
<a name="1860"><span class="lineNum">    1860 </span>            :         }</a>
<a name="1861"><span class="lineNum">    1861 </span>            : </a>
<a name="1862"><span class="lineNum">    1862 </span><span class="lineCov">         90 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1863"><span class="lineNum">    1863 </span>            : </a>
<a name="1864"><span class="lineNum">    1864 </span><span class="lineCov">         66 :         do_fetch_opt_finish(stmt, 1);</span></a>
<a name="1865"><span class="lineNum">    1865 </span>            : </a>
<a name="1866"><span class="lineNum">    1866 </span><span class="lineCov">         66 :         if (!pdo_stmt_setup_fetch_mode(stmt, fetch_mode, 1, args, num_args)) {</span></a>
<a name="1867"><span class="lineNum">    1867 </span><span class="lineNoCov">          0 :                 RETURN_THROWS();</span></a>
<a name="1868"><span class="lineNum">    1868 </span>            :         }</a>
<a name="1869"><span class="lineNum">    1869 </span>            : </a>
<a name="1870"><span class="lineNum">    1870 </span>            :         // TODO Void return?</a>
<a name="1871"><span class="lineNum">    1871 </span><span class="lineCov">         66 :         RETURN_TRUE;</span></a>
<a name="1872"><span class="lineNum">    1872 </span>            : }</a>
<a name="1873"><span class="lineNum">    1873 </span>            : /* }}} */</a>
<a name="1874"><span class="lineNum">    1874 </span>            : </a>
<a name="1875"><span class="lineNum">    1875 </span>            : /* {{{ Advances to the next rowset in a multi-rowset statement handle. Returns true if it succeeded, false otherwise */</a>
<a name="1876"><span class="lineNum">    1876 </span>            : </a>
<a name="1877"><span class="lineNum">    1877 </span><span class="lineNoCov">          0 : static bool pdo_stmt_do_next_rowset(pdo_stmt_t *stmt)</span></a>
<a name="1878"><span class="lineNum">    1878 </span>            : {</a>
<a name="1879"><span class="lineNum">    1879 </span><span class="lineNoCov">          0 :         pdo_stmt_reset_columns(stmt);</span></a>
<a name="1880"><span class="lineNum">    1880 </span>            : </a>
<a name="1881"><span class="lineNum">    1881 </span><span class="lineNoCov">          0 :         if (!stmt-&gt;methods-&gt;next_rowset(stmt)) {</span></a>
<a name="1882"><span class="lineNum">    1882 </span>            :                 /* Set the executed flag to 0 to reallocate columns on next execute */</a>
<a name="1883"><span class="lineNum">    1883 </span><span class="lineNoCov">          0 :                 stmt-&gt;executed = 0;</span></a>
<a name="1884"><span class="lineNum">    1884 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="1885"><span class="lineNum">    1885 </span>            :         }</a>
<a name="1886"><span class="lineNum">    1886 </span>            : </a>
<a name="1887"><span class="lineNum">    1887 </span><span class="lineNoCov">          0 :         pdo_stmt_describe_columns(stmt);</span></a>
<a name="1888"><span class="lineNum">    1888 </span>            : </a>
<a name="1889"><span class="lineNum">    1889 </span><span class="lineNoCov">          0 :         return 1;</span></a>
<a name="1890"><span class="lineNum">    1890 </span>            : }</a>
<a name="1891"><span class="lineNum">    1891 </span>            : </a>
<a name="1892"><span class="lineNum">    1892 </span><span class="lineCov">         54 : PHP_METHOD(PDOStatement, nextRowset)</span></a>
<a name="1893"><span class="lineNum">    1893 </span>            : {</a>
<a name="1894"><span class="lineNum">    1894 </span><span class="lineCov">         54 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1895"><span class="lineNum">    1895 </span>            : </a>
<a name="1896"><span class="lineNum">    1896 </span><span class="lineCov">          6 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1897"><span class="lineNum">    1897 </span><span class="lineNoCov">          0 :         if (!stmt-&gt;methods-&gt;next_rowset) {</span></a>
<a name="1898"><span class="lineNum">    1898 </span><span class="lineNoCov">          0 :                 pdo_raise_impl_error(stmt-&gt;dbh, stmt, &quot;IM001&quot;, &quot;driver does not support multiple rowsets&quot;);</span></a>
<a name="1899"><span class="lineNum">    1899 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1900"><span class="lineNum">    1900 </span>            :         }</a>
<a name="1901"><span class="lineNum">    1901 </span>            : </a>
<a name="1902"><span class="lineNum">    1902 </span><span class="lineNoCov">          0 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1903"><span class="lineNum">    1903 </span>            : </a>
<a name="1904"><span class="lineNum">    1904 </span><span class="lineNoCov">          0 :         if (!pdo_stmt_do_next_rowset(stmt)) {</span></a>
<a name="1905"><span class="lineNum">    1905 </span><span class="lineNoCov">          0 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="1906"><span class="lineNum">    1906 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1907"><span class="lineNum">    1907 </span>            :         }</a>
<a name="1908"><span class="lineNum">    1908 </span>            : </a>
<a name="1909"><span class="lineNum">    1909 </span><span class="lineNoCov">          0 :         RETURN_TRUE;</span></a>
<a name="1910"><span class="lineNum">    1910 </span>            : }</a>
<a name="1911"><span class="lineNum">    1911 </span>            : /* }}} */</a>
<a name="1912"><span class="lineNum">    1912 </span>            : </a>
<a name="1913"><span class="lineNum">    1913 </span>            : /* {{{ Closes the cursor, leaving the statement ready for re-execution. */</a>
<a name="1914"><span class="lineNum">    1914 </span><span class="lineCov">        135 : PHP_METHOD(PDOStatement, closeCursor)</span></a>
<a name="1915"><span class="lineNum">    1915 </span>            : {</a>
<a name="1916"><span class="lineNum">    1916 </span><span class="lineCov">        135 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1917"><span class="lineNum">    1917 </span>            : </a>
<a name="1918"><span class="lineNum">    1918 </span><span class="lineCov">         87 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1919"><span class="lineNum">    1919 </span><span class="lineCov">         81 :         if (!stmt-&gt;methods-&gt;cursor_closer) {</span></a>
<a name="1920"><span class="lineNum">    1920 </span>            :                 /* emulate it by fetching and discarding rows */</a>
<a name="1921"><span class="lineNum">    1921 </span>            :                 do {</a>
<a name="1922"><span class="lineNum">    1922 </span><span class="lineNoCov">          0 :                         while (stmt-&gt;methods-&gt;fetcher(stmt, PDO_FETCH_ORI_NEXT, 0))</span></a>
<a name="1923"><span class="lineNum">    1923 </span>            :                                 ;</a>
<a name="1924"><span class="lineNum">    1924 </span><span class="lineNoCov">          0 :                         if (!stmt-&gt;methods-&gt;next_rowset) {</span></a>
<a name="1925"><span class="lineNum">    1925 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="1926"><span class="lineNum">    1926 </span>            :                         }</a>
<a name="1927"><span class="lineNum">    1927 </span>            : </a>
<a name="1928"><span class="lineNum">    1928 </span><span class="lineNoCov">          0 :                         if (!pdo_stmt_do_next_rowset(stmt)) {</span></a>
<a name="1929"><span class="lineNum">    1929 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="1930"><span class="lineNum">    1930 </span>            :                         }</a>
<a name="1931"><span class="lineNum">    1931 </span>            : </a>
<a name="1932"><span class="lineNum">    1932 </span>            :                 } while (1);</a>
<a name="1933"><span class="lineNum">    1933 </span><span class="lineNoCov">          0 :                 stmt-&gt;executed = 0;</span></a>
<a name="1934"><span class="lineNum">    1934 </span><span class="lineNoCov">          0 :                 RETURN_TRUE;</span></a>
<a name="1935"><span class="lineNum">    1935 </span>            :         }</a>
<a name="1936"><span class="lineNum">    1936 </span>            : </a>
<a name="1937"><span class="lineNum">    1937 </span><span class="lineCov">         81 :         PDO_STMT_CLEAR_ERR();</span></a>
<a name="1938"><span class="lineNum">    1938 </span>            : </a>
<a name="1939"><span class="lineNum">    1939 </span><span class="lineCov">         81 :         if (!stmt-&gt;methods-&gt;cursor_closer(stmt)) {</span></a>
<a name="1940"><span class="lineNum">    1940 </span><span class="lineNoCov">          0 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="1941"><span class="lineNum">    1941 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1942"><span class="lineNum">    1942 </span>            :         }</a>
<a name="1943"><span class="lineNum">    1943 </span><span class="lineCov">         81 :         stmt-&gt;executed = 0;</span></a>
<a name="1944"><span class="lineNum">    1944 </span><span class="lineCov">         81 :         RETURN_TRUE;</span></a>
<a name="1945"><span class="lineNum">    1945 </span>            : }</a>
<a name="1946"><span class="lineNum">    1946 </span>            : /* }}} */</a>
<a name="1947"><span class="lineNum">    1947 </span>            : </a>
<a name="1948"><span class="lineNum">    1948 </span>            : /* {{{ A utility for internals hackers to debug parameter internals */</a>
<a name="1949"><span class="lineNum">    1949 </span><span class="lineCov">         60 : PHP_METHOD(PDOStatement, debugDumpParams)</span></a>
<a name="1950"><span class="lineNum">    1950 </span>            : {</a>
<a name="1951"><span class="lineNum">    1951 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1952"><span class="lineNum">    1952 </span>            : </a>
<a name="1953"><span class="lineNum">    1953 </span><span class="lineCov">         12 :         php_stream *out = php_stream_open_wrapper(&quot;php://output&quot;, &quot;w&quot;, 0, NULL);</span></a>
<a name="1954"><span class="lineNum">    1954 </span>            :         struct pdo_bound_param_data *param;</a>
<a name="1955"><span class="lineNum">    1955 </span>            : </a>
<a name="1956"><span class="lineNum">    1956 </span><span class="lineCov">         12 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="1957"><span class="lineNum">    1957 </span>            : </a>
<a name="1958"><span class="lineNum">    1958 </span><span class="lineCov">         12 :         PHP_STMT_GET_OBJ;</span></a>
<a name="1959"><span class="lineNum">    1959 </span>            : </a>
<a name="1960"><span class="lineNum">    1960 </span><span class="lineCov">          6 :         if (out == NULL) {</span></a>
<a name="1961"><span class="lineNum">    1961 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="1962"><span class="lineNum">    1962 </span>            :         }</a>
<a name="1963"><span class="lineNum">    1963 </span>            : </a>
<a name="1964"><span class="lineNum">    1964 </span>            :         /* break into multiple operations so query string won't be truncated at FORMAT_CONV_MAX_PRECISION */</a>
<a name="1965"><span class="lineNum">    1965 </span><span class="lineCov">          6 :         php_stream_printf(out, &quot;SQL: [%zd] &quot;, ZSTR_LEN(stmt-&gt;query_string));</span></a>
<a name="1966"><span class="lineNum">    1966 </span><span class="lineCov">          6 :         php_stream_write(out, ZSTR_VAL(stmt-&gt;query_string), ZSTR_LEN(stmt-&gt;query_string));</span></a>
<a name="1967"><span class="lineNum">    1967 </span><span class="lineCov">          6 :         php_stream_write(out, &quot;\n&quot;, 1);</span></a>
<a name="1968"><span class="lineNum">    1968 </span>            : </a>
<a name="1969"><span class="lineNum">    1969 </span>            :         /* show parsed SQL if emulated prepares enabled */</a>
<a name="1970"><span class="lineNum">    1970 </span>            :         /* pointers will be equal if PDO::query() was invoked */</a>
<a name="1971"><span class="lineNum">    1971 </span><span class="lineCov">          6 :         if (stmt-&gt;active_query_string != NULL &amp;&amp; stmt-&gt;active_query_string != stmt-&gt;query_string) {</span></a>
<a name="1972"><span class="lineNum">    1972 </span>            :                 /* break into multiple operations so query string won't be truncated at FORMAT_CONV_MAX_PRECISION */</a>
<a name="1973"><span class="lineNum">    1973 </span><span class="lineNoCov">          0 :                 php_stream_printf(out, &quot;Sent SQL: [%zd] &quot;, ZSTR_LEN(stmt-&gt;active_query_string));</span></a>
<a name="1974"><span class="lineNum">    1974 </span><span class="lineNoCov">          0 :                 php_stream_write(out, ZSTR_VAL(stmt-&gt;active_query_string), ZSTR_LEN(stmt-&gt;active_query_string));</span></a>
<a name="1975"><span class="lineNum">    1975 </span><span class="lineNoCov">          0 :                 php_stream_write(out, &quot;\n&quot;, 1);</span></a>
<a name="1976"><span class="lineNum">    1976 </span>            :         }</a>
<a name="1977"><span class="lineNum">    1977 </span>            : </a>
<a name="1978"><span class="lineNum">    1978 </span><span class="lineCov">          6 :         php_stream_printf(out, &quot;Params:  %d\n&quot;,</span></a>
<a name="1979"><span class="lineNum">    1979 </span><span class="lineCov">          6 :                 stmt-&gt;bound_params ? zend_hash_num_elements(stmt-&gt;bound_params) : 0);</span></a>
<a name="1980"><span class="lineNum">    1980 </span>            : </a>
<a name="1981"><span class="lineNum">    1981 </span><span class="lineCov">          6 :         if (stmt-&gt;bound_params) {</span></a>
<a name="1982"><span class="lineNum">    1982 </span>            :                 zend_ulong num;</a>
<a name="1983"><span class="lineNum">    1983 </span><span class="lineCov">          3 :                 zend_string *key = NULL;</span></a>
<a name="1984"><span class="lineNum">    1984 </span><span class="lineCov">         21 :                 ZEND_HASH_FOREACH_KEY_PTR(stmt-&gt;bound_params, num, key, param) {</span></a>
<a name="1985"><span class="lineNum">    1985 </span><span class="lineCov">          9 :                         if (key) {</span></a>
<a name="1986"><span class="lineNum">    1986 </span><span class="lineCov">          6 :                                 php_stream_printf(out, &quot;Key: Name: [%zd] %.*s\n&quot;,</span></a>
<a name="1987"><span class="lineNum">    1987 </span><span class="lineCov">          6 :                                         ZSTR_LEN(key), (int) ZSTR_LEN(key), ZSTR_VAL(key));</span></a>
<a name="1988"><span class="lineNum">    1988 </span>            :                         } else {</a>
<a name="1989"><span class="lineNum">    1989 </span><span class="lineCov">          3 :                                 php_stream_printf(out, &quot;Key: Position #&quot; ZEND_ULONG_FMT &quot;:\n&quot;, num);</span></a>
<a name="1990"><span class="lineNum">    1990 </span>            :                         }</a>
<a name="1991"><span class="lineNum">    1991 </span>            : </a>
<a name="1992"><span class="lineNum">    1992 </span><span class="lineCov">         15 :                         php_stream_printf(out,</span></a>
<a name="1993"><span class="lineNum">    1993 </span>            :                                 &quot;paramno=&quot; ZEND_LONG_FMT &quot;\n&quot;</a>
<a name="1994"><span class="lineNum">    1994 </span>            :                                 &quot;name=[%zd] \&quot;%.*s\&quot;\n&quot;</a>
<a name="1995"><span class="lineNum">    1995 </span>            :                                 &quot;is_param=%d\n&quot;</a>
<a name="1996"><span class="lineNum">    1996 </span>            :                                 &quot;param_type=%d\n&quot;,</a>
<a name="1997"><span class="lineNum">    1997 </span><span class="lineCov">         12 :                                 param-&gt;paramno, param-&gt;name ? ZSTR_LEN(param-&gt;name) : 0, param-&gt;name ? (int) ZSTR_LEN(param-&gt;name) : 0,</span></a>
<a name="1998"><span class="lineNum">    1998 </span><span class="lineCov">          6 :                                 param-&gt;name ? ZSTR_VAL(param-&gt;name) : &quot;&quot;,</span></a>
<a name="1999"><span class="lineNum">    1999 </span>            :                                 param-&gt;is_param,</a>
<a name="2000"><span class="lineNum">    2000 </span><span class="lineCov">          9 :                                 param-&gt;param_type);</span></a>
<a name="2001"><span class="lineNum">    2001 </span>            : </a>
<a name="2002"><span class="lineNum">    2002 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="2003"><span class="lineNum">    2003 </span>            :         }</a>
<a name="2004"><span class="lineNum">    2004 </span>            : </a>
<a name="2005"><span class="lineNum">    2005 </span><span class="lineCov">          6 :         php_stream_close(out);</span></a>
<a name="2006"><span class="lineNum">    2006 </span>            : }</a>
<a name="2007"><span class="lineNum">    2007 </span>            : /* }}} */</a>
<a name="2008"><span class="lineNum">    2008 </span>            : </a>
<a name="2009"><span class="lineNum">    2009 </span><span class="lineCov">         60 : PHP_METHOD(PDOStatement, getIterator)</span></a>
<a name="2010"><span class="lineNum">    2010 </span>            : {</a>
<a name="2011"><span class="lineNum">    2011 </span><span class="lineCov">         60 :         if (zend_parse_parameters_none() == FAILURE) {</span></a>
<a name="2012"><span class="lineNum">    2012 </span><span class="lineCov">         48 :                 return;</span></a>
<a name="2013"><span class="lineNum">    2013 </span>            :         }</a>
<a name="2014"><span class="lineNum">    2014 </span>            : </a>
<a name="2015"><span class="lineNum">    2015 </span><span class="lineCov">         12 :         zend_create_internal_iterator_zval(return_value, ZEND_THIS);</span></a>
<a name="2016"><span class="lineNum">    2016 </span>            : }</a>
<a name="2017"><span class="lineNum">    2017 </span>            : </a>
<a name="2018"><span class="lineNum">    2018 </span>            : /* {{{ overloaded handlers for PDOStatement class */</a>
<a name="2019"><span class="lineNum">    2019 </span><span class="lineCov">         33 : static zval *dbstmt_prop_write(zend_object *object, zend_string *name, zval *value, void **cache_slot)</span></a>
<a name="2020"><span class="lineNum">    2020 </span>            : {</a>
<a name="2021"><span class="lineNum">    2021 </span><span class="lineCov">         33 :         if (zend_string_equals_literal(name, &quot;queryString&quot;)) {</span></a>
<a name="2022"><span class="lineNum">    2022 </span><span class="lineCov">         12 :                 zval *query_string = OBJ_PROP_NUM(object, 0);</span></a>
<a name="2023"><span class="lineNum">    2023 </span><span class="lineCov">         12 :                 if (!Z_ISUNDEF_P(query_string)) {</span></a>
<a name="2024"><span class="lineNum">    2024 </span><span class="lineCov">          6 :                         zend_throw_error(NULL, &quot;Property queryString is read only&quot;);</span></a>
<a name="2025"><span class="lineNum">    2025 </span><span class="lineCov">          6 :                         return value;</span></a>
<a name="2026"><span class="lineNum">    2026 </span>            :                 }</a>
<a name="2027"><span class="lineNum">    2027 </span>            :         }</a>
<a name="2028"><span class="lineNum">    2028 </span><span class="lineCov">         27 :         return zend_std_write_property(object, name, value, cache_slot);</span></a>
<a name="2029"><span class="lineNum">    2029 </span>            : }</a>
<a name="2030"><span class="lineNum">    2030 </span>            : </a>
<a name="2031"><span class="lineNum">    2031 </span><span class="lineNoCov">          0 : static void dbstmt_prop_delete(zend_object *object, zend_string *name, void **cache_slot)</span></a>
<a name="2032"><span class="lineNum">    2032 </span>            : {</a>
<a name="2033"><span class="lineNum">    2033 </span><span class="lineNoCov">          0 :         if (zend_string_equals_literal(name, &quot;queryString&quot;)) {</span></a>
<a name="2034"><span class="lineNum">    2034 </span><span class="lineNoCov">          0 :                 zend_throw_error(NULL, &quot;Property queryString is read only&quot;);</span></a>
<a name="2035"><span class="lineNum">    2035 </span>            :         } else {</a>
<a name="2036"><span class="lineNum">    2036 </span><span class="lineNoCov">          0 :                 zend_std_unset_property(object, name, cache_slot);</span></a>
<a name="2037"><span class="lineNum">    2037 </span>            :         }</a>
<a name="2038"><span class="lineNum">    2038 </span><span class="lineNoCov">          0 : }</span></a>
<a name="2039"><span class="lineNum">    2039 </span>            : </a>
<a name="2040"><span class="lineNum">    2040 </span><span class="lineCov">       2118 : static zend_function *dbstmt_method_get(zend_object **object_pp, zend_string *method_name, const zval *key)</span></a>
<a name="2041"><span class="lineNum">    2041 </span>            : {</a>
<a name="2042"><span class="lineNum">    2042 </span><span class="lineCov">       2118 :         zend_function *fbc = NULL;</span></a>
<a name="2043"><span class="lineNum">    2043 </span>            :         zend_string *lc_method_name;</a>
<a name="2044"><span class="lineNum">    2044 </span><span class="lineCov">       2118 :         zend_object *object = *object_pp;</span></a>
<a name="2045"><span class="lineNum">    2045 </span>            : </a>
<a name="2046"><span class="lineNum">    2046 </span><span class="lineCov">       2118 :         lc_method_name = zend_string_tolower(method_name);</span></a>
<a name="2047"><span class="lineNum">    2047 </span>            : </a>
<a name="2048"><span class="lineNum">    2048 </span><span class="lineCov">       4236 :         if ((fbc = zend_hash_find_ptr(&amp;object-&gt;ce-&gt;function_table, lc_method_name)) == NULL) {</span></a>
<a name="2049"><span class="lineNum">    2049 </span><span class="lineCov">         15 :                 pdo_stmt_t *stmt = php_pdo_stmt_fetch_object(object);</span></a>
<a name="2050"><span class="lineNum">    2050 </span>            :                 /* instance not created by PDO object */</a>
<a name="2051"><span class="lineNum">    2051 </span><span class="lineCov">         15 :                 if (!stmt-&gt;dbh) {</span></a>
<a name="2052"><span class="lineNum">    2052 </span><span class="lineCov">          9 :                         goto out;</span></a>
<a name="2053"><span class="lineNum">    2053 </span>            :                 }</a>
<a name="2054"><span class="lineNum">    2054 </span>            :                 /* not a pre-defined method, nor a user-defined method; check</a>
<a name="2055"><span class="lineNum">    2055 </span>            :                  * the driver specific methods */</a>
<a name="2056"><span class="lineNum">    2056 </span><span class="lineCov">          6 :                 if (!stmt-&gt;dbh-&gt;cls_methods[PDO_DBH_DRIVER_METHOD_KIND_STMT]) {</span></a>
<a name="2057"><span class="lineNum">    2057 </span><span class="lineCov">          6 :                         if (!pdo_hash_methods(Z_PDO_OBJECT_P(&amp;stmt-&gt;database_object_handle),</span></a>
<a name="2058"><span class="lineNum">    2058 </span>            :                                 PDO_DBH_DRIVER_METHOD_KIND_STMT)</a>
<a name="2059"><span class="lineNum">    2059 </span><span class="lineNoCov">          0 :                                 || !stmt-&gt;dbh-&gt;cls_methods[PDO_DBH_DRIVER_METHOD_KIND_STMT]) {</span></a>
<a name="2060"><span class="lineNum">    2060 </span><span class="lineCov">          6 :                                 goto out;</span></a>
<a name="2061"><span class="lineNum">    2061 </span>            :                         }</a>
<a name="2062"><span class="lineNum">    2062 </span>            :                 }</a>
<a name="2063"><span class="lineNum">    2063 </span>            : </a>
<a name="2064"><span class="lineNum">    2064 </span><span class="lineNoCov">          0 :                 if ((fbc = zend_hash_find_ptr(stmt-&gt;dbh-&gt;cls_methods[PDO_DBH_DRIVER_METHOD_KIND_STMT], lc_method_name)) == NULL) {</span></a>
<a name="2065"><span class="lineNum">    2065 </span><span class="lineNoCov">          0 :                         goto out;</span></a>
<a name="2066"><span class="lineNum">    2066 </span>            :                 }</a>
<a name="2067"><span class="lineNum">    2067 </span>            :                 /* got it */</a>
<a name="2068"><span class="lineNum">    2068 </span>            :         }</a>
<a name="2069"><span class="lineNum">    2069 </span>            : </a>
<a name="2070"><span class="lineNum">    2070 </span><span class="lineCov">       2118 : out:</span></a>
<a name="2071"><span class="lineNum">    2071 </span>            :         zend_string_release_ex(lc_method_name, 0);</a>
<a name="2072"><span class="lineNum">    2072 </span><span class="lineCov">       2118 :         if (!fbc) {</span></a>
<a name="2073"><span class="lineNum">    2073 </span><span class="lineCov">         15 :                 fbc = zend_std_get_method(object_pp, method_name, key);</span></a>
<a name="2074"><span class="lineNum">    2074 </span>            :         }</a>
<a name="2075"><span class="lineNum">    2075 </span><span class="lineCov">       2118 :         return fbc;</span></a>
<a name="2076"><span class="lineNum">    2076 </span>            : }</a>
<a name="2077"><span class="lineNum">    2077 </span>            : </a>
<a name="2078"><span class="lineNum">    2078 </span>            : zend_object_handlers pdo_dbstmt_object_handlers;</a>
<a name="2079"><span class="lineNum">    2079 </span>            : zend_object_handlers pdo_row_object_handlers;</a>
<a name="2080"><span class="lineNum">    2080 </span>            : </a>
<a name="2081"><span class="lineNum">    2081 </span><span class="lineCov">        687 : PDO_API void php_pdo_free_statement(pdo_stmt_t *stmt)</span></a>
<a name="2082"><span class="lineNum">    2082 </span>            : {</a>
<a name="2083"><span class="lineNum">    2083 </span><span class="lineCov">        687 :         if (stmt-&gt;bound_params) {</span></a>
<a name="2084"><span class="lineNum">    2084 </span><span class="lineCov">        114 :                 zend_hash_destroy(stmt-&gt;bound_params);</span></a>
<a name="2085"><span class="lineNum">    2085 </span><span class="lineCov">        114 :                 FREE_HASHTABLE(stmt-&gt;bound_params);</span></a>
<a name="2086"><span class="lineNum">    2086 </span><span class="lineCov">        114 :                 stmt-&gt;bound_params = NULL;</span></a>
<a name="2087"><span class="lineNum">    2087 </span>            :         }</a>
<a name="2088"><span class="lineNum">    2088 </span><span class="lineCov">        687 :         if (stmt-&gt;bound_param_map) {</span></a>
<a name="2089"><span class="lineNum">    2089 </span><span class="lineNoCov">          0 :                 zend_hash_destroy(stmt-&gt;bound_param_map);</span></a>
<a name="2090"><span class="lineNum">    2090 </span><span class="lineNoCov">          0 :                 FREE_HASHTABLE(stmt-&gt;bound_param_map);</span></a>
<a name="2091"><span class="lineNum">    2091 </span><span class="lineNoCov">          0 :                 stmt-&gt;bound_param_map = NULL;</span></a>
<a name="2092"><span class="lineNum">    2092 </span>            :         }</a>
<a name="2093"><span class="lineNum">    2093 </span><span class="lineCov">        687 :         if (stmt-&gt;bound_columns) {</span></a>
<a name="2094"><span class="lineNum">    2094 </span><span class="lineCov">         24 :                 zend_hash_destroy(stmt-&gt;bound_columns);</span></a>
<a name="2095"><span class="lineNum">    2095 </span><span class="lineCov">         24 :                 FREE_HASHTABLE(stmt-&gt;bound_columns);</span></a>
<a name="2096"><span class="lineNum">    2096 </span><span class="lineCov">         24 :                 stmt-&gt;bound_columns = NULL;</span></a>
<a name="2097"><span class="lineNum">    2097 </span>            :         }</a>
<a name="2098"><span class="lineNum">    2098 </span>            : </a>
<a name="2099"><span class="lineNum">    2099 </span><span class="lineCov">        687 :         if (stmt-&gt;methods &amp;&amp; stmt-&gt;methods-&gt;dtor) {</span></a>
<a name="2100"><span class="lineNum">    2100 </span><span class="lineCov">        645 :                 stmt-&gt;methods-&gt;dtor(stmt);</span></a>
<a name="2101"><span class="lineNum">    2101 </span>            :         }</a>
<a name="2102"><span class="lineNum">    2102 </span><span class="lineCov">        687 :         if (stmt-&gt;active_query_string) {</span></a>
<a name="2103"><span class="lineNum">    2103 </span><span class="lineCov">        354 :                 zend_string_release(stmt-&gt;active_query_string);</span></a>
<a name="2104"><span class="lineNum">    2104 </span>            :         }</a>
<a name="2105"><span class="lineNum">    2105 </span><span class="lineCov">        687 :         if (stmt-&gt;query_string) {</span></a>
<a name="2106"><span class="lineNum">    2106 </span><span class="lineCov">        645 :                 zend_string_release(stmt-&gt;query_string);</span></a>
<a name="2107"><span class="lineNum">    2107 </span>            :         }</a>
<a name="2108"><span class="lineNum">    2108 </span>            : </a>
<a name="2109"><span class="lineNum">    2109 </span><span class="lineCov">        687 :         pdo_stmt_reset_columns(stmt);</span></a>
<a name="2110"><span class="lineNum">    2110 </span>            : </a>
<a name="2111"><span class="lineNum">    2111 </span><span class="lineCov">       1374 :         if (!Z_ISUNDEF(stmt-&gt;fetch.into) &amp;&amp; stmt-&gt;default_fetch_type == PDO_FETCH_INTO) {</span></a>
<a name="2112"><span class="lineNum">    2112 </span><span class="lineCov">          6 :                 zval_ptr_dtor(&amp;stmt-&gt;fetch.into);</span></a>
<a name="2113"><span class="lineNum">    2113 </span><span class="lineCov">          6 :                 ZVAL_UNDEF(&amp;stmt-&gt;fetch.into);</span></a>
<a name="2114"><span class="lineNum">    2114 </span>            :         }</a>
<a name="2115"><span class="lineNum">    2115 </span>            : </a>
<a name="2116"><span class="lineNum">    2116 </span><span class="lineCov">        687 :         do_fetch_opt_finish(stmt, 1);</span></a>
<a name="2117"><span class="lineNum">    2117 </span>            : </a>
<a name="2118"><span class="lineNum">    2118 </span><span class="lineCov">       1374 :         if (!Z_ISUNDEF(stmt-&gt;database_object_handle)) {</span></a>
<a name="2119"><span class="lineNum">    2119 </span><span class="lineCov">        627 :                 zval_ptr_dtor(&amp;stmt-&gt;database_object_handle);</span></a>
<a name="2120"><span class="lineNum">    2120 </span>            :         }</a>
<a name="2121"><span class="lineNum">    2121 </span><span class="lineCov">        687 :         zend_object_std_dtor(&amp;stmt-&gt;std);</span></a>
<a name="2122"><span class="lineNum">    2122 </span><span class="lineCov">        687 : }</span></a>
<a name="2123"><span class="lineNum">    2123 </span>            : </a>
<a name="2124"><span class="lineNum">    2124 </span><span class="lineCov">        687 : void pdo_dbstmt_free_storage(zend_object *std)</span></a>
<a name="2125"><span class="lineNum">    2125 </span>            : {</a>
<a name="2126"><span class="lineNum">    2126 </span><span class="lineCov">        687 :         pdo_stmt_t *stmt = php_pdo_stmt_fetch_object(std);</span></a>
<a name="2127"><span class="lineNum">    2127 </span><span class="lineCov">        687 :         php_pdo_free_statement(stmt);</span></a>
<a name="2128"><span class="lineNum">    2128 </span><span class="lineCov">        687 : }</span></a>
<a name="2129"><span class="lineNum">    2129 </span>            : </a>
<a name="2130"><span class="lineNum">    2130 </span><span class="lineCov">        687 : zend_object *pdo_dbstmt_new(zend_class_entry *ce)</span></a>
<a name="2131"><span class="lineNum">    2131 </span>            : {</a>
<a name="2132"><span class="lineNum">    2132 </span>            :         pdo_stmt_t *stmt;</a>
<a name="2133"><span class="lineNum">    2133 </span>            : </a>
<a name="2134"><span class="lineNum">    2134 </span><span class="lineCov">        687 :         stmt = zend_object_alloc(sizeof(pdo_stmt_t), ce);</span></a>
<a name="2135"><span class="lineNum">    2135 </span><span class="lineCov">        687 :         zend_object_std_init(&amp;stmt-&gt;std, ce);</span></a>
<a name="2136"><span class="lineNum">    2136 </span><span class="lineCov">        687 :         object_properties_init(&amp;stmt-&gt;std, ce);</span></a>
<a name="2137"><span class="lineNum">    2137 </span>            : </a>
<a name="2138"><span class="lineNum">    2138 </span><span class="lineCov">        687 :         stmt-&gt;std.handlers = &amp;pdo_dbstmt_object_handlers;</span></a>
<a name="2139"><span class="lineNum">    2139 </span>            : </a>
<a name="2140"><span class="lineNum">    2140 </span><span class="lineCov">        687 :         return &amp;stmt-&gt;std;</span></a>
<a name="2141"><span class="lineNum">    2141 </span>            : }</a>
<a name="2142"><span class="lineNum">    2142 </span>            : /* }}} */</a>
<a name="2143"><span class="lineNum">    2143 </span>            : </a>
<a name="2144"><span class="lineNum">    2144 </span>            : /* {{{ statement iterator */</a>
<a name="2145"><span class="lineNum">    2145 </span>            : </a>
<a name="2146"><span class="lineNum">    2146 </span>            : struct php_pdo_iterator {</a>
<a name="2147"><span class="lineNum">    2147 </span>            :         zend_object_iterator iter;</a>
<a name="2148"><span class="lineNum">    2148 </span>            :         zend_ulong key;</a>
<a name="2149"><span class="lineNum">    2149 </span>            :         zval fetch_ahead;</a>
<a name="2150"><span class="lineNum">    2150 </span>            : };</a>
<a name="2151"><span class="lineNum">    2151 </span>            : </a>
<a name="2152"><span class="lineNum">    2152 </span><span class="lineCov">         48 : static void pdo_stmt_iter_dtor(zend_object_iterator *iter)</span></a>
<a name="2153"><span class="lineNum">    2153 </span>            : {</a>
<a name="2154"><span class="lineNum">    2154 </span><span class="lineCov">         48 :         struct php_pdo_iterator *I = (struct php_pdo_iterator*)iter;</span></a>
<a name="2155"><span class="lineNum">    2155 </span>            : </a>
<a name="2156"><span class="lineNum">    2156 </span><span class="lineCov">         48 :         zval_ptr_dtor(&amp;I-&gt;iter.data);</span></a>
<a name="2157"><span class="lineNum">    2157 </span>            : </a>
<a name="2158"><span class="lineNum">    2158 </span><span class="lineCov">         96 :         if (!Z_ISUNDEF(I-&gt;fetch_ahead)) {</span></a>
<a name="2159"><span class="lineNum">    2159 </span><span class="lineCov">          3 :                 zval_ptr_dtor(&amp;I-&gt;fetch_ahead);</span></a>
<a name="2160"><span class="lineNum">    2160 </span>            :         }</a>
<a name="2161"><span class="lineNum">    2161 </span><span class="lineCov">         48 : }</span></a>
<a name="2162"><span class="lineNum">    2162 </span>            : </a>
<a name="2163"><span class="lineNum">    2163 </span><span class="lineCov">        162 : static int pdo_stmt_iter_valid(zend_object_iterator *iter)</span></a>
<a name="2164"><span class="lineNum">    2164 </span>            : {</a>
<a name="2165"><span class="lineNum">    2165 </span><span class="lineCov">        162 :         struct php_pdo_iterator *I = (struct php_pdo_iterator*)iter;</span></a>
<a name="2166"><span class="lineNum">    2166 </span>            : </a>
<a name="2167"><span class="lineNum">    2167 </span><span class="lineCov">        324 :         return Z_ISUNDEF(I-&gt;fetch_ahead) ? FAILURE : SUCCESS;</span></a>
<a name="2168"><span class="lineNum">    2168 </span>            : }</a>
<a name="2169"><span class="lineNum">    2169 </span>            : </a>
<a name="2170"><span class="lineNum">    2170 </span><span class="lineCov">        114 : static zval *pdo_stmt_iter_get_data(zend_object_iterator *iter)</span></a>
<a name="2171"><span class="lineNum">    2171 </span>            : {</a>
<a name="2172"><span class="lineNum">    2172 </span><span class="lineCov">        114 :         struct php_pdo_iterator *I = (struct php_pdo_iterator*)iter;</span></a>
<a name="2173"><span class="lineNum">    2173 </span>            : </a>
<a name="2174"><span class="lineNum">    2174 </span>            :         /* sanity */</a>
<a name="2175"><span class="lineNum">    2175 </span><span class="lineCov">        228 :         if (Z_ISUNDEF(I-&gt;fetch_ahead)) {</span></a>
<a name="2176"><span class="lineNum">    2176 </span><span class="lineNoCov">          0 :                 return NULL;</span></a>
<a name="2177"><span class="lineNum">    2177 </span>            :         }</a>
<a name="2178"><span class="lineNum">    2178 </span>            : </a>
<a name="2179"><span class="lineNum">    2179 </span><span class="lineCov">        114 :         return &amp;I-&gt;fetch_ahead;</span></a>
<a name="2180"><span class="lineNum">    2180 </span>            : }</a>
<a name="2181"><span class="lineNum">    2181 </span>            : </a>
<a name="2182"><span class="lineNum">    2182 </span><span class="lineCov">         12 : static void pdo_stmt_iter_get_key(zend_object_iterator *iter, zval *key)</span></a>
<a name="2183"><span class="lineNum">    2183 </span>            : {</a>
<a name="2184"><span class="lineNum">    2184 </span><span class="lineCov">         12 :         struct php_pdo_iterator *I = (struct php_pdo_iterator*)iter;</span></a>
<a name="2185"><span class="lineNum">    2185 </span>            : </a>
<a name="2186"><span class="lineNum">    2186 </span><span class="lineCov">         12 :         if (I-&gt;key == (zend_ulong)-1) {</span></a>
<a name="2187"><span class="lineNum">    2187 </span><span class="lineNoCov">          0 :                 ZVAL_NULL(key);</span></a>
<a name="2188"><span class="lineNum">    2188 </span>            :         } else {</a>
<a name="2189"><span class="lineNum">    2189 </span><span class="lineCov">         12 :                 ZVAL_LONG(key, I-&gt;key);</span></a>
<a name="2190"><span class="lineNum">    2190 </span>            :         }</a>
<a name="2191"><span class="lineNum">    2191 </span><span class="lineCov">         12 : }</span></a>
<a name="2192"><span class="lineNum">    2192 </span>            : </a>
<a name="2193"><span class="lineNum">    2193 </span><span class="lineCov">        117 : static void pdo_stmt_iter_move_forwards(zend_object_iterator *iter)</span></a>
<a name="2194"><span class="lineNum">    2194 </span>            : {</a>
<a name="2195"><span class="lineNum">    2195 </span><span class="lineCov">        117 :         struct php_pdo_iterator *I = (struct php_pdo_iterator*)iter;</span></a>
<a name="2196"><span class="lineNum">    2196 </span><span class="lineCov">        117 :         pdo_stmt_t *stmt = Z_PDO_STMT_P(&amp;I-&gt;iter.data); /* for PDO_HANDLE_STMT_ERR() */</span></a>
<a name="2197"><span class="lineNum">    2197 </span>            : </a>
<a name="2198"><span class="lineNum">    2198 </span><span class="lineCov">        234 :         if (!Z_ISUNDEF(I-&gt;fetch_ahead)) {</span></a>
<a name="2199"><span class="lineNum">    2199 </span><span class="lineCov">        114 :                 zval_ptr_dtor(&amp;I-&gt;fetch_ahead);</span></a>
<a name="2200"><span class="lineNum">    2200 </span>            :         }</a>
<a name="2201"><span class="lineNum">    2201 </span>            : </a>
<a name="2202"><span class="lineNum">    2202 </span><span class="lineCov">        117 :         if (!do_fetch(stmt, &amp;I-&gt;fetch_ahead, PDO_FETCH_USE_DEFAULT,</span></a>
<a name="2203"><span class="lineNum">    2203 </span>            :                         PDO_FETCH_ORI_NEXT, /* offset */ 0, NULL)) {</a>
<a name="2204"><span class="lineNum">    2204 </span>            : </a>
<a name="2205"><span class="lineNum">    2205 </span><span class="lineCov">         48 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="2206"><span class="lineNum">    2206 </span><span class="lineCov">         48 :                 I-&gt;key = (zend_ulong)-1;</span></a>
<a name="2207"><span class="lineNum">    2207 </span><span class="lineCov">         48 :                 ZVAL_UNDEF(&amp;I-&gt;fetch_ahead);</span></a>
<a name="2208"><span class="lineNum">    2208 </span>            : </a>
<a name="2209"><span class="lineNum">    2209 </span><span class="lineCov">         48 :                 return;</span></a>
<a name="2210"><span class="lineNum">    2210 </span>            :         }</a>
<a name="2211"><span class="lineNum">    2211 </span>            : </a>
<a name="2212"><span class="lineNum">    2212 </span><span class="lineCov">         69 :         I-&gt;key++;</span></a>
<a name="2213"><span class="lineNum">    2213 </span>            : }</a>
<a name="2214"><span class="lineNum">    2214 </span>            : </a>
<a name="2215"><span class="lineNum">    2215 </span>            : static const zend_object_iterator_funcs pdo_stmt_iter_funcs = {</a>
<a name="2216"><span class="lineNum">    2216 </span>            :         pdo_stmt_iter_dtor,</a>
<a name="2217"><span class="lineNum">    2217 </span>            :         pdo_stmt_iter_valid,</a>
<a name="2218"><span class="lineNum">    2218 </span>            :         pdo_stmt_iter_get_data,</a>
<a name="2219"><span class="lineNum">    2219 </span>            :         pdo_stmt_iter_get_key,</a>
<a name="2220"><span class="lineNum">    2220 </span>            :         pdo_stmt_iter_move_forwards,</a>
<a name="2221"><span class="lineNum">    2221 </span>            :         NULL,</a>
<a name="2222"><span class="lineNum">    2222 </span>            :         NULL,</a>
<a name="2223"><span class="lineNum">    2223 </span>            :         NULL, /* get_gc */</a>
<a name="2224"><span class="lineNum">    2224 </span>            : };</a>
<a name="2225"><span class="lineNum">    2225 </span>            : </a>
<a name="2226"><span class="lineNum">    2226 </span><span class="lineCov">         60 : zend_object_iterator *pdo_stmt_iter_get(zend_class_entry *ce, zval *object, int by_ref)</span></a>
<a name="2227"><span class="lineNum">    2227 </span>            : {</a>
<a name="2228"><span class="lineNum">    2228 </span><span class="lineCov">         60 :         if (by_ref) {</span></a>
<a name="2229"><span class="lineNum">    2229 </span><span class="lineNoCov">          0 :                 zend_throw_error(NULL, &quot;An iterator cannot be used with foreach by reference&quot;);</span></a>
<a name="2230"><span class="lineNum">    2230 </span><span class="lineNoCov">          0 :                 return NULL;</span></a>
<a name="2231"><span class="lineNum">    2231 </span>            :         }</a>
<a name="2232"><span class="lineNum">    2232 </span>            : </a>
<a name="2233"><span class="lineNum">    2233 </span><span class="lineCov">         60 :         pdo_stmt_t *stmt = Z_PDO_STMT_P(object);</span></a>
<a name="2234"><span class="lineNum">    2234 </span><span class="lineCov">         60 :         if (!stmt-&gt;dbh) {</span></a>
<a name="2235"><span class="lineNum">    2235 </span><span class="lineCov">         12 :                 zend_throw_error(NULL, &quot;PDO object is uninitialized&quot;);</span></a>
<a name="2236"><span class="lineNum">    2236 </span><span class="lineCov">         12 :                 return NULL;</span></a>
<a name="2237"><span class="lineNum">    2237 </span>            :         }</a>
<a name="2238"><span class="lineNum">    2238 </span>            : </a>
<a name="2239"><span class="lineNum">    2239 </span><span class="lineCov">         48 :         struct php_pdo_iterator *I = ecalloc(1, sizeof(struct php_pdo_iterator));</span></a>
<a name="2240"><span class="lineNum">    2240 </span><span class="lineCov">         48 :         zend_iterator_init(&amp;I-&gt;iter);</span></a>
<a name="2241"><span class="lineNum">    2241 </span><span class="lineCov">         48 :         I-&gt;iter.funcs = &amp;pdo_stmt_iter_funcs;</span></a>
<a name="2242"><span class="lineNum">    2242 </span>            :         Z_ADDREF_P(object);</a>
<a name="2243"><span class="lineNum">    2243 </span><span class="lineCov">         48 :         ZVAL_OBJ(&amp;I-&gt;iter.data, Z_OBJ_P(object));</span></a>
<a name="2244"><span class="lineNum">    2244 </span>            : </a>
<a name="2245"><span class="lineNum">    2245 </span><span class="lineCov">         48 :         if (!do_fetch(stmt, &amp;I-&gt;fetch_ahead, PDO_FETCH_USE_DEFAULT,</span></a>
<a name="2246"><span class="lineNum">    2246 </span>            :                         PDO_FETCH_ORI_NEXT, /* offset */ 0, NULL)) {</a>
<a name="2247"><span class="lineNum">    2247 </span><span class="lineNoCov">          0 :                 PDO_HANDLE_STMT_ERR();</span></a>
<a name="2248"><span class="lineNum">    2248 </span><span class="lineNoCov">          0 :                 I-&gt;key = (zend_ulong)-1;</span></a>
<a name="2249"><span class="lineNum">    2249 </span><span class="lineNoCov">          0 :                 ZVAL_UNDEF(&amp;I-&gt;fetch_ahead);</span></a>
<a name="2250"><span class="lineNum">    2250 </span>            :         }</a>
<a name="2251"><span class="lineNum">    2251 </span>            : </a>
<a name="2252"><span class="lineNum">    2252 </span><span class="lineCov">         48 :         return &amp;I-&gt;iter;</span></a>
<a name="2253"><span class="lineNum">    2253 </span>            : }</a>
<a name="2254"><span class="lineNum">    2254 </span>            : </a>
<a name="2255"><span class="lineNum">    2255 </span>            : /* }}} */</a>
<a name="2256"><span class="lineNum">    2256 </span>            : </a>
<a name="2257"><span class="lineNum">    2257 </span>            : /* {{{ overloaded handlers for PDORow class (used by PDO_FETCH_LAZY) */</a>
<a name="2258"><span class="lineNum">    2258 </span>            : </a>
<a name="2259"><span class="lineNum">    2259 </span><span class="lineCov">         27 : static zval *row_prop_read(zend_object *object, zend_string *name, int type, void **cache_slot, zval *rv)</span></a>
<a name="2260"><span class="lineNum">    2260 </span>            : {</a>
<a name="2261"><span class="lineNum">    2261 </span><span class="lineCov">         27 :         pdo_row_t *row = (pdo_row_t *)object;</span></a>
<a name="2262"><span class="lineNum">    2262 </span><span class="lineCov">         27 :         pdo_stmt_t *stmt = row-&gt;stmt;</span></a>
<a name="2263"><span class="lineNum">    2263 </span><span class="lineCov">         27 :         int colno = -1;</span></a>
<a name="2264"><span class="lineNum">    2264 </span>            :         zend_long lval;</a>
<a name="2265"><span class="lineNum">    2265 </span><span class="lineCov">         27 :         ZEND_ASSERT(stmt);</span></a>
<a name="2266"><span class="lineNum">    2266 </span>            : </a>
<a name="2267"><span class="lineNum">    2267 </span><span class="lineCov">         27 :         ZVAL_NULL(rv);</span></a>
<a name="2268"><span class="lineNum">    2268 </span><span class="lineCov">         27 :         if (zend_string_equals_literal(name, &quot;queryString&quot;)) {</span></a>
<a name="2269"><span class="lineNum">    2269 </span><span class="lineCov">          6 :                 return zend_std_read_property(&amp;stmt-&gt;std, name, type, cache_slot, rv);</span></a>
<a name="2270"><span class="lineNum">    2270 </span><span class="lineCov">         42 :         } else if (is_numeric_string(ZSTR_VAL(name), ZSTR_LEN(name), &amp;lval, NULL, 0) == IS_LONG) {</span></a>
<a name="2271"><span class="lineNum">    2271 </span><span class="lineCov">          3 :                 if (lval &gt;= 0 &amp;&amp; lval &lt; stmt-&gt;column_count) {</span></a>
<a name="2272"><span class="lineNum">    2272 </span><span class="lineNoCov">          0 :                         fetch_value(stmt, rv, lval, NULL);</span></a>
<a name="2273"><span class="lineNum">    2273 </span>            :                 }</a>
<a name="2274"><span class="lineNum">    2274 </span>            :         } else {</a>
<a name="2275"><span class="lineNum">    2275 </span>            :                 /* TODO: replace this with a hash of available column names to column</a>
<a name="2276"><span class="lineNum">    2276 </span>            :                  * numbers */</a>
<a name="2277"><span class="lineNum">    2277 </span><span class="lineCov">         27 :                 for (colno = 0; colno &lt; stmt-&gt;column_count; colno++) {</span></a>
<a name="2278"><span class="lineNum">    2278 </span><span class="lineCov">         48 :                         if (zend_string_equals(stmt-&gt;columns[colno].name, name)) {</span></a>
<a name="2279"><span class="lineNum">    2279 </span><span class="lineCov">         15 :                                 fetch_value(stmt, rv, colno, NULL);</span></a>
<a name="2280"><span class="lineNum">    2280 </span><span class="lineCov">         15 :                                 return rv;</span></a>
<a name="2281"><span class="lineNum">    2281 </span>            :                         }</a>
<a name="2282"><span class="lineNum">    2282 </span>            :                 }</a>
<a name="2283"><span class="lineNum">    2283 </span>            :         }</a>
<a name="2284"><span class="lineNum">    2284 </span>            : </a>
<a name="2285"><span class="lineNum">    2285 </span><span class="lineCov">          6 :         return rv;</span></a>
<a name="2286"><span class="lineNum">    2286 </span>            : }</a>
<a name="2287"><span class="lineNum">    2287 </span>            : </a>
<a name="2288"><span class="lineNum">    2288 </span><span class="lineCov">          3 : static zval *row_dim_read(zend_object *object, zval *member, int type, zval *rv)</span></a>
<a name="2289"><span class="lineNum">    2289 </span>            : {</a>
<a name="2290"><span class="lineNum">    2290 </span><span class="lineCov">          3 :         pdo_row_t *row = (pdo_row_t *)object;</span></a>
<a name="2291"><span class="lineNum">    2291 </span><span class="lineCov">          3 :         pdo_stmt_t *stmt = row-&gt;stmt;</span></a>
<a name="2292"><span class="lineNum">    2292 </span><span class="lineCov">          3 :         int colno = -1;</span></a>
<a name="2293"><span class="lineNum">    2293 </span>            :         zend_long lval;</a>
<a name="2294"><span class="lineNum">    2294 </span><span class="lineCov">          3 :         ZEND_ASSERT(stmt);</span></a>
<a name="2295"><span class="lineNum">    2295 </span>            : </a>
<a name="2296"><span class="lineNum">    2296 </span><span class="lineCov">          3 :         ZVAL_NULL(rv);</span></a>
<a name="2297"><span class="lineNum">    2297 </span><span class="lineCov">          3 :         if (Z_TYPE_P(member) == IS_LONG) {</span></a>
<a name="2298"><span class="lineNum">    2298 </span><span class="lineCov">          3 :                 if (Z_LVAL_P(member) &gt;= 0 &amp;&amp; Z_LVAL_P(member) &lt; stmt-&gt;column_count) {</span></a>
<a name="2299"><span class="lineNum">    2299 </span><span class="lineNoCov">          0 :                         fetch_value(stmt, rv, Z_LVAL_P(member), NULL);</span></a>
<a name="2300"><span class="lineNum">    2300 </span>            :                 }</a>
<a name="2301"><span class="lineNum">    2301 </span><span class="lineNoCov">          0 :         } else if (Z_TYPE_P(member) == IS_STRING</span></a>
<a name="2302"><span class="lineNum">    2302 </span><span class="lineNoCov">          0 :                    &amp;&amp; is_numeric_string(Z_STRVAL_P(member), Z_STRLEN_P(member), &amp;lval, NULL, 0) == IS_LONG) {</span></a>
<a name="2303"><span class="lineNum">    2303 </span><span class="lineNoCov">          0 :                 if (lval &gt;= 0 &amp;&amp; lval &lt; stmt-&gt;column_count) {</span></a>
<a name="2304"><span class="lineNum">    2304 </span><span class="lineNoCov">          0 :                         fetch_value(stmt, rv, lval, NULL);</span></a>
<a name="2305"><span class="lineNum">    2305 </span>            :                 }</a>
<a name="2306"><span class="lineNum">    2306 </span>            :         } else {</a>
<a name="2307"><span class="lineNum">    2307 </span><span class="lineNoCov">          0 :                 if (!try_convert_to_string(member)) {</span></a>
<a name="2308"><span class="lineNum">    2308 </span><span class="lineNoCov">          0 :                         return &amp;EG(uninitialized_zval);</span></a>
<a name="2309"><span class="lineNum">    2309 </span>            :                 }</a>
<a name="2310"><span class="lineNum">    2310 </span>            : </a>
<a name="2311"><span class="lineNum">    2311 </span><span class="lineNoCov">          0 :                 if (zend_string_equals_literal(Z_STR_P(member), &quot;queryString&quot;)) {</span></a>
<a name="2312"><span class="lineNum">    2312 </span><span class="lineNoCov">          0 :                         return zend_std_read_property(&amp;stmt-&gt;std, Z_STR_P(member), type, NULL, rv);</span></a>
<a name="2313"><span class="lineNum">    2313 </span>            :                 }</a>
<a name="2314"><span class="lineNum">    2314 </span>            : </a>
<a name="2315"><span class="lineNum">    2315 </span>            :                 /* TODO: replace this with a hash of available column names to column</a>
<a name="2316"><span class="lineNum">    2316 </span>            :                  * numbers */</a>
<a name="2317"><span class="lineNum">    2317 </span><span class="lineNoCov">          0 :                 for (colno = 0; colno &lt; stmt-&gt;column_count; colno++) {</span></a>
<a name="2318"><span class="lineNum">    2318 </span><span class="lineNoCov">          0 :                         if (zend_string_equals(stmt-&gt;columns[colno].name, Z_STR_P(member))) {</span></a>
<a name="2319"><span class="lineNum">    2319 </span><span class="lineNoCov">          0 :                                 fetch_value(stmt, rv, colno, NULL);</span></a>
<a name="2320"><span class="lineNum">    2320 </span><span class="lineNoCov">          0 :                                 return rv;</span></a>
<a name="2321"><span class="lineNum">    2321 </span>            :                         }</a>
<a name="2322"><span class="lineNum">    2322 </span>            :                 }</a>
<a name="2323"><span class="lineNum">    2323 </span>            :         }</a>
<a name="2324"><span class="lineNum">    2324 </span>            : </a>
<a name="2325"><span class="lineNum">    2325 </span><span class="lineCov">          3 :         return rv;</span></a>
<a name="2326"><span class="lineNum">    2326 </span>            : }</a>
<a name="2327"><span class="lineNum">    2327 </span>            : </a>
<a name="2328"><span class="lineNum">    2328 </span><span class="lineCov">          3 : static zval *row_prop_write(zend_object *object, zend_string *name, zval *value, void **cache_slot)</span></a>
<a name="2329"><span class="lineNum">    2329 </span>            : {</a>
<a name="2330"><span class="lineNum">    2330 </span><span class="lineCov">          3 :         zend_throw_error(NULL, &quot;Cannot write to PDORow property&quot;);</span></a>
<a name="2331"><span class="lineNum">    2331 </span><span class="lineCov">          3 :         return value;</span></a>
<a name="2332"><span class="lineNum">    2332 </span>            : }</a>
<a name="2333"><span class="lineNum">    2333 </span>            : </a>
<a name="2334"><span class="lineNum">    2334 </span><span class="lineCov">          3 : static void row_dim_write(zend_object *object, zval *member, zval *value)</span></a>
<a name="2335"><span class="lineNum">    2335 </span>            : {</a>
<a name="2336"><span class="lineNum">    2336 </span><span class="lineCov">          3 :         zend_throw_error(NULL, &quot;Cannot write to PDORow offset&quot;);</span></a>
<a name="2337"><span class="lineNum">    2337 </span><span class="lineCov">          3 : }</span></a>
<a name="2338"><span class="lineNum">    2338 </span>            : </a>
<a name="2339"><span class="lineNum">    2339 </span><span class="lineCov">         24 : static int row_prop_exists(zend_object *object, zend_string *name, int check_empty, void **cache_slot)</span></a>
<a name="2340"><span class="lineNum">    2340 </span>            : {</a>
<a name="2341"><span class="lineNum">    2341 </span><span class="lineCov">         24 :         pdo_row_t *row = (pdo_row_t *)object;</span></a>
<a name="2342"><span class="lineNum">    2342 </span><span class="lineCov">         24 :         pdo_stmt_t *stmt = row-&gt;stmt;</span></a>
<a name="2343"><span class="lineNum">    2343 </span><span class="lineCov">         24 :         int colno = -1;</span></a>
<a name="2344"><span class="lineNum">    2344 </span>            :         zend_long lval;</a>
<a name="2345"><span class="lineNum">    2345 </span><span class="lineCov">         24 :         ZEND_ASSERT(stmt);</span></a>
<a name="2346"><span class="lineNum">    2346 </span>            : </a>
<a name="2347"><span class="lineNum">    2347 </span><span class="lineCov">         48 :         if (is_numeric_string(ZSTR_VAL(name), ZSTR_LEN(name), &amp;lval, NULL, 0) == IS_LONG)   {</span></a>
<a name="2348"><span class="lineNum">    2348 </span><span class="lineNoCov">          0 :                 return lval &gt;=0 &amp;&amp; lval &lt; stmt-&gt;column_count;</span></a>
<a name="2349"><span class="lineNum">    2349 </span>            :         }</a>
<a name="2350"><span class="lineNum">    2350 </span>            : </a>
<a name="2351"><span class="lineNum">    2351 </span>            :         /* TODO: replace this with a hash of available column names to column</a>
<a name="2352"><span class="lineNum">    2352 </span>            :          * numbers */</a>
<a name="2353"><span class="lineNum">    2353 </span><span class="lineCov">         60 :         for (colno = 0; colno &lt; stmt-&gt;column_count; colno++) {</span></a>
<a name="2354"><span class="lineNum">    2354 </span><span class="lineCov">        108 :                 if (zend_string_equals(stmt-&gt;columns[colno].name, name)) {</span></a>
<a name="2355"><span class="lineNum">    2355 </span>            :                         int res;</a>
<a name="2356"><span class="lineNum">    2356 </span>            :                         zval val;</a>
<a name="2357"><span class="lineNum">    2357 </span>            : </a>
<a name="2358"><span class="lineNum">    2358 </span><span class="lineCov">         18 :                         fetch_value(stmt, &amp;val, colno, NULL);</span></a>
<a name="2359"><span class="lineNum">    2359 </span><span class="lineCov">         36 :                         res = check_empty ? i_zend_is_true(&amp;val) : Z_TYPE(val) != IS_NULL;</span></a>
<a name="2360"><span class="lineNum">    2360 </span>            :                         zval_ptr_dtor_nogc(&amp;val);</a>
<a name="2361"><span class="lineNum">    2361 </span>            : </a>
<a name="2362"><span class="lineNum">    2362 </span><span class="lineCov">         18 :                         return res;</span></a>
<a name="2363"><span class="lineNum">    2363 </span>            :                 }</a>
<a name="2364"><span class="lineNum">    2364 </span>            :         }</a>
<a name="2365"><span class="lineNum">    2365 </span>            : </a>
<a name="2366"><span class="lineNum">    2366 </span><span class="lineCov">          6 :         return 0;</span></a>
<a name="2367"><span class="lineNum">    2367 </span>            : }</a>
<a name="2368"><span class="lineNum">    2368 </span>            : </a>
<a name="2369"><span class="lineNum">    2369 </span><span class="lineNoCov">          0 : static int row_dim_exists(zend_object *object, zval *member, int check_empty)</span></a>
<a name="2370"><span class="lineNum">    2370 </span>            : {</a>
<a name="2371"><span class="lineNum">    2371 </span><span class="lineNoCov">          0 :         pdo_row_t *row = (pdo_row_t *)object;</span></a>
<a name="2372"><span class="lineNum">    2372 </span><span class="lineNoCov">          0 :         pdo_stmt_t *stmt = row-&gt;stmt;</span></a>
<a name="2373"><span class="lineNum">    2373 </span><span class="lineNoCov">          0 :         int colno = -1;</span></a>
<a name="2374"><span class="lineNum">    2374 </span>            :         zend_long lval;</a>
<a name="2375"><span class="lineNum">    2375 </span><span class="lineNoCov">          0 :         ZEND_ASSERT(stmt);</span></a>
<a name="2376"><span class="lineNum">    2376 </span>            : </a>
<a name="2377"><span class="lineNum">    2377 </span><span class="lineNoCov">          0 :         if (Z_TYPE_P(member) == IS_LONG) {</span></a>
<a name="2378"><span class="lineNum">    2378 </span><span class="lineNoCov">          0 :                 return Z_LVAL_P(member) &gt;= 0 &amp;&amp; Z_LVAL_P(member) &lt; stmt-&gt;column_count;</span></a>
<a name="2379"><span class="lineNum">    2379 </span><span class="lineNoCov">          0 :         } else if (Z_TYPE_P(member) == IS_STRING) {</span></a>
<a name="2380"><span class="lineNum">    2380 </span><span class="lineNoCov">          0 :                 if (is_numeric_string(Z_STRVAL_P(member), Z_STRLEN_P(member), &amp;lval, NULL, 0) == IS_LONG)   {</span></a>
<a name="2381"><span class="lineNum">    2381 </span><span class="lineNoCov">          0 :                         return lval &gt;=0 &amp;&amp; lval &lt; stmt-&gt;column_count;</span></a>
<a name="2382"><span class="lineNum">    2382 </span>            :                 }</a>
<a name="2383"><span class="lineNum">    2383 </span>            :         } else {</a>
<a name="2384"><span class="lineNum">    2384 </span><span class="lineNoCov">          0 :                 if (!try_convert_to_string(member)) {</span></a>
<a name="2385"><span class="lineNum">    2385 </span><span class="lineNoCov">          0 :                         return 0;</span></a>
<a name="2386"><span class="lineNum">    2386 </span>            :                 }</a>
<a name="2387"><span class="lineNum">    2387 </span>            :         }</a>
<a name="2388"><span class="lineNum">    2388 </span>            : </a>
<a name="2389"><span class="lineNum">    2389 </span>            :         /* TODO: replace this with a hash of available column names to column</a>
<a name="2390"><span class="lineNum">    2390 </span>            :          * numbers */</a>
<a name="2391"><span class="lineNum">    2391 </span><span class="lineNoCov">          0 :         for (colno = 0; colno &lt; stmt-&gt;column_count; colno++) {</span></a>
<a name="2392"><span class="lineNum">    2392 </span><span class="lineNoCov">          0 :                 if (zend_string_equals(stmt-&gt;columns[colno].name, Z_STR_P(member))) {</span></a>
<a name="2393"><span class="lineNum">    2393 </span>            :                         int res;</a>
<a name="2394"><span class="lineNum">    2394 </span>            :                         zval val;</a>
<a name="2395"><span class="lineNum">    2395 </span>            : </a>
<a name="2396"><span class="lineNum">    2396 </span><span class="lineNoCov">          0 :                         fetch_value(stmt, &amp;val, colno, NULL);</span></a>
<a name="2397"><span class="lineNum">    2397 </span><span class="lineNoCov">          0 :                         res = check_empty ? i_zend_is_true(&amp;val) : Z_TYPE(val) != IS_NULL;</span></a>
<a name="2398"><span class="lineNum">    2398 </span>            :                         zval_ptr_dtor_nogc(&amp;val);</a>
<a name="2399"><span class="lineNum">    2399 </span>            : </a>
<a name="2400"><span class="lineNum">    2400 </span><span class="lineNoCov">          0 :                         return res;</span></a>
<a name="2401"><span class="lineNum">    2401 </span>            :                 }</a>
<a name="2402"><span class="lineNum">    2402 </span>            :         }</a>
<a name="2403"><span class="lineNum">    2403 </span>            : </a>
<a name="2404"><span class="lineNum">    2404 </span><span class="lineNoCov">          0 :         return 0;</span></a>
<a name="2405"><span class="lineNum">    2405 </span>            : }</a>
<a name="2406"><span class="lineNum">    2406 </span>            : </a>
<a name="2407"><span class="lineNum">    2407 </span><span class="lineCov">          3 : static void row_prop_delete(zend_object *object, zend_string *offset, void **cache_slot)</span></a>
<a name="2408"><span class="lineNum">    2408 </span>            : {</a>
<a name="2409"><span class="lineNum">    2409 </span><span class="lineCov">          3 :         zend_throw_error(NULL, &quot;Cannot unset PDORow property&quot;);</span></a>
<a name="2410"><span class="lineNum">    2410 </span><span class="lineCov">          3 : }</span></a>
<a name="2411"><span class="lineNum">    2411 </span>            : </a>
<a name="2412"><span class="lineNum">    2412 </span><span class="lineCov">          3 : static void row_dim_delete(zend_object *object, zval *offset)</span></a>
<a name="2413"><span class="lineNum">    2413 </span>            : {</a>
<a name="2414"><span class="lineNum">    2414 </span><span class="lineCov">          3 :         zend_throw_error(NULL, &quot;Cannot unset PDORow offset&quot;);</span></a>
<a name="2415"><span class="lineNum">    2415 </span><span class="lineCov">          3 : }</span></a>
<a name="2416"><span class="lineNum">    2416 </span>            : </a>
<a name="2417"><span class="lineNum">    2417 </span><span class="lineCov">          6 : static HashTable *row_get_properties_for(zend_object *object, zend_prop_purpose purpose)</span></a>
<a name="2418"><span class="lineNum">    2418 </span>            : {</a>
<a name="2419"><span class="lineNum">    2419 </span><span class="lineCov">          6 :         pdo_row_t *row = (pdo_row_t *)object;</span></a>
<a name="2420"><span class="lineNum">    2420 </span><span class="lineCov">          6 :         pdo_stmt_t *stmt = row-&gt;stmt;</span></a>
<a name="2421"><span class="lineNum">    2421 </span>            :         HashTable *props;</a>
<a name="2422"><span class="lineNum">    2422 </span>            :         int i;</a>
<a name="2423"><span class="lineNum">    2423 </span><span class="lineCov">          6 :         ZEND_ASSERT(stmt);</span></a>
<a name="2424"><span class="lineNum">    2424 </span>            : </a>
<a name="2425"><span class="lineNum">    2425 </span><span class="lineCov">          6 :         if (purpose != ZEND_PROP_PURPOSE_DEBUG) {</span></a>
<a name="2426"><span class="lineNum">    2426 </span><span class="lineNoCov">          0 :                 return zend_std_get_properties_for(object, purpose);</span></a>
<a name="2427"><span class="lineNum">    2427 </span>            :         }</a>
<a name="2428"><span class="lineNum">    2428 </span>            : </a>
<a name="2429"><span class="lineNum">    2429 </span><span class="lineCov">          6 :         if (!stmt-&gt;std.properties) {</span></a>
<a name="2430"><span class="lineNum">    2430 </span><span class="lineCov">          3 :                 rebuild_object_properties(&amp;stmt-&gt;std);</span></a>
<a name="2431"><span class="lineNum">    2431 </span>            :         }</a>
<a name="2432"><span class="lineNum">    2432 </span><span class="lineCov">          6 :         props = zend_array_dup(stmt-&gt;std.properties);</span></a>
<a name="2433"><span class="lineNum">    2433 </span><span class="lineCov">         12 :         for (i = 0; i &lt; stmt-&gt;column_count; i++) {</span></a>
<a name="2434"><span class="lineNum">    2434 </span><span class="lineCov">          6 :                 if (zend_string_equals_literal(stmt-&gt;columns[i].name, &quot;queryString&quot;)) {</span></a>
<a name="2435"><span class="lineNum">    2435 </span><span class="lineCov">          3 :                         continue;</span></a>
<a name="2436"><span class="lineNum">    2436 </span>            :                 }</a>
<a name="2437"><span class="lineNum">    2437 </span>            : </a>
<a name="2438"><span class="lineNum">    2438 </span>            :                 zval val;</a>
<a name="2439"><span class="lineNum">    2439 </span><span class="lineCov">          3 :                 fetch_value(stmt, &amp;val, i, NULL);</span></a>
<a name="2440"><span class="lineNum">    2440 </span>            : </a>
<a name="2441"><span class="lineNum">    2441 </span><span class="lineCov">          3 :                 zend_hash_update(props, stmt-&gt;columns[i].name, &amp;val);</span></a>
<a name="2442"><span class="lineNum">    2442 </span>            :         }</a>
<a name="2443"><span class="lineNum">    2443 </span><span class="lineCov">          6 :         return props;</span></a>
<a name="2444"><span class="lineNum">    2444 </span>            : }</a>
<a name="2445"><span class="lineNum">    2445 </span>            : </a>
<a name="2446"><span class="lineNum">    2446 </span><span class="lineCov">         15 : static zend_function *row_get_ctor(zend_object *object)</span></a>
<a name="2447"><span class="lineNum">    2447 </span>            : {</a>
<a name="2448"><span class="lineNum">    2448 </span><span class="lineCov">         15 :         zend_throw_exception_ex(php_pdo_get_exception(), 0, &quot;You may not create a PDORow manually&quot;);</span></a>
<a name="2449"><span class="lineNum">    2449 </span><span class="lineCov">         15 :         return NULL;</span></a>
<a name="2450"><span class="lineNum">    2450 </span>            : }</a>
<a name="2451"><span class="lineNum">    2451 </span>            : </a>
<a name="2452"><span class="lineNum">    2452 </span><span class="lineCov">         30 : void pdo_row_free_storage(zend_object *std)</span></a>
<a name="2453"><span class="lineNum">    2453 </span>            : {</a>
<a name="2454"><span class="lineNum">    2454 </span><span class="lineCov">         30 :         pdo_row_t *row = (pdo_row_t *)std;</span></a>
<a name="2455"><span class="lineNum">    2455 </span><span class="lineCov">         30 :         if (row-&gt;stmt) {</span></a>
<a name="2456"><span class="lineNum">    2456 </span><span class="lineCov">         15 :                 ZVAL_UNDEF(&amp;row-&gt;stmt-&gt;lazy_object_ref);</span></a>
<a name="2457"><span class="lineNum">    2457 </span><span class="lineCov">         15 :                 OBJ_RELEASE(&amp;row-&gt;stmt-&gt;std);</span></a>
<a name="2458"><span class="lineNum">    2458 </span>            :         }</a>
<a name="2459"><span class="lineNum">    2459 </span><span class="lineCov">         30 : }</span></a>
<a name="2460"><span class="lineNum">    2460 </span>            : </a>
<a name="2461"><span class="lineNum">    2461 </span><span class="lineCov">         15 : zend_object *pdo_row_new(zend_class_entry *ce)</span></a>
<a name="2462"><span class="lineNum">    2462 </span>            : {</a>
<a name="2463"><span class="lineNum">    2463 </span><span class="lineCov">         15 :         pdo_row_t *row = ecalloc(1, sizeof(pdo_row_t));</span></a>
<a name="2464"><span class="lineNum">    2464 </span><span class="lineCov">         15 :         zend_object_std_init(&amp;row-&gt;std, ce);</span></a>
<a name="2465"><span class="lineNum">    2465 </span><span class="lineCov">         15 :         row-&gt;std.handlers = &amp;pdo_row_object_handlers;</span></a>
<a name="2466"><span class="lineNum">    2466 </span>            : </a>
<a name="2467"><span class="lineNum">    2467 </span><span class="lineCov">         15 :         return &amp;row-&gt;std;</span></a>
<a name="2468"><span class="lineNum">    2468 </span>            : }</a>
<a name="2469"><span class="lineNum">    2469 </span>            : </a>
<a name="2470"><span class="lineNum">    2470 </span><span class="lineCov">      38769 : void pdo_stmt_init(void)</span></a>
<a name="2471"><span class="lineNum">    2471 </span>            : {</a>
<a name="2472"><span class="lineNum">    2472 </span><span class="lineCov">      38769 :         pdo_dbstmt_ce = register_class_PDOStatement(zend_ce_aggregate);</span></a>
<a name="2473"><span class="lineNum">    2473 </span><span class="lineCov">      38769 :         pdo_dbstmt_ce-&gt;get_iterator = pdo_stmt_iter_get;</span></a>
<a name="2474"><span class="lineNum">    2474 </span><span class="lineCov">      38769 :         pdo_dbstmt_ce-&gt;create_object = pdo_dbstmt_new;</span></a>
<a name="2475"><span class="lineNum">    2475 </span>            : </a>
<a name="2476"><span class="lineNum">    2476 </span><span class="lineCov">      38769 :         memcpy(&amp;pdo_dbstmt_object_handlers, &amp;std_object_handlers, sizeof(zend_object_handlers));</span></a>
<a name="2477"><span class="lineNum">    2477 </span><span class="lineCov">      38769 :         pdo_dbstmt_object_handlers.offset = XtOffsetOf(pdo_stmt_t, std);</span></a>
<a name="2478"><span class="lineNum">    2478 </span><span class="lineCov">      38769 :         pdo_dbstmt_object_handlers.free_obj = pdo_dbstmt_free_storage;</span></a>
<a name="2479"><span class="lineNum">    2479 </span><span class="lineCov">      38769 :         pdo_dbstmt_object_handlers.write_property = dbstmt_prop_write;</span></a>
<a name="2480"><span class="lineNum">    2480 </span><span class="lineCov">      38769 :         pdo_dbstmt_object_handlers.unset_property = dbstmt_prop_delete;</span></a>
<a name="2481"><span class="lineNum">    2481 </span><span class="lineCov">      38769 :         pdo_dbstmt_object_handlers.get_method = dbstmt_method_get;</span></a>
<a name="2482"><span class="lineNum">    2482 </span><span class="lineCov">      38769 :         pdo_dbstmt_object_handlers.compare = zend_objects_not_comparable;</span></a>
<a name="2483"><span class="lineNum">    2483 </span><span class="lineCov">      38769 :         pdo_dbstmt_object_handlers.clone_obj = NULL;</span></a>
<a name="2484"><span class="lineNum">    2484 </span>            : </a>
<a name="2485"><span class="lineNum">    2485 </span><span class="lineCov">      38769 :         pdo_row_ce = register_class_PDORow();</span></a>
<a name="2486"><span class="lineNum">    2486 </span><span class="lineCov">      38769 :         pdo_row_ce-&gt;create_object = pdo_row_new;</span></a>
<a name="2487"><span class="lineNum">    2487 </span>            : </a>
<a name="2488"><span class="lineNum">    2488 </span><span class="lineCov">      38769 :         memcpy(&amp;pdo_row_object_handlers, &amp;std_object_handlers, sizeof(zend_object_handlers));</span></a>
<a name="2489"><span class="lineNum">    2489 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.free_obj = pdo_row_free_storage;</span></a>
<a name="2490"><span class="lineNum">    2490 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.clone_obj = NULL;</span></a>
<a name="2491"><span class="lineNum">    2491 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.get_property_ptr_ptr = NULL;</span></a>
<a name="2492"><span class="lineNum">    2492 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.read_property = row_prop_read;</span></a>
<a name="2493"><span class="lineNum">    2493 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.write_property = row_prop_write;</span></a>
<a name="2494"><span class="lineNum">    2494 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.has_property = row_prop_exists;</span></a>
<a name="2495"><span class="lineNum">    2495 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.unset_property = row_prop_delete;</span></a>
<a name="2496"><span class="lineNum">    2496 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.read_dimension = row_dim_read;</span></a>
<a name="2497"><span class="lineNum">    2497 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.write_dimension = row_dim_write;</span></a>
<a name="2498"><span class="lineNum">    2498 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.has_dimension = row_dim_exists;</span></a>
<a name="2499"><span class="lineNum">    2499 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.unset_dimension = row_dim_delete;</span></a>
<a name="2500"><span class="lineNum">    2500 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.get_properties_for = row_get_properties_for;</span></a>
<a name="2501"><span class="lineNum">    2501 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.get_constructor = row_get_ctor;</span></a>
<a name="2502"><span class="lineNum">    2502 </span><span class="lineCov">      38769 :         pdo_row_object_handlers.compare = zend_objects_not_comparable;</span></a>
<a name="2503"><span class="lineNum">    2503 </span><span class="lineCov">      38769 : }</span></a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.14</a></td></tr>
  </table>
  <br>

</body>
</html>
