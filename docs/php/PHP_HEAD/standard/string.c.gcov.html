<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - tests.info - standard/string.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">standard</a> - string.c<span style="font-size: 80%;"> (source / <a href="string.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">tests.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2782</td>
            <td class="headerCovTableEntry">3018</td>
            <td class="headerCovTableEntryHi">92.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-11-29 14:13:02</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">117</td>
            <td class="headerCovTableEntry">124</td>
            <td class="headerCovTableEntryHi">94.4 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<a name="2"><span class="lineNum">       2 </span>            :    +----------------------------------------------------------------------+</a>
<a name="3"><span class="lineNum">       3 </span>            :    | Copyright (c) The PHP Group                                          |</a>
<a name="4"><span class="lineNum">       4 </span>            :    +----------------------------------------------------------------------+</a>
<a name="5"><span class="lineNum">       5 </span>            :    | This source file is subject to version 3.01 of the PHP license,      |</a>
<a name="6"><span class="lineNum">       6 </span>            :    | that is bundled with this package in the file LICENSE, and is        |</a>
<a name="7"><span class="lineNum">       7 </span>            :    | available through the world-wide-web at the following url:           |</a>
<a name="8"><span class="lineNum">       8 </span>            :    | https://www.php.net/license/3_01.txt                                 |</a>
<a name="9"><span class="lineNum">       9 </span>            :    | If you did not receive a copy of the PHP license and are unable to   |</a>
<a name="10"><span class="lineNum">      10 </span>            :    | obtain it through the world-wide-web, please send a note to          |</a>
<a name="11"><span class="lineNum">      11 </span>            :    | license@php.net so we can mail you a copy immediately.               |</a>
<a name="12"><span class="lineNum">      12 </span>            :    +----------------------------------------------------------------------+</a>
<a name="13"><span class="lineNum">      13 </span>            :    | Authors: Rasmus Lerdorf &lt;rasmus@php.net&gt;                             |</a>
<a name="14"><span class="lineNum">      14 </span>            :    |          Stig SÃ¦ther Bakken &lt;ssb@php.net&gt;                          |</a>
<a name="15"><span class="lineNum">      15 </span>            :    |          Zeev Suraski &lt;zeev@php.net&gt;                                 |</a>
<a name="16"><span class="lineNum">      16 </span>            :    +----------------------------------------------------------------------+</a>
<a name="17"><span class="lineNum">      17 </span>            :  */</a>
<a name="18"><span class="lineNum">      18 </span>            : </a>
<a name="19"><span class="lineNum">      19 </span>            : #include &lt;stdio.h&gt;</a>
<a name="20"><span class="lineNum">      20 </span>            : #include &quot;php.h&quot;</a>
<a name="21"><span class="lineNum">      21 </span>            : #include &quot;php_rand.h&quot;</a>
<a name="22"><span class="lineNum">      22 </span>            : #include &quot;php_string.h&quot;</a>
<a name="23"><span class="lineNum">      23 </span>            : #include &quot;php_variables.h&quot;</a>
<a name="24"><span class="lineNum">      24 </span>            : #include &lt;locale.h&gt;</a>
<a name="25"><span class="lineNum">      25 </span>            : #ifdef HAVE_LANGINFO_H</a>
<a name="26"><span class="lineNum">      26 </span>            : # include &lt;langinfo.h&gt;</a>
<a name="27"><span class="lineNum">      27 </span>            : #endif</a>
<a name="28"><span class="lineNum">      28 </span>            : </a>
<a name="29"><span class="lineNum">      29 </span>            : #ifdef HAVE_LIBINTL</a>
<a name="30"><span class="lineNum">      30 </span>            : # include &lt;libintl.h&gt; /* For LC_MESSAGES */</a>
<a name="31"><span class="lineNum">      31 </span>            : #endif</a>
<a name="32"><span class="lineNum">      32 </span>            : </a>
<a name="33"><span class="lineNum">      33 </span>            : #include &quot;scanf.h&quot;</a>
<a name="34"><span class="lineNum">      34 </span>            : #include &quot;zend_API.h&quot;</a>
<a name="35"><span class="lineNum">      35 </span>            : #include &quot;zend_execute.h&quot;</a>
<a name="36"><span class="lineNum">      36 </span>            : #include &quot;php_globals.h&quot;</a>
<a name="37"><span class="lineNum">      37 </span>            : #include &quot;basic_functions.h&quot;</a>
<a name="38"><span class="lineNum">      38 </span>            : #include &quot;zend_smart_str.h&quot;</a>
<a name="39"><span class="lineNum">      39 </span>            : #include &lt;Zend/zend_exceptions.h&gt;</a>
<a name="40"><span class="lineNum">      40 </span>            : #ifdef ZTS</a>
<a name="41"><span class="lineNum">      41 </span>            : #include &quot;TSRM.h&quot;</a>
<a name="42"><span class="lineNum">      42 </span>            : #endif</a>
<a name="43"><span class="lineNum">      43 </span>            : </a>
<a name="44"><span class="lineNum">      44 </span>            : /* For str_getcsv() support */</a>
<a name="45"><span class="lineNum">      45 </span>            : #include &quot;ext/standard/file.h&quot;</a>
<a name="46"><span class="lineNum">      46 </span>            : /* For php_next_utf8_char() */</a>
<a name="47"><span class="lineNum">      47 </span>            : #include &quot;ext/standard/html.h&quot;</a>
<a name="48"><span class="lineNum">      48 </span>            : </a>
<a name="49"><span class="lineNum">      49 </span>            : #ifdef __SSE2__</a>
<a name="50"><span class="lineNum">      50 </span>            : #include &lt;emmintrin.h&gt;</a>
<a name="51"><span class="lineNum">      51 </span>            : #endif</a>
<a name="52"><span class="lineNum">      52 </span>            : </a>
<a name="53"><span class="lineNum">      53 </span>            : #define STR_PAD_LEFT                    0</a>
<a name="54"><span class="lineNum">      54 </span>            : #define STR_PAD_RIGHT                   1</a>
<a name="55"><span class="lineNum">      55 </span>            : #define STR_PAD_BOTH                    2</a>
<a name="56"><span class="lineNum">      56 </span>            : #define PHP_PATHINFO_DIRNAME    1</a>
<a name="57"><span class="lineNum">      57 </span>            : #define PHP_PATHINFO_BASENAME   2</a>
<a name="58"><span class="lineNum">      58 </span>            : #define PHP_PATHINFO_EXTENSION  4</a>
<a name="59"><span class="lineNum">      59 </span>            : #define PHP_PATHINFO_FILENAME   8</a>
<a name="60"><span class="lineNum">      60 </span>            : #define PHP_PATHINFO_ALL        (PHP_PATHINFO_DIRNAME | PHP_PATHINFO_BASENAME | PHP_PATHINFO_EXTENSION | PHP_PATHINFO_FILENAME)</a>
<a name="61"><span class="lineNum">      61 </span>            : </a>
<a name="62"><span class="lineNum">      62 </span>            : #define STR_STRSPN                              0</a>
<a name="63"><span class="lineNum">      63 </span>            : #define STR_STRCSPN                             1</a>
<a name="64"><span class="lineNum">      64 </span>            : </a>
<a name="65"><span class="lineNum">      65 </span>            : /* {{{ register_string_constants */</a>
<a name="66"><span class="lineNum">      66 </span><span class="lineCov">      38769 : void register_string_constants(INIT_FUNC_ARGS)</span></a>
<a name="67"><span class="lineNum">      67 </span>            : {</a>
<a name="68"><span class="lineNum">      68 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;STR_PAD_LEFT&quot;, STR_PAD_LEFT, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="69"><span class="lineNum">      69 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;STR_PAD_RIGHT&quot;, STR_PAD_RIGHT, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="70"><span class="lineNum">      70 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;STR_PAD_BOTH&quot;, STR_PAD_BOTH, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="71"><span class="lineNum">      71 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;PATHINFO_DIRNAME&quot;, PHP_PATHINFO_DIRNAME, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="72"><span class="lineNum">      72 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;PATHINFO_BASENAME&quot;, PHP_PATHINFO_BASENAME, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="73"><span class="lineNum">      73 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;PATHINFO_EXTENSION&quot;, PHP_PATHINFO_EXTENSION, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="74"><span class="lineNum">      74 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;PATHINFO_FILENAME&quot;, PHP_PATHINFO_FILENAME, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="75"><span class="lineNum">      75 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;PATHINFO_ALL&quot;, PHP_PATHINFO_ALL, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="76"><span class="lineNum">      76 </span>            : </a>
<a name="77"><span class="lineNum">      77 </span>            :         /* If last members of struct lconv equal CHAR_MAX, no grouping is done */</a>
<a name="78"><span class="lineNum">      78 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;CHAR_MAX&quot;, CHAR_MAX, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="79"><span class="lineNum">      79 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;LC_CTYPE&quot;, LC_CTYPE, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="80"><span class="lineNum">      80 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;LC_NUMERIC&quot;, LC_NUMERIC, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="81"><span class="lineNum">      81 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;LC_TIME&quot;, LC_TIME, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="82"><span class="lineNum">      82 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;LC_COLLATE&quot;, LC_COLLATE, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="83"><span class="lineNum">      83 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;LC_MONETARY&quot;, LC_MONETARY, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="84"><span class="lineNum">      84 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;LC_ALL&quot;, LC_ALL, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="85"><span class="lineNum">      85 </span>            : # ifdef LC_MESSAGES</a>
<a name="86"><span class="lineNum">      86 </span><span class="lineCov">      38769 :         REGISTER_LONG_CONSTANT(&quot;LC_MESSAGES&quot;, LC_MESSAGES, CONST_CS | CONST_PERSISTENT);</span></a>
<a name="87"><span class="lineNum">      87 </span>            : # endif</a>
<a name="88"><span class="lineNum">      88 </span>            : </a>
<a name="89"><span class="lineNum">      89 </span><span class="lineCov">      38769 : }</span></a>
<a name="90"><span class="lineNum">      90 </span>            : /* }}} */</a>
<a name="91"><span class="lineNum">      91 </span>            : </a>
<a name="92"><span class="lineNum">      92 </span>            : int php_tag_find(char *tag, size_t len, const char *set);</a>
<a name="93"><span class="lineNum">      93 </span>            : </a>
<a name="94"><span class="lineNum">      94 </span>            : /* this is read-only, so it's ok */</a>
<a name="95"><span class="lineNum">      95 </span>            : ZEND_SET_ALIGNED(16, static const char hexconvtab[]) = &quot;0123456789abcdef&quot;;</a>
<a name="96"><span class="lineNum">      96 </span>            : </a>
<a name="97"><span class="lineNum">      97 </span>            : /* localeconv mutex */</a>
<a name="98"><span class="lineNum">      98 </span>            : #ifdef ZTS</a>
<a name="99"><span class="lineNum">      99 </span>            : static MUTEX_T locale_mutex = NULL;</a>
<a name="100"><span class="lineNum">     100 </span>            : #endif</a>
<a name="101"><span class="lineNum">     101 </span>            : </a>
<a name="102"><span class="lineNum">     102 </span>            : /* {{{ php_bin2hex */</a>
<a name="103"><span class="lineNum">     103 </span><span class="lineCov">      26942 : static zend_string *php_bin2hex(const unsigned char *old, const size_t oldlen)</span></a>
<a name="104"><span class="lineNum">     104 </span>            : {</a>
<a name="105"><span class="lineNum">     105 </span>            :         zend_string *result;</a>
<a name="106"><span class="lineNum">     106 </span>            :         size_t i, j;</a>
<a name="107"><span class="lineNum">     107 </span>            : </a>
<a name="108"><span class="lineNum">     108 </span><span class="lineCov">      26942 :         result = zend_string_safe_alloc(oldlen, 2 * sizeof(char), 0, 0);</span></a>
<a name="109"><span class="lineNum">     109 </span>            : </a>
<a name="110"><span class="lineNum">     110 </span><span class="lineCov">     105866 :         for (i = j = 0; i &lt; oldlen; i++) {</span></a>
<a name="111"><span class="lineNum">     111 </span><span class="lineCov">      78924 :                 ZSTR_VAL(result)[j++] = hexconvtab[old[i] &gt;&gt; 4];</span></a>
<a name="112"><span class="lineNum">     112 </span><span class="lineCov">      78924 :                 ZSTR_VAL(result)[j++] = hexconvtab[old[i] &amp; 15];</span></a>
<a name="113"><span class="lineNum">     113 </span>            :         }</a>
<a name="114"><span class="lineNum">     114 </span><span class="lineCov">      26942 :         ZSTR_VAL(result)[j] = '\0';</span></a>
<a name="115"><span class="lineNum">     115 </span>            : </a>
<a name="116"><span class="lineNum">     116 </span><span class="lineCov">      26942 :         return result;</span></a>
<a name="117"><span class="lineNum">     117 </span>            : }</a>
<a name="118"><span class="lineNum">     118 </span>            : /* }}} */</a>
<a name="119"><span class="lineNum">     119 </span>            : </a>
<a name="120"><span class="lineNum">     120 </span>            : /* {{{ php_hex2bin */</a>
<a name="121"><span class="lineNum">     121 </span><span class="lineCov">        120 : static zend_string *php_hex2bin(const unsigned char *old, const size_t oldlen)</span></a>
<a name="122"><span class="lineNum">     122 </span>            : {</a>
<a name="123"><span class="lineNum">     123 </span><span class="lineCov">        120 :         size_t target_length = oldlen &gt;&gt; 1;</span></a>
<a name="124"><span class="lineNum">     124 </span><span class="lineCov">        120 :         zend_string *str = zend_string_alloc(target_length, 0);</span></a>
<a name="125"><span class="lineNum">     125 </span><span class="lineCov">        120 :         unsigned char *ret = (unsigned char *)ZSTR_VAL(str);</span></a>
<a name="126"><span class="lineNum">     126 </span>            :         size_t i, j;</a>
<a name="127"><span class="lineNum">     127 </span>            : </a>
<a name="128"><span class="lineNum">     128 </span><span class="lineCov">        831 :         for (i = j = 0; i &lt; target_length; i++) {</span></a>
<a name="129"><span class="lineNum">     129 </span><span class="lineCov">        717 :                 unsigned char c = old[j++];</span></a>
<a name="130"><span class="lineNum">     130 </span><span class="lineCov">        717 :                 unsigned char l = c &amp; ~0x20;</span></a>
<a name="131"><span class="lineNum">     131 </span><span class="lineCov">        717 :                 int is_letter = ((unsigned int) ((l - 'A') ^ (l - 'F' - 1))) &gt;&gt; (8 * sizeof(unsigned int) - 1);</span></a>
<a name="132"><span class="lineNum">     132 </span>            :                 unsigned char d;</a>
<a name="133"><span class="lineNum">     133 </span>            : </a>
<a name="134"><span class="lineNum">     134 </span>            :                 /* basically (c &gt;= '0' &amp;&amp; c &lt;= '9') || (l &gt;= 'A' &amp;&amp; l &lt;= 'F') */</a>
<a name="135"><span class="lineNum">     135 </span><span class="lineCov">        717 :                 if (EXPECTED((((c ^ '0') - 10) &gt;&gt; (8 * sizeof(unsigned int) - 1)) | is_letter)) {</span></a>
<a name="136"><span class="lineNum">     136 </span><span class="lineCov">        714 :                         d = (l - 0x10 - 0x27 * is_letter) &lt;&lt; 4;</span></a>
<a name="137"><span class="lineNum">     137 </span>            :                 } else {</a>
<a name="138"><span class="lineNum">     138 </span>            :                         zend_string_efree(str);</a>
<a name="139"><span class="lineNum">     139 </span><span class="lineCov">          3 :                         return NULL;</span></a>
<a name="140"><span class="lineNum">     140 </span>            :                 }</a>
<a name="141"><span class="lineNum">     141 </span><span class="lineCov">        714 :                 c = old[j++];</span></a>
<a name="142"><span class="lineNum">     142 </span><span class="lineCov">        714 :                 l = c &amp; ~0x20;</span></a>
<a name="143"><span class="lineNum">     143 </span><span class="lineCov">        714 :                 is_letter = ((unsigned int) ((l - 'A') ^ (l - 'F' - 1))) &gt;&gt; (8 * sizeof(unsigned int) - 1);</span></a>
<a name="144"><span class="lineNum">     144 </span><span class="lineCov">        714 :                 if (EXPECTED((((c ^ '0') - 10) &gt;&gt; (8 * sizeof(unsigned int) - 1)) | is_letter)) {</span></a>
<a name="145"><span class="lineNum">     145 </span><span class="lineCov">        711 :                         d |= l - 0x10 - 0x27 * is_letter;</span></a>
<a name="146"><span class="lineNum">     146 </span>            :                 } else {</a>
<a name="147"><span class="lineNum">     147 </span>            :                         zend_string_efree(str);</a>
<a name="148"><span class="lineNum">     148 </span><span class="lineCov">          3 :                         return NULL;</span></a>
<a name="149"><span class="lineNum">     149 </span>            :                 }</a>
<a name="150"><span class="lineNum">     150 </span><span class="lineCov">        711 :                 ret[i] = d;</span></a>
<a name="151"><span class="lineNum">     151 </span>            :         }</a>
<a name="152"><span class="lineNum">     152 </span><span class="lineCov">        114 :         ret[i] = '\0';</span></a>
<a name="153"><span class="lineNum">     153 </span>            : </a>
<a name="154"><span class="lineNum">     154 </span><span class="lineCov">        114 :         return str;</span></a>
<a name="155"><span class="lineNum">     155 </span>            : }</a>
<a name="156"><span class="lineNum">     156 </span>            : /* }}} */</a>
<a name="157"><span class="lineNum">     157 </span>            : </a>
<a name="158"><span class="lineNum">     158 </span>            : /* {{{ localeconv_r</a>
<a name="159"><span class="lineNum">     159 </span>            :  * glibc's localeconv is not reentrant, so lets make it so ... sorta */</a>
<a name="160"><span class="lineNum">     160 </span><span class="lineCov">         24 : PHPAPI struct lconv *localeconv_r(struct lconv *out)</span></a>
<a name="161"><span class="lineNum">     161 </span>            : {</a>
<a name="162"><span class="lineNum">     162 </span>            : </a>
<a name="163"><span class="lineNum">     163 </span>            : #ifdef ZTS</a>
<a name="164"><span class="lineNum">     164 </span>            :         tsrm_mutex_lock( locale_mutex );</a>
<a name="165"><span class="lineNum">     165 </span>            : #endif</a>
<a name="166"><span class="lineNum">     166 </span>            : </a>
<a name="167"><span class="lineNum">     167 </span>            : /*  cur-&gt;locinfo is struct __crt_locale_info which implementation is</a>
<a name="168"><span class="lineNum">     168 </span>            :         hidden in vc14. TODO revisit this and check if a workaround available</a>
<a name="169"><span class="lineNum">     169 </span>            :         and needed. */</a>
<a name="170"><span class="lineNum">     170 </span>            : #if defined(PHP_WIN32) &amp;&amp; _MSC_VER &lt; 1900 &amp;&amp; defined(ZTS)</a>
<a name="171"><span class="lineNum">     171 </span>            :         {</a>
<a name="172"><span class="lineNum">     172 </span>            :                 /* Even with the enabled per thread locale, localeconv</a>
<a name="173"><span class="lineNum">     173 </span>            :                         won't check any locale change in the master thread. */</a>
<a name="174"><span class="lineNum">     174 </span>            :                 _locale_t cur = _get_current_locale();</a>
<a name="175"><span class="lineNum">     175 </span>            :                 *out = *cur-&gt;locinfo-&gt;lconv;</a>
<a name="176"><span class="lineNum">     176 </span>            :                 _free_locale(cur);</a>
<a name="177"><span class="lineNum">     177 </span>            :         }</a>
<a name="178"><span class="lineNum">     178 </span>            : #else</a>
<a name="179"><span class="lineNum">     179 </span>            :         /* localeconv doesn't return an error condition */</a>
<a name="180"><span class="lineNum">     180 </span><span class="lineCov">         24 :         *out = *localeconv();</span></a>
<a name="181"><span class="lineNum">     181 </span>            : #endif</a>
<a name="182"><span class="lineNum">     182 </span>            : </a>
<a name="183"><span class="lineNum">     183 </span>            : #ifdef ZTS</a>
<a name="184"><span class="lineNum">     184 </span>            :         tsrm_mutex_unlock( locale_mutex );</a>
<a name="185"><span class="lineNum">     185 </span>            : #endif</a>
<a name="186"><span class="lineNum">     186 </span>            : </a>
<a name="187"><span class="lineNum">     187 </span><span class="lineCov">         24 :         return out;</span></a>
<a name="188"><span class="lineNum">     188 </span>            : }</a>
<a name="189"><span class="lineNum">     189 </span>            : /* }}} */</a>
<a name="190"><span class="lineNum">     190 </span>            : </a>
<a name="191"><span class="lineNum">     191 </span>            : #ifdef ZTS</a>
<a name="192"><span class="lineNum">     192 </span>            : /* {{{ PHP_MINIT_FUNCTION */</a>
<a name="193"><span class="lineNum">     193 </span>            : PHP_MINIT_FUNCTION(localeconv)</a>
<a name="194"><span class="lineNum">     194 </span>            : {</a>
<a name="195"><span class="lineNum">     195 </span>            :         locale_mutex = tsrm_mutex_alloc();</a>
<a name="196"><span class="lineNum">     196 </span>            :         return SUCCESS;</a>
<a name="197"><span class="lineNum">     197 </span>            : }</a>
<a name="198"><span class="lineNum">     198 </span>            : /* }}} */</a>
<a name="199"><span class="lineNum">     199 </span>            : </a>
<a name="200"><span class="lineNum">     200 </span>            : /* {{{ PHP_MSHUTDOWN_FUNCTION */</a>
<a name="201"><span class="lineNum">     201 </span>            : PHP_MSHUTDOWN_FUNCTION(localeconv)</a>
<a name="202"><span class="lineNum">     202 </span>            : {</a>
<a name="203"><span class="lineNum">     203 </span>            :         tsrm_mutex_free( locale_mutex );</a>
<a name="204"><span class="lineNum">     204 </span>            :         locale_mutex = NULL;</a>
<a name="205"><span class="lineNum">     205 </span>            :         return SUCCESS;</a>
<a name="206"><span class="lineNum">     206 </span>            : }</a>
<a name="207"><span class="lineNum">     207 </span>            : /* }}} */</a>
<a name="208"><span class="lineNum">     208 </span>            : #endif</a>
<a name="209"><span class="lineNum">     209 </span>            : </a>
<a name="210"><span class="lineNum">     210 </span>            : /* {{{ Converts the binary representation of data to hex */</a>
<a name="211"><span class="lineNum">     211 </span><span class="lineCov">      26993 : PHP_FUNCTION(bin2hex)</span></a>
<a name="212"><span class="lineNum">     212 </span>            : {</a>
<a name="213"><span class="lineNum">     213 </span>            :         zend_string *result;</a>
<a name="214"><span class="lineNum">     214 </span>            :         zend_string *data;</a>
<a name="215"><span class="lineNum">     215 </span>            : </a>
<a name="216"><span class="lineNum">     216 </span><span class="lineCov">      26993 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="217"><span class="lineNum">     217 </span><span class="lineCov">      53890 :                 Z_PARAM_STR(data)</span></a>
<a name="218"><span class="lineNum">     218 </span><span class="lineCov">      26993 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="219"><span class="lineNum">     219 </span>            : </a>
<a name="220"><span class="lineNum">     220 </span><span class="lineCov">      26942 :         result = php_bin2hex((unsigned char *)ZSTR_VAL(data), ZSTR_LEN(data));</span></a>
<a name="221"><span class="lineNum">     221 </span>            : </a>
<a name="222"><span class="lineNum">     222 </span><span class="lineCov">      53884 :         RETURN_STR(result);</span></a>
<a name="223"><span class="lineNum">     223 </span>            : }</a>
<a name="224"><span class="lineNum">     224 </span>            : /* }}} */</a>
<a name="225"><span class="lineNum">     225 </span>            : </a>
<a name="226"><span class="lineNum">     226 </span>            : /* {{{ Converts the hex representation of data to binary */</a>
<a name="227"><span class="lineNum">     227 </span><span class="lineCov">        174 : PHP_FUNCTION(hex2bin)</span></a>
<a name="228"><span class="lineNum">     228 </span>            : {</a>
<a name="229"><span class="lineNum">     229 </span>            :         zend_string *result, *data;</a>
<a name="230"><span class="lineNum">     230 </span>            : </a>
<a name="231"><span class="lineNum">     231 </span><span class="lineCov">        174 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="232"><span class="lineNum">     232 </span><span class="lineCov">        252 :                 Z_PARAM_STR(data)</span></a>
<a name="233"><span class="lineNum">     233 </span><span class="lineCov">        183 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="234"><span class="lineNum">     234 </span>            : </a>
<a name="235"><span class="lineNum">     235 </span><span class="lineCov">        123 :         if (ZSTR_LEN(data) % 2 != 0) {</span></a>
<a name="236"><span class="lineNum">     236 </span><span class="lineCov">          3 :                 php_error_docref(NULL, E_WARNING, &quot;Hexadecimal input string must have an even length&quot;);</span></a>
<a name="237"><span class="lineNum">     237 </span><span class="lineCov">          3 :                 RETURN_FALSE;</span></a>
<a name="238"><span class="lineNum">     238 </span>            :         }</a>
<a name="239"><span class="lineNum">     239 </span>            : </a>
<a name="240"><span class="lineNum">     240 </span><span class="lineCov">        120 :         result = php_hex2bin((unsigned char *)ZSTR_VAL(data), ZSTR_LEN(data));</span></a>
<a name="241"><span class="lineNum">     241 </span>            : </a>
<a name="242"><span class="lineNum">     242 </span><span class="lineCov">        120 :         if (!result) {</span></a>
<a name="243"><span class="lineNum">     243 </span><span class="lineCov">          6 :                 php_error_docref(NULL, E_WARNING, &quot;Input string must be hexadecimal string&quot;);</span></a>
<a name="244"><span class="lineNum">     244 </span><span class="lineCov">          6 :                 RETURN_FALSE;</span></a>
<a name="245"><span class="lineNum">     245 </span>            :         }</a>
<a name="246"><span class="lineNum">     246 </span>            : </a>
<a name="247"><span class="lineNum">     247 </span><span class="lineCov">        228 :         RETVAL_STR(result);</span></a>
<a name="248"><span class="lineNum">     248 </span>            : }</a>
<a name="249"><span class="lineNum">     249 </span>            : /* }}} */</a>
<a name="250"><span class="lineNum">     250 </span>            : </a>
<a name="251"><span class="lineNum">     251 </span><span class="lineCov">      24333 : static void php_spn_common_handler(INTERNAL_FUNCTION_PARAMETERS, int behavior) /* {{{ */</span></a>
<a name="252"><span class="lineNum">     252 </span>            : {</a>
<a name="253"><span class="lineNum">     253 </span>            :         zend_string *s11, *s22;</a>
<a name="254"><span class="lineNum">     254 </span><span class="lineCov">      24333 :         zend_long start = 0, len = 0;</span></a>
<a name="255"><span class="lineNum">     255 </span><span class="lineCov">      24333 :         bool len_is_null = 1;</span></a>
<a name="256"><span class="lineNum">     256 </span>            : </a>
<a name="257"><span class="lineNum">     257 </span><span class="lineCov">      24333 :         ZEND_PARSE_PARAMETERS_START(2, 4)</span></a>
<a name="258"><span class="lineNum">     258 </span><span class="lineCov">      48522 :                 Z_PARAM_STR(s11)</span></a>
<a name="259"><span class="lineNum">     259 </span><span class="lineCov">      48486 :                 Z_PARAM_STR(s22)</span></a>
<a name="260"><span class="lineNum">     260 </span><span class="lineCov">      24243 :                 Z_PARAM_OPTIONAL</span></a>
<a name="261"><span class="lineNum">     261 </span><span class="lineCov">      46872 :                 Z_PARAM_LONG(start)</span></a>
<a name="262"><span class="lineNum">     262 </span><span class="lineCov">      38100 :                 Z_PARAM_LONG_OR_NULL(len, len_is_null)</span></a>
<a name="263"><span class="lineNum">     263 </span><span class="lineCov">      24333 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="264"><span class="lineNum">     264 </span>            : </a>
<a name="265"><span class="lineNum">     265 </span><span class="lineCov">      24243 :         size_t remain_len = ZSTR_LEN(s11);</span></a>
<a name="266"><span class="lineNum">     266 </span><span class="lineCov">      24243 :         if (start &lt; 0) {</span></a>
<a name="267"><span class="lineNum">     267 </span><span class="lineCov">       8208 :                 start += remain_len;</span></a>
<a name="268"><span class="lineNum">     268 </span><span class="lineCov">       8208 :                 if (start &lt; 0) {</span></a>
<a name="269"><span class="lineNum">     269 </span><span class="lineCov">       4362 :                         start = 0;</span></a>
<a name="270"><span class="lineNum">     270 </span>            :                 }</a>
<a name="271"><span class="lineNum">     271 </span><span class="lineCov">      16035 :         } else if ((size_t) start &gt; remain_len) {</span></a>
<a name="272"><span class="lineNum">     272 </span><span class="lineCov">       5070 :                 start = remain_len;</span></a>
<a name="273"><span class="lineNum">     273 </span>            :         }</a>
<a name="274"><span class="lineNum">     274 </span>            : </a>
<a name="275"><span class="lineNum">     275 </span><span class="lineCov">      24243 :         remain_len -= start;</span></a>
<a name="276"><span class="lineNum">     276 </span><span class="lineCov">      24243 :         if (!len_is_null) {</span></a>
<a name="277"><span class="lineNum">     277 </span><span class="lineCov">      15465 :                 if (len &lt; 0) {</span></a>
<a name="278"><span class="lineNum">     278 </span><span class="lineCov">       5148 :                         len += remain_len;</span></a>
<a name="279"><span class="lineNum">     279 </span><span class="lineCov">       5148 :                         if (len &lt; 0) {</span></a>
<a name="280"><span class="lineNum">     280 </span><span class="lineCov">       3549 :                                 len = 0;</span></a>
<a name="281"><span class="lineNum">     281 </span>            :                         }</a>
<a name="282"><span class="lineNum">     282 </span><span class="lineCov">      10317 :                 } else if ((size_t) len &gt; remain_len) {</span></a>
<a name="283"><span class="lineNum">     283 </span><span class="lineCov">       5040 :                         len = remain_len;</span></a>
<a name="284"><span class="lineNum">     284 </span>            :                 }</a>
<a name="285"><span class="lineNum">     285 </span>            :         } else {</a>
<a name="286"><span class="lineNum">     286 </span><span class="lineCov">       8778 :                 len = remain_len;</span></a>
<a name="287"><span class="lineNum">     287 </span>            :         }</a>
<a name="288"><span class="lineNum">     288 </span>            : </a>
<a name="289"><span class="lineNum">     289 </span><span class="lineCov">      24243 :         if (len == 0) {</span></a>
<a name="290"><span class="lineNum">     290 </span><span class="lineCov">      11760 :                 RETURN_LONG(0);</span></a>
<a name="291"><span class="lineNum">     291 </span>            :         }</a>
<a name="292"><span class="lineNum">     292 </span>            : </a>
<a name="293"><span class="lineNum">     293 </span><span class="lineCov">      12483 :         if (behavior == STR_STRSPN) {</span></a>
<a name="294"><span class="lineNum">     294 </span><span class="lineCov">       6462 :                 RETURN_LONG(php_strspn(ZSTR_VAL(s11) + start /*str1_start*/,</span></a>
<a name="295"><span class="lineNum">     295 </span>            :                                                 ZSTR_VAL(s22) /*str2_start*/,</a>
<a name="296"><span class="lineNum">     296 </span>            :                                                 ZSTR_VAL(s11) + start + len /*str1_end*/,</a>
<a name="297"><span class="lineNum">     297 </span>            :                                                 ZSTR_VAL(s22) + ZSTR_LEN(s22) /*str2_end*/));</a>
<a name="298"><span class="lineNum">     298 </span>            :         } else {</a>
<a name="299"><span class="lineNum">     299 </span><span class="lineCov">       6021 :                 ZEND_ASSERT(behavior == STR_STRCSPN);</span></a>
<a name="300"><span class="lineNum">     300 </span><span class="lineCov">       6021 :                 RETURN_LONG(php_strcspn(ZSTR_VAL(s11) + start /*str1_start*/,</span></a>
<a name="301"><span class="lineNum">     301 </span>            :                                                 ZSTR_VAL(s22) /*str2_start*/,</a>
<a name="302"><span class="lineNum">     302 </span>            :                                                 ZSTR_VAL(s11) + start + len /*str1_end*/,</a>
<a name="303"><span class="lineNum">     303 </span>            :                                                 ZSTR_VAL(s22) + ZSTR_LEN(s22) /*str2_end*/));</a>
<a name="304"><span class="lineNum">     304 </span>            :         }</a>
<a name="305"><span class="lineNum">     305 </span>            : }</a>
<a name="306"><span class="lineNum">     306 </span>            : /* }}} */</a>
<a name="307"><span class="lineNum">     307 </span>            : </a>
<a name="308"><span class="lineNum">     308 </span>            : /* {{{ Finds length of initial segment consisting entirely of characters found in mask. If start or/and length is provided works like strspn(substr($s,$start,$len),$good_chars) */</a>
<a name="309"><span class="lineNum">     309 </span><span class="lineCov">      12753 : PHP_FUNCTION(strspn)</span></a>
<a name="310"><span class="lineNum">     310 </span>            : {</a>
<a name="311"><span class="lineNum">     311 </span><span class="lineCov">      12753 :         php_spn_common_handler(INTERNAL_FUNCTION_PARAM_PASSTHRU, STR_STRSPN);</span></a>
<a name="312"><span class="lineNum">     312 </span><span class="lineCov">      12753 : }</span></a>
<a name="313"><span class="lineNum">     313 </span>            : /* }}} */</a>
<a name="314"><span class="lineNum">     314 </span>            : </a>
<a name="315"><span class="lineNum">     315 </span>            : /* {{{ Finds length of initial segment consisting entirely of characters not found in mask. If start or/and length is provide works like strcspn(substr($s,$start,$len),$bad_chars) */</a>
<a name="316"><span class="lineNum">     316 </span><span class="lineCov">      11580 : PHP_FUNCTION(strcspn)</span></a>
<a name="317"><span class="lineNum">     317 </span>            : {</a>
<a name="318"><span class="lineNum">     318 </span><span class="lineCov">      11580 :         php_spn_common_handler(INTERNAL_FUNCTION_PARAM_PASSTHRU, STR_STRCSPN);</span></a>
<a name="319"><span class="lineNum">     319 </span><span class="lineCov">      11580 : }</span></a>
<a name="320"><span class="lineNum">     320 </span>            : /* }}} */</a>
<a name="321"><span class="lineNum">     321 </span>            : </a>
<a name="322"><span class="lineNum">     322 </span>            : /* {{{ PHP_MINIT_FUNCTION(nl_langinfo) */</a>
<a name="323"><span class="lineNum">     323 </span>            : #if HAVE_NL_LANGINFO</a>
<a name="324"><span class="lineNum">     324 </span><span class="lineCov">      38769 : PHP_MINIT_FUNCTION(nl_langinfo)</span></a>
<a name="325"><span class="lineNum">     325 </span>            : {</a>
<a name="326"><span class="lineNum">     326 </span>            : #define REGISTER_NL_LANGINFO_CONSTANT(x)        REGISTER_LONG_CONSTANT(#x, x, CONST_CS | CONST_PERSISTENT)</a>
<a name="327"><span class="lineNum">     327 </span>            : #ifdef ABDAY_1</a>
<a name="328"><span class="lineNum">     328 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABDAY_1);</span></a>
<a name="329"><span class="lineNum">     329 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABDAY_2);</span></a>
<a name="330"><span class="lineNum">     330 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABDAY_3);</span></a>
<a name="331"><span class="lineNum">     331 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABDAY_4);</span></a>
<a name="332"><span class="lineNum">     332 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABDAY_5);</span></a>
<a name="333"><span class="lineNum">     333 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABDAY_6);</span></a>
<a name="334"><span class="lineNum">     334 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABDAY_7);</span></a>
<a name="335"><span class="lineNum">     335 </span>            : #endif</a>
<a name="336"><span class="lineNum">     336 </span>            : #ifdef DAY_1</a>
<a name="337"><span class="lineNum">     337 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DAY_1);</span></a>
<a name="338"><span class="lineNum">     338 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DAY_2);</span></a>
<a name="339"><span class="lineNum">     339 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DAY_3);</span></a>
<a name="340"><span class="lineNum">     340 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DAY_4);</span></a>
<a name="341"><span class="lineNum">     341 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DAY_5);</span></a>
<a name="342"><span class="lineNum">     342 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DAY_6);</span></a>
<a name="343"><span class="lineNum">     343 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DAY_7);</span></a>
<a name="344"><span class="lineNum">     344 </span>            : #endif</a>
<a name="345"><span class="lineNum">     345 </span>            : #ifdef ABMON_1</a>
<a name="346"><span class="lineNum">     346 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_1);</span></a>
<a name="347"><span class="lineNum">     347 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_2);</span></a>
<a name="348"><span class="lineNum">     348 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_3);</span></a>
<a name="349"><span class="lineNum">     349 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_4);</span></a>
<a name="350"><span class="lineNum">     350 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_5);</span></a>
<a name="351"><span class="lineNum">     351 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_6);</span></a>
<a name="352"><span class="lineNum">     352 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_7);</span></a>
<a name="353"><span class="lineNum">     353 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_8);</span></a>
<a name="354"><span class="lineNum">     354 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_9);</span></a>
<a name="355"><span class="lineNum">     355 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_10);</span></a>
<a name="356"><span class="lineNum">     356 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_11);</span></a>
<a name="357"><span class="lineNum">     357 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ABMON_12);</span></a>
<a name="358"><span class="lineNum">     358 </span>            : #endif</a>
<a name="359"><span class="lineNum">     359 </span>            : #ifdef MON_1</a>
<a name="360"><span class="lineNum">     360 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_1);</span></a>
<a name="361"><span class="lineNum">     361 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_2);</span></a>
<a name="362"><span class="lineNum">     362 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_3);</span></a>
<a name="363"><span class="lineNum">     363 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_4);</span></a>
<a name="364"><span class="lineNum">     364 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_5);</span></a>
<a name="365"><span class="lineNum">     365 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_6);</span></a>
<a name="366"><span class="lineNum">     366 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_7);</span></a>
<a name="367"><span class="lineNum">     367 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_8);</span></a>
<a name="368"><span class="lineNum">     368 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_9);</span></a>
<a name="369"><span class="lineNum">     369 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_10);</span></a>
<a name="370"><span class="lineNum">     370 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_11);</span></a>
<a name="371"><span class="lineNum">     371 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_12);</span></a>
<a name="372"><span class="lineNum">     372 </span>            : #endif</a>
<a name="373"><span class="lineNum">     373 </span>            : #ifdef AM_STR</a>
<a name="374"><span class="lineNum">     374 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(AM_STR);</span></a>
<a name="375"><span class="lineNum">     375 </span>            : #endif</a>
<a name="376"><span class="lineNum">     376 </span>            : #ifdef PM_STR</a>
<a name="377"><span class="lineNum">     377 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(PM_STR);</span></a>
<a name="378"><span class="lineNum">     378 </span>            : #endif</a>
<a name="379"><span class="lineNum">     379 </span>            : #ifdef D_T_FMT</a>
<a name="380"><span class="lineNum">     380 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(D_T_FMT);</span></a>
<a name="381"><span class="lineNum">     381 </span>            : #endif</a>
<a name="382"><span class="lineNum">     382 </span>            : #ifdef D_FMT</a>
<a name="383"><span class="lineNum">     383 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(D_FMT);</span></a>
<a name="384"><span class="lineNum">     384 </span>            : #endif</a>
<a name="385"><span class="lineNum">     385 </span>            : #ifdef T_FMT</a>
<a name="386"><span class="lineNum">     386 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(T_FMT);</span></a>
<a name="387"><span class="lineNum">     387 </span>            : #endif</a>
<a name="388"><span class="lineNum">     388 </span>            : #ifdef T_FMT_AMPM</a>
<a name="389"><span class="lineNum">     389 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(T_FMT_AMPM);</span></a>
<a name="390"><span class="lineNum">     390 </span>            : #endif</a>
<a name="391"><span class="lineNum">     391 </span>            : #ifdef ERA</a>
<a name="392"><span class="lineNum">     392 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ERA);</span></a>
<a name="393"><span class="lineNum">     393 </span>            : #endif</a>
<a name="394"><span class="lineNum">     394 </span>            : #ifdef ERA_YEAR</a>
<a name="395"><span class="lineNum">     395 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ERA_YEAR);</span></a>
<a name="396"><span class="lineNum">     396 </span>            : #endif</a>
<a name="397"><span class="lineNum">     397 </span>            : #ifdef ERA_D_T_FMT</a>
<a name="398"><span class="lineNum">     398 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ERA_D_T_FMT);</span></a>
<a name="399"><span class="lineNum">     399 </span>            : #endif</a>
<a name="400"><span class="lineNum">     400 </span>            : #ifdef ERA_D_FMT</a>
<a name="401"><span class="lineNum">     401 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ERA_D_FMT);</span></a>
<a name="402"><span class="lineNum">     402 </span>            : #endif</a>
<a name="403"><span class="lineNum">     403 </span>            : #ifdef ERA_T_FMT</a>
<a name="404"><span class="lineNum">     404 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ERA_T_FMT);</span></a>
<a name="405"><span class="lineNum">     405 </span>            : #endif</a>
<a name="406"><span class="lineNum">     406 </span>            : #ifdef ALT_DIGITS</a>
<a name="407"><span class="lineNum">     407 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(ALT_DIGITS);</span></a>
<a name="408"><span class="lineNum">     408 </span>            : #endif</a>
<a name="409"><span class="lineNum">     409 </span>            : #ifdef INT_CURR_SYMBOL</a>
<a name="410"><span class="lineNum">     410 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(INT_CURR_SYMBOL);</span></a>
<a name="411"><span class="lineNum">     411 </span>            : #endif</a>
<a name="412"><span class="lineNum">     412 </span>            : #ifdef CURRENCY_SYMBOL</a>
<a name="413"><span class="lineNum">     413 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(CURRENCY_SYMBOL);</span></a>
<a name="414"><span class="lineNum">     414 </span>            : #endif</a>
<a name="415"><span class="lineNum">     415 </span>            : #ifdef CRNCYSTR</a>
<a name="416"><span class="lineNum">     416 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(CRNCYSTR);</span></a>
<a name="417"><span class="lineNum">     417 </span>            : #endif</a>
<a name="418"><span class="lineNum">     418 </span>            : #ifdef MON_DECIMAL_POINT</a>
<a name="419"><span class="lineNum">     419 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_DECIMAL_POINT);</span></a>
<a name="420"><span class="lineNum">     420 </span>            : #endif</a>
<a name="421"><span class="lineNum">     421 </span>            : #ifdef MON_THOUSANDS_SEP</a>
<a name="422"><span class="lineNum">     422 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_THOUSANDS_SEP);</span></a>
<a name="423"><span class="lineNum">     423 </span>            : #endif</a>
<a name="424"><span class="lineNum">     424 </span>            : #ifdef MON_GROUPING</a>
<a name="425"><span class="lineNum">     425 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(MON_GROUPING);</span></a>
<a name="426"><span class="lineNum">     426 </span>            : #endif</a>
<a name="427"><span class="lineNum">     427 </span>            : #ifdef POSITIVE_SIGN</a>
<a name="428"><span class="lineNum">     428 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(POSITIVE_SIGN);</span></a>
<a name="429"><span class="lineNum">     429 </span>            : #endif</a>
<a name="430"><span class="lineNum">     430 </span>            : #ifdef NEGATIVE_SIGN</a>
<a name="431"><span class="lineNum">     431 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(NEGATIVE_SIGN);</span></a>
<a name="432"><span class="lineNum">     432 </span>            : #endif</a>
<a name="433"><span class="lineNum">     433 </span>            : #ifdef INT_FRAC_DIGITS</a>
<a name="434"><span class="lineNum">     434 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(INT_FRAC_DIGITS);</span></a>
<a name="435"><span class="lineNum">     435 </span>            : #endif</a>
<a name="436"><span class="lineNum">     436 </span>            : #ifdef FRAC_DIGITS</a>
<a name="437"><span class="lineNum">     437 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(FRAC_DIGITS);</span></a>
<a name="438"><span class="lineNum">     438 </span>            : #endif</a>
<a name="439"><span class="lineNum">     439 </span>            : #ifdef P_CS_PRECEDES</a>
<a name="440"><span class="lineNum">     440 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(P_CS_PRECEDES);</span></a>
<a name="441"><span class="lineNum">     441 </span>            : #endif</a>
<a name="442"><span class="lineNum">     442 </span>            : #ifdef P_SEP_BY_SPACE</a>
<a name="443"><span class="lineNum">     443 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(P_SEP_BY_SPACE);</span></a>
<a name="444"><span class="lineNum">     444 </span>            : #endif</a>
<a name="445"><span class="lineNum">     445 </span>            : #ifdef N_CS_PRECEDES</a>
<a name="446"><span class="lineNum">     446 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(N_CS_PRECEDES);</span></a>
<a name="447"><span class="lineNum">     447 </span>            : #endif</a>
<a name="448"><span class="lineNum">     448 </span>            : #ifdef N_SEP_BY_SPACE</a>
<a name="449"><span class="lineNum">     449 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(N_SEP_BY_SPACE);</span></a>
<a name="450"><span class="lineNum">     450 </span>            : #endif</a>
<a name="451"><span class="lineNum">     451 </span>            : #ifdef P_SIGN_POSN</a>
<a name="452"><span class="lineNum">     452 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(P_SIGN_POSN);</span></a>
<a name="453"><span class="lineNum">     453 </span>            : #endif</a>
<a name="454"><span class="lineNum">     454 </span>            : #ifdef N_SIGN_POSN</a>
<a name="455"><span class="lineNum">     455 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(N_SIGN_POSN);</span></a>
<a name="456"><span class="lineNum">     456 </span>            : #endif</a>
<a name="457"><span class="lineNum">     457 </span>            : #ifdef DECIMAL_POINT</a>
<a name="458"><span class="lineNum">     458 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(DECIMAL_POINT);</span></a>
<a name="459"><span class="lineNum">     459 </span>            : #endif</a>
<a name="460"><span class="lineNum">     460 </span>            : #ifdef RADIXCHAR</a>
<a name="461"><span class="lineNum">     461 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(RADIXCHAR);</span></a>
<a name="462"><span class="lineNum">     462 </span>            : #endif</a>
<a name="463"><span class="lineNum">     463 </span>            : #ifdef THOUSANDS_SEP</a>
<a name="464"><span class="lineNum">     464 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(THOUSANDS_SEP);</span></a>
<a name="465"><span class="lineNum">     465 </span>            : #endif</a>
<a name="466"><span class="lineNum">     466 </span>            : #ifdef THOUSEP</a>
<a name="467"><span class="lineNum">     467 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(THOUSEP);</span></a>
<a name="468"><span class="lineNum">     468 </span>            : #endif</a>
<a name="469"><span class="lineNum">     469 </span>            : #ifdef GROUPING</a>
<a name="470"><span class="lineNum">     470 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(GROUPING);</span></a>
<a name="471"><span class="lineNum">     471 </span>            : #endif</a>
<a name="472"><span class="lineNum">     472 </span>            : #ifdef YESEXPR</a>
<a name="473"><span class="lineNum">     473 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(YESEXPR);</span></a>
<a name="474"><span class="lineNum">     474 </span>            : #endif</a>
<a name="475"><span class="lineNum">     475 </span>            : #ifdef NOEXPR</a>
<a name="476"><span class="lineNum">     476 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(NOEXPR);</span></a>
<a name="477"><span class="lineNum">     477 </span>            : #endif</a>
<a name="478"><span class="lineNum">     478 </span>            : #ifdef YESSTR</a>
<a name="479"><span class="lineNum">     479 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(YESSTR);</span></a>
<a name="480"><span class="lineNum">     480 </span>            : #endif</a>
<a name="481"><span class="lineNum">     481 </span>            : #ifdef NOSTR</a>
<a name="482"><span class="lineNum">     482 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(NOSTR);</span></a>
<a name="483"><span class="lineNum">     483 </span>            : #endif</a>
<a name="484"><span class="lineNum">     484 </span>            : #ifdef CODESET</a>
<a name="485"><span class="lineNum">     485 </span><span class="lineCov">      38769 :         REGISTER_NL_LANGINFO_CONSTANT(CODESET);</span></a>
<a name="486"><span class="lineNum">     486 </span>            : #endif</a>
<a name="487"><span class="lineNum">     487 </span>            : #undef REGISTER_NL_LANGINFO_CONSTANT</a>
<a name="488"><span class="lineNum">     488 </span><span class="lineCov">      38769 :         return SUCCESS;</span></a>
<a name="489"><span class="lineNum">     489 </span>            : }</a>
<a name="490"><span class="lineNum">     490 </span>            : /* }}} */</a>
<a name="491"><span class="lineNum">     491 </span>            : </a>
<a name="492"><span class="lineNum">     492 </span>            : /* {{{ Query language and locale information */</a>
<a name="493"><span class="lineNum">     493 </span><span class="lineCov">         69 : PHP_FUNCTION(nl_langinfo)</span></a>
<a name="494"><span class="lineNum">     494 </span>            : {</a>
<a name="495"><span class="lineNum">     495 </span>            :         zend_long item;</a>
<a name="496"><span class="lineNum">     496 </span>            :         char *value;</a>
<a name="497"><span class="lineNum">     497 </span>            : </a>
<a name="498"><span class="lineNum">     498 </span><span class="lineCov">         69 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="499"><span class="lineNum">     499 </span><span class="lineCov">         42 :                 Z_PARAM_LONG(item)</span></a>
<a name="500"><span class="lineNum">     500 </span><span class="lineCov">         69 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="501"><span class="lineNum">     501 </span>            : </a>
<a name="502"><span class="lineNum">     502 </span><span class="lineCov">         18 :         switch(item) { /* {{{ */</span></a>
<a name="503"><span class="lineNum">     503 </span>            : #ifdef ABDAY_1</a>
<a name="504"><span class="lineNum">     504 </span><span class="lineCov">         15 :                 case ABDAY_1:</span></a>
<a name="505"><span class="lineNum">     505 </span>            :                 case ABDAY_2:</a>
<a name="506"><span class="lineNum">     506 </span>            :                 case ABDAY_3:</a>
<a name="507"><span class="lineNum">     507 </span>            :                 case ABDAY_4:</a>
<a name="508"><span class="lineNum">     508 </span>            :                 case ABDAY_5:</a>
<a name="509"><span class="lineNum">     509 </span>            :                 case ABDAY_6:</a>
<a name="510"><span class="lineNum">     510 </span>            :                 case ABDAY_7:</a>
<a name="511"><span class="lineNum">     511 </span>            : #endif</a>
<a name="512"><span class="lineNum">     512 </span>            : #ifdef DAY_1</a>
<a name="513"><span class="lineNum">     513 </span>            :                 case DAY_1:</a>
<a name="514"><span class="lineNum">     514 </span>            :                 case DAY_2:</a>
<a name="515"><span class="lineNum">     515 </span>            :                 case DAY_3:</a>
<a name="516"><span class="lineNum">     516 </span>            :                 case DAY_4:</a>
<a name="517"><span class="lineNum">     517 </span>            :                 case DAY_5:</a>
<a name="518"><span class="lineNum">     518 </span>            :                 case DAY_6:</a>
<a name="519"><span class="lineNum">     519 </span>            :                 case DAY_7:</a>
<a name="520"><span class="lineNum">     520 </span>            : #endif</a>
<a name="521"><span class="lineNum">     521 </span>            : #ifdef ABMON_1</a>
<a name="522"><span class="lineNum">     522 </span>            :                 case ABMON_1:</a>
<a name="523"><span class="lineNum">     523 </span>            :                 case ABMON_2:</a>
<a name="524"><span class="lineNum">     524 </span>            :                 case ABMON_3:</a>
<a name="525"><span class="lineNum">     525 </span>            :                 case ABMON_4:</a>
<a name="526"><span class="lineNum">     526 </span>            :                 case ABMON_5:</a>
<a name="527"><span class="lineNum">     527 </span>            :                 case ABMON_6:</a>
<a name="528"><span class="lineNum">     528 </span>            :                 case ABMON_7:</a>
<a name="529"><span class="lineNum">     529 </span>            :                 case ABMON_8:</a>
<a name="530"><span class="lineNum">     530 </span>            :                 case ABMON_9:</a>
<a name="531"><span class="lineNum">     531 </span>            :                 case ABMON_10:</a>
<a name="532"><span class="lineNum">     532 </span>            :                 case ABMON_11:</a>
<a name="533"><span class="lineNum">     533 </span>            :                 case ABMON_12:</a>
<a name="534"><span class="lineNum">     534 </span>            : #endif</a>
<a name="535"><span class="lineNum">     535 </span>            : #ifdef MON_1</a>
<a name="536"><span class="lineNum">     536 </span>            :                 case MON_1:</a>
<a name="537"><span class="lineNum">     537 </span>            :                 case MON_2:</a>
<a name="538"><span class="lineNum">     538 </span>            :                 case MON_3:</a>
<a name="539"><span class="lineNum">     539 </span>            :                 case MON_4:</a>
<a name="540"><span class="lineNum">     540 </span>            :                 case MON_5:</a>
<a name="541"><span class="lineNum">     541 </span>            :                 case MON_6:</a>
<a name="542"><span class="lineNum">     542 </span>            :                 case MON_7:</a>
<a name="543"><span class="lineNum">     543 </span>            :                 case MON_8:</a>
<a name="544"><span class="lineNum">     544 </span>            :                 case MON_9:</a>
<a name="545"><span class="lineNum">     545 </span>            :                 case MON_10:</a>
<a name="546"><span class="lineNum">     546 </span>            :                 case MON_11:</a>
<a name="547"><span class="lineNum">     547 </span>            :                 case MON_12:</a>
<a name="548"><span class="lineNum">     548 </span>            : #endif</a>
<a name="549"><span class="lineNum">     549 </span>            : #ifdef AM_STR</a>
<a name="550"><span class="lineNum">     550 </span>            :                 case AM_STR:</a>
<a name="551"><span class="lineNum">     551 </span>            : #endif</a>
<a name="552"><span class="lineNum">     552 </span>            : #ifdef PM_STR</a>
<a name="553"><span class="lineNum">     553 </span>            :                 case PM_STR:</a>
<a name="554"><span class="lineNum">     554 </span>            : #endif</a>
<a name="555"><span class="lineNum">     555 </span>            : #ifdef D_T_FMT</a>
<a name="556"><span class="lineNum">     556 </span>            :                 case D_T_FMT:</a>
<a name="557"><span class="lineNum">     557 </span>            : #endif</a>
<a name="558"><span class="lineNum">     558 </span>            : #ifdef D_FMT</a>
<a name="559"><span class="lineNum">     559 </span>            :                 case D_FMT:</a>
<a name="560"><span class="lineNum">     560 </span>            : #endif</a>
<a name="561"><span class="lineNum">     561 </span>            : #ifdef T_FMT</a>
<a name="562"><span class="lineNum">     562 </span>            :                 case T_FMT:</a>
<a name="563"><span class="lineNum">     563 </span>            : #endif</a>
<a name="564"><span class="lineNum">     564 </span>            : #ifdef T_FMT_AMPM</a>
<a name="565"><span class="lineNum">     565 </span>            :                 case T_FMT_AMPM:</a>
<a name="566"><span class="lineNum">     566 </span>            : #endif</a>
<a name="567"><span class="lineNum">     567 </span>            : #ifdef ERA</a>
<a name="568"><span class="lineNum">     568 </span>            :                 case ERA:</a>
<a name="569"><span class="lineNum">     569 </span>            : #endif</a>
<a name="570"><span class="lineNum">     570 </span>            : #ifdef ERA_YEAR</a>
<a name="571"><span class="lineNum">     571 </span>            :                 case ERA_YEAR:</a>
<a name="572"><span class="lineNum">     572 </span>            : #endif</a>
<a name="573"><span class="lineNum">     573 </span>            : #ifdef ERA_D_T_FMT</a>
<a name="574"><span class="lineNum">     574 </span>            :                 case ERA_D_T_FMT:</a>
<a name="575"><span class="lineNum">     575 </span>            : #endif</a>
<a name="576"><span class="lineNum">     576 </span>            : #ifdef ERA_D_FMT</a>
<a name="577"><span class="lineNum">     577 </span>            :                 case ERA_D_FMT:</a>
<a name="578"><span class="lineNum">     578 </span>            : #endif</a>
<a name="579"><span class="lineNum">     579 </span>            : #ifdef ERA_T_FMT</a>
<a name="580"><span class="lineNum">     580 </span>            :                 case ERA_T_FMT:</a>
<a name="581"><span class="lineNum">     581 </span>            : #endif</a>
<a name="582"><span class="lineNum">     582 </span>            : #ifdef ALT_DIGITS</a>
<a name="583"><span class="lineNum">     583 </span>            :                 case ALT_DIGITS:</a>
<a name="584"><span class="lineNum">     584 </span>            : #endif</a>
<a name="585"><span class="lineNum">     585 </span>            : #ifdef INT_CURR_SYMBOL</a>
<a name="586"><span class="lineNum">     586 </span>            :                 case INT_CURR_SYMBOL:</a>
<a name="587"><span class="lineNum">     587 </span>            : #endif</a>
<a name="588"><span class="lineNum">     588 </span>            : #ifdef CURRENCY_SYMBOL</a>
<a name="589"><span class="lineNum">     589 </span>            :                 case CURRENCY_SYMBOL:</a>
<a name="590"><span class="lineNum">     590 </span>            : #endif</a>
<a name="591"><span class="lineNum">     591 </span>            : #ifdef CRNCYSTR</a>
<a name="592"><span class="lineNum">     592 </span>            :                 case CRNCYSTR:</a>
<a name="593"><span class="lineNum">     593 </span>            : #endif</a>
<a name="594"><span class="lineNum">     594 </span>            : #ifdef MON_DECIMAL_POINT</a>
<a name="595"><span class="lineNum">     595 </span>            :                 case MON_DECIMAL_POINT:</a>
<a name="596"><span class="lineNum">     596 </span>            : #endif</a>
<a name="597"><span class="lineNum">     597 </span>            : #ifdef MON_THOUSANDS_SEP</a>
<a name="598"><span class="lineNum">     598 </span>            :                 case MON_THOUSANDS_SEP:</a>
<a name="599"><span class="lineNum">     599 </span>            : #endif</a>
<a name="600"><span class="lineNum">     600 </span>            : #ifdef MON_GROUPING</a>
<a name="601"><span class="lineNum">     601 </span>            :                 case MON_GROUPING:</a>
<a name="602"><span class="lineNum">     602 </span>            : #endif</a>
<a name="603"><span class="lineNum">     603 </span>            : #ifdef POSITIVE_SIGN</a>
<a name="604"><span class="lineNum">     604 </span>            :                 case POSITIVE_SIGN:</a>
<a name="605"><span class="lineNum">     605 </span>            : #endif</a>
<a name="606"><span class="lineNum">     606 </span>            : #ifdef NEGATIVE_SIGN</a>
<a name="607"><span class="lineNum">     607 </span>            :                 case NEGATIVE_SIGN:</a>
<a name="608"><span class="lineNum">     608 </span>            : #endif</a>
<a name="609"><span class="lineNum">     609 </span>            : #ifdef INT_FRAC_DIGITS</a>
<a name="610"><span class="lineNum">     610 </span>            :                 case INT_FRAC_DIGITS:</a>
<a name="611"><span class="lineNum">     611 </span>            : #endif</a>
<a name="612"><span class="lineNum">     612 </span>            : #ifdef FRAC_DIGITS</a>
<a name="613"><span class="lineNum">     613 </span>            :                 case FRAC_DIGITS:</a>
<a name="614"><span class="lineNum">     614 </span>            : #endif</a>
<a name="615"><span class="lineNum">     615 </span>            : #ifdef P_CS_PRECEDES</a>
<a name="616"><span class="lineNum">     616 </span>            :                 case P_CS_PRECEDES:</a>
<a name="617"><span class="lineNum">     617 </span>            : #endif</a>
<a name="618"><span class="lineNum">     618 </span>            : #ifdef P_SEP_BY_SPACE</a>
<a name="619"><span class="lineNum">     619 </span>            :                 case P_SEP_BY_SPACE:</a>
<a name="620"><span class="lineNum">     620 </span>            : #endif</a>
<a name="621"><span class="lineNum">     621 </span>            : #ifdef N_CS_PRECEDES</a>
<a name="622"><span class="lineNum">     622 </span>            :                 case N_CS_PRECEDES:</a>
<a name="623"><span class="lineNum">     623 </span>            : #endif</a>
<a name="624"><span class="lineNum">     624 </span>            : #ifdef N_SEP_BY_SPACE</a>
<a name="625"><span class="lineNum">     625 </span>            :                 case N_SEP_BY_SPACE:</a>
<a name="626"><span class="lineNum">     626 </span>            : #endif</a>
<a name="627"><span class="lineNum">     627 </span>            : #ifdef P_SIGN_POSN</a>
<a name="628"><span class="lineNum">     628 </span>            :                 case P_SIGN_POSN:</a>
<a name="629"><span class="lineNum">     629 </span>            : #endif</a>
<a name="630"><span class="lineNum">     630 </span>            : #ifdef N_SIGN_POSN</a>
<a name="631"><span class="lineNum">     631 </span>            :                 case N_SIGN_POSN:</a>
<a name="632"><span class="lineNum">     632 </span>            : #endif</a>
<a name="633"><span class="lineNum">     633 </span>            : #ifdef DECIMAL_POINT</a>
<a name="634"><span class="lineNum">     634 </span>            :                 case DECIMAL_POINT:</a>
<a name="635"><span class="lineNum">     635 </span>            : #elif defined(RADIXCHAR)</a>
<a name="636"><span class="lineNum">     636 </span>            :                 case RADIXCHAR:</a>
<a name="637"><span class="lineNum">     637 </span>            : #endif</a>
<a name="638"><span class="lineNum">     638 </span>            : #ifdef THOUSANDS_SEP</a>
<a name="639"><span class="lineNum">     639 </span>            :                 case THOUSANDS_SEP:</a>
<a name="640"><span class="lineNum">     640 </span>            : #elif defined(THOUSEP)</a>
<a name="641"><span class="lineNum">     641 </span>            :                 case THOUSEP:</a>
<a name="642"><span class="lineNum">     642 </span>            : #endif</a>
<a name="643"><span class="lineNum">     643 </span>            : #ifdef GROUPING</a>
<a name="644"><span class="lineNum">     644 </span>            :                 case GROUPING:</a>
<a name="645"><span class="lineNum">     645 </span>            : #endif</a>
<a name="646"><span class="lineNum">     646 </span>            : #ifdef YESEXPR</a>
<a name="647"><span class="lineNum">     647 </span>            :                 case YESEXPR:</a>
<a name="648"><span class="lineNum">     648 </span>            : #endif</a>
<a name="649"><span class="lineNum">     649 </span>            : #ifdef NOEXPR</a>
<a name="650"><span class="lineNum">     650 </span>            :                 case NOEXPR:</a>
<a name="651"><span class="lineNum">     651 </span>            : #endif</a>
<a name="652"><span class="lineNum">     652 </span>            : #ifdef YESSTR</a>
<a name="653"><span class="lineNum">     653 </span>            :                 case YESSTR:</a>
<a name="654"><span class="lineNum">     654 </span>            : #endif</a>
<a name="655"><span class="lineNum">     655 </span>            : #ifdef NOSTR</a>
<a name="656"><span class="lineNum">     656 </span>            :                 case NOSTR:</a>
<a name="657"><span class="lineNum">     657 </span>            : #endif</a>
<a name="658"><span class="lineNum">     658 </span>            : #ifdef CODESET</a>
<a name="659"><span class="lineNum">     659 </span>            :                 case CODESET:</a>
<a name="660"><span class="lineNum">     660 </span>            : #endif</a>
<a name="661"><span class="lineNum">     661 </span><span class="lineCov">         15 :                         break;</span></a>
<a name="662"><span class="lineNum">     662 </span><span class="lineCov">          3 :                 default:</span></a>
<a name="663"><span class="lineNum">     663 </span><span class="lineCov">          3 :                         php_error_docref(NULL, E_WARNING, &quot;Item '&quot; ZEND_LONG_FMT &quot;' is not valid&quot;, item);</span></a>
<a name="664"><span class="lineNum">     664 </span><span class="lineCov">          3 :                         RETURN_FALSE;</span></a>
<a name="665"><span class="lineNum">     665 </span>            :         }</a>
<a name="666"><span class="lineNum">     666 </span>            :         /* }}} */</a>
<a name="667"><span class="lineNum">     667 </span>            : </a>
<a name="668"><span class="lineNum">     668 </span><span class="lineCov">         15 :         value = nl_langinfo(item);</span></a>
<a name="669"><span class="lineNum">     669 </span><span class="lineCov">         15 :         if (value == NULL) {</span></a>
<a name="670"><span class="lineNum">     670 </span><span class="lineNoCov">          0 :                 RETURN_FALSE;</span></a>
<a name="671"><span class="lineNum">     671 </span>            :         } else {</a>
<a name="672"><span class="lineNum">     672 </span><span class="lineCov">         30 :                 RETURN_STRING(value);</span></a>
<a name="673"><span class="lineNum">     673 </span>            :         }</a>
<a name="674"><span class="lineNum">     674 </span>            : }</a>
<a name="675"><span class="lineNum">     675 </span>            : #endif</a>
<a name="676"><span class="lineNum">     676 </span>            : /* }}} */</a>
<a name="677"><span class="lineNum">     677 </span>            : </a>
<a name="678"><span class="lineNum">     678 </span>            : /* {{{ Compares two strings using the current locale */</a>
<a name="679"><span class="lineNum">     679 </span><span class="lineCov">         57 : PHP_FUNCTION(strcoll)</span></a>
<a name="680"><span class="lineNum">     680 </span>            : {</a>
<a name="681"><span class="lineNum">     681 </span>            :         zend_string *s1, *s2;</a>
<a name="682"><span class="lineNum">     682 </span>            : </a>
<a name="683"><span class="lineNum">     683 </span><span class="lineCov">         57 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="684"><span class="lineNum">     684 </span><span class="lineCov">         18 :                 Z_PARAM_STR(s1)</span></a>
<a name="685"><span class="lineNum">     685 </span><span class="lineCov">         12 :                 Z_PARAM_STR(s2)</span></a>
<a name="686"><span class="lineNum">     686 </span><span class="lineCov">         57 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="687"><span class="lineNum">     687 </span>            : </a>
<a name="688"><span class="lineNum">     688 </span><span class="lineCov">          6 :         RETURN_LONG(strcoll((const char *) ZSTR_VAL(s1),</span></a>
<a name="689"><span class="lineNum">     689 </span>            :                             (const char *) ZSTR_VAL(s2)));</a>
<a name="690"><span class="lineNum">     690 </span>            : }</a>
<a name="691"><span class="lineNum">     691 </span>            : /* }}} */</a>
<a name="692"><span class="lineNum">     692 </span>            : </a>
<a name="693"><span class="lineNum">     693 </span>            : /* {{{ php_charmask</a>
<a name="694"><span class="lineNum">     694 </span>            :  * Fills a 256-byte bytemask with input. You can specify a range like 'a..z',</a>
<a name="695"><span class="lineNum">     695 </span>            :  * it needs to be incrementing.</a>
<a name="696"><span class="lineNum">     696 </span>            :  * Returns: FAILURE/SUCCESS whether the input was correct (i.e. no range errors)</a>
<a name="697"><span class="lineNum">     697 </span>            :  */</a>
<a name="698"><span class="lineNum">     698 </span><span class="lineCov">     191090 : static inline int php_charmask(const unsigned char *input, size_t len, char *mask)</span></a>
<a name="699"><span class="lineNum">     699 </span>            : {</a>
<a name="700"><span class="lineNum">     700 </span>            :         const unsigned char *end;</a>
<a name="701"><span class="lineNum">     701 </span>            :         unsigned char c;</a>
<a name="702"><span class="lineNum">     702 </span><span class="lineCov">     191090 :         int result = SUCCESS;</span></a>
<a name="703"><span class="lineNum">     703 </span>            : </a>
<a name="704"><span class="lineNum">     704 </span><span class="lineCov">     191090 :         memset(mask, 0, 256);</span></a>
<a name="705"><span class="lineNum">     705 </span><span class="lineCov">     574209 :         for (end = input+len; input &lt; end; input++) {</span></a>
<a name="706"><span class="lineNum">     706 </span><span class="lineCov">     383119 :                 c=*input;</span></a>
<a name="707"><span class="lineNum">     707 </span><span class="lineCov">     383119 :                 if ((input+3 &lt; end) &amp;&amp; input[1] == '.' &amp;&amp; input[2] == '.'</span></a>
<a name="708"><span class="lineNum">     708 </span><span class="lineCov">         96 :                                 &amp;&amp; input[3] &gt;= c) {</span></a>
<a name="709"><span class="lineNum">     709 </span><span class="lineCov">         78 :                         memset(mask+c, 1, input[3] - c + 1);</span></a>
<a name="710"><span class="lineNum">     710 </span><span class="lineCov">         78 :                         input+=3;</span></a>
<a name="711"><span class="lineNum">     711 </span><span class="lineCov">     383041 :                 } else if ((input+1 &lt; end) &amp;&amp; input[0] == '.' &amp;&amp; input[1] == '.') {</span></a>
<a name="712"><span class="lineNum">     712 </span>            :                         /* Error, try to be as helpful as possible:</a>
<a name="713"><span class="lineNum">     713 </span>            :                            (a range ending/starting with '.' won't be captured here) */</a>
<a name="714"><span class="lineNum">     714 </span><span class="lineCov">         45 :                         if (end-len &gt;= input) { /* there was no 'left' char */</span></a>
<a name="715"><span class="lineNum">     715 </span><span class="lineCov">          9 :                                 php_error_docref(NULL, E_WARNING, &quot;Invalid '..'-range, no character to the left of '..'&quot;);</span></a>
<a name="716"><span class="lineNum">     716 </span><span class="lineCov">          9 :                                 result = FAILURE;</span></a>
<a name="717"><span class="lineNum">     717 </span><span class="lineCov">          9 :                                 continue;</span></a>
<a name="718"><span class="lineNum">     718 </span>            :                         }</a>
<a name="719"><span class="lineNum">     719 </span><span class="lineCov">         36 :                         if (input+2 &gt;= end) { /* there is no 'right' char */</span></a>
<a name="720"><span class="lineNum">     720 </span><span class="lineCov">          9 :                                 php_error_docref(NULL, E_WARNING, &quot;Invalid '..'-range, no character to the right of '..'&quot;);</span></a>
<a name="721"><span class="lineNum">     721 </span><span class="lineCov">          9 :                                 result = FAILURE;</span></a>
<a name="722"><span class="lineNum">     722 </span><span class="lineCov">          9 :                                 continue;</span></a>
<a name="723"><span class="lineNum">     723 </span>            :                         }</a>
<a name="724"><span class="lineNum">     724 </span><span class="lineCov">         27 :                         if (input[-1] &gt; input[2]) { /* wrong order */</span></a>
<a name="725"><span class="lineNum">     725 </span><span class="lineCov">         18 :                                 php_error_docref(NULL, E_WARNING, &quot;Invalid '..'-range, '..'-range needs to be incrementing&quot;);</span></a>
<a name="726"><span class="lineNum">     726 </span><span class="lineCov">         18 :                                 result = FAILURE;</span></a>
<a name="727"><span class="lineNum">     727 </span><span class="lineCov">         18 :                                 continue;</span></a>
<a name="728"><span class="lineNum">     728 </span>            :                         }</a>
<a name="729"><span class="lineNum">     729 </span>            :                         /* FIXME: better error (a..b..c is the only left possibility?) */</a>
<a name="730"><span class="lineNum">     730 </span><span class="lineCov">          9 :                         php_error_docref(NULL, E_WARNING, &quot;Invalid '..'-range&quot;);</span></a>
<a name="731"><span class="lineNum">     731 </span><span class="lineCov">          9 :                         result = FAILURE;</span></a>
<a name="732"><span class="lineNum">     732 </span><span class="lineCov">          9 :                         continue;</span></a>
<a name="733"><span class="lineNum">     733 </span>            :                 } else {</a>
<a name="734"><span class="lineNum">     734 </span><span class="lineCov">     382996 :                         mask[c]=1;</span></a>
<a name="735"><span class="lineNum">     735 </span>            :                 }</a>
<a name="736"><span class="lineNum">     736 </span>            :         }</a>
<a name="737"><span class="lineNum">     737 </span><span class="lineCov">     191090 :         return result;</span></a>
<a name="738"><span class="lineNum">     738 </span>            : }</a>
<a name="739"><span class="lineNum">     739 </span>            : /* }}} */</a>
<a name="740"><span class="lineNum">     740 </span>            : </a>
<a name="741"><span class="lineNum">     741 </span>            : /* {{{ php_trim_int()</a>
<a name="742"><span class="lineNum">     742 </span>            :  * mode 1 : trim left</a>
<a name="743"><span class="lineNum">     743 </span>            :  * mode 2 : trim right</a>
<a name="744"><span class="lineNum">     744 </span>            :  * mode 3 : trim left and right</a>
<a name="745"><span class="lineNum">     745 </span>            :  * what indicates which chars are to be trimmed. NULL-&gt;default (' \t\n\r\v\0')</a>
<a name="746"><span class="lineNum">     746 </span>            :  */</a>
<a name="747"><span class="lineNum">     747 </span>            : static zend_always_inline zend_string *php_trim_int(zend_string *str, const char *what, size_t what_len, int mode)</a>
<a name="748"><span class="lineNum">     748 </span>            : {</a>
<a name="749"><span class="lineNum">     749 </span><span class="lineCov">       1101 :         const char *start = ZSTR_VAL(str);</span></a>
<a name="750"><span class="lineNum">     750 </span><span class="lineCov">       1101 :         const char *end = start + ZSTR_LEN(str);</span></a>
<a name="751"><span class="lineNum">     751 </span>            :         char mask[256];</a>
<a name="752"><span class="lineNum">     752 </span>            : </a>
<a name="753"><span class="lineNum">     753 </span><span class="lineCov">       1101 :         if (what) {</span></a>
<a name="754"><span class="lineNum">     754 </span><span class="lineCov">        432 :                 if (what_len == 1) {</span></a>
<a name="755"><span class="lineNum">     755 </span><span class="lineCov">        204 :                         char p = *what;</span></a>
<a name="756"><span class="lineNum">     756 </span><span class="lineCov">        204 :                         if (mode &amp; 1) {</span></a>
<a name="757"><span class="lineNum">     757 </span><span class="lineCov">       1463 :                                 while (start != end) {</span></a>
<a name="758"><span class="lineNum">     758 </span><span class="lineCov">       1463 :                                         if (*start == p) {</span></a>
<a name="759"><span class="lineNum">     759 </span><span class="lineCov">       1304 :                                                 start++;</span></a>
<a name="760"><span class="lineNum">     760 </span>            :                                         } else {</a>
<a name="761"><span class="lineNum">     761 </span><span class="lineCov">        159 :                                                 break;</span></a>
<a name="762"><span class="lineNum">     762 </span>            :                                         }</a>
<a name="763"><span class="lineNum">     763 </span>            :                                 }</a>
<a name="764"><span class="lineNum">     764 </span>            :                         }</a>
<a name="765"><span class="lineNum">     765 </span><span class="lineCov">        204 :                         if (mode &amp; 2) {</span></a>
<a name="766"><span class="lineNum">     766 </span><span class="lineCov">        117 :                                 while (start != end) {</span></a>
<a name="767"><span class="lineNum">     767 </span><span class="lineCov">        111 :                                         if (*(end-1) == p) {</span></a>
<a name="768"><span class="lineNum">     768 </span><span class="lineCov">         69 :                                                 end--;</span></a>
<a name="769"><span class="lineNum">     769 </span>            :                                         } else {</a>
<a name="770"><span class="lineNum">     770 </span><span class="lineCov">         42 :                                                 break;</span></a>
<a name="771"><span class="lineNum">     771 </span>            :                                         }</a>
<a name="772"><span class="lineNum">     772 </span>            :                                 }</a>
<a name="773"><span class="lineNum">     773 </span>            :                         }</a>
<a name="774"><span class="lineNum">     774 </span>            :                 } else {</a>
<a name="775"><span class="lineNum">     775 </span><span class="lineCov">        228 :                         php_charmask((const unsigned char *) what, what_len, mask);</span></a>
<a name="776"><span class="lineNum">     776 </span>            : </a>
<a name="777"><span class="lineNum">     777 </span><span class="lineCov">        228 :                         if (mode &amp; 1) {</span></a>
<a name="778"><span class="lineNum">     778 </span><span class="lineCov">        360 :                                 while (start != end) {</span></a>
<a name="779"><span class="lineNum">     779 </span><span class="lineCov">        354 :                                         if (mask[(unsigned char)*start]) {</span></a>
<a name="780"><span class="lineNum">     780 </span><span class="lineCov">        255 :                                                 start++;</span></a>
<a name="781"><span class="lineNum">     781 </span>            :                                         } else {</a>
<a name="782"><span class="lineNum">     782 </span><span class="lineCov">         99 :                                                 break;</span></a>
<a name="783"><span class="lineNum">     783 </span>            :                                         }</a>
<a name="784"><span class="lineNum">     784 </span>            :                                 }</a>
<a name="785"><span class="lineNum">     785 </span>            :                         }</a>
<a name="786"><span class="lineNum">     786 </span><span class="lineCov">        228 :                         if (mode &amp; 2) {</span></a>
<a name="787"><span class="lineNum">     787 </span><span class="lineCov">        621 :                                 while (start != end) {</span></a>
<a name="788"><span class="lineNum">     788 </span><span class="lineCov">        606 :                                         if (mask[(unsigned char)*(end-1)]) {</span></a>
<a name="789"><span class="lineNum">     789 </span><span class="lineCov">        441 :                                                 end--;</span></a>
<a name="790"><span class="lineNum">     790 </span>            :                                         } else {</a>
<a name="791"><span class="lineNum">     791 </span><span class="lineCov">        165 :                                                 break;</span></a>
<a name="792"><span class="lineNum">     792 </span>            :                                         }</a>
<a name="793"><span class="lineNum">     793 </span>            :                                 }</a>
<a name="794"><span class="lineNum">     794 </span>            :                         }</a>
<a name="795"><span class="lineNum">     795 </span>            :                 }</a>
<a name="796"><span class="lineNum">     796 </span>            :         } else {</a>
<a name="797"><span class="lineNum">     797 </span><span class="lineCov">        669 :                 if (mode &amp; 1) {</span></a>
<a name="798"><span class="lineNum">     798 </span><span class="lineCov">       1017 :                         while (start != end) {</span></a>
<a name="799"><span class="lineNum">     799 </span><span class="lineCov">        951 :                                 unsigned char c = (unsigned char)*start;</span></a>
<a name="800"><span class="lineNum">     800 </span>            : </a>
<a name="801"><span class="lineNum">     801 </span><span class="lineCov">        951 :                                 if (c &lt;= ' ' &amp;&amp;</span></a>
<a name="802"><span class="lineNum">     802 </span><span class="lineCov">        207 :                                     (c == ' ' || c == '\n' || c == '\r' || c == '\t' || c == '\v' || c == '\0')) {</span></a>
<a name="803"><span class="lineNum">     803 </span><span class="lineCov">        558 :                                         start++;</span></a>
<a name="804"><span class="lineNum">     804 </span>            :                                 } else {</a>
<a name="805"><span class="lineNum">     805 </span>            :                                         break;</a>
<a name="806"><span class="lineNum">     806 </span>            :                                 }</a>
<a name="807"><span class="lineNum">     807 </span>            :                         }</a>
<a name="808"><span class="lineNum">     808 </span>            :                 }</a>
<a name="809"><span class="lineNum">     809 </span><span class="lineCov">        669 :                 if (mode &amp; 2) {</span></a>
<a name="810"><span class="lineNum">     810 </span><span class="lineCov">       1722 :                         while (start != end) {</span></a>
<a name="811"><span class="lineNum">     811 </span><span class="lineCov">       1611 :                                 unsigned char c = (unsigned char)*(end-1);</span></a>
<a name="812"><span class="lineNum">     812 </span>            : </a>
<a name="813"><span class="lineNum">     813 </span><span class="lineCov">       1611 :                                 if (c &lt;= ' ' &amp;&amp;</span></a>
<a name="814"><span class="lineNum">     814 </span><span class="lineCov">        528 :                                     (c == ' ' || c == '\n' || c == '\r' || c == '\t' || c == '\v' || c == '\0')) {</span></a>
<a name="815"><span class="lineNum">     815 </span><span class="lineCov">       1071 :                                         end--;</span></a>
<a name="816"><span class="lineNum">     816 </span>            :                                 } else {</a>
<a name="817"><span class="lineNum">     817 </span>            :                                         break;</a>
<a name="818"><span class="lineNum">     818 </span>            :                                 }</a>
<a name="819"><span class="lineNum">     819 </span>            :                         }</a>
<a name="820"><span class="lineNum">     820 </span>            :                 }</a>
<a name="821"><span class="lineNum">     821 </span>            :         }</a>
<a name="822"><span class="lineNum">     822 </span>            : </a>
<a name="823"><span class="lineNum">     823 </span><span class="lineCov">       1101 :         if (ZSTR_LEN(str) == end - start) {</span></a>
<a name="824"><span class="lineNum">     824 </span><span class="lineCov">        465 :                 return zend_string_copy(str);</span></a>
<a name="825"><span class="lineNum">     825 </span><span class="lineCov">        636 :         } else if (end - start == 0) {</span></a>
<a name="826"><span class="lineNum">     826 </span><span class="lineCov">         42 :                 return ZSTR_EMPTY_ALLOC();</span></a>
<a name="827"><span class="lineNum">     827 </span>            :         } else {</a>
<a name="828"><span class="lineNum">     828 </span><span class="lineCov">       1188 :                 return zend_string_init(start, end - start, 0);</span></a>
<a name="829"><span class="lineNum">     829 </span>            :         }</a>
<a name="830"><span class="lineNum">     830 </span>            : }</a>
<a name="831"><span class="lineNum">     831 </span>            : /* }}} */</a>
<a name="832"><span class="lineNum">     832 </span>            : </a>
<a name="833"><span class="lineNum">     833 </span>            : /* {{{ php_trim_int()</a>
<a name="834"><span class="lineNum">     834 </span>            :  * mode 1 : trim left</a>
<a name="835"><span class="lineNum">     835 </span>            :  * mode 2 : trim right</a>
<a name="836"><span class="lineNum">     836 </span>            :  * mode 3 : trim left and right</a>
<a name="837"><span class="lineNum">     837 </span>            :  * what indicates which chars are to be trimmed. NULL-&gt;default (' \t\n\r\v\0')</a>
<a name="838"><span class="lineNum">     838 </span>            :  */</a>
<a name="839"><span class="lineNum">     839 </span><span class="lineCov">         87 : PHPAPI zend_string *php_trim(zend_string *str, const char *what, size_t what_len, int mode)</span></a>
<a name="840"><span class="lineNum">     840 </span>            : {</a>
<a name="841"><span class="lineNum">     841 </span><span class="lineCov">         87 :         return php_trim_int(str, what, what_len, mode);</span></a>
<a name="842"><span class="lineNum">     842 </span>            : }</a>
<a name="843"><span class="lineNum">     843 </span>            : /* }}} */</a>
<a name="844"><span class="lineNum">     844 </span>            : </a>
<a name="845"><span class="lineNum">     845 </span>            : /* {{{ php_do_trim</a>
<a name="846"><span class="lineNum">     846 </span>            :  * Base for trim(), rtrim() and ltrim() functions.</a>
<a name="847"><span class="lineNum">     847 </span>            :  */</a>
<a name="848"><span class="lineNum">     848 </span>            : static zend_always_inline void php_do_trim(INTERNAL_FUNCTION_PARAMETERS, int mode)</a>
<a name="849"><span class="lineNum">     849 </span>            : {</a>
<a name="850"><span class="lineNum">     850 </span>            :         zend_string *str;</a>
<a name="851"><span class="lineNum">     851 </span><span class="lineCov">       1206 :         zend_string *what = NULL;</span></a>
<a name="852"><span class="lineNum">     852 </span>            : </a>
<a name="853"><span class="lineNum">     853 </span><span class="lineCov">       1206 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="854"><span class="lineNum">     854 </span><span class="lineCov">       2076 :                 Z_PARAM_STR(str)</span></a>
<a name="855"><span class="lineNum">     855 </span><span class="lineCov">       1014 :                 Z_PARAM_OPTIONAL</span></a>
<a name="856"><span class="lineNum">     856 </span><span class="lineCov">       1446 :                 Z_PARAM_STR(what)</span></a>
<a name="857"><span class="lineNum">     857 </span><span class="lineCov">       1206 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="858"><span class="lineNum">     858 </span>            : </a>
<a name="859"><span class="lineNum">     859 </span><span class="lineCov">       3042 :         ZVAL_STR(return_value, php_trim_int(str, (what ? ZSTR_VAL(what) : NULL), (what ? ZSTR_LEN(what) : 0), mode));</span></a>
<a name="860"><span class="lineNum">     860 </span>            : }</a>
<a name="861"><span class="lineNum">     861 </span>            : /* }}} */</a>
<a name="862"><span class="lineNum">     862 </span>            : </a>
<a name="863"><span class="lineNum">     863 </span>            : /* {{{ Strips whitespace from the beginning and end of a string */</a>
<a name="864"><span class="lineNum">     864 </span><span class="lineCov">        549 : PHP_FUNCTION(trim)</span></a>
<a name="865"><span class="lineNum">     865 </span>            : {</a>
<a name="866"><span class="lineNum">     866 </span>            :         php_do_trim(INTERNAL_FUNCTION_PARAM_PASSTHRU, 3);</a>
<a name="867"><span class="lineNum">     867 </span><span class="lineCov">        549 : }</span></a>
<a name="868"><span class="lineNum">     868 </span>            : /* }}} */</a>
<a name="869"><span class="lineNum">     869 </span>            : </a>
<a name="870"><span class="lineNum">     870 </span>            : /* {{{ Removes trailing whitespace */</a>
<a name="871"><span class="lineNum">     871 </span><span class="lineCov">        387 : PHP_FUNCTION(rtrim)</span></a>
<a name="872"><span class="lineNum">     872 </span>            : {</a>
<a name="873"><span class="lineNum">     873 </span>            :         php_do_trim(INTERNAL_FUNCTION_PARAM_PASSTHRU, 2);</a>
<a name="874"><span class="lineNum">     874 </span><span class="lineCov">        387 : }</span></a>
<a name="875"><span class="lineNum">     875 </span>            : /* }}} */</a>
<a name="876"><span class="lineNum">     876 </span>            : </a>
<a name="877"><span class="lineNum">     877 </span>            : /* {{{ Strips whitespace from the beginning of a string */</a>
<a name="878"><span class="lineNum">     878 </span><span class="lineCov">        270 : PHP_FUNCTION(ltrim)</span></a>
<a name="879"><span class="lineNum">     879 </span>            : {</a>
<a name="880"><span class="lineNum">     880 </span>            :         php_do_trim(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1);</a>
<a name="881"><span class="lineNum">     881 </span><span class="lineCov">        270 : }</span></a>
<a name="882"><span class="lineNum">     882 </span>            : /* }}} */</a>
<a name="883"><span class="lineNum">     883 </span>            : </a>
<a name="884"><span class="lineNum">     884 </span>            : /* {{{ Wraps buffer to selected number of characters using string break char */</a>
<a name="885"><span class="lineNum">     885 </span><span class="lineCov">        171 : PHP_FUNCTION(wordwrap)</span></a>
<a name="886"><span class="lineNum">     886 </span>            : {</a>
<a name="887"><span class="lineNum">     887 </span>            :         zend_string *text;</a>
<a name="888"><span class="lineNum">     888 </span><span class="lineCov">        171 :         char *breakchar = &quot;\n&quot;;</span></a>
<a name="889"><span class="lineNum">     889 </span><span class="lineCov">        171 :         size_t newtextlen, chk, breakchar_len = 1;</span></a>
<a name="890"><span class="lineNum">     890 </span>            :         size_t alloced;</a>
<a name="891"><span class="lineNum">     891 </span><span class="lineCov">        171 :         zend_long current = 0, laststart = 0, lastspace = 0;</span></a>
<a name="892"><span class="lineNum">     892 </span><span class="lineCov">        171 :         zend_long linelength = 75;</span></a>
<a name="893"><span class="lineNum">     893 </span><span class="lineCov">        171 :         bool docut = 0;</span></a>
<a name="894"><span class="lineNum">     894 </span>            :         zend_string *newtext;</a>
<a name="895"><span class="lineNum">     895 </span>            : </a>
<a name="896"><span class="lineNum">     896 </span><span class="lineCov">        171 :         ZEND_PARSE_PARAMETERS_START(1, 4)</span></a>
<a name="897"><span class="lineNum">     897 </span><span class="lineCov">        282 :                 Z_PARAM_STR(text)</span></a>
<a name="898"><span class="lineNum">     898 </span><span class="lineCov">        129 :                 Z_PARAM_OPTIONAL</span></a>
<a name="899"><span class="lineNum">     899 </span><span class="lineCov">        249 :                 Z_PARAM_LONG(linelength)</span></a>
<a name="900"><span class="lineNum">     900 </span><span class="lineCov">        222 :                 Z_PARAM_STRING(breakchar, breakchar_len)</span></a>
<a name="901"><span class="lineNum">     901 </span><span class="lineCov">        165 :                 Z_PARAM_BOOL(docut)</span></a>
<a name="902"><span class="lineNum">     902 </span><span class="lineCov">        171 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="903"><span class="lineNum">     903 </span>            : </a>
<a name="904"><span class="lineNum">     904 </span><span class="lineCov">        129 :         if (ZSTR_LEN(text) == 0) {</span></a>
<a name="905"><span class="lineNum">     905 </span><span class="lineCov">         12 :                 RETURN_EMPTY_STRING();</span></a>
<a name="906"><span class="lineNum">     906 </span>            :         }</a>
<a name="907"><span class="lineNum">     907 </span>            : </a>
<a name="908"><span class="lineNum">     908 </span><span class="lineCov">        117 :         if (breakchar_len == 0) {</span></a>
<a name="909"><span class="lineNum">     909 </span><span class="lineCov">          3 :                 zend_argument_value_error(3, &quot;cannot be empty&quot;);</span></a>
<a name="910"><span class="lineNum">     910 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="911"><span class="lineNum">     911 </span>            :         }</a>
<a name="912"><span class="lineNum">     912 </span>            : </a>
<a name="913"><span class="lineNum">     913 </span><span class="lineCov">        114 :         if (linelength == 0 &amp;&amp; docut) {</span></a>
<a name="914"><span class="lineNum">     914 </span><span class="lineCov">          3 :                 zend_argument_value_error(4, &quot;cannot be true when argument #2 ($width) is 0&quot;);</span></a>
<a name="915"><span class="lineNum">     915 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="916"><span class="lineNum">     916 </span>            :         }</a>
<a name="917"><span class="lineNum">     917 </span>            : </a>
<a name="918"><span class="lineNum">     918 </span>            :         /* Special case for a single-character break as it needs no</a>
<a name="919"><span class="lineNum">     919 </span>            :            additional storage space */</a>
<a name="920"><span class="lineNum">     920 </span><span class="lineCov">        111 :         if (breakchar_len == 1 &amp;&amp; !docut) {</span></a>
<a name="921"><span class="lineNum">     921 </span><span class="lineCov">         27 :                 newtext = zend_string_init(ZSTR_VAL(text), ZSTR_LEN(text), 0);</span></a>
<a name="922"><span class="lineNum">     922 </span>            : </a>
<a name="923"><span class="lineNum">     923 </span><span class="lineCov">         27 :                 laststart = lastspace = 0;</span></a>
<a name="924"><span class="lineNum">     924 </span><span class="lineCov">       1173 :                 for (current = 0; current &lt; (zend_long)ZSTR_LEN(text); current++) {</span></a>
<a name="925"><span class="lineNum">     925 </span><span class="lineCov">       1146 :                         if (ZSTR_VAL(text)[current] == breakchar[0]) {</span></a>
<a name="926"><span class="lineNum">     926 </span><span class="lineCov">         12 :                                 laststart = lastspace = current + 1;</span></a>
<a name="927"><span class="lineNum">     927 </span><span class="lineCov">       1134 :                         } else if (ZSTR_VAL(text)[current] == ' ') {</span></a>
<a name="928"><span class="lineNum">     928 </span><span class="lineCov">        102 :                                 if (current - laststart &gt;= linelength) {</span></a>
<a name="929"><span class="lineNum">     929 </span><span class="lineCov">         24 :                                         ZSTR_VAL(newtext)[current] = breakchar[0];</span></a>
<a name="930"><span class="lineNum">     930 </span><span class="lineCov">         24 :                                         laststart = current + 1;</span></a>
<a name="931"><span class="lineNum">     931 </span>            :                                 }</a>
<a name="932"><span class="lineNum">     932 </span><span class="lineCov">        102 :                                 lastspace = current;</span></a>
<a name="933"><span class="lineNum">     933 </span><span class="lineCov">       1032 :                         } else if (current - laststart &gt;= linelength &amp;&amp; laststart != lastspace) {</span></a>
<a name="934"><span class="lineNum">     934 </span><span class="lineCov">         96 :                                 ZSTR_VAL(newtext)[lastspace] = breakchar[0];</span></a>
<a name="935"><span class="lineNum">     935 </span><span class="lineCov">         96 :                                 laststart = lastspace + 1;</span></a>
<a name="936"><span class="lineNum">     936 </span>            :                         }</a>
<a name="937"><span class="lineNum">     937 </span>            :                 }</a>
<a name="938"><span class="lineNum">     938 </span>            : </a>
<a name="939"><span class="lineNum">     939 </span><span class="lineCov">         27 :                 RETURN_NEW_STR(newtext);</span></a>
<a name="940"><span class="lineNum">     940 </span>            :         } else {</a>
<a name="941"><span class="lineNum">     941 </span>            :                 /* Multiple character line break or forced cut */</a>
<a name="942"><span class="lineNum">     942 </span><span class="lineCov">         84 :                 if (linelength &gt; 0) {</span></a>
<a name="943"><span class="lineNum">     943 </span><span class="lineCov">         72 :                         chk = (size_t)(ZSTR_LEN(text)/linelength + 1);</span></a>
<a name="944"><span class="lineNum">     944 </span><span class="lineCov">         72 :                         newtext = zend_string_safe_alloc(chk, breakchar_len, ZSTR_LEN(text), 0);</span></a>
<a name="945"><span class="lineNum">     945 </span><span class="lineCov">         69 :                         alloced = ZSTR_LEN(text) + chk * breakchar_len + 1;</span></a>
<a name="946"><span class="lineNum">     946 </span>            :                 } else {</a>
<a name="947"><span class="lineNum">     947 </span><span class="lineCov">         12 :                         chk = ZSTR_LEN(text);</span></a>
<a name="948"><span class="lineNum">     948 </span><span class="lineCov">         12 :                         alloced = ZSTR_LEN(text) * (breakchar_len + 1) + 1;</span></a>
<a name="949"><span class="lineNum">     949 </span><span class="lineCov">         24 :                         newtext = zend_string_safe_alloc(ZSTR_LEN(text), breakchar_len + 1, 0, 0);</span></a>
<a name="950"><span class="lineNum">     950 </span>            :                 }</a>
<a name="951"><span class="lineNum">     951 </span>            : </a>
<a name="952"><span class="lineNum">     952 </span>            :                 /* now keep track of the actual new text length */</a>
<a name="953"><span class="lineNum">     953 </span><span class="lineCov">         81 :                 newtextlen = 0;</span></a>
<a name="954"><span class="lineNum">     954 </span>            : </a>
<a name="955"><span class="lineNum">     955 </span><span class="lineCov">         81 :                 laststart = lastspace = 0;</span></a>
<a name="956"><span class="lineNum">     956 </span><span class="lineCov">       2520 :                 for (current = 0; current &lt; (zend_long)ZSTR_LEN(text); current++) {</span></a>
<a name="957"><span class="lineNum">     957 </span><span class="lineCov">       2439 :                         if (chk == 0) {</span></a>
<a name="958"><span class="lineNum">     958 </span><span class="lineCov">         18 :                                 alloced += (size_t) (((ZSTR_LEN(text) - current + 1)/linelength + 1) * breakchar_len) + 1;</span></a>
<a name="959"><span class="lineNum">     959 </span><span class="lineCov">         18 :                                 newtext = zend_string_extend(newtext, alloced, 0);</span></a>
<a name="960"><span class="lineNum">     960 </span><span class="lineCov">         18 :                                 chk = (size_t) ((ZSTR_LEN(text) - current)/linelength) + 1;</span></a>
<a name="961"><span class="lineNum">     961 </span>            :                         }</a>
<a name="962"><span class="lineNum">     962 </span>            :                         /* when we hit an existing break, copy to new buffer, and</a>
<a name="963"><span class="lineNum">     963 </span>            :                          * fix up laststart and lastspace */</a>
<a name="964"><span class="lineNum">     964 </span><span class="lineCov">       2439 :                         if (ZSTR_VAL(text)[current] == breakchar[0]</span></a>
<a name="965"><span class="lineNum">     965 </span><span class="lineCov">         60 :                                 &amp;&amp; current + breakchar_len &lt; ZSTR_LEN(text)</span></a>
<a name="966"><span class="lineNum">     966 </span><span class="lineCov">         60 :                                 &amp;&amp; !strncmp(ZSTR_VAL(text) + current, breakchar, breakchar_len)) {</span></a>
<a name="967"><span class="lineNum">     967 </span><span class="lineCov">         42 :                                 memcpy(ZSTR_VAL(newtext) + newtextlen, ZSTR_VAL(text) + laststart, current - laststart + breakchar_len);</span></a>
<a name="968"><span class="lineNum">     968 </span><span class="lineCov">         42 :                                 newtextlen += current - laststart + breakchar_len;</span></a>
<a name="969"><span class="lineNum">     969 </span><span class="lineCov">         42 :                                 current += breakchar_len - 1;</span></a>
<a name="970"><span class="lineNum">     970 </span><span class="lineCov">         42 :                                 laststart = lastspace = current + 1;</span></a>
<a name="971"><span class="lineNum">     971 </span><span class="lineCov">         42 :                                 chk--;</span></a>
<a name="972"><span class="lineNum">     972 </span>            :                         }</a>
<a name="973"><span class="lineNum">     973 </span>            :                         /* if it is a space, check if it is at the line boundary,</a>
<a name="974"><span class="lineNum">     974 </span>            :                          * copy and insert a break, or just keep track of it */</a>
<a name="975"><span class="lineNum">     975 </span><span class="lineCov">       2397 :                         else if (ZSTR_VAL(text)[current] == ' ') {</span></a>
<a name="976"><span class="lineNum">     976 </span><span class="lineCov">        246 :                                 if (current - laststart &gt;= linelength) {</span></a>
<a name="977"><span class="lineNum">     977 </span><span class="lineCov">         99 :                                         memcpy(ZSTR_VAL(newtext) + newtextlen, ZSTR_VAL(text) + laststart, current - laststart);</span></a>
<a name="978"><span class="lineNum">     978 </span><span class="lineCov">         99 :                                         newtextlen += current - laststart;</span></a>
<a name="979"><span class="lineNum">     979 </span><span class="lineCov">         99 :                                         memcpy(ZSTR_VAL(newtext) + newtextlen, breakchar, breakchar_len);</span></a>
<a name="980"><span class="lineNum">     980 </span><span class="lineCov">         99 :                                         newtextlen += breakchar_len;</span></a>
<a name="981"><span class="lineNum">     981 </span><span class="lineCov">         99 :                                         laststart = current + 1;</span></a>
<a name="982"><span class="lineNum">     982 </span><span class="lineCov">         99 :                                         chk--;</span></a>
<a name="983"><span class="lineNum">     983 </span>            :                                 }</a>
<a name="984"><span class="lineNum">     984 </span><span class="lineCov">        246 :                                 lastspace = current;</span></a>
<a name="985"><span class="lineNum">     985 </span>            :                         }</a>
<a name="986"><span class="lineNum">     986 </span>            :                         /* if we are cutting, and we've accumulated enough</a>
<a name="987"><span class="lineNum">     987 </span>            :                          * characters, and we haven't see a space for this line,</a>
<a name="988"><span class="lineNum">     988 </span>            :                          * copy and insert a break. */</a>
<a name="989"><span class="lineNum">     989 </span><span class="lineCov">       2151 :                         else if (current - laststart &gt;= linelength</span></a>
<a name="990"><span class="lineNum">     990 </span><span class="lineCov">        693 :                                         &amp;&amp; docut &amp;&amp; laststart &gt;= lastspace) {</span></a>
<a name="991"><span class="lineNum">     991 </span><span class="lineCov">        213 :                                 memcpy(ZSTR_VAL(newtext) + newtextlen, ZSTR_VAL(text) + laststart, current - laststart);</span></a>
<a name="992"><span class="lineNum">     992 </span><span class="lineCov">        213 :                                 newtextlen += current - laststart;</span></a>
<a name="993"><span class="lineNum">     993 </span><span class="lineCov">        213 :                                 memcpy(ZSTR_VAL(newtext) + newtextlen, breakchar, breakchar_len);</span></a>
<a name="994"><span class="lineNum">     994 </span><span class="lineCov">        213 :                                 newtextlen += breakchar_len;</span></a>
<a name="995"><span class="lineNum">     995 </span><span class="lineCov">        213 :                                 laststart = lastspace = current;</span></a>
<a name="996"><span class="lineNum">     996 </span><span class="lineCov">        213 :                                 chk--;</span></a>
<a name="997"><span class="lineNum">     997 </span>            :                         }</a>
<a name="998"><span class="lineNum">     998 </span>            :                         /* if the current word puts us over the linelength, copy</a>
<a name="999"><span class="lineNum">     999 </span>            :                          * back up until the last space, insert a break, and move</a>
<a name="1000"><span class="lineNum">    1000 </span>            :                          * up the laststart */</a>
<a name="1001"><span class="lineNum">    1001 </span><span class="lineCov">       1938 :                         else if (current - laststart &gt;= linelength</span></a>
<a name="1002"><span class="lineNum">    1002 </span><span class="lineCov">        480 :                                         &amp;&amp; laststart &lt; lastspace) {</span></a>
<a name="1003"><span class="lineNum">    1003 </span><span class="lineCov">         81 :                                 memcpy(ZSTR_VAL(newtext) + newtextlen, ZSTR_VAL(text) + laststart, lastspace - laststart);</span></a>
<a name="1004"><span class="lineNum">    1004 </span><span class="lineCov">         81 :                                 newtextlen += lastspace - laststart;</span></a>
<a name="1005"><span class="lineNum">    1005 </span><span class="lineCov">         81 :                                 memcpy(ZSTR_VAL(newtext) + newtextlen, breakchar, breakchar_len);</span></a>
<a name="1006"><span class="lineNum">    1006 </span><span class="lineCov">         81 :                                 newtextlen += breakchar_len;</span></a>
<a name="1007"><span class="lineNum">    1007 </span><span class="lineCov">         81 :                                 laststart = lastspace = lastspace + 1;</span></a>
<a name="1008"><span class="lineNum">    1008 </span><span class="lineCov">         81 :                                 chk--;</span></a>
<a name="1009"><span class="lineNum">    1009 </span>            :                         }</a>
<a name="1010"><span class="lineNum">    1010 </span>            :                 }</a>
<a name="1011"><span class="lineNum">    1011 </span>            : </a>
<a name="1012"><span class="lineNum">    1012 </span>            :                 /* copy over any stragglers */</a>
<a name="1013"><span class="lineNum">    1013 </span><span class="lineCov">         81 :                 if (laststart != current) {</span></a>
<a name="1014"><span class="lineNum">    1014 </span><span class="lineCov">         81 :                         memcpy(ZSTR_VAL(newtext) + newtextlen, ZSTR_VAL(text) + laststart, current - laststart);</span></a>
<a name="1015"><span class="lineNum">    1015 </span><span class="lineCov">         81 :                         newtextlen += current - laststart;</span></a>
<a name="1016"><span class="lineNum">    1016 </span>            :                 }</a>
<a name="1017"><span class="lineNum">    1017 </span>            : </a>
<a name="1018"><span class="lineNum">    1018 </span><span class="lineCov">         81 :                 ZSTR_VAL(newtext)[newtextlen] = '\0';</span></a>
<a name="1019"><span class="lineNum">    1019 </span>            :                 /* free unused memory */</a>
<a name="1020"><span class="lineNum">    1020 </span><span class="lineCov">         81 :                 newtext = zend_string_truncate(newtext, newtextlen, 0);</span></a>
<a name="1021"><span class="lineNum">    1021 </span>            : </a>
<a name="1022"><span class="lineNum">    1022 </span><span class="lineCov">         81 :                 RETURN_NEW_STR(newtext);</span></a>
<a name="1023"><span class="lineNum">    1023 </span>            :         }</a>
<a name="1024"><span class="lineNum">    1024 </span>            : }</a>
<a name="1025"><span class="lineNum">    1025 </span>            : /* }}} */</a>
<a name="1026"><span class="lineNum">    1026 </span>            : </a>
<a name="1027"><span class="lineNum">    1027 </span>            : /* {{{ php_explode */</a>
<a name="1028"><span class="lineNum">    1028 </span><span class="lineCov">     300637 : PHPAPI void php_explode(const zend_string *delim, zend_string *str, zval *return_value, zend_long limit)</span></a>
<a name="1029"><span class="lineNum">    1029 </span>            : {</a>
<a name="1030"><span class="lineNum">    1030 </span><span class="lineCov">     300637 :         const char *p1 = ZSTR_VAL(str);</span></a>
<a name="1031"><span class="lineNum">    1031 </span><span class="lineCov">     300637 :         const char *endp = ZSTR_VAL(str) + ZSTR_LEN(str);</span></a>
<a name="1032"><span class="lineNum">    1032 </span><span class="lineCov">     300637 :         const char *p2 = php_memnstr(ZSTR_VAL(str), ZSTR_VAL(delim), ZSTR_LEN(delim), endp);</span></a>
<a name="1033"><span class="lineNum">    1033 </span>            :         zval  tmp;</a>
<a name="1034"><span class="lineNum">    1034 </span>            : </a>
<a name="1035"><span class="lineNum">    1035 </span><span class="lineCov">     300637 :         if (p2 == NULL) {</span></a>
<a name="1036"><span class="lineNum">    1036 </span><span class="lineCov">        186 :                 ZVAL_STR_COPY(&amp;tmp, str);</span></a>
<a name="1037"><span class="lineNum">    1037 </span><span class="lineCov">         66 :                 zend_hash_next_index_insert_new(Z_ARRVAL_P(return_value), &amp;tmp);</span></a>
<a name="1038"><span class="lineNum">    1038 </span>            :         } else {</a>
<a name="1039"><span class="lineNum">    1039 </span><span class="lineCov">     300571 :                 zend_hash_real_init_packed(Z_ARRVAL_P(return_value));</span></a>
<a name="1040"><span class="lineNum">    1040 </span><span class="lineCov">     300571 :                 ZEND_HASH_FILL_PACKED(Z_ARRVAL_P(return_value)) {</span></a>
<a name="1041"><span class="lineNum">    1041 </span>            :                         do {</a>
<a name="1042"><span class="lineNum">    1042 </span><span class="lineCov">     301061 :                                 ZEND_HASH_FILL_GROW();</span></a>
<a name="1043"><span class="lineNum">    1043 </span><span class="lineCov">     903183 :                                 ZEND_HASH_FILL_SET_STR(zend_string_init_fast(p1, p2 - p1));</span></a>
<a name="1044"><span class="lineNum">    1044 </span><span class="lineCov">     301061 :                                 ZEND_HASH_FILL_NEXT();</span></a>
<a name="1045"><span class="lineNum">    1045 </span><span class="lineCov">     301061 :                                 p1 = p2 + ZSTR_LEN(delim);</span></a>
<a name="1046"><span class="lineNum">    1046 </span><span class="lineCov">     301061 :                                 p2 = php_memnstr(p1, ZSTR_VAL(delim), ZSTR_LEN(delim), endp);</span></a>
<a name="1047"><span class="lineNum">    1047 </span><span class="lineCov">     301061 :                         } while (p2 != NULL &amp;&amp; --limit &gt; 1);</span></a>
<a name="1048"><span class="lineNum">    1048 </span>            : </a>
<a name="1049"><span class="lineNum">    1049 </span><span class="lineCov">     300571 :                         if (p1 &lt;= endp) {</span></a>
<a name="1050"><span class="lineNum">    1050 </span><span class="lineCov">     300571 :                                 ZEND_HASH_FILL_GROW();</span></a>
<a name="1051"><span class="lineNum">    1051 </span><span class="lineCov">     901713 :                                 ZEND_HASH_FILL_SET_STR(zend_string_init_fast(p1, endp - p1));</span></a>
<a name="1052"><span class="lineNum">    1052 </span><span class="lineCov">     300571 :                                 ZEND_HASH_FILL_NEXT();</span></a>
<a name="1053"><span class="lineNum">    1053 </span>            :                         }</a>
<a name="1054"><span class="lineNum">    1054 </span><span class="lineCov">     300571 :                 } ZEND_HASH_FILL_END();</span></a>
<a name="1055"><span class="lineNum">    1055 </span>            :         }</a>
<a name="1056"><span class="lineNum">    1056 </span><span class="lineCov">     300637 : }</span></a>
<a name="1057"><span class="lineNum">    1057 </span>            : /* }}} */</a>
<a name="1058"><span class="lineNum">    1058 </span>            : </a>
<a name="1059"><span class="lineNum">    1059 </span>            : /* {{{ php_explode_negative_limit */</a>
<a name="1060"><span class="lineNum">    1060 </span><span class="lineCov">         63 : PHPAPI void php_explode_negative_limit(const zend_string *delim, zend_string *str, zval *return_value, zend_long limit)</span></a>
<a name="1061"><span class="lineNum">    1061 </span>            : {</a>
<a name="1062"><span class="lineNum">    1062 </span>            : #define EXPLODE_ALLOC_STEP 64</a>
<a name="1063"><span class="lineNum">    1063 </span><span class="lineCov">         63 :         const char *p1 = ZSTR_VAL(str);</span></a>
<a name="1064"><span class="lineNum">    1064 </span><span class="lineCov">         63 :         const char *endp = ZSTR_VAL(str) + ZSTR_LEN(str);</span></a>
<a name="1065"><span class="lineNum">    1065 </span><span class="lineCov">         63 :         const char *p2 = php_memnstr(ZSTR_VAL(str), ZSTR_VAL(delim), ZSTR_LEN(delim), endp);</span></a>
<a name="1066"><span class="lineNum">    1066 </span>            :         zval  tmp;</a>
<a name="1067"><span class="lineNum">    1067 </span>            : </a>
<a name="1068"><span class="lineNum">    1068 </span><span class="lineCov">         63 :         if (p2 == NULL) {</span></a>
<a name="1069"><span class="lineNum">    1069 </span>            :                 /*</a>
<a name="1070"><span class="lineNum">    1070 </span>            :                 do nothing since limit &lt;= -1, thus if only one chunk - 1 + (limit) &lt;= 0</a>
<a name="1071"><span class="lineNum">    1071 </span>            :                 by doing nothing we return empty array</a>
<a name="1072"><span class="lineNum">    1072 </span>            :                 */</a>
<a name="1073"><span class="lineNum">    1073 </span>            :         } else {</a>
<a name="1074"><span class="lineNum">    1074 </span><span class="lineCov">         60 :                 size_t allocated = EXPLODE_ALLOC_STEP, found = 0;</span></a>
<a name="1075"><span class="lineNum">    1075 </span>            :                 zend_long i, to_return;</a>
<a name="1076"><span class="lineNum">    1076 </span><span class="lineCov">         60 :                 const char **positions = emalloc(allocated * sizeof(char *));</span></a>
<a name="1077"><span class="lineNum">    1077 </span>            : </a>
<a name="1078"><span class="lineNum">    1078 </span><span class="lineCov">         60 :                 positions[found++] = p1;</span></a>
<a name="1079"><span class="lineNum">    1079 </span>            :                 do {</a>
<a name="1080"><span class="lineNum">    1080 </span><span class="lineCov">        504 :                         if (found &gt;= allocated) {</span></a>
<a name="1081"><span class="lineNum">    1081 </span><span class="lineCov">          3 :                                 allocated = found + EXPLODE_ALLOC_STEP;/* make sure we have enough memory */</span></a>
<a name="1082"><span class="lineNum">    1082 </span><span class="lineCov">          3 :                                 positions = erealloc(ZEND_VOIDP(positions), allocated*sizeof(char *));</span></a>
<a name="1083"><span class="lineNum">    1083 </span>            :                         }</a>
<a name="1084"><span class="lineNum">    1084 </span><span class="lineCov">        504 :                         positions[found++] = p1 = p2 + ZSTR_LEN(delim);</span></a>
<a name="1085"><span class="lineNum">    1085 </span><span class="lineCov">        504 :                         p2 = php_memnstr(p1, ZSTR_VAL(delim), ZSTR_LEN(delim), endp);</span></a>
<a name="1086"><span class="lineNum">    1086 </span><span class="lineCov">        504 :                 } while (p2 != NULL);</span></a>
<a name="1087"><span class="lineNum">    1087 </span>            : </a>
<a name="1088"><span class="lineNum">    1088 </span><span class="lineCov">         60 :                 to_return = limit + found;</span></a>
<a name="1089"><span class="lineNum">    1089 </span>            :                 /* limit is at least -1 therefore no need of bounds checking : i will be always less than found */</a>
<a name="1090"><span class="lineNum">    1090 </span><span class="lineCov">        537 :                 for (i = 0; i &lt; to_return; i++) { /* this checks also for to_return &gt; 0 */</span></a>
<a name="1091"><span class="lineNum">    1091 </span><span class="lineCov">        477 :                         ZVAL_STRINGL(&amp;tmp, positions[i], (positions[i+1] - ZSTR_LEN(delim)) - positions[i]);</span></a>
<a name="1092"><span class="lineNum">    1092 </span><span class="lineCov">        477 :                         zend_hash_next_index_insert_new(Z_ARRVAL_P(return_value), &amp;tmp);</span></a>
<a name="1093"><span class="lineNum">    1093 </span>            :                 }</a>
<a name="1094"><span class="lineNum">    1094 </span><span class="lineCov">         60 :                 efree((void *)positions);</span></a>
<a name="1095"><span class="lineNum">    1095 </span>            :         }</a>
<a name="1096"><span class="lineNum">    1096 </span>            : #undef EXPLODE_ALLOC_STEP</a>
<a name="1097"><span class="lineNum">    1097 </span><span class="lineCov">         63 : }</span></a>
<a name="1098"><span class="lineNum">    1098 </span>            : /* }}} */</a>
<a name="1099"><span class="lineNum">    1099 </span>            : </a>
<a name="1100"><span class="lineNum">    1100 </span>            : /* {{{ Splits a string on string separator and return array of components. If limit is positive only limit number of components is returned. If limit is negative all components except the last abs(limit) are returned. */</a>
<a name="1101"><span class="lineNum">    1101 </span><span class="lineCov">     300877 : PHP_FUNCTION(explode)</span></a>
<a name="1102"><span class="lineNum">    1102 </span>            : {</a>
<a name="1103"><span class="lineNum">    1103 </span>            :         zend_string *str, *delim;</a>
<a name="1104"><span class="lineNum">    1104 </span><span class="lineCov">     300877 :         zend_long limit = ZEND_LONG_MAX; /* No limit */</span></a>
<a name="1105"><span class="lineNum">    1105 </span>            :         zval tmp;</a>
<a name="1106"><span class="lineNum">    1106 </span>            : </a>
<a name="1107"><span class="lineNum">    1107 </span><span class="lineCov">     300877 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="1108"><span class="lineNum">    1108 </span><span class="lineCov">     601664 :                 Z_PARAM_STR(delim)</span></a>
<a name="1109"><span class="lineNum">    1109 </span><span class="lineCov">     601652 :                 Z_PARAM_STR(str)</span></a>
<a name="1110"><span class="lineNum">    1110 </span><span class="lineCov">     300826 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1111"><span class="lineNum">    1111 </span><span class="lineCov">     301030 :                 Z_PARAM_LONG(limit)</span></a>
<a name="1112"><span class="lineNum">    1112 </span><span class="lineCov">     300877 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1113"><span class="lineNum">    1113 </span>            : </a>
<a name="1114"><span class="lineNum">    1114 </span><span class="lineCov">     300826 :         if (ZSTR_LEN(delim) == 0) {</span></a>
<a name="1115"><span class="lineNum">    1115 </span><span class="lineCov">         54 :                 zend_argument_value_error(1, &quot;cannot be empty&quot;);</span></a>
<a name="1116"><span class="lineNum">    1116 </span><span class="lineCov">         54 :                 RETURN_THROWS();</span></a>
<a name="1117"><span class="lineNum">    1117 </span>            :         }</a>
<a name="1118"><span class="lineNum">    1118 </span>            : </a>
<a name="1119"><span class="lineNum">    1119 </span><span class="lineCov">     300772 :         array_init(return_value);</span></a>
<a name="1120"><span class="lineNum">    1120 </span>            : </a>
<a name="1121"><span class="lineNum">    1121 </span><span class="lineCov">     300772 :         if (ZSTR_LEN(str) == 0) {</span></a>
<a name="1122"><span class="lineNum">    1122 </span><span class="lineCov">         12 :                 if (limit &gt;= 0) {</span></a>
<a name="1123"><span class="lineNum">    1123 </span><span class="lineCov">          9 :                         ZVAL_EMPTY_STRING(&amp;tmp);</span></a>
<a name="1124"><span class="lineNum">    1124 </span><span class="lineCov">          9 :                         zend_hash_index_add_new(Z_ARRVAL_P(return_value), 0, &amp;tmp);</span></a>
<a name="1125"><span class="lineNum">    1125 </span>            :                 }</a>
<a name="1126"><span class="lineNum">    1126 </span><span class="lineCov">         12 :                 return;</span></a>
<a name="1127"><span class="lineNum">    1127 </span>            :         }</a>
<a name="1128"><span class="lineNum">    1128 </span>            : </a>
<a name="1129"><span class="lineNum">    1129 </span><span class="lineCov">     300760 :         if (limit &gt; 1) {</span></a>
<a name="1130"><span class="lineNum">    1130 </span><span class="lineCov">     300637 :                 php_explode(delim, str, return_value, limit);</span></a>
<a name="1131"><span class="lineNum">    1131 </span><span class="lineCov">        123 :         } else if (limit &lt; 0) {</span></a>
<a name="1132"><span class="lineNum">    1132 </span><span class="lineCov">         63 :                 php_explode_negative_limit(delim, str, return_value, limit);</span></a>
<a name="1133"><span class="lineNum">    1133 </span>            :         } else {</a>
<a name="1134"><span class="lineNum">    1134 </span><span class="lineCov">        120 :                 ZVAL_STR_COPY(&amp;tmp, str);</span></a>
<a name="1135"><span class="lineNum">    1135 </span><span class="lineCov">         60 :                 zend_hash_index_add_new(Z_ARRVAL_P(return_value), 0, &amp;tmp);</span></a>
<a name="1136"><span class="lineNum">    1136 </span>            :         }</a>
<a name="1137"><span class="lineNum">    1137 </span>            : }</a>
<a name="1138"><span class="lineNum">    1138 </span>            : /* }}} */</a>
<a name="1139"><span class="lineNum">    1139 </span>            : </a>
<a name="1140"><span class="lineNum">    1140 </span>            : /* {{{ An alias for implode */</a>
<a name="1141"><span class="lineNum">    1141 </span>            : /* }}} */</a>
<a name="1142"><span class="lineNum">    1142 </span>            : </a>
<a name="1143"><span class="lineNum">    1143 </span>            : /* {{{ php_implode */</a>
<a name="1144"><span class="lineNum">    1144 </span><span class="lineCov">     931158 : PHPAPI void php_implode(const zend_string *glue, HashTable *pieces, zval *return_value)</span></a>
<a name="1145"><span class="lineNum">    1145 </span>            : {</a>
<a name="1146"><span class="lineNum">    1146 </span>            :         zval         *tmp;</a>
<a name="1147"><span class="lineNum">    1147 </span>            :         int           numelems;</a>
<a name="1148"><span class="lineNum">    1148 </span>            :         zend_string  *str;</a>
<a name="1149"><span class="lineNum">    1149 </span>            :         char         *cptr;</a>
<a name="1150"><span class="lineNum">    1150 </span><span class="lineCov">     931158 :         size_t        len = 0;</span></a>
<a name="1151"><span class="lineNum">    1151 </span>            :         struct {</a>
<a name="1152"><span class="lineNum">    1152 </span>            :                 zend_string *str;</a>
<a name="1153"><span class="lineNum">    1153 </span>            :                 zend_long    lval;</a>
<a name="1154"><span class="lineNum">    1154 </span>            :         } *strings, *ptr;</a>
<a name="1155"><span class="lineNum">    1155 </span>            :         ALLOCA_FLAG(use_heap)</a>
<a name="1156"><span class="lineNum">    1156 </span>            : </a>
<a name="1157"><span class="lineNum">    1157 </span><span class="lineCov">     931158 :         numelems = zend_hash_num_elements(pieces);</span></a>
<a name="1158"><span class="lineNum">    1158 </span>            : </a>
<a name="1159"><span class="lineNum">    1159 </span><span class="lineCov">     931158 :         if (numelems == 0) {</span></a>
<a name="1160"><span class="lineNum">    1160 </span><span class="lineCov">        144 :                 RETURN_EMPTY_STRING();</span></a>
<a name="1161"><span class="lineNum">    1161 </span><span class="lineCov">     931014 :         } else if (numelems == 1) {</span></a>
<a name="1162"><span class="lineNum">    1162 </span>            :                 /* loop to search the first not undefined element... */</a>
<a name="1163"><span class="lineNum">    1163 </span><span class="lineCov">        306 :                 ZEND_HASH_FOREACH_VAL(pieces, tmp) {</span></a>
<a name="1164"><span class="lineNum">    1164 </span><span class="lineCov">        459 :                         RETURN_STR(zval_get_string(tmp));</span></a>
<a name="1165"><span class="lineNum">    1165 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="1166"><span class="lineNum">    1166 </span>            :         }</a>
<a name="1167"><span class="lineNum">    1167 </span>            : </a>
<a name="1168"><span class="lineNum">    1168 </span><span class="lineCov">     930861 :         ptr = strings = do_alloca((sizeof(*strings)) * numelems, use_heap);</span></a>
<a name="1169"><span class="lineNum">    1169 </span>            : </a>
<a name="1170"><span class="lineNum">    1170 </span><span class="lineCov">   13667300 :         ZEND_HASH_FOREACH_VAL(pieces, tmp) {</span></a>
<a name="1171"><span class="lineNum">    1171 </span><span class="lineCov">    6368180 :                 if (EXPECTED(Z_TYPE_P(tmp) == IS_STRING)) {</span></a>
<a name="1172"><span class="lineNum">    1172 </span><span class="lineCov">    5285590 :                         ptr-&gt;str = Z_STR_P(tmp);</span></a>
<a name="1173"><span class="lineNum">    1173 </span><span class="lineCov">    5285590 :                         len += ZSTR_LEN(ptr-&gt;str);</span></a>
<a name="1174"><span class="lineNum">    1174 </span><span class="lineCov">    5285590 :                         ptr-&gt;lval = 0;</span></a>
<a name="1175"><span class="lineNum">    1175 </span><span class="lineCov">    5285590 :                         ptr++;</span></a>
<a name="1176"><span class="lineNum">    1176 </span><span class="lineCov">    1082590 :                 } else if (UNEXPECTED(Z_TYPE_P(tmp) == IS_LONG)) {</span></a>
<a name="1177"><span class="lineNum">    1177 </span><span class="lineCov">    1082130 :                         zend_long val = Z_LVAL_P(tmp);</span></a>
<a name="1178"><span class="lineNum">    1178 </span>            : </a>
<a name="1179"><span class="lineNum">    1179 </span><span class="lineCov">    1082130 :                         ptr-&gt;str = NULL;</span></a>
<a name="1180"><span class="lineNum">    1180 </span><span class="lineCov">    1082130 :                         ptr-&gt;lval = val;</span></a>
<a name="1181"><span class="lineNum">    1181 </span><span class="lineCov">    1082130 :                         ptr++;</span></a>
<a name="1182"><span class="lineNum">    1182 </span><span class="lineCov">    1082130 :                         if (val &lt;= 0) {</span></a>
<a name="1183"><span class="lineNum">    1183 </span><span class="lineCov">       1572 :                                 len++;</span></a>
<a name="1184"><span class="lineNum">    1184 </span>            :                         }</a>
<a name="1185"><span class="lineNum">    1185 </span><span class="lineCov">    2163420 :                         while (val) {</span></a>
<a name="1186"><span class="lineNum">    1186 </span><span class="lineCov">    1081280 :                                 val /= 10;</span></a>
<a name="1187"><span class="lineNum">    1187 </span><span class="lineCov">    1081280 :                                 len++;</span></a>
<a name="1188"><span class="lineNum">    1188 </span>            :                         }</a>
<a name="1189"><span class="lineNum">    1189 </span>            :                 } else {</a>
<a name="1190"><span class="lineNum">    1190 </span><span class="lineCov">        453 :                         ptr-&gt;str = zval_get_string_func(tmp);</span></a>
<a name="1191"><span class="lineNum">    1191 </span><span class="lineCov">        453 :                         len += ZSTR_LEN(ptr-&gt;str);</span></a>
<a name="1192"><span class="lineNum">    1192 </span><span class="lineCov">        453 :                         ptr-&gt;lval = 1;</span></a>
<a name="1193"><span class="lineNum">    1193 </span><span class="lineCov">        453 :                         ptr++;</span></a>
<a name="1194"><span class="lineNum">    1194 </span>            :                 }</a>
<a name="1195"><span class="lineNum">    1195 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="1196"><span class="lineNum">    1196 </span>            : </a>
<a name="1197"><span class="lineNum">    1197 </span>            :         /* numelems cannot be 0, we checked above */</a>
<a name="1198"><span class="lineNum">    1198 </span><span class="lineCov">     930861 :         str = zend_string_safe_alloc(numelems - 1, ZSTR_LEN(glue), len, 0);</span></a>
<a name="1199"><span class="lineNum">    1199 </span><span class="lineCov">     930861 :         cptr = ZSTR_VAL(str) + ZSTR_LEN(str);</span></a>
<a name="1200"><span class="lineNum">    1200 </span><span class="lineCov">     930861 :         *cptr = 0;</span></a>
<a name="1201"><span class="lineNum">    1201 </span>            : </a>
<a name="1202"><span class="lineNum">    1202 </span>            :         while (1) {</a>
<a name="1203"><span class="lineNum">    1203 </span><span class="lineCov">    6368180 :                 ptr--;</span></a>
<a name="1204"><span class="lineNum">    1204 </span><span class="lineCov">    6368180 :                 if (EXPECTED(ptr-&gt;str)) {</span></a>
<a name="1205"><span class="lineNum">    1205 </span><span class="lineCov">    5286040 :                         cptr -= ZSTR_LEN(ptr-&gt;str);</span></a>
<a name="1206"><span class="lineNum">    1206 </span><span class="lineCov">    5286040 :                         memcpy(cptr, ZSTR_VAL(ptr-&gt;str), ZSTR_LEN(ptr-&gt;str));</span></a>
<a name="1207"><span class="lineNum">    1207 </span><span class="lineCov">    5286040 :                         if (ptr-&gt;lval) {</span></a>
<a name="1208"><span class="lineNum">    1208 </span><span class="lineCov">        453 :                                 zend_string_release_ex(ptr-&gt;str, 0);</span></a>
<a name="1209"><span class="lineNum">    1209 </span>            :                         }</a>
<a name="1210"><span class="lineNum">    1210 </span>            :                 } else {</a>
<a name="1211"><span class="lineNum">    1211 </span><span class="lineCov">    1082130 :                         char *oldPtr = cptr;</span></a>
<a name="1212"><span class="lineNum">    1212 </span><span class="lineCov">    1082130 :                         char oldVal = *cptr;</span></a>
<a name="1213"><span class="lineNum">    1213 </span><span class="lineCov">    1082130 :                         cptr = zend_print_long_to_buf(cptr, ptr-&gt;lval);</span></a>
<a name="1214"><span class="lineNum">    1214 </span><span class="lineCov">    1082130 :                         *oldPtr = oldVal;</span></a>
<a name="1215"><span class="lineNum">    1215 </span>            :                 }</a>
<a name="1216"><span class="lineNum">    1216 </span>            : </a>
<a name="1217"><span class="lineNum">    1217 </span><span class="lineCov">    6368180 :                 if (ptr == strings) {</span></a>
<a name="1218"><span class="lineNum">    1218 </span><span class="lineCov">     930861 :                         break;</span></a>
<a name="1219"><span class="lineNum">    1219 </span>            :                 }</a>
<a name="1220"><span class="lineNum">    1220 </span>            : </a>
<a name="1221"><span class="lineNum">    1221 </span><span class="lineCov">    5437320 :                 cptr -= ZSTR_LEN(glue);</span></a>
<a name="1222"><span class="lineNum">    1222 </span><span class="lineCov">    5437320 :                 memcpy(cptr, ZSTR_VAL(glue), ZSTR_LEN(glue));</span></a>
<a name="1223"><span class="lineNum">    1223 </span>            :         }</a>
<a name="1224"><span class="lineNum">    1224 </span>            : </a>
<a name="1225"><span class="lineNum">    1225 </span><span class="lineCov">     930861 :         free_alloca(strings, use_heap);</span></a>
<a name="1226"><span class="lineNum">    1226 </span><span class="lineCov">     930861 :         RETURN_NEW_STR(str);</span></a>
<a name="1227"><span class="lineNum">    1227 </span>            : }</a>
<a name="1228"><span class="lineNum">    1228 </span>            : /* }}} */</a>
<a name="1229"><span class="lineNum">    1229 </span>            : </a>
<a name="1230"><span class="lineNum">    1230 </span>            : /* {{{ Joins array elements placing glue string between items and return one string */</a>
<a name="1231"><span class="lineNum">    1231 </span><span class="lineCov">     931386 : PHP_FUNCTION(implode)</span></a>
<a name="1232"><span class="lineNum">    1232 </span>            : {</a>
<a name="1233"><span class="lineNum">    1233 </span><span class="lineCov">     931386 :         zend_string *arg1_str = NULL;</span></a>
<a name="1234"><span class="lineNum">    1234 </span><span class="lineCov">     931386 :         HashTable *arg1_array = NULL;</span></a>
<a name="1235"><span class="lineNum">    1235 </span><span class="lineCov">     931386 :         zend_array *pieces = NULL;</span></a>
<a name="1236"><span class="lineNum">    1236 </span>            : </a>
<a name="1237"><span class="lineNum">    1237 </span><span class="lineCov">     931386 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="1238"><span class="lineNum">    1238 </span><span class="lineCov">    1862600 :                 Z_PARAM_ARRAY_HT_OR_STR(arg1_array, arg1_str)</span></a>
<a name="1239"><span class="lineNum">    1239 </span><span class="lineCov">     931287 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1240"><span class="lineNum">    1240 </span><span class="lineCov">    1862540 :                 Z_PARAM_ARRAY_HT_OR_NULL(pieces)</span></a>
<a name="1241"><span class="lineNum">    1241 </span><span class="lineCov">     931449 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1242"><span class="lineNum">    1242 </span>            : </a>
<a name="1243"><span class="lineNum">    1243 </span><span class="lineCov">     931221 :         if (pieces == NULL) {</span></a>
<a name="1244"><span class="lineNum">    1244 </span><span class="lineCov">         54 :                 if (arg1_array == NULL) {</span></a>
<a name="1245"><span class="lineNum">    1245 </span><span class="lineCov">         36 :                         zend_type_error(&quot;%s(): Argument #1 ($pieces) must be of type array, string given&quot;, get_active_function_name());</span></a>
<a name="1246"><span class="lineNum">    1246 </span><span class="lineCov">         36 :                         RETURN_THROWS();</span></a>
<a name="1247"><span class="lineNum">    1247 </span>            :                 }</a>
<a name="1248"><span class="lineNum">    1248 </span>            : </a>
<a name="1249"><span class="lineNum">    1249 </span><span class="lineCov">         18 :                 arg1_str = ZSTR_EMPTY_ALLOC();</span></a>
<a name="1250"><span class="lineNum">    1250 </span><span class="lineCov">         18 :                 pieces = arg1_array;</span></a>
<a name="1251"><span class="lineNum">    1251 </span>            :         } else {</a>
<a name="1252"><span class="lineNum">    1252 </span><span class="lineCov">     931167 :                 if (arg1_str == NULL) {</span></a>
<a name="1253"><span class="lineNum">    1253 </span><span class="lineCov">         27 :                         zend_argument_type_error(1, &quot;must be of type string, array given&quot;);</span></a>
<a name="1254"><span class="lineNum">    1254 </span><span class="lineCov">         27 :                         RETURN_THROWS();</span></a>
<a name="1255"><span class="lineNum">    1255 </span>            :                 }</a>
<a name="1256"><span class="lineNum">    1256 </span>            :         }</a>
<a name="1257"><span class="lineNum">    1257 </span>            : </a>
<a name="1258"><span class="lineNum">    1258 </span><span class="lineCov">     931158 :         php_implode(arg1_str, pieces, return_value);</span></a>
<a name="1259"><span class="lineNum">    1259 </span>            : }</a>
<a name="1260"><span class="lineNum">    1260 </span>            : /* }}} */</a>
<a name="1261"><span class="lineNum">    1261 </span>            : </a>
<a name="1262"><span class="lineNum">    1262 </span>            : #define STRTOK_TABLE(p) BG(strtok_table)[(unsigned char) *p]</a>
<a name="1263"><span class="lineNum">    1263 </span>            : </a>
<a name="1264"><span class="lineNum">    1264 </span>            : /* {{{ Tokenize a string */</a>
<a name="1265"><span class="lineNum">    1265 </span><span class="lineCov">        921 : PHP_FUNCTION(strtok)</span></a>
<a name="1266"><span class="lineNum">    1266 </span>            : {</a>
<a name="1267"><span class="lineNum">    1267 </span><span class="lineCov">        921 :         zend_string *str, *tok = NULL;</span></a>
<a name="1268"><span class="lineNum">    1268 </span>            :         char *token;</a>
<a name="1269"><span class="lineNum">    1269 </span>            :         char *token_end;</a>
<a name="1270"><span class="lineNum">    1270 </span>            :         char *p;</a>
<a name="1271"><span class="lineNum">    1271 </span>            :         char *pe;</a>
<a name="1272"><span class="lineNum">    1272 </span><span class="lineCov">        921 :         size_t skipped = 0;</span></a>
<a name="1273"><span class="lineNum">    1273 </span>            : </a>
<a name="1274"><span class="lineNum">    1274 </span><span class="lineCov">        921 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="1275"><span class="lineNum">    1275 </span><span class="lineCov">       1758 :                 Z_PARAM_STR(str)</span></a>
<a name="1276"><span class="lineNum">    1276 </span><span class="lineCov">        873 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1277"><span class="lineNum">    1277 </span><span class="lineCov">       1023 :                 Z_PARAM_STR_OR_NULL(tok)</span></a>
<a name="1278"><span class="lineNum">    1278 </span><span class="lineCov">       1380 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1279"><span class="lineNum">    1279 </span>            : </a>
<a name="1280"><span class="lineNum">    1280 </span><span class="lineCov">        873 :         if (!tok) {</span></a>
<a name="1281"><span class="lineNum">    1281 </span><span class="lineCov">        726 :                 tok = str;</span></a>
<a name="1282"><span class="lineNum">    1282 </span>            :         } else {</a>
<a name="1283"><span class="lineNum">    1283 </span><span class="lineCov">        147 :                 if (BG(strtok_string)) {</span></a>
<a name="1284"><span class="lineNum">    1284 </span><span class="lineCov">         96 :                         zend_string_release(BG(strtok_string));</span></a>
<a name="1285"><span class="lineNum">    1285 </span>            :                 }</a>
<a name="1286"><span class="lineNum">    1286 </span><span class="lineCov">        147 :                 BG(strtok_string) = zend_string_copy(str);</span></a>
<a name="1287"><span class="lineNum">    1287 </span><span class="lineCov">        147 :                 BG(strtok_last) = ZSTR_VAL(str);</span></a>
<a name="1288"><span class="lineNum">    1288 </span><span class="lineCov">        147 :                 BG(strtok_len) = ZSTR_LEN(str);</span></a>
<a name="1289"><span class="lineNum">    1289 </span>            :         }</a>
<a name="1290"><span class="lineNum">    1290 </span>            : </a>
<a name="1291"><span class="lineNum">    1291 </span><span class="lineCov">        873 :         if (!BG(strtok_string)) {</span></a>
<a name="1292"><span class="lineNum">    1292 </span>            :                 /* String to tokenize not set. */</a>
<a name="1293"><span class="lineNum">    1293 </span>            :                 // TODO: Should this warn?</a>
<a name="1294"><span class="lineNum">    1294 </span><span class="lineCov">        135 :                 RETURN_FALSE;</span></a>
<a name="1295"><span class="lineNum">    1295 </span>            :         }</a>
<a name="1296"><span class="lineNum">    1296 </span>            : </a>
<a name="1297"><span class="lineNum">    1297 </span><span class="lineCov">        738 :         p = BG(strtok_last); /* Where we start to search */</span></a>
<a name="1298"><span class="lineNum">    1298 </span><span class="lineCov">        738 :         pe = ZSTR_VAL(BG(strtok_string)) + BG(strtok_len);</span></a>
<a name="1299"><span class="lineNum">    1299 </span><span class="lineCov">        738 :         if (p &gt;= pe) {</span></a>
<a name="1300"><span class="lineNum">    1300 </span>            :                 /* Reached the end of the string. */</a>
<a name="1301"><span class="lineNum">    1301 </span><span class="lineCov">        324 :                 RETURN_FALSE;</span></a>
<a name="1302"><span class="lineNum">    1302 </span>            :         }</a>
<a name="1303"><span class="lineNum">    1303 </span>            : </a>
<a name="1304"><span class="lineNum">    1304 </span><span class="lineCov">        414 :         token = ZSTR_VAL(tok);</span></a>
<a name="1305"><span class="lineNum">    1305 </span><span class="lineCov">        414 :         token_end = token + ZSTR_LEN(tok);</span></a>
<a name="1306"><span class="lineNum">    1306 </span>            : </a>
<a name="1307"><span class="lineNum">    1307 </span><span class="lineCov">       2163 :         while (token &lt; token_end) {</span></a>
<a name="1308"><span class="lineNum">    1308 </span><span class="lineCov">       1749 :                 STRTOK_TABLE(token++) = 1;</span></a>
<a name="1309"><span class="lineNum">    1309 </span>            :         }</a>
<a name="1310"><span class="lineNum">    1310 </span>            : </a>
<a name="1311"><span class="lineNum">    1311 </span>            :         /* Skip leading delimiters */</a>
<a name="1312"><span class="lineNum">    1312 </span><span class="lineCov">        666 :         while (STRTOK_TABLE(p)) {</span></a>
<a name="1313"><span class="lineNum">    1313 </span><span class="lineCov">        288 :                 if (++p &gt;= pe) {</span></a>
<a name="1314"><span class="lineNum">    1314 </span>            :                         /* no other chars left */</a>
<a name="1315"><span class="lineNum">    1315 </span><span class="lineCov">         36 :                         goto return_false;</span></a>
<a name="1316"><span class="lineNum">    1316 </span>            :                 }</a>
<a name="1317"><span class="lineNum">    1317 </span><span class="lineCov">        252 :                 skipped++;</span></a>
<a name="1318"><span class="lineNum">    1318 </span>            :         }</a>
<a name="1319"><span class="lineNum">    1319 </span>            : </a>
<a name="1320"><span class="lineNum">    1320 </span>            :         /* We know at this place that *p is no delimiter, so skip it */</a>
<a name="1321"><span class="lineNum">    1321 </span><span class="lineCov">       1716 :         while (++p &lt; pe) {</span></a>
<a name="1322"><span class="lineNum">    1322 </span><span class="lineCov">       1650 :                 if (STRTOK_TABLE(p)) {</span></a>
<a name="1323"><span class="lineNum">    1323 </span><span class="lineCov">        312 :                         goto return_token;</span></a>
<a name="1324"><span class="lineNum">    1324 </span>            :                 }</a>
<a name="1325"><span class="lineNum">    1325 </span>            :         }</a>
<a name="1326"><span class="lineNum">    1326 </span>            : </a>
<a name="1327"><span class="lineNum">    1327 </span><span class="lineCov">         66 :         if (p - BG(strtok_last)) {</span></a>
<a name="1328"><span class="lineNum">    1328 </span><span class="lineCov">         66 : return_token:</span></a>
<a name="1329"><span class="lineNum">    1329 </span><span class="lineCov">        378 :                 RETVAL_STRINGL(BG(strtok_last) + skipped, (p - BG(strtok_last)) - skipped);</span></a>
<a name="1330"><span class="lineNum">    1330 </span><span class="lineCov">        378 :                 BG(strtok_last) = p + 1;</span></a>
<a name="1331"><span class="lineNum">    1331 </span>            :         } else {</a>
<a name="1332"><span class="lineNum">    1332 </span><span class="lineNoCov">          0 : return_false:</span></a>
<a name="1333"><span class="lineNum">    1333 </span><span class="lineCov">         36 :                 RETVAL_FALSE;</span></a>
<a name="1334"><span class="lineNum">    1334 </span><span class="lineCov">         36 :                 zend_string_release(BG(strtok_string));</span></a>
<a name="1335"><span class="lineNum">    1335 </span><span class="lineCov">         36 :                 BG(strtok_string) = NULL;</span></a>
<a name="1336"><span class="lineNum">    1336 </span>            :         }</a>
<a name="1337"><span class="lineNum">    1337 </span>            : </a>
<a name="1338"><span class="lineNum">    1338 </span>            :         /* Restore table -- usually faster then memset'ing the table on every invocation */</a>
<a name="1339"><span class="lineNum">    1339 </span><span class="lineCov">        414 :         token = ZSTR_VAL(tok);</span></a>
<a name="1340"><span class="lineNum">    1340 </span><span class="lineCov">       2163 :         while (token &lt; token_end) {</span></a>
<a name="1341"><span class="lineNum">    1341 </span><span class="lineCov">       1749 :                 STRTOK_TABLE(token++) = 0;</span></a>
<a name="1342"><span class="lineNum">    1342 </span>            :         }</a>
<a name="1343"><span class="lineNum">    1343 </span>            : }</a>
<a name="1344"><span class="lineNum">    1344 </span>            : /* }}} */</a>
<a name="1345"><span class="lineNum">    1345 </span>            : </a>
<a name="1346"><span class="lineNum">    1346 </span>            : /* {{{ php_strtoupper */</a>
<a name="1347"><span class="lineNum">    1347 </span><span class="lineNoCov">          0 : PHPAPI char *php_strtoupper(char *s, size_t len)</span></a>
<a name="1348"><span class="lineNum">    1348 </span>            : {</a>
<a name="1349"><span class="lineNum">    1349 </span>            :         unsigned char *c;</a>
<a name="1350"><span class="lineNum">    1350 </span>            :         const unsigned char *e;</a>
<a name="1351"><span class="lineNum">    1351 </span>            : </a>
<a name="1352"><span class="lineNum">    1352 </span><span class="lineNoCov">          0 :         c = (unsigned char *)s;</span></a>
<a name="1353"><span class="lineNum">    1353 </span><span class="lineNoCov">          0 :         e = (unsigned char *)c+len;</span></a>
<a name="1354"><span class="lineNum">    1354 </span>            : </a>
<a name="1355"><span class="lineNum">    1355 </span><span class="lineNoCov">          0 :         while (c &lt; e) {</span></a>
<a name="1356"><span class="lineNum">    1356 </span><span class="lineNoCov">          0 :                 *c = toupper(*c);</span></a>
<a name="1357"><span class="lineNum">    1357 </span><span class="lineNoCov">          0 :                 c++;</span></a>
<a name="1358"><span class="lineNum">    1358 </span>            :         }</a>
<a name="1359"><span class="lineNum">    1359 </span><span class="lineNoCov">          0 :         return s;</span></a>
<a name="1360"><span class="lineNum">    1360 </span>            : }</a>
<a name="1361"><span class="lineNum">    1361 </span>            : /* }}} */</a>
<a name="1362"><span class="lineNum">    1362 </span>            : </a>
<a name="1363"><span class="lineNum">    1363 </span>            : /* {{{ php_string_toupper */</a>
<a name="1364"><span class="lineNum">    1364 </span><span class="lineCov">       1081 : PHPAPI zend_string *php_string_toupper(zend_string *s)</span></a>
<a name="1365"><span class="lineNum">    1365 </span>            : {</a>
<a name="1366"><span class="lineNum">    1366 </span>            :         unsigned char *c;</a>
<a name="1367"><span class="lineNum">    1367 </span>            :         const unsigned char *e;</a>
<a name="1368"><span class="lineNum">    1368 </span>            : </a>
<a name="1369"><span class="lineNum">    1369 </span><span class="lineCov">       1081 :         if (EXPECTED(!BG(ctype_string))) {</span></a>
<a name="1370"><span class="lineNum">    1370 </span><span class="lineCov">        652 :                 return zend_string_toupper(s);</span></a>
<a name="1371"><span class="lineNum">    1371 </span>            :         }</a>
<a name="1372"><span class="lineNum">    1372 </span><span class="lineCov">        429 :         c = (unsigned char *)ZSTR_VAL(s);</span></a>
<a name="1373"><span class="lineNum">    1373 </span><span class="lineCov">        429 :         e = c + ZSTR_LEN(s);</span></a>
<a name="1374"><span class="lineNum">    1374 </span>            : </a>
<a name="1375"><span class="lineNum">    1375 </span><span class="lineCov">       1002 :         while (c &lt; e) {</span></a>
<a name="1376"><span class="lineNum">    1376 </span><span class="lineCov">        678 :                 if (islower(*c)) {</span></a>
<a name="1377"><span class="lineNum">    1377 </span>            :                         unsigned char *r;</a>
<a name="1378"><span class="lineNum">    1378 </span><span class="lineCov">        105 :                         zend_string *res = zend_string_alloc(ZSTR_LEN(s), 0);</span></a>
<a name="1379"><span class="lineNum">    1379 </span>            : </a>
<a name="1380"><span class="lineNum">    1380 </span><span class="lineCov">        105 :                         if (c != (unsigned char*)ZSTR_VAL(s)) {</span></a>
<a name="1381"><span class="lineNum">    1381 </span><span class="lineCov">         12 :                                 memcpy(ZSTR_VAL(res), ZSTR_VAL(s), c - (unsigned char*)ZSTR_VAL(s));</span></a>
<a name="1382"><span class="lineNum">    1382 </span>            :                         }</a>
<a name="1383"><span class="lineNum">    1383 </span><span class="lineCov">        105 :                         r = c + (ZSTR_VAL(res) - ZSTR_VAL(s));</span></a>
<a name="1384"><span class="lineNum">    1384 </span><span class="lineCov">        594 :                         while (c &lt; e) {</span></a>
<a name="1385"><span class="lineNum">    1385 </span><span class="lineCov">        489 :                                 *r = toupper(*c);</span></a>
<a name="1386"><span class="lineNum">    1386 </span><span class="lineCov">        489 :                                 r++;</span></a>
<a name="1387"><span class="lineNum">    1387 </span><span class="lineCov">        489 :                                 c++;</span></a>
<a name="1388"><span class="lineNum">    1388 </span>            :                         }</a>
<a name="1389"><span class="lineNum">    1389 </span><span class="lineCov">        105 :                         *r = '\0';</span></a>
<a name="1390"><span class="lineNum">    1390 </span><span class="lineCov">        105 :                         return res;</span></a>
<a name="1391"><span class="lineNum">    1391 </span>            :                 }</a>
<a name="1392"><span class="lineNum">    1392 </span><span class="lineCov">        573 :                 c++;</span></a>
<a name="1393"><span class="lineNum">    1393 </span>            :         }</a>
<a name="1394"><span class="lineNum">    1394 </span><span class="lineCov">        324 :         return zend_string_copy(s);</span></a>
<a name="1395"><span class="lineNum">    1395 </span>            : }</a>
<a name="1396"><span class="lineNum">    1396 </span>            : /* }}} */</a>
<a name="1397"><span class="lineNum">    1397 </span>            : </a>
<a name="1398"><span class="lineNum">    1398 </span>            : /* {{{ Makes a string uppercase */</a>
<a name="1399"><span class="lineNum">    1399 </span><span class="lineCov">        706 : PHP_FUNCTION(strtoupper)</span></a>
<a name="1400"><span class="lineNum">    1400 </span>            : {</a>
<a name="1401"><span class="lineNum">    1401 </span>            :         zend_string *arg;</a>
<a name="1402"><span class="lineNum">    1402 </span>            : </a>
<a name="1403"><span class="lineNum">    1403 </span><span class="lineCov">        706 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="1404"><span class="lineNum">    1404 </span><span class="lineCov">       1316 :                 Z_PARAM_STR(arg)</span></a>
<a name="1405"><span class="lineNum">    1405 </span><span class="lineCov">        706 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1406"><span class="lineNum">    1406 </span>            : </a>
<a name="1407"><span class="lineNum">    1407 </span><span class="lineCov">       1310 :         RETURN_STR(php_string_toupper(arg));</span></a>
<a name="1408"><span class="lineNum">    1408 </span>            : }</a>
<a name="1409"><span class="lineNum">    1409 </span>            : /* }}} */</a>
<a name="1410"><span class="lineNum">    1410 </span>            : </a>
<a name="1411"><span class="lineNum">    1411 </span>            : /* {{{ php_strtolower */</a>
<a name="1412"><span class="lineNum">    1412 </span><span class="lineCov">        794 : PHPAPI char *php_strtolower(char *s, size_t len)</span></a>
<a name="1413"><span class="lineNum">    1413 </span>            : {</a>
<a name="1414"><span class="lineNum">    1414 </span>            :         unsigned char *c;</a>
<a name="1415"><span class="lineNum">    1415 </span>            :         const unsigned char *e;</a>
<a name="1416"><span class="lineNum">    1416 </span>            : </a>
<a name="1417"><span class="lineNum">    1417 </span><span class="lineCov">        794 :         c = (unsigned char *)s;</span></a>
<a name="1418"><span class="lineNum">    1418 </span><span class="lineCov">        794 :         e = c+len;</span></a>
<a name="1419"><span class="lineNum">    1419 </span>            : </a>
<a name="1420"><span class="lineNum">    1420 </span><span class="lineCov">     165655 :         while (c &lt; e) {</span></a>
<a name="1421"><span class="lineNum">    1421 </span><span class="lineCov">     164861 :                 *c = tolower(*c);</span></a>
<a name="1422"><span class="lineNum">    1422 </span><span class="lineCov">     164861 :                 c++;</span></a>
<a name="1423"><span class="lineNum">    1423 </span>            :         }</a>
<a name="1424"><span class="lineNum">    1424 </span><span class="lineCov">        794 :         return s;</span></a>
<a name="1425"><span class="lineNum">    1425 </span>            : }</a>
<a name="1426"><span class="lineNum">    1426 </span>            : /* }}} */</a>
<a name="1427"><span class="lineNum">    1427 </span>            : </a>
<a name="1428"><span class="lineNum">    1428 </span>            : /* {{{ php_string_tolower */</a>
<a name="1429"><span class="lineNum">    1429 </span><span class="lineCov">       5248 : PHPAPI zend_string *php_string_tolower(zend_string *s)</span></a>
<a name="1430"><span class="lineNum">    1430 </span>            : {</a>
<a name="1431"><span class="lineNum">    1431 </span><span class="lineCov">       5248 :         if (EXPECTED(!BG(ctype_string))) {</span></a>
<a name="1432"><span class="lineNum">    1432 </span><span class="lineCov">       4819 :                 return zend_string_tolower(s);</span></a>
<a name="1433"><span class="lineNum">    1433 </span>            :         }</a>
<a name="1434"><span class="lineNum">    1434 </span>            : </a>
<a name="1435"><span class="lineNum">    1435 </span><span class="lineCov">        429 :         unsigned char *c = (unsigned char *)ZSTR_VAL(s);</span></a>
<a name="1436"><span class="lineNum">    1436 </span><span class="lineCov">        429 :         const unsigned char *e = c + ZSTR_LEN(s);</span></a>
<a name="1437"><span class="lineNum">    1437 </span><span class="lineCov">        966 :         while (c &lt; e) {</span></a>
<a name="1438"><span class="lineNum">    1438 </span><span class="lineCov">        642 :                 if (isupper(*c)) {</span></a>
<a name="1439"><span class="lineNum">    1439 </span>            :                         unsigned char *r;</a>
<a name="1440"><span class="lineNum">    1440 </span><span class="lineCov">        105 :                         zend_string *res = zend_string_alloc(ZSTR_LEN(s), 0);</span></a>
<a name="1441"><span class="lineNum">    1441 </span>            : </a>
<a name="1442"><span class="lineNum">    1442 </span><span class="lineCov">        105 :                         if (c != (unsigned char*)ZSTR_VAL(s)) {</span></a>
<a name="1443"><span class="lineNum">    1443 </span><span class="lineCov">         12 :                                 memcpy(ZSTR_VAL(res), ZSTR_VAL(s), c - (unsigned char*)ZSTR_VAL(s));</span></a>
<a name="1444"><span class="lineNum">    1444 </span>            :                         }</a>
<a name="1445"><span class="lineNum">    1445 </span><span class="lineCov">        105 :                         r = c + (ZSTR_VAL(res) - ZSTR_VAL(s));</span></a>
<a name="1446"><span class="lineNum">    1446 </span><span class="lineCov">        630 :                         while (c &lt; e) {</span></a>
<a name="1447"><span class="lineNum">    1447 </span><span class="lineCov">        525 :                                 *r = tolower(*c);</span></a>
<a name="1448"><span class="lineNum">    1448 </span><span class="lineCov">        525 :                                 r++;</span></a>
<a name="1449"><span class="lineNum">    1449 </span><span class="lineCov">        525 :                                 c++;</span></a>
<a name="1450"><span class="lineNum">    1450 </span>            :                         }</a>
<a name="1451"><span class="lineNum">    1451 </span><span class="lineCov">        105 :                         *r = '\0';</span></a>
<a name="1452"><span class="lineNum">    1452 </span><span class="lineCov">        105 :                         return res;</span></a>
<a name="1453"><span class="lineNum">    1453 </span>            :                 }</a>
<a name="1454"><span class="lineNum">    1454 </span><span class="lineCov">        537 :                 c++;</span></a>
<a name="1455"><span class="lineNum">    1455 </span>            :         }</a>
<a name="1456"><span class="lineNum">    1456 </span><span class="lineCov">        324 :         return zend_string_copy(s);</span></a>
<a name="1457"><span class="lineNum">    1457 </span>            : }</a>
<a name="1458"><span class="lineNum">    1458 </span>            : /* }}} */</a>
<a name="1459"><span class="lineNum">    1459 </span>            : </a>
<a name="1460"><span class="lineNum">    1460 </span>            : /* {{{ Makes a string lowercase */</a>
<a name="1461"><span class="lineNum">    1461 </span><span class="lineCov">        775 : PHP_FUNCTION(strtolower)</span></a>
<a name="1462"><span class="lineNum">    1462 </span>            : {</a>
<a name="1463"><span class="lineNum">    1463 </span>            :         zend_string *str;</a>
<a name="1464"><span class="lineNum">    1464 </span>            : </a>
<a name="1465"><span class="lineNum">    1465 </span><span class="lineCov">        775 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="1466"><span class="lineNum">    1466 </span><span class="lineCov">       1454 :                 Z_PARAM_STR(str)</span></a>
<a name="1467"><span class="lineNum">    1467 </span><span class="lineCov">        775 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1468"><span class="lineNum">    1468 </span>            : </a>
<a name="1469"><span class="lineNum">    1469 </span><span class="lineCov">       1448 :         RETURN_STR(php_string_tolower(str));</span></a>
<a name="1470"><span class="lineNum">    1470 </span>            : }</a>
<a name="1471"><span class="lineNum">    1471 </span>            : /* }}} */</a>
<a name="1472"><span class="lineNum">    1472 </span>            : </a>
<a name="1473"><span class="lineNum">    1473 </span>            : #if defined(PHP_WIN32)</a>
<a name="1474"><span class="lineNum">    1474 </span>            : static bool _is_basename_start(const char *start, const char *pos)</a>
<a name="1475"><span class="lineNum">    1475 </span>            : {</a>
<a name="1476"><span class="lineNum">    1476 </span>            :         if (pos - start &gt;= 1</a>
<a name="1477"><span class="lineNum">    1477 </span>            :             &amp;&amp; *(pos-1) != '/'</a>
<a name="1478"><span class="lineNum">    1478 </span>            :             &amp;&amp; *(pos-1) != '\\') {</a>
<a name="1479"><span class="lineNum">    1479 </span>            :                 if (pos - start == 1) {</a>
<a name="1480"><span class="lineNum">    1480 </span>            :                         return 1;</a>
<a name="1481"><span class="lineNum">    1481 </span>            :                 } else if (*(pos-2) == '/' || *(pos-2) == '\\') {</a>
<a name="1482"><span class="lineNum">    1482 </span>            :                         return 1;</a>
<a name="1483"><span class="lineNum">    1483 </span>            :                 } else if (*(pos-2) == ':'</a>
<a name="1484"><span class="lineNum">    1484 </span>            :                         &amp;&amp; _is_basename_start(start, pos - 2)) {</a>
<a name="1485"><span class="lineNum">    1485 </span>            :                         return 1;</a>
<a name="1486"><span class="lineNum">    1486 </span>            :                 }</a>
<a name="1487"><span class="lineNum">    1487 </span>            :         }</a>
<a name="1488"><span class="lineNum">    1488 </span>            :         return 0;</a>
<a name="1489"><span class="lineNum">    1489 </span>            : }</a>
<a name="1490"><span class="lineNum">    1490 </span>            : #endif</a>
<a name="1491"><span class="lineNum">    1491 </span>            : </a>
<a name="1492"><span class="lineNum">    1492 </span>            : /* {{{ php_basename */</a>
<a name="1493"><span class="lineNum">    1493 </span><span class="lineCov">       6444 : PHPAPI zend_string *php_basename(const char *s, size_t len, const char *suffix, size_t suffix_len)</span></a>
<a name="1494"><span class="lineNum">    1494 </span>            : {</a>
<a name="1495"><span class="lineNum">    1495 </span>            :         const char *basename_start;</a>
<a name="1496"><span class="lineNum">    1496 </span>            :         const char *basename_end;</a>
<a name="1497"><span class="lineNum">    1497 </span>            : </a>
<a name="1498"><span class="lineNum">    1498 </span><span class="lineCov">       6444 :         if (CG(ascii_compatible_locale)) {</span></a>
<a name="1499"><span class="lineNum">    1499 </span><span class="lineCov">       6444 :                 basename_end = s + len - 1;</span></a>
<a name="1500"><span class="lineNum">    1500 </span>            : </a>
<a name="1501"><span class="lineNum">    1501 </span>            :                 /* Strip trailing slashes */</a>
<a name="1502"><span class="lineNum">    1502 </span><span class="lineCov">       7077 :                 while (basename_end &gt;= s</span></a>
<a name="1503"><span class="lineNum">    1503 </span>            : #if defined(PHP_WIN32)</a>
<a name="1504"><span class="lineNum">    1504 </span>            :                         &amp;&amp; (*basename_end == '/'</a>
<a name="1505"><span class="lineNum">    1505 </span>            :                                 || *basename_end == '\\'</a>
<a name="1506"><span class="lineNum">    1506 </span>            :                                 || (*basename_end == ':'</a>
<a name="1507"><span class="lineNum">    1507 </span>            :                                         &amp;&amp; _is_basename_start(s, basename_end)))) {</a>
<a name="1508"><span class="lineNum">    1508 </span>            : #else</a>
<a name="1509"><span class="lineNum">    1509 </span><span class="lineCov">       6936 :                         &amp;&amp; *basename_end == '/') {</span></a>
<a name="1510"><span class="lineNum">    1510 </span>            : #endif</a>
<a name="1511"><span class="lineNum">    1511 </span><span class="lineCov">        633 :                         basename_end--;</span></a>
<a name="1512"><span class="lineNum">    1512 </span>            :                 }</a>
<a name="1513"><span class="lineNum">    1513 </span><span class="lineCov">       6444 :                 if (basename_end &lt; s) {</span></a>
<a name="1514"><span class="lineNum">    1514 </span><span class="lineCov">        141 :                         return ZSTR_EMPTY_ALLOC();</span></a>
<a name="1515"><span class="lineNum">    1515 </span>            :                 }</a>
<a name="1516"><span class="lineNum">    1516 </span>            : </a>
<a name="1517"><span class="lineNum">    1517 </span>            :                 /* Extract filename */</a>
<a name="1518"><span class="lineNum">    1518 </span><span class="lineCov">       6303 :                 basename_start = basename_end;</span></a>
<a name="1519"><span class="lineNum">    1519 </span><span class="lineCov">       6303 :                 basename_end++;</span></a>
<a name="1520"><span class="lineNum">    1520 </span><span class="lineCov">      84340 :                 while (basename_start &gt; s</span></a>
<a name="1521"><span class="lineNum">    1521 </span>            : #if defined(PHP_WIN32)</a>
<a name="1522"><span class="lineNum">    1522 </span>            :                         &amp;&amp; *(basename_start-1) != '/'</a>
<a name="1523"><span class="lineNum">    1523 </span>            :                         &amp;&amp; *(basename_start-1) != '\\') {</a>
<a name="1524"><span class="lineNum">    1524 </span>            : </a>
<a name="1525"><span class="lineNum">    1525 </span>            :                         if (*(basename_start-1) == ':' &amp;&amp;</a>
<a name="1526"><span class="lineNum">    1526 </span>            :                                 _is_basename_start(s, basename_start - 1)) {</a>
<a name="1527"><span class="lineNum">    1527 </span>            :                                 break;</a>
<a name="1528"><span class="lineNum">    1528 </span>            :                         }</a>
<a name="1529"><span class="lineNum">    1529 </span>            : #else</a>
<a name="1530"><span class="lineNum">    1530 </span><span class="lineCov">      81428 :                         &amp;&amp; *(basename_start-1) != '/') {</span></a>
<a name="1531"><span class="lineNum">    1531 </span>            : #endif</a>
<a name="1532"><span class="lineNum">    1532 </span><span class="lineCov">      78037 :                         basename_start--;</span></a>
<a name="1533"><span class="lineNum">    1533 </span>            :                 }</a>
<a name="1534"><span class="lineNum">    1534 </span>            :         } else {</a>
<a name="1535"><span class="lineNum">    1535 </span>            :                 /* State 0 is directly after a directory separator (or at the start of the string).</a>
<a name="1536"><span class="lineNum">    1536 </span>            :                  * State 1 is everything else. */</a>
<a name="1537"><span class="lineNum">    1537 </span><span class="lineNoCov">          0 :                 int state = 0;</span></a>
<a name="1538"><span class="lineNum">    1538 </span>            : </a>
<a name="1539"><span class="lineNum">    1539 </span><span class="lineNoCov">          0 :                 basename_start = s;</span></a>
<a name="1540"><span class="lineNum">    1540 </span><span class="lineNoCov">          0 :                 basename_end = s;</span></a>
<a name="1541"><span class="lineNum">    1541 </span><span class="lineNoCov">          0 :                 while (len &gt; 0) {</span></a>
<a name="1542"><span class="lineNum">    1542 </span><span class="lineNoCov">          0 :                         int inc_len = (*s == '\0' ? 1 : php_mblen(s, len));</span></a>
<a name="1543"><span class="lineNum">    1543 </span>            : </a>
<a name="1544"><span class="lineNum">    1544 </span><span class="lineNoCov">          0 :                         switch (inc_len) {</span></a>
<a name="1545"><span class="lineNum">    1545 </span><span class="lineNoCov">          0 :                                 case 0:</span></a>
<a name="1546"><span class="lineNum">    1546 </span><span class="lineNoCov">          0 :                                         goto quit_loop;</span></a>
<a name="1547"><span class="lineNum">    1547 </span><span class="lineNoCov">          0 :                                 case 1:</span></a>
<a name="1548"><span class="lineNum">    1548 </span>            : #if defined(PHP_WIN32)</a>
<a name="1549"><span class="lineNum">    1549 </span>            :                                         if (*s == '/' || *s == '\\') {</a>
<a name="1550"><span class="lineNum">    1550 </span>            : #else</a>
<a name="1551"><span class="lineNum">    1551 </span><span class="lineNoCov">          0 :                                         if (*s == '/') {</span></a>
<a name="1552"><span class="lineNum">    1552 </span>            : #endif</a>
<a name="1553"><span class="lineNum">    1553 </span><span class="lineNoCov">          0 :                                                 if (state == 1) {</span></a>
<a name="1554"><span class="lineNum">    1554 </span><span class="lineNoCov">          0 :                                                         state = 0;</span></a>
<a name="1555"><span class="lineNum">    1555 </span><span class="lineNoCov">          0 :                                                         basename_end = s;</span></a>
<a name="1556"><span class="lineNum">    1556 </span>            :                                                 }</a>
<a name="1557"><span class="lineNum">    1557 </span>            : #if defined(PHP_WIN32)</a>
<a name="1558"><span class="lineNum">    1558 </span>            :                                         /* Catch relative paths in c:file.txt style. They're not to confuse</a>
<a name="1559"><span class="lineNum">    1559 </span>            :                                            with the NTFS streams. This part ensures also, that no drive</a>
<a name="1560"><span class="lineNum">    1560 </span>            :                                            letter traversing happens. */</a>
<a name="1561"><span class="lineNum">    1561 </span>            :                                         } else if ((*s == ':' &amp;&amp; (s - basename_start == 1))) {</a>
<a name="1562"><span class="lineNum">    1562 </span>            :                                                 if (state == 0) {</a>
<a name="1563"><span class="lineNum">    1563 </span>            :                                                         basename_start = s;</a>
<a name="1564"><span class="lineNum">    1564 </span>            :                                                         state = 1;</a>
<a name="1565"><span class="lineNum">    1565 </span>            :                                                 } else {</a>
<a name="1566"><span class="lineNum">    1566 </span>            :                                                         basename_end = s;</a>
<a name="1567"><span class="lineNum">    1567 </span>            :                                                         state = 0;</a>
<a name="1568"><span class="lineNum">    1568 </span>            :                                                 }</a>
<a name="1569"><span class="lineNum">    1569 </span>            : #endif</a>
<a name="1570"><span class="lineNum">    1570 </span>            :                                         } else {</a>
<a name="1571"><span class="lineNum">    1571 </span><span class="lineNoCov">          0 :                                                 if (state == 0) {</span></a>
<a name="1572"><span class="lineNum">    1572 </span><span class="lineNoCov">          0 :                                                         basename_start = s;</span></a>
<a name="1573"><span class="lineNum">    1573 </span><span class="lineNoCov">          0 :                                                         state = 1;</span></a>
<a name="1574"><span class="lineNum">    1574 </span>            :                                                 }</a>
<a name="1575"><span class="lineNum">    1575 </span>            :                                         }</a>
<a name="1576"><span class="lineNum">    1576 </span><span class="lineNoCov">          0 :                                         break;</span></a>
<a name="1577"><span class="lineNum">    1577 </span><span class="lineNoCov">          0 :                                 default:</span></a>
<a name="1578"><span class="lineNum">    1578 </span><span class="lineNoCov">          0 :                                         if (inc_len &lt; 0) {</span></a>
<a name="1579"><span class="lineNum">    1579 </span>            :                                                 /* If character is invalid, treat it like other non-significant characters. */</a>
<a name="1580"><span class="lineNum">    1580 </span><span class="lineNoCov">          0 :                                                 inc_len = 1;</span></a>
<a name="1581"><span class="lineNum">    1581 </span><span class="lineNoCov">          0 :                                                 php_mb_reset();</span></a>
<a name="1582"><span class="lineNum">    1582 </span>            :                                         }</a>
<a name="1583"><span class="lineNum">    1583 </span><span class="lineNoCov">          0 :                                         if (state == 0) {</span></a>
<a name="1584"><span class="lineNum">    1584 </span><span class="lineNoCov">          0 :                                                 basename_start = s;</span></a>
<a name="1585"><span class="lineNum">    1585 </span><span class="lineNoCov">          0 :                                                 state = 1;</span></a>
<a name="1586"><span class="lineNum">    1586 </span>            :                                         }</a>
<a name="1587"><span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                                         break;</span></a>
<a name="1588"><span class="lineNum">    1588 </span>            :                         }</a>
<a name="1589"><span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                         s += inc_len;</span></a>
<a name="1590"><span class="lineNum">    1590 </span><span class="lineNoCov">          0 :                         len -= inc_len;</span></a>
<a name="1591"><span class="lineNum">    1591 </span>            :                 }</a>
<a name="1592"><span class="lineNum">    1592 </span>            : </a>
<a name="1593"><span class="lineNum">    1593 </span><span class="lineNoCov">          0 : quit_loop:</span></a>
<a name="1594"><span class="lineNum">    1594 </span><span class="lineNoCov">          0 :                 if (state == 1) {</span></a>
<a name="1595"><span class="lineNum">    1595 </span><span class="lineNoCov">          0 :                         basename_end = s;</span></a>
<a name="1596"><span class="lineNum">    1596 </span>            :                 }</a>
<a name="1597"><span class="lineNum">    1597 </span>            :         }</a>
<a name="1598"><span class="lineNum">    1598 </span>            : </a>
<a name="1599"><span class="lineNum">    1599 </span><span class="lineCov">       6303 :         if (suffix != NULL &amp;&amp; suffix_len &lt; (size_t)(basename_end - basename_start) &amp;&amp;</span></a>
<a name="1600"><span class="lineNum">    1600 </span><span class="lineCov">       2376 :                         memcmp(basename_end - suffix_len, suffix, suffix_len) == 0) {</span></a>
<a name="1601"><span class="lineNum">    1601 </span><span class="lineCov">       2136 :                 basename_end -= suffix_len;</span></a>
<a name="1602"><span class="lineNum">    1602 </span>            :         }</a>
<a name="1603"><span class="lineNum">    1603 </span>            : </a>
<a name="1604"><span class="lineNum">    1604 </span><span class="lineCov">      12606 :         return zend_string_init(basename_start, basename_end - basename_start, 0);</span></a>
<a name="1605"><span class="lineNum">    1605 </span>            : }</a>
<a name="1606"><span class="lineNum">    1606 </span>            : /* }}} */</a>
<a name="1607"><span class="lineNum">    1607 </span>            : </a>
<a name="1608"><span class="lineNum">    1608 </span>            : /* {{{ Returns the filename component of the path */</a>
<a name="1609"><span class="lineNum">    1609 </span><span class="lineCov">       3310 : PHP_FUNCTION(basename)</span></a>
<a name="1610"><span class="lineNum">    1610 </span>            : {</a>
<a name="1611"><span class="lineNum">    1611 </span><span class="lineCov">       3310 :         char *string, *suffix = NULL;</span></a>
<a name="1612"><span class="lineNum">    1612 </span><span class="lineCov">       3310 :         size_t   string_len, suffix_len = 0;</span></a>
<a name="1613"><span class="lineNum">    1613 </span>            : </a>
<a name="1614"><span class="lineNum">    1614 </span><span class="lineCov">       3310 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="1615"><span class="lineNum">    1615 </span><span class="lineCov">       6536 :                 Z_PARAM_STRING(string, string_len)</span></a>
<a name="1616"><span class="lineNum">    1616 </span><span class="lineCov">       3262 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1617"><span class="lineNum">    1617 </span><span class="lineCov">       5833 :                 Z_PARAM_STRING(suffix, suffix_len)</span></a>
<a name="1618"><span class="lineNum">    1618 </span><span class="lineCov">       3310 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1619"><span class="lineNum">    1619 </span>            : </a>
<a name="1620"><span class="lineNum">    1620 </span><span class="lineCov">       6524 :         RETURN_STR(php_basename(string, string_len, suffix, suffix_len));</span></a>
<a name="1621"><span class="lineNum">    1621 </span>            : }</a>
<a name="1622"><span class="lineNum">    1622 </span>            : /* }}} */</a>
<a name="1623"><span class="lineNum">    1623 </span>            : </a>
<a name="1624"><span class="lineNum">    1624 </span>            : /* {{{ php_dirname</a>
<a name="1625"><span class="lineNum">    1625 </span>            :    Returns directory name component of path */</a>
<a name="1626"><span class="lineNum">    1626 </span><span class="lineCov">       1341 : PHPAPI size_t php_dirname(char *path, size_t len)</span></a>
<a name="1627"><span class="lineNum">    1627 </span>            : {</a>
<a name="1628"><span class="lineNum">    1628 </span><span class="lineCov">       1341 :         return zend_dirname(path, len);</span></a>
<a name="1629"><span class="lineNum">    1629 </span>            : }</a>
<a name="1630"><span class="lineNum">    1630 </span>            : /* }}} */</a>
<a name="1631"><span class="lineNum">    1631 </span>            : </a>
<a name="1632"><span class="lineNum">    1632 </span>            : /* {{{ Returns the directory name component of the path */</a>
<a name="1633"><span class="lineNum">    1633 </span><span class="lineCov">      12927 : PHP_FUNCTION(dirname)</span></a>
<a name="1634"><span class="lineNum">    1634 </span>            : {</a>
<a name="1635"><span class="lineNum">    1635 </span>            :         char *str;</a>
<a name="1636"><span class="lineNum">    1636 </span>            :         size_t str_len;</a>
<a name="1637"><span class="lineNum">    1637 </span>            :         zend_string *ret;</a>
<a name="1638"><span class="lineNum">    1638 </span><span class="lineCov">      12927 :         zend_long levels = 1;</span></a>
<a name="1639"><span class="lineNum">    1639 </span>            : </a>
<a name="1640"><span class="lineNum">    1640 </span><span class="lineCov">      12927 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="1641"><span class="lineNum">    1641 </span><span class="lineCov">      25770 :                 Z_PARAM_STRING(str, str_len)</span></a>
<a name="1642"><span class="lineNum">    1642 </span><span class="lineCov">      12879 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1643"><span class="lineNum">    1643 </span><span class="lineCov">      12966 :                 Z_PARAM_LONG(levels)</span></a>
<a name="1644"><span class="lineNum">    1644 </span><span class="lineCov">      12927 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1645"><span class="lineNum">    1645 </span>            : </a>
<a name="1646"><span class="lineNum">    1646 </span><span class="lineCov">      12879 :         ret = zend_string_init(str, str_len, 0);</span></a>
<a name="1647"><span class="lineNum">    1647 </span>            : </a>
<a name="1648"><span class="lineNum">    1648 </span><span class="lineCov">      12879 :         if (levels == 1) {</span></a>
<a name="1649"><span class="lineNum">    1649 </span>            :                 /* Default case */</a>
<a name="1650"><span class="lineNum">    1650 </span>            : #ifdef PHP_WIN32</a>
<a name="1651"><span class="lineNum">    1651 </span>            :                 ZSTR_LEN(ret) = php_win32_ioutil_dirname(ZSTR_VAL(ret), str_len);</a>
<a name="1652"><span class="lineNum">    1652 </span>            : #else</a>
<a name="1653"><span class="lineNum">    1653 </span><span class="lineCov">      12795 :                 ZSTR_LEN(ret) = zend_dirname(ZSTR_VAL(ret), str_len);</span></a>
<a name="1654"><span class="lineNum">    1654 </span>            : #endif</a>
<a name="1655"><span class="lineNum">    1655 </span><span class="lineCov">         84 :         } else if (levels &lt; 1) {</span></a>
<a name="1656"><span class="lineNum">    1656 </span><span class="lineCov">          9 :                 zend_argument_value_error(2, &quot;must be greater than or equal to 1&quot;);</span></a>
<a name="1657"><span class="lineNum">    1657 </span>            :                 zend_string_efree(ret);</a>
<a name="1658"><span class="lineNum">    1658 </span><span class="lineCov">          9 :                 RETURN_THROWS();</span></a>
<a name="1659"><span class="lineNum">    1659 </span>            :         } else {</a>
<a name="1660"><span class="lineNum">    1660 </span>            :                 /* Some levels up */</a>
<a name="1661"><span class="lineNum">    1661 </span>            :                 do {</a>
<a name="1662"><span class="lineNum">    1662 </span>            : #ifdef PHP_WIN32</a>
<a name="1663"><span class="lineNum">    1663 </span>            :                         ZSTR_LEN(ret) = php_win32_ioutil_dirname(ZSTR_VAL(ret), str_len = ZSTR_LEN(ret));</a>
<a name="1664"><span class="lineNum">    1664 </span>            : #else</a>
<a name="1665"><span class="lineNum">    1665 </span><span class="lineCov">        228 :                         ZSTR_LEN(ret) = zend_dirname(ZSTR_VAL(ret), str_len = ZSTR_LEN(ret));</span></a>
<a name="1666"><span class="lineNum">    1666 </span>            : #endif</a>
<a name="1667"><span class="lineNum">    1667 </span><span class="lineCov">        228 :                 } while (ZSTR_LEN(ret) &lt; str_len &amp;&amp; --levels);</span></a>
<a name="1668"><span class="lineNum">    1668 </span>            :         }</a>
<a name="1669"><span class="lineNum">    1669 </span>            : </a>
<a name="1670"><span class="lineNum">    1670 </span><span class="lineCov">      12870 :         RETURN_NEW_STR(ret);</span></a>
<a name="1671"><span class="lineNum">    1671 </span>            : }</a>
<a name="1672"><span class="lineNum">    1672 </span>            : /* }}} */</a>
<a name="1673"><span class="lineNum">    1673 </span>            : </a>
<a name="1674"><span class="lineNum">    1674 </span>            : /* {{{ Returns information about a certain string */</a>
<a name="1675"><span class="lineNum">    1675 </span><span class="lineCov">       1686 : PHP_FUNCTION(pathinfo)</span></a>
<a name="1676"><span class="lineNum">    1676 </span>            : {</a>
<a name="1677"><span class="lineNum">    1677 </span>            :         zval tmp;</a>
<a name="1678"><span class="lineNum">    1678 </span>            :         char *path, *dirname;</a>
<a name="1679"><span class="lineNum">    1679 </span>            :         size_t path_len;</a>
<a name="1680"><span class="lineNum">    1680 </span>            :         int have_basename;</a>
<a name="1681"><span class="lineNum">    1681 </span><span class="lineCov">       1686 :         zend_long opt = PHP_PATHINFO_ALL;</span></a>
<a name="1682"><span class="lineNum">    1682 </span><span class="lineCov">       1686 :         zend_string *ret = NULL;</span></a>
<a name="1683"><span class="lineNum">    1683 </span>            : </a>
<a name="1684"><span class="lineNum">    1684 </span><span class="lineCov">       1686 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="1685"><span class="lineNum">    1685 </span><span class="lineCov">       3288 :                 Z_PARAM_STRING(path, path_len)</span></a>
<a name="1686"><span class="lineNum">    1686 </span><span class="lineCov">       1638 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1687"><span class="lineNum">    1687 </span><span class="lineCov">       2931 :                 Z_PARAM_LONG(opt)</span></a>
<a name="1688"><span class="lineNum">    1688 </span><span class="lineCov">       1686 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1689"><span class="lineNum">    1689 </span>            : </a>
<a name="1690"><span class="lineNum">    1690 </span><span class="lineCov">       1638 :         have_basename = ((opt &amp; PHP_PATHINFO_BASENAME) == PHP_PATHINFO_BASENAME);</span></a>
<a name="1691"><span class="lineNum">    1691 </span>            : </a>
<a name="1692"><span class="lineNum">    1692 </span><span class="lineCov">       1638 :         array_init(&amp;tmp);</span></a>
<a name="1693"><span class="lineNum">    1693 </span>            : </a>
<a name="1694"><span class="lineNum">    1694 </span><span class="lineCov">       1638 :         if ((opt &amp; PHP_PATHINFO_DIRNAME) == PHP_PATHINFO_DIRNAME) {</span></a>
<a name="1695"><span class="lineNum">    1695 </span><span class="lineCov">        672 :                 dirname = estrndup(path, path_len);</span></a>
<a name="1696"><span class="lineNum">    1696 </span><span class="lineCov">        672 :                 php_dirname(dirname, path_len);</span></a>
<a name="1697"><span class="lineNum">    1697 </span><span class="lineCov">        672 :                 if (*dirname) {</span></a>
<a name="1698"><span class="lineNum">    1698 </span><span class="lineCov">        642 :                         add_assoc_string(&amp;tmp, &quot;dirname&quot;, dirname);</span></a>
<a name="1699"><span class="lineNum">    1699 </span>            :                 }</a>
<a name="1700"><span class="lineNum">    1700 </span><span class="lineCov">        672 :                 efree(dirname);</span></a>
<a name="1701"><span class="lineNum">    1701 </span>            :         }</a>
<a name="1702"><span class="lineNum">    1702 </span>            : </a>
<a name="1703"><span class="lineNum">    1703 </span><span class="lineCov">       1638 :         if (have_basename) {</span></a>
<a name="1704"><span class="lineNum">    1704 </span><span class="lineCov">        672 :                 ret = php_basename(path, path_len, NULL, 0);</span></a>
<a name="1705"><span class="lineNum">    1705 </span><span class="lineCov">        672 :                 add_assoc_str(&amp;tmp, &quot;basename&quot;, zend_string_copy(ret));</span></a>
<a name="1706"><span class="lineNum">    1706 </span>            :         }</a>
<a name="1707"><span class="lineNum">    1707 </span>            : </a>
<a name="1708"><span class="lineNum">    1708 </span><span class="lineCov">       1638 :         if ((opt &amp; PHP_PATHINFO_EXTENSION) == PHP_PATHINFO_EXTENSION) {</span></a>
<a name="1709"><span class="lineNum">    1709 </span>            :                 const char *p;</a>
<a name="1710"><span class="lineNum">    1710 </span>            :                 ptrdiff_t idx;</a>
<a name="1711"><span class="lineNum">    1711 </span>            : </a>
<a name="1712"><span class="lineNum">    1712 </span><span class="lineCov">        702 :                 if (!have_basename) {</span></a>
<a name="1713"><span class="lineNum">    1713 </span><span class="lineCov">        345 :                         ret = php_basename(path, path_len, NULL, 0);</span></a>
<a name="1714"><span class="lineNum">    1714 </span>            :                 }</a>
<a name="1715"><span class="lineNum">    1715 </span>            : </a>
<a name="1716"><span class="lineNum">    1716 </span><span class="lineCov">        702 :                 p = zend_memrchr(ZSTR_VAL(ret), '.', ZSTR_LEN(ret));</span></a>
<a name="1717"><span class="lineNum">    1717 </span>            : </a>
<a name="1718"><span class="lineNum">    1718 </span><span class="lineCov">        702 :                 if (p) {</span></a>
<a name="1719"><span class="lineNum">    1719 </span><span class="lineCov">        393 :                         idx = p - ZSTR_VAL(ret);</span></a>
<a name="1720"><span class="lineNum">    1720 </span><span class="lineCov">        393 :                         add_assoc_stringl(&amp;tmp, &quot;extension&quot;, ZSTR_VAL(ret) + idx + 1, ZSTR_LEN(ret) - idx - 1);</span></a>
<a name="1721"><span class="lineNum">    1721 </span>            :                 }</a>
<a name="1722"><span class="lineNum">    1722 </span>            :         }</a>
<a name="1723"><span class="lineNum">    1723 </span>            : </a>
<a name="1724"><span class="lineNum">    1724 </span><span class="lineCov">       1638 :         if ((opt &amp; PHP_PATHINFO_FILENAME) == PHP_PATHINFO_FILENAME) {</span></a>
<a name="1725"><span class="lineNum">    1725 </span>            :                 const char *p;</a>
<a name="1726"><span class="lineNum">    1726 </span>            :                 ptrdiff_t idx;</a>
<a name="1727"><span class="lineNum">    1727 </span>            : </a>
<a name="1728"><span class="lineNum">    1728 </span>            :                 /* Have we already looked up the basename? */</a>
<a name="1729"><span class="lineNum">    1729 </span><span class="lineCov">        684 :                 if (!have_basename &amp;&amp; !ret) {</span></a>
<a name="1730"><span class="lineNum">    1730 </span><span class="lineCov">        315 :                         ret = php_basename(path, path_len, NULL, 0);</span></a>
<a name="1731"><span class="lineNum">    1731 </span>            :                 }</a>
<a name="1732"><span class="lineNum">    1732 </span>            : </a>
<a name="1733"><span class="lineNum">    1733 </span><span class="lineCov">        684 :                 p = zend_memrchr(ZSTR_VAL(ret), '.', ZSTR_LEN(ret));</span></a>
<a name="1734"><span class="lineNum">    1734 </span>            : </a>
<a name="1735"><span class="lineNum">    1735 </span><span class="lineCov">        684 :                 idx = p ? (p - ZSTR_VAL(ret)) : (ptrdiff_t)ZSTR_LEN(ret);</span></a>
<a name="1736"><span class="lineNum">    1736 </span><span class="lineCov">        684 :                 add_assoc_stringl(&amp;tmp, &quot;filename&quot;, ZSTR_VAL(ret), idx);</span></a>
<a name="1737"><span class="lineNum">    1737 </span>            :         }</a>
<a name="1738"><span class="lineNum">    1738 </span>            : </a>
<a name="1739"><span class="lineNum">    1739 </span><span class="lineCov">       1638 :         if (ret) {</span></a>
<a name="1740"><span class="lineNum">    1740 </span>            :                 zend_string_release_ex(ret, 0);</a>
<a name="1741"><span class="lineNum">    1741 </span>            :         }</a>
<a name="1742"><span class="lineNum">    1742 </span>            : </a>
<a name="1743"><span class="lineNum">    1743 </span><span class="lineCov">       1638 :         if (opt == PHP_PATHINFO_ALL) {</span></a>
<a name="1744"><span class="lineNum">    1744 </span><span class="lineCov">        345 :                 RETURN_COPY_VALUE(&amp;tmp);</span></a>
<a name="1745"><span class="lineNum">    1745 </span>            :         } else {</a>
<a name="1746"><span class="lineNum">    1746 </span>            :                 zval *element;</a>
<a name="1747"><span class="lineNum">    1747 </span><span class="lineCov">       1293 :                 if ((element = zend_hash_get_current_data(Z_ARRVAL(tmp))) != NULL) {</span></a>
<a name="1748"><span class="lineNum">    1748 </span><span class="lineCov">       2229 :                         RETVAL_COPY_DEREF(element);</span></a>
<a name="1749"><span class="lineNum">    1749 </span>            :                 } else {</a>
<a name="1750"><span class="lineNum">    1750 </span><span class="lineCov">        168 :                         RETVAL_EMPTY_STRING();</span></a>
<a name="1751"><span class="lineNum">    1751 </span>            :                 }</a>
<a name="1752"><span class="lineNum">    1752 </span><span class="lineCov">       1293 :                 zval_ptr_dtor(&amp;tmp);</span></a>
<a name="1753"><span class="lineNum">    1753 </span>            :         }</a>
<a name="1754"><span class="lineNum">    1754 </span>            : }</a>
<a name="1755"><span class="lineNum">    1755 </span>            : /* }}} */</a>
<a name="1756"><span class="lineNum">    1756 </span>            : </a>
<a name="1757"><span class="lineNum">    1757 </span>            : /* {{{ php_stristr</a>
<a name="1758"><span class="lineNum">    1758 </span>            :    case insensitive strstr */</a>
<a name="1759"><span class="lineNum">    1759 </span><span class="lineCov">        397 : PHPAPI char *php_stristr(char *s, char *t, size_t s_len, size_t t_len)</span></a>
<a name="1760"><span class="lineNum">    1760 </span>            : {</a>
<a name="1761"><span class="lineNum">    1761 </span><span class="lineCov">        397 :         php_strtolower(s, s_len);</span></a>
<a name="1762"><span class="lineNum">    1762 </span><span class="lineCov">        397 :         php_strtolower(t, t_len);</span></a>
<a name="1763"><span class="lineNum">    1763 </span><span class="lineCov">        794 :         return (char*)php_memnstr(s, t, t_len, s + s_len);</span></a>
<a name="1764"><span class="lineNum">    1764 </span>            : }</a>
<a name="1765"><span class="lineNum">    1765 </span>            : /* }}} */</a>
<a name="1766"><span class="lineNum">    1766 </span>            : </a>
<a name="1767"><span class="lineNum">    1767 </span>            : /* {{{ php_strspn */</a>
<a name="1768"><span class="lineNum">    1768 </span><span class="lineCov">       6462 : PHPAPI size_t php_strspn(const char *s1, const char *s2, const char *s1_end, const char *s2_end)</span></a>
<a name="1769"><span class="lineNum">    1769 </span>            : {</a>
<a name="1770"><span class="lineNum">    1770 </span><span class="lineCov">       6462 :         const char *p = s1, *spanp;</span></a>
<a name="1771"><span class="lineNum">    1771 </span><span class="lineCov">       6462 :         char c = *p;</span></a>
<a name="1772"><span class="lineNum">    1772 </span>            : </a>
<a name="1773"><span class="lineNum">    1773 </span><span class="lineCov">      12975 : cont:</span></a>
<a name="1774"><span class="lineNum">    1774 </span><span class="lineCov">      73914 :         for (spanp = s2; p != s1_end &amp;&amp; spanp != s2_end;) {</span></a>
<a name="1775"><span class="lineNum">    1775 </span><span class="lineCov">      67452 :                 if (*spanp++ == c) {</span></a>
<a name="1776"><span class="lineNum">    1776 </span><span class="lineCov">       6513 :                         c = *(++p);</span></a>
<a name="1777"><span class="lineNum">    1777 </span><span class="lineCov">       6513 :                         goto cont;</span></a>
<a name="1778"><span class="lineNum">    1778 </span>            :                 }</a>
<a name="1779"><span class="lineNum">    1779 </span>            :         }</a>
<a name="1780"><span class="lineNum">    1780 </span><span class="lineCov">       6462 :         return (p - s1);</span></a>
<a name="1781"><span class="lineNum">    1781 </span>            : }</a>
<a name="1782"><span class="lineNum">    1782 </span>            : /* }}} */</a>
<a name="1783"><span class="lineNum">    1783 </span>            : </a>
<a name="1784"><span class="lineNum">    1784 </span>            : /* {{{ php_strcspn */</a>
<a name="1785"><span class="lineNum">    1785 </span><span class="lineCov">       6021 : PHPAPI size_t php_strcspn(const char *s1, const char *s2, const char *s1_end, const char *s2_end)</span></a>
<a name="1786"><span class="lineNum">    1786 </span>            : {</a>
<a name="1787"><span class="lineNum">    1787 </span>            :         const char *p, *spanp;</a>
<a name="1788"><span class="lineNum">    1788 </span><span class="lineCov">       6021 :         char c = *s1;</span></a>
<a name="1789"><span class="lineNum">    1789 </span>            : </a>
<a name="1790"><span class="lineNum">    1790 </span><span class="lineCov">       6021 :         for (p = s1;;) {</span></a>
<a name="1791"><span class="lineNum">    1791 </span><span class="lineCov">      38301 :                 spanp = s2;</span></a>
<a name="1792"><span class="lineNum">    1792 </span>            :                 do {</a>
<a name="1793"><span class="lineNum">    1793 </span><span class="lineCov">      94653 :                         if (*spanp == c || p == s1_end) {</span></a>
<a name="1794"><span class="lineNum">    1794 </span><span class="lineCov">       6021 :                                 return p - s1;</span></a>
<a name="1795"><span class="lineNum">    1795 </span>            :                         }</a>
<a name="1796"><span class="lineNum">    1796 </span><span class="lineCov">      88632 :                 } while (spanp++ &lt; (s2_end - 1));</span></a>
<a name="1797"><span class="lineNum">    1797 </span><span class="lineCov">      32280 :                 c = *++p;</span></a>
<a name="1798"><span class="lineNum">    1798 </span>            :         }</a>
<a name="1799"><span class="lineNum">    1799 </span>            :         /* NOTREACHED */</a>
<a name="1800"><span class="lineNum">    1800 </span>            : }</a>
<a name="1801"><span class="lineNum">    1801 </span>            : /* }}} */</a>
<a name="1802"><span class="lineNum">    1802 </span>            : </a>
<a name="1803"><span class="lineNum">    1803 </span>            : /* {{{ Finds first occurrence of a string within another, case insensitive */</a>
<a name="1804"><span class="lineNum">    1804 </span><span class="lineCov">        207 : PHP_FUNCTION(stristr)</span></a>
<a name="1805"><span class="lineNum">    1805 </span>            : {</a>
<a name="1806"><span class="lineNum">    1806 </span>            :         zend_string *haystack, *needle;</a>
<a name="1807"><span class="lineNum">    1807 </span><span class="lineCov">        207 :         const char *found = NULL;</span></a>
<a name="1808"><span class="lineNum">    1808 </span>            :         size_t  found_offset;</a>
<a name="1809"><span class="lineNum">    1809 </span>            :         char *haystack_dup;</a>
<a name="1810"><span class="lineNum">    1810 </span>            :         char *orig_needle;</a>
<a name="1811"><span class="lineNum">    1811 </span><span class="lineCov">        207 :         bool part = 0;</span></a>
<a name="1812"><span class="lineNum">    1812 </span>            : </a>
<a name="1813"><span class="lineNum">    1813 </span><span class="lineCov">        207 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="1814"><span class="lineNum">    1814 </span><span class="lineCov">        330 :                 Z_PARAM_STR(haystack)</span></a>
<a name="1815"><span class="lineNum">    1815 </span><span class="lineCov">        318 :                 Z_PARAM_STR(needle)</span></a>
<a name="1816"><span class="lineNum">    1816 </span><span class="lineCov">        147 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1817"><span class="lineNum">    1817 </span><span class="lineCov">        165 :                 Z_PARAM_BOOL(part)</span></a>
<a name="1818"><span class="lineNum">    1818 </span><span class="lineCov">        207 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1819"><span class="lineNum">    1819 </span>            : </a>
<a name="1820"><span class="lineNum">    1820 </span><span class="lineCov">        147 :         haystack_dup = estrndup(ZSTR_VAL(haystack), ZSTR_LEN(haystack));</span></a>
<a name="1821"><span class="lineNum">    1821 </span><span class="lineCov">        147 :         orig_needle = estrndup(ZSTR_VAL(needle), ZSTR_LEN(needle));</span></a>
<a name="1822"><span class="lineNum">    1822 </span><span class="lineCov">        147 :         found = php_stristr(haystack_dup, orig_needle, ZSTR_LEN(haystack), ZSTR_LEN(needle));</span></a>
<a name="1823"><span class="lineNum">    1823 </span><span class="lineCov">        147 :         efree(orig_needle);</span></a>
<a name="1824"><span class="lineNum">    1824 </span>            : </a>
<a name="1825"><span class="lineNum">    1825 </span><span class="lineCov">        147 :         if (found) {</span></a>
<a name="1826"><span class="lineNum">    1826 </span><span class="lineCov">         93 :                 found_offset = found - haystack_dup;</span></a>
<a name="1827"><span class="lineNum">    1827 </span><span class="lineCov">         93 :                 if (part) {</span></a>
<a name="1828"><span class="lineNum">    1828 </span><span class="lineCov">         18 :                         RETVAL_STRINGL(ZSTR_VAL(haystack), found_offset);</span></a>
<a name="1829"><span class="lineNum">    1829 </span>            :                 } else {</a>
<a name="1830"><span class="lineNum">    1830 </span><span class="lineCov">        168 :                         RETVAL_STRINGL(ZSTR_VAL(haystack) + found_offset, ZSTR_LEN(haystack) - found_offset);</span></a>
<a name="1831"><span class="lineNum">    1831 </span>            :                 }</a>
<a name="1832"><span class="lineNum">    1832 </span>            :         } else {</a>
<a name="1833"><span class="lineNum">    1833 </span><span class="lineCov">         54 :                 RETVAL_FALSE;</span></a>
<a name="1834"><span class="lineNum">    1834 </span>            :         }</a>
<a name="1835"><span class="lineNum">    1835 </span>            : </a>
<a name="1836"><span class="lineNum">    1836 </span><span class="lineCov">        147 :         efree(haystack_dup);</span></a>
<a name="1837"><span class="lineNum">    1837 </span>            : }</a>
<a name="1838"><span class="lineNum">    1838 </span>            : /* }}} */</a>
<a name="1839"><span class="lineNum">    1839 </span>            : </a>
<a name="1840"><span class="lineNum">    1840 </span>            : /* {{{ Finds first occurrence of a string within another */</a>
<a name="1841"><span class="lineNum">    1841 </span><span class="lineCov">      20499 : PHP_FUNCTION(strstr)</span></a>
<a name="1842"><span class="lineNum">    1842 </span>            : {</a>
<a name="1843"><span class="lineNum">    1843 </span>            :         zend_string *haystack, *needle;</a>
<a name="1844"><span class="lineNum">    1844 </span><span class="lineCov">      20499 :         const char *found = NULL;</span></a>
<a name="1845"><span class="lineNum">    1845 </span>            :         zend_long found_offset;</a>
<a name="1846"><span class="lineNum">    1846 </span><span class="lineCov">      20499 :         bool part = 0;</span></a>
<a name="1847"><span class="lineNum">    1847 </span>            : </a>
<a name="1848"><span class="lineNum">    1848 </span><span class="lineCov">      20499 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="1849"><span class="lineNum">    1849 </span><span class="lineCov">      40830 :                 Z_PARAM_STR(haystack)</span></a>
<a name="1850"><span class="lineNum">    1850 </span><span class="lineCov">      40806 :                 Z_PARAM_STR(needle)</span></a>
<a name="1851"><span class="lineNum">    1851 </span><span class="lineCov">      20403 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1852"><span class="lineNum">    1852 </span><span class="lineCov">      20814 :                 Z_PARAM_BOOL(part)</span></a>
<a name="1853"><span class="lineNum">    1853 </span><span class="lineCov">      20499 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1854"><span class="lineNum">    1854 </span>            : </a>
<a name="1855"><span class="lineNum">    1855 </span><span class="lineCov">      20403 :         found = php_memnstr(ZSTR_VAL(haystack), ZSTR_VAL(needle), ZSTR_LEN(needle), ZSTR_VAL(haystack) + ZSTR_LEN(haystack));</span></a>
<a name="1856"><span class="lineNum">    1856 </span>            : </a>
<a name="1857"><span class="lineNum">    1857 </span><span class="lineCov">      20403 :         if (found) {</span></a>
<a name="1858"><span class="lineNum">    1858 </span><span class="lineCov">       7635 :                 found_offset = found - ZSTR_VAL(haystack);</span></a>
<a name="1859"><span class="lineNum">    1859 </span><span class="lineCov">       7635 :                 if (part) {</span></a>
<a name="1860"><span class="lineNum">    1860 </span><span class="lineCov">        792 :                         RETURN_STRINGL(ZSTR_VAL(haystack), found_offset);</span></a>
<a name="1861"><span class="lineNum">    1861 </span>            :                 } else {</a>
<a name="1862"><span class="lineNum">    1862 </span><span class="lineCov">      14478 :                         RETURN_STRINGL(found, ZSTR_LEN(haystack) - found_offset);</span></a>
<a name="1863"><span class="lineNum">    1863 </span>            :                 }</a>
<a name="1864"><span class="lineNum">    1864 </span>            :         }</a>
<a name="1865"><span class="lineNum">    1865 </span><span class="lineCov">      12768 :         RETURN_FALSE;</span></a>
<a name="1866"><span class="lineNum">    1866 </span>            : }</a>
<a name="1867"><span class="lineNum">    1867 </span>            : /* }}} */</a>
<a name="1868"><span class="lineNum">    1868 </span>            : </a>
<a name="1869"><span class="lineNum">    1869 </span>            : /* {{{ Checks if a string contains another */</a>
<a name="1870"><span class="lineNum">    1870 </span><span class="lineCov">       5196 : PHP_FUNCTION(str_contains)</span></a>
<a name="1871"><span class="lineNum">    1871 </span>            : {</a>
<a name="1872"><span class="lineNum">    1872 </span>            :         zend_string *haystack, *needle;</a>
<a name="1873"><span class="lineNum">    1873 </span>            : </a>
<a name="1874"><span class="lineNum">    1874 </span><span class="lineCov">       5196 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="1875"><span class="lineNum">    1875 </span><span class="lineCov">      10296 :                 Z_PARAM_STR(haystack)</span></a>
<a name="1876"><span class="lineNum">    1876 </span><span class="lineCov">      10290 :                 Z_PARAM_STR(needle)</span></a>
<a name="1877"><span class="lineNum">    1877 </span><span class="lineCov">       5196 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1878"><span class="lineNum">    1878 </span>            : </a>
<a name="1879"><span class="lineNum">    1879 </span><span class="lineCov">      10290 :         RETURN_BOOL(php_memnstr(ZSTR_VAL(haystack), ZSTR_VAL(needle), ZSTR_LEN(needle), ZSTR_VAL(haystack) + ZSTR_LEN(haystack)));</span></a>
<a name="1880"><span class="lineNum">    1880 </span>            : }</a>
<a name="1881"><span class="lineNum">    1881 </span>            : /* }}} */</a>
<a name="1882"><span class="lineNum">    1882 </span>            : </a>
<a name="1883"><span class="lineNum">    1883 </span>            : /* {{{ Checks if haystack starts with needle */</a>
<a name="1884"><span class="lineNum">    1884 </span><span class="lineCov">      10335 : PHP_FUNCTION(str_starts_with)</span></a>
<a name="1885"><span class="lineNum">    1885 </span>            : {</a>
<a name="1886"><span class="lineNum">    1886 </span>            :         zend_string *haystack, *needle;</a>
<a name="1887"><span class="lineNum">    1887 </span>            : </a>
<a name="1888"><span class="lineNum">    1888 </span><span class="lineCov">      10335 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="1889"><span class="lineNum">    1889 </span><span class="lineCov">      20574 :                 Z_PARAM_STR(haystack)</span></a>
<a name="1890"><span class="lineNum">    1890 </span><span class="lineCov">      20568 :                 Z_PARAM_STR(needle)</span></a>
<a name="1891"><span class="lineNum">    1891 </span><span class="lineCov">      10335 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1892"><span class="lineNum">    1892 </span>            : </a>
<a name="1893"><span class="lineNum">    1893 </span><span class="lineCov">      10284 :         if (ZSTR_LEN(needle) &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="1894"><span class="lineNum">    1894 </span><span class="lineCov">        132 :                 RETURN_FALSE;</span></a>
<a name="1895"><span class="lineNum">    1895 </span>            :         }</a>
<a name="1896"><span class="lineNum">    1896 </span>            : </a>
<a name="1897"><span class="lineNum">    1897 </span><span class="lineCov">      10152 :         RETURN_BOOL(memcmp(ZSTR_VAL(haystack), ZSTR_VAL(needle), ZSTR_LEN(needle)) == 0);</span></a>
<a name="1898"><span class="lineNum">    1898 </span>            : }</a>
<a name="1899"><span class="lineNum">    1899 </span>            : /* }}} */</a>
<a name="1900"><span class="lineNum">    1900 </span>            : </a>
<a name="1901"><span class="lineNum">    1901 </span>            : /* {{{ Checks if haystack ends with needle */</a>
<a name="1902"><span class="lineNum">    1902 </span><span class="lineCov">        105 : PHP_FUNCTION(str_ends_with)</span></a>
<a name="1903"><span class="lineNum">    1903 </span>            : {</a>
<a name="1904"><span class="lineNum">    1904 </span>            :         zend_string *haystack, *needle;</a>
<a name="1905"><span class="lineNum">    1905 </span>            : </a>
<a name="1906"><span class="lineNum">    1906 </span><span class="lineCov">        105 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="1907"><span class="lineNum">    1907 </span><span class="lineCov">        114 :                 Z_PARAM_STR(haystack)</span></a>
<a name="1908"><span class="lineNum">    1908 </span><span class="lineCov">        108 :                 Z_PARAM_STR(needle)</span></a>
<a name="1909"><span class="lineNum">    1909 </span><span class="lineCov">        105 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1910"><span class="lineNum">    1910 </span>            : </a>
<a name="1911"><span class="lineNum">    1911 </span><span class="lineCov">         54 :         if (ZSTR_LEN(needle) &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="1912"><span class="lineNum">    1912 </span><span class="lineCov">         12 :                 RETURN_FALSE;</span></a>
<a name="1913"><span class="lineNum">    1913 </span>            :         }</a>
<a name="1914"><span class="lineNum">    1914 </span>            : </a>
<a name="1915"><span class="lineNum">    1915 </span><span class="lineCov">         42 :         RETURN_BOOL(memcmp(</span></a>
<a name="1916"><span class="lineNum">    1916 </span>            :                 ZSTR_VAL(haystack) + ZSTR_LEN(haystack) - ZSTR_LEN(needle),</a>
<a name="1917"><span class="lineNum">    1917 </span>            :                 ZSTR_VAL(needle), ZSTR_LEN(needle)) == 0);</a>
<a name="1918"><span class="lineNum">    1918 </span>            : }</a>
<a name="1919"><span class="lineNum">    1919 </span>            : /* }}} */</a>
<a name="1920"><span class="lineNum">    1920 </span>            : </a>
<a name="1921"><span class="lineNum">    1921 </span>            : /* {{{ An alias for strstr */</a>
<a name="1922"><span class="lineNum">    1922 </span>            : /* }}} */</a>
<a name="1923"><span class="lineNum">    1923 </span>            : </a>
<a name="1924"><span class="lineNum">    1924 </span>            : /* {{{ Finds position of first occurrence of a string within another */</a>
<a name="1925"><span class="lineNum">    1925 </span><span class="lineCov">       3997 : PHP_FUNCTION(strpos)</span></a>
<a name="1926"><span class="lineNum">    1926 </span>            : {</a>
<a name="1927"><span class="lineNum">    1927 </span>            :         zend_string *haystack, *needle;</a>
<a name="1928"><span class="lineNum">    1928 </span><span class="lineCov">       3997 :         const char *found = NULL;</span></a>
<a name="1929"><span class="lineNum">    1929 </span><span class="lineCov">       3997 :         zend_long offset = 0;</span></a>
<a name="1930"><span class="lineNum">    1930 </span>            : </a>
<a name="1931"><span class="lineNum">    1931 </span><span class="lineCov">       3997 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="1932"><span class="lineNum">    1932 </span><span class="lineCov">       7910 :                 Z_PARAM_STR(haystack)</span></a>
<a name="1933"><span class="lineNum">    1933 </span><span class="lineCov">       7898 :                 Z_PARAM_STR(needle)</span></a>
<a name="1934"><span class="lineNum">    1934 </span><span class="lineCov">       3949 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1935"><span class="lineNum">    1935 </span><span class="lineCov">       4030 :                 Z_PARAM_LONG(offset)</span></a>
<a name="1936"><span class="lineNum">    1936 </span><span class="lineCov">       3997 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1937"><span class="lineNum">    1937 </span>            : </a>
<a name="1938"><span class="lineNum">    1938 </span><span class="lineCov">       3940 :         if (offset &lt; 0) {</span></a>
<a name="1939"><span class="lineNum">    1939 </span><span class="lineCov">         18 :                 offset += (zend_long)ZSTR_LEN(haystack);</span></a>
<a name="1940"><span class="lineNum">    1940 </span>            :         }</a>
<a name="1941"><span class="lineNum">    1941 </span><span class="lineCov">       3940 :         if (offset &lt; 0 || (size_t)offset &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="1942"><span class="lineNum">    1942 </span><span class="lineCov">         12 :                 zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="1943"><span class="lineNum">    1943 </span><span class="lineCov">         12 :                 RETURN_THROWS();</span></a>
<a name="1944"><span class="lineNum">    1944 </span>            :         }</a>
<a name="1945"><span class="lineNum">    1945 </span>            : </a>
<a name="1946"><span class="lineNum">    1946 </span><span class="lineCov">       7856 :         found = (char*)php_memnstr(ZSTR_VAL(haystack) + offset,</span></a>
<a name="1947"><span class="lineNum">    1947 </span><span class="lineCov">       3928 :                                                 ZSTR_VAL(needle), ZSTR_LEN(needle),</span></a>
<a name="1948"><span class="lineNum">    1948 </span><span class="lineCov">       3928 :                                                 ZSTR_VAL(haystack) + ZSTR_LEN(haystack));</span></a>
<a name="1949"><span class="lineNum">    1949 </span>            : </a>
<a name="1950"><span class="lineNum">    1950 </span><span class="lineCov">       3928 :         if (found) {</span></a>
<a name="1951"><span class="lineNum">    1951 </span><span class="lineCov">        285 :                 RETURN_LONG(found - ZSTR_VAL(haystack));</span></a>
<a name="1952"><span class="lineNum">    1952 </span>            :         } else {</a>
<a name="1953"><span class="lineNum">    1953 </span><span class="lineCov">       3643 :                 RETURN_FALSE;</span></a>
<a name="1954"><span class="lineNum">    1954 </span>            :         }</a>
<a name="1955"><span class="lineNum">    1955 </span>            : }</a>
<a name="1956"><span class="lineNum">    1956 </span>            : /* }}} */</a>
<a name="1957"><span class="lineNum">    1957 </span>            : </a>
<a name="1958"><span class="lineNum">    1958 </span>            : /* {{{ Finds position of first occurrence of a string within another, case insensitive */</a>
<a name="1959"><span class="lineNum">    1959 </span><span class="lineCov">       1380 : PHP_FUNCTION(stripos)</span></a>
<a name="1960"><span class="lineNum">    1960 </span>            : {</a>
<a name="1961"><span class="lineNum">    1961 </span><span class="lineCov">       1380 :         const char *found = NULL;</span></a>
<a name="1962"><span class="lineNum">    1962 </span>            :         zend_string *haystack, *needle;</a>
<a name="1963"><span class="lineNum">    1963 </span><span class="lineCov">       1380 :         zend_long offset = 0;</span></a>
<a name="1964"><span class="lineNum">    1964 </span><span class="lineCov">       1380 :         zend_string *needle_dup = NULL, *haystack_dup;</span></a>
<a name="1965"><span class="lineNum">    1965 </span>            : </a>
<a name="1966"><span class="lineNum">    1966 </span><span class="lineCov">       1380 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="1967"><span class="lineNum">    1967 </span><span class="lineCov">       2676 :                 Z_PARAM_STR(haystack)</span></a>
<a name="1968"><span class="lineNum">    1968 </span><span class="lineCov">       2664 :                 Z_PARAM_STR(needle)</span></a>
<a name="1969"><span class="lineNum">    1969 </span><span class="lineCov">       1332 :                 Z_PARAM_OPTIONAL</span></a>
<a name="1970"><span class="lineNum">    1970 </span><span class="lineCov">       2226 :                 Z_PARAM_LONG(offset)</span></a>
<a name="1971"><span class="lineNum">    1971 </span><span class="lineCov">       1380 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="1972"><span class="lineNum">    1972 </span>            : </a>
<a name="1973"><span class="lineNum">    1973 </span><span class="lineCov">       1332 :         if (offset &lt; 0) {</span></a>
<a name="1974"><span class="lineNum">    1974 </span><span class="lineCov">         33 :                 offset += (zend_long)ZSTR_LEN(haystack);</span></a>
<a name="1975"><span class="lineNum">    1975 </span>            :         }</a>
<a name="1976"><span class="lineNum">    1976 </span><span class="lineCov">       1332 :         if (offset &lt; 0 || (size_t)offset &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="1977"><span class="lineNum">    1977 </span><span class="lineCov">         12 :                 zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="1978"><span class="lineNum">    1978 </span><span class="lineCov">         12 :                 RETURN_THROWS();</span></a>
<a name="1979"><span class="lineNum">    1979 </span>            :         }</a>
<a name="1980"><span class="lineNum">    1980 </span>            : </a>
<a name="1981"><span class="lineNum">    1981 </span><span class="lineCov">       1320 :         if (ZSTR_LEN(needle) &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="1982"><span class="lineNum">    1982 </span><span class="lineCov">          9 :                 RETURN_FALSE;</span></a>
<a name="1983"><span class="lineNum">    1983 </span>            :         }</a>
<a name="1984"><span class="lineNum">    1984 </span>            : </a>
<a name="1985"><span class="lineNum">    1985 </span><span class="lineCov">       1311 :         haystack_dup = php_string_tolower(haystack);</span></a>
<a name="1986"><span class="lineNum">    1986 </span><span class="lineCov">       1311 :         needle_dup = php_string_tolower(needle);</span></a>
<a name="1987"><span class="lineNum">    1987 </span><span class="lineCov">       2622 :         found = (char*)php_memnstr(ZSTR_VAL(haystack_dup) + offset,</span></a>
<a name="1988"><span class="lineNum">    1988 </span><span class="lineCov">       1311 :                         ZSTR_VAL(needle_dup), ZSTR_LEN(needle_dup), ZSTR_VAL(haystack_dup) + ZSTR_LEN(haystack));</span></a>
<a name="1989"><span class="lineNum">    1989 </span>            : </a>
<a name="1990"><span class="lineNum">    1990 </span><span class="lineCov">       1311 :         if (found) {</span></a>
<a name="1991"><span class="lineNum">    1991 </span><span class="lineCov">       1035 :                 RETVAL_LONG(found - ZSTR_VAL(haystack_dup));</span></a>
<a name="1992"><span class="lineNum">    1992 </span>            :         } else {</a>
<a name="1993"><span class="lineNum">    1993 </span><span class="lineCov">        276 :                 RETVAL_FALSE;</span></a>
<a name="1994"><span class="lineNum">    1994 </span>            :         }</a>
<a name="1995"><span class="lineNum">    1995 </span>            : </a>
<a name="1996"><span class="lineNum">    1996 </span>            :         zend_string_release_ex(haystack_dup, 0);</a>
<a name="1997"><span class="lineNum">    1997 </span>            :         zend_string_release_ex(needle_dup, 0);</a>
<a name="1998"><span class="lineNum">    1998 </span>            : }</a>
<a name="1999"><span class="lineNum">    1999 </span>            : /* }}} */</a>
<a name="2000"><span class="lineNum">    2000 </span>            : </a>
<a name="2001"><span class="lineNum">    2001 </span>            : /* {{{ Finds position of last occurrence of a string within another string */</a>
<a name="2002"><span class="lineNum">    2002 </span><span class="lineCov">        675 : PHP_FUNCTION(strrpos)</span></a>
<a name="2003"><span class="lineNum">    2003 </span>            : {</a>
<a name="2004"><span class="lineNum">    2004 </span>            :         zend_string *needle;</a>
<a name="2005"><span class="lineNum">    2005 </span>            :         zend_string *haystack;</a>
<a name="2006"><span class="lineNum">    2006 </span><span class="lineCov">        675 :         zend_long offset = 0;</span></a>
<a name="2007"><span class="lineNum">    2007 </span>            :         const char *p, *e, *found;</a>
<a name="2008"><span class="lineNum">    2008 </span>            : </a>
<a name="2009"><span class="lineNum">    2009 </span><span class="lineCov">        675 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="2010"><span class="lineNum">    2010 </span><span class="lineCov">       1266 :                 Z_PARAM_STR(haystack)</span></a>
<a name="2011"><span class="lineNum">    2011 </span><span class="lineCov">       1254 :                 Z_PARAM_STR(needle)</span></a>
<a name="2012"><span class="lineNum">    2012 </span><span class="lineCov">        627 :                 Z_PARAM_OPTIONAL</span></a>
<a name="2013"><span class="lineNum">    2013 </span><span class="lineCov">        945 :                 Z_PARAM_LONG(offset)</span></a>
<a name="2014"><span class="lineNum">    2014 </span><span class="lineCov">        675 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2015"><span class="lineNum">    2015 </span>            : </a>
<a name="2016"><span class="lineNum">    2016 </span><span class="lineCov">        624 :         if (offset &gt;= 0) {</span></a>
<a name="2017"><span class="lineNum">    2017 </span><span class="lineCov">        573 :                 if ((size_t)offset &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="2018"><span class="lineNum">    2018 </span><span class="lineCov">          6 :                         zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="2019"><span class="lineNum">    2019 </span><span class="lineCov">          6 :                         RETURN_THROWS();</span></a>
<a name="2020"><span class="lineNum">    2020 </span>            :                 }</a>
<a name="2021"><span class="lineNum">    2021 </span><span class="lineCov">        567 :                 p = ZSTR_VAL(haystack) + (size_t)offset;</span></a>
<a name="2022"><span class="lineNum">    2022 </span><span class="lineCov">        567 :                 e = ZSTR_VAL(haystack) + ZSTR_LEN(haystack);</span></a>
<a name="2023"><span class="lineNum">    2023 </span>            :         } else {</a>
<a name="2024"><span class="lineNum">    2024 </span><span class="lineCov">         51 :                 if (offset &lt; -ZEND_LONG_MAX || (size_t)(-offset) &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="2025"><span class="lineNum">    2025 </span><span class="lineCov">         15 :                         zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="2026"><span class="lineNum">    2026 </span><span class="lineCov">         15 :                         RETURN_THROWS();</span></a>
<a name="2027"><span class="lineNum">    2027 </span>            :                 }</a>
<a name="2028"><span class="lineNum">    2028 </span>            : </a>
<a name="2029"><span class="lineNum">    2029 </span><span class="lineCov">         36 :                 p = ZSTR_VAL(haystack);</span></a>
<a name="2030"><span class="lineNum">    2030 </span><span class="lineCov">         36 :                 if ((size_t)-offset &lt; ZSTR_LEN(needle)) {</span></a>
<a name="2031"><span class="lineNum">    2031 </span><span class="lineCov">          6 :                         e = ZSTR_VAL(haystack) + ZSTR_LEN(haystack);</span></a>
<a name="2032"><span class="lineNum">    2032 </span>            :                 } else {</a>
<a name="2033"><span class="lineNum">    2033 </span><span class="lineCov">         30 :                         e = ZSTR_VAL(haystack) + ZSTR_LEN(haystack) + offset + ZSTR_LEN(needle);</span></a>
<a name="2034"><span class="lineNum">    2034 </span>            :                 }</a>
<a name="2035"><span class="lineNum">    2035 </span>            :         }</a>
<a name="2036"><span class="lineNum">    2036 </span>            : </a>
<a name="2037"><span class="lineNum">    2037 </span><span class="lineCov">       1206 :         if ((found = zend_memnrstr(p, ZSTR_VAL(needle), ZSTR_LEN(needle), e))) {</span></a>
<a name="2038"><span class="lineNum">    2038 </span><span class="lineCov">        432 :                 RETURN_LONG(found - ZSTR_VAL(haystack));</span></a>
<a name="2039"><span class="lineNum">    2039 </span>            :         }</a>
<a name="2040"><span class="lineNum">    2040 </span>            : </a>
<a name="2041"><span class="lineNum">    2041 </span><span class="lineCov">        171 :         RETURN_FALSE;</span></a>
<a name="2042"><span class="lineNum">    2042 </span>            : }</a>
<a name="2043"><span class="lineNum">    2043 </span>            : /* }}} */</a>
<a name="2044"><span class="lineNum">    2044 </span>            : </a>
<a name="2045"><span class="lineNum">    2045 </span>            : /* {{{ Finds position of last occurrence of a string within another string */</a>
<a name="2046"><span class="lineNum">    2046 </span><span class="lineCov">       1089 : PHP_FUNCTION(strripos)</span></a>
<a name="2047"><span class="lineNum">    2047 </span>            : {</a>
<a name="2048"><span class="lineNum">    2048 </span>            :         zend_string *needle;</a>
<a name="2049"><span class="lineNum">    2049 </span>            :         zend_string *haystack;</a>
<a name="2050"><span class="lineNum">    2050 </span><span class="lineCov">       1089 :         zend_long offset = 0;</span></a>
<a name="2051"><span class="lineNum">    2051 </span>            :         const char *p, *e, *found;</a>
<a name="2052"><span class="lineNum">    2052 </span>            :         zend_string *needle_dup, *haystack_dup;</a>
<a name="2053"><span class="lineNum">    2053 </span>            : </a>
<a name="2054"><span class="lineNum">    2054 </span><span class="lineCov">       1089 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="2055"><span class="lineNum">    2055 </span><span class="lineCov">       2094 :                 Z_PARAM_STR(haystack)</span></a>
<a name="2056"><span class="lineNum">    2056 </span><span class="lineCov">       2082 :                 Z_PARAM_STR(needle)</span></a>
<a name="2057"><span class="lineNum">    2057 </span><span class="lineCov">       1041 :                 Z_PARAM_OPTIONAL</span></a>
<a name="2058"><span class="lineNum">    2058 </span><span class="lineCov">       1785 :                 Z_PARAM_LONG(offset)</span></a>
<a name="2059"><span class="lineNum">    2059 </span><span class="lineCov">       1089 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2060"><span class="lineNum">    2060 </span>            : </a>
<a name="2061"><span class="lineNum">    2061 </span><span class="lineCov">       1038 :         if (ZSTR_LEN(needle) == 1) {</span></a>
<a name="2062"><span class="lineNum">    2062 </span>            :                 /* Single character search can shortcut memcmps</a>
<a name="2063"><span class="lineNum">    2063 </span>            :                    Can also avoid tolower emallocs */</a>
<a name="2064"><span class="lineNum">    2064 </span>            :                 char lowered;</a>
<a name="2065"><span class="lineNum">    2065 </span><span class="lineCov">        381 :                 if (offset &gt;= 0) {</span></a>
<a name="2066"><span class="lineNum">    2066 </span><span class="lineCov">        279 :                         if ((size_t)offset &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="2067"><span class="lineNum">    2067 </span><span class="lineNoCov">          0 :                                 zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="2068"><span class="lineNum">    2068 </span><span class="lineNoCov">          0 :                                 RETURN_THROWS();</span></a>
<a name="2069"><span class="lineNum">    2069 </span>            :                         }</a>
<a name="2070"><span class="lineNum">    2070 </span><span class="lineCov">        279 :                         p = ZSTR_VAL(haystack) + (size_t)offset;</span></a>
<a name="2071"><span class="lineNum">    2071 </span><span class="lineCov">        279 :                         e = ZSTR_VAL(haystack) + ZSTR_LEN(haystack) - 1;</span></a>
<a name="2072"><span class="lineNum">    2072 </span>            :                 } else {</a>
<a name="2073"><span class="lineNum">    2073 </span><span class="lineCov">        102 :                         p = ZSTR_VAL(haystack);</span></a>
<a name="2074"><span class="lineNum">    2074 </span><span class="lineCov">        102 :                         if (offset &lt; -ZEND_LONG_MAX || (size_t)(-offset) &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="2075"><span class="lineNum">    2075 </span><span class="lineCov">          3 :                                 zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="2076"><span class="lineNum">    2076 </span><span class="lineCov">          3 :                                 RETURN_THROWS();</span></a>
<a name="2077"><span class="lineNum">    2077 </span>            :                         }</a>
<a name="2078"><span class="lineNum">    2078 </span><span class="lineCov">         99 :                         e = ZSTR_VAL(haystack) + (ZSTR_LEN(haystack) + (size_t)offset);</span></a>
<a name="2079"><span class="lineNum">    2079 </span>            :                 }</a>
<a name="2080"><span class="lineNum">    2080 </span>            :                 /* Borrow that ord_needle buffer to avoid repeatedly tolower()ing needle */</a>
<a name="2081"><span class="lineNum">    2081 </span><span class="lineCov">        378 :                 lowered = tolower(*ZSTR_VAL(needle));</span></a>
<a name="2082"><span class="lineNum">    2082 </span><span class="lineCov">       7425 :                 while (e &gt;= p) {</span></a>
<a name="2083"><span class="lineNum">    2083 </span><span class="lineCov">       7374 :                         if (tolower(*e) == lowered) {</span></a>
<a name="2084"><span class="lineNum">    2084 </span><span class="lineCov">        327 :                                 RETURN_LONG(e - p + (offset &gt; 0 ? offset : 0));</span></a>
<a name="2085"><span class="lineNum">    2085 </span>            :                         }</a>
<a name="2086"><span class="lineNum">    2086 </span><span class="lineCov">       7047 :                         e--;</span></a>
<a name="2087"><span class="lineNum">    2087 </span>            :                 }</a>
<a name="2088"><span class="lineNum">    2088 </span><span class="lineCov">         51 :                 RETURN_FALSE;</span></a>
<a name="2089"><span class="lineNum">    2089 </span>            :         }</a>
<a name="2090"><span class="lineNum">    2090 </span>            : </a>
<a name="2091"><span class="lineNum">    2091 </span><span class="lineCov">        657 :         haystack_dup = php_string_tolower(haystack);</span></a>
<a name="2092"><span class="lineNum">    2092 </span><span class="lineCov">        657 :         if (offset &gt;= 0) {</span></a>
<a name="2093"><span class="lineNum">    2093 </span><span class="lineCov">        492 :                 if ((size_t)offset &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="2094"><span class="lineNum">    2094 </span>            :                         zend_string_release_ex(haystack_dup, 0);</a>
<a name="2095"><span class="lineNum">    2095 </span><span class="lineCov">          6 :                         zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="2096"><span class="lineNum">    2096 </span><span class="lineCov">          6 :                         RETURN_THROWS();</span></a>
<a name="2097"><span class="lineNum">    2097 </span>            :                 }</a>
<a name="2098"><span class="lineNum">    2098 </span><span class="lineCov">        486 :                 p = ZSTR_VAL(haystack_dup) + offset;</span></a>
<a name="2099"><span class="lineNum">    2099 </span><span class="lineCov">        486 :                 e = ZSTR_VAL(haystack_dup) + ZSTR_LEN(haystack);</span></a>
<a name="2100"><span class="lineNum">    2100 </span>            :         } else {</a>
<a name="2101"><span class="lineNum">    2101 </span><span class="lineCov">        165 :                 if (offset &lt; -ZEND_LONG_MAX || (size_t)(-offset) &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="2102"><span class="lineNum">    2102 </span>            :                         zend_string_release_ex(haystack_dup, 0);</a>
<a name="2103"><span class="lineNum">    2103 </span><span class="lineCov">         12 :                         zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="2104"><span class="lineNum">    2104 </span><span class="lineCov">         12 :                         RETURN_THROWS();</span></a>
<a name="2105"><span class="lineNum">    2105 </span>            :                 }</a>
<a name="2106"><span class="lineNum">    2106 </span>            : </a>
<a name="2107"><span class="lineNum">    2107 </span><span class="lineCov">        153 :                 p = ZSTR_VAL(haystack_dup);</span></a>
<a name="2108"><span class="lineNum">    2108 </span><span class="lineCov">        153 :                 if ((size_t)-offset &lt; ZSTR_LEN(needle)) {</span></a>
<a name="2109"><span class="lineNum">    2109 </span><span class="lineCov">        111 :                         e = ZSTR_VAL(haystack_dup) + ZSTR_LEN(haystack);</span></a>
<a name="2110"><span class="lineNum">    2110 </span>            :                 } else {</a>
<a name="2111"><span class="lineNum">    2111 </span><span class="lineCov">         42 :                         e = ZSTR_VAL(haystack_dup) + ZSTR_LEN(haystack) + offset + ZSTR_LEN(needle);</span></a>
<a name="2112"><span class="lineNum">    2112 </span>            :                 }</a>
<a name="2113"><span class="lineNum">    2113 </span>            :         }</a>
<a name="2114"><span class="lineNum">    2114 </span>            : </a>
<a name="2115"><span class="lineNum">    2115 </span><span class="lineCov">        639 :         needle_dup = php_string_tolower(needle);</span></a>
<a name="2116"><span class="lineNum">    2116 </span><span class="lineCov">       1278 :         if ((found = (char *)zend_memnrstr(p, ZSTR_VAL(needle_dup), ZSTR_LEN(needle_dup), e))) {</span></a>
<a name="2117"><span class="lineNum">    2117 </span><span class="lineCov">        480 :                 RETVAL_LONG(found - ZSTR_VAL(haystack_dup));</span></a>
<a name="2118"><span class="lineNum">    2118 </span>            :                 zend_string_release_ex(needle_dup, 0);</a>
<a name="2119"><span class="lineNum">    2119 </span>            :                 zend_string_release_ex(haystack_dup, 0);</a>
<a name="2120"><span class="lineNum">    2120 </span>            :         } else {</a>
<a name="2121"><span class="lineNum">    2121 </span>            :                 zend_string_release_ex(needle_dup, 0);</a>
<a name="2122"><span class="lineNum">    2122 </span>            :                 zend_string_release_ex(haystack_dup, 0);</a>
<a name="2123"><span class="lineNum">    2123 </span><span class="lineCov">        159 :                 RETURN_FALSE;</span></a>
<a name="2124"><span class="lineNum">    2124 </span>            :         }</a>
<a name="2125"><span class="lineNum">    2125 </span>            : }</a>
<a name="2126"><span class="lineNum">    2126 </span>            : /* }}} */</a>
<a name="2127"><span class="lineNum">    2127 </span>            : </a>
<a name="2128"><span class="lineNum">    2128 </span>            : /* {{{ Finds the last occurrence of a character in a string within another */</a>
<a name="2129"><span class="lineNum">    2129 </span><span class="lineCov">        513 : PHP_FUNCTION(strrchr)</span></a>
<a name="2130"><span class="lineNum">    2130 </span>            : {</a>
<a name="2131"><span class="lineNum">    2131 </span>            :         zend_string *haystack, *needle;</a>
<a name="2132"><span class="lineNum">    2132 </span><span class="lineCov">        513 :         const char *found = NULL;</span></a>
<a name="2133"><span class="lineNum">    2133 </span>            :         zend_long found_offset;</a>
<a name="2134"><span class="lineNum">    2134 </span>            : </a>
<a name="2135"><span class="lineNum">    2135 </span><span class="lineCov">        513 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="2136"><span class="lineNum">    2136 </span><span class="lineCov">        930 :                 Z_PARAM_STR(haystack)</span></a>
<a name="2137"><span class="lineNum">    2137 </span><span class="lineCov">        924 :                 Z_PARAM_STR(needle)</span></a>
<a name="2138"><span class="lineNum">    2138 </span><span class="lineCov">        513 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2139"><span class="lineNum">    2139 </span>            : </a>
<a name="2140"><span class="lineNum">    2140 </span><span class="lineCov">        462 :         found = zend_memrchr(ZSTR_VAL(haystack), *ZSTR_VAL(needle), ZSTR_LEN(haystack));</span></a>
<a name="2141"><span class="lineNum">    2141 </span><span class="lineCov">        462 :         if (found) {</span></a>
<a name="2142"><span class="lineNum">    2142 </span><span class="lineCov">        393 :                 found_offset = found - ZSTR_VAL(haystack);</span></a>
<a name="2143"><span class="lineNum">    2143 </span><span class="lineCov">        786 :                 RETURN_STRINGL(found, ZSTR_LEN(haystack) - found_offset);</span></a>
<a name="2144"><span class="lineNum">    2144 </span>            :         } else {</a>
<a name="2145"><span class="lineNum">    2145 </span><span class="lineCov">         69 :                 RETURN_FALSE;</span></a>
<a name="2146"><span class="lineNum">    2146 </span>            :         }</a>
<a name="2147"><span class="lineNum">    2147 </span>            : }</a>
<a name="2148"><span class="lineNum">    2148 </span>            : /* }}} */</a>
<a name="2149"><span class="lineNum">    2149 </span>            : </a>
<a name="2150"><span class="lineNum">    2150 </span>            : /* {{{ php_chunk_split */</a>
<a name="2151"><span class="lineNum">    2151 </span><span class="lineCov">        249 : static zend_string *php_chunk_split(const char *src, size_t srclen, const char *end, size_t endlen, size_t chunklen)</span></a>
<a name="2152"><span class="lineNum">    2152 </span>            : {</a>
<a name="2153"><span class="lineNum">    2153 </span>            :         char *q;</a>
<a name="2154"><span class="lineNum">    2154 </span>            :         const char *p;</a>
<a name="2155"><span class="lineNum">    2155 </span>            :         size_t chunks;</a>
<a name="2156"><span class="lineNum">    2156 </span>            :         size_t restlen;</a>
<a name="2157"><span class="lineNum">    2157 </span>            :         zend_string *dest;</a>
<a name="2158"><span class="lineNum">    2158 </span>            : </a>
<a name="2159"><span class="lineNum">    2159 </span><span class="lineCov">        249 :         chunks = srclen / chunklen;</span></a>
<a name="2160"><span class="lineNum">    2160 </span><span class="lineCov">        249 :         restlen = srclen - chunks * chunklen; /* srclen % chunklen */</span></a>
<a name="2161"><span class="lineNum">    2161 </span><span class="lineCov">        249 :         if (restlen) {</span></a>
<a name="2162"><span class="lineNum">    2162 </span>            :                 /* We want chunks to be rounded up rather than rounded down.</a>
<a name="2163"><span class="lineNum">    2163 </span>            :                  * Increment can't overflow because chunks &lt;= SIZE_MAX/2 at this point. */</a>
<a name="2164"><span class="lineNum">    2164 </span><span class="lineCov">        225 :                 chunks++;</span></a>
<a name="2165"><span class="lineNum">    2165 </span>            :         }</a>
<a name="2166"><span class="lineNum">    2166 </span>            : </a>
<a name="2167"><span class="lineNum">    2167 </span><span class="lineCov">        246 :         dest = zend_string_safe_alloc(chunks, endlen, srclen, 0);</span></a>
<a name="2168"><span class="lineNum">    2168 </span>            : </a>
<a name="2169"><span class="lineNum">    2169 </span><span class="lineCov">       3051 :         for (p = src, q = ZSTR_VAL(dest); p &lt; (src + srclen - chunklen + 1); ) {</span></a>
<a name="2170"><span class="lineNum">    2170 </span><span class="lineCov">       2805 :                 memcpy(q, p, chunklen);</span></a>
<a name="2171"><span class="lineNum">    2171 </span><span class="lineCov">       2805 :                 q += chunklen;</span></a>
<a name="2172"><span class="lineNum">    2172 </span><span class="lineCov">       2805 :                 memcpy(q, end, endlen);</span></a>
<a name="2173"><span class="lineNum">    2173 </span><span class="lineCov">       2805 :                 q += endlen;</span></a>
<a name="2174"><span class="lineNum">    2174 </span><span class="lineCov">       2805 :                 p += chunklen;</span></a>
<a name="2175"><span class="lineNum">    2175 </span>            :         }</a>
<a name="2176"><span class="lineNum">    2176 </span>            : </a>
<a name="2177"><span class="lineNum">    2177 </span><span class="lineCov">        246 :         if (restlen) {</span></a>
<a name="2178"><span class="lineNum">    2178 </span><span class="lineCov">        225 :                 memcpy(q, p, restlen);</span></a>
<a name="2179"><span class="lineNum">    2179 </span><span class="lineCov">        225 :                 q += restlen;</span></a>
<a name="2180"><span class="lineNum">    2180 </span><span class="lineCov">        225 :                 memcpy(q, end, endlen);</span></a>
<a name="2181"><span class="lineNum">    2181 </span><span class="lineCov">        225 :                 q += endlen;</span></a>
<a name="2182"><span class="lineNum">    2182 </span>            :         }</a>
<a name="2183"><span class="lineNum">    2183 </span>            : </a>
<a name="2184"><span class="lineNum">    2184 </span><span class="lineCov">        246 :         *q = '\0';</span></a>
<a name="2185"><span class="lineNum">    2185 </span><span class="lineCov">        246 :         ZEND_ASSERT(q - ZSTR_VAL(dest) == ZSTR_LEN(dest));</span></a>
<a name="2186"><span class="lineNum">    2186 </span>            : </a>
<a name="2187"><span class="lineNum">    2187 </span><span class="lineCov">        246 :         return dest;</span></a>
<a name="2188"><span class="lineNum">    2188 </span>            : }</a>
<a name="2189"><span class="lineNum">    2189 </span>            : /* }}} */</a>
<a name="2190"><span class="lineNum">    2190 </span>            : </a>
<a name="2191"><span class="lineNum">    2191 </span>            : /* {{{ Returns split line */</a>
<a name="2192"><span class="lineNum">    2192 </span><span class="lineCov">        378 : PHP_FUNCTION(chunk_split)</span></a>
<a name="2193"><span class="lineNum">    2193 </span>            : {</a>
<a name="2194"><span class="lineNum">    2194 </span>            :         zend_string *str;</a>
<a name="2195"><span class="lineNum">    2195 </span><span class="lineCov">        378 :         char *end    = &quot;\r\n&quot;;</span></a>
<a name="2196"><span class="lineNum">    2196 </span><span class="lineCov">        378 :         size_t endlen   = 2;</span></a>
<a name="2197"><span class="lineNum">    2197 </span><span class="lineCov">        378 :         zend_long chunklen = 76;</span></a>
<a name="2198"><span class="lineNum">    2198 </span>            :         zend_string *result;</a>
<a name="2199"><span class="lineNum">    2199 </span>            : </a>
<a name="2200"><span class="lineNum">    2200 </span><span class="lineCov">        378 :         ZEND_PARSE_PARAMETERS_START(1, 3)</span></a>
<a name="2201"><span class="lineNum">    2201 </span><span class="lineCov">        684 :                 Z_PARAM_STR(str)</span></a>
<a name="2202"><span class="lineNum">    2202 </span><span class="lineCov">        333 :                 Z_PARAM_OPTIONAL</span></a>
<a name="2203"><span class="lineNum">    2203 </span><span class="lineCov">        642 :                 Z_PARAM_LONG(chunklen)</span></a>
<a name="2204"><span class="lineNum">    2204 </span><span class="lineCov">        570 :                 Z_PARAM_STRING(end, endlen)</span></a>
<a name="2205"><span class="lineNum">    2205 </span><span class="lineCov">        378 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2206"><span class="lineNum">    2206 </span>            : </a>
<a name="2207"><span class="lineNum">    2207 </span><span class="lineCov">        327 :         if (chunklen &lt;= 0) {</span></a>
<a name="2208"><span class="lineNum">    2208 </span><span class="lineCov">         24 :                 zend_argument_value_error(2, &quot;must be greater than 0&quot;);</span></a>
<a name="2209"><span class="lineNum">    2209 </span><span class="lineCov">         24 :                 RETURN_THROWS();</span></a>
<a name="2210"><span class="lineNum">    2210 </span>            :         }</a>
<a name="2211"><span class="lineNum">    2211 </span>            : </a>
<a name="2212"><span class="lineNum">    2212 </span><span class="lineCov">        303 :         if ((size_t)chunklen &gt; ZSTR_LEN(str)) {</span></a>
<a name="2213"><span class="lineNum">    2213 </span>            :                 /* to maintain BC, we must return original string + ending */</a>
<a name="2214"><span class="lineNum">    2214 </span><span class="lineCov">         54 :                 result = zend_string_safe_alloc(ZSTR_LEN(str), 1, endlen, 0);</span></a>
<a name="2215"><span class="lineNum">    2215 </span><span class="lineCov">         54 :                 memcpy(ZSTR_VAL(result), ZSTR_VAL(str), ZSTR_LEN(str));</span></a>
<a name="2216"><span class="lineNum">    2216 </span><span class="lineCov">         54 :                 memcpy(ZSTR_VAL(result) + ZSTR_LEN(str), end, endlen);</span></a>
<a name="2217"><span class="lineNum">    2217 </span><span class="lineCov">         54 :                 ZSTR_VAL(result)[ZSTR_LEN(result)] = '\0';</span></a>
<a name="2218"><span class="lineNum">    2218 </span><span class="lineCov">         54 :                 RETURN_NEW_STR(result);</span></a>
<a name="2219"><span class="lineNum">    2219 </span>            :         }</a>
<a name="2220"><span class="lineNum">    2220 </span>            : </a>
<a name="2221"><span class="lineNum">    2221 </span><span class="lineCov">        249 :         if (!ZSTR_LEN(str)) {</span></a>
<a name="2222"><span class="lineNum">    2222 </span><span class="lineNoCov">          0 :                 RETURN_EMPTY_STRING();</span></a>
<a name="2223"><span class="lineNum">    2223 </span>            :         }</a>
<a name="2224"><span class="lineNum">    2224 </span>            : </a>
<a name="2225"><span class="lineNum">    2225 </span><span class="lineCov">        249 :         result = php_chunk_split(ZSTR_VAL(str), ZSTR_LEN(str), end, endlen, (size_t)chunklen);</span></a>
<a name="2226"><span class="lineNum">    2226 </span>            : </a>
<a name="2227"><span class="lineNum">    2227 </span><span class="lineCov">        492 :         RETURN_STR(result);</span></a>
<a name="2228"><span class="lineNum">    2228 </span>            : }</a>
<a name="2229"><span class="lineNum">    2229 </span>            : /* }}} */</a>
<a name="2230"><span class="lineNum">    2230 </span>            : </a>
<a name="2231"><span class="lineNum">    2231 </span>            : /* {{{ Returns part of a string */</a>
<a name="2232"><span class="lineNum">    2232 </span><span class="lineCov">      40954 : PHP_FUNCTION(substr)</span></a>
<a name="2233"><span class="lineNum">    2233 </span>            : {</a>
<a name="2234"><span class="lineNum">    2234 </span>            :         zend_string *str;</a>
<a name="2235"><span class="lineNum">    2235 </span><span class="lineCov">      40954 :         zend_long l = 0, f;</span></a>
<a name="2236"><span class="lineNum">    2236 </span><span class="lineCov">      40954 :         bool len_is_null = 1;</span></a>
<a name="2237"><span class="lineNum">    2237 </span>            : </a>
<a name="2238"><span class="lineNum">    2238 </span><span class="lineCov">      40954 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="2239"><span class="lineNum">    2239 </span><span class="lineCov">      81812 :                 Z_PARAM_STR(str)</span></a>
<a name="2240"><span class="lineNum">    2240 </span><span class="lineCov">      81794 :                 Z_PARAM_LONG(f)</span></a>
<a name="2241"><span class="lineNum">    2241 </span><span class="lineCov">      40897 :                 Z_PARAM_OPTIONAL</span></a>
<a name="2242"><span class="lineNum">    2242 </span><span class="lineCov">      67978 :                 Z_PARAM_LONG_OR_NULL(l, len_is_null)</span></a>
<a name="2243"><span class="lineNum">    2243 </span><span class="lineCov">      40954 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2244"><span class="lineNum">    2244 </span>            : </a>
<a name="2245"><span class="lineNum">    2245 </span><span class="lineCov">      40897 :         if (f &lt; 0) {</span></a>
<a name="2246"><span class="lineNum">    2246 </span>            :                 /* if &quot;from&quot; position is negative, count start position from the end</a>
<a name="2247"><span class="lineNum">    2247 </span>            :                  * of the string</a>
<a name="2248"><span class="lineNum">    2248 </span>            :                  */</a>
<a name="2249"><span class="lineNum">    2249 </span><span class="lineCov">       8266 :                 if (-(size_t)f &gt; ZSTR_LEN(str)) {</span></a>
<a name="2250"><span class="lineNum">    2250 </span><span class="lineCov">         21 :                         f = 0;</span></a>
<a name="2251"><span class="lineNum">    2251 </span>            :                 } else {</a>
<a name="2252"><span class="lineNum">    2252 </span><span class="lineCov">       8245 :                         f = (zend_long)ZSTR_LEN(str) + f;</span></a>
<a name="2253"><span class="lineNum">    2253 </span>            :                 }</a>
<a name="2254"><span class="lineNum">    2254 </span><span class="lineCov">      32631 :         } else if ((size_t)f &gt; ZSTR_LEN(str)) {</span></a>
<a name="2255"><span class="lineNum">    2255 </span><span class="lineCov">         36 :                 RETURN_EMPTY_STRING();</span></a>
<a name="2256"><span class="lineNum">    2256 </span>            :         }</a>
<a name="2257"><span class="lineNum">    2257 </span>            : </a>
<a name="2258"><span class="lineNum">    2258 </span><span class="lineCov">      40861 :         if (!len_is_null) {</span></a>
<a name="2259"><span class="lineNum">    2259 </span><span class="lineCov">      27060 :                 if (l &lt; 0) {</span></a>
<a name="2260"><span class="lineNum">    2260 </span>            :                         /* if &quot;length&quot; position is negative, set it to the length</a>
<a name="2261"><span class="lineNum">    2261 </span>            :                          * needed to stop that many chars from the end of the string</a>
<a name="2262"><span class="lineNum">    2262 </span>            :                          */</a>
<a name="2263"><span class="lineNum">    2263 </span><span class="lineCov">        277 :                         if (-(size_t)l &gt; ZSTR_LEN(str) - (size_t)f) {</span></a>
<a name="2264"><span class="lineNum">    2264 </span><span class="lineCov">         33 :                                 l = 0;</span></a>
<a name="2265"><span class="lineNum">    2265 </span>            :                         } else {</a>
<a name="2266"><span class="lineNum">    2266 </span><span class="lineCov">        244 :                                 l = (zend_long)ZSTR_LEN(str) - f + l;</span></a>
<a name="2267"><span class="lineNum">    2267 </span>            :                         }</a>
<a name="2268"><span class="lineNum">    2268 </span><span class="lineCov">      26783 :                 } else if ((size_t)l &gt; ZSTR_LEN(str) - (size_t)f) {</span></a>
<a name="2269"><span class="lineNum">    2269 </span><span class="lineCov">        893 :                         l = (zend_long)ZSTR_LEN(str) - f;</span></a>
<a name="2270"><span class="lineNum">    2270 </span>            :                 }</a>
<a name="2271"><span class="lineNum">    2271 </span>            :         } else {</a>
<a name="2272"><span class="lineNum">    2272 </span><span class="lineCov">      13801 :                 l = (zend_long)ZSTR_LEN(str) - f;</span></a>
<a name="2273"><span class="lineNum">    2273 </span>            :         }</a>
<a name="2274"><span class="lineNum">    2274 </span>            : </a>
<a name="2275"><span class="lineNum">    2275 </span><span class="lineCov">      40861 :         if (l == ZSTR_LEN(str)) {</span></a>
<a name="2276"><span class="lineNum">    2276 </span><span class="lineCov">        669 :                 RETURN_STR_COPY(str);</span></a>
<a name="2277"><span class="lineNum">    2277 </span>            :         } else {</a>
<a name="2278"><span class="lineNum">    2278 </span><span class="lineCov">     121668 :                 RETURN_STRINGL_FAST(ZSTR_VAL(str) + f, l);</span></a>
<a name="2279"><span class="lineNum">    2279 </span>            :         }</a>
<a name="2280"><span class="lineNum">    2280 </span>            : }</a>
<a name="2281"><span class="lineNum">    2281 </span>            : /* }}} */</a>
<a name="2282"><span class="lineNum">    2282 </span>            : </a>
<a name="2283"><span class="lineNum">    2283 </span>            : /* {{{ Replaces part of a string with another string */</a>
<a name="2284"><span class="lineNum">    2284 </span><span class="lineCov">        228 : PHP_FUNCTION(substr_replace)</span></a>
<a name="2285"><span class="lineNum">    2285 </span>            : {</a>
<a name="2286"><span class="lineNum">    2286 </span>            :         zend_string *str, *repl_str;</a>
<a name="2287"><span class="lineNum">    2287 </span>            :         HashTable *str_ht, *repl_ht;</a>
<a name="2288"><span class="lineNum">    2288 </span>            :         HashTable *from_ht;</a>
<a name="2289"><span class="lineNum">    2289 </span>            :         zend_long from_long;</a>
<a name="2290"><span class="lineNum">    2290 </span><span class="lineCov">        228 :         HashTable *len_ht = NULL;</span></a>
<a name="2291"><span class="lineNum">    2291 </span>            :         zend_long len_long;</a>
<a name="2292"><span class="lineNum">    2292 </span><span class="lineCov">        228 :         bool len_is_null = 1;</span></a>
<a name="2293"><span class="lineNum">    2293 </span><span class="lineCov">        228 :         zend_long l = 0;</span></a>
<a name="2294"><span class="lineNum">    2294 </span>            :         zend_long f;</a>
<a name="2295"><span class="lineNum">    2295 </span>            :         zend_string *result;</a>
<a name="2296"><span class="lineNum">    2296 </span>            :         HashPosition from_idx, repl_idx, len_idx;</a>
<a name="2297"><span class="lineNum">    2297 </span><span class="lineCov">        228 :         zval *tmp_str = NULL, *tmp_repl, *tmp_from = NULL, *tmp_len= NULL;</span></a>
<a name="2298"><span class="lineNum">    2298 </span>            : </a>
<a name="2299"><span class="lineNum">    2299 </span><span class="lineCov">        228 :         ZEND_PARSE_PARAMETERS_START(3, 4)</span></a>
<a name="2300"><span class="lineNum">    2300 </span><span class="lineCov">        372 :                 Z_PARAM_ARRAY_HT_OR_STR(str_ht, str)</span></a>
<a name="2301"><span class="lineNum">    2301 </span><span class="lineCov">        360 :                 Z_PARAM_ARRAY_HT_OR_STR(repl_ht, repl_str)</span></a>
<a name="2302"><span class="lineNum">    2302 </span><span class="lineCov">        360 :                 Z_PARAM_ARRAY_HT_OR_LONG(from_ht, from_long)</span></a>
<a name="2303"><span class="lineNum">    2303 </span><span class="lineCov">        180 :                 Z_PARAM_OPTIONAL</span></a>
<a name="2304"><span class="lineNum">    2304 </span><span class="lineCov">        324 :                 Z_PARAM_ARRAY_HT_OR_LONG_OR_NULL(len_ht, len_long, len_is_null)</span></a>
<a name="2305"><span class="lineNum">    2305 </span><span class="lineCov">        228 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2306"><span class="lineNum">    2306 </span>            : </a>
<a name="2307"><span class="lineNum">    2307 </span><span class="lineCov">        180 :         if (len_is_null) {</span></a>
<a name="2308"><span class="lineNum">    2308 </span><span class="lineCov">         39 :                 if (str) {</span></a>
<a name="2309"><span class="lineNum">    2309 </span><span class="lineCov">         21 :                         l = ZSTR_LEN(str);</span></a>
<a name="2310"><span class="lineNum">    2310 </span>            :                 }</a>
<a name="2311"><span class="lineNum">    2311 </span><span class="lineCov">        141 :         } else if (!len_ht) {</span></a>
<a name="2312"><span class="lineNum">    2312 </span><span class="lineCov">         90 :                 l = len_long;</span></a>
<a name="2313"><span class="lineNum">    2313 </span>            :         }</a>
<a name="2314"><span class="lineNum">    2314 </span>            : </a>
<a name="2315"><span class="lineNum">    2315 </span><span class="lineCov">        180 :         if (str) {</span></a>
<a name="2316"><span class="lineNum">    2316 </span><span class="lineCov">         42 :                 if (from_ht) {</span></a>
<a name="2317"><span class="lineNum">    2317 </span><span class="lineCov">          3 :                         zend_argument_type_error(3, &quot;cannot be an array when working on a single string&quot;);</span></a>
<a name="2318"><span class="lineNum">    2318 </span><span class="lineCov">          3 :                         RETURN_THROWS();</span></a>
<a name="2319"><span class="lineNum">    2319 </span>            :                 }</a>
<a name="2320"><span class="lineNum">    2320 </span><span class="lineCov">         39 :                 if (len_ht) {</span></a>
<a name="2321"><span class="lineNum">    2321 </span><span class="lineCov">          3 :                         zend_argument_type_error(4, &quot;cannot be an array when working on a single string&quot;);</span></a>
<a name="2322"><span class="lineNum">    2322 </span><span class="lineCov">          3 :                         RETURN_THROWS();</span></a>
<a name="2323"><span class="lineNum">    2323 </span>            :                 }</a>
<a name="2324"><span class="lineNum">    2324 </span>            : </a>
<a name="2325"><span class="lineNum">    2325 </span><span class="lineCov">         36 :                 f = from_long;</span></a>
<a name="2326"><span class="lineNum">    2326 </span>            : </a>
<a name="2327"><span class="lineNum">    2327 </span>            :                 /* if &quot;from&quot; position is negative, count start position from the end</a>
<a name="2328"><span class="lineNum">    2328 </span>            :                  * of the string</a>
<a name="2329"><span class="lineNum">    2329 </span>            :                  */</a>
<a name="2330"><span class="lineNum">    2330 </span><span class="lineCov">         36 :                 if (f &lt; 0) {</span></a>
<a name="2331"><span class="lineNum">    2331 </span><span class="lineNoCov">          0 :                         f = (zend_long)ZSTR_LEN(str) + f;</span></a>
<a name="2332"><span class="lineNum">    2332 </span><span class="lineNoCov">          0 :                         if (f &lt; 0) {</span></a>
<a name="2333"><span class="lineNum">    2333 </span><span class="lineNoCov">          0 :                                 f = 0;</span></a>
<a name="2334"><span class="lineNum">    2334 </span>            :                         }</a>
<a name="2335"><span class="lineNum">    2335 </span><span class="lineCov">         36 :                 } else if ((size_t)f &gt; ZSTR_LEN(str)) {</span></a>
<a name="2336"><span class="lineNum">    2336 </span><span class="lineCov">          3 :                         f = ZSTR_LEN(str);</span></a>
<a name="2337"><span class="lineNum">    2337 </span>            :                 }</a>
<a name="2338"><span class="lineNum">    2338 </span>            :                 /* if &quot;length&quot; position is negative, set it to the length</a>
<a name="2339"><span class="lineNum">    2339 </span>            :                  * needed to stop that many chars from the end of the string</a>
<a name="2340"><span class="lineNum">    2340 </span>            :                  */</a>
<a name="2341"><span class="lineNum">    2341 </span><span class="lineCov">         36 :                 if (l &lt; 0) {</span></a>
<a name="2342"><span class="lineNum">    2342 </span><span class="lineCov">          3 :                         l = ((zend_long)ZSTR_LEN(str) - f) + l;</span></a>
<a name="2343"><span class="lineNum">    2343 </span><span class="lineCov">          3 :                         if (l &lt; 0) {</span></a>
<a name="2344"><span class="lineNum">    2344 </span><span class="lineNoCov">          0 :                                 l = 0;</span></a>
<a name="2345"><span class="lineNum">    2345 </span>            :                         }</a>
<a name="2346"><span class="lineNum">    2346 </span>            :                 }</a>
<a name="2347"><span class="lineNum">    2347 </span>            : </a>
<a name="2348"><span class="lineNum">    2348 </span><span class="lineCov">         36 :                 if ((size_t)l &gt; ZSTR_LEN(str) || (l &lt; 0 &amp;&amp; (size_t)(-l) &gt; ZSTR_LEN(str))) {</span></a>
<a name="2349"><span class="lineNum">    2349 </span><span class="lineCov">          3 :                         l = ZSTR_LEN(str);</span></a>
<a name="2350"><span class="lineNum">    2350 </span>            :                 }</a>
<a name="2351"><span class="lineNum">    2351 </span>            : </a>
<a name="2352"><span class="lineNum">    2352 </span><span class="lineCov">         36 :                 if ((f + l) &gt; (zend_long)ZSTR_LEN(str)) {</span></a>
<a name="2353"><span class="lineNum">    2353 </span><span class="lineCov">         15 :                         l = ZSTR_LEN(str) - f;</span></a>
<a name="2354"><span class="lineNum">    2354 </span>            :                 }</a>
<a name="2355"><span class="lineNum">    2355 </span>            : </a>
<a name="2356"><span class="lineNum">    2356 </span><span class="lineCov">         36 :                 zend_string *tmp_repl_str = NULL;</span></a>
<a name="2357"><span class="lineNum">    2357 </span><span class="lineCov">         36 :                 if (repl_ht) {</span></a>
<a name="2358"><span class="lineNum">    2358 </span><span class="lineCov">          9 :                         repl_idx = 0;</span></a>
<a name="2359"><span class="lineNum">    2359 </span><span class="lineCov">          9 :                         if (HT_IS_PACKED(repl_ht)) {</span></a>
<a name="2360"><span class="lineNum">    2360 </span><span class="lineCov">          9 :                                 while (repl_idx &lt; repl_ht-&gt;nNumUsed) {</span></a>
<a name="2361"><span class="lineNum">    2361 </span><span class="lineCov">          9 :                                         tmp_repl = &amp;repl_ht-&gt;arPacked[repl_idx];</span></a>
<a name="2362"><span class="lineNum">    2362 </span><span class="lineCov">          9 :                                         if (Z_TYPE_P(tmp_repl) != IS_UNDEF) {</span></a>
<a name="2363"><span class="lineNum">    2363 </span><span class="lineCov">          9 :                                                 break;</span></a>
<a name="2364"><span class="lineNum">    2364 </span>            :                                         }</a>
<a name="2365"><span class="lineNum">    2365 </span><span class="lineNoCov">          0 :                                         repl_idx++;</span></a>
<a name="2366"><span class="lineNum">    2366 </span>            :                                 }</a>
<a name="2367"><span class="lineNum">    2367 </span>            :                         } else {</a>
<a name="2368"><span class="lineNum">    2368 </span><span class="lineNoCov">          0 :                                 while (repl_idx &lt; repl_ht-&gt;nNumUsed) {</span></a>
<a name="2369"><span class="lineNum">    2369 </span><span class="lineNoCov">          0 :                                         tmp_repl = &amp;repl_ht-&gt;arData[repl_idx].val;</span></a>
<a name="2370"><span class="lineNum">    2370 </span><span class="lineNoCov">          0 :                                         if (Z_TYPE_P(tmp_repl) != IS_UNDEF) {</span></a>
<a name="2371"><span class="lineNum">    2371 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="2372"><span class="lineNum">    2372 </span>            :                                         }</a>
<a name="2373"><span class="lineNum">    2373 </span><span class="lineNoCov">          0 :                                         repl_idx++;</span></a>
<a name="2374"><span class="lineNum">    2374 </span>            :                                 }</a>
<a name="2375"><span class="lineNum">    2375 </span>            :                         }</a>
<a name="2376"><span class="lineNum">    2376 </span><span class="lineCov">          9 :                         if (repl_idx &lt; repl_ht-&gt;nNumUsed) {</span></a>
<a name="2377"><span class="lineNum">    2377 </span><span class="lineCov">          9 :                                 repl_str = zval_get_tmp_string(tmp_repl, &amp;tmp_repl_str);</span></a>
<a name="2378"><span class="lineNum">    2378 </span>            :                         } else {</a>
<a name="2379"><span class="lineNum">    2379 </span><span class="lineNoCov">          0 :                                 repl_str = STR_EMPTY_ALLOC();</span></a>
<a name="2380"><span class="lineNum">    2380 </span>            :                         }</a>
<a name="2381"><span class="lineNum">    2381 </span>            :                 }</a>
<a name="2382"><span class="lineNum">    2382 </span>            : </a>
<a name="2383"><span class="lineNum">    2383 </span><span class="lineCov">         36 :                 result = zend_string_safe_alloc(1, ZSTR_LEN(str) - l + ZSTR_LEN(repl_str), 0, 0);</span></a>
<a name="2384"><span class="lineNum">    2384 </span>            : </a>
<a name="2385"><span class="lineNum">    2385 </span><span class="lineCov">         36 :                 memcpy(ZSTR_VAL(result), ZSTR_VAL(str), f);</span></a>
<a name="2386"><span class="lineNum">    2386 </span><span class="lineCov">         36 :                 if (ZSTR_LEN(repl_str)) {</span></a>
<a name="2387"><span class="lineNum">    2387 </span><span class="lineCov">         27 :                         memcpy((ZSTR_VAL(result) + f), ZSTR_VAL(repl_str), ZSTR_LEN(repl_str));</span></a>
<a name="2388"><span class="lineNum">    2388 </span>            :                 }</a>
<a name="2389"><span class="lineNum">    2389 </span><span class="lineCov">         36 :                 memcpy((ZSTR_VAL(result) + f + ZSTR_LEN(repl_str)), ZSTR_VAL(str) + f + l, ZSTR_LEN(str) - f - l);</span></a>
<a name="2390"><span class="lineNum">    2390 </span><span class="lineCov">         36 :                 ZSTR_VAL(result)[ZSTR_LEN(result)] = '\0';</span></a>
<a name="2391"><span class="lineNum">    2391 </span><span class="lineCov">         36 :                 zend_tmp_string_release(tmp_repl_str);</span></a>
<a name="2392"><span class="lineNum">    2392 </span><span class="lineCov">         36 :                 RETURN_NEW_STR(result);</span></a>
<a name="2393"><span class="lineNum">    2393 </span>            :         } else { /* str is array of strings */</a>
<a name="2394"><span class="lineNum">    2394 </span><span class="lineCov">        138 :                 zend_string *str_index = NULL;</span></a>
<a name="2395"><span class="lineNum">    2395 </span>            :                 size_t result_len;</a>
<a name="2396"><span class="lineNum">    2396 </span>            :                 zend_ulong num_index;</a>
<a name="2397"><span class="lineNum">    2397 </span>            : </a>
<a name="2398"><span class="lineNum">    2398 </span>            :                 /* TODO</a>
<a name="2399"><span class="lineNum">    2399 </span>            :                 if (!len_is_null &amp;&amp; from_ht) {</a>
<a name="2400"><span class="lineNum">    2400 </span>            :                         if (zend_hash_num_elements(from_ht) != zend_hash_num_elements(len_ht)) {</a>
<a name="2401"><span class="lineNum">    2401 </span>            :                                 php_error_docref(NULL, E_WARNING, &quot;'start' and 'length' should have the same number of elements&quot;);</a>
<a name="2402"><span class="lineNum">    2402 </span>            :                                 RETURN_STR_COPY(str);</a>
<a name="2403"><span class="lineNum">    2403 </span>            :                         }</a>
<a name="2404"><span class="lineNum">    2404 </span>            :                 }</a>
<a name="2405"><span class="lineNum">    2405 </span>            :                 */</a>
<a name="2406"><span class="lineNum">    2406 </span>            : </a>
<a name="2407"><span class="lineNum">    2407 </span><span class="lineCov">        138 :                 array_init(return_value);</span></a>
<a name="2408"><span class="lineNum">    2408 </span>            : </a>
<a name="2409"><span class="lineNum">    2409 </span><span class="lineCov">        138 :                 from_idx = len_idx = repl_idx = 0;</span></a>
<a name="2410"><span class="lineNum">    2410 </span>            : </a>
<a name="2411"><span class="lineNum">    2411 </span><span class="lineCov">        618 :                 ZEND_HASH_FOREACH_KEY_VAL(str_ht, num_index, str_index, tmp_str) {</span></a>
<a name="2412"><span class="lineNum">    2412 </span>            :                         zend_string *tmp_orig_str;</a>
<a name="2413"><span class="lineNum">    2413 </span><span class="lineCov">        240 :                         zend_string *orig_str = zval_get_tmp_string(tmp_str, &amp;tmp_orig_str);</span></a>
<a name="2414"><span class="lineNum">    2414 </span>            : </a>
<a name="2415"><span class="lineNum">    2415 </span><span class="lineCov">        240 :                         if (from_ht) {</span></a>
<a name="2416"><span class="lineNum">    2416 </span><span class="lineCov">        171 :                                 if (HT_IS_PACKED(from_ht)) {</span></a>
<a name="2417"><span class="lineNum">    2417 </span><span class="lineCov">        171 :                                         while (from_idx &lt; from_ht-&gt;nNumUsed) {</span></a>
<a name="2418"><span class="lineNum">    2418 </span><span class="lineCov">        153 :                                                 tmp_from = &amp;from_ht-&gt;arPacked[from_idx];</span></a>
<a name="2419"><span class="lineNum">    2419 </span><span class="lineCov">        153 :                                                 if (Z_TYPE_P(tmp_from) != IS_UNDEF) {</span></a>
<a name="2420"><span class="lineNum">    2420 </span><span class="lineCov">        153 :                                                         break;</span></a>
<a name="2421"><span class="lineNum">    2421 </span>            :                                                 }</a>
<a name="2422"><span class="lineNum">    2422 </span><span class="lineNoCov">          0 :                                                 from_idx++;</span></a>
<a name="2423"><span class="lineNum">    2423 </span>            :                                         }</a>
<a name="2424"><span class="lineNum">    2424 </span>            :                                 } else {</a>
<a name="2425"><span class="lineNum">    2425 </span><span class="lineNoCov">          0 :                                         while (from_idx &lt; from_ht-&gt;nNumUsed) {</span></a>
<a name="2426"><span class="lineNum">    2426 </span><span class="lineNoCov">          0 :                                                 tmp_from = &amp;from_ht-&gt;arData[from_idx].val;</span></a>
<a name="2427"><span class="lineNum">    2427 </span><span class="lineNoCov">          0 :                                                 if (Z_TYPE_P(tmp_from) != IS_UNDEF) {</span></a>
<a name="2428"><span class="lineNum">    2428 </span><span class="lineNoCov">          0 :                                                         break;</span></a>
<a name="2429"><span class="lineNum">    2429 </span>            :                                                 }</a>
<a name="2430"><span class="lineNum">    2430 </span><span class="lineNoCov">          0 :                                                 from_idx++;</span></a>
<a name="2431"><span class="lineNum">    2431 </span>            :                                         }</a>
<a name="2432"><span class="lineNum">    2432 </span>            :                                 }</a>
<a name="2433"><span class="lineNum">    2433 </span><span class="lineCov">        171 :                                 if (from_idx &lt; from_ht-&gt;nNumUsed) {</span></a>
<a name="2434"><span class="lineNum">    2434 </span><span class="lineCov">        153 :                                         f = zval_get_long(tmp_from);</span></a>
<a name="2435"><span class="lineNum">    2435 </span>            : </a>
<a name="2436"><span class="lineNum">    2436 </span><span class="lineCov">        153 :                                         if (f &lt; 0) {</span></a>
<a name="2437"><span class="lineNum">    2437 </span><span class="lineNoCov">          0 :                                                 f = (zend_long)ZSTR_LEN(orig_str) + f;</span></a>
<a name="2438"><span class="lineNum">    2438 </span><span class="lineNoCov">          0 :                                                 if (f &lt; 0) {</span></a>
<a name="2439"><span class="lineNum">    2439 </span><span class="lineNoCov">          0 :                                                         f = 0;</span></a>
<a name="2440"><span class="lineNum">    2440 </span>            :                                                 }</a>
<a name="2441"><span class="lineNum">    2441 </span><span class="lineCov">        153 :                                         } else if (f &gt; (zend_long)ZSTR_LEN(orig_str)) {</span></a>
<a name="2442"><span class="lineNum">    2442 </span><span class="lineNoCov">          0 :                                                 f = ZSTR_LEN(orig_str);</span></a>
<a name="2443"><span class="lineNum">    2443 </span>            :                                         }</a>
<a name="2444"><span class="lineNum">    2444 </span><span class="lineCov">        153 :                                         from_idx++;</span></a>
<a name="2445"><span class="lineNum">    2445 </span>            :                                 } else {</a>
<a name="2446"><span class="lineNum">    2446 </span><span class="lineCov">         18 :                                         f = 0;</span></a>
<a name="2447"><span class="lineNum">    2447 </span>            :                                 }</a>
<a name="2448"><span class="lineNum">    2448 </span>            :                         } else {</a>
<a name="2449"><span class="lineNum">    2449 </span><span class="lineCov">         69 :                                 f = from_long;</span></a>
<a name="2450"><span class="lineNum">    2450 </span><span class="lineCov">         69 :                                 if (f &lt; 0) {</span></a>
<a name="2451"><span class="lineNum">    2451 </span><span class="lineNoCov">          0 :                                         f = (zend_long)ZSTR_LEN(orig_str) + f;</span></a>
<a name="2452"><span class="lineNum">    2452 </span><span class="lineNoCov">          0 :                                         if (f &lt; 0) {</span></a>
<a name="2453"><span class="lineNum">    2453 </span><span class="lineNoCov">          0 :                                                 f = 0;</span></a>
<a name="2454"><span class="lineNum">    2454 </span>            :                                         }</a>
<a name="2455"><span class="lineNum">    2455 </span><span class="lineCov">         69 :                                 } else if (f &gt; (zend_long)ZSTR_LEN(orig_str)) {</span></a>
<a name="2456"><span class="lineNum">    2456 </span><span class="lineNoCov">          0 :                                         f = ZSTR_LEN(orig_str);</span></a>
<a name="2457"><span class="lineNum">    2457 </span>            :                                 }</a>
<a name="2458"><span class="lineNum">    2458 </span>            :                         }</a>
<a name="2459"><span class="lineNum">    2459 </span>            : </a>
<a name="2460"><span class="lineNum">    2460 </span><span class="lineCov">        240 :                         if (len_ht) {</span></a>
<a name="2461"><span class="lineNum">    2461 </span><span class="lineCov">         87 :                                 if (HT_IS_PACKED(len_ht)) {</span></a>
<a name="2462"><span class="lineNum">    2462 </span><span class="lineCov">         87 :                                         while (len_idx &lt; len_ht-&gt;nNumUsed) {</span></a>
<a name="2463"><span class="lineNum">    2463 </span><span class="lineCov">         69 :                                                 tmp_len = &amp;len_ht-&gt;arPacked[len_idx];</span></a>
<a name="2464"><span class="lineNum">    2464 </span><span class="lineCov">         69 :                                                 if (Z_TYPE_P(tmp_len) != IS_UNDEF) {</span></a>
<a name="2465"><span class="lineNum">    2465 </span><span class="lineCov">         69 :                                                         break;</span></a>
<a name="2466"><span class="lineNum">    2466 </span>            :                                                 }</a>
<a name="2467"><span class="lineNum">    2467 </span><span class="lineNoCov">          0 :                                                 len_idx++;</span></a>
<a name="2468"><span class="lineNum">    2468 </span>            :                                         }</a>
<a name="2469"><span class="lineNum">    2469 </span>            :                                 } else {</a>
<a name="2470"><span class="lineNum">    2470 </span><span class="lineNoCov">          0 :                                         while (len_idx &lt; len_ht-&gt;nNumUsed) {</span></a>
<a name="2471"><span class="lineNum">    2471 </span><span class="lineNoCov">          0 :                                                 tmp_len = &amp;len_ht-&gt;arData[len_idx].val;</span></a>
<a name="2472"><span class="lineNum">    2472 </span><span class="lineNoCov">          0 :                                                 if (Z_TYPE_P(tmp_len) != IS_UNDEF) {</span></a>
<a name="2473"><span class="lineNum">    2473 </span><span class="lineNoCov">          0 :                                                         break;</span></a>
<a name="2474"><span class="lineNum">    2474 </span>            :                                                 }</a>
<a name="2475"><span class="lineNum">    2475 </span><span class="lineNoCov">          0 :                                                 len_idx++;</span></a>
<a name="2476"><span class="lineNum">    2476 </span>            :                                         }</a>
<a name="2477"><span class="lineNum">    2477 </span>            :                                 }</a>
<a name="2478"><span class="lineNum">    2478 </span><span class="lineCov">         87 :                                 if (len_idx &lt; len_ht-&gt;nNumUsed) {</span></a>
<a name="2479"><span class="lineNum">    2479 </span><span class="lineCov">         69 :                                         l = zval_get_long(tmp_len);</span></a>
<a name="2480"><span class="lineNum">    2480 </span><span class="lineCov">         69 :                                         len_idx++;</span></a>
<a name="2481"><span class="lineNum">    2481 </span>            :                                 } else {</a>
<a name="2482"><span class="lineNum">    2482 </span><span class="lineCov">         18 :                                         l = ZSTR_LEN(orig_str);</span></a>
<a name="2483"><span class="lineNum">    2483 </span>            :                                 }</a>
<a name="2484"><span class="lineNum">    2484 </span><span class="lineCov">        153 :                         } else if (!len_is_null) {</span></a>
<a name="2485"><span class="lineNum">    2485 </span><span class="lineCov">        135 :                                 l = len_long;</span></a>
<a name="2486"><span class="lineNum">    2486 </span>            :                         } else {</a>
<a name="2487"><span class="lineNum">    2487 </span><span class="lineCov">         18 :                                 l = ZSTR_LEN(orig_str);</span></a>
<a name="2488"><span class="lineNum">    2488 </span>            :                         }</a>
<a name="2489"><span class="lineNum">    2489 </span>            : </a>
<a name="2490"><span class="lineNum">    2490 </span><span class="lineCov">        240 :                         if (l &lt; 0) {</span></a>
<a name="2491"><span class="lineNum">    2491 </span><span class="lineCov">         69 :                                 l = (ZSTR_LEN(orig_str) - f) + l;</span></a>
<a name="2492"><span class="lineNum">    2492 </span><span class="lineCov">         69 :                                 if (l &lt; 0) {</span></a>
<a name="2493"><span class="lineNum">    2493 </span><span class="lineNoCov">          0 :                                         l = 0;</span></a>
<a name="2494"><span class="lineNum">    2494 </span>            :                                 }</a>
<a name="2495"><span class="lineNum">    2495 </span>            :                         }</a>
<a name="2496"><span class="lineNum">    2496 </span>            : </a>
<a name="2497"><span class="lineNum">    2497 </span><span class="lineCov">        240 :                         ZEND_ASSERT(0 &lt;= f &amp;&amp; f &lt;= ZEND_LONG_MAX);</span></a>
<a name="2498"><span class="lineNum">    2498 </span><span class="lineCov">        240 :                         ZEND_ASSERT(0 &lt;= l &amp;&amp; l &lt;= ZEND_LONG_MAX);</span></a>
<a name="2499"><span class="lineNum">    2499 </span><span class="lineCov">        240 :                         if (((size_t) f + l) &gt; ZSTR_LEN(orig_str)) {</span></a>
<a name="2500"><span class="lineNum">    2500 </span><span class="lineCov">         45 :                                 l = ZSTR_LEN(orig_str) - f;</span></a>
<a name="2501"><span class="lineNum">    2501 </span>            :                         }</a>
<a name="2502"><span class="lineNum">    2502 </span>            : </a>
<a name="2503"><span class="lineNum">    2503 </span><span class="lineCov">        240 :                         result_len = ZSTR_LEN(orig_str) - l;</span></a>
<a name="2504"><span class="lineNum">    2504 </span>            : </a>
<a name="2505"><span class="lineNum">    2505 </span><span class="lineCov">        240 :                         if (repl_ht) {</span></a>
<a name="2506"><span class="lineNum">    2506 </span><span class="lineCov">        114 :                                 if (HT_IS_PACKED(repl_ht)) {</span></a>
<a name="2507"><span class="lineNum">    2507 </span><span class="lineCov">        114 :                                         while (repl_idx &lt; repl_ht-&gt;nNumUsed) {</span></a>
<a name="2508"><span class="lineNum">    2508 </span><span class="lineCov">         69 :                                                 tmp_repl = &amp;repl_ht-&gt;arPacked[repl_idx];</span></a>
<a name="2509"><span class="lineNum">    2509 </span><span class="lineCov">         69 :                                                 if (repl_ht != IS_UNDEF) {</span></a>
<a name="2510"><span class="lineNum">    2510 </span><span class="lineCov">         69 :                                                         break;</span></a>
<a name="2511"><span class="lineNum">    2511 </span>            :                                                 }</a>
<a name="2512"><span class="lineNum">    2512 </span><span class="lineNoCov">          0 :                                                 repl_idx++;</span></a>
<a name="2513"><span class="lineNum">    2513 </span>            :                                         }</a>
<a name="2514"><span class="lineNum">    2514 </span>            :                                 } else {</a>
<a name="2515"><span class="lineNum">    2515 </span><span class="lineNoCov">          0 :                                         while (repl_idx &lt; repl_ht-&gt;nNumUsed) {</span></a>
<a name="2516"><span class="lineNum">    2516 </span><span class="lineNoCov">          0 :                                                 tmp_repl = &amp;repl_ht-&gt;arData[repl_idx].val;</span></a>
<a name="2517"><span class="lineNum">    2517 </span><span class="lineNoCov">          0 :                                                 if (repl_ht != IS_UNDEF) {</span></a>
<a name="2518"><span class="lineNum">    2518 </span><span class="lineNoCov">          0 :                                                         break;</span></a>
<a name="2519"><span class="lineNum">    2519 </span>            :                                                 }</a>
<a name="2520"><span class="lineNum">    2520 </span><span class="lineNoCov">          0 :                                                 repl_idx++;</span></a>
<a name="2521"><span class="lineNum">    2521 </span>            :                                         }</a>
<a name="2522"><span class="lineNum">    2522 </span>            :                                 }</a>
<a name="2523"><span class="lineNum">    2523 </span><span class="lineCov">        114 :                                 if (repl_idx &lt; repl_ht-&gt;nNumUsed) {</span></a>
<a name="2524"><span class="lineNum">    2524 </span>            :                                         zend_string *tmp_repl_str;</a>
<a name="2525"><span class="lineNum">    2525 </span><span class="lineCov">         69 :                                         zend_string *repl_str = zval_get_tmp_string(tmp_repl, &amp;tmp_repl_str);</span></a>
<a name="2526"><span class="lineNum">    2526 </span>            : </a>
<a name="2527"><span class="lineNum">    2527 </span><span class="lineCov">         69 :                                         result_len += ZSTR_LEN(repl_str);</span></a>
<a name="2528"><span class="lineNum">    2528 </span><span class="lineCov">         69 :                                         repl_idx++;</span></a>
<a name="2529"><span class="lineNum">    2529 </span><span class="lineCov">         69 :                                         result = zend_string_safe_alloc(1, result_len, 0, 0);</span></a>
<a name="2530"><span class="lineNum">    2530 </span>            : </a>
<a name="2531"><span class="lineNum">    2531 </span><span class="lineCov">         69 :                                         memcpy(ZSTR_VAL(result), ZSTR_VAL(orig_str), f);</span></a>
<a name="2532"><span class="lineNum">    2532 </span><span class="lineCov">         69 :                                         memcpy((ZSTR_VAL(result) + f), ZSTR_VAL(repl_str), ZSTR_LEN(repl_str));</span></a>
<a name="2533"><span class="lineNum">    2533 </span><span class="lineCov">         69 :                                         memcpy((ZSTR_VAL(result) + f + ZSTR_LEN(repl_str)), ZSTR_VAL(orig_str) + f + l, ZSTR_LEN(orig_str) - f - l);</span></a>
<a name="2534"><span class="lineNum">    2534 </span><span class="lineCov">         69 :                                         zend_tmp_string_release(tmp_repl_str);</span></a>
<a name="2535"><span class="lineNum">    2535 </span>            :                                 } else {</a>
<a name="2536"><span class="lineNum">    2536 </span><span class="lineCov">         45 :                                         result = zend_string_safe_alloc(1, result_len, 0, 0);</span></a>
<a name="2537"><span class="lineNum">    2537 </span>            : </a>
<a name="2538"><span class="lineNum">    2538 </span><span class="lineCov">         45 :                                         memcpy(ZSTR_VAL(result), ZSTR_VAL(orig_str), f);</span></a>
<a name="2539"><span class="lineNum">    2539 </span><span class="lineCov">         45 :                                         memcpy((ZSTR_VAL(result) + f), ZSTR_VAL(orig_str) + f + l, ZSTR_LEN(orig_str) - f - l);</span></a>
<a name="2540"><span class="lineNum">    2540 </span>            :                                 }</a>
<a name="2541"><span class="lineNum">    2541 </span>            :                         } else {</a>
<a name="2542"><span class="lineNum">    2542 </span><span class="lineCov">        126 :                                 result_len += ZSTR_LEN(repl_str);</span></a>
<a name="2543"><span class="lineNum">    2543 </span>            : </a>
<a name="2544"><span class="lineNum">    2544 </span><span class="lineCov">        126 :                                 result = zend_string_safe_alloc(1, result_len, 0, 0);</span></a>
<a name="2545"><span class="lineNum">    2545 </span>            : </a>
<a name="2546"><span class="lineNum">    2546 </span><span class="lineCov">        126 :                                 memcpy(ZSTR_VAL(result), ZSTR_VAL(orig_str), f);</span></a>
<a name="2547"><span class="lineNum">    2547 </span><span class="lineCov">        126 :                                 memcpy((ZSTR_VAL(result) + f), ZSTR_VAL(repl_str), ZSTR_LEN(repl_str));</span></a>
<a name="2548"><span class="lineNum">    2548 </span><span class="lineCov">        126 :                                 memcpy((ZSTR_VAL(result) + f + ZSTR_LEN(repl_str)), ZSTR_VAL(orig_str) + f + l, ZSTR_LEN(orig_str) - f - l);</span></a>
<a name="2549"><span class="lineNum">    2549 </span>            :                         }</a>
<a name="2550"><span class="lineNum">    2550 </span>            : </a>
<a name="2551"><span class="lineNum">    2551 </span><span class="lineCov">        240 :                         ZSTR_VAL(result)[ZSTR_LEN(result)] = '\0';</span></a>
<a name="2552"><span class="lineNum">    2552 </span>            : </a>
<a name="2553"><span class="lineNum">    2553 </span><span class="lineCov">        240 :                         if (str_index) {</span></a>
<a name="2554"><span class="lineNum">    2554 </span>            :                                 zval tmp;</a>
<a name="2555"><span class="lineNum">    2555 </span>            : </a>
<a name="2556"><span class="lineNum">    2556 </span><span class="lineCov">          6 :                                 ZVAL_NEW_STR(&amp;tmp, result);</span></a>
<a name="2557"><span class="lineNum">    2557 </span><span class="lineCov">          6 :                                 zend_symtable_update(Z_ARRVAL_P(return_value), str_index, &amp;tmp);</span></a>
<a name="2558"><span class="lineNum">    2558 </span>            :                         } else {</a>
<a name="2559"><span class="lineNum">    2559 </span><span class="lineCov">        234 :                                 add_index_str(return_value, num_index, result);</span></a>
<a name="2560"><span class="lineNum">    2560 </span>            :                         }</a>
<a name="2561"><span class="lineNum">    2561 </span>            : </a>
<a name="2562"><span class="lineNum">    2562 </span><span class="lineCov">        240 :                         zend_tmp_string_release(tmp_orig_str);</span></a>
<a name="2563"><span class="lineNum">    2563 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="2564"><span class="lineNum">    2564 </span>            :         } /* if */</a>
<a name="2565"><span class="lineNum">    2565 </span>            : }</a>
<a name="2566"><span class="lineNum">    2566 </span>            : /* }}} */</a>
<a name="2567"><span class="lineNum">    2567 </span>            : </a>
<a name="2568"><span class="lineNum">    2568 </span>            : /* {{{ Quotes meta characters */</a>
<a name="2569"><span class="lineNum">    2569 </span><span class="lineCov">         69 : PHP_FUNCTION(quotemeta)</span></a>
<a name="2570"><span class="lineNum">    2570 </span>            : {</a>
<a name="2571"><span class="lineNum">    2571 </span>            :         zend_string *old;</a>
<a name="2572"><span class="lineNum">    2572 </span>            :         const char *old_end, *p;</a>
<a name="2573"><span class="lineNum">    2573 </span>            :         char *q;</a>
<a name="2574"><span class="lineNum">    2574 </span>            :         char c;</a>
<a name="2575"><span class="lineNum">    2575 </span>            :         zend_string *str;</a>
<a name="2576"><span class="lineNum">    2576 </span>            : </a>
<a name="2577"><span class="lineNum">    2577 </span><span class="lineCov">         69 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="2578"><span class="lineNum">    2578 </span><span class="lineCov">         42 :                 Z_PARAM_STR(old)</span></a>
<a name="2579"><span class="lineNum">    2579 </span><span class="lineCov">         69 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2580"><span class="lineNum">    2580 </span>            : </a>
<a name="2581"><span class="lineNum">    2581 </span><span class="lineCov">         18 :         old_end = ZSTR_VAL(old) + ZSTR_LEN(old);</span></a>
<a name="2582"><span class="lineNum">    2582 </span>            : </a>
<a name="2583"><span class="lineNum">    2583 </span><span class="lineCov">         18 :         if (ZSTR_LEN(old) == 0) {</span></a>
<a name="2584"><span class="lineNum">    2584 </span><span class="lineCov">          6 :                 RETURN_EMPTY_STRING();</span></a>
<a name="2585"><span class="lineNum">    2585 </span>            :         }</a>
<a name="2586"><span class="lineNum">    2586 </span>            : </a>
<a name="2587"><span class="lineNum">    2587 </span><span class="lineCov">         12 :         str = zend_string_safe_alloc(2, ZSTR_LEN(old), 0, 0);</span></a>
<a name="2588"><span class="lineNum">    2588 </span>            : </a>
<a name="2589"><span class="lineNum">    2589 </span><span class="lineCov">        180 :         for (p = ZSTR_VAL(old), q = ZSTR_VAL(str); p != old_end; p++) {</span></a>
<a name="2590"><span class="lineNum">    2590 </span><span class="lineCov">        168 :                 c = *p;</span></a>
<a name="2591"><span class="lineNum">    2591 </span><span class="lineCov">        168 :                 switch (c) {</span></a>
<a name="2592"><span class="lineNum">    2592 </span><span class="lineCov">         72 :                         case '.':</span></a>
<a name="2593"><span class="lineNum">    2593 </span>            :                         case '\\':</a>
<a name="2594"><span class="lineNum">    2594 </span>            :                         case '+':</a>
<a name="2595"><span class="lineNum">    2595 </span>            :                         case '*':</a>
<a name="2596"><span class="lineNum">    2596 </span>            :                         case '?':</a>
<a name="2597"><span class="lineNum">    2597 </span>            :                         case '[':</a>
<a name="2598"><span class="lineNum">    2598 </span>            :                         case '^':</a>
<a name="2599"><span class="lineNum">    2599 </span>            :                         case ']':</a>
<a name="2600"><span class="lineNum">    2600 </span>            :                         case '$':</a>
<a name="2601"><span class="lineNum">    2601 </span>            :                         case '(':</a>
<a name="2602"><span class="lineNum">    2602 </span>            :                         case ')':</a>
<a name="2603"><span class="lineNum">    2603 </span><span class="lineCov">         72 :                                 *q++ = '\\';</span></a>
<a name="2604"><span class="lineNum">    2604 </span>            :                                 ZEND_FALLTHROUGH;</a>
<a name="2605"><span class="lineNum">    2605 </span><span class="lineCov">        168 :                         default:</span></a>
<a name="2606"><span class="lineNum">    2606 </span><span class="lineCov">        168 :                                 *q++ = c;</span></a>
<a name="2607"><span class="lineNum">    2607 </span>            :                 }</a>
<a name="2608"><span class="lineNum">    2608 </span>            :         }</a>
<a name="2609"><span class="lineNum">    2609 </span>            : </a>
<a name="2610"><span class="lineNum">    2610 </span><span class="lineCov">         12 :         *q = '\0';</span></a>
<a name="2611"><span class="lineNum">    2611 </span>            : </a>
<a name="2612"><span class="lineNum">    2612 </span><span class="lineCov">         24 :         RETURN_NEW_STR(zend_string_truncate(str, q - ZSTR_VAL(str), 0));</span></a>
<a name="2613"><span class="lineNum">    2613 </span>            : }</a>
<a name="2614"><span class="lineNum">    2614 </span>            : /* }}} */</a>
<a name="2615"><span class="lineNum">    2615 </span>            : </a>
<a name="2616"><span class="lineNum">    2616 </span>            : /* {{{ Returns ASCII value of character</a>
<a name="2617"><span class="lineNum">    2617 </span>            :    Warning: This function is special-cased by zend_compile.c and so is bypassed for constant string argument */</a>
<a name="2618"><span class="lineNum">    2618 </span><span class="lineCov">     137073 : PHP_FUNCTION(ord)</span></a>
<a name="2619"><span class="lineNum">    2619 </span>            : {</a>
<a name="2620"><span class="lineNum">    2620 </span>            :         zend_string *str;</a>
<a name="2621"><span class="lineNum">    2621 </span>            : </a>
<a name="2622"><span class="lineNum">    2622 </span><span class="lineCov">     137073 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="2623"><span class="lineNum">    2623 </span><span class="lineCov">     274050 :                 Z_PARAM_STR(str)</span></a>
<a name="2624"><span class="lineNum">    2624 </span><span class="lineCov">     137073 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2625"><span class="lineNum">    2625 </span>            : </a>
<a name="2626"><span class="lineNum">    2626 </span><span class="lineCov">     137019 :         RETURN_LONG((unsigned char) ZSTR_VAL(str)[0]);</span></a>
<a name="2627"><span class="lineNum">    2627 </span>            : }</a>
<a name="2628"><span class="lineNum">    2628 </span>            : /* }}} */</a>
<a name="2629"><span class="lineNum">    2629 </span>            : </a>
<a name="2630"><span class="lineNum">    2630 </span>            : /* {{{ Converts ASCII code to a character</a>
<a name="2631"><span class="lineNum">    2631 </span>            :    Warning: This function is special-cased by zend_compile.c and so is bypassed for constant integer argument */</a>
<a name="2632"><span class="lineNum">    2632 </span><span class="lineCov">     196752 : PHP_FUNCTION(chr)</span></a>
<a name="2633"><span class="lineNum">    2633 </span>            : {</a>
<a name="2634"><span class="lineNum">    2634 </span>            :         zend_long c;</a>
<a name="2635"><span class="lineNum">    2635 </span>            : </a>
<a name="2636"><span class="lineNum">    2636 </span><span class="lineCov">     196752 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="2637"><span class="lineNum">    2637 </span><span class="lineCov">     393396 :                 Z_PARAM_LONG(c)</span></a>
<a name="2638"><span class="lineNum">    2638 </span><span class="lineCov">     196752 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2639"><span class="lineNum">    2639 </span>            : </a>
<a name="2640"><span class="lineNum">    2640 </span><span class="lineCov">     196695 :         c &amp;= 0xff;</span></a>
<a name="2641"><span class="lineNum">    2641 </span><span class="lineCov">     196695 :         RETURN_CHAR(c);</span></a>
<a name="2642"><span class="lineNum">    2642 </span>            : }</a>
<a name="2643"><span class="lineNum">    2643 </span>            : /* }}} */</a>
<a name="2644"><span class="lineNum">    2644 </span>            : </a>
<a name="2645"><span class="lineNum">    2645 </span>            : /* {{{ php_ucfirst</a>
<a name="2646"><span class="lineNum">    2646 </span>            :    Uppercase the first character of the word in a native string */</a>
<a name="2647"><span class="lineNum">    2647 </span><span class="lineCov">        173 : static zend_string* php_ucfirst(zend_string *str)</span></a>
<a name="2648"><span class="lineNum">    2648 </span>            : {</a>
<a name="2649"><span class="lineNum">    2649 </span><span class="lineCov">        173 :         const unsigned char ch = ZSTR_VAL(str)[0];</span></a>
<a name="2650"><span class="lineNum">    2650 </span><span class="lineCov">        173 :         unsigned char r = toupper(ch);</span></a>
<a name="2651"><span class="lineNum">    2651 </span><span class="lineCov">        173 :         if (r == ch) {</span></a>
<a name="2652"><span class="lineNum">    2652 </span><span class="lineCov">         72 :                 return zend_string_copy(str);</span></a>
<a name="2653"><span class="lineNum">    2653 </span>            :         } else {</a>
<a name="2654"><span class="lineNum">    2654 </span><span class="lineCov">        101 :                 zend_string *s = zend_string_init(ZSTR_VAL(str), ZSTR_LEN(str), 0);</span></a>
<a name="2655"><span class="lineNum">    2655 </span><span class="lineCov">        101 :                 ZSTR_VAL(s)[0] = r;</span></a>
<a name="2656"><span class="lineNum">    2656 </span><span class="lineCov">        101 :                 return s;</span></a>
<a name="2657"><span class="lineNum">    2657 </span>            :         }</a>
<a name="2658"><span class="lineNum">    2658 </span>            : }</a>
<a name="2659"><span class="lineNum">    2659 </span>            : /* }}} */</a>
<a name="2660"><span class="lineNum">    2660 </span>            : </a>
<a name="2661"><span class="lineNum">    2661 </span>            : /* {{{ Makes a string's first character uppercase */</a>
<a name="2662"><span class="lineNum">    2662 </span><span class="lineCov">        236 : PHP_FUNCTION(ucfirst)</span></a>
<a name="2663"><span class="lineNum">    2663 </span>            : {</a>
<a name="2664"><span class="lineNum">    2664 </span>            :         zend_string *str;</a>
<a name="2665"><span class="lineNum">    2665 </span>            : </a>
<a name="2666"><span class="lineNum">    2666 </span><span class="lineCov">        236 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="2667"><span class="lineNum">    2667 </span><span class="lineCov">        376 :                 Z_PARAM_STR(str)</span></a>
<a name="2668"><span class="lineNum">    2668 </span><span class="lineCov">        236 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2669"><span class="lineNum">    2669 </span>            : </a>
<a name="2670"><span class="lineNum">    2670 </span><span class="lineCov">        185 :         if (!ZSTR_LEN(str)) {</span></a>
<a name="2671"><span class="lineNum">    2671 </span><span class="lineCov">         12 :                 RETURN_EMPTY_STRING();</span></a>
<a name="2672"><span class="lineNum">    2672 </span>            :         }</a>
<a name="2673"><span class="lineNum">    2673 </span>            : </a>
<a name="2674"><span class="lineNum">    2674 </span><span class="lineCov">        346 :         RETURN_STR(php_ucfirst(str));</span></a>
<a name="2675"><span class="lineNum">    2675 </span>            : }</a>
<a name="2676"><span class="lineNum">    2676 </span>            : /* }}} */</a>
<a name="2677"><span class="lineNum">    2677 </span>            : </a>
<a name="2678"><span class="lineNum">    2678 </span>            : /* {{{</a>
<a name="2679"><span class="lineNum">    2679 </span>            :    Lowercase the first character of the word in a native string */</a>
<a name="2680"><span class="lineNum">    2680 </span><span class="lineCov">        114 : static zend_string* php_lcfirst(zend_string *str)</span></a>
<a name="2681"><span class="lineNum">    2681 </span>            : {</a>
<a name="2682"><span class="lineNum">    2682 </span><span class="lineCov">        114 :         unsigned char r = tolower(ZSTR_VAL(str)[0]);</span></a>
<a name="2683"><span class="lineNum">    2683 </span><span class="lineCov">        114 :         if (r == ZSTR_VAL(str)[0]) {</span></a>
<a name="2684"><span class="lineNum">    2684 </span><span class="lineCov">         87 :                 return zend_string_copy(str);</span></a>
<a name="2685"><span class="lineNum">    2685 </span>            :         } else {</a>
<a name="2686"><span class="lineNum">    2686 </span><span class="lineCov">         27 :                 zend_string *s = zend_string_init(ZSTR_VAL(str), ZSTR_LEN(str), 0);</span></a>
<a name="2687"><span class="lineNum">    2687 </span><span class="lineCov">         27 :                 ZSTR_VAL(s)[0] = r;</span></a>
<a name="2688"><span class="lineNum">    2688 </span><span class="lineCov">         27 :                 return s;</span></a>
<a name="2689"><span class="lineNum">    2689 </span>            :         }</a>
<a name="2690"><span class="lineNum">    2690 </span>            : }</a>
<a name="2691"><span class="lineNum">    2691 </span>            : /* }}} */</a>
<a name="2692"><span class="lineNum">    2692 </span>            : </a>
<a name="2693"><span class="lineNum">    2693 </span>            : /* {{{ Make a string's first character lowercase */</a>
<a name="2694"><span class="lineNum">    2694 </span><span class="lineCov">        177 : PHP_FUNCTION(lcfirst)</span></a>
<a name="2695"><span class="lineNum">    2695 </span>            : {</a>
<a name="2696"><span class="lineNum">    2696 </span>            :         zend_string  *str;</a>
<a name="2697"><span class="lineNum">    2697 </span>            : </a>
<a name="2698"><span class="lineNum">    2698 </span><span class="lineCov">        177 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="2699"><span class="lineNum">    2699 </span><span class="lineCov">        258 :                 Z_PARAM_STR(str)</span></a>
<a name="2700"><span class="lineNum">    2700 </span><span class="lineCov">        177 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2701"><span class="lineNum">    2701 </span>            : </a>
<a name="2702"><span class="lineNum">    2702 </span><span class="lineCov">        126 :         if (!ZSTR_LEN(str)) {</span></a>
<a name="2703"><span class="lineNum">    2703 </span><span class="lineCov">         12 :                 RETURN_EMPTY_STRING();</span></a>
<a name="2704"><span class="lineNum">    2704 </span>            :         }</a>
<a name="2705"><span class="lineNum">    2705 </span>            : </a>
<a name="2706"><span class="lineNum">    2706 </span><span class="lineCov">        228 :         RETURN_STR(php_lcfirst(str));</span></a>
<a name="2707"><span class="lineNum">    2707 </span>            : }</a>
<a name="2708"><span class="lineNum">    2708 </span>            : /* }}} */</a>
<a name="2709"><span class="lineNum">    2709 </span>            : </a>
<a name="2710"><span class="lineNum">    2710 </span>            : /* {{{ Uppercase the first character of every word in a string */</a>
<a name="2711"><span class="lineNum">    2711 </span><span class="lineCov">        267 : PHP_FUNCTION(ucwords)</span></a>
<a name="2712"><span class="lineNum">    2712 </span>            : {</a>
<a name="2713"><span class="lineNum">    2713 </span>            :         zend_string *str;</a>
<a name="2714"><span class="lineNum">    2714 </span><span class="lineCov">        267 :         char *delims = &quot; \t\r\n\f\v&quot;;</span></a>
<a name="2715"><span class="lineNum">    2715 </span>            :         char *r;</a>
<a name="2716"><span class="lineNum">    2716 </span>            :         const char *r_end;</a>
<a name="2717"><span class="lineNum">    2717 </span><span class="lineCov">        267 :         size_t delims_len = 6;</span></a>
<a name="2718"><span class="lineNum">    2718 </span>            :         char mask[256];</a>
<a name="2719"><span class="lineNum">    2719 </span>            : </a>
<a name="2720"><span class="lineNum">    2720 </span><span class="lineCov">        267 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="2721"><span class="lineNum">    2721 </span><span class="lineCov">        450 :                 Z_PARAM_STR(str)</span></a>
<a name="2722"><span class="lineNum">    2722 </span><span class="lineCov">        219 :                 Z_PARAM_OPTIONAL</span></a>
<a name="2723"><span class="lineNum">    2723 </span><span class="lineCov">        234 :                 Z_PARAM_STRING(delims, delims_len)</span></a>
<a name="2724"><span class="lineNum">    2724 </span><span class="lineCov">        279 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="2725"><span class="lineNum">    2725 </span>            : </a>
<a name="2726"><span class="lineNum">    2726 </span><span class="lineCov">        219 :         if (!ZSTR_LEN(str)) {</span></a>
<a name="2727"><span class="lineNum">    2727 </span><span class="lineCov">         12 :                 RETURN_EMPTY_STRING();</span></a>
<a name="2728"><span class="lineNum">    2728 </span>            :         }</a>
<a name="2729"><span class="lineNum">    2729 </span>            : </a>
<a name="2730"><span class="lineNum">    2730 </span><span class="lineCov">        207 :         php_charmask((const unsigned char *) delims, delims_len, mask);</span></a>
<a name="2731"><span class="lineNum">    2731 </span>            : </a>
<a name="2732"><span class="lineNum">    2732 </span><span class="lineCov">        207 :         ZVAL_STRINGL(return_value, ZSTR_VAL(str), ZSTR_LEN(str));</span></a>
<a name="2733"><span class="lineNum">    2733 </span><span class="lineCov">        207 :         r = Z_STRVAL_P(return_value);</span></a>
<a name="2734"><span class="lineNum">    2734 </span>            : </a>
<a name="2735"><span class="lineNum">    2735 </span><span class="lineCov">        207 :         *r = toupper((unsigned char) *r);</span></a>
<a name="2736"><span class="lineNum">    2736 </span><span class="lineCov">       5151 :         for (r_end = r + Z_STRLEN_P(return_value) - 1; r &lt; r_end; ) {</span></a>
<a name="2737"><span class="lineNum">    2737 </span><span class="lineCov">       4944 :                 if (mask[(unsigned char)*r++]) {</span></a>
<a name="2738"><span class="lineNum">    2738 </span><span class="lineCov">        570 :                         *r = toupper((unsigned char) *r);</span></a>
<a name="2739"><span class="lineNum">    2739 </span>            :                 }</a>
<a name="2740"><span class="lineNum">    2740 </span>            :         }</a>
<a name="2741"><span class="lineNum">    2741 </span>            : }</a>
<a name="2742"><span class="lineNum">    2742 </span>            : /* }}} */</a>
<a name="2743"><span class="lineNum">    2743 </span>            : </a>
<a name="2744"><span class="lineNum">    2744 </span>            : /* {{{ php_strtr */</a>
<a name="2745"><span class="lineNum">    2745 </span><span class="lineCov">       3942 : PHPAPI char *php_strtr(char *str, size_t len, const char *str_from, const char *str_to, size_t trlen)</span></a>
<a name="2746"><span class="lineNum">    2746 </span>            : {</a>
<a name="2747"><span class="lineNum">    2747 </span>            :         size_t i;</a>
<a name="2748"><span class="lineNum">    2748 </span>            : </a>
<a name="2749"><span class="lineNum">    2749 </span><span class="lineCov">       3942 :         if (UNEXPECTED(trlen &lt; 1)) {</span></a>
<a name="2750"><span class="lineNum">    2750 </span><span class="lineNoCov">          0 :                 return str;</span></a>
<a name="2751"><span class="lineNum">    2751 </span><span class="lineCov">       3942 :         } else if (trlen == 1) {</span></a>
<a name="2752"><span class="lineNum">    2752 </span><span class="lineNoCov">          0 :                 char ch_from = *str_from;</span></a>
<a name="2753"><span class="lineNum">    2753 </span><span class="lineNoCov">          0 :                 char ch_to = *str_to;</span></a>
<a name="2754"><span class="lineNum">    2754 </span>            : </a>
<a name="2755"><span class="lineNum">    2755 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; len; i++) {</span></a>
<a name="2756"><span class="lineNum">    2756 </span><span class="lineNoCov">          0 :                         if (str[i] == ch_from) {</span></a>
<a name="2757"><span class="lineNum">    2757 </span><span class="lineNoCov">          0 :                                 str[i] = ch_to;</span></a>
<a name="2758"><span class="lineNum">    2758 </span>            :                         }</a>
<a name="2759"><span class="lineNum">    2759 </span>            :                 }</a>
<a name="2760"><span class="lineNum">    2760 </span>            :         } else {</a>
<a name="2761"><span class="lineNum">    2761 </span>            :                 unsigned char xlat[256];</a>
<a name="2762"><span class="lineNum">    2762 </span>            : </a>
<a name="2763"><span class="lineNum">    2763 </span><span class="lineCov">       3942 :                 memset(xlat, 0, sizeof(xlat));</span></a>
<a name="2764"><span class="lineNum">    2764 </span>            : </a>
<a name="2765"><span class="lineNum">    2765 </span><span class="lineCov">     188568 :                 for (i = 0; i &lt; trlen; i++) {</span></a>
<a name="2766"><span class="lineNum">    2766 </span><span class="lineCov">     184626 :                         xlat[(size_t)(unsigned char) str_from[i]] = str_to[i] - str_from[i];</span></a>
<a name="2767"><span class="lineNum">    2767 </span>            :                 }</a>
<a name="2768"><span class="lineNum">    2768 </span>            : </a>
<a name="2769"><span class="lineNum">    2769 </span><span class="lineCov">   31660100 :                 for (i = 0; i &lt; len; i++) {</span></a>
<a name="2770"><span class="lineNum">    2770 </span><span class="lineCov">   31656200 :                         str[i] += xlat[(size_t)(unsigned char) str[i]];</span></a>
<a name="2771"><span class="lineNum">    2771 </span>            :                 }</a>
<a name="2772"><span class="lineNum">    2772 </span>            :         }</a>
<a name="2773"><span class="lineNum">    2773 </span>            : </a>
<a name="2774"><span class="lineNum">    2774 </span><span class="lineCov">       3942 :         return str;</span></a>
<a name="2775"><span class="lineNum">    2775 </span>            : }</a>
<a name="2776"><span class="lineNum">    2776 </span>            : /* }}} */</a>
<a name="2777"><span class="lineNum">    2777 </span>            : </a>
<a name="2778"><span class="lineNum">    2778 </span>            : /* {{{ php_strtr_ex */</a>
<a name="2779"><span class="lineNum">    2779 </span><span class="lineCov">        150 : static zend_string *php_strtr_ex(zend_string *str, const char *str_from, const char *str_to, size_t trlen)</span></a>
<a name="2780"><span class="lineNum">    2780 </span>            : {</a>
<a name="2781"><span class="lineNum">    2781 </span><span class="lineCov">        150 :         zend_string *new_str = NULL;</span></a>
<a name="2782"><span class="lineNum">    2782 </span>            :         size_t i;</a>
<a name="2783"><span class="lineNum">    2783 </span>            : </a>
<a name="2784"><span class="lineNum">    2784 </span><span class="lineCov">        150 :         if (UNEXPECTED(trlen &lt; 1)) {</span></a>
<a name="2785"><span class="lineNum">    2785 </span><span class="lineCov">         12 :                 return zend_string_copy(str);</span></a>
<a name="2786"><span class="lineNum">    2786 </span><span class="lineCov">        138 :         } else if (trlen == 1) {</span></a>
<a name="2787"><span class="lineNum">    2787 </span><span class="lineCov">         27 :                 char ch_from = *str_from;</span></a>
<a name="2788"><span class="lineNum">    2788 </span><span class="lineCov">         27 :                 char ch_to = *str_to;</span></a>
<a name="2789"><span class="lineNum">    2789 </span>            :                 char *output;</a>
<a name="2790"><span class="lineNum">    2790 </span><span class="lineCov">         27 :                 char *input = ZSTR_VAL(str);</span></a>
<a name="2791"><span class="lineNum">    2791 </span><span class="lineCov">         27 :                 size_t len = ZSTR_LEN(str);</span></a>
<a name="2792"><span class="lineNum">    2792 </span>            : </a>
<a name="2793"><span class="lineNum">    2793 </span>            : #ifdef __SSE2__</a>
<a name="2794"><span class="lineNum">    2794 </span><span class="lineCov">         27 :                 if (ZSTR_LEN(str) &gt;= sizeof(__m128i)) {</span></a>
<a name="2795"><span class="lineNum">    2795 </span><span class="lineCov">          6 :                         __m128i search = _mm_set1_epi8(ch_from);</span></a>
<a name="2796"><span class="lineNum">    2796 </span><span class="lineCov">         12 :                         __m128i delta = _mm_set1_epi8(ch_to - ch_from);</span></a>
<a name="2797"><span class="lineNum">    2797 </span>            : </a>
<a name="2798"><span class="lineNum">    2798 </span>            :                         do {</a>
<a name="2799"><span class="lineNum">    2799 </span><span class="lineCov">          6 :                                 __m128i src = _mm_loadu_si128((__m128i*)(input));</span></a>
<a name="2800"><span class="lineNum">    2800 </span><span class="lineCov">          6 :                                 __m128i mask = _mm_cmpeq_epi8(src, search);</span></a>
<a name="2801"><span class="lineNum">    2801 </span><span class="lineCov">          6 :                                 if (_mm_movemask_epi8(mask)) {</span></a>
<a name="2802"><span class="lineNum">    2802 </span><span class="lineNoCov">          0 :                                         new_str = zend_string_alloc(ZSTR_LEN(str), 0);</span></a>
<a name="2803"><span class="lineNum">    2803 </span><span class="lineNoCov">          0 :                                         memcpy(ZSTR_VAL(new_str), ZSTR_VAL(str), input - ZSTR_VAL(str));</span></a>
<a name="2804"><span class="lineNum">    2804 </span><span class="lineNoCov">          0 :                                         output = ZSTR_VAL(new_str) + (input - ZSTR_VAL(str));</span></a>
<a name="2805"><span class="lineNum">    2805 </span><span class="lineNoCov">          0 :                                         _mm_storeu_si128((__m128i *)(output),</span></a>
<a name="2806"><span class="lineNum">    2806 </span>            :                                                 _mm_add_epi8(src,</a>
<a name="2807"><span class="lineNum">    2807 </span>            :                                                         _mm_and_si128(mask, delta)));</a>
<a name="2808"><span class="lineNum">    2808 </span><span class="lineNoCov">          0 :                                         input += sizeof(__m128i);</span></a>
<a name="2809"><span class="lineNum">    2809 </span><span class="lineNoCov">          0 :                                         output += sizeof(__m128i);</span></a>
<a name="2810"><span class="lineNum">    2810 </span><span class="lineNoCov">          0 :                                         len -= sizeof(__m128i);</span></a>
<a name="2811"><span class="lineNum">    2811 </span><span class="lineNoCov">          0 :                                         for (; len &gt;= sizeof(__m128i); input += sizeof(__m128i), output += sizeof(__m128i), len -= sizeof(__m128i)) {</span></a>
<a name="2812"><span class="lineNum">    2812 </span><span class="lineNoCov">          0 :                                                 src = _mm_loadu_si128((__m128i*)(input));</span></a>
<a name="2813"><span class="lineNum">    2813 </span><span class="lineNoCov">          0 :                                                 mask = _mm_cmpeq_epi8(src, search);</span></a>
<a name="2814"><span class="lineNum">    2814 </span><span class="lineNoCov">          0 :                                                 _mm_storeu_si128((__m128i *)(output),</span></a>
<a name="2815"><span class="lineNum">    2815 </span>            :                                                         _mm_add_epi8(src,</a>
<a name="2816"><span class="lineNum">    2816 </span>            :                                                                 _mm_and_si128(mask, delta)));</a>
<a name="2817"><span class="lineNum">    2817 </span>            :                                         }</a>
<a name="2818"><span class="lineNum">    2818 </span><span class="lineNoCov">          0 :                                         for (; len &gt; 0; input++, output++, len--) {</span></a>
<a name="2819"><span class="lineNum">    2819 </span><span class="lineNoCov">          0 :                                                 *output = (*input == ch_from) ? ch_to : *input;</span></a>
<a name="2820"><span class="lineNum">    2820 </span>            :                                         }</a>
<a name="2821"><span class="lineNum">    2821 </span><span class="lineNoCov">          0 :                                         *output = 0;</span></a>
<a name="2822"><span class="lineNum">    2822 </span><span class="lineNoCov">          0 :                                         return new_str;</span></a>
<a name="2823"><span class="lineNum">    2823 </span>            :                                 }</a>
<a name="2824"><span class="lineNum">    2824 </span><span class="lineCov">          6 :                                 input += sizeof(__m128i);</span></a>
<a name="2825"><span class="lineNum">    2825 </span><span class="lineCov">          6 :                                 len -= sizeof(__m128i);</span></a>
<a name="2826"><span class="lineNum">    2826 </span><span class="lineCov">          6 :                         } while (len &gt;= sizeof(__m128i));</span></a>
<a name="2827"><span class="lineNum">    2827 </span>            :                 }</a>
<a name="2828"><span class="lineNum">    2828 </span>            : #endif</a>
<a name="2829"><span class="lineNum">    2829 </span><span class="lineCov">         42 :                 for (; len &gt; 0; input++, len--) {</span></a>
<a name="2830"><span class="lineNum">    2830 </span><span class="lineCov">         42 :                         if (*input == ch_from) {</span></a>
<a name="2831"><span class="lineNum">    2831 </span><span class="lineCov">         27 :                                 new_str = zend_string_alloc(ZSTR_LEN(str), 0);</span></a>
<a name="2832"><span class="lineNum">    2832 </span><span class="lineCov">         27 :                                 memcpy(ZSTR_VAL(new_str), ZSTR_VAL(str), input - ZSTR_VAL(str));</span></a>
<a name="2833"><span class="lineNum">    2833 </span><span class="lineCov">         27 :                                 output = ZSTR_VAL(new_str) + (input - ZSTR_VAL(str));</span></a>
<a name="2834"><span class="lineNum">    2834 </span><span class="lineCov">         27 :                                 *output = ch_to;</span></a>
<a name="2835"><span class="lineNum">    2835 </span><span class="lineCov">         27 :                                 input++;</span></a>
<a name="2836"><span class="lineNum">    2836 </span><span class="lineCov">         27 :                                 output++;</span></a>
<a name="2837"><span class="lineNum">    2837 </span><span class="lineCov">         27 :                                 len--;</span></a>
<a name="2838"><span class="lineNum">    2838 </span><span class="lineCov">        171 :                                 for (; len &gt; 0; input++, output++, len--) {</span></a>
<a name="2839"><span class="lineNum">    2839 </span><span class="lineCov">        144 :                                         *output = (*input == ch_from) ? ch_to : *input;</span></a>
<a name="2840"><span class="lineNum">    2840 </span>            :                                 }</a>
<a name="2841"><span class="lineNum">    2841 </span><span class="lineCov">         27 :                                 *output = 0;</span></a>
<a name="2842"><span class="lineNum">    2842 </span><span class="lineCov">         27 :                                 return new_str;</span></a>
<a name="2843"><span class="lineNum">    2843 </span>            :                         }</a>
<a name="2844"><span class="lineNum">    2844 </span>            :                 }</a>
<a name="2845"><span class="lineNum">    2845 </span>            :         } else {</a>
<a name="2846"><span class="lineNum">    2846 </span>            :                 unsigned char xlat[256];</a>
<a name="2847"><span class="lineNum">    2847 </span>            : </a>
<a name="2848"><span class="lineNum">    2848 </span><span class="lineCov">        111 :                 memset(xlat, 0, sizeof(xlat));;</span></a>
<a name="2849"><span class="lineNum">    2849 </span>            : </a>
<a name="2850"><span class="lineNum">    2850 </span><span class="lineCov">        687 :                 for (i = 0; i &lt; trlen; i++) {</span></a>
<a name="2851"><span class="lineNum">    2851 </span><span class="lineCov">        576 :                         xlat[(size_t)(unsigned char) str_from[i]] = str_to[i] - str_from[i];</span></a>
<a name="2852"><span class="lineNum">    2852 </span>            :                 }</a>
<a name="2853"><span class="lineNum">    2853 </span>            : </a>
<a name="2854"><span class="lineNum">    2854 </span><span class="lineCov">        207 :                 for (i = 0; i &lt; ZSTR_LEN(str); i++) {</span></a>
<a name="2855"><span class="lineNum">    2855 </span><span class="lineCov">        201 :                         if (xlat[(size_t)(unsigned char) ZSTR_VAL(str)[i]]) {</span></a>
<a name="2856"><span class="lineNum">    2856 </span><span class="lineCov">        105 :                                 new_str = zend_string_alloc(ZSTR_LEN(str), 0);</span></a>
<a name="2857"><span class="lineNum">    2857 </span><span class="lineCov">        105 :                                 memcpy(ZSTR_VAL(new_str), ZSTR_VAL(str), i);</span></a>
<a name="2858"><span class="lineNum">    2858 </span>            :                                 do {</a>
<a name="2859"><span class="lineNum">    2859 </span><span class="lineCov">        942 :                                         ZSTR_VAL(new_str)[i] = ZSTR_VAL(str)[i] + xlat[(size_t)(unsigned char) ZSTR_VAL(str)[i]];</span></a>
<a name="2860"><span class="lineNum">    2860 </span><span class="lineCov">        942 :                                         i++;</span></a>
<a name="2861"><span class="lineNum">    2861 </span><span class="lineCov">        942 :                                 } while (i &lt; ZSTR_LEN(str));</span></a>
<a name="2862"><span class="lineNum">    2862 </span><span class="lineCov">        105 :                                 ZSTR_VAL(new_str)[i] = 0;</span></a>
<a name="2863"><span class="lineNum">    2863 </span><span class="lineCov">        105 :                                 return new_str;</span></a>
<a name="2864"><span class="lineNum">    2864 </span>            :                         }</a>
<a name="2865"><span class="lineNum">    2865 </span>            :                 }</a>
<a name="2866"><span class="lineNum">    2866 </span>            :         }</a>
<a name="2867"><span class="lineNum">    2867 </span>            : </a>
<a name="2868"><span class="lineNum">    2868 </span><span class="lineCov">          6 :         return zend_string_copy(str);</span></a>
<a name="2869"><span class="lineNum">    2869 </span>            : }</a>
<a name="2870"><span class="lineNum">    2870 </span>            : /* }}} */</a>
<a name="2871"><span class="lineNum">    2871 </span>            : </a>
<a name="2872"><span class="lineNum">    2872 </span>            : /* {{{ php_strtr_array */</a>
<a name="2873"><span class="lineNum">    2873 </span><span class="lineCov">     184605 : static void php_strtr_array(zval *return_value, zend_string *input, HashTable *pats)</span></a>
<a name="2874"><span class="lineNum">    2874 </span>            : {</a>
<a name="2875"><span class="lineNum">    2875 </span><span class="lineCov">     184605 :         const char *str = ZSTR_VAL(input);</span></a>
<a name="2876"><span class="lineNum">    2876 </span><span class="lineCov">     184605 :         size_t slen = ZSTR_LEN(input);</span></a>
<a name="2877"><span class="lineNum">    2877 </span>            :         zend_ulong num_key;</a>
<a name="2878"><span class="lineNum">    2878 </span>            :         zend_string *str_key;</a>
<a name="2879"><span class="lineNum">    2879 </span>            :         size_t len, pos, old_pos;</a>
<a name="2880"><span class="lineNum">    2880 </span><span class="lineCov">     184605 :         int num_keys = 0;</span></a>
<a name="2881"><span class="lineNum">    2881 </span><span class="lineCov">     184605 :         size_t minlen = 128*1024;</span></a>
<a name="2882"><span class="lineNum">    2882 </span><span class="lineCov">     184605 :         size_t maxlen = 0;</span></a>
<a name="2883"><span class="lineNum">    2883 </span>            :         HashTable str_hash;</a>
<a name="2884"><span class="lineNum">    2884 </span>            :         zval *entry;</a>
<a name="2885"><span class="lineNum">    2885 </span>            :         const char *key;</a>
<a name="2886"><span class="lineNum">    2886 </span><span class="lineCov">     184605 :         smart_str result = {0};</span></a>
<a name="2887"><span class="lineNum">    2887 </span>            :         zend_ulong bitset[256/sizeof(zend_ulong)];</a>
<a name="2888"><span class="lineNum">    2888 </span>            :         zend_ulong *num_bitset;</a>
<a name="2889"><span class="lineNum">    2889 </span>            : </a>
<a name="2890"><span class="lineNum">    2890 </span>            :         /* we will collect all possible key lengths */</a>
<a name="2891"><span class="lineNum">    2891 </span><span class="lineCov">     184605 :         num_bitset = ecalloc((slen + sizeof(zend_ulong)) / sizeof(zend_ulong), sizeof(zend_ulong));</span></a>
<a name="2892"><span class="lineNum">    2892 </span><span class="lineCov">     184605 :         memset(bitset, 0, sizeof(bitset));</span></a>
<a name="2893"><span class="lineNum">    2893 </span>            : </a>
<a name="2894"><span class="lineNum">    2894 </span>            :         /* check if original array has numeric keys */</a>
<a name="2895"><span class="lineNum">    2895 </span><span class="lineCov">    2768170 :         ZEND_HASH_FOREACH_STR_KEY(pats, str_key) {</span></a>
<a name="2896"><span class="lineNum">    2896 </span><span class="lineCov">    1291780 :                 if (UNEXPECTED(!str_key)) {</span></a>
<a name="2897"><span class="lineNum">    2897 </span><span class="lineCov">         57 :                         num_keys = 1;</span></a>
<a name="2898"><span class="lineNum">    2898 </span>            :                 } else {</a>
<a name="2899"><span class="lineNum">    2899 </span><span class="lineCov">    1291720 :                         len = ZSTR_LEN(str_key);</span></a>
<a name="2900"><span class="lineNum">    2900 </span><span class="lineCov">    1291720 :                         if (UNEXPECTED(len &lt; 1)) {</span></a>
<a name="2901"><span class="lineNum">    2901 </span><span class="lineCov">          3 :                                 php_error_docref(NULL, E_WARNING, &quot;Ignoring replacement of empty string&quot;);</span></a>
<a name="2902"><span class="lineNum">    2902 </span><span class="lineCov">          3 :                                 continue;</span></a>
<a name="2903"><span class="lineNum">    2903 </span><span class="lineCov">    1291720 :                         } else if (UNEXPECTED(len &gt; slen)) {</span></a>
<a name="2904"><span class="lineNum">    2904 </span>            :                                 /* skip long patterns */</a>
<a name="2905"><span class="lineNum">    2905 </span><span class="lineCov">         45 :                                 continue;</span></a>
<a name="2906"><span class="lineNum">    2906 </span>            :                         }</a>
<a name="2907"><span class="lineNum">    2907 </span><span class="lineCov">    1291680 :                         if (len &gt; maxlen) {</span></a>
<a name="2908"><span class="lineNum">    2908 </span><span class="lineCov">     184707 :                                 maxlen = len;</span></a>
<a name="2909"><span class="lineNum">    2909 </span>            :                         }</a>
<a name="2910"><span class="lineNum">    2910 </span><span class="lineCov">    1291680 :                         if (len &lt; minlen) {</span></a>
<a name="2911"><span class="lineNum">    2911 </span><span class="lineCov">     184605 :                                 minlen = len;</span></a>
<a name="2912"><span class="lineNum">    2912 </span>            :                         }</a>
<a name="2913"><span class="lineNum">    2913 </span>            :                         /* remember possible key length */</a>
<a name="2914"><span class="lineNum">    2914 </span><span class="lineCov">    1291680 :                         num_bitset[len / sizeof(zend_ulong)] |= Z_UL(1) &lt;&lt; (len % sizeof(zend_ulong));</span></a>
<a name="2915"><span class="lineNum">    2915 </span><span class="lineCov">    1291680 :                         bitset[((unsigned char)ZSTR_VAL(str_key)[0]) / sizeof(zend_ulong)] |= Z_UL(1) &lt;&lt; (((unsigned char)ZSTR_VAL(str_key)[0]) % sizeof(zend_ulong));</span></a>
<a name="2916"><span class="lineNum">    2916 </span>            :                 }</a>
<a name="2917"><span class="lineNum">    2917 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="2918"><span class="lineNum">    2918 </span>            : </a>
<a name="2919"><span class="lineNum">    2919 </span><span class="lineCov">     184605 :         if (UNEXPECTED(num_keys)) {</span></a>
<a name="2920"><span class="lineNum">    2920 </span>            :                 zend_string *key_used;</a>
<a name="2921"><span class="lineNum">    2921 </span>            :                 /* we have to rebuild HashTable with numeric keys */</a>
<a name="2922"><span class="lineNum">    2922 </span><span class="lineCov">         27 :                 zend_hash_init(&amp;str_hash, zend_hash_num_elements(pats), NULL, NULL, 0);</span></a>
<a name="2923"><span class="lineNum">    2923 </span><span class="lineCov">        267 :                 ZEND_HASH_FOREACH_KEY_VAL(pats, num_key, str_key, entry) {</span></a>
<a name="2924"><span class="lineNum">    2924 </span><span class="lineCov">        120 :                         if (UNEXPECTED(!str_key)) {</span></a>
<a name="2925"><span class="lineNum">    2925 </span><span class="lineCov">         57 :                                 key_used = zend_long_to_str(num_key);</span></a>
<a name="2926"><span class="lineNum">    2926 </span><span class="lineCov">         57 :                                 len = ZSTR_LEN(key_used);</span></a>
<a name="2927"><span class="lineNum">    2927 </span><span class="lineCov">         57 :                                 if (UNEXPECTED(len &gt; slen)) {</span></a>
<a name="2928"><span class="lineNum">    2928 </span>            :                                         /* skip long patterns */</a>
<a name="2929"><span class="lineNum">    2929 </span>            :                                         zend_string_release(key_used);</a>
<a name="2930"><span class="lineNum">    2930 </span><span class="lineCov">         30 :                                         continue;</span></a>
<a name="2931"><span class="lineNum">    2931 </span>            :                                 }</a>
<a name="2932"><span class="lineNum">    2932 </span><span class="lineCov">         27 :                                 if (len &gt; maxlen) {</span></a>
<a name="2933"><span class="lineNum">    2933 </span><span class="lineCov">          3 :                                         maxlen = len;</span></a>
<a name="2934"><span class="lineNum">    2934 </span>            :                                 }</a>
<a name="2935"><span class="lineNum">    2935 </span><span class="lineCov">         27 :                                 if (len &lt; minlen) {</span></a>
<a name="2936"><span class="lineNum">    2936 </span><span class="lineCov">          3 :                                         minlen = len;</span></a>
<a name="2937"><span class="lineNum">    2937 </span>            :                                 }</a>
<a name="2938"><span class="lineNum">    2938 </span>            :                                 /* remember possible key length */</a>
<a name="2939"><span class="lineNum">    2939 </span><span class="lineCov">         27 :                                 num_bitset[len / sizeof(zend_ulong)] |= Z_UL(1) &lt;&lt; (len % sizeof(zend_ulong));</span></a>
<a name="2940"><span class="lineNum">    2940 </span><span class="lineCov">         27 :                                 bitset[((unsigned char)ZSTR_VAL(key_used)[0]) / sizeof(zend_ulong)] |= Z_UL(1) &lt;&lt; (((unsigned char)ZSTR_VAL(key_used)[0]) % sizeof(zend_ulong));</span></a>
<a name="2941"><span class="lineNum">    2941 </span>            :                         } else {</a>
<a name="2942"><span class="lineNum">    2942 </span><span class="lineCov">         63 :                                 key_used = str_key;</span></a>
<a name="2943"><span class="lineNum">    2943 </span><span class="lineCov">         63 :                                 len = ZSTR_LEN(key_used);</span></a>
<a name="2944"><span class="lineNum">    2944 </span><span class="lineCov">         63 :                                 if (UNEXPECTED(len &gt; slen)) {</span></a>
<a name="2945"><span class="lineNum">    2945 </span>            :                                         /* skip long patterns */</a>
<a name="2946"><span class="lineNum">    2946 </span><span class="lineCov">         24 :                                         continue;</span></a>
<a name="2947"><span class="lineNum">    2947 </span>            :                                 }</a>
<a name="2948"><span class="lineNum">    2948 </span>            :                         }</a>
<a name="2949"><span class="lineNum">    2949 </span><span class="lineCov">         66 :                         zend_hash_add(&amp;str_hash, key_used, entry);</span></a>
<a name="2950"><span class="lineNum">    2950 </span><span class="lineCov">         66 :                         if (UNEXPECTED(!str_key)) {</span></a>
<a name="2951"><span class="lineNum">    2951 </span>            :                                 zend_string_release_ex(key_used, 0);</a>
<a name="2952"><span class="lineNum">    2952 </span>            :                         }</a>
<a name="2953"><span class="lineNum">    2953 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="2954"><span class="lineNum">    2954 </span><span class="lineCov">         27 :                 pats = &amp;str_hash;</span></a>
<a name="2955"><span class="lineNum">    2955 </span>            :         }</a>
<a name="2956"><span class="lineNum">    2956 </span>            : </a>
<a name="2957"><span class="lineNum">    2957 </span><span class="lineCov">     184605 :         if (UNEXPECTED(minlen &gt; maxlen)) {</span></a>
<a name="2958"><span class="lineNum">    2958 </span>            :                 /* return the original string */</a>
<a name="2959"><span class="lineNum">    2959 </span><span class="lineCov">          3 :                 if (pats == &amp;str_hash) {</span></a>
<a name="2960"><span class="lineNum">    2960 </span><span class="lineCov">          3 :                         zend_hash_destroy(&amp;str_hash);</span></a>
<a name="2961"><span class="lineNum">    2961 </span>            :                 }</a>
<a name="2962"><span class="lineNum">    2962 </span><span class="lineCov">          3 :                 efree(num_bitset);</span></a>
<a name="2963"><span class="lineNum">    2963 </span><span class="lineCov">          6 :                 RETURN_STR_COPY(input);</span></a>
<a name="2964"><span class="lineNum">    2964 </span>            :         }</a>
<a name="2965"><span class="lineNum">    2965 </span>            : </a>
<a name="2966"><span class="lineNum">    2966 </span><span class="lineCov">     184602 :         old_pos = pos = 0;</span></a>
<a name="2967"><span class="lineNum">    2967 </span><span class="lineCov">    6666700 :         while (pos &lt;= slen - minlen) {</span></a>
<a name="2968"><span class="lineNum">    2968 </span><span class="lineCov">    6482090 :                 key = str + pos;</span></a>
<a name="2969"><span class="lineNum">    2969 </span><span class="lineCov">    6482090 :                 if (bitset[((unsigned char)key[0]) / sizeof(zend_ulong)] &amp; (Z_UL(1) &lt;&lt; (((unsigned char)key[0]) % sizeof(zend_ulong)))) {</span></a>
<a name="2970"><span class="lineNum">    2970 </span><span class="lineCov">      38082 :                         len = maxlen;</span></a>
<a name="2971"><span class="lineNum">    2971 </span><span class="lineCov">      38082 :                         if (len &gt; slen - pos) {</span></a>
<a name="2972"><span class="lineNum">    2972 </span><span class="lineCov">          3 :                                 len = slen - pos;</span></a>
<a name="2973"><span class="lineNum">    2973 </span>            :                         }</a>
<a name="2974"><span class="lineNum">    2974 </span><span class="lineCov">      38355 :                         while (len &gt;= minlen) {</span></a>
<a name="2975"><span class="lineNum">    2975 </span><span class="lineCov">      38343 :                                 if ((num_bitset[len / sizeof(zend_ulong)] &amp; (Z_UL(1) &lt;&lt; (len % sizeof(zend_ulong))))) {</span></a>
<a name="2976"><span class="lineNum">    2976 </span><span class="lineCov">      38205 :                                         entry = zend_hash_str_find(pats, key, len);</span></a>
<a name="2977"><span class="lineNum">    2977 </span><span class="lineCov">      38205 :                                         if (entry != NULL) {</span></a>
<a name="2978"><span class="lineNum">    2978 </span>            :                                                 zend_string *tmp;</a>
<a name="2979"><span class="lineNum">    2979 </span><span class="lineCov">      38070 :                                                 zend_string *s = zval_get_tmp_string(entry, &amp;tmp);</span></a>
<a name="2980"><span class="lineNum">    2980 </span><span class="lineCov">      38070 :                                                 smart_str_appendl(&amp;result, str + old_pos, pos - old_pos);</span></a>
<a name="2981"><span class="lineNum">    2981 </span>            :                                                 smart_str_append(&amp;result, s);</a>
<a name="2982"><span class="lineNum">    2982 </span><span class="lineCov">      38070 :                                                 old_pos = pos + len;</span></a>
<a name="2983"><span class="lineNum">    2983 </span><span class="lineCov">      38070 :                                                 pos = old_pos - 1;</span></a>
<a name="2984"><span class="lineNum">    2984 </span><span class="lineCov">      38070 :                                                 zend_tmp_string_release(tmp);</span></a>
<a name="2985"><span class="lineNum">    2985 </span><span class="lineCov">      38070 :                                                 break;</span></a>
<a name="2986"><span class="lineNum">    2986 </span>            :                                         }</a>
<a name="2987"><span class="lineNum">    2987 </span>            :                                 }</a>
<a name="2988"><span class="lineNum">    2988 </span><span class="lineCov">        273 :                                 len--;</span></a>
<a name="2989"><span class="lineNum">    2989 </span>            :                         }</a>
<a name="2990"><span class="lineNum">    2990 </span>            :                 }</a>
<a name="2991"><span class="lineNum">    2991 </span><span class="lineCov">    6482090 :                 pos++;</span></a>
<a name="2992"><span class="lineNum">    2992 </span>            :         }</a>
<a name="2993"><span class="lineNum">    2993 </span>            : </a>
<a name="2994"><span class="lineNum">    2994 </span><span class="lineCov">     184602 :         if (result.s) {</span></a>
<a name="2995"><span class="lineNum">    2995 </span><span class="lineCov">       7860 :                 smart_str_appendl(&amp;result, str + old_pos, slen - old_pos);</span></a>
<a name="2996"><span class="lineNum">    2996 </span>            :                 smart_str_0(&amp;result);</a>
<a name="2997"><span class="lineNum">    2997 </span><span class="lineCov">       7860 :                 RETVAL_NEW_STR(result.s);</span></a>
<a name="2998"><span class="lineNum">    2998 </span>            :         } else {</a>
<a name="2999"><span class="lineNum">    2999 </span>            :                 smart_str_free(&amp;result);</a>
<a name="3000"><span class="lineNum">    3000 </span><span class="lineCov">     395277 :                 RETVAL_STR_COPY(input);</span></a>
<a name="3001"><span class="lineNum">    3001 </span>            :         }</a>
<a name="3002"><span class="lineNum">    3002 </span>            : </a>
<a name="3003"><span class="lineNum">    3003 </span><span class="lineCov">     184602 :         if (pats == &amp;str_hash) {</span></a>
<a name="3004"><span class="lineNum">    3004 </span><span class="lineCov">         24 :                 zend_hash_destroy(&amp;str_hash);</span></a>
<a name="3005"><span class="lineNum">    3005 </span>            :         }</a>
<a name="3006"><span class="lineNum">    3006 </span><span class="lineCov">     184602 :         efree(num_bitset);</span></a>
<a name="3007"><span class="lineNum">    3007 </span>            : }</a>
<a name="3008"><span class="lineNum">    3008 </span>            : /* }}} */</a>
<a name="3009"><span class="lineNum">    3009 </span>            : </a>
<a name="3010"><span class="lineNum">    3010 </span>            : /* {{{ count_chars */</a>
<a name="3011"><span class="lineNum">    3011 </span>            : static zend_always_inline zend_long count_chars(const char *p, zend_long length, char ch)</a>
<a name="3012"><span class="lineNum">    3012 </span>            : {</a>
<a name="3013"><span class="lineNum">    3013 </span><span class="lineCov">     324328 :         zend_long count = 0;</span></a>
<a name="3014"><span class="lineNum">    3014 </span>            :         const char *endp;</a>
<a name="3015"><span class="lineNum">    3015 </span>            : </a>
<a name="3016"><span class="lineNum">    3016 </span>            : #ifdef __SSE2__</a>
<a name="3017"><span class="lineNum">    3017 </span><span class="lineCov">     324328 :         if (length &gt;= sizeof(__m128i)) {</span></a>
<a name="3018"><span class="lineNum">    3018 </span><span class="lineCov">     190764 :                 __m128i search = _mm_set1_epi8(ch);</span></a>
<a name="3019"><span class="lineNum">    3019 </span>            : </a>
<a name="3020"><span class="lineNum">    3020 </span>            :                 do {</a>
<a name="3021"><span class="lineNum">    3021 </span><span class="lineCov">     120600 :                         __m128i src = _mm_loadu_si128((__m128i*)(p));</span></a>
<a name="3022"><span class="lineNum">    3022 </span><span class="lineCov">     120600 :                         uint32_t mask = _mm_movemask_epi8(_mm_cmpeq_epi8(src, search));</span></a>
<a name="3023"><span class="lineNum">    3023 </span>            :                         // TODO: It would be great to use POPCNT, but it's available only with SSE4.1</a>
<a name="3024"><span class="lineNum">    3024 </span>            : #if 1</a>
<a name="3025"><span class="lineNum">    3025 </span><span class="lineCov">     227505 :                         while (mask != 0) {</span></a>
<a name="3026"><span class="lineNum">    3026 </span><span class="lineCov">     106905 :                                 count++;</span></a>
<a name="3027"><span class="lineNum">    3027 </span><span class="lineCov">     106905 :                                 mask = mask &amp; (mask - 1);</span></a>
<a name="3028"><span class="lineNum">    3028 </span>            :                         }</a>
<a name="3029"><span class="lineNum">    3029 </span>            : #else</a>
<a name="3030"><span class="lineNum">    3030 </span>            :                         if (mask) {</a>
<a name="3031"><span class="lineNum">    3031 </span>            :                                 mask = mask - ((mask &gt;&gt; 1) &amp; 0x5555);</a>
<a name="3032"><span class="lineNum">    3032 </span>            :                                 mask = (mask &amp; 0x3333) + ((mask &gt;&gt; 2) &amp; 0x3333);</a>
<a name="3033"><span class="lineNum">    3033 </span>            :                                 mask = (mask + (mask &gt;&gt; 4)) &amp; 0x0F0F;</a>
<a name="3034"><span class="lineNum">    3034 </span>            :                                 mask = (mask + (mask &gt;&gt; 8)) &amp; 0x00ff;</a>
<a name="3035"><span class="lineNum">    3035 </span>            :                                 count += mask;</a>
<a name="3036"><span class="lineNum">    3036 </span>            :                         }</a>
<a name="3037"><span class="lineNum">    3037 </span>            : #endif</a>
<a name="3038"><span class="lineNum">    3038 </span><span class="lineCov">     120600 :                         p += sizeof(__m128i);</span></a>
<a name="3039"><span class="lineNum">    3039 </span><span class="lineCov">     120600 :                         length -= sizeof(__m128i);</span></a>
<a name="3040"><span class="lineNum">    3040 </span><span class="lineCov">     120600 :                 } while (length &gt;= sizeof(__m128i));</span></a>
<a name="3041"><span class="lineNum">    3041 </span>            :         }</a>
<a name="3042"><span class="lineNum">    3042 </span><span class="lineCov">     324328 :         endp = p + length;</span></a>
<a name="3043"><span class="lineNum">    3043 </span><span class="lineCov">    2102420 :         while (p != endp) {</span></a>
<a name="3044"><span class="lineNum">    3044 </span><span class="lineCov">    1778100 :                 count += (*p == ch);</span></a>
<a name="3045"><span class="lineNum">    3045 </span><span class="lineCov">    1778100 :                 p++;</span></a>
<a name="3046"><span class="lineNum">    3046 </span>            :         }</a>
<a name="3047"><span class="lineNum">    3047 </span>            : #else</a>
<a name="3048"><span class="lineNum">    3048 </span>            :         endp = p + length;</a>
<a name="3049"><span class="lineNum">    3049 </span>            :         while ((p = memchr(p, ch, endp-p))) {</a>
<a name="3050"><span class="lineNum">    3050 </span>            :                 count++;</a>
<a name="3051"><span class="lineNum">    3051 </span>            :                 p++;</a>
<a name="3052"><span class="lineNum">    3052 </span>            :         }</a>
<a name="3053"><span class="lineNum">    3053 </span>            : #endif</a>
<a name="3054"><span class="lineNum">    3054 </span><span class="lineCov">     324328 :         return count;</span></a>
<a name="3055"><span class="lineNum">    3055 </span>            : }</a>
<a name="3056"><span class="lineNum">    3056 </span>            : /* }}} */</a>
<a name="3057"><span class="lineNum">    3057 </span>            : </a>
<a name="3058"><span class="lineNum">    3058 </span>            : /* {{{ php_char_to_str_ex */</a>
<a name="3059"><span class="lineNum">    3059 </span><span class="lineCov">     324307 : static zend_string* php_char_to_str_ex(zend_string *str, char from, char *to, size_t to_len, int case_sensitivity, zend_long *replace_count)</span></a>
<a name="3060"><span class="lineNum">    3060 </span>            : {</a>
<a name="3061"><span class="lineNum">    3061 </span>            :         zend_string *result;</a>
<a name="3062"><span class="lineNum">    3062 </span>            :         size_t char_count;</a>
<a name="3063"><span class="lineNum">    3063 </span><span class="lineCov">     324307 :         int lc_from = 0;</span></a>
<a name="3064"><span class="lineNum">    3064 </span>            :         const char *source, *source_end;</a>
<a name="3065"><span class="lineNum">    3065 </span>            :         char *target;</a>
<a name="3066"><span class="lineNum">    3066 </span>            : </a>
<a name="3067"><span class="lineNum">    3067 </span><span class="lineCov">     324307 :         if (case_sensitivity) {</span></a>
<a name="3068"><span class="lineNum">    3068 </span><span class="lineCov">     648554 :                 char_count = count_chars(ZSTR_VAL(str), ZSTR_LEN(str), from);</span></a>
<a name="3069"><span class="lineNum">    3069 </span>            :         } else {</a>
<a name="3070"><span class="lineNum">    3070 </span><span class="lineCov">         30 :                 lc_from = tolower(from);</span></a>
<a name="3071"><span class="lineNum">    3071 </span><span class="lineCov">         30 :                 char_count = 0;</span></a>
<a name="3072"><span class="lineNum">    3072 </span><span class="lineCov">         30 :                 source_end = ZSTR_VAL(str) + ZSTR_LEN(str);</span></a>
<a name="3073"><span class="lineNum">    3073 </span><span class="lineCov">        999 :                 for (source = ZSTR_VAL(str); source &lt; source_end; source++) {</span></a>
<a name="3074"><span class="lineNum">    3074 </span><span class="lineCov">        969 :                         if (tolower(*source) == lc_from) {</span></a>
<a name="3075"><span class="lineNum">    3075 </span><span class="lineCov">         87 :                                 char_count++;</span></a>
<a name="3076"><span class="lineNum">    3076 </span>            :                         }</a>
<a name="3077"><span class="lineNum">    3077 </span>            :                 }</a>
<a name="3078"><span class="lineNum">    3078 </span>            :         }</a>
<a name="3079"><span class="lineNum">    3079 </span>            : </a>
<a name="3080"><span class="lineNum">    3080 </span><span class="lineCov">     324307 :         if (char_count == 0) {</span></a>
<a name="3081"><span class="lineNum">    3081 </span><span class="lineCov">     249604 :                 return zend_string_copy(str);</span></a>
<a name="3082"><span class="lineNum">    3082 </span>            :         }</a>
<a name="3083"><span class="lineNum">    3083 </span>            : </a>
<a name="3084"><span class="lineNum">    3084 </span><span class="lineCov">      74703 :         if (replace_count) {</span></a>
<a name="3085"><span class="lineNum">    3085 </span><span class="lineCov">      74694 :                 *replace_count += char_count;</span></a>
<a name="3086"><span class="lineNum">    3086 </span>            :         }</a>
<a name="3087"><span class="lineNum">    3087 </span>            : </a>
<a name="3088"><span class="lineNum">    3088 </span><span class="lineCov">      74703 :         if (to_len &gt; 0) {</span></a>
<a name="3089"><span class="lineNum">    3089 </span><span class="lineCov">        588 :                 result = zend_string_safe_alloc(char_count, to_len - 1, ZSTR_LEN(str), 0);</span></a>
<a name="3090"><span class="lineNum">    3090 </span>            :         } else {</a>
<a name="3091"><span class="lineNum">    3091 </span><span class="lineCov">     148818 :                 result = zend_string_alloc(ZSTR_LEN(str) - char_count, 0);</span></a>
<a name="3092"><span class="lineNum">    3092 </span>            :         }</a>
<a name="3093"><span class="lineNum">    3093 </span><span class="lineCov">      74703 :         target = ZSTR_VAL(result);</span></a>
<a name="3094"><span class="lineNum">    3094 </span>            : </a>
<a name="3095"><span class="lineNum">    3095 </span><span class="lineCov">      74703 :         if (case_sensitivity) {</span></a>
<a name="3096"><span class="lineNum">    3096 </span><span class="lineCov">      74688 :                 char *p = ZSTR_VAL(str), *e = p + ZSTR_LEN(str), *s = ZSTR_VAL(str);</span></a>
<a name="3097"><span class="lineNum">    3097 </span>            : </a>
<a name="3098"><span class="lineNum">    3098 </span><span class="lineCov">     224673 :                 while ((p = memchr(p, from, (e - p)))) {</span></a>
<a name="3099"><span class="lineNum">    3099 </span><span class="lineCov">     224673 :                         memcpy(target, s, (p - s));</span></a>
<a name="3100"><span class="lineNum">    3100 </span><span class="lineCov">     224673 :                         target += p - s;</span></a>
<a name="3101"><span class="lineNum">    3101 </span><span class="lineCov">     224673 :                         memcpy(target, to, to_len);</span></a>
<a name="3102"><span class="lineNum">    3102 </span><span class="lineCov">     224673 :                         target += to_len;</span></a>
<a name="3103"><span class="lineNum">    3103 </span><span class="lineCov">     224673 :                         p++;</span></a>
<a name="3104"><span class="lineNum">    3104 </span><span class="lineCov">     224673 :                         s = p;</span></a>
<a name="3105"><span class="lineNum">    3105 </span><span class="lineCov">     224673 :                         if (--char_count == 0) break;</span></a>
<a name="3106"><span class="lineNum">    3106 </span>            :                 }</a>
<a name="3107"><span class="lineNum">    3107 </span><span class="lineCov">      74688 :                 if (s &lt; e) {</span></a>
<a name="3108"><span class="lineNum">    3108 </span><span class="lineCov">      64146 :                         memcpy(target, s, (e - s));</span></a>
<a name="3109"><span class="lineNum">    3109 </span><span class="lineCov">      64146 :                         target += e - s;</span></a>
<a name="3110"><span class="lineNum">    3110 </span>            :                 }</a>
<a name="3111"><span class="lineNum">    3111 </span>            :         } else {</a>
<a name="3112"><span class="lineNum">    3112 </span><span class="lineCov">         15 :                 source_end = ZSTR_VAL(str) + ZSTR_LEN(str);</span></a>
<a name="3113"><span class="lineNum">    3113 </span><span class="lineCov">        654 :                 for (source = ZSTR_VAL(str); source &lt; source_end; source++) {</span></a>
<a name="3114"><span class="lineNum">    3114 </span><span class="lineCov">        639 :                         if (tolower(*source) == lc_from) {</span></a>
<a name="3115"><span class="lineNum">    3115 </span><span class="lineCov">         87 :                                 memcpy(target, to, to_len);</span></a>
<a name="3116"><span class="lineNum">    3116 </span><span class="lineCov">         87 :                                 target += to_len;</span></a>
<a name="3117"><span class="lineNum">    3117 </span>            :                         } else {</a>
<a name="3118"><span class="lineNum">    3118 </span><span class="lineCov">        552 :                                 *target = *source;</span></a>
<a name="3119"><span class="lineNum">    3119 </span><span class="lineCov">        552 :                                 target++;</span></a>
<a name="3120"><span class="lineNum">    3120 </span>            :                         }</a>
<a name="3121"><span class="lineNum">    3121 </span>            :                 }</a>
<a name="3122"><span class="lineNum">    3122 </span>            :         }</a>
<a name="3123"><span class="lineNum">    3123 </span><span class="lineCov">      74703 :         *target = 0;</span></a>
<a name="3124"><span class="lineNum">    3124 </span><span class="lineCov">      74703 :         return result;</span></a>
<a name="3125"><span class="lineNum">    3125 </span>            : }</a>
<a name="3126"><span class="lineNum">    3126 </span>            : /* }}} */</a>
<a name="3127"><span class="lineNum">    3127 </span>            : </a>
<a name="3128"><span class="lineNum">    3128 </span>            : /* {{{ php_str_to_str_ex */</a>
<a name="3129"><span class="lineNum">    3129 </span><span class="lineCov">      10657 : static zend_string *php_str_to_str_ex(zend_string *haystack,</span></a>
<a name="3130"><span class="lineNum">    3130 </span>            :         const char *needle, size_t needle_len, const char *str, size_t str_len, zend_long *replace_count)</a>
<a name="3131"><span class="lineNum">    3131 </span>            : {</a>
<a name="3132"><span class="lineNum">    3132 </span>            : </a>
<a name="3133"><span class="lineNum">    3133 </span><span class="lineCov">      10657 :         if (needle_len &lt; ZSTR_LEN(haystack)) {</span></a>
<a name="3134"><span class="lineNum">    3134 </span>            :                 zend_string *new_str;</a>
<a name="3135"><span class="lineNum">    3135 </span>            :                 const char *end;</a>
<a name="3136"><span class="lineNum">    3136 </span>            :                 const char *p, *r;</a>
<a name="3137"><span class="lineNum">    3137 </span>            :                 char *e;</a>
<a name="3138"><span class="lineNum">    3138 </span>            : </a>
<a name="3139"><span class="lineNum">    3139 </span><span class="lineCov">      10531 :                 if (needle_len == str_len) {</span></a>
<a name="3140"><span class="lineNum">    3140 </span><span class="lineCov">        963 :                         new_str = NULL;</span></a>
<a name="3141"><span class="lineNum">    3141 </span><span class="lineCov">        963 :                         end = ZSTR_VAL(haystack) + ZSTR_LEN(haystack);</span></a>
<a name="3142"><span class="lineNum">    3142 </span><span class="lineCov">       2853 :                         for (p = ZSTR_VAL(haystack); (r = (char*)php_memnstr(p, needle, needle_len, end)); p = r + needle_len) {</span></a>
<a name="3143"><span class="lineNum">    3143 </span><span class="lineCov">        927 :                                 if (!new_str) {</span></a>
<a name="3144"><span class="lineNum">    3144 </span><span class="lineCov">       1824 :                                         new_str = zend_string_init(ZSTR_VAL(haystack), ZSTR_LEN(haystack), 0);</span></a>
<a name="3145"><span class="lineNum">    3145 </span>            :                                 }</a>
<a name="3146"><span class="lineNum">    3146 </span><span class="lineCov">        927 :                                 memcpy(ZSTR_VAL(new_str) + (r - ZSTR_VAL(haystack)), str, str_len);</span></a>
<a name="3147"><span class="lineNum">    3147 </span><span class="lineCov">        927 :                                 (*replace_count)++;</span></a>
<a name="3148"><span class="lineNum">    3148 </span>            :                         }</a>
<a name="3149"><span class="lineNum">    3149 </span><span class="lineCov">        963 :                         if (!new_str) {</span></a>
<a name="3150"><span class="lineNum">    3150 </span><span class="lineCov">         51 :                                 goto nothing_todo;</span></a>
<a name="3151"><span class="lineNum">    3151 </span>            :                         }</a>
<a name="3152"><span class="lineNum">    3152 </span><span class="lineCov">        912 :                         return new_str;</span></a>
<a name="3153"><span class="lineNum">    3153 </span>            :                 } else {</a>
<a name="3154"><span class="lineNum">    3154 </span><span class="lineCov">       9568 :                         size_t count = 0;</span></a>
<a name="3155"><span class="lineNum">    3155 </span><span class="lineCov">       9568 :                         const char *o = ZSTR_VAL(haystack);</span></a>
<a name="3156"><span class="lineNum">    3156 </span><span class="lineCov">       9568 :                         const char *n = needle;</span></a>
<a name="3157"><span class="lineNum">    3157 </span><span class="lineCov">       9568 :                         const char *endp = o + ZSTR_LEN(haystack);</span></a>
<a name="3158"><span class="lineNum">    3158 </span>            : </a>
<a name="3159"><span class="lineNum">    3159 </span><span class="lineCov">      28715 :                         while ((o = (char*)php_memnstr(o, n, needle_len, endp))) {</span></a>
<a name="3160"><span class="lineNum">    3160 </span><span class="lineCov">       9579 :                                 o += needle_len;</span></a>
<a name="3161"><span class="lineNum">    3161 </span><span class="lineCov">       9579 :                                 count++;</span></a>
<a name="3162"><span class="lineNum">    3162 </span>            :                         }</a>
<a name="3163"><span class="lineNum">    3163 </span><span class="lineCov">       9568 :                         if (count == 0) {</span></a>
<a name="3164"><span class="lineNum">    3164 </span>            :                                 /* Needle doesn't occur, shortcircuit the actual replacement. */</a>
<a name="3165"><span class="lineNum">    3165 </span><span class="lineCov">         64 :                                 goto nothing_todo;</span></a>
<a name="3166"><span class="lineNum">    3166 </span>            :                         }</a>
<a name="3167"><span class="lineNum">    3167 </span><span class="lineCov">       9504 :                         if (str_len &gt; needle_len) {</span></a>
<a name="3168"><span class="lineNum">    3168 </span><span class="lineCov">         72 :                                 new_str = zend_string_safe_alloc(count, str_len - needle_len, ZSTR_LEN(haystack), 0);</span></a>
<a name="3169"><span class="lineNum">    3169 </span>            :                         } else {</a>
<a name="3170"><span class="lineNum">    3170 </span><span class="lineCov">      18936 :                                 new_str = zend_string_alloc(count * (str_len - needle_len) + ZSTR_LEN(haystack), 0);</span></a>
<a name="3171"><span class="lineNum">    3171 </span>            :                         }</a>
<a name="3172"><span class="lineNum">    3172 </span>            : </a>
<a name="3173"><span class="lineNum">    3173 </span><span class="lineCov">       9504 :                         e = ZSTR_VAL(new_str);</span></a>
<a name="3174"><span class="lineNum">    3174 </span><span class="lineCov">       9504 :                         end = ZSTR_VAL(haystack) + ZSTR_LEN(haystack);</span></a>
<a name="3175"><span class="lineNum">    3175 </span><span class="lineCov">      28587 :                         for (p = ZSTR_VAL(haystack); (r = (char*)php_memnstr(p, needle, needle_len, end)); p = r + needle_len) {</span></a>
<a name="3176"><span class="lineNum">    3176 </span><span class="lineCov">       9579 :                                 memcpy(e, p, r - p);</span></a>
<a name="3177"><span class="lineNum">    3177 </span><span class="lineCov">       9579 :                                 e += r - p;</span></a>
<a name="3178"><span class="lineNum">    3178 </span><span class="lineCov">       9579 :                                 memcpy(e, str, str_len);</span></a>
<a name="3179"><span class="lineNum">    3179 </span><span class="lineCov">       9579 :                                 e += str_len;</span></a>
<a name="3180"><span class="lineNum">    3180 </span><span class="lineCov">       9579 :                                 (*replace_count)++;</span></a>
<a name="3181"><span class="lineNum">    3181 </span>            :                         }</a>
<a name="3182"><span class="lineNum">    3182 </span>            : </a>
<a name="3183"><span class="lineNum">    3183 </span><span class="lineCov">       9504 :                         if (p &lt; end) {</span></a>
<a name="3184"><span class="lineNum">    3184 </span><span class="lineCov">       9501 :                                 memcpy(e, p, end - p);</span></a>
<a name="3185"><span class="lineNum">    3185 </span><span class="lineCov">       9501 :                                 e += end - p;</span></a>
<a name="3186"><span class="lineNum">    3186 </span>            :                         }</a>
<a name="3187"><span class="lineNum">    3187 </span>            : </a>
<a name="3188"><span class="lineNum">    3188 </span><span class="lineCov">       9504 :                         *e = '\0';</span></a>
<a name="3189"><span class="lineNum">    3189 </span><span class="lineCov">       9504 :                         return new_str;</span></a>
<a name="3190"><span class="lineNum">    3190 </span>            :                 }</a>
<a name="3191"><span class="lineNum">    3191 </span><span class="lineCov">        126 :         } else if (needle_len &gt; ZSTR_LEN(haystack) || memcmp(ZSTR_VAL(haystack), needle, ZSTR_LEN(haystack))) {</span></a>
<a name="3192"><span class="lineNum">    3192 </span><span class="lineCov">        205 : nothing_todo:</span></a>
<a name="3193"><span class="lineNum">    3193 </span><span class="lineCov">        205 :                 return zend_string_copy(haystack);</span></a>
<a name="3194"><span class="lineNum">    3194 </span>            :         } else {</a>
<a name="3195"><span class="lineNum">    3195 </span><span class="lineCov">         36 :                 (*replace_count)++;</span></a>
<a name="3196"><span class="lineNum">    3196 </span><span class="lineCov">         36 :                 return zend_string_init_fast(str, str_len);</span></a>
<a name="3197"><span class="lineNum">    3197 </span>            :         }</a>
<a name="3198"><span class="lineNum">    3198 </span>            : }</a>
<a name="3199"><span class="lineNum">    3199 </span>            : /* }}} */</a>
<a name="3200"><span class="lineNum">    3200 </span>            : </a>
<a name="3201"><span class="lineNum">    3201 </span>            : /* {{{ php_str_to_str_i_ex */</a>
<a name="3202"><span class="lineNum">    3202 </span><span class="lineCov">         84 : static zend_string *php_str_to_str_i_ex(zend_string *haystack, const char *lc_haystack,</span></a>
<a name="3203"><span class="lineNum">    3203 </span>            :         zend_string *needle, const char *str, size_t str_len, zend_long *replace_count)</a>
<a name="3204"><span class="lineNum">    3204 </span>            : {</a>
<a name="3205"><span class="lineNum">    3205 </span><span class="lineCov">         84 :         zend_string *new_str = NULL;</span></a>
<a name="3206"><span class="lineNum">    3206 </span>            :         zend_string *lc_needle;</a>
<a name="3207"><span class="lineNum">    3207 </span>            : </a>
<a name="3208"><span class="lineNum">    3208 </span><span class="lineCov">         84 :         if (ZSTR_LEN(needle) &lt; ZSTR_LEN(haystack)) {</span></a>
<a name="3209"><span class="lineNum">    3209 </span>            :                 const char *end;</a>
<a name="3210"><span class="lineNum">    3210 </span>            :                 const char *p, *r;</a>
<a name="3211"><span class="lineNum">    3211 </span>            :                 char *e;</a>
<a name="3212"><span class="lineNum">    3212 </span>            : </a>
<a name="3213"><span class="lineNum">    3213 </span><span class="lineCov">         78 :                 if (ZSTR_LEN(needle) == str_len) {</span></a>
<a name="3214"><span class="lineNum">    3214 </span><span class="lineCov">          6 :                         lc_needle = php_string_tolower(needle);</span></a>
<a name="3215"><span class="lineNum">    3215 </span><span class="lineCov">          6 :                         end = lc_haystack + ZSTR_LEN(haystack);</span></a>
<a name="3216"><span class="lineNum">    3216 </span><span class="lineCov">         96 :                         for (p = lc_haystack; (r = (char*)php_memnstr(p, ZSTR_VAL(lc_needle), ZSTR_LEN(lc_needle), end)); p = r + ZSTR_LEN(lc_needle)) {</span></a>
<a name="3217"><span class="lineNum">    3217 </span><span class="lineCov">         42 :                                 if (!new_str) {</span></a>
<a name="3218"><span class="lineNum">    3218 </span><span class="lineCov">         12 :                                         new_str = zend_string_init(ZSTR_VAL(haystack), ZSTR_LEN(haystack), 0);</span></a>
<a name="3219"><span class="lineNum">    3219 </span>            :                                 }</a>
<a name="3220"><span class="lineNum">    3220 </span><span class="lineCov">         42 :                                 memcpy(ZSTR_VAL(new_str) + (r - lc_haystack), str, str_len);</span></a>
<a name="3221"><span class="lineNum">    3221 </span><span class="lineCov">         42 :                                 (*replace_count)++;</span></a>
<a name="3222"><span class="lineNum">    3222 </span>            :                         }</a>
<a name="3223"><span class="lineNum">    3223 </span>            :                         zend_string_release_ex(lc_needle, 0);</a>
<a name="3224"><span class="lineNum">    3224 </span>            : </a>
<a name="3225"><span class="lineNum">    3225 </span><span class="lineCov">          6 :                         if (!new_str) {</span></a>
<a name="3226"><span class="lineNum">    3226 </span><span class="lineNoCov">          0 :                                 goto nothing_todo;</span></a>
<a name="3227"><span class="lineNum">    3227 </span>            :                         }</a>
<a name="3228"><span class="lineNum">    3228 </span><span class="lineCov">          6 :                         return new_str;</span></a>
<a name="3229"><span class="lineNum">    3229 </span>            :                 } else {</a>
<a name="3230"><span class="lineNum">    3230 </span><span class="lineCov">         72 :                         size_t count = 0;</span></a>
<a name="3231"><span class="lineNum">    3231 </span><span class="lineCov">         72 :                         const char *o = lc_haystack;</span></a>
<a name="3232"><span class="lineNum">    3232 </span>            :                         const char *n;</a>
<a name="3233"><span class="lineNum">    3233 </span><span class="lineCov">         72 :                         const char *endp = o + ZSTR_LEN(haystack);</span></a>
<a name="3234"><span class="lineNum">    3234 </span>            : </a>
<a name="3235"><span class="lineNum">    3235 </span><span class="lineCov">         72 :                         lc_needle = php_string_tolower(needle);</span></a>
<a name="3236"><span class="lineNum">    3236 </span><span class="lineCov">         72 :                         n = ZSTR_VAL(lc_needle);</span></a>
<a name="3237"><span class="lineNum">    3237 </span>            : </a>
<a name="3238"><span class="lineNum">    3238 </span><span class="lineCov">        780 :                         while ((o = (char*)php_memnstr(o, n, ZSTR_LEN(lc_needle), endp))) {</span></a>
<a name="3239"><span class="lineNum">    3239 </span><span class="lineCov">        318 :                                 o += ZSTR_LEN(lc_needle);</span></a>
<a name="3240"><span class="lineNum">    3240 </span><span class="lineCov">        318 :                                 count++;</span></a>
<a name="3241"><span class="lineNum">    3241 </span>            :                         }</a>
<a name="3242"><span class="lineNum">    3242 </span><span class="lineCov">         72 :                         if (count == 0) {</span></a>
<a name="3243"><span class="lineNum">    3243 </span>            :                                 /* Needle doesn't occur, shortcircuit the actual replacement. */</a>
<a name="3244"><span class="lineNum">    3244 </span>            :                                 zend_string_release_ex(lc_needle, 0);</a>
<a name="3245"><span class="lineNum">    3245 </span><span class="lineCov">         24 :                                 goto nothing_todo;</span></a>
<a name="3246"><span class="lineNum">    3246 </span>            :                         }</a>
<a name="3247"><span class="lineNum">    3247 </span>            : </a>
<a name="3248"><span class="lineNum">    3248 </span><span class="lineCov">         48 :                         if (str_len &gt; ZSTR_LEN(lc_needle)) {</span></a>
<a name="3249"><span class="lineNum">    3249 </span><span class="lineCov">         78 :                                 new_str = zend_string_safe_alloc(count, str_len - ZSTR_LEN(lc_needle), ZSTR_LEN(haystack), 0);</span></a>
<a name="3250"><span class="lineNum">    3250 </span>            :                         } else {</a>
<a name="3251"><span class="lineNum">    3251 </span><span class="lineCov">         18 :                                 new_str = zend_string_alloc(count * (str_len - ZSTR_LEN(lc_needle)) + ZSTR_LEN(haystack), 0);</span></a>
<a name="3252"><span class="lineNum">    3252 </span>            :                         }</a>
<a name="3253"><span class="lineNum">    3253 </span>            : </a>
<a name="3254"><span class="lineNum">    3254 </span><span class="lineCov">         48 :                         e = ZSTR_VAL(new_str);</span></a>
<a name="3255"><span class="lineNum">    3255 </span><span class="lineCov">         48 :                         end = lc_haystack + ZSTR_LEN(haystack);</span></a>
<a name="3256"><span class="lineNum">    3256 </span>            : </a>
<a name="3257"><span class="lineNum">    3257 </span><span class="lineCov">        732 :                         for (p = lc_haystack; (r = (char*)php_memnstr(p, ZSTR_VAL(lc_needle), ZSTR_LEN(lc_needle), end)); p = r + ZSTR_LEN(lc_needle)) {</span></a>
<a name="3258"><span class="lineNum">    3258 </span><span class="lineCov">        318 :                                 memcpy(e, ZSTR_VAL(haystack) + (p - lc_haystack), r - p);</span></a>
<a name="3259"><span class="lineNum">    3259 </span><span class="lineCov">        318 :                                 e += r - p;</span></a>
<a name="3260"><span class="lineNum">    3260 </span><span class="lineCov">        318 :                                 memcpy(e, str, str_len);</span></a>
<a name="3261"><span class="lineNum">    3261 </span><span class="lineCov">        318 :                                 e += str_len;</span></a>
<a name="3262"><span class="lineNum">    3262 </span><span class="lineCov">        318 :                                 (*replace_count)++;</span></a>
<a name="3263"><span class="lineNum">    3263 </span>            :                         }</a>
<a name="3264"><span class="lineNum">    3264 </span>            : </a>
<a name="3265"><span class="lineNum">    3265 </span><span class="lineCov">         48 :                         if (p &lt; end) {</span></a>
<a name="3266"><span class="lineNum">    3266 </span><span class="lineCov">         48 :                                 memcpy(e, ZSTR_VAL(haystack) + (p - lc_haystack), end - p);</span></a>
<a name="3267"><span class="lineNum">    3267 </span><span class="lineCov">         48 :                                 e += end - p;</span></a>
<a name="3268"><span class="lineNum">    3268 </span>            :                         }</a>
<a name="3269"><span class="lineNum">    3269 </span><span class="lineCov">         48 :                         *e = '\0';</span></a>
<a name="3270"><span class="lineNum">    3270 </span>            : </a>
<a name="3271"><span class="lineNum">    3271 </span>            :                         zend_string_release_ex(lc_needle, 0);</a>
<a name="3272"><span class="lineNum">    3272 </span>            : </a>
<a name="3273"><span class="lineNum">    3273 </span><span class="lineCov">         48 :                         return new_str;</span></a>
<a name="3274"><span class="lineNum">    3274 </span>            :                 }</a>
<a name="3275"><span class="lineNum">    3275 </span><span class="lineCov">          6 :         } else if (ZSTR_LEN(needle) &gt; ZSTR_LEN(haystack)) {</span></a>
<a name="3276"><span class="lineNum">    3276 </span><span class="lineCov">         27 : nothing_todo:</span></a>
<a name="3277"><span class="lineNum">    3277 </span><span class="lineCov">         27 :                 return zend_string_copy(haystack);</span></a>
<a name="3278"><span class="lineNum">    3278 </span>            :         } else {</a>
<a name="3279"><span class="lineNum">    3279 </span><span class="lineCov">          6 :                 lc_needle = php_string_tolower(needle);</span></a>
<a name="3280"><span class="lineNum">    3280 </span>            : </a>
<a name="3281"><span class="lineNum">    3281 </span><span class="lineCov">          6 :                 if (memcmp(lc_haystack, ZSTR_VAL(lc_needle), ZSTR_LEN(lc_needle))) {</span></a>
<a name="3282"><span class="lineNum">    3282 </span>            :                         zend_string_release_ex(lc_needle, 0);</a>
<a name="3283"><span class="lineNum">    3283 </span><span class="lineCov">          3 :                         goto nothing_todo;</span></a>
<a name="3284"><span class="lineNum">    3284 </span>            :                 }</a>
<a name="3285"><span class="lineNum">    3285 </span>            :                 zend_string_release_ex(lc_needle, 0);</a>
<a name="3286"><span class="lineNum">    3286 </span>            : </a>
<a name="3287"><span class="lineNum">    3287 </span><span class="lineCov">          3 :                 new_str = zend_string_init(str, str_len, 0);</span></a>
<a name="3288"><span class="lineNum">    3288 </span>            : </a>
<a name="3289"><span class="lineNum">    3289 </span><span class="lineCov">          3 :                 (*replace_count)++;</span></a>
<a name="3290"><span class="lineNum">    3290 </span><span class="lineCov">          3 :                 return new_str;</span></a>
<a name="3291"><span class="lineNum">    3291 </span>            :         }</a>
<a name="3292"><span class="lineNum">    3292 </span>            : }</a>
<a name="3293"><span class="lineNum">    3293 </span>            : /* }}} */</a>
<a name="3294"><span class="lineNum">    3294 </span>            : </a>
<a name="3295"><span class="lineNum">    3295 </span>            : /* {{{ php_str_to_str */</a>
<a name="3296"><span class="lineNum">    3296 </span><span class="lineCov">      16138 : PHPAPI zend_string *php_str_to_str(const char *haystack, size_t length, const char *needle, size_t needle_len, const char *str, size_t str_len)</span></a>
<a name="3297"><span class="lineNum">    3297 </span>            : {</a>
<a name="3298"><span class="lineNum">    3298 </span>            :         zend_string *new_str;</a>
<a name="3299"><span class="lineNum">    3299 </span>            : </a>
<a name="3300"><span class="lineNum">    3300 </span><span class="lineCov">      16138 :         if (needle_len &lt; length) {</span></a>
<a name="3301"><span class="lineNum">    3301 </span>            :                 const char *end;</a>
<a name="3302"><span class="lineNum">    3302 </span>            :                 const char *s, *p;</a>
<a name="3303"><span class="lineNum">    3303 </span>            :                 char *e, *r;</a>
<a name="3304"><span class="lineNum">    3304 </span>            : </a>
<a name="3305"><span class="lineNum">    3305 </span><span class="lineCov">       1471 :                 if (needle_len == str_len) {</span></a>
<a name="3306"><span class="lineNum">    3306 </span><span class="lineNoCov">          0 :                         new_str = zend_string_init(haystack, length, 0);</span></a>
<a name="3307"><span class="lineNum">    3307 </span><span class="lineNoCov">          0 :                         end = ZSTR_VAL(new_str) + length;</span></a>
<a name="3308"><span class="lineNum">    3308 </span><span class="lineNoCov">          0 :                         for (p = ZSTR_VAL(new_str); (r = (char*)php_memnstr(p, needle, needle_len, end)); p = r + needle_len) {</span></a>
<a name="3309"><span class="lineNum">    3309 </span><span class="lineNoCov">          0 :                                 memcpy(r, str, str_len);</span></a>
<a name="3310"><span class="lineNum">    3310 </span>            :                         }</a>
<a name="3311"><span class="lineNum">    3311 </span><span class="lineNoCov">          0 :                         return new_str;</span></a>
<a name="3312"><span class="lineNum">    3312 </span>            :                 } else {</a>
<a name="3313"><span class="lineNum">    3313 </span><span class="lineCov">       1471 :                         if (str_len &lt; needle_len) {</span></a>
<a name="3314"><span class="lineNum">    3314 </span><span class="lineNoCov">          0 :                                 new_str = zend_string_alloc(length, 0);</span></a>
<a name="3315"><span class="lineNum">    3315 </span>            :                         } else {</a>
<a name="3316"><span class="lineNum">    3316 </span><span class="lineCov">       1471 :                                 size_t count = 0;</span></a>
<a name="3317"><span class="lineNum">    3317 </span><span class="lineCov">       1471 :                                 const char *o = haystack;</span></a>
<a name="3318"><span class="lineNum">    3318 </span><span class="lineCov">       1471 :                                 const char *n = needle;</span></a>
<a name="3319"><span class="lineNum">    3319 </span><span class="lineCov">       1471 :                                 const char *endp = o + length;</span></a>
<a name="3320"><span class="lineNum">    3320 </span>            : </a>
<a name="3321"><span class="lineNum">    3321 </span><span class="lineCov">       3023 :                                 while ((o = (char*)php_memnstr(o, n, needle_len, endp))) {</span></a>
<a name="3322"><span class="lineNum">    3322 </span><span class="lineCov">         81 :                                         o += needle_len;</span></a>
<a name="3323"><span class="lineNum">    3323 </span><span class="lineCov">         81 :                                         count++;</span></a>
<a name="3324"><span class="lineNum">    3324 </span>            :                                 }</a>
<a name="3325"><span class="lineNum">    3325 </span><span class="lineCov">       1471 :                                 if (count == 0) {</span></a>
<a name="3326"><span class="lineNum">    3326 </span>            :                                         /* Needle doesn't occur, shortcircuit the actual replacement. */</a>
<a name="3327"><span class="lineNum">    3327 </span><span class="lineCov">       1426 :                                         new_str = zend_string_init(haystack, length, 0);</span></a>
<a name="3328"><span class="lineNum">    3328 </span><span class="lineCov">       1426 :                                         return new_str;</span></a>
<a name="3329"><span class="lineNum">    3329 </span>            :                                 } else {</a>
<a name="3330"><span class="lineNum">    3330 </span><span class="lineCov">         45 :                                         if (str_len &gt; needle_len) {</span></a>
<a name="3331"><span class="lineNum">    3331 </span><span class="lineCov">         90 :                                                 new_str = zend_string_safe_alloc(count, str_len - needle_len, length, 0);</span></a>
<a name="3332"><span class="lineNum">    3332 </span>            :                                         } else {</a>
<a name="3333"><span class="lineNum">    3333 </span><span class="lineNoCov">          0 :                                                 new_str = zend_string_alloc(count * (str_len - needle_len) + length, 0);</span></a>
<a name="3334"><span class="lineNum">    3334 </span>            :                                         }</a>
<a name="3335"><span class="lineNum">    3335 </span>            :                                 }</a>
<a name="3336"><span class="lineNum">    3336 </span>            :                         }</a>
<a name="3337"><span class="lineNum">    3337 </span>            : </a>
<a name="3338"><span class="lineNum">    3338 </span><span class="lineCov">         45 :                         s = e = ZSTR_VAL(new_str);</span></a>
<a name="3339"><span class="lineNum">    3339 </span><span class="lineCov">         45 :                         end = haystack + length;</span></a>
<a name="3340"><span class="lineNum">    3340 </span><span class="lineCov">        171 :                         for (p = haystack; (r = (char*)php_memnstr(p, needle, needle_len, end)); p = r + needle_len) {</span></a>
<a name="3341"><span class="lineNum">    3341 </span><span class="lineCov">         81 :                                 memcpy(e, p, r - p);</span></a>
<a name="3342"><span class="lineNum">    3342 </span><span class="lineCov">         81 :                                 e += r - p;</span></a>
<a name="3343"><span class="lineNum">    3343 </span><span class="lineCov">         81 :                                 memcpy(e, str, str_len);</span></a>
<a name="3344"><span class="lineNum">    3344 </span><span class="lineCov">         81 :                                 e += str_len;</span></a>
<a name="3345"><span class="lineNum">    3345 </span>            :                         }</a>
<a name="3346"><span class="lineNum">    3346 </span>            : </a>
<a name="3347"><span class="lineNum">    3347 </span><span class="lineCov">         45 :                         if (p &lt; end) {</span></a>
<a name="3348"><span class="lineNum">    3348 </span><span class="lineCov">         36 :                                 memcpy(e, p, end - p);</span></a>
<a name="3349"><span class="lineNum">    3349 </span><span class="lineCov">         36 :                                 e += end - p;</span></a>
<a name="3350"><span class="lineNum">    3350 </span>            :                         }</a>
<a name="3351"><span class="lineNum">    3351 </span>            : </a>
<a name="3352"><span class="lineNum">    3352 </span><span class="lineCov">         45 :                         *e = '\0';</span></a>
<a name="3353"><span class="lineNum">    3353 </span><span class="lineCov">         45 :                         new_str = zend_string_truncate(new_str, e - s, 0);</span></a>
<a name="3354"><span class="lineNum">    3354 </span><span class="lineCov">         45 :                         return new_str;</span></a>
<a name="3355"><span class="lineNum">    3355 </span>            :                 }</a>
<a name="3356"><span class="lineNum">    3356 </span><span class="lineCov">      14667 :         } else if (needle_len &gt; length || memcmp(haystack, needle, length)) {</span></a>
<a name="3357"><span class="lineNum">    3357 </span><span class="lineCov">      14652 :                 new_str = zend_string_init(haystack, length, 0);</span></a>
<a name="3358"><span class="lineNum">    3358 </span><span class="lineCov">      14652 :                 return new_str;</span></a>
<a name="3359"><span class="lineNum">    3359 </span>            :         } else {</a>
<a name="3360"><span class="lineNum">    3360 </span><span class="lineCov">         15 :                 new_str = zend_string_init(str, str_len, 0);</span></a>
<a name="3361"><span class="lineNum">    3361 </span>            : </a>
<a name="3362"><span class="lineNum">    3362 </span><span class="lineCov">         15 :                 return new_str;</span></a>
<a name="3363"><span class="lineNum">    3363 </span>            :         }</a>
<a name="3364"><span class="lineNum">    3364 </span>            : }</a>
<a name="3365"><span class="lineNum">    3365 </span>            : /* }}} */</a>
<a name="3366"><span class="lineNum">    3366 </span>            : </a>
<a name="3367"><span class="lineNum">    3367 </span>            : /* {{{ Translates characters in str using given translation tables */</a>
<a name="3368"><span class="lineNum">    3368 </span><span class="lineCov">     192264 : PHP_FUNCTION(strtr)</span></a>
<a name="3369"><span class="lineNum">    3369 </span>            : {</a>
<a name="3370"><span class="lineNum">    3370 </span><span class="lineCov">     192264 :         zend_string *str, *from_str = NULL;</span></a>
<a name="3371"><span class="lineNum">    3371 </span><span class="lineCov">     192264 :         HashTable *from_ht = NULL;</span></a>
<a name="3372"><span class="lineNum">    3372 </span><span class="lineCov">     192264 :         char *to = NULL;</span></a>
<a name="3373"><span class="lineNum">    3373 </span><span class="lineCov">     192264 :         size_t to_len = 0;</span></a>
<a name="3374"><span class="lineNum">    3374 </span>            : </a>
<a name="3375"><span class="lineNum">    3375 </span><span class="lineCov">     192264 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="3376"><span class="lineNum">    3376 </span><span class="lineCov">     384444 :                 Z_PARAM_STR(str)</span></a>
<a name="3377"><span class="lineNum">    3377 </span><span class="lineCov">     384432 :                 Z_PARAM_ARRAY_HT_OR_STR(from_ht, from_str)</span></a>
<a name="3378"><span class="lineNum">    3378 </span><span class="lineCov">     192210 :                 Z_PARAM_OPTIONAL</span></a>
<a name="3379"><span class="lineNum">    3379 </span><span class="lineCov">     192387 :                 Z_PARAM_STRING_OR_NULL(to, to_len)</span></a>
<a name="3380"><span class="lineNum">    3380 </span><span class="lineCov">     199869 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="3381"><span class="lineNum">    3381 </span>            : </a>
<a name="3382"><span class="lineNum">    3382 </span><span class="lineCov">     192210 :         if (!to &amp;&amp; from_ht == NULL) {</span></a>
<a name="3383"><span class="lineNum">    3383 </span><span class="lineCov">         45 :                 zend_argument_type_error(2, &quot;must be of type array, string given&quot;);</span></a>
<a name="3384"><span class="lineNum">    3384 </span><span class="lineCov">         45 :                 RETURN_THROWS();</span></a>
<a name="3385"><span class="lineNum">    3385 </span><span class="lineCov">     192165 :         } else if (to &amp;&amp; from_str == NULL) {</span></a>
<a name="3386"><span class="lineNum">    3386 </span><span class="lineCov">          9 :                 zend_argument_type_error(2, &quot;must be of type string, array given&quot;);</span></a>
<a name="3387"><span class="lineNum">    3387 </span><span class="lineCov">          9 :                 RETURN_THROWS();</span></a>
<a name="3388"><span class="lineNum">    3388 </span>            :         }</a>
<a name="3389"><span class="lineNum">    3389 </span>            : </a>
<a name="3390"><span class="lineNum">    3390 </span>            :         /* shortcut for empty string */</a>
<a name="3391"><span class="lineNum">    3391 </span><span class="lineCov">     192156 :         if (ZSTR_LEN(str) == 0) {</span></a>
<a name="3392"><span class="lineNum">    3392 </span><span class="lineCov">       7377 :                 RETURN_EMPTY_STRING();</span></a>
<a name="3393"><span class="lineNum">    3393 </span>            :         }</a>
<a name="3394"><span class="lineNum">    3394 </span>            : </a>
<a name="3395"><span class="lineNum">    3395 </span><span class="lineCov">     184779 :         if (!to) {</span></a>
<a name="3396"><span class="lineNum">    3396 </span><span class="lineCov">     184629 :                 if (zend_hash_num_elements(from_ht) &lt; 1) {</span></a>
<a name="3397"><span class="lineNum">    3397 </span><span class="lineCov">         12 :                         RETURN_STR_COPY(str);</span></a>
<a name="3398"><span class="lineNum">    3398 </span><span class="lineCov">     184623 :                 } else if (zend_hash_num_elements(from_ht) == 1) {</span></a>
<a name="3399"><span class="lineNum">    3399 </span>            :                         zend_long num_key;</a>
<a name="3400"><span class="lineNum">    3400 </span>            :                         zend_string *str_key, *tmp_str, *replace, *tmp_replace;</a>
<a name="3401"><span class="lineNum">    3401 </span>            :                         zval *entry;</a>
<a name="3402"><span class="lineNum">    3402 </span>            : </a>
<a name="3403"><span class="lineNum">    3403 </span><span class="lineCov">         36 :                         ZEND_HASH_FOREACH_KEY_VAL(from_ht, num_key, str_key, entry) {</span></a>
<a name="3404"><span class="lineNum">    3404 </span><span class="lineCov">         18 :                                 tmp_str = NULL;</span></a>
<a name="3405"><span class="lineNum">    3405 </span><span class="lineCov">         18 :                                 if (UNEXPECTED(!str_key)) {</span></a>
<a name="3406"><span class="lineNum">    3406 </span><span class="lineCov">          6 :                                         str_key = tmp_str = zend_long_to_str(num_key);</span></a>
<a name="3407"><span class="lineNum">    3407 </span>            :                                 }</a>
<a name="3408"><span class="lineNum">    3408 </span><span class="lineCov">         18 :                                 replace = zval_get_tmp_string(entry, &amp;tmp_replace);</span></a>
<a name="3409"><span class="lineNum">    3409 </span><span class="lineCov">         18 :                                 if (ZSTR_LEN(str_key) &lt; 1) {</span></a>
<a name="3410"><span class="lineNum">    3410 </span><span class="lineCov">          3 :                                         php_error_docref(NULL, E_WARNING, &quot;Ignoring replacement of empty string&quot;);</span></a>
<a name="3411"><span class="lineNum">    3411 </span><span class="lineCov">          6 :                                         RETVAL_STR_COPY(str);</span></a>
<a name="3412"><span class="lineNum">    3412 </span><span class="lineCov">         15 :                                 } else if (ZSTR_LEN(str_key) == 1) {</span></a>
<a name="3413"><span class="lineNum">    3413 </span><span class="lineCov">         18 :                                         RETVAL_STR(php_char_to_str_ex(str,</span></a>
<a name="3414"><span class="lineNum">    3414 </span>            :                                                                 ZSTR_VAL(str_key)[0],</a>
<a name="3415"><span class="lineNum">    3415 </span>            :                                                                 ZSTR_VAL(replace),</a>
<a name="3416"><span class="lineNum">    3416 </span>            :                                                                 ZSTR_LEN(replace),</a>
<a name="3417"><span class="lineNum">    3417 </span>            :                                                                 1,</a>
<a name="3418"><span class="lineNum">    3418 </span>            :                                                                 NULL));</a>
<a name="3419"><span class="lineNum">    3419 </span>            :                                 } else {</a>
<a name="3420"><span class="lineNum">    3420 </span>            :                                         zend_long dummy;</a>
<a name="3421"><span class="lineNum">    3421 </span><span class="lineCov">         12 :                                         RETVAL_STR(php_str_to_str_ex(str,</span></a>
<a name="3422"><span class="lineNum">    3422 </span>            :                                                                 ZSTR_VAL(str_key), ZSTR_LEN(str_key),</a>
<a name="3423"><span class="lineNum">    3423 </span>            :                                                                 ZSTR_VAL(replace), ZSTR_LEN(replace), &amp;dummy));</a>
<a name="3424"><span class="lineNum">    3424 </span>            :                                 }</a>
<a name="3425"><span class="lineNum">    3425 </span>            :                                 zend_tmp_string_release(tmp_str);</a>
<a name="3426"><span class="lineNum">    3426 </span><span class="lineCov">         18 :                                 zend_tmp_string_release(tmp_replace);</span></a>
<a name="3427"><span class="lineNum">    3427 </span><span class="lineCov">         18 :                                 return;</span></a>
<a name="3428"><span class="lineNum">    3428 </span>            :                         } ZEND_HASH_FOREACH_END();</a>
<a name="3429"><span class="lineNum">    3429 </span>            :                 } else {</a>
<a name="3430"><span class="lineNum">    3430 </span><span class="lineCov">     184605 :                         php_strtr_array(return_value, str, from_ht);</span></a>
<a name="3431"><span class="lineNum">    3431 </span>            :                 }</a>
<a name="3432"><span class="lineNum">    3432 </span>            :         } else {</a>
<a name="3433"><span class="lineNum">    3433 </span><span class="lineCov">        300 :                 RETURN_STR(php_strtr_ex(str,</span></a>
<a name="3434"><span class="lineNum">    3434 </span>            :                                   ZSTR_VAL(from_str),</a>
<a name="3435"><span class="lineNum">    3435 </span>            :                                   to,</a>
<a name="3436"><span class="lineNum">    3436 </span>            :                                   MIN(ZSTR_LEN(from_str), to_len)));</a>
<a name="3437"><span class="lineNum">    3437 </span>            :         }</a>
<a name="3438"><span class="lineNum">    3438 </span>            : }</a>
<a name="3439"><span class="lineNum">    3439 </span>            : /* }}} */</a>
<a name="3440"><span class="lineNum">    3440 </span>            : </a>
<a name="3441"><span class="lineNum">    3441 </span>            : /* {{{ Reverse a string */</a>
<a name="3442"><span class="lineNum">    3442 </span>            : #if ZEND_INTRIN_SSSE3_NATIVE</a>
<a name="3443"><span class="lineNum">    3443 </span>            : #include &lt;tmmintrin.h&gt;</a>
<a name="3444"><span class="lineNum">    3444 </span>            : #elif defined(__aarch64__)</a>
<a name="3445"><span class="lineNum">    3445 </span>            : #include &lt;arm_neon.h&gt;</a>
<a name="3446"><span class="lineNum">    3446 </span>            : #endif</a>
<a name="3447"><span class="lineNum">    3447 </span><span class="lineCov">        291 : PHP_FUNCTION(strrev)</span></a>
<a name="3448"><span class="lineNum">    3448 </span>            : {</a>
<a name="3449"><span class="lineNum">    3449 </span>            :         zend_string *str;</a>
<a name="3450"><span class="lineNum">    3450 </span>            :         const char *s, *e;</a>
<a name="3451"><span class="lineNum">    3451 </span>            :         char *p;</a>
<a name="3452"><span class="lineNum">    3452 </span>            :         zend_string *n;</a>
<a name="3453"><span class="lineNum">    3453 </span>            : </a>
<a name="3454"><span class="lineNum">    3454 </span><span class="lineCov">        291 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="3455"><span class="lineNum">    3455 </span><span class="lineCov">        486 :                 Z_PARAM_STR(str)</span></a>
<a name="3456"><span class="lineNum">    3456 </span><span class="lineCov">        291 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="3457"><span class="lineNum">    3457 </span>            : </a>
<a name="3458"><span class="lineNum">    3458 </span><span class="lineCov">        240 :         n = zend_string_alloc(ZSTR_LEN(str), 0);</span></a>
<a name="3459"><span class="lineNum">    3459 </span><span class="lineCov">        240 :         p = ZSTR_VAL(n);</span></a>
<a name="3460"><span class="lineNum">    3460 </span>            : </a>
<a name="3461"><span class="lineNum">    3461 </span><span class="lineCov">        240 :         s = ZSTR_VAL(str);</span></a>
<a name="3462"><span class="lineNum">    3462 </span><span class="lineCov">        240 :         e = s + ZSTR_LEN(str);</span></a>
<a name="3463"><span class="lineNum">    3463 </span><span class="lineCov">        240 :         --e;</span></a>
<a name="3464"><span class="lineNum">    3464 </span>            : #if ZEND_INTRIN_SSSE3_NATIVE</a>
<a name="3465"><span class="lineNum">    3465 </span>            :         if (e - s &gt; 15) {</a>
<a name="3466"><span class="lineNum">    3466 </span>            :                 const __m128i map = _mm_set_epi8(</a>
<a name="3467"><span class="lineNum">    3467 </span>            :                                 0, 1, 2, 3,</a>
<a name="3468"><span class="lineNum">    3468 </span>            :                                 4, 5, 6, 7,</a>
<a name="3469"><span class="lineNum">    3469 </span>            :                                 8, 9, 10, 11,</a>
<a name="3470"><span class="lineNum">    3470 </span>            :                                 12, 13, 14, 15);</a>
<a name="3471"><span class="lineNum">    3471 </span>            :                 do {</a>
<a name="3472"><span class="lineNum">    3472 </span>            :                         const __m128i str = _mm_loadu_si128((__m128i *)(e - 15));</a>
<a name="3473"><span class="lineNum">    3473 </span>            :                         _mm_storeu_si128((__m128i *)p, _mm_shuffle_epi8(str, map));</a>
<a name="3474"><span class="lineNum">    3474 </span>            :                         p += 16;</a>
<a name="3475"><span class="lineNum">    3475 </span>            :                         e -= 16;</a>
<a name="3476"><span class="lineNum">    3476 </span>            :                 } while (e - s &gt; 15);</a>
<a name="3477"><span class="lineNum">    3477 </span>            :         }</a>
<a name="3478"><span class="lineNum">    3478 </span>            : #elif defined(__aarch64__)</a>
<a name="3479"><span class="lineNum">    3479 </span>            :         if (e - s &gt; 15) {</a>
<a name="3480"><span class="lineNum">    3480 </span>            :                 do {</a>
<a name="3481"><span class="lineNum">    3481 </span>            :                         const uint8x16_t str = vld1q_u8((uint8_t *)(e - 15));</a>
<a name="3482"><span class="lineNum">    3482 </span>            :                         /* Synthesize rev128 with a rev64 + ext. */</a>
<a name="3483"><span class="lineNum">    3483 </span>            :                         const uint8x16_t rev = vrev64q_u8(str);</a>
<a name="3484"><span class="lineNum">    3484 </span>            :                         const uint8x16_t ext = (uint8x16_t)</a>
<a name="3485"><span class="lineNum">    3485 </span>            :                                 vextq_u64((uint64x2_t)rev, (uint64x2_t)rev, 1);</a>
<a name="3486"><span class="lineNum">    3486 </span>            :                         vst1q_u8((uint8_t *)p, ext);</a>
<a name="3487"><span class="lineNum">    3487 </span>            :                         p += 16;</a>
<a name="3488"><span class="lineNum">    3488 </span>            :                         e -= 16;</a>
<a name="3489"><span class="lineNum">    3489 </span>            :                 } while (e - s &gt; 15);</a>
<a name="3490"><span class="lineNum">    3490 </span>            :         }</a>
<a name="3491"><span class="lineNum">    3491 </span>            : #endif</a>
<a name="3492"><span class="lineNum">    3492 </span><span class="lineCov">       4989 :         while (e &gt;= s) {</span></a>
<a name="3493"><span class="lineNum">    3493 </span><span class="lineCov">       4749 :                 *p++ = *e--;</span></a>
<a name="3494"><span class="lineNum">    3494 </span>            :         }</a>
<a name="3495"><span class="lineNum">    3495 </span>            : </a>
<a name="3496"><span class="lineNum">    3496 </span><span class="lineCov">        240 :         *p = '\0';</span></a>
<a name="3497"><span class="lineNum">    3497 </span>            : </a>
<a name="3498"><span class="lineNum">    3498 </span><span class="lineCov">        240 :         RETVAL_NEW_STR(n);</span></a>
<a name="3499"><span class="lineNum">    3499 </span>            : }</a>
<a name="3500"><span class="lineNum">    3500 </span>            : /* }}} */</a>
<a name="3501"><span class="lineNum">    3501 </span>            : </a>
<a name="3502"><span class="lineNum">    3502 </span>            : /* {{{ php_similar_str */</a>
<a name="3503"><span class="lineNum">    3503 </span><span class="lineCov">         30 : static void php_similar_str(const char *txt1, size_t len1, const char *txt2, size_t len2, size_t *pos1, size_t *pos2, size_t *max, size_t *count)</span></a>
<a name="3504"><span class="lineNum">    3504 </span>            : {</a>
<a name="3505"><span class="lineNum">    3505 </span>            :         const char *p, *q;</a>
<a name="3506"><span class="lineNum">    3506 </span><span class="lineCov">         30 :         const char *end1 = (char *) txt1 + len1;</span></a>
<a name="3507"><span class="lineNum">    3507 </span><span class="lineCov">         30 :         const char *end2 = (char *) txt2 + len2;</span></a>
<a name="3508"><span class="lineNum">    3508 </span>            :         size_t l;</a>
<a name="3509"><span class="lineNum">    3509 </span>            : </a>
<a name="3510"><span class="lineNum">    3510 </span><span class="lineCov">         30 :         *max = 0;</span></a>
<a name="3511"><span class="lineNum">    3511 </span><span class="lineCov">         30 :         *count = 0;</span></a>
<a name="3512"><span class="lineNum">    3512 </span><span class="lineCov">        312 :         for (p = (char *) txt1; p &lt; end1; p++) {</span></a>
<a name="3513"><span class="lineNum">    3513 </span><span class="lineCov">       1806 :                 for (q = (char *) txt2; q &lt; end2; q++) {</span></a>
<a name="3514"><span class="lineNum">    3514 </span><span class="lineCov">       1884 :                         for (l = 0; (p + l &lt; end1) &amp;&amp; (q + l &lt; end2) &amp;&amp; (p[l] == q[l]); l++);</span></a>
<a name="3515"><span class="lineNum">    3515 </span><span class="lineCov">       1524 :                         if (l &gt; *max) {</span></a>
<a name="3516"><span class="lineNum">    3516 </span><span class="lineCov">         18 :                                 *max = l;</span></a>
<a name="3517"><span class="lineNum">    3517 </span><span class="lineCov">         18 :                                 *count += 1;</span></a>
<a name="3518"><span class="lineNum">    3518 </span><span class="lineCov">         18 :                                 *pos1 = p - txt1;</span></a>
<a name="3519"><span class="lineNum">    3519 </span><span class="lineCov">         18 :                                 *pos2 = q - txt2;</span></a>
<a name="3520"><span class="lineNum">    3520 </span>            :                         }</a>
<a name="3521"><span class="lineNum">    3521 </span>            :                 }</a>
<a name="3522"><span class="lineNum">    3522 </span>            :         }</a>
<a name="3523"><span class="lineNum">    3523 </span><span class="lineCov">         30 : }</span></a>
<a name="3524"><span class="lineNum">    3524 </span>            : /* }}} */</a>
<a name="3525"><span class="lineNum">    3525 </span>            : </a>
<a name="3526"><span class="lineNum">    3526 </span>            : /* {{{ php_similar_char */</a>
<a name="3527"><span class="lineNum">    3527 </span><span class="lineCov">         30 : static size_t php_similar_char(const char *txt1, size_t len1, const char *txt2, size_t len2)</span></a>
<a name="3528"><span class="lineNum">    3528 </span>            : {</a>
<a name="3529"><span class="lineNum">    3529 </span>            :         size_t sum;</a>
<a name="3530"><span class="lineNum">    3530 </span><span class="lineCov">         30 :         size_t pos1 = 0, pos2 = 0, max, count;</span></a>
<a name="3531"><span class="lineNum">    3531 </span>            : </a>
<a name="3532"><span class="lineNum">    3532 </span><span class="lineCov">         30 :         php_similar_str(txt1, len1, txt2, len2, &amp;pos1, &amp;pos2, &amp;max, &amp;count);</span></a>
<a name="3533"><span class="lineNum">    3533 </span><span class="lineCov">         30 :         if ((sum = max)) {</span></a>
<a name="3534"><span class="lineNum">    3534 </span><span class="lineCov">         18 :                 if (pos1 &amp;&amp; pos2 &amp;&amp; count &gt; 1) {</span></a>
<a name="3535"><span class="lineNum">    3535 </span><span class="lineNoCov">          0 :                         sum += php_similar_char(txt1, pos1,</span></a>
<a name="3536"><span class="lineNum">    3536 </span>            :                                                                         txt2, pos2);</a>
<a name="3537"><span class="lineNum">    3537 </span>            :                 }</a>
<a name="3538"><span class="lineNum">    3538 </span><span class="lineCov">         18 :                 if ((pos1 + max &lt; len1) &amp;&amp; (pos2 + max &lt; len2)) {</span></a>
<a name="3539"><span class="lineNum">    3539 </span><span class="lineCov">          6 :                         sum += php_similar_char(txt1 + pos1 + max, len1 - pos1 - max,</span></a>
<a name="3540"><span class="lineNum">    3540 </span><span class="lineCov">          6 :                                                                         txt2 + pos2 + max, len2 - pos2 - max);</span></a>
<a name="3541"><span class="lineNum">    3541 </span>            :                 }</a>
<a name="3542"><span class="lineNum">    3542 </span>            :         }</a>
<a name="3543"><span class="lineNum">    3543 </span>            : </a>
<a name="3544"><span class="lineNum">    3544 </span><span class="lineCov">         30 :         return sum;</span></a>
<a name="3545"><span class="lineNum">    3545 </span>            : }</a>
<a name="3546"><span class="lineNum">    3546 </span>            : /* }}} */</a>
<a name="3547"><span class="lineNum">    3547 </span>            : </a>
<a name="3548"><span class="lineNum">    3548 </span>            : /* {{{ Calculates the similarity between two strings */</a>
<a name="3549"><span class="lineNum">    3549 </span><span class="lineCov">         42 : PHP_FUNCTION(similar_text)</span></a>
<a name="3550"><span class="lineNum">    3550 </span>            : {</a>
<a name="3551"><span class="lineNum">    3551 </span>            :         zend_string *t1, *t2;</a>
<a name="3552"><span class="lineNum">    3552 </span><span class="lineCov">         42 :         zval *percent = NULL;</span></a>
<a name="3553"><span class="lineNum">    3553 </span><span class="lineCov">         42 :         int ac = ZEND_NUM_ARGS();</span></a>
<a name="3554"><span class="lineNum">    3554 </span>            :         size_t sim;</a>
<a name="3555"><span class="lineNum">    3555 </span>            : </a>
<a name="3556"><span class="lineNum">    3556 </span><span class="lineCov">         42 :         ZEND_PARSE_PARAMETERS_START(2, 3)</span></a>
<a name="3557"><span class="lineNum">    3557 </span><span class="lineCov">         60 :                 Z_PARAM_STR(t1)</span></a>
<a name="3558"><span class="lineNum">    3558 </span><span class="lineCov">         54 :                 Z_PARAM_STR(t2)</span></a>
<a name="3559"><span class="lineNum">    3559 </span><span class="lineCov">         27 :                 Z_PARAM_OPTIONAL</span></a>
<a name="3560"><span class="lineNum">    3560 </span><span class="lineCov">         27 :                 Z_PARAM_ZVAL(percent)</span></a>
<a name="3561"><span class="lineNum">    3561 </span><span class="lineCov">         42 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="3562"><span class="lineNum">    3562 </span>            : </a>
<a name="3563"><span class="lineNum">    3563 </span><span class="lineCov">         27 :         if (ZSTR_LEN(t1) + ZSTR_LEN(t2) == 0) {</span></a>
<a name="3564"><span class="lineNum">    3564 </span><span class="lineCov">          3 :                 if (ac &gt; 2) {</span></a>
<a name="3565"><span class="lineNum">    3565 </span><span class="lineNoCov">          0 :                         ZEND_TRY_ASSIGN_REF_DOUBLE(percent, 0);</span></a>
<a name="3566"><span class="lineNum">    3566 </span>            :                 }</a>
<a name="3567"><span class="lineNum">    3567 </span>            : </a>
<a name="3568"><span class="lineNum">    3568 </span><span class="lineCov">          3 :                 RETURN_LONG(0);</span></a>
<a name="3569"><span class="lineNum">    3569 </span>            :         }</a>
<a name="3570"><span class="lineNum">    3570 </span>            : </a>
<a name="3571"><span class="lineNum">    3571 </span><span class="lineCov">         24 :         sim = php_similar_char(ZSTR_VAL(t1), ZSTR_LEN(t1), ZSTR_VAL(t2), ZSTR_LEN(t2));</span></a>
<a name="3572"><span class="lineNum">    3572 </span>            : </a>
<a name="3573"><span class="lineNum">    3573 </span><span class="lineCov">         24 :         if (ac &gt; 2) {</span></a>
<a name="3574"><span class="lineNum">    3574 </span><span class="lineCov">         24 :                 ZEND_TRY_ASSIGN_REF_DOUBLE(percent, sim * 200.0 / (ZSTR_LEN(t1) + ZSTR_LEN(t2)));</span></a>
<a name="3575"><span class="lineNum">    3575 </span>            :         }</a>
<a name="3576"><span class="lineNum">    3576 </span>            : </a>
<a name="3577"><span class="lineNum">    3577 </span><span class="lineCov">         24 :         RETURN_LONG(sim);</span></a>
<a name="3578"><span class="lineNum">    3578 </span>            : }</a>
<a name="3579"><span class="lineNum">    3579 </span>            : /* }}} */</a>
<a name="3580"><span class="lineNum">    3580 </span>            : </a>
<a name="3581"><span class="lineNum">    3581 </span>            : /* {{{ Escapes all chars mentioned in charlist with backslash. It creates octal representations if asked to backslash characters with 8th bit set or with ASCII&lt;32 (except '\n', '\r', '\t' etc...) */</a>
<a name="3582"><span class="lineNum">    3582 </span><span class="lineCov">     173640 : PHP_FUNCTION(addcslashes)</span></a>
<a name="3583"><span class="lineNum">    3583 </span>            : {</a>
<a name="3584"><span class="lineNum">    3584 </span>            :         zend_string *str, *what;</a>
<a name="3585"><span class="lineNum">    3585 </span>            : </a>
<a name="3586"><span class="lineNum">    3586 </span><span class="lineCov">     173640 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="3587"><span class="lineNum">    3587 </span><span class="lineCov">     347184 :                 Z_PARAM_STR(str)</span></a>
<a name="3588"><span class="lineNum">    3588 </span><span class="lineCov">     347178 :                 Z_PARAM_STR(what)</span></a>
<a name="3589"><span class="lineNum">    3589 </span><span class="lineCov">     173640 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="3590"><span class="lineNum">    3590 </span>            : </a>
<a name="3591"><span class="lineNum">    3591 </span><span class="lineCov">     173586 :         if (ZSTR_LEN(str) == 0) {</span></a>
<a name="3592"><span class="lineNum">    3592 </span><span class="lineCov">         15 :                 RETURN_EMPTY_STRING();</span></a>
<a name="3593"><span class="lineNum">    3593 </span>            :         }</a>
<a name="3594"><span class="lineNum">    3594 </span>            : </a>
<a name="3595"><span class="lineNum">    3595 </span><span class="lineCov">     173571 :         if (ZSTR_LEN(what) == 0) {</span></a>
<a name="3596"><span class="lineNum">    3596 </span><span class="lineCov">         18 :                 RETURN_STR_COPY(str);</span></a>
<a name="3597"><span class="lineNum">    3597 </span>            :         }</a>
<a name="3598"><span class="lineNum">    3598 </span>            : </a>
<a name="3599"><span class="lineNum">    3599 </span><span class="lineCov">     347124 :         RETURN_STR(php_addcslashes_str(ZSTR_VAL(str), ZSTR_LEN(str), ZSTR_VAL(what), ZSTR_LEN(what)));</span></a>
<a name="3600"><span class="lineNum">    3600 </span>            : }</a>
<a name="3601"><span class="lineNum">    3601 </span>            : /* }}} */</a>
<a name="3602"><span class="lineNum">    3602 </span>            : </a>
<a name="3603"><span class="lineNum">    3603 </span>            : /* {{{ Escapes single quote, double quotes and backslash characters in a string with backslashes */</a>
<a name="3604"><span class="lineNum">    3604 </span><span class="lineCov">        336 : PHP_FUNCTION(addslashes)</span></a>
<a name="3605"><span class="lineNum">    3605 </span>            : {</a>
<a name="3606"><span class="lineNum">    3606 </span>            :         zend_string *str;</a>
<a name="3607"><span class="lineNum">    3607 </span>            : </a>
<a name="3608"><span class="lineNum">    3608 </span><span class="lineCov">        336 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="3609"><span class="lineNum">    3609 </span><span class="lineCov">        576 :                 Z_PARAM_STR(str)</span></a>
<a name="3610"><span class="lineNum">    3610 </span><span class="lineCov">        336 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="3611"><span class="lineNum">    3611 </span>            : </a>
<a name="3612"><span class="lineNum">    3612 </span><span class="lineCov">        285 :         if (ZSTR_LEN(str) == 0) {</span></a>
<a name="3613"><span class="lineNum">    3613 </span><span class="lineCov">         21 :                 RETURN_EMPTY_STRING();</span></a>
<a name="3614"><span class="lineNum">    3614 </span>            :         }</a>
<a name="3615"><span class="lineNum">    3615 </span>            : </a>
<a name="3616"><span class="lineNum">    3616 </span><span class="lineCov">        528 :         RETURN_STR(php_addslashes(str));</span></a>
<a name="3617"><span class="lineNum">    3617 </span>            : }</a>
<a name="3618"><span class="lineNum">    3618 </span>            : /* }}} */</a>
<a name="3619"><span class="lineNum">    3619 </span>            : </a>
<a name="3620"><span class="lineNum">    3620 </span>            : /* {{{ Strips backslashes from a string. Uses C-style conventions */</a>
<a name="3621"><span class="lineNum">    3621 </span><span class="lineCov">         93 : PHP_FUNCTION(stripcslashes)</span></a>
<a name="3622"><span class="lineNum">    3622 </span>            : {</a>
<a name="3623"><span class="lineNum">    3623 </span>            :         zend_string *str;</a>
<a name="3624"><span class="lineNum">    3624 </span>            : </a>
<a name="3625"><span class="lineNum">    3625 </span><span class="lineCov">         93 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="3626"><span class="lineNum">    3626 </span><span class="lineCov">         90 :                 Z_PARAM_STR(str)</span></a>
<a name="3627"><span class="lineNum">    3627 </span><span class="lineCov">         93 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="3628"><span class="lineNum">    3628 </span>            : </a>
<a name="3629"><span class="lineNum">    3629 </span><span class="lineCov">         42 :         ZVAL_STRINGL(return_value, ZSTR_VAL(str), ZSTR_LEN(str));</span></a>
<a name="3630"><span class="lineNum">    3630 </span><span class="lineCov">         42 :         php_stripcslashes(Z_STR_P(return_value));</span></a>
<a name="3631"><span class="lineNum">    3631 </span>            : }</a>
<a name="3632"><span class="lineNum">    3632 </span>            : /* }}} */</a>
<a name="3633"><span class="lineNum">    3633 </span>            : </a>
<a name="3634"><span class="lineNum">    3634 </span>            : /* {{{ Strips backslashes from a string */</a>
<a name="3635"><span class="lineNum">    3635 </span><span class="lineCov">        303 : PHP_FUNCTION(stripslashes)</span></a>
<a name="3636"><span class="lineNum">    3636 </span>            : {</a>
<a name="3637"><span class="lineNum">    3637 </span>            :         zend_string *str;</a>
<a name="3638"><span class="lineNum">    3638 </span>            : </a>
<a name="3639"><span class="lineNum">    3639 </span><span class="lineCov">        303 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="3640"><span class="lineNum">    3640 </span><span class="lineCov">        510 :                 Z_PARAM_STR(str)</span></a>
<a name="3641"><span class="lineNum">    3641 </span><span class="lineCov">        303 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="3642"><span class="lineNum">    3642 </span>            : </a>
<a name="3643"><span class="lineNum">    3643 </span><span class="lineCov">        252 :         ZVAL_STRINGL(return_value, ZSTR_VAL(str), ZSTR_LEN(str));</span></a>
<a name="3644"><span class="lineNum">    3644 </span><span class="lineCov">        252 :         php_stripslashes(Z_STR_P(return_value));</span></a>
<a name="3645"><span class="lineNum">    3645 </span>            : }</a>
<a name="3646"><span class="lineNum">    3646 </span>            : /* }}} */</a>
<a name="3647"><span class="lineNum">    3647 </span>            : </a>
<a name="3648"><span class="lineNum">    3648 </span>            : /* {{{ php_stripcslashes */</a>
<a name="3649"><span class="lineNum">    3649 </span><span class="lineCov">         42 : PHPAPI void php_stripcslashes(zend_string *str)</span></a>
<a name="3650"><span class="lineNum">    3650 </span>            : {</a>
<a name="3651"><span class="lineNum">    3651 </span>            :         const char *source, *end;</a>
<a name="3652"><span class="lineNum">    3652 </span>            :         char *target;</a>
<a name="3653"><span class="lineNum">    3653 </span><span class="lineCov">         42 :         size_t  nlen = ZSTR_LEN(str), i;</span></a>
<a name="3654"><span class="lineNum">    3654 </span>            :         char numtmp[4];</a>
<a name="3655"><span class="lineNum">    3655 </span>            : </a>
<a name="3656"><span class="lineNum">    3656 </span><span class="lineCov">        243 :         for (source = (char*)ZSTR_VAL(str), end = source + ZSTR_LEN(str), target = ZSTR_VAL(str); source &lt; end; source++) {</span></a>
<a name="3657"><span class="lineNum">    3657 </span><span class="lineCov">        201 :                 if (*source == '\\' &amp;&amp; source + 1 &lt; end) {</span></a>
<a name="3658"><span class="lineNum">    3658 </span><span class="lineCov">        123 :                         source++;</span></a>
<a name="3659"><span class="lineNum">    3659 </span><span class="lineCov">        123 :                         switch (*source) {</span></a>
<a name="3660"><span class="lineNum">    3660 </span><span class="lineCov">          6 :                                 case 'n':  *target++='\n'; nlen--; break;</span></a>
<a name="3661"><span class="lineNum">    3661 </span><span class="lineCov">          6 :                                 case 'r':  *target++='\r'; nlen--; break;</span></a>
<a name="3662"><span class="lineNum">    3662 </span><span class="lineCov">          3 :                                 case 'a':  *target++='\a'; nlen--; break;</span></a>
<a name="3663"><span class="lineNum">    3663 </span><span class="lineCov">          3 :                                 case 't':  *target++='\t'; nlen--; break;</span></a>
<a name="3664"><span class="lineNum">    3664 </span><span class="lineCov">          3 :                                 case 'v':  *target++='\v'; nlen--; break;</span></a>
<a name="3665"><span class="lineNum">    3665 </span><span class="lineCov">          3 :                                 case 'b':  *target++='\b'; nlen--; break;</span></a>
<a name="3666"><span class="lineNum">    3666 </span><span class="lineCov">          3 :                                 case 'f':  *target++='\f'; nlen--; break;</span></a>
<a name="3667"><span class="lineNum">    3667 </span><span class="lineCov">          3 :                                 case '\\': *target++='\\'; nlen--; break;</span></a>
<a name="3668"><span class="lineNum">    3668 </span><span class="lineCov">         33 :                                 case 'x':</span></a>
<a name="3669"><span class="lineNum">    3669 </span><span class="lineCov">         33 :                                         if (source+1 &lt; end &amp;&amp; isxdigit((int)(*(source+1)))) {</span></a>
<a name="3670"><span class="lineNum">    3670 </span><span class="lineCov">         33 :                                                 numtmp[0] = *++source;</span></a>
<a name="3671"><span class="lineNum">    3671 </span><span class="lineCov">         33 :                                                 if (source+1 &lt; end &amp;&amp; isxdigit((int)(*(source+1)))) {</span></a>
<a name="3672"><span class="lineNum">    3672 </span><span class="lineCov">         33 :                                                         numtmp[1] = *++source;</span></a>
<a name="3673"><span class="lineNum">    3673 </span><span class="lineCov">         33 :                                                         numtmp[2] = '\0';</span></a>
<a name="3674"><span class="lineNum">    3674 </span><span class="lineCov">         33 :                                                         nlen-=3;</span></a>
<a name="3675"><span class="lineNum">    3675 </span>            :                                                 } else {</a>
<a name="3676"><span class="lineNum">    3676 </span><span class="lineNoCov">          0 :                                                         numtmp[1] = '\0';</span></a>
<a name="3677"><span class="lineNum">    3677 </span><span class="lineNoCov">          0 :                                                         nlen-=2;</span></a>
<a name="3678"><span class="lineNum">    3678 </span>            :                                                 }</a>
<a name="3679"><span class="lineNum">    3679 </span><span class="lineCov">         33 :                                                 *target++=(char)strtol(numtmp, NULL, 16);</span></a>
<a name="3680"><span class="lineNum">    3680 </span><span class="lineCov">         33 :                                                 break;</span></a>
<a name="3681"><span class="lineNum">    3681 </span>            :                                         }</a>
<a name="3682"><span class="lineNum">    3682 </span>            :                                         ZEND_FALLTHROUGH;</a>
<a name="3683"><span class="lineNum">    3683 </span>            :                                 default:</a>
<a name="3684"><span class="lineNum">    3684 </span><span class="lineCov">         60 :                                         i=0;</span></a>
<a name="3685"><span class="lineNum">    3685 </span><span class="lineCov">        159 :                                         while (source &lt; end &amp;&amp; *source &gt;= '0' &amp;&amp; *source &lt;= '7' &amp;&amp; i&lt;3) {</span></a>
<a name="3686"><span class="lineNum">    3686 </span><span class="lineCov">         99 :                                                 numtmp[i++] = *source++;</span></a>
<a name="3687"><span class="lineNum">    3687 </span>            :                                         }</a>
<a name="3688"><span class="lineNum">    3688 </span><span class="lineCov">         60 :                                         if (i) {</span></a>
<a name="3689"><span class="lineNum">    3689 </span><span class="lineCov">         33 :                                                 numtmp[i]='\0';</span></a>
<a name="3690"><span class="lineNum">    3690 </span><span class="lineCov">         33 :                                                 *target++=(char)strtol(numtmp, NULL, 8);</span></a>
<a name="3691"><span class="lineNum">    3691 </span><span class="lineCov">         33 :                                                 nlen-=i;</span></a>
<a name="3692"><span class="lineNum">    3692 </span><span class="lineCov">         33 :                                                 source--;</span></a>
<a name="3693"><span class="lineNum">    3693 </span>            :                                         } else {</a>
<a name="3694"><span class="lineNum">    3694 </span><span class="lineCov">         27 :                                                 *target++=*source;</span></a>
<a name="3695"><span class="lineNum">    3695 </span><span class="lineCov">         27 :                                                 nlen--;</span></a>
<a name="3696"><span class="lineNum">    3696 </span>            :                                         }</a>
<a name="3697"><span class="lineNum">    3697 </span>            :                         }</a>
<a name="3698"><span class="lineNum">    3698 </span>            :                 } else {</a>
<a name="3699"><span class="lineNum">    3699 </span><span class="lineCov">         78 :                         *target++=*source;</span></a>
<a name="3700"><span class="lineNum">    3700 </span>            :                 }</a>
<a name="3701"><span class="lineNum">    3701 </span>            :         }</a>
<a name="3702"><span class="lineNum">    3702 </span>            : </a>
<a name="3703"><span class="lineNum">    3703 </span><span class="lineCov">         42 :         if (nlen != 0) {</span></a>
<a name="3704"><span class="lineNum">    3704 </span><span class="lineCov">         36 :                 *target='\0';</span></a>
<a name="3705"><span class="lineNum">    3705 </span>            :         }</a>
<a name="3706"><span class="lineNum">    3706 </span>            : </a>
<a name="3707"><span class="lineNum">    3707 </span><span class="lineCov">         42 :         ZSTR_LEN(str) = nlen;</span></a>
<a name="3708"><span class="lineNum">    3708 </span><span class="lineCov">         42 : }</span></a>
<a name="3709"><span class="lineNum">    3709 </span>            : /* }}} */</a>
<a name="3710"><span class="lineNum">    3710 </span>            : </a>
<a name="3711"><span class="lineNum">    3711 </span>            : /* {{{ php_addcslashes_str */</a>
<a name="3712"><span class="lineNum">    3712 </span><span class="lineCov">     190610 : PHPAPI zend_string *php_addcslashes_str(const char *str, size_t len, const char *what, size_t wlength)</span></a>
<a name="3713"><span class="lineNum">    3713 </span>            : {</a>
<a name="3714"><span class="lineNum">    3714 </span>            :         char flags[256];</a>
<a name="3715"><span class="lineNum">    3715 </span>            :         char *target;</a>
<a name="3716"><span class="lineNum">    3716 </span>            :         const char *source, *end;</a>
<a name="3717"><span class="lineNum">    3717 </span>            :         char c;</a>
<a name="3718"><span class="lineNum">    3718 </span>            :         size_t  newlen;</a>
<a name="3719"><span class="lineNum">    3719 </span><span class="lineCov">     190610 :         zend_string *new_str = zend_string_safe_alloc(4, len, 0, 0);</span></a>
<a name="3720"><span class="lineNum">    3720 </span>            : </a>
<a name="3721"><span class="lineNum">    3721 </span><span class="lineCov">     190610 :         php_charmask((const unsigned char *) what, wlength, flags);</span></a>
<a name="3722"><span class="lineNum">    3722 </span>            : </a>
<a name="3723"><span class="lineNum">    3723 </span><span class="lineCov">    9297560 :         for (source = str, end = source + len, target = ZSTR_VAL(new_str); source &lt; end; source++) {</span></a>
<a name="3724"><span class="lineNum">    3724 </span><span class="lineCov">    9106950 :                 c = *source;</span></a>
<a name="3725"><span class="lineNum">    3725 </span><span class="lineCov">    9106950 :                 if (flags[(unsigned char)c]) {</span></a>
<a name="3726"><span class="lineNum">    3726 </span><span class="lineCov">      64038 :                         if ((unsigned char) c &lt; 32 || (unsigned char) c &gt; 126) {</span></a>
<a name="3727"><span class="lineNum">    3727 </span><span class="lineCov">         84 :                                 *target++ = '\\';</span></a>
<a name="3728"><span class="lineNum">    3728 </span><span class="lineCov">         84 :                                 switch (c) {</span></a>
<a name="3729"><span class="lineNum">    3729 </span><span class="lineCov">         24 :                                         case '\n': *target++ = 'n'; break;</span></a>
<a name="3730"><span class="lineNum">    3730 </span><span class="lineCov">          6 :                                         case '\t': *target++ = 't'; break;</span></a>
<a name="3731"><span class="lineNum">    3731 </span><span class="lineCov">         24 :                                         case '\r': *target++ = 'r'; break;</span></a>
<a name="3732"><span class="lineNum">    3732 </span><span class="lineNoCov">          0 :                                         case '\a': *target++ = 'a'; break;</span></a>
<a name="3733"><span class="lineNum">    3733 </span><span class="lineCov">          6 :                                         case '\v': *target++ = 'v'; break;</span></a>
<a name="3734"><span class="lineNum">    3734 </span><span class="lineNoCov">          0 :                                         case '\b': *target++ = 'b'; break;</span></a>
<a name="3735"><span class="lineNum">    3735 </span><span class="lineCov">          6 :                                         case '\f': *target++ = 'f'; break;</span></a>
<a name="3736"><span class="lineNum">    3736 </span><span class="lineCov">         18 :                                         default: target += sprintf(target, &quot;%03o&quot;, (unsigned char) c);</span></a>
<a name="3737"><span class="lineNum">    3737 </span>            :                                 }</a>
<a name="3738"><span class="lineNum">    3738 </span><span class="lineCov">         84 :                                 continue;</span></a>
<a name="3739"><span class="lineNum">    3739 </span>            :                         }</a>
<a name="3740"><span class="lineNum">    3740 </span><span class="lineCov">      63954 :                         *target++ = '\\';</span></a>
<a name="3741"><span class="lineNum">    3741 </span>            :                 }</a>
<a name="3742"><span class="lineNum">    3742 </span><span class="lineCov">    9106860 :                 *target++ = c;</span></a>
<a name="3743"><span class="lineNum">    3743 </span>            :         }</a>
<a name="3744"><span class="lineNum">    3744 </span><span class="lineCov">     190610 :         *target = 0;</span></a>
<a name="3745"><span class="lineNum">    3745 </span><span class="lineCov">     190610 :         newlen = target - ZSTR_VAL(new_str);</span></a>
<a name="3746"><span class="lineNum">    3746 </span><span class="lineCov">     190610 :         if (newlen &lt; len * 4) {</span></a>
<a name="3747"><span class="lineNum">    3747 </span><span class="lineCov">     190568 :                 new_str = zend_string_truncate(new_str, newlen, 0);</span></a>
<a name="3748"><span class="lineNum">    3748 </span>            :         }</a>
<a name="3749"><span class="lineNum">    3749 </span><span class="lineCov">     190610 :         return new_str;</span></a>
<a name="3750"><span class="lineNum">    3750 </span>            : }</a>
<a name="3751"><span class="lineNum">    3751 </span>            : /* }}} */</a>
<a name="3752"><span class="lineNum">    3752 </span>            : </a>
<a name="3753"><span class="lineNum">    3753 </span>            : /* {{{ php_addcslashes */</a>
<a name="3754"><span class="lineNum">    3754 </span><span class="lineCov">      16138 : PHPAPI zend_string *php_addcslashes(zend_string *str, const char *what, size_t wlength)</span></a>
<a name="3755"><span class="lineNum">    3755 </span>            : {</a>
<a name="3756"><span class="lineNum">    3756 </span><span class="lineCov">      16138 :         return php_addcslashes_str(ZSTR_VAL(str), ZSTR_LEN(str), what, wlength);</span></a>
<a name="3757"><span class="lineNum">    3757 </span>            : }</a>
<a name="3758"><span class="lineNum">    3758 </span>            : /* }}} */</a>
<a name="3759"><span class="lineNum">    3759 </span>            : </a>
<a name="3760"><span class="lineNum">    3760 </span>            : /* {{{ php_addslashes */</a>
<a name="3761"><span class="lineNum">    3761 </span>            : </a>
<a name="3762"><span class="lineNum">    3762 </span>            : #if ZEND_INTRIN_SSE4_2_NATIVE</a>
<a name="3763"><span class="lineNum">    3763 </span>            : # include &lt;nmmintrin.h&gt;</a>
<a name="3764"><span class="lineNum">    3764 </span>            : # include &quot;Zend/zend_bitset.h&quot;</a>
<a name="3765"><span class="lineNum">    3765 </span>            : #elif ZEND_INTRIN_SSE4_2_RESOLVER</a>
<a name="3766"><span class="lineNum">    3766 </span>            : # include &lt;nmmintrin.h&gt;</a>
<a name="3767"><span class="lineNum">    3767 </span>            : # include &quot;Zend/zend_bitset.h&quot;</a>
<a name="3768"><span class="lineNum">    3768 </span>            : # include &quot;Zend/zend_cpuinfo.h&quot;</a>
<a name="3769"><span class="lineNum">    3769 </span>            : </a>
<a name="3770"><span class="lineNum">    3770 </span>            : ZEND_INTRIN_SSE4_2_FUNC_DECL(zend_string *php_addslashes_sse42(zend_string *str));</a>
<a name="3771"><span class="lineNum">    3771 </span>            : zend_string *php_addslashes_default(zend_string *str);</a>
<a name="3772"><span class="lineNum">    3772 </span>            : </a>
<a name="3773"><span class="lineNum">    3773 </span>            : ZEND_INTRIN_SSE4_2_FUNC_DECL(void php_stripslashes_sse42(zend_string *str));</a>
<a name="3774"><span class="lineNum">    3774 </span>            : void php_stripslashes_default(zend_string *str);</a>
<a name="3775"><span class="lineNum">    3775 </span>            : </a>
<a name="3776"><span class="lineNum">    3776 </span>            : # if ZEND_INTRIN_SSE4_2_FUNC_PROTO</a>
<a name="3777"><span class="lineNum">    3777 </span>            : PHPAPI zend_string *php_addslashes(zend_string *str) __attribute__((ifunc(&quot;resolve_addslashes&quot;)));</a>
<a name="3778"><span class="lineNum">    3778 </span>            : PHPAPI void php_stripslashes(zend_string *str) __attribute__((ifunc(&quot;resolve_stripslashes&quot;)));</a>
<a name="3779"><span class="lineNum">    3779 </span>            : </a>
<a name="3780"><span class="lineNum">    3780 </span>            : typedef zend_string *(*php_addslashes_func_t)(zend_string *);</a>
<a name="3781"><span class="lineNum">    3781 </span>            : typedef void (*php_stripslashes_func_t)(zend_string *);</a>
<a name="3782"><span class="lineNum">    3782 </span>            : </a>
<a name="3783"><span class="lineNum">    3783 </span>            : ZEND_NO_SANITIZE_ADDRESS</a>
<a name="3784"><span class="lineNum">    3784 </span>            : ZEND_ATTRIBUTE_UNUSED /* clang mistakenly warns about this */</a>
<a name="3785"><span class="lineNum">    3785 </span><span class="lineCov">      38661 : static php_addslashes_func_t resolve_addslashes(void) {</span></a>
<a name="3786"><span class="lineNum">    3786 </span><span class="lineCov">      38661 :         if (zend_cpu_supports_sse42()) {</span></a>
<a name="3787"><span class="lineNum">    3787 </span><span class="lineCov">      38661 :                 return php_addslashes_sse42;</span></a>
<a name="3788"><span class="lineNum">    3788 </span>            :         }</a>
<a name="3789"><span class="lineNum">    3789 </span><span class="lineNoCov">          0 :         return php_addslashes_default;</span></a>
<a name="3790"><span class="lineNum">    3790 </span>            : }</a>
<a name="3791"><span class="lineNum">    3791 </span>            : </a>
<a name="3792"><span class="lineNum">    3792 </span>            : ZEND_NO_SANITIZE_ADDRESS</a>
<a name="3793"><span class="lineNum">    3793 </span>            : ZEND_ATTRIBUTE_UNUSED /* clang mistakenly warns about this */</a>
<a name="3794"><span class="lineNum">    3794 </span><span class="lineCov">      38661 : static php_stripslashes_func_t resolve_stripslashes(void) {</span></a>
<a name="3795"><span class="lineNum">    3795 </span><span class="lineCov">      38661 :         if (zend_cpu_supports_sse42()) {</span></a>
<a name="3796"><span class="lineNum">    3796 </span><span class="lineCov">      38661 :                 return php_stripslashes_sse42;</span></a>
<a name="3797"><span class="lineNum">    3797 </span>            :         }</a>
<a name="3798"><span class="lineNum">    3798 </span><span class="lineNoCov">          0 :         return php_stripslashes_default;</span></a>
<a name="3799"><span class="lineNum">    3799 </span>            : }</a>
<a name="3800"><span class="lineNum">    3800 </span>            : # else /* ZEND_INTRIN_SSE4_2_FUNC_PTR */</a>
<a name="3801"><span class="lineNum">    3801 </span>            : </a>
<a name="3802"><span class="lineNum">    3802 </span>            : static zend_string *(*php_addslashes_ptr)(zend_string *str) = NULL;</a>
<a name="3803"><span class="lineNum">    3803 </span>            : static void (*php_stripslashes_ptr)(zend_string *str) = NULL;</a>
<a name="3804"><span class="lineNum">    3804 </span>            : </a>
<a name="3805"><span class="lineNum">    3805 </span>            : PHPAPI zend_string *php_addslashes(zend_string *str) {</a>
<a name="3806"><span class="lineNum">    3806 </span>            :         return php_addslashes_ptr(str);</a>
<a name="3807"><span class="lineNum">    3807 </span>            : }</a>
<a name="3808"><span class="lineNum">    3808 </span>            : PHPAPI void php_stripslashes(zend_string *str) {</a>
<a name="3809"><span class="lineNum">    3809 </span>            :         php_stripslashes_ptr(str);</a>
<a name="3810"><span class="lineNum">    3810 </span>            : }</a>
<a name="3811"><span class="lineNum">    3811 </span>            : </a>
<a name="3812"><span class="lineNum">    3812 </span>            : /* {{{ PHP_MINIT_FUNCTION */</a>
<a name="3813"><span class="lineNum">    3813 </span>            : PHP_MINIT_FUNCTION(string_intrin)</a>
<a name="3814"><span class="lineNum">    3814 </span>            : {</a>
<a name="3815"><span class="lineNum">    3815 </span>            :         if (zend_cpu_supports_sse42()) {</a>
<a name="3816"><span class="lineNum">    3816 </span>            :                 php_addslashes_ptr = php_addslashes_sse42;</a>
<a name="3817"><span class="lineNum">    3817 </span>            :                 php_stripslashes_ptr = php_stripslashes_sse42;</a>
<a name="3818"><span class="lineNum">    3818 </span>            :         } else {</a>
<a name="3819"><span class="lineNum">    3819 </span>            :                 php_addslashes_ptr = php_addslashes_default;</a>
<a name="3820"><span class="lineNum">    3820 </span>            :                 php_stripslashes_ptr = php_stripslashes_default;</a>
<a name="3821"><span class="lineNum">    3821 </span>            :         }</a>
<a name="3822"><span class="lineNum">    3822 </span>            :         return SUCCESS;</a>
<a name="3823"><span class="lineNum">    3823 </span>            : }</a>
<a name="3824"><span class="lineNum">    3824 </span>            : /* }}} */</a>
<a name="3825"><span class="lineNum">    3825 </span>            : # endif</a>
<a name="3826"><span class="lineNum">    3826 </span>            : #endif</a>
<a name="3827"><span class="lineNum">    3827 </span>            : </a>
<a name="3828"><span class="lineNum">    3828 </span>            : #if ZEND_INTRIN_SSE4_2_NATIVE || ZEND_INTRIN_SSE4_2_RESOLVER</a>
<a name="3829"><span class="lineNum">    3829 </span>            : # if ZEND_INTRIN_SSE4_2_NATIVE</a>
<a name="3830"><span class="lineNum">    3830 </span>            : PHPAPI zend_string *php_addslashes(zend_string *str) /* {{{ */</a>
<a name="3831"><span class="lineNum">    3831 </span>            : # elif ZEND_INTRIN_SSE4_2_RESOLVER</a>
<a name="3832"><span class="lineNum">    3832 </span><span class="lineCov">        345 : zend_string *php_addslashes_sse42(zend_string *str)</span></a>
<a name="3833"><span class="lineNum">    3833 </span>            : # endif</a>
<a name="3834"><span class="lineNum">    3834 </span>            : {</a>
<a name="3835"><span class="lineNum">    3835 </span>            :         ZEND_SET_ALIGNED(16, static const char slashchars[16]) = &quot;\'\&quot;\\\0&quot;;</a>
<a name="3836"><span class="lineNum">    3836 </span>            :         __m128i w128, s128;</a>
<a name="3837"><span class="lineNum">    3837 </span><span class="lineCov">        345 :         uint32_t res = 0;</span></a>
<a name="3838"><span class="lineNum">    3838 </span>            :         /* maximum string length, worst case situation */</a>
<a name="3839"><span class="lineNum">    3839 </span>            :         char *target;</a>
<a name="3840"><span class="lineNum">    3840 </span>            :         const char *source, *end;</a>
<a name="3841"><span class="lineNum">    3841 </span>            :         size_t offset;</a>
<a name="3842"><span class="lineNum">    3842 </span>            :         zend_string *new_str;</a>
<a name="3843"><span class="lineNum">    3843 </span>            : </a>
<a name="3844"><span class="lineNum">    3844 </span><span class="lineCov">        345 :         if (!str) {</span></a>
<a name="3845"><span class="lineNum">    3845 </span><span class="lineNoCov">          0 :                 return ZSTR_EMPTY_ALLOC();</span></a>
<a name="3846"><span class="lineNum">    3846 </span>            :         }</a>
<a name="3847"><span class="lineNum">    3847 </span>            : </a>
<a name="3848"><span class="lineNum">    3848 </span><span class="lineCov">        345 :         source = ZSTR_VAL(str);</span></a>
<a name="3849"><span class="lineNum">    3849 </span><span class="lineCov">        345 :         end = source + ZSTR_LEN(str);</span></a>
<a name="3850"><span class="lineNum">    3850 </span>            : </a>
<a name="3851"><span class="lineNum">    3851 </span><span class="lineCov">        345 :         if (ZSTR_LEN(str) &gt; 15) {</span></a>
<a name="3852"><span class="lineNum">    3852 </span><span class="lineCov">        117 :                 w128 = _mm_load_si128((__m128i *)slashchars);</span></a>
<a name="3853"><span class="lineNum">    3853 </span>            :                 do {</a>
<a name="3854"><span class="lineNum">    3854 </span><span class="lineCov">        168 :                         s128 = _mm_loadu_si128((__m128i *)source);</span></a>
<a name="3855"><span class="lineNum">    3855 </span><span class="lineCov">        168 :                         res = _mm_cvtsi128_si32(_mm_cmpestrm(w128, 4, s128, 16, _SIDD_UBYTE_OPS | _SIDD_CMP_EQUAL_ANY | _SIDD_BIT_MASK));</span></a>
<a name="3856"><span class="lineNum">    3856 </span><span class="lineCov">        168 :                         if (res) {</span></a>
<a name="3857"><span class="lineNum">    3857 </span><span class="lineCov">         63 :                                 goto do_escape;</span></a>
<a name="3858"><span class="lineNum">    3858 </span>            :                         }</a>
<a name="3859"><span class="lineNum">    3859 </span><span class="lineCov">        105 :                         source += 16;</span></a>
<a name="3860"><span class="lineNum">    3860 </span><span class="lineCov">        105 :                 } while ((end - source) &gt; 15);</span></a>
<a name="3861"><span class="lineNum">    3861 </span>            :         }</a>
<a name="3862"><span class="lineNum">    3862 </span>            : </a>
<a name="3863"><span class="lineNum">    3863 </span><span class="lineCov">       1176 :         while (source &lt; end) {</span></a>
<a name="3864"><span class="lineNum">    3864 </span><span class="lineCov">       1056 :                 switch (*source) {</span></a>
<a name="3865"><span class="lineNum">    3865 </span><span class="lineCov">        162 :                         case '\0':</span></a>
<a name="3866"><span class="lineNum">    3866 </span>            :                         case '\'':</a>
<a name="3867"><span class="lineNum">    3867 </span>            :                         case '\&quot;':</a>
<a name="3868"><span class="lineNum">    3868 </span>            :                         case '\\':</a>
<a name="3869"><span class="lineNum">    3869 </span><span class="lineCov">        162 :                                 goto do_escape;</span></a>
<a name="3870"><span class="lineNum">    3870 </span><span class="lineCov">        894 :                         default:</span></a>
<a name="3871"><span class="lineNum">    3871 </span><span class="lineCov">        894 :                                 source++;</span></a>
<a name="3872"><span class="lineNum">    3872 </span><span class="lineCov">        894 :                                 break;</span></a>
<a name="3873"><span class="lineNum">    3873 </span>            :                 }</a>
<a name="3874"><span class="lineNum">    3874 </span>            :         }</a>
<a name="3875"><span class="lineNum">    3875 </span>            : </a>
<a name="3876"><span class="lineNum">    3876 </span><span class="lineCov">        120 :         return zend_string_copy(str);</span></a>
<a name="3877"><span class="lineNum">    3877 </span>            : </a>
<a name="3878"><span class="lineNum">    3878 </span><span class="lineCov">        225 : do_escape:</span></a>
<a name="3879"><span class="lineNum">    3879 </span><span class="lineCov">        225 :         offset = source - (char *)ZSTR_VAL(str);</span></a>
<a name="3880"><span class="lineNum">    3880 </span><span class="lineCov">        225 :         new_str = zend_string_safe_alloc(2, ZSTR_LEN(str) - offset, offset, 0);</span></a>
<a name="3881"><span class="lineNum">    3881 </span><span class="lineCov">        225 :         memcpy(ZSTR_VAL(new_str), ZSTR_VAL(str), offset);</span></a>
<a name="3882"><span class="lineNum">    3882 </span><span class="lineCov">        225 :         target = ZSTR_VAL(new_str) + offset;</span></a>
<a name="3883"><span class="lineNum">    3883 </span>            : </a>
<a name="3884"><span class="lineNum">    3884 </span><span class="lineCov">        225 :         if (res) {</span></a>
<a name="3885"><span class="lineNum">    3885 </span><span class="lineCov">         63 :                 int pos = 0;</span></a>
<a name="3886"><span class="lineNum">    3886 </span>            :                 do {</a>
<a name="3887"><span class="lineNum">    3887 </span><span class="lineCov">        141 :                         int i, n = zend_ulong_ntz(res);</span></a>
<a name="3888"><span class="lineNum">    3888 </span><span class="lineCov">        702 :                         for (i = 0; i &lt; n; i++) {</span></a>
<a name="3889"><span class="lineNum">    3889 </span><span class="lineCov">        561 :                                 *target++ = source[pos + i];</span></a>
<a name="3890"><span class="lineNum">    3890 </span>            :                         }</a>
<a name="3891"><span class="lineNum">    3891 </span><span class="lineCov">        141 :                         pos += n;</span></a>
<a name="3892"><span class="lineNum">    3892 </span><span class="lineCov">        141 :                         *target++ = '\\';</span></a>
<a name="3893"><span class="lineNum">    3893 </span><span class="lineCov">        141 :                         if (source[pos] == '\0') {</span></a>
<a name="3894"><span class="lineNum">    3894 </span><span class="lineCov">          9 :                                 *target++ = '0';</span></a>
<a name="3895"><span class="lineNum">    3895 </span>            :                         } else {</a>
<a name="3896"><span class="lineNum">    3896 </span><span class="lineCov">        132 :                                 *target++ = source[pos];</span></a>
<a name="3897"><span class="lineNum">    3897 </span>            :                         }</a>
<a name="3898"><span class="lineNum">    3898 </span><span class="lineCov">        141 :                         pos++;</span></a>
<a name="3899"><span class="lineNum">    3899 </span><span class="lineCov">        141 :                         res = res &gt;&gt; (n + 1);</span></a>
<a name="3900"><span class="lineNum">    3900 </span><span class="lineCov">        141 :                 } while (res);</span></a>
<a name="3901"><span class="lineNum">    3901 </span>            : </a>
<a name="3902"><span class="lineNum">    3902 </span><span class="lineCov">        369 :                 for (; pos &lt; 16; pos++) {</span></a>
<a name="3903"><span class="lineNum">    3903 </span><span class="lineCov">        306 :                         *target++ = source[pos];</span></a>
<a name="3904"><span class="lineNum">    3904 </span>            :                 }</a>
<a name="3905"><span class="lineNum">    3905 </span><span class="lineCov">         63 :                 source += 16;</span></a>
<a name="3906"><span class="lineNum">    3906 </span><span class="lineCov">        162 :         } else if (end - source &gt; 15) {</span></a>
<a name="3907"><span class="lineNum">    3907 </span><span class="lineNoCov">          0 :                 w128 = _mm_load_si128((__m128i *)slashchars);</span></a>
<a name="3908"><span class="lineNum">    3908 </span>            :         }</a>
<a name="3909"><span class="lineNum">    3909 </span>            : </a>
<a name="3910"><span class="lineNum">    3910 </span><span class="lineCov">        330 :         for (; end - source &gt; 15; source += 16) {</span></a>
<a name="3911"><span class="lineNum">    3911 </span><span class="lineCov">        105 :                 int pos = 0;</span></a>
<a name="3912"><span class="lineNum">    3912 </span><span class="lineCov">        105 :                 s128 = _mm_loadu_si128((__m128i *)source);</span></a>
<a name="3913"><span class="lineNum">    3913 </span><span class="lineCov">        105 :                 res = _mm_cvtsi128_si32(_mm_cmpestrm(w128, 4, s128, 16, _SIDD_UBYTE_OPS | _SIDD_CMP_EQUAL_ANY | _SIDD_BIT_MASK));</span></a>
<a name="3914"><span class="lineNum">    3914 </span><span class="lineCov">        105 :                 if (res) {</span></a>
<a name="3915"><span class="lineNum">    3915 </span>            :                         do {</a>
<a name="3916"><span class="lineNum">    3916 </span><span class="lineCov">         33 :                                 int i, n = zend_ulong_ntz(res);</span></a>
<a name="3917"><span class="lineNum">    3917 </span><span class="lineCov">        213 :                                 for (i = 0; i &lt; n; i++) {</span></a>
<a name="3918"><span class="lineNum">    3918 </span><span class="lineCov">        180 :                                         *target++ = source[pos + i];</span></a>
<a name="3919"><span class="lineNum">    3919 </span>            :                                 }</a>
<a name="3920"><span class="lineNum">    3920 </span><span class="lineCov">         33 :                                 pos += n;</span></a>
<a name="3921"><span class="lineNum">    3921 </span><span class="lineCov">         33 :                                 *target++ = '\\';</span></a>
<a name="3922"><span class="lineNum">    3922 </span><span class="lineCov">         33 :                                 if (source[pos] == '\0') {</span></a>
<a name="3923"><span class="lineNum">    3923 </span><span class="lineCov">          3 :                                         *target++ = '0';</span></a>
<a name="3924"><span class="lineNum">    3924 </span>            :                                 } else {</a>
<a name="3925"><span class="lineNum">    3925 </span><span class="lineCov">         30 :                                         *target++ = source[pos];</span></a>
<a name="3926"><span class="lineNum">    3926 </span>            :                                 }</a>
<a name="3927"><span class="lineNum">    3927 </span><span class="lineCov">         33 :                                 pos++;</span></a>
<a name="3928"><span class="lineNum">    3928 </span><span class="lineCov">         33 :                                 res = res &gt;&gt; (n + 1);</span></a>
<a name="3929"><span class="lineNum">    3929 </span><span class="lineCov">         33 :                         } while (res);</span></a>
<a name="3930"><span class="lineNum">    3930 </span><span class="lineCov">        144 :                         for (; pos &lt; 16; pos++) {</span></a>
<a name="3931"><span class="lineNum">    3931 </span><span class="lineCov">        123 :                                 *target++ = source[pos];</span></a>
<a name="3932"><span class="lineNum">    3932 </span>            :                         }</a>
<a name="3933"><span class="lineNum">    3933 </span>            :                 } else {</a>
<a name="3934"><span class="lineNum">    3934 </span>            :                         _mm_storeu_si128((__m128i*)target, s128);</a>
<a name="3935"><span class="lineNum">    3935 </span><span class="lineCov">         84 :                         target += 16;</span></a>
<a name="3936"><span class="lineNum">    3936 </span>            :                 }</a>
<a name="3937"><span class="lineNum">    3937 </span>            :         }</a>
<a name="3938"><span class="lineNum">    3938 </span>            : </a>
<a name="3939"><span class="lineNum">    3939 </span><span class="lineCov">       1614 :         while (source &lt; end) {</span></a>
<a name="3940"><span class="lineNum">    3940 </span><span class="lineCov">       1389 :                 switch (*source) {</span></a>
<a name="3941"><span class="lineNum">    3941 </span><span class="lineCov">         84 :                         case '\0':</span></a>
<a name="3942"><span class="lineNum">    3942 </span><span class="lineCov">         84 :                                 *target++ = '\\';</span></a>
<a name="3943"><span class="lineNum">    3943 </span><span class="lineCov">         84 :                                 *target++ = '0';</span></a>
<a name="3944"><span class="lineNum">    3944 </span><span class="lineCov">         84 :                                 break;</span></a>
<a name="3945"><span class="lineNum">    3945 </span><span class="lineCov">        267 :                         case '\'':</span></a>
<a name="3946"><span class="lineNum">    3946 </span>            :                         case '\&quot;':</a>
<a name="3947"><span class="lineNum">    3947 </span>            :                         case '\\':</a>
<a name="3948"><span class="lineNum">    3948 </span><span class="lineCov">        267 :                                 *target++ = '\\';</span></a>
<a name="3949"><span class="lineNum">    3949 </span>            :                                 ZEND_FALLTHROUGH;</a>
<a name="3950"><span class="lineNum">    3950 </span><span class="lineCov">       1305 :                         default:</span></a>
<a name="3951"><span class="lineNum">    3951 </span><span class="lineCov">       1305 :                                 *target++ = *source;</span></a>
<a name="3952"><span class="lineNum">    3952 </span><span class="lineCov">       1305 :                                 break;</span></a>
<a name="3953"><span class="lineNum">    3953 </span>            :                 }</a>
<a name="3954"><span class="lineNum">    3954 </span><span class="lineCov">       1389 :                 source++;</span></a>
<a name="3955"><span class="lineNum">    3955 </span>            :         }</a>
<a name="3956"><span class="lineNum">    3956 </span>            : </a>
<a name="3957"><span class="lineNum">    3957 </span><span class="lineCov">        225 :         *target = '\0';</span></a>
<a name="3958"><span class="lineNum">    3958 </span>            : </a>
<a name="3959"><span class="lineNum">    3959 </span><span class="lineCov">        225 :         if (ZSTR_LEN(new_str) - (target - ZSTR_VAL(new_str)) &gt; 16) {</span></a>
<a name="3960"><span class="lineNum">    3960 </span><span class="lineCov">         96 :                 new_str = zend_string_truncate(new_str, target - ZSTR_VAL(new_str), 0);</span></a>
<a name="3961"><span class="lineNum">    3961 </span>            :         } else {</a>
<a name="3962"><span class="lineNum">    3962 </span><span class="lineCov">        177 :                 ZSTR_LEN(new_str) = target - ZSTR_VAL(new_str);</span></a>
<a name="3963"><span class="lineNum">    3963 </span>            :         }</a>
<a name="3964"><span class="lineNum">    3964 </span>            : </a>
<a name="3965"><span class="lineNum">    3965 </span><span class="lineCov">        225 :         return new_str;</span></a>
<a name="3966"><span class="lineNum">    3966 </span>            : }</a>
<a name="3967"><span class="lineNum">    3967 </span>            : /* }}} */</a>
<a name="3968"><span class="lineNum">    3968 </span>            : #endif</a>
<a name="3969"><span class="lineNum">    3969 </span>            : </a>
<a name="3970"><span class="lineNum">    3970 </span>            : #ifdef __aarch64__</a>
<a name="3971"><span class="lineNum">    3971 </span>            : typedef union {</a>
<a name="3972"><span class="lineNum">    3972 </span>            :         uint8_t mem[16];</a>
<a name="3973"><span class="lineNum">    3973 </span>            :         uint64_t dw[2];</a>
<a name="3974"><span class="lineNum">    3974 </span>            : } quad_word;</a>
<a name="3975"><span class="lineNum">    3975 </span>            : </a>
<a name="3976"><span class="lineNum">    3976 </span>            : static zend_always_inline quad_word aarch64_contains_slash_chars(uint8x16_t x) {</a>
<a name="3977"><span class="lineNum">    3977 </span>            :         uint8x16_t s0 = vceqq_u8(x, vdupq_n_u8('\0'));</a>
<a name="3978"><span class="lineNum">    3978 </span>            :         uint8x16_t s1 = vceqq_u8(x, vdupq_n_u8('\''));</a>
<a name="3979"><span class="lineNum">    3979 </span>            :         uint8x16_t s2 = vceqq_u8(x, vdupq_n_u8('\&quot;'));</a>
<a name="3980"><span class="lineNum">    3980 </span>            :         uint8x16_t s3 = vceqq_u8(x, vdupq_n_u8('\\'));</a>
<a name="3981"><span class="lineNum">    3981 </span>            :         uint8x16_t s01 = vorrq_u8(s0, s1);</a>
<a name="3982"><span class="lineNum">    3982 </span>            :         uint8x16_t s23 = vorrq_u8(s2, s3);</a>
<a name="3983"><span class="lineNum">    3983 </span>            :         uint8x16_t s0123 = vorrq_u8(s01, s23);</a>
<a name="3984"><span class="lineNum">    3984 </span>            :         quad_word qw;</a>
<a name="3985"><span class="lineNum">    3985 </span>            :         vst1q_u8(qw.mem, s0123);</a>
<a name="3986"><span class="lineNum">    3986 </span>            :         return qw;</a>
<a name="3987"><span class="lineNum">    3987 </span>            : }</a>
<a name="3988"><span class="lineNum">    3988 </span>            : </a>
<a name="3989"><span class="lineNum">    3989 </span>            : static zend_always_inline char *aarch64_add_slashes(quad_word res, const char *source, char *target)</a>
<a name="3990"><span class="lineNum">    3990 </span>            : {</a>
<a name="3991"><span class="lineNum">    3991 </span>            :         int i = 0;</a>
<a name="3992"><span class="lineNum">    3992 </span>            :         for (; i &lt; 16; i++) {</a>
<a name="3993"><span class="lineNum">    3993 </span>            :                 char s = source[i];</a>
<a name="3994"><span class="lineNum">    3994 </span>            :                 if (res.mem[i] == 0)</a>
<a name="3995"><span class="lineNum">    3995 </span>            :                         *target++ = s;</a>
<a name="3996"><span class="lineNum">    3996 </span>            :                 else {</a>
<a name="3997"><span class="lineNum">    3997 </span>            :                         *target++ = '\\';</a>
<a name="3998"><span class="lineNum">    3998 </span>            :                         if (s == '\0')</a>
<a name="3999"><span class="lineNum">    3999 </span>            :                                 *target++ = '0';</a>
<a name="4000"><span class="lineNum">    4000 </span>            :                         else</a>
<a name="4001"><span class="lineNum">    4001 </span>            :                                 *target++ = s;</a>
<a name="4002"><span class="lineNum">    4002 </span>            :                 }</a>
<a name="4003"><span class="lineNum">    4003 </span>            :         }</a>
<a name="4004"><span class="lineNum">    4004 </span>            :         return target;</a>
<a name="4005"><span class="lineNum">    4005 </span>            : }</a>
<a name="4006"><span class="lineNum">    4006 </span>            : #endif /* __aarch64__ */</a>
<a name="4007"><span class="lineNum">    4007 </span>            : </a>
<a name="4008"><span class="lineNum">    4008 </span>            : #if !ZEND_INTRIN_SSE4_2_NATIVE</a>
<a name="4009"><span class="lineNum">    4009 </span>            : # if ZEND_INTRIN_SSE4_2_RESOLVER</a>
<a name="4010"><span class="lineNum">    4010 </span><span class="lineNoCov">          0 : zend_string *php_addslashes_default(zend_string *str) /* {{{ */</span></a>
<a name="4011"><span class="lineNum">    4011 </span>            : # else</a>
<a name="4012"><span class="lineNum">    4012 </span>            : PHPAPI zend_string *php_addslashes(zend_string *str)</a>
<a name="4013"><span class="lineNum">    4013 </span>            : # endif</a>
<a name="4014"><span class="lineNum">    4014 </span>            : {</a>
<a name="4015"><span class="lineNum">    4015 </span>            :         /* maximum string length, worst case situation */</a>
<a name="4016"><span class="lineNum">    4016 </span>            :         char *target;</a>
<a name="4017"><span class="lineNum">    4017 </span>            :         const char *source, *end;</a>
<a name="4018"><span class="lineNum">    4018 </span>            :         size_t offset;</a>
<a name="4019"><span class="lineNum">    4019 </span>            :         zend_string *new_str;</a>
<a name="4020"><span class="lineNum">    4020 </span>            : </a>
<a name="4021"><span class="lineNum">    4021 </span><span class="lineNoCov">          0 :         if (!str) {</span></a>
<a name="4022"><span class="lineNum">    4022 </span><span class="lineNoCov">          0 :                 return ZSTR_EMPTY_ALLOC();</span></a>
<a name="4023"><span class="lineNum">    4023 </span>            :         }</a>
<a name="4024"><span class="lineNum">    4024 </span>            : </a>
<a name="4025"><span class="lineNum">    4025 </span><span class="lineNoCov">          0 :         source = ZSTR_VAL(str);</span></a>
<a name="4026"><span class="lineNum">    4026 </span><span class="lineNoCov">          0 :         end = source + ZSTR_LEN(str);</span></a>
<a name="4027"><span class="lineNum">    4027 </span>            : </a>
<a name="4028"><span class="lineNum">    4028 </span>            : # ifdef __aarch64__</a>
<a name="4029"><span class="lineNum">    4029 </span>            :         quad_word res = {0};</a>
<a name="4030"><span class="lineNum">    4030 </span>            :         if (ZSTR_LEN(str) &gt; 15) {</a>
<a name="4031"><span class="lineNum">    4031 </span>            :                 do {</a>
<a name="4032"><span class="lineNum">    4032 </span>            :                         res = aarch64_contains_slash_chars(vld1q_u8((uint8_t *)source));</a>
<a name="4033"><span class="lineNum">    4033 </span>            :                         if (res.dw[0] | res.dw[1])</a>
<a name="4034"><span class="lineNum">    4034 </span>            :                                 goto do_escape;</a>
<a name="4035"><span class="lineNum">    4035 </span>            :                         source += 16;</a>
<a name="4036"><span class="lineNum">    4036 </span>            :                 } while ((end - source) &gt; 15);</a>
<a name="4037"><span class="lineNum">    4037 </span>            :         }</a>
<a name="4038"><span class="lineNum">    4038 </span>            :         /* Finish the last 15 bytes or less with the scalar loop. */</a>
<a name="4039"><span class="lineNum">    4039 </span>            : # endif /* __aarch64__ */</a>
<a name="4040"><span class="lineNum">    4040 </span>            : </a>
<a name="4041"><span class="lineNum">    4041 </span><span class="lineNoCov">          0 :         while (source &lt; end) {</span></a>
<a name="4042"><span class="lineNum">    4042 </span><span class="lineNoCov">          0 :                 switch (*source) {</span></a>
<a name="4043"><span class="lineNum">    4043 </span><span class="lineNoCov">          0 :                         case '\0':</span></a>
<a name="4044"><span class="lineNum">    4044 </span>            :                         case '\'':</a>
<a name="4045"><span class="lineNum">    4045 </span>            :                         case '\&quot;':</a>
<a name="4046"><span class="lineNum">    4046 </span>            :                         case '\\':</a>
<a name="4047"><span class="lineNum">    4047 </span><span class="lineNoCov">          0 :                                 goto do_escape;</span></a>
<a name="4048"><span class="lineNum">    4048 </span><span class="lineNoCov">          0 :                         default:</span></a>
<a name="4049"><span class="lineNum">    4049 </span><span class="lineNoCov">          0 :                                 source++;</span></a>
<a name="4050"><span class="lineNum">    4050 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="4051"><span class="lineNum">    4051 </span>            :                 }</a>
<a name="4052"><span class="lineNum">    4052 </span>            :         }</a>
<a name="4053"><span class="lineNum">    4053 </span>            : </a>
<a name="4054"><span class="lineNum">    4054 </span><span class="lineNoCov">          0 :         return zend_string_copy(str);</span></a>
<a name="4055"><span class="lineNum">    4055 </span>            : </a>
<a name="4056"><span class="lineNum">    4056 </span><span class="lineNoCov">          0 : do_escape:</span></a>
<a name="4057"><span class="lineNum">    4057 </span><span class="lineNoCov">          0 :         offset = source - (char *)ZSTR_VAL(str);</span></a>
<a name="4058"><span class="lineNum">    4058 </span><span class="lineNoCov">          0 :         new_str = zend_string_safe_alloc(2, ZSTR_LEN(str) - offset, offset, 0);</span></a>
<a name="4059"><span class="lineNum">    4059 </span><span class="lineNoCov">          0 :         memcpy(ZSTR_VAL(new_str), ZSTR_VAL(str), offset);</span></a>
<a name="4060"><span class="lineNum">    4060 </span><span class="lineNoCov">          0 :         target = ZSTR_VAL(new_str) + offset;</span></a>
<a name="4061"><span class="lineNum">    4061 </span>            : </a>
<a name="4062"><span class="lineNum">    4062 </span>            : # ifdef __aarch64__</a>
<a name="4063"><span class="lineNum">    4063 </span>            :         if (res.dw[0] | res.dw[1]) {</a>
<a name="4064"><span class="lineNum">    4064 </span>            :                 target = aarch64_add_slashes(res, source, target);</a>
<a name="4065"><span class="lineNum">    4065 </span>            :                 source += 16;</a>
<a name="4066"><span class="lineNum">    4066 </span>            :         }</a>
<a name="4067"><span class="lineNum">    4067 </span>            :         for (; end - source &gt; 15; source += 16) {</a>
<a name="4068"><span class="lineNum">    4068 </span>            :                 uint8x16_t x = vld1q_u8((uint8_t *)source);</a>
<a name="4069"><span class="lineNum">    4069 </span>            :                 res = aarch64_contains_slash_chars(x);</a>
<a name="4070"><span class="lineNum">    4070 </span>            :                 if (res.dw[0] | res.dw[1]) {</a>
<a name="4071"><span class="lineNum">    4071 </span>            :                         target = aarch64_add_slashes(res, source, target);</a>
<a name="4072"><span class="lineNum">    4072 </span>            :                 } else {</a>
<a name="4073"><span class="lineNum">    4073 </span>            :                         vst1q_u8((uint8_t*)target, x);</a>
<a name="4074"><span class="lineNum">    4074 </span>            :                         target += 16;</a>
<a name="4075"><span class="lineNum">    4075 </span>            :                 }</a>
<a name="4076"><span class="lineNum">    4076 </span>            :         }</a>
<a name="4077"><span class="lineNum">    4077 </span>            :         /* Finish the last 15 bytes or less with the scalar loop. */</a>
<a name="4078"><span class="lineNum">    4078 </span>            : # endif /* __aarch64__ */</a>
<a name="4079"><span class="lineNum">    4079 </span>            : </a>
<a name="4080"><span class="lineNum">    4080 </span><span class="lineNoCov">          0 :         while (source &lt; end) {</span></a>
<a name="4081"><span class="lineNum">    4081 </span><span class="lineNoCov">          0 :                 switch (*source) {</span></a>
<a name="4082"><span class="lineNum">    4082 </span><span class="lineNoCov">          0 :                         case '\0':</span></a>
<a name="4083"><span class="lineNum">    4083 </span><span class="lineNoCov">          0 :                                 *target++ = '\\';</span></a>
<a name="4084"><span class="lineNum">    4084 </span><span class="lineNoCov">          0 :                                 *target++ = '0';</span></a>
<a name="4085"><span class="lineNum">    4085 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="4086"><span class="lineNum">    4086 </span><span class="lineNoCov">          0 :                         case '\'':</span></a>
<a name="4087"><span class="lineNum">    4087 </span>            :                         case '\&quot;':</a>
<a name="4088"><span class="lineNum">    4088 </span>            :                         case '\\':</a>
<a name="4089"><span class="lineNum">    4089 </span><span class="lineNoCov">          0 :                                 *target++ = '\\';</span></a>
<a name="4090"><span class="lineNum">    4090 </span>            :                                 ZEND_FALLTHROUGH;</a>
<a name="4091"><span class="lineNum">    4091 </span><span class="lineNoCov">          0 :                         default:</span></a>
<a name="4092"><span class="lineNum">    4092 </span><span class="lineNoCov">          0 :                                 *target++ = *source;</span></a>
<a name="4093"><span class="lineNum">    4093 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="4094"><span class="lineNum">    4094 </span>            :                 }</a>
<a name="4095"><span class="lineNum">    4095 </span><span class="lineNoCov">          0 :                 source++;</span></a>
<a name="4096"><span class="lineNum">    4096 </span>            :         }</a>
<a name="4097"><span class="lineNum">    4097 </span>            : </a>
<a name="4098"><span class="lineNum">    4098 </span><span class="lineNoCov">          0 :         *target = '\0';</span></a>
<a name="4099"><span class="lineNum">    4099 </span>            : </a>
<a name="4100"><span class="lineNum">    4100 </span><span class="lineNoCov">          0 :         if (ZSTR_LEN(new_str) - (target - ZSTR_VAL(new_str)) &gt; 16) {</span></a>
<a name="4101"><span class="lineNum">    4101 </span><span class="lineNoCov">          0 :                 new_str = zend_string_truncate(new_str, target - ZSTR_VAL(new_str), 0);</span></a>
<a name="4102"><span class="lineNum">    4102 </span>            :         } else {</a>
<a name="4103"><span class="lineNum">    4103 </span><span class="lineNoCov">          0 :                 ZSTR_LEN(new_str) = target - ZSTR_VAL(new_str);</span></a>
<a name="4104"><span class="lineNum">    4104 </span>            :         }</a>
<a name="4105"><span class="lineNum">    4105 </span>            : </a>
<a name="4106"><span class="lineNum">    4106 </span><span class="lineNoCov">          0 :         return new_str;</span></a>
<a name="4107"><span class="lineNum">    4107 </span>            : }</a>
<a name="4108"><span class="lineNum">    4108 </span>            : #endif</a>
<a name="4109"><span class="lineNum">    4109 </span>            : /* }}} */</a>
<a name="4110"><span class="lineNum">    4110 </span>            : /* }}} */</a>
<a name="4111"><span class="lineNum">    4111 </span>            : </a>
<a name="4112"><span class="lineNum">    4112 </span>            : /* {{{ php_stripslashes</a>
<a name="4113"><span class="lineNum">    4113 </span>            :  *</a>
<a name="4114"><span class="lineNum">    4114 </span>            :  * be careful, this edits the string in-place */</a>
<a name="4115"><span class="lineNum">    4115 </span>            : static zend_always_inline char *php_stripslashes_impl(const char *str, char *out, size_t len)</a>
<a name="4116"><span class="lineNum">    4116 </span>            : {</a>
<a name="4117"><span class="lineNum">    4117 </span>            : #ifdef __aarch64__</a>
<a name="4118"><span class="lineNum">    4118 </span>            :         while (len &gt; 15) {</a>
<a name="4119"><span class="lineNum">    4119 </span>            :                 uint8x16_t x = vld1q_u8((uint8_t *)str);</a>
<a name="4120"><span class="lineNum">    4120 </span>            :                 quad_word q;</a>
<a name="4121"><span class="lineNum">    4121 </span>            :                 vst1q_u8(q.mem, vceqq_u8(x, vdupq_n_u8('\\')));</a>
<a name="4122"><span class="lineNum">    4122 </span>            :                 if (q.dw[0] | q.dw[1]) {</a>
<a name="4123"><span class="lineNum">    4123 </span>            :                         int i = 0;</a>
<a name="4124"><span class="lineNum">    4124 </span>            :                         for (; i &lt; 16; i++) {</a>
<a name="4125"><span class="lineNum">    4125 </span>            :                                 if (q.mem[i] == 0) {</a>
<a name="4126"><span class="lineNum">    4126 </span>            :                                         *out++ = str[i];</a>
<a name="4127"><span class="lineNum">    4127 </span>            :                                         continue;</a>
<a name="4128"><span class="lineNum">    4128 </span>            :                                 }</a>
<a name="4129"><span class="lineNum">    4129 </span>            : </a>
<a name="4130"><span class="lineNum">    4130 </span>            :                                 i++;                    /* skip the slash */</a>
<a name="4131"><span class="lineNum">    4131 </span>            :                                 char s = str[i];</a>
<a name="4132"><span class="lineNum">    4132 </span>            :                                 if (s == '0')</a>
<a name="4133"><span class="lineNum">    4133 </span>            :                                         *out++ = '\0';</a>
<a name="4134"><span class="lineNum">    4134 </span>            :                                 else</a>
<a name="4135"><span class="lineNum">    4135 </span>            :                                         *out++ = s;     /* preserve the next character */</a>
<a name="4136"><span class="lineNum">    4136 </span>            :                         }</a>
<a name="4137"><span class="lineNum">    4137 </span>            :                         str += i;</a>
<a name="4138"><span class="lineNum">    4138 </span>            :                         len -= i;</a>
<a name="4139"><span class="lineNum">    4139 </span>            :                 } else {</a>
<a name="4140"><span class="lineNum">    4140 </span>            :                         vst1q_u8((uint8_t*)out, x);</a>
<a name="4141"><span class="lineNum">    4141 </span>            :                         out += 16;</a>
<a name="4142"><span class="lineNum">    4142 </span>            :                         str += 16;</a>
<a name="4143"><span class="lineNum">    4143 </span>            :                         len -= 16;</a>
<a name="4144"><span class="lineNum">    4144 </span>            :                 }</a>
<a name="4145"><span class="lineNum">    4145 </span>            :         }</a>
<a name="4146"><span class="lineNum">    4146 </span>            :         /* Finish the last 15 bytes or less with the scalar loop. */</a>
<a name="4147"><span class="lineNum">    4147 </span>            : #endif /* __aarch64__ */</a>
<a name="4148"><span class="lineNum">    4148 </span><span class="lineCov">       1443 :         while (len &gt; 0) {</span></a>
<a name="4149"><span class="lineNum">    4149 </span><span class="lineCov">       1191 :                 if (*str == '\\') {</span></a>
<a name="4150"><span class="lineNum">    4150 </span><span class="lineCov">        237 :                         str++;                          /* skip the slash */</span></a>
<a name="4151"><span class="lineNum">    4151 </span><span class="lineCov">        237 :                         len--;</span></a>
<a name="4152"><span class="lineNum">    4152 </span><span class="lineCov">        237 :                         if (len &gt; 0) {</span></a>
<a name="4153"><span class="lineNum">    4153 </span><span class="lineCov">        237 :                                 if (*str == '0') {</span></a>
<a name="4154"><span class="lineNum">    4154 </span><span class="lineCov">         36 :                                         *out++='\0';</span></a>
<a name="4155"><span class="lineNum">    4155 </span><span class="lineCov">         36 :                                         str++;</span></a>
<a name="4156"><span class="lineNum">    4156 </span>            :                                 } else {</a>
<a name="4157"><span class="lineNum">    4157 </span><span class="lineCov">        201 :                                         *out++ = *str++;        /* preserve the next character */</span></a>
<a name="4158"><span class="lineNum">    4158 </span>            :                                 }</a>
<a name="4159"><span class="lineNum">    4159 </span><span class="lineCov">        237 :                                 len--;</span></a>
<a name="4160"><span class="lineNum">    4160 </span>            :                         }</a>
<a name="4161"><span class="lineNum">    4161 </span>            :                 } else {</a>
<a name="4162"><span class="lineNum">    4162 </span><span class="lineCov">        954 :                         *out++ = *str++;</span></a>
<a name="4163"><span class="lineNum">    4163 </span><span class="lineCov">        954 :                         len--;</span></a>
<a name="4164"><span class="lineNum">    4164 </span>            :                 }</a>
<a name="4165"><span class="lineNum">    4165 </span>            :         }</a>
<a name="4166"><span class="lineNum">    4166 </span>            : </a>
<a name="4167"><span class="lineNum">    4167 </span><span class="lineCov">        252 :         return out;</span></a>
<a name="4168"><span class="lineNum">    4168 </span>            : }</a>
<a name="4169"><span class="lineNum">    4169 </span>            : </a>
<a name="4170"><span class="lineNum">    4170 </span>            : #if ZEND_INTRIN_SSE4_2_NATIVE || ZEND_INTRIN_SSE4_2_RESOLVER</a>
<a name="4171"><span class="lineNum">    4171 </span>            : # if ZEND_INTRIN_SSE4_2_NATIVE</a>
<a name="4172"><span class="lineNum">    4172 </span>            : PHPAPI void php_stripslashes(zend_string *str)</a>
<a name="4173"><span class="lineNum">    4173 </span>            : # elif ZEND_INTRIN_SSE4_2_RESOLVER</a>
<a name="4174"><span class="lineNum">    4174 </span><span class="lineCov">        252 : void php_stripslashes_sse42(zend_string *str)</span></a>
<a name="4175"><span class="lineNum">    4175 </span>            : # endif</a>
<a name="4176"><span class="lineNum">    4176 </span>            : {</a>
<a name="4177"><span class="lineNum">    4177 </span><span class="lineCov">        252 :         const char *s = ZSTR_VAL(str);</span></a>
<a name="4178"><span class="lineNum">    4178 </span><span class="lineCov">        252 :         char *t = ZSTR_VAL(str);</span></a>
<a name="4179"><span class="lineNum">    4179 </span><span class="lineCov">        252 :         size_t l = ZSTR_LEN(str);</span></a>
<a name="4180"><span class="lineNum">    4180 </span>            : </a>
<a name="4181"><span class="lineNum">    4181 </span><span class="lineCov">        252 :         if (l &gt; 15) {</span></a>
<a name="4182"><span class="lineNum">    4182 </span><span class="lineCov">         57 :                 const __m128i slash = _mm_set1_epi8('\\');</span></a>
<a name="4183"><span class="lineNum">    4183 </span>            : </a>
<a name="4184"><span class="lineNum">    4184 </span>            :                 do {</a>
<a name="4185"><span class="lineNum">    4185 </span><span class="lineCov">        189 :                         __m128i in = _mm_loadu_si128((__m128i *)s);</span></a>
<a name="4186"><span class="lineNum">    4186 </span><span class="lineCov">        189 :                         __m128i any_slash = _mm_cmpeq_epi8(in, slash);</span></a>
<a name="4187"><span class="lineNum">    4187 </span><span class="lineCov">        189 :                         uint32_t res = _mm_movemask_epi8(any_slash);</span></a>
<a name="4188"><span class="lineNum">    4188 </span>            : </a>
<a name="4189"><span class="lineNum">    4189 </span><span class="lineCov">        189 :                         if (res) {</span></a>
<a name="4190"><span class="lineNum">    4190 </span><span class="lineCov">         72 :                                 int i, n = zend_ulong_ntz(res);</span></a>
<a name="4191"><span class="lineNum">    4191 </span><span class="lineCov">         72 :                                 const char *e = s + 15;</span></a>
<a name="4192"><span class="lineNum">    4192 </span><span class="lineCov">         72 :                                 l -= n;</span></a>
<a name="4193"><span class="lineNum">    4193 </span><span class="lineCov">        390 :                                 for (i = 0; i &lt; n; i++) {</span></a>
<a name="4194"><span class="lineNum">    4194 </span><span class="lineCov">        318 :                                         *t++ = *s++;</span></a>
<a name="4195"><span class="lineNum">    4195 </span>            :                                 }</a>
<a name="4196"><span class="lineNum">    4196 </span><span class="lineCov">        729 :                                 for (; s &lt; e; s++) {</span></a>
<a name="4197"><span class="lineNum">    4197 </span><span class="lineCov">        657 :                                         if (*s == '\\') {</span></a>
<a name="4198"><span class="lineNum">    4198 </span><span class="lineCov">        108 :                                                 s++;</span></a>
<a name="4199"><span class="lineNum">    4199 </span><span class="lineCov">        108 :                                                 l--;</span></a>
<a name="4200"><span class="lineNum">    4200 </span><span class="lineCov">        108 :                                                 if (*s == '0') {</span></a>
<a name="4201"><span class="lineNum">    4201 </span><span class="lineCov">          9 :                                                         *t = '\0';</span></a>
<a name="4202"><span class="lineNum">    4202 </span>            :                                                 } else {</a>
<a name="4203"><span class="lineNum">    4203 </span><span class="lineCov">         99 :                                                         *t = *s;</span></a>
<a name="4204"><span class="lineNum">    4204 </span>            :                                                 }</a>
<a name="4205"><span class="lineNum">    4205 </span>            :                                         } else {</a>
<a name="4206"><span class="lineNum">    4206 </span><span class="lineCov">        549 :                                                 *t = *s;</span></a>
<a name="4207"><span class="lineNum">    4207 </span>            :                                         }</a>
<a name="4208"><span class="lineNum">    4208 </span><span class="lineCov">        657 :                                         t++;</span></a>
<a name="4209"><span class="lineNum">    4209 </span><span class="lineCov">        657 :                                         l--;</span></a>
<a name="4210"><span class="lineNum">    4210 </span>            :                                 }</a>
<a name="4211"><span class="lineNum">    4211 </span>            :                         } else {</a>
<a name="4212"><span class="lineNum">    4212 </span>            :                                 _mm_storeu_si128((__m128i *)t, in);</a>
<a name="4213"><span class="lineNum">    4213 </span><span class="lineCov">        117 :                                 s += 16;</span></a>
<a name="4214"><span class="lineNum">    4214 </span><span class="lineCov">        117 :                                 t += 16;</span></a>
<a name="4215"><span class="lineNum">    4215 </span><span class="lineCov">        117 :                                 l -= 16;</span></a>
<a name="4216"><span class="lineNum">    4216 </span>            :                         }</a>
<a name="4217"><span class="lineNum">    4217 </span><span class="lineCov">        189 :                 } while (l &gt; 15);</span></a>
<a name="4218"><span class="lineNum">    4218 </span>            :         }</a>
<a name="4219"><span class="lineNum">    4219 </span>            : </a>
<a name="4220"><span class="lineNum">    4220 </span><span class="lineCov">        252 :         t = php_stripslashes_impl(s, t, l);</span></a>
<a name="4221"><span class="lineNum">    4221 </span><span class="lineCov">        252 :         if (t != (ZSTR_VAL(str) + ZSTR_LEN(str))) {</span></a>
<a name="4222"><span class="lineNum">    4222 </span><span class="lineCov">        198 :                 ZSTR_LEN(str) = t - ZSTR_VAL(str);</span></a>
<a name="4223"><span class="lineNum">    4223 </span><span class="lineCov">        198 :                 ZSTR_VAL(str)[ZSTR_LEN(str)] = '\0';</span></a>
<a name="4224"><span class="lineNum">    4224 </span>            :         }</a>
<a name="4225"><span class="lineNum">    4225 </span><span class="lineCov">        252 : }</span></a>
<a name="4226"><span class="lineNum">    4226 </span>            : #endif</a>
<a name="4227"><span class="lineNum">    4227 </span>            : </a>
<a name="4228"><span class="lineNum">    4228 </span>            : #if !ZEND_INTRIN_SSE4_2_NATIVE</a>
<a name="4229"><span class="lineNum">    4229 </span>            : # if ZEND_INTRIN_SSE4_2_RESOLVER</a>
<a name="4230"><span class="lineNum">    4230 </span><span class="lineNoCov">          0 : void php_stripslashes_default(zend_string *str) /* {{{ */</span></a>
<a name="4231"><span class="lineNum">    4231 </span>            : # else</a>
<a name="4232"><span class="lineNum">    4232 </span>            : PHPAPI void php_stripslashes(zend_string *str)</a>
<a name="4233"><span class="lineNum">    4233 </span>            : # endif</a>
<a name="4234"><span class="lineNum">    4234 </span>            : {</a>
<a name="4235"><span class="lineNum">    4235 </span><span class="lineNoCov">          0 :         const char *t = php_stripslashes_impl(ZSTR_VAL(str), ZSTR_VAL(str), ZSTR_LEN(str));</span></a>
<a name="4236"><span class="lineNum">    4236 </span><span class="lineNoCov">          0 :         if (t != (ZSTR_VAL(str) + ZSTR_LEN(str))) {</span></a>
<a name="4237"><span class="lineNum">    4237 </span><span class="lineNoCov">          0 :                 ZSTR_LEN(str) = t - ZSTR_VAL(str);</span></a>
<a name="4238"><span class="lineNum">    4238 </span><span class="lineNoCov">          0 :                 ZSTR_VAL(str)[ZSTR_LEN(str)] = '\0';</span></a>
<a name="4239"><span class="lineNum">    4239 </span>            :         }</a>
<a name="4240"><span class="lineNum">    4240 </span><span class="lineNoCov">          0 : }</span></a>
<a name="4241"><span class="lineNum">    4241 </span>            : /* }}} */</a>
<a name="4242"><span class="lineNum">    4242 </span>            : #endif</a>
<a name="4243"><span class="lineNum">    4243 </span>            : /* }}} */</a>
<a name="4244"><span class="lineNum">    4244 </span>            : </a>
<a name="4245"><span class="lineNum">    4245 </span>            : #define _HEB_BLOCK_TYPE_ENG 1</a>
<a name="4246"><span class="lineNum">    4246 </span>            : #define _HEB_BLOCK_TYPE_HEB 2</a>
<a name="4247"><span class="lineNum">    4247 </span>            : #define isheb(c)      (((((unsigned char) c) &gt;= 224) &amp;&amp; (((unsigned char) c) &lt;= 250)) ? 1 : 0)</a>
<a name="4248"><span class="lineNum">    4248 </span>            : #define _isblank(c)   (((((unsigned char) c) == ' '  || ((unsigned char) c) == '\t')) ? 1 : 0)</a>
<a name="4249"><span class="lineNum">    4249 </span>            : #define _isnewline(c) (((((unsigned char) c) == '\n' || ((unsigned char) c) == '\r')) ? 1 : 0)</a>
<a name="4250"><span class="lineNum">    4250 </span>            : </a>
<a name="4251"><span class="lineNum">    4251 </span>            : /* {{{ php_str_replace_in_subject */</a>
<a name="4252"><span class="lineNum">    4252 </span><span class="lineCov">     335162 : static zend_long php_str_replace_in_subject(</span></a>
<a name="4253"><span class="lineNum">    4253 </span>            :         zend_string *search_str, HashTable *search_ht, zend_string *replace_str, HashTable *replace_ht,</a>
<a name="4254"><span class="lineNum">    4254 </span>            :         zend_string *subject_str, zval *result, int case_sensitivity</a>
<a name="4255"><span class="lineNum">    4255 </span>            : ) {</a>
<a name="4256"><span class="lineNum">    4256 </span>            :         zval            *search_entry;</a>
<a name="4257"><span class="lineNum">    4257 </span>            :         zend_string     *tmp_result;</a>
<a name="4258"><span class="lineNum">    4258 </span><span class="lineCov">     335162 :         char            *replace_value = NULL;</span></a>
<a name="4259"><span class="lineNum">    4259 </span><span class="lineCov">     335162 :         size_t           replace_len = 0;</span></a>
<a name="4260"><span class="lineNum">    4260 </span><span class="lineCov">     335162 :         zend_long        replace_count = 0;</span></a>
<a name="4261"><span class="lineNum">    4261 </span><span class="lineCov">     335162 :         zend_string *lc_subject_str = NULL;</span></a>
<a name="4262"><span class="lineNum">    4262 </span>            :         uint32_t     replace_idx;</a>
<a name="4263"><span class="lineNum">    4263 </span>            : </a>
<a name="4264"><span class="lineNum">    4264 </span><span class="lineCov">     335162 :         if (ZSTR_LEN(subject_str) == 0) {</span></a>
<a name="4265"><span class="lineNum">    4265 </span><span class="lineCov">        153 :                 ZVAL_EMPTY_STRING(result);</span></a>
<a name="4266"><span class="lineNum">    4266 </span><span class="lineCov">        153 :                 return 0;</span></a>
<a name="4267"><span class="lineNum">    4267 </span>            :         }</a>
<a name="4268"><span class="lineNum">    4268 </span>            : </a>
<a name="4269"><span class="lineNum">    4269 </span>            :         /* If search is an array */</a>
<a name="4270"><span class="lineNum">    4270 </span><span class="lineCov">     335009 :         if (search_ht) {</span></a>
<a name="4271"><span class="lineNum">    4271 </span>            :                 /* Duplicate subject string for repeated replacement */</a>
<a name="4272"><span class="lineNum">    4272 </span>            :                 zend_string_addref(subject_str);</a>
<a name="4273"><span class="lineNum">    4273 </span>            : </a>
<a name="4274"><span class="lineNum">    4274 </span><span class="lineCov">        141 :                 if (replace_ht) {</span></a>
<a name="4275"><span class="lineNum">    4275 </span><span class="lineCov">        102 :                         replace_idx = 0;</span></a>
<a name="4276"><span class="lineNum">    4276 </span>            :                 } else {</a>
<a name="4277"><span class="lineNum">    4277 </span>            :                         /* Set replacement value to the passed one */</a>
<a name="4278"><span class="lineNum">    4278 </span><span class="lineCov">         39 :                         replace_value = ZSTR_VAL(replace_str);</span></a>
<a name="4279"><span class="lineNum">    4279 </span><span class="lineCov">         39 :                         replace_len = ZSTR_LEN(replace_str);</span></a>
<a name="4280"><span class="lineNum">    4280 </span>            :                 }</a>
<a name="4281"><span class="lineNum">    4281 </span>            : </a>
<a name="4282"><span class="lineNum">    4282 </span>            :                 /* For each entry in the search array, get the entry */</a>
<a name="4283"><span class="lineNum">    4283 </span><span class="lineCov">        648 :                 ZEND_HASH_FOREACH_VAL(search_ht, search_entry) {</span></a>
<a name="4284"><span class="lineNum">    4284 </span>            :                         /* Make sure we're dealing with strings. */</a>
<a name="4285"><span class="lineNum">    4285 </span>            :                         zend_string *tmp_search_str;</a>
<a name="4286"><span class="lineNum">    4286 </span><span class="lineCov">        255 :                         zend_string *search_str = zval_get_tmp_string(search_entry, &amp;tmp_search_str);</span></a>
<a name="4287"><span class="lineNum">    4287 </span><span class="lineCov">        255 :                         zend_string *replace_entry_str, *tmp_replace_entry_str = NULL;</span></a>
<a name="4288"><span class="lineNum">    4288 </span>            : </a>
<a name="4289"><span class="lineNum">    4289 </span>            :                         /* If replace is an array. */</a>
<a name="4290"><span class="lineNum">    4290 </span><span class="lineCov">        255 :                         if (replace_ht) {</span></a>
<a name="4291"><span class="lineNum">    4291 </span>            :                                 /* Get current entry */</a>
<a name="4292"><span class="lineNum">    4292 </span><span class="lineCov">        225 :                                 zval *replace_entry = NULL;</span></a>
<a name="4293"><span class="lineNum">    4293 </span><span class="lineCov">        225 :                                 if (HT_IS_PACKED(replace_ht)) {</span></a>
<a name="4294"><span class="lineNum">    4294 </span><span class="lineCov">        201 :                                         while (replace_idx &lt; replace_ht-&gt;nNumUsed) {</span></a>
<a name="4295"><span class="lineNum">    4295 </span><span class="lineCov">        183 :                                                 replace_entry = &amp;replace_ht-&gt;arPacked[replace_idx];</span></a>
<a name="4296"><span class="lineNum">    4296 </span><span class="lineCov">        183 :                                                 if (Z_TYPE_P(replace_entry) != IS_UNDEF) {</span></a>
<a name="4297"><span class="lineNum">    4297 </span><span class="lineCov">        183 :                                                         break;</span></a>
<a name="4298"><span class="lineNum">    4298 </span>            :                                                 }</a>
<a name="4299"><span class="lineNum">    4299 </span><span class="lineNoCov">          0 :                                                 replace_idx++;</span></a>
<a name="4300"><span class="lineNum">    4300 </span>            :                                         }</a>
<a name="4301"><span class="lineNum">    4301 </span>            :                                 } else {</a>
<a name="4302"><span class="lineNum">    4302 </span><span class="lineCov">         24 :                                         while (replace_idx &lt; replace_ht-&gt;nNumUsed) {</span></a>
<a name="4303"><span class="lineNum">    4303 </span><span class="lineCov">         24 :                                                 replace_entry = &amp;replace_ht-&gt;arData[replace_idx].val;</span></a>
<a name="4304"><span class="lineNum">    4304 </span><span class="lineCov">         24 :                                                 if (Z_TYPE_P(replace_entry) != IS_UNDEF) {</span></a>
<a name="4305"><span class="lineNum">    4305 </span><span class="lineCov">         24 :                                                         break;</span></a>
<a name="4306"><span class="lineNum">    4306 </span>            :                                                 }</a>
<a name="4307"><span class="lineNum">    4307 </span><span class="lineNoCov">          0 :                                                 replace_idx++;</span></a>
<a name="4308"><span class="lineNum">    4308 </span>            :                                         }</a>
<a name="4309"><span class="lineNum">    4309 </span>            :                                 }</a>
<a name="4310"><span class="lineNum">    4310 </span><span class="lineCov">        225 :                                 if (replace_idx &lt; replace_ht-&gt;nNumUsed) {</span></a>
<a name="4311"><span class="lineNum">    4311 </span>            :                                         /* Make sure we're dealing with strings. */</a>
<a name="4312"><span class="lineNum">    4312 </span><span class="lineCov">        207 :                                         replace_entry_str = zval_get_tmp_string(replace_entry, &amp;tmp_replace_entry_str);</span></a>
<a name="4313"><span class="lineNum">    4313 </span>            : </a>
<a name="4314"><span class="lineNum">    4314 </span>            :                                         /* Set replacement value to the one we got from array */</a>
<a name="4315"><span class="lineNum">    4315 </span><span class="lineCov">        207 :                                         replace_value = ZSTR_VAL(replace_entry_str);</span></a>
<a name="4316"><span class="lineNum">    4316 </span><span class="lineCov">        207 :                                         replace_len = ZSTR_LEN(replace_entry_str);</span></a>
<a name="4317"><span class="lineNum">    4317 </span>            : </a>
<a name="4318"><span class="lineNum">    4318 </span><span class="lineCov">        207 :                                         replace_idx++;</span></a>
<a name="4319"><span class="lineNum">    4319 </span>            :                                 } else {</a>
<a name="4320"><span class="lineNum">    4320 </span>            :                                         /* We've run out of replacement strings, so use an empty one. */</a>
<a name="4321"><span class="lineNum">    4321 </span><span class="lineCov">         18 :                                         replace_value = &quot;&quot;;</span></a>
<a name="4322"><span class="lineNum">    4322 </span><span class="lineCov">         18 :                                         replace_len = 0;</span></a>
<a name="4323"><span class="lineNum">    4323 </span>            :                                 }</a>
<a name="4324"><span class="lineNum">    4324 </span>            :                         }</a>
<a name="4325"><span class="lineNum">    4325 </span>            : </a>
<a name="4326"><span class="lineNum">    4326 </span><span class="lineCov">        255 :                         if (ZSTR_LEN(search_str) == 1) {</span></a>
<a name="4327"><span class="lineNum">    4327 </span><span class="lineCov">        153 :                                 zend_long old_replace_count = replace_count;</span></a>
<a name="4328"><span class="lineNum">    4328 </span>            : </a>
<a name="4329"><span class="lineNum">    4329 </span><span class="lineCov">        153 :                                 tmp_result = php_char_to_str_ex(subject_str,</span></a>
<a name="4330"><span class="lineNum">    4330 </span><span class="lineCov">        153 :                                                                 ZSTR_VAL(search_str)[0],</span></a>
<a name="4331"><span class="lineNum">    4331 </span>            :                                                                 replace_value,</a>
<a name="4332"><span class="lineNum">    4332 </span>            :                                                                 replace_len,</a>
<a name="4333"><span class="lineNum">    4333 </span>            :                                                                 case_sensitivity,</a>
<a name="4334"><span class="lineNum">    4334 </span>            :                                                                 &amp;replace_count);</a>
<a name="4335"><span class="lineNum">    4335 </span><span class="lineCov">        153 :                                 if (lc_subject_str &amp;&amp; replace_count != old_replace_count) {</span></a>
<a name="4336"><span class="lineNum">    4336 </span>            :                                         zend_string_release_ex(lc_subject_str, 0);</a>
<a name="4337"><span class="lineNum">    4337 </span><span class="lineCov">          9 :                                         lc_subject_str = NULL;</span></a>
<a name="4338"><span class="lineNum">    4338 </span>            :                                 }</a>
<a name="4339"><span class="lineNum">    4339 </span><span class="lineCov">        102 :                         } else if (ZSTR_LEN(search_str) &gt; 1) {</span></a>
<a name="4340"><span class="lineNum">    4340 </span><span class="lineCov">         99 :                                 if (case_sensitivity) {</span></a>
<a name="4341"><span class="lineNum">    4341 </span><span class="lineCov">         51 :                                         tmp_result = php_str_to_str_ex(subject_str,</span></a>
<a name="4342"><span class="lineNum">    4342 </span><span class="lineCov">         51 :                                                         ZSTR_VAL(search_str), ZSTR_LEN(search_str),</span></a>
<a name="4343"><span class="lineNum">    4343 </span>            :                                                         replace_value, replace_len, &amp;replace_count);</a>
<a name="4344"><span class="lineNum">    4344 </span>            :                                 } else {</a>
<a name="4345"><span class="lineNum">    4345 </span><span class="lineCov">         48 :                                         zend_long old_replace_count = replace_count;</span></a>
<a name="4346"><span class="lineNum">    4346 </span>            : </a>
<a name="4347"><span class="lineNum">    4347 </span><span class="lineCov">         48 :                                         if (!lc_subject_str) {</span></a>
<a name="4348"><span class="lineNum">    4348 </span><span class="lineCov">         48 :                                                 lc_subject_str = php_string_tolower(subject_str);</span></a>
<a name="4349"><span class="lineNum">    4349 </span>            :                                         }</a>
<a name="4350"><span class="lineNum">    4350 </span><span class="lineCov">         48 :                                         tmp_result = php_str_to_str_i_ex(subject_str, ZSTR_VAL(lc_subject_str),</span></a>
<a name="4351"><span class="lineNum">    4351 </span>            :                                                         search_str, replace_value, replace_len, &amp;replace_count);</a>
<a name="4352"><span class="lineNum">    4352 </span><span class="lineCov">         48 :                                         if (replace_count != old_replace_count) {</span></a>
<a name="4353"><span class="lineNum">    4353 </span>            :                                                 zend_string_release_ex(lc_subject_str, 0);</a>
<a name="4354"><span class="lineNum">    4354 </span><span class="lineCov">         27 :                                                 lc_subject_str = NULL;</span></a>
<a name="4355"><span class="lineNum">    4355 </span>            :                                         }</a>
<a name="4356"><span class="lineNum">    4356 </span>            :                                 }</a>
<a name="4357"><span class="lineNum">    4357 </span>            :                         } else {</a>
<a name="4358"><span class="lineNum">    4358 </span><span class="lineCov">          3 :                                 zend_tmp_string_release(tmp_search_str);</span></a>
<a name="4359"><span class="lineNum">    4359 </span><span class="lineCov">          3 :                                 zend_tmp_string_release(tmp_replace_entry_str);</span></a>
<a name="4360"><span class="lineNum">    4360 </span><span class="lineCov">          3 :                                 continue;</span></a>
<a name="4361"><span class="lineNum">    4361 </span>            :                         }</a>
<a name="4362"><span class="lineNum">    4362 </span>            : </a>
<a name="4363"><span class="lineNum">    4363 </span><span class="lineCov">        252 :                         zend_tmp_string_release(tmp_search_str);</span></a>
<a name="4364"><span class="lineNum">    4364 </span><span class="lineCov">        252 :                         zend_tmp_string_release(tmp_replace_entry_str);</span></a>
<a name="4365"><span class="lineNum">    4365 </span>            : </a>
<a name="4366"><span class="lineNum">    4366 </span><span class="lineCov">        252 :                         if (subject_str == tmp_result) {</span></a>
<a name="4367"><span class="lineNum">    4367 </span>            :                                 zend_string_delref(subject_str);</a>
<a name="4368"><span class="lineNum">    4368 </span>            :                         } else {</a>
<a name="4369"><span class="lineNum">    4369 </span>            :                                 zend_string_release_ex(subject_str, 0);</a>
<a name="4370"><span class="lineNum">    4370 </span><span class="lineCov">        108 :                                 subject_str = tmp_result;</span></a>
<a name="4371"><span class="lineNum">    4371 </span><span class="lineCov">        108 :                                 if (ZSTR_LEN(subject_str) == 0) {</span></a>
<a name="4372"><span class="lineNum">    4372 </span>            :                                         zend_string_release_ex(subject_str, 0);</a>
<a name="4373"><span class="lineNum">    4373 </span><span class="lineCov">          3 :                                         ZVAL_EMPTY_STRING(result);</span></a>
<a name="4374"><span class="lineNum">    4374 </span><span class="lineCov">          3 :                                         if (lc_subject_str) {</span></a>
<a name="4375"><span class="lineNum">    4375 </span>            :                                                 zend_string_release_ex(lc_subject_str, 0);</a>
<a name="4376"><span class="lineNum">    4376 </span>            :                                         }</a>
<a name="4377"><span class="lineNum">    4377 </span><span class="lineCov">          3 :                                         return replace_count;</span></a>
<a name="4378"><span class="lineNum">    4378 </span>            :                                 }</a>
<a name="4379"><span class="lineNum">    4379 </span>            :                         }</a>
<a name="4380"><span class="lineNum">    4380 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="4381"><span class="lineNum">    4381 </span><span class="lineCov">        276 :                 ZVAL_STR(result, subject_str);</span></a>
<a name="4382"><span class="lineNum">    4382 </span><span class="lineCov">        138 :                 if (lc_subject_str) {</span></a>
<a name="4383"><span class="lineNum">    4383 </span>            :                         zend_string_release_ex(lc_subject_str, 0);</a>
<a name="4384"><span class="lineNum">    4384 </span>            :                 }</a>
<a name="4385"><span class="lineNum">    4385 </span>            :         } else {</a>
<a name="4386"><span class="lineNum">    4386 </span><span class="lineCov">     334868 :                 ZEND_ASSERT(search_str);</span></a>
<a name="4387"><span class="lineNum">    4387 </span><span class="lineCov">     334868 :                 if (ZSTR_LEN(search_str) == 1) {</span></a>
<a name="4388"><span class="lineNum">    4388 </span><span class="lineCov">     648290 :                         ZVAL_STR(result,</span></a>
<a name="4389"><span class="lineNum">    4389 </span>            :                                 php_char_to_str_ex(subject_str,</a>
<a name="4390"><span class="lineNum">    4390 </span>            :                                                         ZSTR_VAL(search_str)[0],</a>
<a name="4391"><span class="lineNum">    4391 </span>            :                                                         ZSTR_VAL(replace_str),</a>
<a name="4392"><span class="lineNum">    4392 </span>            :                                                         ZSTR_LEN(replace_str),</a>
<a name="4393"><span class="lineNum">    4393 </span>            :                                                         case_sensitivity,</a>
<a name="4394"><span class="lineNum">    4394 </span>            :                                                         &amp;replace_count));</a>
<a name="4395"><span class="lineNum">    4395 </span><span class="lineCov">      10723 :                 } else if (ZSTR_LEN(search_str) &gt; 1) {</span></a>
<a name="4396"><span class="lineNum">    4396 </span><span class="lineCov">      10636 :                         if (case_sensitivity) {</span></a>
<a name="4397"><span class="lineNum">    4397 </span><span class="lineCov">      21200 :                                 ZVAL_STR(result, php_str_to_str_ex(subject_str,</span></a>
<a name="4398"><span class="lineNum">    4398 </span>            :                                                 ZSTR_VAL(search_str), ZSTR_LEN(search_str),</a>
<a name="4399"><span class="lineNum">    4399 </span>            :                                                 ZSTR_VAL(replace_str), ZSTR_LEN(replace_str), &amp;replace_count));</a>
<a name="4400"><span class="lineNum">    4400 </span>            :                         } else {</a>
<a name="4401"><span class="lineNum">    4401 </span><span class="lineCov">         36 :                                 lc_subject_str = php_string_tolower(subject_str);</span></a>
<a name="4402"><span class="lineNum">    4402 </span><span class="lineCov">         72 :                                 ZVAL_STR(result, php_str_to_str_i_ex(subject_str, ZSTR_VAL(lc_subject_str),</span></a>
<a name="4403"><span class="lineNum">    4403 </span>            :                                                 search_str, ZSTR_VAL(replace_str), ZSTR_LEN(replace_str), &amp;replace_count));</a>
<a name="4404"><span class="lineNum">    4404 </span>            :                                 zend_string_release_ex(lc_subject_str, 0);</a>
<a name="4405"><span class="lineNum">    4405 </span>            :                         }</a>
<a name="4406"><span class="lineNum">    4406 </span>            :                 } else {</a>
<a name="4407"><span class="lineNum">    4407 </span><span class="lineCov">        201 :                         ZVAL_STR_COPY(result, subject_str);</span></a>
<a name="4408"><span class="lineNum">    4408 </span>            :                 }</a>
<a name="4409"><span class="lineNum">    4409 </span>            :         }</a>
<a name="4410"><span class="lineNum">    4410 </span><span class="lineCov">     335006 :         return replace_count;</span></a>
<a name="4411"><span class="lineNum">    4411 </span>            : }</a>
<a name="4412"><span class="lineNum">    4412 </span>            : /* }}} */</a>
<a name="4413"><span class="lineNum">    4413 </span>            : </a>
<a name="4414"><span class="lineNum">    4414 </span>            : /* {{{ php_str_replace_common */</a>
<a name="4415"><span class="lineNum">    4415 </span><span class="lineCov">     334739 : static void php_str_replace_common(INTERNAL_FUNCTION_PARAMETERS, int case_sensitivity)</span></a>
<a name="4416"><span class="lineNum">    4416 </span>            : {</a>
<a name="4417"><span class="lineNum">    4417 </span>            :         zend_string *search_str;</a>
<a name="4418"><span class="lineNum">    4418 </span>            :         HashTable *search_ht;</a>
<a name="4419"><span class="lineNum">    4419 </span>            :         zend_string *replace_str;</a>
<a name="4420"><span class="lineNum">    4420 </span>            :         HashTable *replace_ht;</a>
<a name="4421"><span class="lineNum">    4421 </span>            :         zend_string *subject_str;</a>
<a name="4422"><span class="lineNum">    4422 </span>            :         HashTable *subject_ht;</a>
<a name="4423"><span class="lineNum">    4423 </span><span class="lineCov">     334739 :         zval *subject_entry, *zcount = NULL;</span></a>
<a name="4424"><span class="lineNum">    4424 </span>            :         zval result;</a>
<a name="4425"><span class="lineNum">    4425 </span>            :         zend_string *string_key;</a>
<a name="4426"><span class="lineNum">    4426 </span>            :         zend_ulong num_key;</a>
<a name="4427"><span class="lineNum">    4427 </span><span class="lineCov">     334739 :         zend_long count = 0;</span></a>
<a name="4428"><span class="lineNum">    4428 </span>            : </a>
<a name="4429"><span class="lineNum">    4429 </span><span class="lineCov">     334739 :         ZEND_PARSE_PARAMETERS_START(3, 4)</span></a>
<a name="4430"><span class="lineNum">    4430 </span><span class="lineCov">     669406 :                 Z_PARAM_ARRAY_HT_OR_STR(search_ht, search_str)</span></a>
<a name="4431"><span class="lineNum">    4431 </span><span class="lineCov">     669388 :                 Z_PARAM_ARRAY_HT_OR_STR(replace_ht, replace_str)</span></a>
<a name="4432"><span class="lineNum">    4432 </span><span class="lineCov">     669388 :                 Z_PARAM_ARRAY_HT_OR_STR(subject_ht, subject_str)</span></a>
<a name="4433"><span class="lineNum">    4433 </span><span class="lineCov">     334688 :                 Z_PARAM_OPTIONAL</span></a>
<a name="4434"><span class="lineNum">    4434 </span><span class="lineCov">     334688 :                 Z_PARAM_ZVAL(zcount)</span></a>
<a name="4435"><span class="lineNum">    4435 </span><span class="lineCov">     334742 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="4436"><span class="lineNum">    4436 </span>            : </a>
<a name="4437"><span class="lineNum">    4437 </span>            :         /* Make sure we're dealing with strings and do the replacement. */</a>
<a name="4438"><span class="lineNum">    4438 </span><span class="lineCov">     334688 :         if (search_str &amp;&amp; replace_ht) {</span></a>
<a name="4439"><span class="lineNum">    4439 </span><span class="lineCov">          6 :                 zend_argument_type_error(2, &quot;must be of type %s when argument #1 ($search) is %s&quot;,</span></a>
<a name="4440"><span class="lineNum">    4440 </span><span class="lineCov">          6 :                         search_str ? &quot;string&quot; : &quot;array&quot;, search_str ? &quot;a string&quot; : &quot;an array&quot;</span></a>
<a name="4441"><span class="lineNum">    4441 </span>            :                 );</a>
<a name="4442"><span class="lineNum">    4442 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="4443"><span class="lineNum">    4443 </span>            :         }</a>
<a name="4444"><span class="lineNum">    4444 </span>            : </a>
<a name="4445"><span class="lineNum">    4445 </span>            :         /* if subject is an array */</a>
<a name="4446"><span class="lineNum">    4446 </span><span class="lineCov">     334685 :         if (subject_ht) {</span></a>
<a name="4447"><span class="lineNum">    4447 </span><span class="lineCov">         84 :                 array_init(return_value);</span></a>
<a name="4448"><span class="lineNum">    4448 </span>            : </a>
<a name="4449"><span class="lineNum">    4449 </span>            :                 /* For each subject entry, convert it to string, then perform replacement</a>
<a name="4450"><span class="lineNum">    4450 </span>            :                    and add the result to the return_value array. */</a>
<a name="4451"><span class="lineNum">    4451 </span><span class="lineCov">       1206 :                 ZEND_HASH_FOREACH_KEY_VAL(subject_ht, num_key, string_key, subject_entry) {</span></a>
<a name="4452"><span class="lineNum">    4452 </span>            :                         zend_string *tmp_subject_str;</a>
<a name="4453"><span class="lineNum">    4453 </span><span class="lineCov">        561 :                         ZVAL_DEREF(subject_entry);</span></a>
<a name="4454"><span class="lineNum">    4454 </span><span class="lineCov">        561 :                         subject_str = zval_get_tmp_string(subject_entry, &amp;tmp_subject_str);</span></a>
<a name="4455"><span class="lineNum">    4455 </span><span class="lineCov">        561 :                         count += php_str_replace_in_subject(search_str, search_ht, replace_str, replace_ht, subject_str, &amp;result, case_sensitivity);</span></a>
<a name="4456"><span class="lineNum">    4456 </span><span class="lineCov">        561 :                         zend_tmp_string_release(tmp_subject_str);</span></a>
<a name="4457"><span class="lineNum">    4457 </span>            : </a>
<a name="4458"><span class="lineNum">    4458 </span>            :                         /* Add to return array */</a>
<a name="4459"><span class="lineNum">    4459 </span><span class="lineCov">        561 :                         if (string_key) {</span></a>
<a name="4460"><span class="lineNum">    4460 </span><span class="lineCov">         12 :                                 zend_hash_add_new(Z_ARRVAL_P(return_value), string_key, &amp;result);</span></a>
<a name="4461"><span class="lineNum">    4461 </span>            :                         } else {</a>
<a name="4462"><span class="lineNum">    4462 </span><span class="lineCov">        549 :                                 zend_hash_index_add_new(Z_ARRVAL_P(return_value), num_key, &amp;result);</span></a>
<a name="4463"><span class="lineNum">    4463 </span>            :                         }</a>
<a name="4464"><span class="lineNum">    4464 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="4465"><span class="lineNum">    4465 </span>            :         } else {        /* if subject is not an array */</a>
<a name="4466"><span class="lineNum">    4466 </span><span class="lineCov">     334601 :                 count = php_str_replace_in_subject(search_str, search_ht, replace_str, replace_ht, subject_str, return_value, case_sensitivity);</span></a>
<a name="4467"><span class="lineNum">    4467 </span>            :         }</a>
<a name="4468"><span class="lineNum">    4468 </span><span class="lineCov">     334685 :         if (zcount) {</span></a>
<a name="4469"><span class="lineNum">    4469 </span><span class="lineCov">        420 :                 ZEND_TRY_ASSIGN_REF_LONG(zcount, count);</span></a>
<a name="4470"><span class="lineNum">    4470 </span>            :         }</a>
<a name="4471"><span class="lineNum">    4471 </span>            : }</a>
<a name="4472"><span class="lineNum">    4472 </span>            : /* }}} */</a>
<a name="4473"><span class="lineNum">    4473 </span>            : </a>
<a name="4474"><span class="lineNum">    4474 </span>            : /* {{{ Replaces all occurrences of search in haystack with replace */</a>
<a name="4475"><span class="lineNum">    4475 </span><span class="lineCov">     334643 : PHP_FUNCTION(str_replace)</span></a>
<a name="4476"><span class="lineNum">    4476 </span>            : {</a>
<a name="4477"><span class="lineNum">    4477 </span><span class="lineCov">     334643 :         php_str_replace_common(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1);</span></a>
<a name="4478"><span class="lineNum">    4478 </span><span class="lineCov">     334643 : }</span></a>
<a name="4479"><span class="lineNum">    4479 </span>            : /* }}} */</a>
<a name="4480"><span class="lineNum">    4480 </span>            : </a>
<a name="4481"><span class="lineNum">    4481 </span>            : /* {{{ Replaces all occurrences of search in haystack with replace / case-insensitive */</a>
<a name="4482"><span class="lineNum">    4482 </span><span class="lineCov">         96 : PHP_FUNCTION(str_ireplace)</span></a>
<a name="4483"><span class="lineNum">    4483 </span>            : {</a>
<a name="4484"><span class="lineNum">    4484 </span><span class="lineCov">         96 :         php_str_replace_common(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0);</span></a>
<a name="4485"><span class="lineNum">    4485 </span><span class="lineCov">         96 : }</span></a>
<a name="4486"><span class="lineNum">    4486 </span>            : /* }}} */</a>
<a name="4487"><span class="lineNum">    4487 </span>            : </a>
<a name="4488"><span class="lineNum">    4488 </span>            : /* {{{ Converts logical Hebrew text to visual text */</a>
<a name="4489"><span class="lineNum">    4489 </span><span class="lineCov">         60 : PHP_FUNCTION(hebrev)</span></a>
<a name="4490"><span class="lineNum">    4490 </span>            : {</a>
<a name="4491"><span class="lineNum">    4491 </span>            :         char *str, *heb_str, *target;</a>
<a name="4492"><span class="lineNum">    4492 </span>            :         const char *tmp;</a>
<a name="4493"><span class="lineNum">    4493 </span>            :         size_t block_start, block_end, block_type, block_length, i;</a>
<a name="4494"><span class="lineNum">    4494 </span><span class="lineCov">         60 :         zend_long max_chars=0, char_count;</span></a>
<a name="4495"><span class="lineNum">    4495 </span>            :         size_t begin, end, orig_begin;</a>
<a name="4496"><span class="lineNum">    4496 </span>            :         size_t str_len;</a>
<a name="4497"><span class="lineNum">    4497 </span>            :         zend_string *broken_str;</a>
<a name="4498"><span class="lineNum">    4498 </span>            : </a>
<a name="4499"><span class="lineNum">    4499 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="4500"><span class="lineNum">    4500 </span><span class="lineCov">         36 :                 Z_PARAM_STRING(str, str_len)</span></a>
<a name="4501"><span class="lineNum">    4501 </span><span class="lineCov">         12 :                 Z_PARAM_OPTIONAL</span></a>
<a name="4502"><span class="lineNum">    4502 </span><span class="lineCov">         18 :                 Z_PARAM_LONG(max_chars)</span></a>
<a name="4503"><span class="lineNum">    4503 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="4504"><span class="lineNum">    4504 </span>            : </a>
<a name="4505"><span class="lineNum">    4505 </span><span class="lineCov">         12 :         if (str_len == 0) {</span></a>
<a name="4506"><span class="lineNum">    4506 </span><span class="lineCov">          6 :                 RETURN_EMPTY_STRING();</span></a>
<a name="4507"><span class="lineNum">    4507 </span>            :         }</a>
<a name="4508"><span class="lineNum">    4508 </span>            : </a>
<a name="4509"><span class="lineNum">    4509 </span><span class="lineCov">          6 :         tmp = str;</span></a>
<a name="4510"><span class="lineNum">    4510 </span><span class="lineCov">          6 :         block_start=block_end=0;</span></a>
<a name="4511"><span class="lineNum">    4511 </span>            : </a>
<a name="4512"><span class="lineNum">    4512 </span><span class="lineCov">          6 :         heb_str = (char *) emalloc(str_len+1);</span></a>
<a name="4513"><span class="lineNum">    4513 </span><span class="lineCov">          6 :         target = heb_str+str_len;</span></a>
<a name="4514"><span class="lineNum">    4514 </span><span class="lineCov">          6 :         *target = 0;</span></a>
<a name="4515"><span class="lineNum">    4515 </span><span class="lineCov">          6 :         target--;</span></a>
<a name="4516"><span class="lineNum">    4516 </span>            : </a>
<a name="4517"><span class="lineNum">    4517 </span><span class="lineCov">          6 :         block_length=0;</span></a>
<a name="4518"><span class="lineNum">    4518 </span>            : </a>
<a name="4519"><span class="lineNum">    4519 </span><span class="lineCov">          6 :         if (isheb(*tmp)) {</span></a>
<a name="4520"><span class="lineNum">    4520 </span><span class="lineNoCov">          0 :                 block_type = _HEB_BLOCK_TYPE_HEB;</span></a>
<a name="4521"><span class="lineNum">    4521 </span>            :         } else {</a>
<a name="4522"><span class="lineNum">    4522 </span><span class="lineCov">          6 :                 block_type = _HEB_BLOCK_TYPE_ENG;</span></a>
<a name="4523"><span class="lineNum">    4523 </span>            :         }</a>
<a name="4524"><span class="lineNum">    4524 </span>            : </a>
<a name="4525"><span class="lineNum">    4525 </span>            :         do {</a>
<a name="4526"><span class="lineNum">    4526 </span><span class="lineCov">         24 :                 if (block_type == _HEB_BLOCK_TYPE_HEB) {</span></a>
<a name="4527"><span class="lineNum">    4527 </span><span class="lineCov">         36 :                         while ((isheb((int)*(tmp+1)) || _isblank((int)*(tmp+1)) || ispunct((int)*(tmp+1)) || (int)*(tmp+1)=='\n' ) &amp;&amp; block_end&lt;str_len-1) {</span></a>
<a name="4528"><span class="lineNum">    4528 </span><span class="lineCov">         24 :                                 tmp++;</span></a>
<a name="4529"><span class="lineNum">    4529 </span><span class="lineCov">         24 :                                 block_end++;</span></a>
<a name="4530"><span class="lineNum">    4530 </span><span class="lineCov">         24 :                                 block_length++;</span></a>
<a name="4531"><span class="lineNum">    4531 </span>            :                         }</a>
<a name="4532"><span class="lineNum">    4532 </span><span class="lineCov">         36 :                         for (i = block_start+1; i&lt;= block_end+1; i++) {</span></a>
<a name="4533"><span class="lineNum">    4533 </span><span class="lineCov">         24 :                                 *target = str[i-1];</span></a>
<a name="4534"><span class="lineNum">    4534 </span><span class="lineCov">         24 :                                 switch (*target) {</span></a>
<a name="4535"><span class="lineNum">    4535 </span><span class="lineNoCov">          0 :                                         case '(':</span></a>
<a name="4536"><span class="lineNum">    4536 </span><span class="lineNoCov">          0 :                                                 *target = ')';</span></a>
<a name="4537"><span class="lineNum">    4537 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4538"><span class="lineNum">    4538 </span><span class="lineNoCov">          0 :                                         case ')':</span></a>
<a name="4539"><span class="lineNum">    4539 </span><span class="lineNoCov">          0 :                                                 *target = '(';</span></a>
<a name="4540"><span class="lineNum">    4540 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4541"><span class="lineNum">    4541 </span><span class="lineNoCov">          0 :                                         case '[':</span></a>
<a name="4542"><span class="lineNum">    4542 </span><span class="lineNoCov">          0 :                                                 *target = ']';</span></a>
<a name="4543"><span class="lineNum">    4543 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4544"><span class="lineNum">    4544 </span><span class="lineNoCov">          0 :                                         case ']':</span></a>
<a name="4545"><span class="lineNum">    4545 </span><span class="lineNoCov">          0 :                                                 *target = '[';</span></a>
<a name="4546"><span class="lineNum">    4546 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4547"><span class="lineNum">    4547 </span><span class="lineNoCov">          0 :                                         case '{':</span></a>
<a name="4548"><span class="lineNum">    4548 </span><span class="lineNoCov">          0 :                                                 *target = '}';</span></a>
<a name="4549"><span class="lineNum">    4549 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4550"><span class="lineNum">    4550 </span><span class="lineNoCov">          0 :                                         case '}':</span></a>
<a name="4551"><span class="lineNum">    4551 </span><span class="lineNoCov">          0 :                                                 *target = '{';</span></a>
<a name="4552"><span class="lineNum">    4552 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4553"><span class="lineNum">    4553 </span><span class="lineNoCov">          0 :                                         case '&lt;':</span></a>
<a name="4554"><span class="lineNum">    4554 </span><span class="lineNoCov">          0 :                                                 *target = '&gt;';</span></a>
<a name="4555"><span class="lineNum">    4555 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4556"><span class="lineNum">    4556 </span><span class="lineNoCov">          0 :                                         case '&gt;':</span></a>
<a name="4557"><span class="lineNum">    4557 </span><span class="lineNoCov">          0 :                                                 *target = '&lt;';</span></a>
<a name="4558"><span class="lineNum">    4558 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4559"><span class="lineNum">    4559 </span><span class="lineNoCov">          0 :                                         case '\\':</span></a>
<a name="4560"><span class="lineNum">    4560 </span><span class="lineNoCov">          0 :                                                 *target = '/';</span></a>
<a name="4561"><span class="lineNum">    4561 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4562"><span class="lineNum">    4562 </span><span class="lineNoCov">          0 :                                         case '/':</span></a>
<a name="4563"><span class="lineNum">    4563 </span><span class="lineNoCov">          0 :                                                 *target = '\\';</span></a>
<a name="4564"><span class="lineNum">    4564 </span><span class="lineNoCov">          0 :                                                 break;</span></a>
<a name="4565"><span class="lineNum">    4565 </span><span class="lineCov">         24 :                                         default:</span></a>
<a name="4566"><span class="lineNum">    4566 </span><span class="lineCov">         24 :                                                 break;</span></a>
<a name="4567"><span class="lineNum">    4567 </span>            :                                 }</a>
<a name="4568"><span class="lineNum">    4568 </span><span class="lineCov">         24 :                                 target--;</span></a>
<a name="4569"><span class="lineNum">    4569 </span>            :                         }</a>
<a name="4570"><span class="lineNum">    4570 </span><span class="lineCov">         12 :                         block_type = _HEB_BLOCK_TYPE_ENG;</span></a>
<a name="4571"><span class="lineNum">    4571 </span>            :                 } else {</a>
<a name="4572"><span class="lineNum">    4572 </span><span class="lineCov">        648 :                         while (!isheb(*(tmp+1)) &amp;&amp; (int)*(tmp+1)!='\n' &amp;&amp; block_end &lt; str_len-1) {</span></a>
<a name="4573"><span class="lineNum">    4573 </span><span class="lineCov">        636 :                                 tmp++;</span></a>
<a name="4574"><span class="lineNum">    4574 </span><span class="lineCov">        636 :                                 block_end++;</span></a>
<a name="4575"><span class="lineNum">    4575 </span><span class="lineCov">        636 :                                 block_length++;</span></a>
<a name="4576"><span class="lineNum">    4576 </span>            :                         }</a>
<a name="4577"><span class="lineNum">    4577 </span><span class="lineCov">         24 :                         while ((_isblank((int)*tmp) || ispunct((int)*tmp)) &amp;&amp; *tmp!='/' &amp;&amp; *tmp!='-' &amp;&amp; block_end &gt; block_start) {</span></a>
<a name="4578"><span class="lineNum">    4578 </span><span class="lineCov">         12 :                                 tmp--;</span></a>
<a name="4579"><span class="lineNum">    4579 </span><span class="lineCov">         12 :                                 block_end--;</span></a>
<a name="4580"><span class="lineNum">    4580 </span>            :                         }</a>
<a name="4581"><span class="lineNum">    4581 </span><span class="lineCov">        642 :                         for (i = block_end+1; i &gt;= block_start+1; i--) {</span></a>
<a name="4582"><span class="lineNum">    4582 </span><span class="lineCov">        630 :                                 *target = str[i-1];</span></a>
<a name="4583"><span class="lineNum">    4583 </span><span class="lineCov">        630 :                                 target--;</span></a>
<a name="4584"><span class="lineNum">    4584 </span>            :                         }</a>
<a name="4585"><span class="lineNum">    4585 </span><span class="lineCov">         12 :                         block_type = _HEB_BLOCK_TYPE_HEB;</span></a>
<a name="4586"><span class="lineNum">    4586 </span>            :                 }</a>
<a name="4587"><span class="lineNum">    4587 </span><span class="lineCov">         24 :                 block_start=block_end+1;</span></a>
<a name="4588"><span class="lineNum">    4588 </span><span class="lineCov">         24 :         } while (block_end &lt; str_len-1);</span></a>
<a name="4589"><span class="lineNum">    4589 </span>            : </a>
<a name="4590"><span class="lineNum">    4590 </span>            : </a>
<a name="4591"><span class="lineNum">    4591 </span><span class="lineCov">          6 :         broken_str = zend_string_alloc(str_len, 0);</span></a>
<a name="4592"><span class="lineNum">    4592 </span><span class="lineCov">          6 :         begin = end = str_len-1;</span></a>
<a name="4593"><span class="lineNum">    4593 </span><span class="lineCov">          6 :         target = ZSTR_VAL(broken_str);</span></a>
<a name="4594"><span class="lineNum">    4594 </span>            : </a>
<a name="4595"><span class="lineNum">    4595 </span>            :         while (1) {</a>
<a name="4596"><span class="lineNum">    4596 </span><span class="lineCov">         33 :                 char_count=0;</span></a>
<a name="4597"><span class="lineNum">    4597 </span><span class="lineCov">        708 :                 while ((!max_chars || (max_chars &gt; 0 &amp;&amp; char_count &lt; max_chars)) &amp;&amp; begin &gt; 0) {</span></a>
<a name="4598"><span class="lineNum">    4598 </span><span class="lineCov">        687 :                         char_count++;</span></a>
<a name="4599"><span class="lineNum">    4599 </span><span class="lineCov">        687 :                         begin--;</span></a>
<a name="4600"><span class="lineNum">    4600 </span><span class="lineCov">        687 :                         if (_isnewline(heb_str[begin])) {</span></a>
<a name="4601"><span class="lineNum">    4601 </span><span class="lineCov">         12 :                                 while (begin &gt; 0 &amp;&amp; _isnewline(heb_str[begin-1])) {</span></a>
<a name="4602"><span class="lineNum">    4602 </span><span class="lineNoCov">          0 :                                         begin--;</span></a>
<a name="4603"><span class="lineNum">    4603 </span><span class="lineNoCov">          0 :                                         char_count++;</span></a>
<a name="4604"><span class="lineNum">    4604 </span>            :                                 }</a>
<a name="4605"><span class="lineNum">    4605 </span><span class="lineCov">         12 :                                 break;</span></a>
<a name="4606"><span class="lineNum">    4606 </span>            :                         }</a>
<a name="4607"><span class="lineNum">    4607 </span>            :                 }</a>
<a name="4608"><span class="lineNum">    4608 </span><span class="lineCov">         33 :                 if (max_chars &gt;= 0 &amp;&amp; char_count == max_chars) { /* try to avoid breaking words */</span></a>
<a name="4609"><span class="lineNum">    4609 </span><span class="lineCov">         21 :                         size_t new_char_count=char_count, new_begin=begin;</span></a>
<a name="4610"><span class="lineNum">    4610 </span>            : </a>
<a name="4611"><span class="lineNum">    4611 </span><span class="lineCov">         87 :                         while (new_char_count &gt; 0) {</span></a>
<a name="4612"><span class="lineNum">    4612 </span><span class="lineCov">         87 :                                 if (_isblank(heb_str[new_begin]) || _isnewline(heb_str[new_begin])) {</span></a>
<a name="4613"><span class="lineNum">    4613 </span>            :                                         break;</a>
<a name="4614"><span class="lineNum">    4614 </span>            :                                 }</a>
<a name="4615"><span class="lineNum">    4615 </span><span class="lineCov">         66 :                                 new_begin++;</span></a>
<a name="4616"><span class="lineNum">    4616 </span><span class="lineCov">         66 :                                 new_char_count--;</span></a>
<a name="4617"><span class="lineNum">    4617 </span>            :                         }</a>
<a name="4618"><span class="lineNum">    4618 </span><span class="lineCov">         21 :                         if (new_char_count &gt; 0) {</span></a>
<a name="4619"><span class="lineNum">    4619 </span><span class="lineCov">         21 :                                 begin=new_begin;</span></a>
<a name="4620"><span class="lineNum">    4620 </span>            :                         }</a>
<a name="4621"><span class="lineNum">    4621 </span>            :                 }</a>
<a name="4622"><span class="lineNum">    4622 </span><span class="lineCov">         33 :                 orig_begin=begin;</span></a>
<a name="4623"><span class="lineNum">    4623 </span>            : </a>
<a name="4624"><span class="lineNum">    4624 </span><span class="lineCov">         33 :                 if (_isblank(heb_str[begin])) {</span></a>
<a name="4625"><span class="lineNum">    4625 </span><span class="lineCov">         21 :                         heb_str[begin]='\n';</span></a>
<a name="4626"><span class="lineNum">    4626 </span>            :                 }</a>
<a name="4627"><span class="lineNum">    4627 </span><span class="lineCov">         66 :                 while (begin &lt;= end &amp;&amp; _isnewline(heb_str[begin])) { /* skip leading newlines */</span></a>
<a name="4628"><span class="lineNum">    4628 </span><span class="lineCov">         33 :                         begin++;</span></a>
<a name="4629"><span class="lineNum">    4629 </span>            :                 }</a>
<a name="4630"><span class="lineNum">    4630 </span><span class="lineCov">        654 :                 for (i = begin; i &lt;= end; i++) { /* copy content */</span></a>
<a name="4631"><span class="lineNum">    4631 </span><span class="lineCov">        621 :                         *target = heb_str[i];</span></a>
<a name="4632"><span class="lineNum">    4632 </span><span class="lineCov">        621 :                         target++;</span></a>
<a name="4633"><span class="lineNum">    4633 </span>            :                 }</a>
<a name="4634"><span class="lineNum">    4634 </span><span class="lineCov">         66 :                 for (i = orig_begin; i &lt;= end &amp;&amp; _isnewline(heb_str[i]); i++) {</span></a>
<a name="4635"><span class="lineNum">    4635 </span><span class="lineCov">         33 :                         *target = heb_str[i];</span></a>
<a name="4636"><span class="lineNum">    4636 </span><span class="lineCov">         33 :                         target++;</span></a>
<a name="4637"><span class="lineNum">    4637 </span>            :                 }</a>
<a name="4638"><span class="lineNum">    4638 </span><span class="lineCov">         33 :                 begin=orig_begin;</span></a>
<a name="4639"><span class="lineNum">    4639 </span>            : </a>
<a name="4640"><span class="lineNum">    4640 </span><span class="lineCov">         33 :                 if (begin == 0) {</span></a>
<a name="4641"><span class="lineNum">    4641 </span><span class="lineCov">          6 :                         *target = 0;</span></a>
<a name="4642"><span class="lineNum">    4642 </span><span class="lineCov">          6 :                         break;</span></a>
<a name="4643"><span class="lineNum">    4643 </span>            :                 }</a>
<a name="4644"><span class="lineNum">    4644 </span><span class="lineCov">         27 :                 begin--;</span></a>
<a name="4645"><span class="lineNum">    4645 </span><span class="lineCov">         27 :                 end=begin;</span></a>
<a name="4646"><span class="lineNum">    4646 </span>            :         }</a>
<a name="4647"><span class="lineNum">    4647 </span><span class="lineCov">          6 :         efree(heb_str);</span></a>
<a name="4648"><span class="lineNum">    4648 </span>            : </a>
<a name="4649"><span class="lineNum">    4649 </span><span class="lineCov">          6 :         RETURN_NEW_STR(broken_str);</span></a>
<a name="4650"><span class="lineNum">    4650 </span>            : }</a>
<a name="4651"><span class="lineNum">    4651 </span>            : /* }}} */</a>
<a name="4652"><span class="lineNum">    4652 </span>            : </a>
<a name="4653"><span class="lineNum">    4653 </span>            : /* {{{ Converts newlines to HTML line breaks */</a>
<a name="4654"><span class="lineNum">    4654 </span><span class="lineCov">        153 : PHP_FUNCTION(nl2br)</span></a>
<a name="4655"><span class="lineNum">    4655 </span>            : {</a>
<a name="4656"><span class="lineNum">    4656 </span>            :         /* in brief this inserts &lt;br /&gt; or &lt;br&gt; before matched regexp \n\r?|\r\n? */</a>
<a name="4657"><span class="lineNum">    4657 </span>            :         const char      *tmp, *end;</a>
<a name="4658"><span class="lineNum">    4658 </span>            :         zend_string *str;</a>
<a name="4659"><span class="lineNum">    4659 </span>            :         char *target;</a>
<a name="4660"><span class="lineNum">    4660 </span><span class="lineCov">        153 :         size_t  repl_cnt = 0;</span></a>
<a name="4661"><span class="lineNum">    4661 </span><span class="lineCov">        153 :         bool    is_xhtml = 1;</span></a>
<a name="4662"><span class="lineNum">    4662 </span>            :         zend_string *result;</a>
<a name="4663"><span class="lineNum">    4663 </span>            : </a>
<a name="4664"><span class="lineNum">    4664 </span><span class="lineCov">        153 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="4665"><span class="lineNum">    4665 </span><span class="lineCov">        222 :                 Z_PARAM_STR(str)</span></a>
<a name="4666"><span class="lineNum">    4666 </span><span class="lineCov">        105 :                 Z_PARAM_OPTIONAL</span></a>
<a name="4667"><span class="lineNum">    4667 </span><span class="lineCov">        108 :                 Z_PARAM_BOOL(is_xhtml)</span></a>
<a name="4668"><span class="lineNum">    4668 </span><span class="lineCov">        153 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="4669"><span class="lineNum">    4669 </span>            : </a>
<a name="4670"><span class="lineNum">    4670 </span><span class="lineCov">        105 :         tmp = ZSTR_VAL(str);</span></a>
<a name="4671"><span class="lineNum">    4671 </span><span class="lineCov">        105 :         end = ZSTR_VAL(str) + ZSTR_LEN(str);</span></a>
<a name="4672"><span class="lineNum">    4672 </span>            : </a>
<a name="4673"><span class="lineNum">    4673 </span>            :         /* it is really faster to scan twice and allocate mem once instead of scanning once</a>
<a name="4674"><span class="lineNum">    4674 </span>            :            and constantly reallocing */</a>
<a name="4675"><span class="lineNum">    4675 </span><span class="lineCov">       1170 :         while (tmp &lt; end) {</span></a>
<a name="4676"><span class="lineNum">    4676 </span><span class="lineCov">       1065 :                 if (*tmp == '\r') {</span></a>
<a name="4677"><span class="lineNum">    4677 </span><span class="lineCov">         99 :                         if (*(tmp+1) == '\n') {</span></a>
<a name="4678"><span class="lineNum">    4678 </span><span class="lineCov">         42 :                                 tmp++;</span></a>
<a name="4679"><span class="lineNum">    4679 </span>            :                         }</a>
<a name="4680"><span class="lineNum">    4680 </span><span class="lineCov">         99 :                         repl_cnt++;</span></a>
<a name="4681"><span class="lineNum">    4681 </span><span class="lineCov">        966 :                 } else if (*tmp == '\n') {</span></a>
<a name="4682"><span class="lineNum">    4682 </span><span class="lineCov">        138 :                         if (*(tmp+1) == '\r') {</span></a>
<a name="4683"><span class="lineNum">    4683 </span><span class="lineCov">         39 :                                 tmp++;</span></a>
<a name="4684"><span class="lineNum">    4684 </span>            :                         }</a>
<a name="4685"><span class="lineNum">    4685 </span><span class="lineCov">        138 :                         repl_cnt++;</span></a>
<a name="4686"><span class="lineNum">    4686 </span>            :                 }</a>
<a name="4687"><span class="lineNum">    4687 </span>            : </a>
<a name="4688"><span class="lineNum">    4688 </span><span class="lineCov">       1065 :                 tmp++;</span></a>
<a name="4689"><span class="lineNum">    4689 </span>            :         }</a>
<a name="4690"><span class="lineNum">    4690 </span>            : </a>
<a name="4691"><span class="lineNum">    4691 </span><span class="lineCov">        105 :         if (repl_cnt == 0) {</span></a>
<a name="4692"><span class="lineNum">    4692 </span><span class="lineCov">         96 :                 RETURN_STR_COPY(str);</span></a>
<a name="4693"><span class="lineNum">    4693 </span>            :         }</a>
<a name="4694"><span class="lineNum">    4694 </span>            : </a>
<a name="4695"><span class="lineNum">    4695 </span>            :         {</a>
<a name="4696"><span class="lineNum">    4696 </span><span class="lineCov">         69 :                 size_t repl_len = is_xhtml ? (sizeof(&quot;&lt;br /&gt;&quot;) - 1) : (sizeof(&quot;&lt;br&gt;&quot;) - 1);</span></a>
<a name="4697"><span class="lineNum">    4697 </span>            : </a>
<a name="4698"><span class="lineNum">    4698 </span><span class="lineCov">         69 :                 result = zend_string_safe_alloc(repl_cnt, repl_len, ZSTR_LEN(str), 0);</span></a>
<a name="4699"><span class="lineNum">    4699 </span><span class="lineCov">         69 :                 target = ZSTR_VAL(result);</span></a>
<a name="4700"><span class="lineNum">    4700 </span>            :         }</a>
<a name="4701"><span class="lineNum">    4701 </span>            : </a>
<a name="4702"><span class="lineNum">    4702 </span><span class="lineCov">         69 :         tmp = ZSTR_VAL(str);</span></a>
<a name="4703"><span class="lineNum">    4703 </span><span class="lineCov">        840 :         while (tmp &lt; end) {</span></a>
<a name="4704"><span class="lineNum">    4704 </span><span class="lineCov">        771 :                 switch (*tmp) {</span></a>
<a name="4705"><span class="lineNum">    4705 </span><span class="lineCov">        237 :                         case '\r':</span></a>
<a name="4706"><span class="lineNum">    4706 </span>            :                         case '\n':</a>
<a name="4707"><span class="lineNum">    4707 </span><span class="lineCov">        237 :                                 *target++ = '&lt;';</span></a>
<a name="4708"><span class="lineNum">    4708 </span><span class="lineCov">        237 :                                 *target++ = 'b';</span></a>
<a name="4709"><span class="lineNum">    4709 </span><span class="lineCov">        237 :                                 *target++ = 'r';</span></a>
<a name="4710"><span class="lineNum">    4710 </span>            : </a>
<a name="4711"><span class="lineNum">    4711 </span><span class="lineCov">        237 :                                 if (is_xhtml) {</span></a>
<a name="4712"><span class="lineNum">    4712 </span><span class="lineCov">        237 :                                         *target++ = ' ';</span></a>
<a name="4713"><span class="lineNum">    4713 </span><span class="lineCov">        237 :                                         *target++ = '/';</span></a>
<a name="4714"><span class="lineNum">    4714 </span>            :                                 }</a>
<a name="4715"><span class="lineNum">    4715 </span>            : </a>
<a name="4716"><span class="lineNum">    4716 </span><span class="lineCov">        237 :                                 *target++ = '&gt;';</span></a>
<a name="4717"><span class="lineNum">    4717 </span>            : </a>
<a name="4718"><span class="lineNum">    4718 </span><span class="lineCov">        237 :                                 if ((*tmp == '\r' &amp;&amp; *(tmp+1) == '\n') || (*tmp == '\n' &amp;&amp; *(tmp+1) == '\r')) {</span></a>
<a name="4719"><span class="lineNum">    4719 </span><span class="lineCov">         81 :                                         *target++ = *tmp++;</span></a>
<a name="4720"><span class="lineNum">    4720 </span>            :                                 }</a>
<a name="4721"><span class="lineNum">    4721 </span>            :                                 ZEND_FALLTHROUGH;</a>
<a name="4722"><span class="lineNum">    4722 </span>            :                         default:</a>
<a name="4723"><span class="lineNum">    4723 </span><span class="lineCov">        771 :                                 *target++ = *tmp;</span></a>
<a name="4724"><span class="lineNum">    4724 </span>            :                 }</a>
<a name="4725"><span class="lineNum">    4725 </span>            : </a>
<a name="4726"><span class="lineNum">    4726 </span><span class="lineCov">        771 :                 tmp++;</span></a>
<a name="4727"><span class="lineNum">    4727 </span>            :         }</a>
<a name="4728"><span class="lineNum">    4728 </span>            : </a>
<a name="4729"><span class="lineNum">    4729 </span><span class="lineCov">         69 :         *target = '\0';</span></a>
<a name="4730"><span class="lineNum">    4730 </span>            : </a>
<a name="4731"><span class="lineNum">    4731 </span><span class="lineCov">         69 :         RETURN_NEW_STR(result);</span></a>
<a name="4732"><span class="lineNum">    4732 </span>            : }</a>
<a name="4733"><span class="lineNum">    4733 </span>            : /* }}} */</a>
<a name="4734"><span class="lineNum">    4734 </span>            : </a>
<a name="4735"><span class="lineNum">    4735 </span>            : /* {{{ Strips HTML and PHP tags from a string */</a>
<a name="4736"><span class="lineNum">    4736 </span><span class="lineCov">        543 : PHP_FUNCTION(strip_tags)</span></a>
<a name="4737"><span class="lineNum">    4737 </span>            : {</a>
<a name="4738"><span class="lineNum">    4738 </span>            :         zend_string *buf;</a>
<a name="4739"><span class="lineNum">    4739 </span>            :         zend_string *str;</a>
<a name="4740"><span class="lineNum">    4740 </span><span class="lineCov">        543 :         zend_string *allow_str = NULL;</span></a>
<a name="4741"><span class="lineNum">    4741 </span><span class="lineCov">        543 :         HashTable *allow_ht = NULL;</span></a>
<a name="4742"><span class="lineNum">    4742 </span><span class="lineCov">        543 :         const char *allowed_tags=NULL;</span></a>
<a name="4743"><span class="lineNum">    4743 </span><span class="lineCov">        543 :         size_t allowed_tags_len=0;</span></a>
<a name="4744"><span class="lineNum">    4744 </span><span class="lineCov">        543 :         smart_str tags_ss = {0};</span></a>
<a name="4745"><span class="lineNum">    4745 </span>            : </a>
<a name="4746"><span class="lineNum">    4746 </span><span class="lineCov">        543 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="4747"><span class="lineNum">    4747 </span><span class="lineCov">       1002 :                 Z_PARAM_STR(str)</span></a>
<a name="4748"><span class="lineNum">    4748 </span><span class="lineCov">        495 :                 Z_PARAM_OPTIONAL</span></a>
<a name="4749"><span class="lineNum">    4749 </span><span class="lineCov">        792 :                 Z_PARAM_ARRAY_HT_OR_STR_OR_NULL(allow_ht, allow_str)</span></a>
<a name="4750"><span class="lineNum">    4750 </span><span class="lineCov">        543 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="4751"><span class="lineNum">    4751 </span>            : </a>
<a name="4752"><span class="lineNum">    4752 </span><span class="lineCov">        492 :         if (allow_ht) {</span></a>
<a name="4753"><span class="lineNum">    4753 </span>            :                 zval *tmp;</a>
<a name="4754"><span class="lineNum">    4754 </span>            :                 zend_string *tag;</a>
<a name="4755"><span class="lineNum">    4755 </span>            : </a>
<a name="4756"><span class="lineNum">    4756 </span><span class="lineCov">         99 :                 ZEND_HASH_FOREACH_VAL(allow_ht, tmp) {</span></a>
<a name="4757"><span class="lineNum">    4757 </span><span class="lineCov">         36 :                         tag = zval_get_string(tmp);</span></a>
<a name="4758"><span class="lineNum">    4758 </span>            :                         smart_str_appendc(&amp;tags_ss, '&lt;');</a>
<a name="4759"><span class="lineNum">    4759 </span>            :                         smart_str_append(&amp;tags_ss, tag);</a>
<a name="4760"><span class="lineNum">    4760 </span>            :                         smart_str_appendc(&amp;tags_ss, '&gt;');</a>
<a name="4761"><span class="lineNum">    4761 </span>            :                         zend_string_release(tag);</a>
<a name="4762"><span class="lineNum">    4762 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="4763"><span class="lineNum">    4763 </span><span class="lineCov">         27 :                 if (tags_ss.s) {</span></a>
<a name="4764"><span class="lineNum">    4764 </span>            :                         smart_str_0(&amp;tags_ss);</a>
<a name="4765"><span class="lineNum">    4765 </span><span class="lineCov">         24 :                         allowed_tags = ZSTR_VAL(tags_ss.s);</span></a>
<a name="4766"><span class="lineNum">    4766 </span><span class="lineCov">         24 :                         allowed_tags_len = ZSTR_LEN(tags_ss.s);</span></a>
<a name="4767"><span class="lineNum">    4767 </span>            :                 }</a>
<a name="4768"><span class="lineNum">    4768 </span><span class="lineCov">        465 :         } else if (allow_str) {</span></a>
<a name="4769"><span class="lineNum">    4769 </span><span class="lineCov">        252 :                 allowed_tags = ZSTR_VAL(allow_str);</span></a>
<a name="4770"><span class="lineNum">    4770 </span><span class="lineCov">        252 :                 allowed_tags_len = ZSTR_LEN(allow_str);</span></a>
<a name="4771"><span class="lineNum">    4771 </span>            :         }</a>
<a name="4772"><span class="lineNum">    4772 </span>            : </a>
<a name="4773"><span class="lineNum">    4773 </span><span class="lineCov">        492 :         buf = zend_string_init(ZSTR_VAL(str), ZSTR_LEN(str), 0);</span></a>
<a name="4774"><span class="lineNum">    4774 </span><span class="lineCov">        492 :         ZSTR_LEN(buf) = php_strip_tags_ex(ZSTR_VAL(buf), ZSTR_LEN(str), allowed_tags, allowed_tags_len, 0);</span></a>
<a name="4775"><span class="lineNum">    4775 </span>            :         smart_str_free(&amp;tags_ss);</a>
<a name="4776"><span class="lineNum">    4776 </span><span class="lineCov">        492 :         RETURN_NEW_STR(buf);</span></a>
<a name="4777"><span class="lineNum">    4777 </span>            : }</a>
<a name="4778"><span class="lineNum">    4778 </span>            : /* }}} */</a>
<a name="4779"><span class="lineNum">    4779 </span>            : </a>
<a name="4780"><span class="lineNum">    4780 </span><span class="lineCov">        899 : static zend_string *try_setlocale_str(zend_long cat, zend_string *loc) {</span></a>
<a name="4781"><span class="lineNum">    4781 </span>            :         const char *retval;</a>
<a name="4782"><span class="lineNum">    4782 </span>            : </a>
<a name="4783"><span class="lineNum">    4783 </span><span class="lineCov">        899 :         if (zend_string_equals_literal(loc, &quot;0&quot;)) {</span></a>
<a name="4784"><span class="lineNum">    4784 </span><span class="lineCov">         12 :                 loc = NULL;</span></a>
<a name="4785"><span class="lineNum">    4785 </span>            :         } else {</a>
<a name="4786"><span class="lineNum">    4786 </span><span class="lineCov">        887 :                 if (ZSTR_LEN(loc) &gt;= 255) {</span></a>
<a name="4787"><span class="lineNum">    4787 </span><span class="lineCov">          3 :                         php_error_docref(NULL, E_WARNING, &quot;Specified locale name is too long&quot;);</span></a>
<a name="4788"><span class="lineNum">    4788 </span><span class="lineCov">          3 :                         return NULL;</span></a>
<a name="4789"><span class="lineNum">    4789 </span>            :                 }</a>
<a name="4790"><span class="lineNum">    4790 </span>            :         }</a>
<a name="4791"><span class="lineNum">    4791 </span>            : </a>
<a name="4792"><span class="lineNum">    4792 </span>            : # ifndef PHP_WIN32</a>
<a name="4793"><span class="lineNum">    4793 </span><span class="lineCov">        896 :         retval = setlocale(cat, loc ? ZSTR_VAL(loc) : NULL);</span></a>
<a name="4794"><span class="lineNum">    4794 </span>            : # else</a>
<a name="4795"><span class="lineNum">    4795 </span>            :         if (loc) {</a>
<a name="4796"><span class="lineNum">    4796 </span>            :                 /* BC: don't try /^[a-z]{2}_[A-Z]{2}($|\..*)/ except for /^u[ks]_U[KS]$/ */</a>
<a name="4797"><span class="lineNum">    4797 </span>            :                 char *locp = ZSTR_VAL(loc);</a>
<a name="4798"><span class="lineNum">    4798 </span>            :                 if (ZSTR_LEN(loc) &gt;= 5 &amp;&amp; locp[2] == '_'</a>
<a name="4799"><span class="lineNum">    4799 </span>            :                         &amp;&amp; locp[0] &gt;= 'a' &amp;&amp; locp[0] &lt;= 'z' &amp;&amp; locp[1] &gt;= 'a' &amp;&amp; locp[1] &lt;= 'z'</a>
<a name="4800"><span class="lineNum">    4800 </span>            :                         &amp;&amp; locp[3] &gt;= 'A' &amp;&amp; locp[3] &lt;= 'Z' &amp;&amp; locp[4] &gt;= 'A' &amp;&amp; locp[4] &lt;= 'Z'</a>
<a name="4801"><span class="lineNum">    4801 </span>            :                         &amp;&amp; (locp[5] == '\0' || locp[5] == '.')</a>
<a name="4802"><span class="lineNum">    4802 </span>            :                         &amp;&amp; !(locp[0] == 'u' &amp;&amp; (locp[1] == 'k' || locp[1] == 's')</a>
<a name="4803"><span class="lineNum">    4803 </span>            :                                 &amp;&amp; locp[3] == 'U' &amp;&amp; (locp[4] == 'K' || locp[4] == 'S')</a>
<a name="4804"><span class="lineNum">    4804 </span>            :                                 &amp;&amp; locp[5] == '\0')</a>
<a name="4805"><span class="lineNum">    4805 </span>            :                 ) {</a>
<a name="4806"><span class="lineNum">    4806 </span>            :                         retval = NULL;</a>
<a name="4807"><span class="lineNum">    4807 </span>            :                 } else {</a>
<a name="4808"><span class="lineNum">    4808 </span>            :                         retval = setlocale(cat, ZSTR_VAL(loc));</a>
<a name="4809"><span class="lineNum">    4809 </span>            :                 }</a>
<a name="4810"><span class="lineNum">    4810 </span>            :         } else {</a>
<a name="4811"><span class="lineNum">    4811 </span>            :                 retval = setlocale(cat, NULL);</a>
<a name="4812"><span class="lineNum">    4812 </span>            :         }</a>
<a name="4813"><span class="lineNum">    4813 </span>            : # endif</a>
<a name="4814"><span class="lineNum">    4814 </span><span class="lineCov">        896 :         if (!retval) {</span></a>
<a name="4815"><span class="lineNum">    4815 </span><span class="lineCov">        397 :                 return NULL;</span></a>
<a name="4816"><span class="lineNum">    4816 </span>            :         }</a>
<a name="4817"><span class="lineNum">    4817 </span>            : </a>
<a name="4818"><span class="lineNum">    4818 </span><span class="lineCov">        499 :         if (loc) {</span></a>
<a name="4819"><span class="lineNum">    4819 </span>            :                 /* Remember if locale was changed */</a>
<a name="4820"><span class="lineNum">    4820 </span><span class="lineCov">        487 :                 size_t len = strlen(retval);</span></a>
<a name="4821"><span class="lineNum">    4821 </span>            : </a>
<a name="4822"><span class="lineNum">    4822 </span><span class="lineCov">        487 :                 BG(locale_changed) = 1;</span></a>
<a name="4823"><span class="lineNum">    4823 </span><span class="lineCov">        487 :                 if (cat == LC_CTYPE || cat == LC_ALL) {</span></a>
<a name="4824"><span class="lineNum">    4824 </span><span class="lineCov">        470 :                         zend_update_current_locale();</span></a>
<a name="4825"><span class="lineNum">    4825 </span><span class="lineCov">        470 :                         if (BG(ctype_string)) {</span></a>
<a name="4826"><span class="lineNum">    4826 </span><span class="lineCov">         24 :                                 zend_string_release_ex(BG(ctype_string), 0);</span></a>
<a name="4827"><span class="lineNum">    4827 </span>            :                         }</a>
<a name="4828"><span class="lineNum">    4828 </span><span class="lineCov">        470 :                         if (len == 1 &amp;&amp; *retval == 'C') {</span></a>
<a name="4829"><span class="lineNum">    4829 </span>            :                                 /* C locale is represented as NULL. */</a>
<a name="4830"><span class="lineNum">    4830 </span><span class="lineCov">        379 :                                 BG(ctype_string) = NULL;</span></a>
<a name="4831"><span class="lineNum">    4831 </span><span class="lineCov">        379 :                                 return ZSTR_CHAR('C');</span></a>
<a name="4832"><span class="lineNum">    4832 </span><span class="lineCov">         91 :                         } else if (len == ZSTR_LEN(loc) &amp;&amp; !memcmp(ZSTR_VAL(loc), retval, len)) {</span></a>
<a name="4833"><span class="lineNum">    4833 </span><span class="lineCov">         67 :                                 BG(ctype_string) = zend_string_copy(loc);</span></a>
<a name="4834"><span class="lineNum">    4834 </span><span class="lineCov">        134 :                                 return zend_string_copy(BG(ctype_string));</span></a>
<a name="4835"><span class="lineNum">    4835 </span>            :                         } else {</a>
<a name="4836"><span class="lineNum">    4836 </span><span class="lineCov">         24 :                                 BG(ctype_string) = zend_string_init(retval, len, 0);</span></a>
<a name="4837"><span class="lineNum">    4837 </span><span class="lineCov">         48 :                                 return zend_string_copy(BG(ctype_string));</span></a>
<a name="4838"><span class="lineNum">    4838 </span>            :                         }</a>
<a name="4839"><span class="lineNum">    4839 </span><span class="lineCov">         17 :                 } else if (len == ZSTR_LEN(loc) &amp;&amp; !memcmp(ZSTR_VAL(loc), retval, len)) {</span></a>
<a name="4840"><span class="lineNum">    4840 </span><span class="lineCov">          9 :                         return zend_string_copy(loc);</span></a>
<a name="4841"><span class="lineNum">    4841 </span>            :                 }</a>
<a name="4842"><span class="lineNum">    4842 </span>            :         }</a>
<a name="4843"><span class="lineNum">    4843 </span><span class="lineCov">         40 :         return zend_string_init(retval, strlen(retval), 0);</span></a>
<a name="4844"><span class="lineNum">    4844 </span>            : }</a>
<a name="4845"><span class="lineNum">    4845 </span>            : </a>
<a name="4846"><span class="lineNum">    4846 </span><span class="lineCov">        899 : static zend_string *try_setlocale_zval(zend_long cat, zval *loc_zv) {</span></a>
<a name="4847"><span class="lineNum">    4847 </span>            :         zend_string *tmp_loc_str;</a>
<a name="4848"><span class="lineNum">    4848 </span><span class="lineCov">        899 :         zend_string *loc_str = zval_try_get_tmp_string(loc_zv, &amp;tmp_loc_str);</span></a>
<a name="4849"><span class="lineNum">    4849 </span><span class="lineCov">        899 :         if (UNEXPECTED(loc_str == NULL)) {</span></a>
<a name="4850"><span class="lineNum">    4850 </span><span class="lineNoCov">          0 :                 return NULL;</span></a>
<a name="4851"><span class="lineNum">    4851 </span>            :         }</a>
<a name="4852"><span class="lineNum">    4852 </span><span class="lineCov">        899 :         zend_string *result = try_setlocale_str(cat, loc_str);</span></a>
<a name="4853"><span class="lineNum">    4853 </span><span class="lineCov">        899 :         zend_tmp_string_release(tmp_loc_str);</span></a>
<a name="4854"><span class="lineNum">    4854 </span><span class="lineCov">        899 :         return result;</span></a>
<a name="4855"><span class="lineNum">    4855 </span>            : }</a>
<a name="4856"><span class="lineNum">    4856 </span>            : </a>
<a name="4857"><span class="lineNum">    4857 </span>            : /* {{{ Set locale information */</a>
<a name="4858"><span class="lineNum">    4858 </span><span class="lineCov">        704 : PHP_FUNCTION(setlocale)</span></a>
<a name="4859"><span class="lineNum">    4859 </span>            : {</a>
<a name="4860"><span class="lineNum">    4860 </span>            :         zend_long cat;</a>
<a name="4861"><span class="lineNum">    4861 </span><span class="lineCov">        704 :         zval *args = NULL;</span></a>
<a name="4862"><span class="lineNum">    4862 </span>            :         int num_args;</a>
<a name="4863"><span class="lineNum">    4863 </span>            : </a>
<a name="4864"><span class="lineNum">    4864 </span><span class="lineCov">        704 :         ZEND_PARSE_PARAMETERS_START(2, -1)</span></a>
<a name="4865"><span class="lineNum">    4865 </span><span class="lineCov">       1384 :                 Z_PARAM_LONG(cat)</span></a>
<a name="4866"><span class="lineNum">    4866 </span><span class="lineCov">        671 :                 Z_PARAM_VARIADIC('+', args, num_args)</span></a>
<a name="4867"><span class="lineNum">    4867 </span><span class="lineCov">        704 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="4868"><span class="lineNum">    4868 </span>            : </a>
<a name="4869"><span class="lineNum">    4869 </span><span class="lineCov">       1065 :         for (uint32_t i = 0; i &lt; num_args; i++) {</span></a>
<a name="4870"><span class="lineNum">    4870 </span><span class="lineCov">       1786 :                 if (Z_TYPE(args[i]) == IS_ARRAY) {</span></a>
<a name="4871"><span class="lineNum">    4871 </span>            :                         zval *elem;</a>
<a name="4872"><span class="lineNum">    4872 </span><span class="lineCov">         27 :                         ZEND_HASH_FOREACH_VAL(Z_ARRVAL(args[i]), elem) {</span></a>
<a name="4873"><span class="lineNum">    4873 </span><span class="lineCov">         12 :                                 zend_string *result = try_setlocale_zval(cat, elem);</span></a>
<a name="4874"><span class="lineNum">    4874 </span><span class="lineCov">         12 :                                 if (EG(exception)) {</span></a>
<a name="4875"><span class="lineNum">    4875 </span><span class="lineNoCov">          0 :                                         RETURN_THROWS();</span></a>
<a name="4876"><span class="lineNum">    4876 </span>            :                                 }</a>
<a name="4877"><span class="lineNum">    4877 </span><span class="lineCov">         12 :                                 if (result) {</span></a>
<a name="4878"><span class="lineNum">    4878 </span><span class="lineCov">          6 :                                         RETURN_STR(result);</span></a>
<a name="4879"><span class="lineNum">    4879 </span>            :                                 }</a>
<a name="4880"><span class="lineNum">    4880 </span>            :                         } ZEND_HASH_FOREACH_END();</a>
<a name="4881"><span class="lineNum">    4881 </span>            :                 } else {</a>
<a name="4882"><span class="lineNum">    4882 </span><span class="lineCov">        887 :                         zend_string *result = try_setlocale_zval(cat, &amp;args[i]);</span></a>
<a name="4883"><span class="lineNum">    4883 </span><span class="lineCov">        887 :                         if (EG(exception)) {</span></a>
<a name="4884"><span class="lineNum">    4884 </span><span class="lineNoCov">          0 :                                 RETURN_THROWS();</span></a>
<a name="4885"><span class="lineNum">    4885 </span>            :                         }</a>
<a name="4886"><span class="lineNum">    4886 </span><span class="lineCov">        887 :                         if (result) {</span></a>
<a name="4887"><span class="lineNum">    4887 </span><span class="lineCov">        992 :                                 RETURN_STR(result);</span></a>
<a name="4888"><span class="lineNum">    4888 </span>            :                         }</a>
<a name="4889"><span class="lineNum">    4889 </span>            :                 }</a>
<a name="4890"><span class="lineNum">    4890 </span>            :         }</a>
<a name="4891"><span class="lineNum">    4891 </span>            : </a>
<a name="4892"><span class="lineNum">    4892 </span><span class="lineCov">        172 :         RETURN_FALSE;</span></a>
<a name="4893"><span class="lineNum">    4893 </span>            : }</a>
<a name="4894"><span class="lineNum">    4894 </span>            : /* }}} */</a>
<a name="4895"><span class="lineNum">    4895 </span>            : </a>
<a name="4896"><span class="lineNum">    4896 </span>            : /* {{{ Parses GET/POST/COOKIE data and sets global variables */</a>
<a name="4897"><span class="lineNum">    4897 </span><span class="lineCov">         84 : PHP_FUNCTION(parse_str)</span></a>
<a name="4898"><span class="lineNum">    4898 </span>            : {</a>
<a name="4899"><span class="lineNum">    4899 </span>            :         char *arg;</a>
<a name="4900"><span class="lineNum">    4900 </span><span class="lineCov">         84 :         zval *arrayArg = NULL;</span></a>
<a name="4901"><span class="lineNum">    4901 </span><span class="lineCov">         84 :         char *res = NULL;</span></a>
<a name="4902"><span class="lineNum">    4902 </span>            :         size_t arglen;</a>
<a name="4903"><span class="lineNum">    4903 </span>            : </a>
<a name="4904"><span class="lineNum">    4904 </span><span class="lineCov">         84 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="4905"><span class="lineNum">    4905 </span><span class="lineCov">        144 :                 Z_PARAM_STRING(arg, arglen)</span></a>
<a name="4906"><span class="lineNum">    4906 </span><span class="lineCov">         72 :                 Z_PARAM_ZVAL(arrayArg)</span></a>
<a name="4907"><span class="lineNum">    4907 </span><span class="lineCov">         84 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="4908"><span class="lineNum">    4908 </span>            : </a>
<a name="4909"><span class="lineNum">    4909 </span><span class="lineCov">         72 :         arrayArg = zend_try_array_init(arrayArg);</span></a>
<a name="4910"><span class="lineNum">    4910 </span><span class="lineCov">         72 :         if (!arrayArg) {</span></a>
<a name="4911"><span class="lineNum">    4911 </span><span class="lineNoCov">          0 :                 RETURN_THROWS();</span></a>
<a name="4912"><span class="lineNum">    4912 </span>            :         }</a>
<a name="4913"><span class="lineNum">    4913 </span>            : </a>
<a name="4914"><span class="lineNum">    4914 </span><span class="lineCov">         72 :         res = estrndup(arg, arglen);</span></a>
<a name="4915"><span class="lineNum">    4915 </span><span class="lineCov">         72 :         sapi_module.treat_data(PARSE_STRING, res, arrayArg);</span></a>
<a name="4916"><span class="lineNum">    4916 </span>            : }</a>
<a name="4917"><span class="lineNum">    4917 </span>            : /* }}} */</a>
<a name="4918"><span class="lineNum">    4918 </span>            : </a>
<a name="4919"><span class="lineNum">    4919 </span>            : #define PHP_TAG_BUF_SIZE 1023</a>
<a name="4920"><span class="lineNum">    4920 </span>            : </a>
<a name="4921"><span class="lineNum">    4921 </span>            : /* {{{ php_tag_find</a>
<a name="4922"><span class="lineNum">    4922 </span>            :  *</a>
<a name="4923"><span class="lineNum">    4923 </span>            :  * Check if tag is in a set of tags</a>
<a name="4924"><span class="lineNum">    4924 </span>            :  *</a>
<a name="4925"><span class="lineNum">    4925 </span>            :  * states:</a>
<a name="4926"><span class="lineNum">    4926 </span>            :  *</a>
<a name="4927"><span class="lineNum">    4927 </span>            :  * 0 start tag</a>
<a name="4928"><span class="lineNum">    4928 </span>            :  * 1 first non-whitespace char seen</a>
<a name="4929"><span class="lineNum">    4929 </span>            :  */</a>
<a name="4930"><span class="lineNum">    4930 </span><span class="lineCov">       1116 : int php_tag_find(char *tag, size_t len, const char *set) {</span></a>
<a name="4931"><span class="lineNum">    4931 </span>            :         char c, *n;</a>
<a name="4932"><span class="lineNum">    4932 </span>            :         const char *t;</a>
<a name="4933"><span class="lineNum">    4933 </span><span class="lineCov">       1116 :         int state=0, done=0;</span></a>
<a name="4934"><span class="lineNum">    4934 </span>            :         char *norm;</a>
<a name="4935"><span class="lineNum">    4935 </span>            : </a>
<a name="4936"><span class="lineNum">    4936 </span><span class="lineCov">       1116 :         if (len == 0) {</span></a>
<a name="4937"><span class="lineNum">    4937 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="4938"><span class="lineNum">    4938 </span>            :         }</a>
<a name="4939"><span class="lineNum">    4939 </span>            : </a>
<a name="4940"><span class="lineNum">    4940 </span><span class="lineCov">       1116 :         norm = emalloc(len+1);</span></a>
<a name="4941"><span class="lineNum">    4941 </span>            : </a>
<a name="4942"><span class="lineNum">    4942 </span><span class="lineCov">       1116 :         n = norm;</span></a>
<a name="4943"><span class="lineNum">    4943 </span><span class="lineCov">       1116 :         t = tag;</span></a>
<a name="4944"><span class="lineNum">    4944 </span><span class="lineCov">       1116 :         c = tolower(*t);</span></a>
<a name="4945"><span class="lineNum">    4945 </span>            :         /*</a>
<a name="4946"><span class="lineNum">    4946 </span>            :            normalize the tag removing leading and trailing whitespace</a>
<a name="4947"><span class="lineNum">    4947 </span>            :            and turn any &lt;a whatever...&gt; into just &lt;a&gt; and any &lt;/tag&gt;</a>
<a name="4948"><span class="lineNum">    4948 </span>            :            into &lt;tag&gt;</a>
<a name="4949"><span class="lineNum">    4949 </span>            :         */</a>
<a name="4950"><span class="lineNum">    4950 </span><span class="lineCov">       6303 :         while (!done) {</span></a>
<a name="4951"><span class="lineNum">    4951 </span><span class="lineCov">       5187 :                 switch (c) {</span></a>
<a name="4952"><span class="lineNum">    4952 </span><span class="lineCov">       1116 :                         case '&lt;':</span></a>
<a name="4953"><span class="lineNum">    4953 </span><span class="lineCov">       1116 :                                 *(n++) = c;</span></a>
<a name="4954"><span class="lineNum">    4954 </span><span class="lineCov">       1116 :                                 break;</span></a>
<a name="4955"><span class="lineNum">    4955 </span><span class="lineCov">       1011 :                         case '&gt;':</span></a>
<a name="4956"><span class="lineNum">    4956 </span><span class="lineCov">       1011 :                                 done =1;</span></a>
<a name="4957"><span class="lineNum">    4957 </span><span class="lineCov">       1011 :                                 break;</span></a>
<a name="4958"><span class="lineNum">    4958 </span><span class="lineCov">       3060 :                         default:</span></a>
<a name="4959"><span class="lineNum">    4959 </span><span class="lineCov">       3060 :                                 if (!isspace((int)c)) {</span></a>
<a name="4960"><span class="lineNum">    4960 </span><span class="lineCov">       2949 :                                         if (state == 0) {</span></a>
<a name="4961"><span class="lineNum">    4961 </span><span class="lineCov">       1116 :                                                 state=1;</span></a>
<a name="4962"><span class="lineNum">    4962 </span>            :                                         }</a>
<a name="4963"><span class="lineNum">    4963 </span><span class="lineCov">       2949 :                                         if (c != '/' || (*(t-1) != '&lt;' &amp;&amp; *(t+1) != '&gt;')) {</span></a>
<a name="4964"><span class="lineNum">    4964 </span><span class="lineCov">       2415 :                                                 *(n++) = c;</span></a>
<a name="4965"><span class="lineNum">    4965 </span>            :                                         }</a>
<a name="4966"><span class="lineNum">    4966 </span>            :                                 } else {</a>
<a name="4967"><span class="lineNum">    4967 </span><span class="lineCov">        111 :                                         if (state == 1)</span></a>
<a name="4968"><span class="lineNum">    4968 </span><span class="lineCov">        105 :                                                 done=1;</span></a>
<a name="4969"><span class="lineNum">    4969 </span>            :                                 }</a>
<a name="4970"><span class="lineNum">    4970 </span><span class="lineCov">       3060 :                                 break;</span></a>
<a name="4971"><span class="lineNum">    4971 </span>            :                 }</a>
<a name="4972"><span class="lineNum">    4972 </span><span class="lineCov">       5187 :                 c = tolower(*(++t));</span></a>
<a name="4973"><span class="lineNum">    4973 </span>            :         }</a>
<a name="4974"><span class="lineNum">    4974 </span><span class="lineCov">       1116 :         *(n++) = '&gt;';</span></a>
<a name="4975"><span class="lineNum">    4975 </span><span class="lineCov">       1116 :         *n = '\0';</span></a>
<a name="4976"><span class="lineNum">    4976 </span><span class="lineCov">       1116 :         if (strstr(set, norm)) {</span></a>
<a name="4977"><span class="lineNum">    4977 </span><span class="lineCov">        288 :                 done=1;</span></a>
<a name="4978"><span class="lineNum">    4978 </span>            :         } else {</a>
<a name="4979"><span class="lineNum">    4979 </span><span class="lineCov">        828 :                 done=0;</span></a>
<a name="4980"><span class="lineNum">    4980 </span>            :         }</a>
<a name="4981"><span class="lineNum">    4981 </span><span class="lineCov">       1116 :         efree(norm);</span></a>
<a name="4982"><span class="lineNum">    4982 </span><span class="lineCov">       1116 :         return done;</span></a>
<a name="4983"><span class="lineNum">    4983 </span>            : }</a>
<a name="4984"><span class="lineNum">    4984 </span>            : /* }}} */</a>
<a name="4985"><span class="lineNum">    4985 </span>            : </a>
<a name="4986"><span class="lineNum">    4986 </span><span class="lineNoCov">          0 : PHPAPI size_t php_strip_tags(char *rbuf, size_t len, const char *allow, size_t allow_len) /* {{{ */</span></a>
<a name="4987"><span class="lineNum">    4987 </span>            : {</a>
<a name="4988"><span class="lineNum">    4988 </span><span class="lineNoCov">          0 :         return php_strip_tags_ex(rbuf, len, allow, allow_len, 0);</span></a>
<a name="4989"><span class="lineNum">    4989 </span>            : }</a>
<a name="4990"><span class="lineNum">    4990 </span>            : /* }}} */</a>
<a name="4991"><span class="lineNum">    4991 </span>            : </a>
<a name="4992"><span class="lineNum">    4992 </span>            : /* {{{ php_strip_tags</a>
<a name="4993"><span class="lineNum">    4993 </span>            : </a>
<a name="4994"><span class="lineNum">    4994 </span>            :         A simple little state-machine to strip out html and php tags</a>
<a name="4995"><span class="lineNum">    4995 </span>            : </a>
<a name="4996"><span class="lineNum">    4996 </span>            :         State 0 is the output state, State 1 means we are inside a</a>
<a name="4997"><span class="lineNum">    4997 </span>            :         normal html tag and state 2 means we are inside a php tag.</a>
<a name="4998"><span class="lineNum">    4998 </span>            : </a>
<a name="4999"><span class="lineNum">    4999 </span>            :         The state variable is passed in to allow a function like fgetss</a>
<a name="5000"><span class="lineNum">    5000 </span>            :         to maintain state across calls to the function.</a>
<a name="5001"><span class="lineNum">    5001 </span>            : </a>
<a name="5002"><span class="lineNum">    5002 </span>            :         lc holds the last significant character read and br is a bracket</a>
<a name="5003"><span class="lineNum">    5003 </span>            :         counter.</a>
<a name="5004"><span class="lineNum">    5004 </span>            : </a>
<a name="5005"><span class="lineNum">    5005 </span>            :         When an allow string is passed in we keep track of the string</a>
<a name="5006"><span class="lineNum">    5006 </span>            :         in state 1 and when the tag is closed check it against the</a>
<a name="5007"><span class="lineNum">    5007 </span>            :         allow string to see if we should allow it.</a>
<a name="5008"><span class="lineNum">    5008 </span>            : </a>
<a name="5009"><span class="lineNum">    5009 </span>            :         swm: Added ability to strip &lt;?xml tags without assuming it PHP</a>
<a name="5010"><span class="lineNum">    5010 </span>            :         code.</a>
<a name="5011"><span class="lineNum">    5011 </span>            : */</a>
<a name="5012"><span class="lineNum">    5012 </span><span class="lineCov">        624 : PHPAPI size_t php_strip_tags_ex(char *rbuf, size_t len, const char *allow, size_t allow_len, bool allow_tag_spaces)</span></a>
<a name="5013"><span class="lineNum">    5013 </span>            : {</a>
<a name="5014"><span class="lineNum">    5014 </span>            :         char *tbuf, *tp, *rp, c, lc;</a>
<a name="5015"><span class="lineNum">    5015 </span>            :         const char *buf, *p, *end;</a>
<a name="5016"><span class="lineNum">    5016 </span><span class="lineCov">        624 :         int br, depth=0, in_q = 0;</span></a>
<a name="5017"><span class="lineNum">    5017 </span><span class="lineCov">        624 :         uint8_t state = 0;</span></a>
<a name="5018"><span class="lineNum">    5018 </span>            :         size_t pos;</a>
<a name="5019"><span class="lineNum">    5019 </span><span class="lineCov">        624 :         char *allow_free = NULL;</span></a>
<a name="5020"><span class="lineNum">    5020 </span><span class="lineCov">        624 :         char is_xml = 0;</span></a>
<a name="5021"><span class="lineNum">    5021 </span>            : </a>
<a name="5022"><span class="lineNum">    5022 </span><span class="lineCov">        624 :         buf = estrndup(rbuf, len);</span></a>
<a name="5023"><span class="lineNum">    5023 </span><span class="lineCov">        624 :         end = buf + len;</span></a>
<a name="5024"><span class="lineNum">    5024 </span><span class="lineCov">        624 :         lc = '\0';</span></a>
<a name="5025"><span class="lineNum">    5025 </span><span class="lineCov">        624 :         p = buf;</span></a>
<a name="5026"><span class="lineNum">    5026 </span><span class="lineCov">        624 :         rp = rbuf;</span></a>
<a name="5027"><span class="lineNum">    5027 </span><span class="lineCov">        624 :         br = 0;</span></a>
<a name="5028"><span class="lineNum">    5028 </span><span class="lineCov">        624 :         if (allow) {</span></a>
<a name="5029"><span class="lineNum">    5029 </span><span class="lineCov">        276 :                 allow_free = zend_str_tolower_dup_ex(allow, allow_len);</span></a>
<a name="5030"><span class="lineNum">    5030 </span><span class="lineCov">        276 :                 allow = allow_free ? allow_free : allow;</span></a>
<a name="5031"><span class="lineNum">    5031 </span><span class="lineCov">        276 :                 tbuf = emalloc(PHP_TAG_BUF_SIZE + 1);</span></a>
<a name="5032"><span class="lineNum">    5032 </span><span class="lineCov">        276 :                 tp = tbuf;</span></a>
<a name="5033"><span class="lineNum">    5033 </span>            :         } else {</a>
<a name="5034"><span class="lineNum">    5034 </span><span class="lineCov">        348 :                 tbuf = tp = NULL;</span></a>
<a name="5035"><span class="lineNum">    5035 </span>            :         }</a>
<a name="5036"><span class="lineNum">    5036 </span>            : </a>
<a name="5037"><span class="lineNum">    5037 </span><span class="lineCov">        624 : state_0:</span></a>
<a name="5038"><span class="lineNum">    5038 </span><span class="lineCov">      12324 :         if (p &gt;= end) {</span></a>
<a name="5039"><span class="lineNum">    5039 </span><span class="lineCov">        600 :                 goto finish;</span></a>
<a name="5040"><span class="lineNum">    5040 </span>            :         }</a>
<a name="5041"><span class="lineNum">    5041 </span><span class="lineCov">      11724 :         c = *p;</span></a>
<a name="5042"><span class="lineNum">    5042 </span><span class="lineCov">      11724 :         switch (c) {</span></a>
<a name="5043"><span class="lineNum">    5043 </span><span class="lineCov">          6 :                 case '\0':</span></a>
<a name="5044"><span class="lineNum">    5044 </span><span class="lineCov">          6 :                         break;</span></a>
<a name="5045"><span class="lineNum">    5045 </span><span class="lineCov">       1986 :                 case '&lt;':</span></a>
<a name="5046"><span class="lineNum">    5046 </span><span class="lineCov">       1986 :                         if (in_q) {</span></a>
<a name="5047"><span class="lineNum">    5047 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="5048"><span class="lineNum">    5048 </span>            :                         }</a>
<a name="5049"><span class="lineNum">    5049 </span><span class="lineCov">       1986 :                         if (isspace(*(p + 1)) &amp;&amp; !allow_tag_spaces) {</span></a>
<a name="5050"><span class="lineNum">    5050 </span><span class="lineCov">         12 :                                 *(rp++) = c;</span></a>
<a name="5051"><span class="lineNum">    5051 </span><span class="lineCov">         12 :                                 break;</span></a>
<a name="5052"><span class="lineNum">    5052 </span>            :                         }</a>
<a name="5053"><span class="lineNum">    5053 </span><span class="lineCov">       1974 :                         lc = '&lt;';</span></a>
<a name="5054"><span class="lineNum">    5054 </span><span class="lineCov">       1974 :                         state = 1;</span></a>
<a name="5055"><span class="lineNum">    5055 </span><span class="lineCov">       1974 :                         if (allow) {</span></a>
<a name="5056"><span class="lineNum">    5056 </span><span class="lineCov">       1290 :                                 if (tp - tbuf &gt;= PHP_TAG_BUF_SIZE) {</span></a>
<a name="5057"><span class="lineNum">    5057 </span><span class="lineNoCov">          0 :                                         pos = tp - tbuf;</span></a>
<a name="5058"><span class="lineNum">    5058 </span><span class="lineNoCov">          0 :                                         tbuf = erealloc(tbuf, (tp - tbuf) + PHP_TAG_BUF_SIZE + 1);</span></a>
<a name="5059"><span class="lineNum">    5059 </span><span class="lineNoCov">          0 :                                         tp = tbuf + pos;</span></a>
<a name="5060"><span class="lineNum">    5060 </span>            :                                 }</a>
<a name="5061"><span class="lineNum">    5061 </span><span class="lineCov">       1290 :                                 *(tp++) = '&lt;';</span></a>
<a name="5062"><span class="lineNum">    5062 </span>            :                         }</a>
<a name="5063"><span class="lineNum">    5063 </span><span class="lineCov">       1974 :                         p++;</span></a>
<a name="5064"><span class="lineNum">    5064 </span><span class="lineCov">       1974 :                         goto state_1;</span></a>
<a name="5065"><span class="lineNum">    5065 </span><span class="lineCov">         18 :                 case '&gt;':</span></a>
<a name="5066"><span class="lineNum">    5066 </span><span class="lineCov">         18 :                         if (depth) {</span></a>
<a name="5067"><span class="lineNum">    5067 </span><span class="lineNoCov">          0 :                                 depth--;</span></a>
<a name="5068"><span class="lineNum">    5068 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="5069"><span class="lineNum">    5069 </span>            :                         }</a>
<a name="5070"><span class="lineNum">    5070 </span>            : </a>
<a name="5071"><span class="lineNum">    5071 </span><span class="lineCov">         18 :                         if (in_q) {</span></a>
<a name="5072"><span class="lineNum">    5072 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="5073"><span class="lineNum">    5073 </span>            :                         }</a>
<a name="5074"><span class="lineNum">    5074 </span>            : </a>
<a name="5075"><span class="lineNum">    5075 </span><span class="lineCov">         18 :                         *(rp++) = c;</span></a>
<a name="5076"><span class="lineNum">    5076 </span><span class="lineCov">         18 :                         break;</span></a>
<a name="5077"><span class="lineNum">    5077 </span><span class="lineCov">       9714 :                 default:</span></a>
<a name="5078"><span class="lineNum">    5078 </span><span class="lineCov">       9714 :                         *(rp++) = c;</span></a>
<a name="5079"><span class="lineNum">    5079 </span><span class="lineCov">       9714 :                         break;</span></a>
<a name="5080"><span class="lineNum">    5080 </span>            :         }</a>
<a name="5081"><span class="lineNum">    5081 </span><span class="lineCov">       9750 :         p++;</span></a>
<a name="5082"><span class="lineNum">    5082 </span><span class="lineCov">       9750 :         goto state_0;</span></a>
<a name="5083"><span class="lineNum">    5083 </span>            : </a>
<a name="5084"><span class="lineNum">    5084 </span><span class="lineCov">      23268 : state_1:</span></a>
<a name="5085"><span class="lineNum">    5085 </span><span class="lineCov">      23268 :         if (p &gt;= end) {</span></a>
<a name="5086"><span class="lineNum">    5086 </span><span class="lineCov">         15 :                 goto finish;</span></a>
<a name="5087"><span class="lineNum">    5087 </span>            :         }</a>
<a name="5088"><span class="lineNum">    5088 </span><span class="lineCov">      23253 :         c = *p;</span></a>
<a name="5089"><span class="lineNum">    5089 </span><span class="lineCov">      23253 :         switch (c) {</span></a>
<a name="5090"><span class="lineNum">    5090 </span><span class="lineCov">          6 :                 case '\0':</span></a>
<a name="5091"><span class="lineNum">    5091 </span><span class="lineCov">          6 :                         break;</span></a>
<a name="5092"><span class="lineNum">    5092 </span><span class="lineCov">         78 :                 case '&lt;':</span></a>
<a name="5093"><span class="lineNum">    5093 </span><span class="lineCov">         78 :                         if (in_q) {</span></a>
<a name="5094"><span class="lineNum">    5094 </span><span class="lineCov">          9 :                                 break;</span></a>
<a name="5095"><span class="lineNum">    5095 </span>            :                         }</a>
<a name="5096"><span class="lineNum">    5096 </span><span class="lineCov">         69 :                         if (isspace(*(p + 1)) &amp;&amp; !allow_tag_spaces) {</span></a>
<a name="5097"><span class="lineNum">    5097 </span><span class="lineNoCov">          0 :                                 goto reg_char_1;</span></a>
<a name="5098"><span class="lineNum">    5098 </span>            :                         }</a>
<a name="5099"><span class="lineNum">    5099 </span><span class="lineCov">         69 :                         depth++;</span></a>
<a name="5100"><span class="lineNum">    5100 </span><span class="lineCov">         69 :                         break;</span></a>
<a name="5101"><span class="lineNum">    5101 </span><span class="lineCov">       1752 :                 case '&gt;':</span></a>
<a name="5102"><span class="lineNum">    5102 </span><span class="lineCov">       1752 :                         if (depth) {</span></a>
<a name="5103"><span class="lineNum">    5103 </span><span class="lineCov">         63 :                                 depth--;</span></a>
<a name="5104"><span class="lineNum">    5104 </span><span class="lineCov">         63 :                                 break;</span></a>
<a name="5105"><span class="lineNum">    5105 </span>            :                         }</a>
<a name="5106"><span class="lineNum">    5106 </span><span class="lineCov">       1689 :                         if (in_q) {</span></a>
<a name="5107"><span class="lineNum">    5107 </span><span class="lineCov">         12 :                                 break;</span></a>
<a name="5108"><span class="lineNum">    5108 </span>            :                         }</a>
<a name="5109"><span class="lineNum">    5109 </span>            : </a>
<a name="5110"><span class="lineNum">    5110 </span><span class="lineCov">       1677 :                         lc = '&gt;';</span></a>
<a name="5111"><span class="lineNum">    5111 </span><span class="lineCov">       1677 :                         if (is_xml &amp;&amp; p &gt;= buf + 1 &amp;&amp; *(p -1) == '-') {</span></a>
<a name="5112"><span class="lineNum">    5112 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="5113"><span class="lineNum">    5113 </span>            :                         }</a>
<a name="5114"><span class="lineNum">    5114 </span><span class="lineCov">       1677 :                         in_q = state = is_xml = 0;</span></a>
<a name="5115"><span class="lineNum">    5115 </span><span class="lineCov">       1677 :                         if (allow) {</span></a>
<a name="5116"><span class="lineNum">    5116 </span><span class="lineCov">       1116 :                                 if (tp - tbuf &gt;= PHP_TAG_BUF_SIZE) {</span></a>
<a name="5117"><span class="lineNum">    5117 </span><span class="lineCov">          3 :                                         pos = tp - tbuf;</span></a>
<a name="5118"><span class="lineNum">    5118 </span><span class="lineCov">          3 :                                         tbuf = erealloc(tbuf, (tp - tbuf) + PHP_TAG_BUF_SIZE + 1);</span></a>
<a name="5119"><span class="lineNum">    5119 </span><span class="lineCov">          3 :                                         tp = tbuf + pos;</span></a>
<a name="5120"><span class="lineNum">    5120 </span>            :                                 }</a>
<a name="5121"><span class="lineNum">    5121 </span><span class="lineCov">       1116 :                                 *(tp++) = '&gt;';</span></a>
<a name="5122"><span class="lineNum">    5122 </span><span class="lineCov">       1116 :                                 *tp='\0';</span></a>
<a name="5123"><span class="lineNum">    5123 </span><span class="lineCov">       1116 :                                 if (php_tag_find(tbuf, tp-tbuf, allow)) {</span></a>
<a name="5124"><span class="lineNum">    5124 </span><span class="lineCov">        288 :                                         memcpy(rp, tbuf, tp-tbuf);</span></a>
<a name="5125"><span class="lineNum">    5125 </span><span class="lineCov">        288 :                                         rp += tp-tbuf;</span></a>
<a name="5126"><span class="lineNum">    5126 </span>            :                                 }</a>
<a name="5127"><span class="lineNum">    5127 </span><span class="lineCov">       1116 :                                 tp = tbuf;</span></a>
<a name="5128"><span class="lineNum">    5128 </span>            :                         }</a>
<a name="5129"><span class="lineNum">    5129 </span><span class="lineCov">       1677 :                         p++;</span></a>
<a name="5130"><span class="lineNum">    5130 </span><span class="lineCov">       1677 :                         goto state_0;</span></a>
<a name="5131"><span class="lineNum">    5131 </span><span class="lineCov">        357 :                 case '&quot;':</span></a>
<a name="5132"><span class="lineNum">    5132 </span>            :                 case '\'':</a>
<a name="5133"><span class="lineNum">    5133 </span><span class="lineCov">        357 :                         if (p != buf &amp;&amp; (!in_q || *p == in_q)) {</span></a>
<a name="5134"><span class="lineNum">    5134 </span><span class="lineCov">        354 :                                 if (in_q) {</span></a>
<a name="5135"><span class="lineNum">    5135 </span><span class="lineCov">        177 :                                         in_q = 0;</span></a>
<a name="5136"><span class="lineNum">    5136 </span>            :                                 } else {</a>
<a name="5137"><span class="lineNum">    5137 </span><span class="lineCov">        177 :                                         in_q = *p;</span></a>
<a name="5138"><span class="lineNum">    5138 </span>            :                                 }</a>
<a name="5139"><span class="lineNum">    5139 </span>            :                         }</a>
<a name="5140"><span class="lineNum">    5140 </span><span class="lineCov">        357 :                         goto reg_char_1;</span></a>
<a name="5141"><span class="lineNum">    5141 </span><span class="lineCov">        126 :                 case '!':</span></a>
<a name="5142"><span class="lineNum">    5142 </span>            :                         /* JavaScript &amp; Other HTML scripting languages */</a>
<a name="5143"><span class="lineNum">    5143 </span><span class="lineCov">        126 :                         if (p &gt;= buf + 1 &amp;&amp; *(p-1) == '&lt;') {</span></a>
<a name="5144"><span class="lineNum">    5144 </span><span class="lineCov">        105 :                                 state = 3;</span></a>
<a name="5145"><span class="lineNum">    5145 </span><span class="lineCov">        105 :                                 lc = c;</span></a>
<a name="5146"><span class="lineNum">    5146 </span><span class="lineCov">        105 :                                 p++;</span></a>
<a name="5147"><span class="lineNum">    5147 </span><span class="lineCov">        105 :                                 goto state_3;</span></a>
<a name="5148"><span class="lineNum">    5148 </span>            :                         } else {</a>
<a name="5149"><span class="lineNum">    5149 </span><span class="lineCov">         21 :                                 goto reg_char_1;</span></a>
<a name="5150"><span class="lineNum">    5150 </span>            :                         }</a>
<a name="5151"><span class="lineNum">    5151 </span>            :                         break;</a>
<a name="5152"><span class="lineNum">    5152 </span><span class="lineCov">        225 :                 case '?':</span></a>
<a name="5153"><span class="lineNum">    5153 </span><span class="lineCov">        225 :                         if (p &gt;= buf + 1 &amp;&amp; *(p-1) == '&lt;') {</span></a>
<a name="5154"><span class="lineNum">    5154 </span><span class="lineCov">        192 :                                 br=0;</span></a>
<a name="5155"><span class="lineNum">    5155 </span><span class="lineCov">        192 :                                 state = 2;</span></a>
<a name="5156"><span class="lineNum">    5156 </span><span class="lineCov">        192 :                                 p++;</span></a>
<a name="5157"><span class="lineNum">    5157 </span><span class="lineCov">        192 :                                 goto state_2;</span></a>
<a name="5158"><span class="lineNum">    5158 </span>            :                         } else {</a>
<a name="5159"><span class="lineNum">    5159 </span><span class="lineCov">         33 :                                 goto reg_char_1;</span></a>
<a name="5160"><span class="lineNum">    5160 </span>            :                         }</a>
<a name="5161"><span class="lineNum">    5161 </span>            :                         break;</a>
<a name="5162"><span class="lineNum">    5162 </span>            :                 default:</a>
<a name="5163"><span class="lineNum">    5163 </span><span class="lineCov">      21120 : reg_char_1:</span></a>
<a name="5164"><span class="lineNum">    5164 </span><span class="lineCov">      21120 :                         if (allow) {</span></a>
<a name="5165"><span class="lineNum">    5165 </span><span class="lineCov">      10500 :                                 if (tp - tbuf &gt;= PHP_TAG_BUF_SIZE) {</span></a>
<a name="5166"><span class="lineNum">    5166 </span><span class="lineCov">       3126 :                                         pos = tp - tbuf;</span></a>
<a name="5167"><span class="lineNum">    5167 </span><span class="lineCov">       3126 :                                         tbuf = erealloc(tbuf, (tp - tbuf) + PHP_TAG_BUF_SIZE + 1);</span></a>
<a name="5168"><span class="lineNum">    5168 </span><span class="lineCov">       3126 :                                         tp = tbuf + pos;</span></a>
<a name="5169"><span class="lineNum">    5169 </span>            :                                 }</a>
<a name="5170"><span class="lineNum">    5170 </span><span class="lineCov">      10500 :                                 *(tp++) = c;</span></a>
<a name="5171"><span class="lineNum">    5171 </span>            :                         }</a>
<a name="5172"><span class="lineNum">    5172 </span><span class="lineCov">      21120 :                         break;</span></a>
<a name="5173"><span class="lineNum">    5173 </span>            :         }</a>
<a name="5174"><span class="lineNum">    5174 </span><span class="lineCov">      21279 :         p++;</span></a>
<a name="5175"><span class="lineNum">    5175 </span><span class="lineCov">      21279 :         goto state_1;</span></a>
<a name="5176"><span class="lineNum">    5176 </span>            : </a>
<a name="5177"><span class="lineNum">    5177 </span><span class="lineCov">       3411 : state_2:</span></a>
<a name="5178"><span class="lineNum">    5178 </span><span class="lineCov">       3411 :         if (p &gt;= end) {</span></a>
<a name="5179"><span class="lineNum">    5179 </span><span class="lineCov">          9 :                 goto finish;</span></a>
<a name="5180"><span class="lineNum">    5180 </span>            :         }</a>
<a name="5181"><span class="lineNum">    5181 </span><span class="lineCov">       3402 :         c = *p;</span></a>
<a name="5182"><span class="lineNum">    5182 </span><span class="lineCov">       3402 :         switch (c) {</span></a>
<a name="5183"><span class="lineNum">    5183 </span><span class="lineCov">          9 :                 case '(':</span></a>
<a name="5184"><span class="lineNum">    5184 </span><span class="lineCov">          9 :                         if (lc != '&quot;' &amp;&amp; lc != '\'') {</span></a>
<a name="5185"><span class="lineNum">    5185 </span><span class="lineCov">          9 :                                 lc = '(';</span></a>
<a name="5186"><span class="lineNum">    5186 </span><span class="lineCov">          9 :                                 br++;</span></a>
<a name="5187"><span class="lineNum">    5187 </span>            :                         }</a>
<a name="5188"><span class="lineNum">    5188 </span><span class="lineCov">          9 :                         break;</span></a>
<a name="5189"><span class="lineNum">    5189 </span><span class="lineCov">          9 :                 case ')':</span></a>
<a name="5190"><span class="lineNum">    5190 </span><span class="lineCov">          9 :                         if (lc != '&quot;' &amp;&amp; lc != '\'') {</span></a>
<a name="5191"><span class="lineNum">    5191 </span><span class="lineCov">          9 :                                 lc = ')';</span></a>
<a name="5192"><span class="lineNum">    5192 </span><span class="lineCov">          9 :                                 br--;</span></a>
<a name="5193"><span class="lineNum">    5193 </span>            :                         }</a>
<a name="5194"><span class="lineNum">    5194 </span><span class="lineCov">          9 :                         break;</span></a>
<a name="5195"><span class="lineNum">    5195 </span><span class="lineCov">        213 :                 case '&gt;':</span></a>
<a name="5196"><span class="lineNum">    5196 </span><span class="lineCov">        213 :                         if (depth) {</span></a>
<a name="5197"><span class="lineNum">    5197 </span><span class="lineCov">          3 :                                 depth--;</span></a>
<a name="5198"><span class="lineNum">    5198 </span><span class="lineCov">          3 :                                 break;</span></a>
<a name="5199"><span class="lineNum">    5199 </span>            :                         }</a>
<a name="5200"><span class="lineNum">    5200 </span><span class="lineCov">        210 :                         if (in_q) {</span></a>
<a name="5201"><span class="lineNum">    5201 </span><span class="lineCov">          3 :                                 break;</span></a>
<a name="5202"><span class="lineNum">    5202 </span>            :                         }</a>
<a name="5203"><span class="lineNum">    5203 </span>            : </a>
<a name="5204"><span class="lineNum">    5204 </span><span class="lineCov">        207 :                         if (!br &amp;&amp; p &gt;= buf + 1 &amp;&amp; lc != '\&quot;' &amp;&amp; *(p-1) == '?') {</span></a>
<a name="5205"><span class="lineNum">    5205 </span><span class="lineCov">        177 :                                 in_q = state = 0;</span></a>
<a name="5206"><span class="lineNum">    5206 </span><span class="lineCov">        177 :                                 tp = tbuf;</span></a>
<a name="5207"><span class="lineNum">    5207 </span><span class="lineCov">        177 :                                 p++;</span></a>
<a name="5208"><span class="lineNum">    5208 </span><span class="lineCov">        177 :                                 goto state_0;</span></a>
<a name="5209"><span class="lineNum">    5209 </span>            :                         }</a>
<a name="5210"><span class="lineNum">    5210 </span><span class="lineCov">         30 :                         break;</span></a>
<a name="5211"><span class="lineNum">    5211 </span><span class="lineCov">         33 :                 case '&quot;':</span></a>
<a name="5212"><span class="lineNum">    5212 </span>            :                 case '\'':</a>
<a name="5213"><span class="lineNum">    5213 </span><span class="lineCov">         33 :                         if (p &gt;= buf + 1 &amp;&amp; *(p-1) != '\\') {</span></a>
<a name="5214"><span class="lineNum">    5214 </span><span class="lineCov">         21 :                                 if (lc == c) {</span></a>
<a name="5215"><span class="lineNum">    5215 </span><span class="lineCov">          9 :                                         lc = '\0';</span></a>
<a name="5216"><span class="lineNum">    5216 </span><span class="lineCov">         12 :                                 } else if (lc != '\\') {</span></a>
<a name="5217"><span class="lineNum">    5217 </span><span class="lineCov">         12 :                                         lc = c;</span></a>
<a name="5218"><span class="lineNum">    5218 </span>            :                                 }</a>
<a name="5219"><span class="lineNum">    5219 </span><span class="lineCov">         21 :                                 if (p != buf &amp;&amp; (!in_q || *p == in_q)) {</span></a>
<a name="5220"><span class="lineNum">    5220 </span><span class="lineCov">         21 :                                         if (in_q) {</span></a>
<a name="5221"><span class="lineNum">    5221 </span><span class="lineCov">          9 :                                                 in_q = 0;</span></a>
<a name="5222"><span class="lineNum">    5222 </span>            :                                         } else {</a>
<a name="5223"><span class="lineNum">    5223 </span><span class="lineCov">         12 :                                                 in_q = *p;</span></a>
<a name="5224"><span class="lineNum">    5224 </span>            :                                         }</a>
<a name="5225"><span class="lineNum">    5225 </span>            :                                 }</a>
<a name="5226"><span class="lineNum">    5226 </span>            :                         }</a>
<a name="5227"><span class="lineNum">    5227 </span><span class="lineCov">         33 :                         break;</span></a>
<a name="5228"><span class="lineNum">    5228 </span><span class="lineCov">        345 :                 case 'l':</span></a>
<a name="5229"><span class="lineNum">    5229 </span>            :                 case 'L':</a>
<a name="5230"><span class="lineNum">    5230 </span>            :                         /* swm: If we encounter '&lt;?xml' then we shouldn't be in</a>
<a name="5231"><span class="lineNum">    5231 </span>            :                          * state == 2 (PHP). Switch back to HTML.</a>
<a name="5232"><span class="lineNum">    5232 </span>            :                          */</a>
<a name="5233"><span class="lineNum">    5233 </span><span class="lineCov">        345 :                         if (state == 2 &amp;&amp; p &gt; buf+4</span></a>
<a name="5234"><span class="lineNum">    5234 </span><span class="lineCov">        342 :                                      &amp;&amp; (*(p-1) == 'm' || *(p-1) == 'M')</span></a>
<a name="5235"><span class="lineNum">    5235 </span><span class="lineCov">         24 :                                      &amp;&amp; (*(p-2) == 'x' || *(p-2) == 'X')</span></a>
<a name="5236"><span class="lineNum">    5236 </span><span class="lineCov">         12 :                                      &amp;&amp; *(p-3) == '?'</span></a>
<a name="5237"><span class="lineNum">    5237 </span><span class="lineCov">          6 :                                      &amp;&amp; *(p-4) == '&lt;') {</span></a>
<a name="5238"><span class="lineNum">    5238 </span><span class="lineCov">          6 :                                 state = 1; is_xml=1;</span></a>
<a name="5239"><span class="lineNum">    5239 </span><span class="lineCov">          6 :                                 p++;</span></a>
<a name="5240"><span class="lineNum">    5240 </span><span class="lineCov">          6 :                                 goto state_1;</span></a>
<a name="5241"><span class="lineNum">    5241 </span>            :                         }</a>
<a name="5242"><span class="lineNum">    5242 </span><span class="lineCov">        339 :                         break;</span></a>
<a name="5243"><span class="lineNum">    5243 </span><span class="lineCov">       2793 :                 default:</span></a>
<a name="5244"><span class="lineNum">    5244 </span><span class="lineCov">       2793 :                         break;</span></a>
<a name="5245"><span class="lineNum">    5245 </span>            :         }</a>
<a name="5246"><span class="lineNum">    5246 </span><span class="lineCov">       3219 :         p++;</span></a>
<a name="5247"><span class="lineNum">    5247 </span><span class="lineCov">       3219 :         goto state_2;</span></a>
<a name="5248"><span class="lineNum">    5248 </span>            : </a>
<a name="5249"><span class="lineNum">    5249 </span><span class="lineCov">        267 : state_3:</span></a>
<a name="5250"><span class="lineNum">    5250 </span><span class="lineCov">        267 :         if (p &gt;= end) {</span></a>
<a name="5251"><span class="lineNum">    5251 </span><span class="lineNoCov">          0 :                 goto finish;</span></a>
<a name="5252"><span class="lineNum">    5252 </span>            :         }</a>
<a name="5253"><span class="lineNum">    5253 </span><span class="lineCov">        267 :         c = *p;</span></a>
<a name="5254"><span class="lineNum">    5254 </span><span class="lineCov">        267 :         switch (c) {</span></a>
<a name="5255"><span class="lineNum">    5255 </span><span class="lineCov">          9 :                 case '&gt;':</span></a>
<a name="5256"><span class="lineNum">    5256 </span><span class="lineCov">          9 :                         if (depth) {</span></a>
<a name="5257"><span class="lineNum">    5257 </span><span class="lineCov">          3 :                                 depth--;</span></a>
<a name="5258"><span class="lineNum">    5258 </span><span class="lineCov">          3 :                                 break;</span></a>
<a name="5259"><span class="lineNum">    5259 </span>            :                         }</a>
<a name="5260"><span class="lineNum">    5260 </span><span class="lineCov">          6 :                         if (in_q) {</span></a>
<a name="5261"><span class="lineNum">    5261 </span><span class="lineNoCov">          0 :                                 break;</span></a>
<a name="5262"><span class="lineNum">    5262 </span>            :                         }</a>
<a name="5263"><span class="lineNum">    5263 </span><span class="lineCov">          6 :                         in_q = state = 0;</span></a>
<a name="5264"><span class="lineNum">    5264 </span><span class="lineCov">          6 :                         tp = tbuf;</span></a>
<a name="5265"><span class="lineNum">    5265 </span><span class="lineCov">          6 :                         p++;</span></a>
<a name="5266"><span class="lineNum">    5266 </span><span class="lineCov">          6 :                         goto state_0;</span></a>
<a name="5267"><span class="lineNum">    5267 </span><span class="lineNoCov">          0 :                 case '&quot;':</span></a>
<a name="5268"><span class="lineNum">    5268 </span>            :                 case '\'':</a>
<a name="5269"><span class="lineNum">    5269 </span><span class="lineNoCov">          0 :                         if (p != buf &amp;&amp; *(p-1) != '\\' &amp;&amp; (!in_q || *p == in_q)) {</span></a>
<a name="5270"><span class="lineNum">    5270 </span><span class="lineNoCov">          0 :                                 if (in_q) {</span></a>
<a name="5271"><span class="lineNum">    5271 </span><span class="lineNoCov">          0 :                                         in_q = 0;</span></a>
<a name="5272"><span class="lineNum">    5272 </span>            :                                 } else {</a>
<a name="5273"><span class="lineNum">    5273 </span><span class="lineNoCov">          0 :                                         in_q = *p;</span></a>
<a name="5274"><span class="lineNum">    5274 </span>            :                                 }</a>
<a name="5275"><span class="lineNum">    5275 </span>            :                         }</a>
<a name="5276"><span class="lineNum">    5276 </span><span class="lineNoCov">          0 :                         break;</span></a>
<a name="5277"><span class="lineNum">    5277 </span><span class="lineCov">        180 :                 case '-':</span></a>
<a name="5278"><span class="lineNum">    5278 </span><span class="lineCov">        180 :                         if (p &gt;= buf + 2 &amp;&amp; *(p-1) == '-' &amp;&amp; *(p-2) == '!') {</span></a>
<a name="5279"><span class="lineNum">    5279 </span><span class="lineCov">         90 :                                 state = 4;</span></a>
<a name="5280"><span class="lineNum">    5280 </span><span class="lineCov">         90 :                                 p++;</span></a>
<a name="5281"><span class="lineNum">    5281 </span><span class="lineCov">         90 :                                 goto state_4;</span></a>
<a name="5282"><span class="lineNum">    5282 </span>            :                         }</a>
<a name="5283"><span class="lineNum">    5283 </span><span class="lineCov">         90 :                         break;</span></a>
<a name="5284"><span class="lineNum">    5284 </span><span class="lineCov">          9 :                 case 'E':</span></a>
<a name="5285"><span class="lineNum">    5285 </span>            :                 case 'e':</a>
<a name="5286"><span class="lineNum">    5286 </span>            :                         /* !DOCTYPE exception */</a>
<a name="5287"><span class="lineNum">    5287 </span><span class="lineCov">          9 :                         if (p &gt; buf+6</span></a>
<a name="5288"><span class="lineNum">    5288 </span><span class="lineCov">          9 :                              &amp;&amp; (*(p-1) == 'p' || *(p-1) == 'P')</span></a>
<a name="5289"><span class="lineNum">    5289 </span><span class="lineCov">          9 :                              &amp;&amp; (*(p-2) == 'y' || *(p-2) == 'Y')</span></a>
<a name="5290"><span class="lineNum">    5290 </span><span class="lineCov">          9 :                              &amp;&amp; (*(p-3) == 't' || *(p-3) == 'T')</span></a>
<a name="5291"><span class="lineNum">    5291 </span><span class="lineCov">          9 :                              &amp;&amp; (*(p-4) == 'c' || *(p-4) == 'C')</span></a>
<a name="5292"><span class="lineNum">    5292 </span><span class="lineCov">          9 :                              &amp;&amp; (*(p-5) == 'o' || *(p-5) == 'O')</span></a>
<a name="5293"><span class="lineNum">    5293 </span><span class="lineCov">          9 :                              &amp;&amp; (*(p-6) == 'd' || *(p-6) == 'D')) {</span></a>
<a name="5294"><span class="lineNum">    5294 </span><span class="lineCov">          9 :                                 state = 1;</span></a>
<a name="5295"><span class="lineNum">    5295 </span><span class="lineCov">          9 :                                 p++;</span></a>
<a name="5296"><span class="lineNum">    5296 </span><span class="lineCov">          9 :                                 goto state_1;</span></a>
<a name="5297"><span class="lineNum">    5297 </span>            :                         }</a>
<a name="5298"><span class="lineNum">    5298 </span><span class="lineNoCov">          0 :                         break;</span></a>
<a name="5299"><span class="lineNum">    5299 </span><span class="lineCov">         69 :                 default:</span></a>
<a name="5300"><span class="lineNum">    5300 </span><span class="lineCov">         69 :                         break;</span></a>
<a name="5301"><span class="lineNum">    5301 </span>            :         }</a>
<a name="5302"><span class="lineNum">    5302 </span><span class="lineCov">        162 :         p++;</span></a>
<a name="5303"><span class="lineNum">    5303 </span><span class="lineCov">        162 :         goto state_3;</span></a>
<a name="5304"><span class="lineNum">    5304 </span>            : </a>
<a name="5305"><span class="lineNum">    5305 </span><span class="lineCov">         90 : state_4:</span></a>
<a name="5306"><span class="lineNum">    5306 </span><span class="lineCov">       1125 :         while (p &lt; end) {</span></a>
<a name="5307"><span class="lineNum">    5307 </span><span class="lineCov">       1125 :                 c = *p;</span></a>
<a name="5308"><span class="lineNum">    5308 </span><span class="lineCov">       1125 :                 if (c == '&gt;' &amp;&amp; !in_q) {</span></a>
<a name="5309"><span class="lineNum">    5309 </span><span class="lineCov">         93 :                         if (p &gt;= buf + 2 &amp;&amp; *(p-1) == '-' &amp;&amp; *(p-2) == '-') {</span></a>
<a name="5310"><span class="lineNum">    5310 </span><span class="lineCov">         90 :                                 in_q = state = 0;</span></a>
<a name="5311"><span class="lineNum">    5311 </span><span class="lineCov">         90 :                                 tp = tbuf;</span></a>
<a name="5312"><span class="lineNum">    5312 </span><span class="lineCov">         90 :                                 p++;</span></a>
<a name="5313"><span class="lineNum">    5313 </span><span class="lineCov">         90 :                                 goto state_0;</span></a>
<a name="5314"><span class="lineNum">    5314 </span>            :                         }</a>
<a name="5315"><span class="lineNum">    5315 </span>            :                 }</a>
<a name="5316"><span class="lineNum">    5316 </span><span class="lineCov">       1035 :                 p++;</span></a>
<a name="5317"><span class="lineNum">    5317 </span>            :         }</a>
<a name="5318"><span class="lineNum">    5318 </span>            : </a>
<a name="5319"><span class="lineNum">    5319 </span><span class="lineNoCov">          0 : finish:</span></a>
<a name="5320"><span class="lineNum">    5320 </span><span class="lineCov">        624 :         if (rp &lt; rbuf + len) {</span></a>
<a name="5321"><span class="lineNum">    5321 </span><span class="lineCov">        453 :                 *rp = '\0';</span></a>
<a name="5322"><span class="lineNum">    5322 </span>            :         }</a>
<a name="5323"><span class="lineNum">    5323 </span><span class="lineCov">        624 :         efree((void *)buf);</span></a>
<a name="5324"><span class="lineNum">    5324 </span><span class="lineCov">        624 :         if (tbuf) {</span></a>
<a name="5325"><span class="lineNum">    5325 </span><span class="lineCov">        276 :                 efree(tbuf);</span></a>
<a name="5326"><span class="lineNum">    5326 </span>            :         }</a>
<a name="5327"><span class="lineNum">    5327 </span><span class="lineCov">        624 :         if (allow_free) {</span></a>
<a name="5328"><span class="lineNum">    5328 </span><span class="lineCov">          6 :                 efree(allow_free);</span></a>
<a name="5329"><span class="lineNum">    5329 </span>            :         }</a>
<a name="5330"><span class="lineNum">    5330 </span>            : </a>
<a name="5331"><span class="lineNum">    5331 </span><span class="lineCov">        624 :         return (size_t)(rp - rbuf);</span></a>
<a name="5332"><span class="lineNum">    5332 </span>            : }</a>
<a name="5333"><span class="lineNum">    5333 </span>            : /* }}} */</a>
<a name="5334"><span class="lineNum">    5334 </span>            : </a>
<a name="5335"><span class="lineNum">    5335 </span>            : /* {{{ Parse a CSV string into an array */</a>
<a name="5336"><span class="lineNum">    5336 </span><span class="lineCov">        108 : PHP_FUNCTION(str_getcsv)</span></a>
<a name="5337"><span class="lineNum">    5337 </span>            : {</a>
<a name="5338"><span class="lineNum">    5338 </span>            :         zend_string *str;</a>
<a name="5339"><span class="lineNum">    5339 </span><span class="lineCov">        108 :         char delim = ',', enc = '&quot;';</span></a>
<a name="5340"><span class="lineNum">    5340 </span><span class="lineCov">        108 :         int esc = (unsigned char) '\\';</span></a>
<a name="5341"><span class="lineNum">    5341 </span><span class="lineCov">        108 :         char *delim_str = NULL, *enc_str = NULL, *esc_str = NULL;</span></a>
<a name="5342"><span class="lineNum">    5342 </span><span class="lineCov">        108 :         size_t delim_len = 0, enc_len = 0, esc_len = 0;</span></a>
<a name="5343"><span class="lineNum">    5343 </span>            : </a>
<a name="5344"><span class="lineNum">    5344 </span><span class="lineCov">        108 :         ZEND_PARSE_PARAMETERS_START(1, 4)</span></a>
<a name="5345"><span class="lineNum">    5345 </span><span class="lineCov">        156 :                 Z_PARAM_STR(str)</span></a>
<a name="5346"><span class="lineNum">    5346 </span><span class="lineCov">         66 :                 Z_PARAM_OPTIONAL</span></a>
<a name="5347"><span class="lineNum">    5347 </span><span class="lineCov">        120 :                 Z_PARAM_STRING(delim_str, delim_len)</span></a>
<a name="5348"><span class="lineNum">    5348 </span><span class="lineCov">         87 :                 Z_PARAM_STRING(enc_str, enc_len)</span></a>
<a name="5349"><span class="lineNum">    5349 </span><span class="lineCov">         57 :                 Z_PARAM_STRING(esc_str, esc_len)</span></a>
<a name="5350"><span class="lineNum">    5350 </span><span class="lineCov">        108 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5351"><span class="lineNum">    5351 </span>            : </a>
<a name="5352"><span class="lineNum">    5352 </span><span class="lineCov">         66 :         delim = delim_len ? delim_str[0] : delim;</span></a>
<a name="5353"><span class="lineNum">    5353 </span><span class="lineCov">         66 :         enc = enc_len ? enc_str[0] : enc;</span></a>
<a name="5354"><span class="lineNum">    5354 </span><span class="lineCov">         66 :         if (esc_str != NULL) {</span></a>
<a name="5355"><span class="lineNum">    5355 </span><span class="lineCov">         24 :                 esc = esc_len ? (unsigned char) esc_str[0] : PHP_CSV_NO_ESCAPE;</span></a>
<a name="5356"><span class="lineNum">    5356 </span>            :         }</a>
<a name="5357"><span class="lineNum">    5357 </span>            : </a>
<a name="5358"><span class="lineNum">    5358 </span><span class="lineCov">         66 :         php_fgetcsv(NULL, delim, enc, esc, ZSTR_LEN(str), ZSTR_VAL(str), return_value);</span></a>
<a name="5359"><span class="lineNum">    5359 </span>            : }</a>
<a name="5360"><span class="lineNum">    5360 </span>            : /* }}} */</a>
<a name="5361"><span class="lineNum">    5361 </span>            : </a>
<a name="5362"><span class="lineNum">    5362 </span>            : /* {{{ Returns the input string repeat mult times */</a>
<a name="5363"><span class="lineNum">    5363 </span><span class="lineCov">     458396 : PHP_FUNCTION(str_repeat)</span></a>
<a name="5364"><span class="lineNum">    5364 </span>            : {</a>
<a name="5365"><span class="lineNum">    5365 </span>            :         zend_string             *input_str;             /* Input string */</a>
<a name="5366"><span class="lineNum">    5366 </span>            :         zend_long               mult;                   /* Multiplier */</a>
<a name="5367"><span class="lineNum">    5367 </span>            :         zend_string     *result;                /* Resulting string */</a>
<a name="5368"><span class="lineNum">    5368 </span>            :         size_t          result_len;             /* Length of the resulting string */</a>
<a name="5369"><span class="lineNum">    5369 </span>            : </a>
<a name="5370"><span class="lineNum">    5370 </span><span class="lineCov">     458396 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="5371"><span class="lineNum">    5371 </span><span class="lineCov">     916696 :                 Z_PARAM_STR(input_str)</span></a>
<a name="5372"><span class="lineNum">    5372 </span><span class="lineCov">     916690 :                 Z_PARAM_LONG(mult)</span></a>
<a name="5373"><span class="lineNum">    5373 </span><span class="lineCov">     458396 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5374"><span class="lineNum">    5374 </span>            : </a>
<a name="5375"><span class="lineNum">    5375 </span><span class="lineCov">     458345 :         if (mult &lt; 0) {</span></a>
<a name="5376"><span class="lineNum">    5376 </span><span class="lineCov">          3 :                 zend_argument_value_error(2, &quot;must be greater than or equal to 0&quot;);</span></a>
<a name="5377"><span class="lineNum">    5377 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="5378"><span class="lineNum">    5378 </span>            :         }</a>
<a name="5379"><span class="lineNum">    5379 </span>            : </a>
<a name="5380"><span class="lineNum">    5380 </span>            :         /* Don't waste our time if it's empty */</a>
<a name="5381"><span class="lineNum">    5381 </span>            :         /* ... or if the multiplier is zero */</a>
<a name="5382"><span class="lineNum">    5382 </span><span class="lineCov">     458342 :         if (ZSTR_LEN(input_str) == 0 || mult == 0)</span></a>
<a name="5383"><span class="lineNum">    5383 </span><span class="lineCov">        169 :                 RETURN_EMPTY_STRING();</span></a>
<a name="5384"><span class="lineNum">    5384 </span>            : </a>
<a name="5385"><span class="lineNum">    5385 </span>            :         /* Initialize the result string */</a>
<a name="5386"><span class="lineNum">    5386 </span><span class="lineCov">     458173 :         result = zend_string_safe_alloc(ZSTR_LEN(input_str), mult, 0, 0);</span></a>
<a name="5387"><span class="lineNum">    5387 </span><span class="lineCov">     458167 :         result_len = ZSTR_LEN(input_str) * mult;</span></a>
<a name="5388"><span class="lineNum">    5388 </span>            : </a>
<a name="5389"><span class="lineNum">    5389 </span>            :         /* Heavy optimization for situations where input string is 1 byte long */</a>
<a name="5390"><span class="lineNum">    5390 </span><span class="lineCov">     458167 :         if (ZSTR_LEN(input_str) == 1) {</span></a>
<a name="5391"><span class="lineNum">    5391 </span><span class="lineCov">     446353 :                 memset(ZSTR_VAL(result), *ZSTR_VAL(input_str), mult);</span></a>
<a name="5392"><span class="lineNum">    5392 </span>            :         } else {</a>
<a name="5393"><span class="lineNum">    5393 </span>            :                 const char *s, *ee;</a>
<a name="5394"><span class="lineNum">    5394 </span>            :                 char *e;</a>
<a name="5395"><span class="lineNum">    5395 </span><span class="lineCov">      11814 :                 ptrdiff_t l=0;</span></a>
<a name="5396"><span class="lineNum">    5396 </span><span class="lineCov">      11814 :                 memcpy(ZSTR_VAL(result), ZSTR_VAL(input_str), ZSTR_LEN(input_str));</span></a>
<a name="5397"><span class="lineNum">    5397 </span><span class="lineCov">      11814 :                 s = ZSTR_VAL(result);</span></a>
<a name="5398"><span class="lineNum">    5398 </span><span class="lineCov">      11814 :                 e = ZSTR_VAL(result) + ZSTR_LEN(input_str);</span></a>
<a name="5399"><span class="lineNum">    5399 </span><span class="lineCov">      11814 :                 ee = ZSTR_VAL(result) + result_len;</span></a>
<a name="5400"><span class="lineNum">    5400 </span>            : </a>
<a name="5401"><span class="lineNum">    5401 </span><span class="lineCov">      98610 :                 while (e&lt;ee) {</span></a>
<a name="5402"><span class="lineNum">    5402 </span><span class="lineCov">      86796 :                         l = (e-s) &lt; (ee-e) ? (e-s) : (ee-e);</span></a>
<a name="5403"><span class="lineNum">    5403 </span><span class="lineCov">      86796 :                         memmove(e, s, l);</span></a>
<a name="5404"><span class="lineNum">    5404 </span><span class="lineCov">      86796 :                         e += l;</span></a>
<a name="5405"><span class="lineNum">    5405 </span>            :                 }</a>
<a name="5406"><span class="lineNum">    5406 </span>            :         }</a>
<a name="5407"><span class="lineNum">    5407 </span>            : </a>
<a name="5408"><span class="lineNum">    5408 </span><span class="lineCov">     458167 :         ZSTR_VAL(result)[result_len] = '\0';</span></a>
<a name="5409"><span class="lineNum">    5409 </span>            : </a>
<a name="5410"><span class="lineNum">    5410 </span><span class="lineCov">     458167 :         RETURN_NEW_STR(result);</span></a>
<a name="5411"><span class="lineNum">    5411 </span>            : }</a>
<a name="5412"><span class="lineNum">    5412 </span>            : /* }}} */</a>
<a name="5413"><span class="lineNum">    5413 </span>            : </a>
<a name="5414"><span class="lineNum">    5414 </span>            : /* {{{ Returns info about what characters are used in input */</a>
<a name="5415"><span class="lineNum">    5415 </span><span class="lineCov">         90 : PHP_FUNCTION(count_chars)</span></a>
<a name="5416"><span class="lineNum">    5416 </span>            : {</a>
<a name="5417"><span class="lineNum">    5417 </span>            :         zend_string *input;</a>
<a name="5418"><span class="lineNum">    5418 </span>            :         int chars[256];</a>
<a name="5419"><span class="lineNum">    5419 </span><span class="lineCov">         90 :         zend_long mymode=0;</span></a>
<a name="5420"><span class="lineNum">    5420 </span>            :         const unsigned char *buf;</a>
<a name="5421"><span class="lineNum">    5421 </span>            :         int inx;</a>
<a name="5422"><span class="lineNum">    5422 </span>            :         char retstr[256];</a>
<a name="5423"><span class="lineNum">    5423 </span><span class="lineCov">         90 :         size_t retlen=0;</span></a>
<a name="5424"><span class="lineNum">    5424 </span><span class="lineCov">         90 :         size_t tmp = 0;</span></a>
<a name="5425"><span class="lineNum">    5425 </span>            : </a>
<a name="5426"><span class="lineNum">    5426 </span><span class="lineCov">         90 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="5427"><span class="lineNum">    5427 </span><span class="lineCov">         96 :                 Z_PARAM_STR(input)</span></a>
<a name="5428"><span class="lineNum">    5428 </span><span class="lineCov">         42 :                 Z_PARAM_OPTIONAL</span></a>
<a name="5429"><span class="lineNum">    5429 </span><span class="lineCov">         78 :                 Z_PARAM_LONG(mymode)</span></a>
<a name="5430"><span class="lineNum">    5430 </span><span class="lineCov">         90 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5431"><span class="lineNum">    5431 </span>            : </a>
<a name="5432"><span class="lineNum">    5432 </span><span class="lineCov">         42 :         if (mymode &lt; 0 || mymode &gt; 4) {</span></a>
<a name="5433"><span class="lineNum">    5433 </span><span class="lineCov">          3 :                 zend_argument_value_error(2, &quot;must be between 1 and 4 (inclusive)&quot;);</span></a>
<a name="5434"><span class="lineNum">    5434 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="5435"><span class="lineNum">    5435 </span>            :         }</a>
<a name="5436"><span class="lineNum">    5436 </span>            : </a>
<a name="5437"><span class="lineNum">    5437 </span><span class="lineCov">         39 :         buf = (const unsigned char *) ZSTR_VAL(input);</span></a>
<a name="5438"><span class="lineNum">    5438 </span><span class="lineCov">         39 :         memset((void*) chars, 0, sizeof(chars));</span></a>
<a name="5439"><span class="lineNum">    5439 </span>            : </a>
<a name="5440"><span class="lineNum">    5440 </span><span class="lineCov">       1950 :         while (tmp &lt; ZSTR_LEN(input)) {</span></a>
<a name="5441"><span class="lineNum">    5441 </span><span class="lineCov">       1911 :                 chars[*buf]++;</span></a>
<a name="5442"><span class="lineNum">    5442 </span><span class="lineCov">       1911 :                 buf++;</span></a>
<a name="5443"><span class="lineNum">    5443 </span><span class="lineCov">       1911 :                 tmp++;</span></a>
<a name="5444"><span class="lineNum">    5444 </span>            :         }</a>
<a name="5445"><span class="lineNum">    5445 </span>            : </a>
<a name="5446"><span class="lineNum">    5446 </span><span class="lineCov">         39 :         if (mymode &lt; 3) {</span></a>
<a name="5447"><span class="lineNum">    5447 </span><span class="lineCov">         27 :                 array_init(return_value);</span></a>
<a name="5448"><span class="lineNum">    5448 </span>            :         }</a>
<a name="5449"><span class="lineNum">    5449 </span>            : </a>
<a name="5450"><span class="lineNum">    5450 </span><span class="lineCov">      10023 :         for (inx = 0; inx &lt; 256; inx++) {</span></a>
<a name="5451"><span class="lineNum">    5451 </span><span class="lineCov">       9984 :                 switch (mymode) {</span></a>
<a name="5452"><span class="lineNum">    5452 </span><span class="lineCov">       3840 :                         case 0:</span></a>
<a name="5453"><span class="lineNum">    5453 </span><span class="lineCov">       3840 :                                 add_index_long(return_value, inx, chars[inx]);</span></a>
<a name="5454"><span class="lineNum">    5454 </span><span class="lineCov">       3840 :                                 break;</span></a>
<a name="5455"><span class="lineNum">    5455 </span><span class="lineCov">       1536 :                         case 1:</span></a>
<a name="5456"><span class="lineNum">    5456 </span><span class="lineCov">       1536 :                                 if (chars[inx] != 0) {</span></a>
<a name="5457"><span class="lineNum">    5457 </span><span class="lineCov">        111 :                                         add_index_long(return_value, inx, chars[inx]);</span></a>
<a name="5458"><span class="lineNum">    5458 </span>            :                                 }</a>
<a name="5459"><span class="lineNum">    5459 </span><span class="lineCov">       1536 :                                 break;</span></a>
<a name="5460"><span class="lineNum">    5460 </span><span class="lineCov">       1536 :                         case 2:</span></a>
<a name="5461"><span class="lineNum">    5461 </span><span class="lineCov">       1536 :                                 if (chars[inx] == 0) {</span></a>
<a name="5462"><span class="lineNum">    5462 </span><span class="lineCov">       1425 :                                         add_index_long(return_value, inx, chars[inx]);</span></a>
<a name="5463"><span class="lineNum">    5463 </span>            :                                 }</a>
<a name="5464"><span class="lineNum">    5464 </span><span class="lineCov">       1536 :                                 break;</span></a>
<a name="5465"><span class="lineNum">    5465 </span><span class="lineCov">       1536 :                         case 3:</span></a>
<a name="5466"><span class="lineNum">    5466 </span><span class="lineCov">       1536 :                                 if (chars[inx] != 0) {</span></a>
<a name="5467"><span class="lineNum">    5467 </span><span class="lineCov">        111 :                                         retstr[retlen++] = inx;</span></a>
<a name="5468"><span class="lineNum">    5468 </span>            :                                 }</a>
<a name="5469"><span class="lineNum">    5469 </span><span class="lineCov">       1536 :                                 break;</span></a>
<a name="5470"><span class="lineNum">    5470 </span><span class="lineCov">       1536 :                         case 4:</span></a>
<a name="5471"><span class="lineNum">    5471 </span><span class="lineCov">       1536 :                                 if (chars[inx] == 0) {</span></a>
<a name="5472"><span class="lineNum">    5472 </span><span class="lineCov">       1425 :                                         retstr[retlen++] = inx;</span></a>
<a name="5473"><span class="lineNum">    5473 </span>            :                                 }</a>
<a name="5474"><span class="lineNum">    5474 </span><span class="lineCov">       1536 :                                 break;</span></a>
<a name="5475"><span class="lineNum">    5475 </span>            :                 }</a>
<a name="5476"><span class="lineNum">    5476 </span><span class="lineCov">       9984 :         }</span></a>
<a name="5477"><span class="lineNum">    5477 </span>            : </a>
<a name="5478"><span class="lineNum">    5478 </span><span class="lineCov">         39 :         if (mymode == 3 || mymode == 4) {</span></a>
<a name="5479"><span class="lineNum">    5479 </span><span class="lineCov">         24 :                 RETURN_STRINGL(retstr, retlen);</span></a>
<a name="5480"><span class="lineNum">    5480 </span>            :         }</a>
<a name="5481"><span class="lineNum">    5481 </span>            : }</a>
<a name="5482"><span class="lineNum">    5482 </span>            : /* }}} */</a>
<a name="5483"><span class="lineNum">    5483 </span>            : </a>
<a name="5484"><span class="lineNum">    5484 </span>            : /* {{{ php_strnatcmp */</a>
<a name="5485"><span class="lineNum">    5485 </span><span class="lineCov">        264 : static void php_strnatcmp(INTERNAL_FUNCTION_PARAMETERS, int fold_case)</span></a>
<a name="5486"><span class="lineNum">    5486 </span>            : {</a>
<a name="5487"><span class="lineNum">    5487 </span>            :         zend_string *s1, *s2;</a>
<a name="5488"><span class="lineNum">    5488 </span>            : </a>
<a name="5489"><span class="lineNum">    5489 </span><span class="lineCov">        264 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="5490"><span class="lineNum">    5490 </span><span class="lineCov">        336 :                 Z_PARAM_STR(s1)</span></a>
<a name="5491"><span class="lineNum">    5491 </span><span class="lineCov">        324 :                 Z_PARAM_STR(s2)</span></a>
<a name="5492"><span class="lineNum">    5492 </span><span class="lineCov">        264 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5493"><span class="lineNum">    5493 </span>            : </a>
<a name="5494"><span class="lineNum">    5494 </span><span class="lineCov">        162 :         RETURN_LONG(strnatcmp_ex(ZSTR_VAL(s1), ZSTR_LEN(s1),</span></a>
<a name="5495"><span class="lineNum">    5495 </span>            :                                                          ZSTR_VAL(s2), ZSTR_LEN(s2),</a>
<a name="5496"><span class="lineNum">    5496 </span>            :                                                          fold_case));</a>
<a name="5497"><span class="lineNum">    5497 </span>            : }</a>
<a name="5498"><span class="lineNum">    5498 </span>            : /* }}} */</a>
<a name="5499"><span class="lineNum">    5499 </span>            : </a>
<a name="5500"><span class="lineNum">    5500 </span><span class="lineNoCov">          0 : PHPAPI int string_natural_compare_function_ex(zval *result, zval *op1, zval *op2, bool case_insensitive) /* {{{ */</span></a>
<a name="5501"><span class="lineNum">    5501 </span>            : {</a>
<a name="5502"><span class="lineNum">    5502 </span>            :         zend_string *tmp_str1, *tmp_str2;</a>
<a name="5503"><span class="lineNum">    5503 </span><span class="lineNoCov">          0 :         zend_string *str1 = zval_get_tmp_string(op1, &amp;tmp_str1);</span></a>
<a name="5504"><span class="lineNum">    5504 </span><span class="lineNoCov">          0 :         zend_string *str2 = zval_get_tmp_string(op2, &amp;tmp_str2);</span></a>
<a name="5505"><span class="lineNum">    5505 </span>            : </a>
<a name="5506"><span class="lineNum">    5506 </span><span class="lineNoCov">          0 :         ZVAL_LONG(result, strnatcmp_ex(ZSTR_VAL(str1), ZSTR_LEN(str1), ZSTR_VAL(str2), ZSTR_LEN(str2), case_insensitive));</span></a>
<a name="5507"><span class="lineNum">    5507 </span>            : </a>
<a name="5508"><span class="lineNum">    5508 </span><span class="lineNoCov">          0 :         zend_tmp_string_release(tmp_str1);</span></a>
<a name="5509"><span class="lineNum">    5509 </span><span class="lineNoCov">          0 :         zend_tmp_string_release(tmp_str2);</span></a>
<a name="5510"><span class="lineNum">    5510 </span><span class="lineNoCov">          0 :         return SUCCESS;</span></a>
<a name="5511"><span class="lineNum">    5511 </span>            : }</a>
<a name="5512"><span class="lineNum">    5512 </span>            : /* }}} */</a>
<a name="5513"><span class="lineNum">    5513 </span>            : </a>
<a name="5514"><span class="lineNum">    5514 </span><span class="lineNoCov">          0 : PHPAPI int string_natural_case_compare_function(zval *result, zval *op1, zval *op2) /* {{{ */</span></a>
<a name="5515"><span class="lineNum">    5515 </span>            : {</a>
<a name="5516"><span class="lineNum">    5516 </span><span class="lineNoCov">          0 :         return string_natural_compare_function_ex(result, op1, op2, 1);</span></a>
<a name="5517"><span class="lineNum">    5517 </span>            : }</a>
<a name="5518"><span class="lineNum">    5518 </span>            : /* }}} */</a>
<a name="5519"><span class="lineNum">    5519 </span>            : </a>
<a name="5520"><span class="lineNum">    5520 </span><span class="lineNoCov">          0 : PHPAPI int string_natural_compare_function(zval *result, zval *op1, zval *op2) /* {{{ */</span></a>
<a name="5521"><span class="lineNum">    5521 </span>            : {</a>
<a name="5522"><span class="lineNum">    5522 </span><span class="lineNoCov">          0 :         return string_natural_compare_function_ex(result, op1, op2, 0);</span></a>
<a name="5523"><span class="lineNum">    5523 </span>            : }</a>
<a name="5524"><span class="lineNum">    5524 </span>            : /* }}} */</a>
<a name="5525"><span class="lineNum">    5525 </span>            : </a>
<a name="5526"><span class="lineNum">    5526 </span>            : /* {{{ Returns the result of string comparison using 'natural' algorithm */</a>
<a name="5527"><span class="lineNum">    5527 </span><span class="lineCov">        153 : PHP_FUNCTION(strnatcmp)</span></a>
<a name="5528"><span class="lineNum">    5528 </span>            : {</a>
<a name="5529"><span class="lineNum">    5529 </span><span class="lineCov">        153 :         php_strnatcmp(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0);</span></a>
<a name="5530"><span class="lineNum">    5530 </span><span class="lineCov">        153 : }</span></a>
<a name="5531"><span class="lineNum">    5531 </span>            : /* }}} */</a>
<a name="5532"><span class="lineNum">    5532 </span>            : </a>
<a name="5533"><span class="lineNum">    5533 </span>            : /* {{{ Returns numeric formatting information based on the current locale */</a>
<a name="5534"><span class="lineNum">    5534 </span><span class="lineCov">         72 : PHP_FUNCTION(localeconv)</span></a>
<a name="5535"><span class="lineNum">    5535 </span>            : {</a>
<a name="5536"><span class="lineNum">    5536 </span>            :         zval grouping, mon_grouping;</a>
<a name="5537"><span class="lineNum">    5537 </span>            :         int len, i;</a>
<a name="5538"><span class="lineNum">    5538 </span>            : </a>
<a name="5539"><span class="lineNum">    5539 </span><span class="lineCov">         72 :         ZEND_PARSE_PARAMETERS_NONE();</span></a>
<a name="5540"><span class="lineNum">    5540 </span>            : </a>
<a name="5541"><span class="lineNum">    5541 </span><span class="lineCov">         24 :         array_init(return_value);</span></a>
<a name="5542"><span class="lineNum">    5542 </span><span class="lineCov">         24 :         array_init(&amp;grouping);</span></a>
<a name="5543"><span class="lineNum">    5543 </span><span class="lineCov">         24 :         array_init(&amp;mon_grouping);</span></a>
<a name="5544"><span class="lineNum">    5544 </span>            : </a>
<a name="5545"><span class="lineNum">    5545 </span>            :         {</a>
<a name="5546"><span class="lineNum">    5546 </span>            :                 struct lconv currlocdata;</a>
<a name="5547"><span class="lineNum">    5547 </span>            : </a>
<a name="5548"><span class="lineNum">    5548 </span><span class="lineCov">         24 :                 localeconv_r( &amp;currlocdata );</span></a>
<a name="5549"><span class="lineNum">    5549 </span>            : </a>
<a name="5550"><span class="lineNum">    5550 </span>            :                 /* Grab the grouping data out of the array */</a>
<a name="5551"><span class="lineNum">    5551 </span><span class="lineCov">         24 :                 len = (int)strlen(currlocdata.grouping);</span></a>
<a name="5552"><span class="lineNum">    5552 </span>            : </a>
<a name="5553"><span class="lineNum">    5553 </span><span class="lineCov">         60 :                 for (i = 0; i &lt; len; i++) {</span></a>
<a name="5554"><span class="lineNum">    5554 </span><span class="lineCov">         36 :                         add_index_long(&amp;grouping, i, currlocdata.grouping[i]);</span></a>
<a name="5555"><span class="lineNum">    5555 </span>            :                 }</a>
<a name="5556"><span class="lineNum">    5556 </span>            : </a>
<a name="5557"><span class="lineNum">    5557 </span>            :                 /* Grab the monetary grouping data out of the array */</a>
<a name="5558"><span class="lineNum">    5558 </span><span class="lineCov">         24 :                 len = (int)strlen(currlocdata.mon_grouping);</span></a>
<a name="5559"><span class="lineNum">    5559 </span>            : </a>
<a name="5560"><span class="lineNum">    5560 </span><span class="lineCov">         60 :                 for (i = 0; i &lt; len; i++) {</span></a>
<a name="5561"><span class="lineNum">    5561 </span><span class="lineCov">         36 :                         add_index_long(&amp;mon_grouping, i, currlocdata.mon_grouping[i]);</span></a>
<a name="5562"><span class="lineNum">    5562 </span>            :                 }</a>
<a name="5563"><span class="lineNum">    5563 </span>            : </a>
<a name="5564"><span class="lineNum">    5564 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;decimal_point&quot;,     currlocdata.decimal_point);</span></a>
<a name="5565"><span class="lineNum">    5565 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;thousands_sep&quot;,     currlocdata.thousands_sep);</span></a>
<a name="5566"><span class="lineNum">    5566 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;int_curr_symbol&quot;,   currlocdata.int_curr_symbol);</span></a>
<a name="5567"><span class="lineNum">    5567 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;currency_symbol&quot;,   currlocdata.currency_symbol);</span></a>
<a name="5568"><span class="lineNum">    5568 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;mon_decimal_point&quot;, currlocdata.mon_decimal_point);</span></a>
<a name="5569"><span class="lineNum">    5569 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;mon_thousands_sep&quot;, currlocdata.mon_thousands_sep);</span></a>
<a name="5570"><span class="lineNum">    5570 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;positive_sign&quot;,     currlocdata.positive_sign);</span></a>
<a name="5571"><span class="lineNum">    5571 </span><span class="lineCov">         24 :                 add_assoc_string(return_value, &quot;negative_sign&quot;,     currlocdata.negative_sign);</span></a>
<a name="5572"><span class="lineNum">    5572 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;int_frac_digits&quot;,   currlocdata.int_frac_digits);</span></a>
<a name="5573"><span class="lineNum">    5573 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;frac_digits&quot;,       currlocdata.frac_digits);</span></a>
<a name="5574"><span class="lineNum">    5574 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;p_cs_precedes&quot;,     currlocdata.p_cs_precedes);</span></a>
<a name="5575"><span class="lineNum">    5575 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;p_sep_by_space&quot;,    currlocdata.p_sep_by_space);</span></a>
<a name="5576"><span class="lineNum">    5576 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;n_cs_precedes&quot;,     currlocdata.n_cs_precedes);</span></a>
<a name="5577"><span class="lineNum">    5577 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;n_sep_by_space&quot;,    currlocdata.n_sep_by_space);</span></a>
<a name="5578"><span class="lineNum">    5578 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;p_sign_posn&quot;,       currlocdata.p_sign_posn);</span></a>
<a name="5579"><span class="lineNum">    5579 </span><span class="lineCov">         24 :                 add_assoc_long(  return_value, &quot;n_sign_posn&quot;,       currlocdata.n_sign_posn);</span></a>
<a name="5580"><span class="lineNum">    5580 </span>            :         }</a>
<a name="5581"><span class="lineNum">    5581 </span>            : </a>
<a name="5582"><span class="lineNum">    5582 </span><span class="lineCov">         24 :         zend_hash_str_update(Z_ARRVAL_P(return_value), &quot;grouping&quot;, sizeof(&quot;grouping&quot;)-1, &amp;grouping);</span></a>
<a name="5583"><span class="lineNum">    5583 </span><span class="lineCov">         24 :         zend_hash_str_update(Z_ARRVAL_P(return_value), &quot;mon_grouping&quot;, sizeof(&quot;mon_grouping&quot;)-1, &amp;mon_grouping);</span></a>
<a name="5584"><span class="lineNum">    5584 </span>            : }</a>
<a name="5585"><span class="lineNum">    5585 </span>            : /* }}} */</a>
<a name="5586"><span class="lineNum">    5586 </span>            : </a>
<a name="5587"><span class="lineNum">    5587 </span>            : /* {{{ Returns the result of case-insensitive string comparison using 'natural' algorithm */</a>
<a name="5588"><span class="lineNum">    5588 </span><span class="lineCov">        111 : PHP_FUNCTION(strnatcasecmp)</span></a>
<a name="5589"><span class="lineNum">    5589 </span>            : {</a>
<a name="5590"><span class="lineNum">    5590 </span><span class="lineCov">        111 :         php_strnatcmp(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1);</span></a>
<a name="5591"><span class="lineNum">    5591 </span><span class="lineCov">        111 : }</span></a>
<a name="5592"><span class="lineNum">    5592 </span>            : /* }}} */</a>
<a name="5593"><span class="lineNum">    5593 </span>            : </a>
<a name="5594"><span class="lineNum">    5594 </span>            : /* {{{ Returns the number of times a substring occurs in the string */</a>
<a name="5595"><span class="lineNum">    5595 </span><span class="lineCov">        183 : PHP_FUNCTION(substr_count)</span></a>
<a name="5596"><span class="lineNum">    5596 </span>            : {</a>
<a name="5597"><span class="lineNum">    5597 </span>            :         char *haystack, *needle;</a>
<a name="5598"><span class="lineNum">    5598 </span><span class="lineCov">        183 :         zend_long offset = 0, length = 0;</span></a>
<a name="5599"><span class="lineNum">    5599 </span><span class="lineCov">        183 :         bool length_is_null = 1;</span></a>
<a name="5600"><span class="lineNum">    5600 </span>            :         zend_long count;</a>
<a name="5601"><span class="lineNum">    5601 </span>            :         size_t haystack_len, needle_len;</a>
<a name="5602"><span class="lineNum">    5602 </span>            :         const char *p, *endp;</a>
<a name="5603"><span class="lineNum">    5603 </span>            : </a>
<a name="5604"><span class="lineNum">    5604 </span><span class="lineCov">        183 :         ZEND_PARSE_PARAMETERS_START(2, 4)</span></a>
<a name="5605"><span class="lineNum">    5605 </span><span class="lineCov">        294 :                 Z_PARAM_STRING(haystack, haystack_len)</span></a>
<a name="5606"><span class="lineNum">    5606 </span><span class="lineCov">        276 :                 Z_PARAM_STRING(needle, needle_len)</span></a>
<a name="5607"><span class="lineNum">    5607 </span><span class="lineCov">        138 :                 Z_PARAM_OPTIONAL</span></a>
<a name="5608"><span class="lineNum">    5608 </span><span class="lineCov">        201 :                 Z_PARAM_LONG(offset)</span></a>
<a name="5609"><span class="lineNum">    5609 </span><span class="lineCov">        105 :                 Z_PARAM_LONG_OR_NULL(length, length_is_null)</span></a>
<a name="5610"><span class="lineNum">    5610 </span><span class="lineCov">        183 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5611"><span class="lineNum">    5611 </span>            : </a>
<a name="5612"><span class="lineNum">    5612 </span><span class="lineCov">        138 :         if (needle_len == 0) {</span></a>
<a name="5613"><span class="lineNum">    5613 </span><span class="lineCov">         15 :                 zend_argument_value_error(2, &quot;cannot be empty&quot;);</span></a>
<a name="5614"><span class="lineNum">    5614 </span><span class="lineCov">         15 :                 RETURN_THROWS();</span></a>
<a name="5615"><span class="lineNum">    5615 </span>            :         }</a>
<a name="5616"><span class="lineNum">    5616 </span>            : </a>
<a name="5617"><span class="lineNum">    5617 </span><span class="lineCov">        123 :         p = haystack;</span></a>
<a name="5618"><span class="lineNum">    5618 </span>            : </a>
<a name="5619"><span class="lineNum">    5619 </span><span class="lineCov">        123 :         if (offset) {</span></a>
<a name="5620"><span class="lineNum">    5620 </span><span class="lineCov">         51 :                 if (offset &lt; 0) {</span></a>
<a name="5621"><span class="lineNum">    5621 </span><span class="lineCov">         15 :                         offset += (zend_long)haystack_len;</span></a>
<a name="5622"><span class="lineNum">    5622 </span>            :                 }</a>
<a name="5623"><span class="lineNum">    5623 </span><span class="lineCov">         51 :                 if ((offset &lt; 0) || ((size_t)offset &gt; haystack_len)) {</span></a>
<a name="5624"><span class="lineNum">    5624 </span><span class="lineCov">         12 :                         zend_argument_value_error(3, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="5625"><span class="lineNum">    5625 </span><span class="lineCov">         12 :                         RETURN_THROWS();</span></a>
<a name="5626"><span class="lineNum">    5626 </span>            :                 }</a>
<a name="5627"><span class="lineNum">    5627 </span><span class="lineCov">         39 :                 p += offset;</span></a>
<a name="5628"><span class="lineNum">    5628 </span><span class="lineCov">         39 :                 haystack_len -= offset;</span></a>
<a name="5629"><span class="lineNum">    5629 </span>            :         }</a>
<a name="5630"><span class="lineNum">    5630 </span>            : </a>
<a name="5631"><span class="lineNum">    5631 </span><span class="lineCov">        111 :         if (!length_is_null) {</span></a>
<a name="5632"><span class="lineNum">    5632 </span><span class="lineCov">         27 :                 if (length &lt; 0) {</span></a>
<a name="5633"><span class="lineNum">    5633 </span><span class="lineCov">          6 :                         length += haystack_len;</span></a>
<a name="5634"><span class="lineNum">    5634 </span>            :                 }</a>
<a name="5635"><span class="lineNum">    5635 </span><span class="lineCov">         27 :                 if (length &lt; 0 || ((size_t)length &gt; haystack_len)) {</span></a>
<a name="5636"><span class="lineNum">    5636 </span><span class="lineCov">          9 :                         zend_argument_value_error(4, &quot;must be contained in argument #1 ($haystack)&quot;);</span></a>
<a name="5637"><span class="lineNum">    5637 </span><span class="lineCov">          9 :                         RETURN_THROWS();</span></a>
<a name="5638"><span class="lineNum">    5638 </span>            :                 }</a>
<a name="5639"><span class="lineNum">    5639 </span>            :         } else {</a>
<a name="5640"><span class="lineNum">    5640 </span><span class="lineCov">         84 :                 length = haystack_len;</span></a>
<a name="5641"><span class="lineNum">    5641 </span>            :         }</a>
<a name="5642"><span class="lineNum">    5642 </span>            : </a>
<a name="5643"><span class="lineNum">    5643 </span><span class="lineCov">        102 :         if (needle_len == 1) {</span></a>
<a name="5644"><span class="lineNum">    5644 </span><span class="lineCov">        102 :                 count = count_chars(p, length, needle[0]);</span></a>
<a name="5645"><span class="lineNum">    5645 </span>            :         } else {</a>
<a name="5646"><span class="lineNum">    5646 </span><span class="lineCov">         51 :                 count = 0;</span></a>
<a name="5647"><span class="lineNum">    5647 </span><span class="lineCov">         51 :                 endp = p + length;</span></a>
<a name="5648"><span class="lineNum">    5648 </span><span class="lineCov">       4986 :                 while ((p = (char*)php_memnstr(p, needle, needle_len, endp))) {</span></a>
<a name="5649"><span class="lineNum">    5649 </span><span class="lineCov">       2442 :                         p += needle_len;</span></a>
<a name="5650"><span class="lineNum">    5650 </span><span class="lineCov">       2442 :                         count++;</span></a>
<a name="5651"><span class="lineNum">    5651 </span>            :                 }</a>
<a name="5652"><span class="lineNum">    5652 </span>            :         }</a>
<a name="5653"><span class="lineNum">    5653 </span>            : </a>
<a name="5654"><span class="lineNum">    5654 </span><span class="lineCov">        102 :         RETURN_LONG(count);</span></a>
<a name="5655"><span class="lineNum">    5655 </span>            : }</a>
<a name="5656"><span class="lineNum">    5656 </span>            : /* }}} */</a>
<a name="5657"><span class="lineNum">    5657 </span>            : </a>
<a name="5658"><span class="lineNum">    5658 </span>            : /* {{{ Returns input string padded on the left or right to specified length with pad_string */</a>
<a name="5659"><span class="lineNum">    5659 </span><span class="lineCov">       8388 : PHP_FUNCTION(str_pad)</span></a>
<a name="5660"><span class="lineNum">    5660 </span>            : {</a>
<a name="5661"><span class="lineNum">    5661 </span>            :         /* Input arguments */</a>
<a name="5662"><span class="lineNum">    5662 </span>            :         zend_string *input;                             /* Input string */</a>
<a name="5663"><span class="lineNum">    5663 </span>            :         zend_long pad_length;                   /* Length to pad to */</a>
<a name="5664"><span class="lineNum">    5664 </span>            : </a>
<a name="5665"><span class="lineNum">    5665 </span>            :         /* Helper variables */</a>
<a name="5666"><span class="lineNum">    5666 </span>            :         size_t num_pad_chars;           /* Number of padding characters (total - input size) */</a>
<a name="5667"><span class="lineNum">    5667 </span><span class="lineCov">       8388 :         char *pad_str = &quot; &quot;; /* Pointer to padding string */</span></a>
<a name="5668"><span class="lineNum">    5668 </span><span class="lineCov">       8388 :         size_t pad_str_len = 1;</span></a>
<a name="5669"><span class="lineNum">    5669 </span><span class="lineCov">       8388 :         zend_long   pad_type_val = STR_PAD_RIGHT; /* The padding type value */</span></a>
<a name="5670"><span class="lineNum">    5670 </span><span class="lineCov">       8388 :         size_t     i, left_pad=0, right_pad=0;</span></a>
<a name="5671"><span class="lineNum">    5671 </span><span class="lineCov">       8388 :         zend_string *result = NULL;     /* Resulting string */</span></a>
<a name="5672"><span class="lineNum">    5672 </span>            : </a>
<a name="5673"><span class="lineNum">    5673 </span><span class="lineCov">       8388 :         ZEND_PARSE_PARAMETERS_START(2, 4)</span></a>
<a name="5674"><span class="lineNum">    5674 </span><span class="lineCov">      16698 :                 Z_PARAM_STR(input)</span></a>
<a name="5675"><span class="lineNum">    5675 </span><span class="lineCov">      16680 :                 Z_PARAM_LONG(pad_length)</span></a>
<a name="5676"><span class="lineNum">    5676 </span><span class="lineCov">       8337 :                 Z_PARAM_OPTIONAL</span></a>
<a name="5677"><span class="lineNum">    5677 </span><span class="lineCov">       9036 :                 Z_PARAM_STRING(pad_str, pad_str_len)</span></a>
<a name="5678"><span class="lineNum">    5678 </span><span class="lineCov">       1191 :                 Z_PARAM_LONG(pad_type_val)</span></a>
<a name="5679"><span class="lineNum">    5679 </span><span class="lineCov">       8388 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5680"><span class="lineNum">    5680 </span>            : </a>
<a name="5681"><span class="lineNum">    5681 </span>            :         /* If resulting string turns out to be shorter than input string,</a>
<a name="5682"><span class="lineNum">    5682 </span>            :            we simply copy the input and return. */</a>
<a name="5683"><span class="lineNum">    5683 </span><span class="lineCov">       8337 :         if (pad_length &lt; 0  || (size_t)pad_length &lt;= ZSTR_LEN(input)) {</span></a>
<a name="5684"><span class="lineNum">    5684 </span><span class="lineCov">       1044 :                 RETURN_STR_COPY(input);</span></a>
<a name="5685"><span class="lineNum">    5685 </span>            :         }</a>
<a name="5686"><span class="lineNum">    5686 </span>            : </a>
<a name="5687"><span class="lineNum">    5687 </span><span class="lineCov">       7941 :         if (pad_str_len == 0) {</span></a>
<a name="5688"><span class="lineNum">    5688 </span><span class="lineCov">          3 :                 zend_argument_value_error(3, &quot;must be a non-empty string&quot;);</span></a>
<a name="5689"><span class="lineNum">    5689 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="5690"><span class="lineNum">    5690 </span>            :         }</a>
<a name="5691"><span class="lineNum">    5691 </span>            : </a>
<a name="5692"><span class="lineNum">    5692 </span><span class="lineCov">       7938 :         if (pad_type_val &lt; STR_PAD_LEFT || pad_type_val &gt; STR_PAD_BOTH) {</span></a>
<a name="5693"><span class="lineNum">    5693 </span><span class="lineCov">          3 :                 zend_argument_value_error(4, &quot;must be STR_PAD_LEFT, STR_PAD_RIGHT, or STR_PAD_BOTH&quot;);</span></a>
<a name="5694"><span class="lineNum">    5694 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="5695"><span class="lineNum">    5695 </span>            :         }</a>
<a name="5696"><span class="lineNum">    5696 </span>            : </a>
<a name="5697"><span class="lineNum">    5697 </span><span class="lineCov">       7935 :         num_pad_chars = pad_length - ZSTR_LEN(input);</span></a>
<a name="5698"><span class="lineNum">    5698 </span><span class="lineCov">       7935 :         result = zend_string_safe_alloc(1, ZSTR_LEN(input), num_pad_chars, 0);</span></a>
<a name="5699"><span class="lineNum">    5699 </span><span class="lineCov">       7932 :         ZSTR_LEN(result) = 0;</span></a>
<a name="5700"><span class="lineNum">    5700 </span>            : </a>
<a name="5701"><span class="lineNum">    5701 </span>            :         /* We need to figure out the left/right padding lengths. */</a>
<a name="5702"><span class="lineNum">    5702 </span><span class="lineCov">       7932 :         switch (pad_type_val) {</span></a>
<a name="5703"><span class="lineNum">    5703 </span><span class="lineCov">       7731 :                 case STR_PAD_RIGHT:</span></a>
<a name="5704"><span class="lineNum">    5704 </span><span class="lineCov">       7731 :                         left_pad = 0;</span></a>
<a name="5705"><span class="lineNum">    5705 </span><span class="lineCov">       7731 :                         right_pad = num_pad_chars;</span></a>
<a name="5706"><span class="lineNum">    5706 </span><span class="lineCov">       7731 :                         break;</span></a>
<a name="5707"><span class="lineNum">    5707 </span>            : </a>
<a name="5708"><span class="lineNum">    5708 </span><span class="lineCov">        117 :                 case STR_PAD_LEFT:</span></a>
<a name="5709"><span class="lineNum">    5709 </span><span class="lineCov">        117 :                         left_pad = num_pad_chars;</span></a>
<a name="5710"><span class="lineNum">    5710 </span><span class="lineCov">        117 :                         right_pad = 0;</span></a>
<a name="5711"><span class="lineNum">    5711 </span><span class="lineCov">        117 :                         break;</span></a>
<a name="5712"><span class="lineNum">    5712 </span>            : </a>
<a name="5713"><span class="lineNum">    5713 </span><span class="lineCov">         84 :                 case STR_PAD_BOTH:</span></a>
<a name="5714"><span class="lineNum">    5714 </span><span class="lineCov">         84 :                         left_pad = num_pad_chars / 2;</span></a>
<a name="5715"><span class="lineNum">    5715 </span><span class="lineCov">         84 :                         right_pad = num_pad_chars - left_pad;</span></a>
<a name="5716"><span class="lineNum">    5716 </span><span class="lineCov">         84 :                         break;</span></a>
<a name="5717"><span class="lineNum">    5717 </span>            :         }</a>
<a name="5718"><span class="lineNum">    5718 </span>            : </a>
<a name="5719"><span class="lineNum">    5719 </span>            :         /* First we pad on the left. */</a>
<a name="5720"><span class="lineNum">    5720 </span><span class="lineCov">       9174 :         for (i = 0; i &lt; left_pad; i++)</span></a>
<a name="5721"><span class="lineNum">    5721 </span><span class="lineCov">       1242 :                 ZSTR_VAL(result)[ZSTR_LEN(result)++] = pad_str[i % pad_str_len];</span></a>
<a name="5722"><span class="lineNum">    5722 </span>            : </a>
<a name="5723"><span class="lineNum">    5723 </span>            :         /* Then we copy the input string. */</a>
<a name="5724"><span class="lineNum">    5724 </span><span class="lineCov">       7932 :         memcpy(ZSTR_VAL(result) + ZSTR_LEN(result), ZSTR_VAL(input), ZSTR_LEN(input));</span></a>
<a name="5725"><span class="lineNum">    5725 </span><span class="lineCov">       7932 :         ZSTR_LEN(result) += ZSTR_LEN(input);</span></a>
<a name="5726"><span class="lineNum">    5726 </span>            : </a>
<a name="5727"><span class="lineNum">    5727 </span>            :         /* Finally, we pad on the right. */</a>
<a name="5728"><span class="lineNum">    5728 </span><span class="lineCov">    6340360 :         for (i = 0; i &lt; right_pad; i++)</span></a>
<a name="5729"><span class="lineNum">    5729 </span><span class="lineCov">    6332420 :                 ZSTR_VAL(result)[ZSTR_LEN(result)++] = pad_str[i % pad_str_len];</span></a>
<a name="5730"><span class="lineNum">    5730 </span>            : </a>
<a name="5731"><span class="lineNum">    5731 </span><span class="lineCov">       7932 :         ZSTR_VAL(result)[ZSTR_LEN(result)] = '\0';</span></a>
<a name="5732"><span class="lineNum">    5732 </span>            : </a>
<a name="5733"><span class="lineNum">    5733 </span><span class="lineCov">       7932 :         RETURN_NEW_STR(result);</span></a>
<a name="5734"><span class="lineNum">    5734 </span>            : }</a>
<a name="5735"><span class="lineNum">    5735 </span>            : /* }}} */</a>
<a name="5736"><span class="lineNum">    5736 </span>            : </a>
<a name="5737"><span class="lineNum">    5737 </span>            : /* {{{ Implements an ANSI C compatible sscanf */</a>
<a name="5738"><span class="lineNum">    5738 </span><span class="lineCov">        135 : PHP_FUNCTION(sscanf)</span></a>
<a name="5739"><span class="lineNum">    5739 </span>            : {</a>
<a name="5740"><span class="lineNum">    5740 </span><span class="lineCov">        135 :         zval *args = NULL;</span></a>
<a name="5741"><span class="lineNum">    5741 </span>            :         char *str, *format;</a>
<a name="5742"><span class="lineNum">    5742 </span>            :         size_t str_len, format_len;</a>
<a name="5743"><span class="lineNum">    5743 </span><span class="lineCov">        135 :         int result, num_args = 0;</span></a>
<a name="5744"><span class="lineNum">    5744 </span>            : </a>
<a name="5745"><span class="lineNum">    5745 </span><span class="lineCov">        135 :         ZEND_PARSE_PARAMETERS_START(2, -1)</span></a>
<a name="5746"><span class="lineNum">    5746 </span><span class="lineCov">        246 :                 Z_PARAM_STRING(str, str_len)</span></a>
<a name="5747"><span class="lineNum">    5747 </span><span class="lineCov">        240 :                 Z_PARAM_STRING(format, format_len)</span></a>
<a name="5748"><span class="lineNum">    5748 </span><span class="lineCov">        120 :                 Z_PARAM_VARIADIC('*', args, num_args)</span></a>
<a name="5749"><span class="lineNum">    5749 </span><span class="lineCov">        135 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5750"><span class="lineNum">    5750 </span>            : </a>
<a name="5751"><span class="lineNum">    5751 </span><span class="lineCov">        120 :         result = php_sscanf_internal(str, format, num_args, args, 0, return_value);</span></a>
<a name="5752"><span class="lineNum">    5752 </span>            : </a>
<a name="5753"><span class="lineNum">    5753 </span><span class="lineCov">        120 :         if (SCAN_ERROR_WRONG_PARAM_COUNT == result) {</span></a>
<a name="5754"><span class="lineNum">    5754 </span><span class="lineNoCov">          0 :                 WRONG_PARAM_COUNT;</span></a>
<a name="5755"><span class="lineNum">    5755 </span>            :         }</a>
<a name="5756"><span class="lineNum">    5756 </span>            : }</a>
<a name="5757"><span class="lineNum">    5757 </span>            : /* }}} */</a>
<a name="5758"><span class="lineNum">    5758 </span>            : </a>
<a name="5759"><span class="lineNum">    5759 </span>            : /* static zend_string *php_str_rot13(zend_string *str) {{{ */</a>
<a name="5760"><span class="lineNum">    5760 </span><span class="lineCov">         75 : static zend_string *php_str_rot13(zend_string *str)</span></a>
<a name="5761"><span class="lineNum">    5761 </span>            : {</a>
<a name="5762"><span class="lineNum">    5762 </span>            :         zend_string *ret;</a>
<a name="5763"><span class="lineNum">    5763 </span>            :         const char *p, *e;</a>
<a name="5764"><span class="lineNum">    5764 </span>            :         char *target;</a>
<a name="5765"><span class="lineNum">    5765 </span>            : </a>
<a name="5766"><span class="lineNum">    5766 </span><span class="lineCov">         75 :         if (UNEXPECTED(ZSTR_LEN(str) == 0)) {</span></a>
<a name="5767"><span class="lineNum">    5767 </span><span class="lineCov">          3 :                 return ZSTR_EMPTY_ALLOC();</span></a>
<a name="5768"><span class="lineNum">    5768 </span>            :         }</a>
<a name="5769"><span class="lineNum">    5769 </span>            : </a>
<a name="5770"><span class="lineNum">    5770 </span><span class="lineCov">         72 :         ret = zend_string_alloc(ZSTR_LEN(str), 0);</span></a>
<a name="5771"><span class="lineNum">    5771 </span>            : </a>
<a name="5772"><span class="lineNum">    5772 </span><span class="lineCov">         72 :         p = ZSTR_VAL(str);</span></a>
<a name="5773"><span class="lineNum">    5773 </span><span class="lineCov">         72 :         e = p + ZSTR_LEN(str);</span></a>
<a name="5774"><span class="lineNum">    5774 </span><span class="lineCov">         72 :         target = ZSTR_VAL(ret);</span></a>
<a name="5775"><span class="lineNum">    5775 </span>            : </a>
<a name="5776"><span class="lineNum">    5776 </span>            : #ifdef __SSE2__</a>
<a name="5777"><span class="lineNum">    5777 </span><span class="lineCov">         72 :         if (e - p &gt; 15) {</span></a>
<a name="5778"><span class="lineNum">    5778 </span><span class="lineCov">         60 :                 const __m128i a_minus_1 = _mm_set1_epi8('a' - 1);</span></a>
<a name="5779"><span class="lineNum">    5779 </span><span class="lineCov">         60 :                 const __m128i m_plus_1 = _mm_set1_epi8('m' + 1);</span></a>
<a name="5780"><span class="lineNum">    5780 </span><span class="lineCov">         60 :                 const __m128i n_minus_1 = _mm_set1_epi8('n' - 1);</span></a>
<a name="5781"><span class="lineNum">    5781 </span><span class="lineCov">         60 :                 const __m128i z_plus_1 = _mm_set1_epi8('z' + 1);</span></a>
<a name="5782"><span class="lineNum">    5782 </span><span class="lineCov">         60 :                 const __m128i A_minus_1 = _mm_set1_epi8('A' - 1);</span></a>
<a name="5783"><span class="lineNum">    5783 </span><span class="lineCov">         60 :                 const __m128i M_plus_1 = _mm_set1_epi8('M' + 1);</span></a>
<a name="5784"><span class="lineNum">    5784 </span><span class="lineCov">         60 :                 const __m128i N_minus_1 = _mm_set1_epi8('N' - 1);</span></a>
<a name="5785"><span class="lineNum">    5785 </span><span class="lineCov">         60 :                 const __m128i Z_plus_1 = _mm_set1_epi8('Z' + 1);</span></a>
<a name="5786"><span class="lineNum">    5786 </span><span class="lineCov">         60 :                 const __m128i add = _mm_set1_epi8(13);</span></a>
<a name="5787"><span class="lineNum">    5787 </span><span class="lineCov">         60 :                 const __m128i sub = _mm_set1_epi8(-13);</span></a>
<a name="5788"><span class="lineNum">    5788 </span>            : </a>
<a name="5789"><span class="lineNum">    5789 </span>            :                 do {</a>
<a name="5790"><span class="lineNum">    5790 </span>            :                         __m128i in, gt, lt, cmp, delta;</a>
<a name="5791"><span class="lineNum">    5791 </span>            : </a>
<a name="5792"><span class="lineNum">    5792 </span><span class="lineCov">       3075 :                         delta = _mm_setzero_si128();</span></a>
<a name="5793"><span class="lineNum">    5793 </span><span class="lineCov">       3075 :                         in = _mm_loadu_si128((__m128i *)p);</span></a>
<a name="5794"><span class="lineNum">    5794 </span>            : </a>
<a name="5795"><span class="lineNum">    5795 </span><span class="lineCov">       3075 :                         gt = _mm_cmpgt_epi8(in, a_minus_1);</span></a>
<a name="5796"><span class="lineNum">    5796 </span><span class="lineCov">       3075 :                         lt = _mm_cmplt_epi8(in, m_plus_1);</span></a>
<a name="5797"><span class="lineNum">    5797 </span><span class="lineCov">       3075 :                         cmp = _mm_and_si128(lt, gt);</span></a>
<a name="5798"><span class="lineNum">    5798 </span><span class="lineCov">       3075 :                         if (_mm_movemask_epi8(cmp)) {</span></a>
<a name="5799"><span class="lineNum">    5799 </span><span class="lineCov">       3072 :                                 cmp = _mm_and_si128(cmp, add);</span></a>
<a name="5800"><span class="lineNum">    5800 </span><span class="lineCov">       3072 :                                 delta = _mm_or_si128(delta, cmp);</span></a>
<a name="5801"><span class="lineNum">    5801 </span>            :                         }</a>
<a name="5802"><span class="lineNum">    5802 </span>            : </a>
<a name="5803"><span class="lineNum">    5803 </span><span class="lineCov">       3075 :                         gt = _mm_cmpgt_epi8(in, n_minus_1);</span></a>
<a name="5804"><span class="lineNum">    5804 </span><span class="lineCov">       3075 :                         lt = _mm_cmplt_epi8(in, z_plus_1);</span></a>
<a name="5805"><span class="lineNum">    5805 </span><span class="lineCov">       3075 :                         cmp = _mm_and_si128(lt, gt);</span></a>
<a name="5806"><span class="lineNum">    5806 </span><span class="lineCov">       3075 :                         if (_mm_movemask_epi8(cmp)) {</span></a>
<a name="5807"><span class="lineNum">    5807 </span><span class="lineCov">       3072 :                                 cmp = _mm_and_si128(cmp, sub);</span></a>
<a name="5808"><span class="lineNum">    5808 </span><span class="lineCov">       3072 :                                 delta = _mm_or_si128(delta, cmp);</span></a>
<a name="5809"><span class="lineNum">    5809 </span>            :                         }</a>
<a name="5810"><span class="lineNum">    5810 </span>            : </a>
<a name="5811"><span class="lineNum">    5811 </span><span class="lineCov">       3075 :                         gt = _mm_cmpgt_epi8(in, A_minus_1);</span></a>
<a name="5812"><span class="lineNum">    5812 </span><span class="lineCov">       3075 :                         lt = _mm_cmplt_epi8(in, M_plus_1);</span></a>
<a name="5813"><span class="lineNum">    5813 </span><span class="lineCov">       3075 :                         cmp = _mm_and_si128(lt, gt);</span></a>
<a name="5814"><span class="lineNum">    5814 </span><span class="lineCov">       3075 :                         if (_mm_movemask_epi8(cmp)) {</span></a>
<a name="5815"><span class="lineNum">    5815 </span><span class="lineCov">       1305 :                                 cmp = _mm_and_si128(cmp, add);</span></a>
<a name="5816"><span class="lineNum">    5816 </span><span class="lineCov">       1305 :                                 delta = _mm_or_si128(delta, cmp);</span></a>
<a name="5817"><span class="lineNum">    5817 </span>            :                         }</a>
<a name="5818"><span class="lineNum">    5818 </span>            : </a>
<a name="5819"><span class="lineNum">    5819 </span><span class="lineCov">       3075 :                         gt = _mm_cmpgt_epi8(in, N_minus_1);</span></a>
<a name="5820"><span class="lineNum">    5820 </span><span class="lineCov">       3075 :                         lt = _mm_cmplt_epi8(in, Z_plus_1);</span></a>
<a name="5821"><span class="lineNum">    5821 </span><span class="lineCov">       3075 :                         cmp = _mm_and_si128(lt, gt);</span></a>
<a name="5822"><span class="lineNum">    5822 </span><span class="lineCov">       3075 :                         if (_mm_movemask_epi8(cmp)) {</span></a>
<a name="5823"><span class="lineNum">    5823 </span><span class="lineCov">        225 :                                 cmp = _mm_and_si128(cmp, sub);</span></a>
<a name="5824"><span class="lineNum">    5824 </span><span class="lineCov">        225 :                                 delta = _mm_or_si128(delta, cmp);</span></a>
<a name="5825"><span class="lineNum">    5825 </span>            :                         }</a>
<a name="5826"><span class="lineNum">    5826 </span>            : </a>
<a name="5827"><span class="lineNum">    5827 </span><span class="lineCov">       3075 :                         in = _mm_add_epi8(in, delta);</span></a>
<a name="5828"><span class="lineNum">    5828 </span>            :                         _mm_storeu_si128((__m128i *)target, in);</a>
<a name="5829"><span class="lineNum">    5829 </span>            : </a>
<a name="5830"><span class="lineNum">    5830 </span><span class="lineCov">       3075 :                         p += 16;</span></a>
<a name="5831"><span class="lineNum">    5831 </span><span class="lineCov">       3075 :                         target += 16;</span></a>
<a name="5832"><span class="lineNum">    5832 </span><span class="lineCov">       3075 :                 } while (e - p &gt; 15);</span></a>
<a name="5833"><span class="lineNum">    5833 </span>            :         }</a>
<a name="5834"><span class="lineNum">    5834 </span>            : #endif</a>
<a name="5835"><span class="lineNum">    5835 </span>            : </a>
<a name="5836"><span class="lineNum">    5836 </span><span class="lineCov">        546 :         while (p &lt; e) {</span></a>
<a name="5837"><span class="lineNum">    5837 </span><span class="lineCov">        474 :                 if (*p &gt;= 'a' &amp;&amp; *p &lt;= 'z') {</span></a>
<a name="5838"><span class="lineNum">    5838 </span><span class="lineCov">        273 :                         *target++ = 'a' + (((*p++ - 'a') + 13) % 26);</span></a>
<a name="5839"><span class="lineNum">    5839 </span><span class="lineCov">        201 :                 } else if (*p &gt;= 'A' &amp;&amp; *p &lt;= 'Z') {</span></a>
<a name="5840"><span class="lineNum">    5840 </span><span class="lineCov">         45 :                         *target++ = 'A' + (((*p++ - 'A') + 13) % 26);</span></a>
<a name="5841"><span class="lineNum">    5841 </span>            :                 } else {</a>
<a name="5842"><span class="lineNum">    5842 </span><span class="lineCov">        156 :                         *target++ = *p++;</span></a>
<a name="5843"><span class="lineNum">    5843 </span>            :                 }</a>
<a name="5844"><span class="lineNum">    5844 </span>            :         }</a>
<a name="5845"><span class="lineNum">    5845 </span>            : </a>
<a name="5846"><span class="lineNum">    5846 </span><span class="lineCov">         72 :         *target = '\0';</span></a>
<a name="5847"><span class="lineNum">    5847 </span>            : </a>
<a name="5848"><span class="lineNum">    5848 </span><span class="lineCov">         72 :         return ret;</span></a>
<a name="5849"><span class="lineNum">    5849 </span>            : }</a>
<a name="5850"><span class="lineNum">    5850 </span>            : /* }}} */</a>
<a name="5851"><span class="lineNum">    5851 </span>            : </a>
<a name="5852"><span class="lineNum">    5852 </span>            : /* {{{ Perform the rot13 transform on a string */</a>
<a name="5853"><span class="lineNum">    5853 </span><span class="lineCov">        132 : PHP_FUNCTION(str_rot13)</span></a>
<a name="5854"><span class="lineNum">    5854 </span>            : {</a>
<a name="5855"><span class="lineNum">    5855 </span>            :         zend_string *arg;</a>
<a name="5856"><span class="lineNum">    5856 </span>            : </a>
<a name="5857"><span class="lineNum">    5857 </span><span class="lineCov">        132 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="5858"><span class="lineNum">    5858 </span><span class="lineCov">        156 :                 Z_PARAM_STR(arg)</span></a>
<a name="5859"><span class="lineNum">    5859 </span><span class="lineCov">        132 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5860"><span class="lineNum">    5860 </span>            : </a>
<a name="5861"><span class="lineNum">    5861 </span><span class="lineCov">        150 :         RETURN_STR(php_str_rot13(arg));</span></a>
<a name="5862"><span class="lineNum">    5862 </span>            : }</a>
<a name="5863"><span class="lineNum">    5863 </span>            : /* }}} */</a>
<a name="5864"><span class="lineNum">    5864 </span>            : </a>
<a name="5865"><span class="lineNum">    5865 </span><span class="lineCov">     273015 : static void php_string_shuffle(char *str, zend_long len) /* {{{ */</span></a>
<a name="5866"><span class="lineNum">    5866 </span>            : {</a>
<a name="5867"><span class="lineNum">    5867 </span>            :         zend_long n_elems, rnd_idx, n_left;</a>
<a name="5868"><span class="lineNum">    5868 </span>            :         char temp;</a>
<a name="5869"><span class="lineNum">    5869 </span>            :         /* The implementation is stolen from array_data_shuffle       */</a>
<a name="5870"><span class="lineNum">    5870 </span>            :         /* Thus the characteristics of the randomization are the same */</a>
<a name="5871"><span class="lineNum">    5871 </span><span class="lineCov">     273015 :         n_elems = len;</span></a>
<a name="5872"><span class="lineNum">    5872 </span>            : </a>
<a name="5873"><span class="lineNum">    5873 </span><span class="lineCov">     273015 :         if (n_elems &lt;= 1) {</span></a>
<a name="5874"><span class="lineNum">    5874 </span><span class="lineNoCov">          0 :                 return;</span></a>
<a name="5875"><span class="lineNum">    5875 </span>            :         }</a>
<a name="5876"><span class="lineNum">    5876 </span>            : </a>
<a name="5877"><span class="lineNum">    5877 </span><span class="lineCov">     273015 :         n_left = n_elems;</span></a>
<a name="5878"><span class="lineNum">    5878 </span>            : </a>
<a name="5879"><span class="lineNum">    5879 </span><span class="lineCov">    1092670 :         while (--n_left) {</span></a>
<a name="5880"><span class="lineNum">    5880 </span><span class="lineCov">     819654 :                 rnd_idx = php_mt_rand_range(0, n_left);</span></a>
<a name="5881"><span class="lineNum">    5881 </span><span class="lineCov">     819654 :                 if (rnd_idx != n_left) {</span></a>
<a name="5882"><span class="lineNum">    5882 </span><span class="lineCov">     523473 :                         temp = str[n_left];</span></a>
<a name="5883"><span class="lineNum">    5883 </span><span class="lineCov">     523473 :                         str[n_left] = str[rnd_idx];</span></a>
<a name="5884"><span class="lineNum">    5884 </span><span class="lineCov">     523473 :                         str[rnd_idx] = temp;</span></a>
<a name="5885"><span class="lineNum">    5885 </span>            :                 }</a>
<a name="5886"><span class="lineNum">    5886 </span>            :         }</a>
<a name="5887"><span class="lineNum">    5887 </span>            : }</a>
<a name="5888"><span class="lineNum">    5888 </span>            : /* }}} */</a>
<a name="5889"><span class="lineNum">    5889 </span>            : </a>
<a name="5890"><span class="lineNum">    5890 </span>            : /* {{{ Shuffles string. One permutation of all possible is created */</a>
<a name="5891"><span class="lineNum">    5891 </span><span class="lineCov">     273069 : PHP_FUNCTION(str_shuffle)</span></a>
<a name="5892"><span class="lineNum">    5892 </span>            : {</a>
<a name="5893"><span class="lineNum">    5893 </span>            :         zend_string *arg;</a>
<a name="5894"><span class="lineNum">    5894 </span>            : </a>
<a name="5895"><span class="lineNum">    5895 </span><span class="lineCov">     273069 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="5896"><span class="lineNum">    5896 </span><span class="lineCov">     546042 :                 Z_PARAM_STR(arg)</span></a>
<a name="5897"><span class="lineNum">    5897 </span><span class="lineCov">     273069 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5898"><span class="lineNum">    5898 </span>            : </a>
<a name="5899"><span class="lineNum">    5899 </span><span class="lineCov">     273018 :         RETVAL_STRINGL(ZSTR_VAL(arg), ZSTR_LEN(arg));</span></a>
<a name="5900"><span class="lineNum">    5900 </span><span class="lineCov">     273018 :         if (Z_STRLEN_P(return_value) &gt; 1) {</span></a>
<a name="5901"><span class="lineNum">    5901 </span><span class="lineCov">     273015 :                 php_string_shuffle(Z_STRVAL_P(return_value), (zend_long) Z_STRLEN_P(return_value));</span></a>
<a name="5902"><span class="lineNum">    5902 </span>            :         }</a>
<a name="5903"><span class="lineNum">    5903 </span>            : }</a>
<a name="5904"><span class="lineNum">    5904 </span>            : /* }}} */</a>
<a name="5905"><span class="lineNum">    5905 </span>            : </a>
<a name="5906"><span class="lineNum">    5906 </span>            : /* {{{ Counts the number of words inside a string. If format of 1 is specified,</a>
<a name="5907"><span class="lineNum">    5907 </span>            :         then the function will return an array containing all the words</a>
<a name="5908"><span class="lineNum">    5908 </span>            :         found inside the string. If format of 2 is specified, then the function</a>
<a name="5909"><span class="lineNum">    5909 </span>            :         will return an associated array where the position of the word is the key</a>
<a name="5910"><span class="lineNum">    5910 </span>            :         and the word itself is the value.</a>
<a name="5911"><span class="lineNum">    5911 </span>            :         For the purpose of this function, 'word' is defined as a locale dependent</a>
<a name="5912"><span class="lineNum">    5912 </span>            :         string containing alphabetic characters, which also may contain, but not start</a>
<a name="5913"><span class="lineNum">    5913 </span>            :         with &quot;'&quot; and &quot;-&quot; characters.</a>
<a name="5914"><span class="lineNum">    5914 </span>            : */</a>
<a name="5915"><span class="lineNum">    5915 </span><span class="lineCov">        135 : PHP_FUNCTION(str_word_count)</span></a>
<a name="5916"><span class="lineNum">    5916 </span>            : {</a>
<a name="5917"><span class="lineNum">    5917 </span>            :         zend_string *str;</a>
<a name="5918"><span class="lineNum">    5918 </span><span class="lineCov">        135 :         char *char_list = NULL, ch[256];</span></a>
<a name="5919"><span class="lineNum">    5919 </span>            :         const char *p, *e, *s;</a>
<a name="5920"><span class="lineNum">    5920 </span><span class="lineCov">        135 :         size_t char_list_len = 0, word_count = 0;</span></a>
<a name="5921"><span class="lineNum">    5921 </span><span class="lineCov">        135 :         zend_long type = 0;</span></a>
<a name="5922"><span class="lineNum">    5922 </span>            : </a>
<a name="5923"><span class="lineNum">    5923 </span><span class="lineCov">        135 :         ZEND_PARSE_PARAMETERS_START(1, 3)</span></a>
<a name="5924"><span class="lineNum">    5924 </span><span class="lineCov">        198 :                 Z_PARAM_STR(str)</span></a>
<a name="5925"><span class="lineNum">    5925 </span><span class="lineCov">         90 :                 Z_PARAM_OPTIONAL</span></a>
<a name="5926"><span class="lineNum">    5926 </span><span class="lineCov">        171 :                 Z_PARAM_LONG(type)</span></a>
<a name="5927"><span class="lineNum">    5927 </span><span class="lineCov">        132 :                 Z_PARAM_STRING_OR_NULL(char_list, char_list_len)</span></a>
<a name="5928"><span class="lineNum">    5928 </span><span class="lineCov">        135 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="5929"><span class="lineNum">    5929 </span>            : </a>
<a name="5930"><span class="lineNum">    5930 </span><span class="lineCov">         90 :         switch(type) {</span></a>
<a name="5931"><span class="lineNum">    5931 </span><span class="lineCov">         45 :                 case 1:</span></a>
<a name="5932"><span class="lineNum">    5932 </span>            :                 case 2:</a>
<a name="5933"><span class="lineNum">    5933 </span><span class="lineCov">         45 :                         array_init(return_value);</span></a>
<a name="5934"><span class="lineNum">    5934 </span><span class="lineCov">         45 :                         if (!ZSTR_LEN(str)) {</span></a>
<a name="5935"><span class="lineNum">    5935 </span><span class="lineNoCov">          0 :                                 return;</span></a>
<a name="5936"><span class="lineNum">    5936 </span>            :                         }</a>
<a name="5937"><span class="lineNum">    5937 </span><span class="lineCov">         45 :                         break;</span></a>
<a name="5938"><span class="lineNum">    5938 </span><span class="lineCov">         27 :                 case 0:</span></a>
<a name="5939"><span class="lineNum">    5939 </span><span class="lineCov">         27 :                         if (!ZSTR_LEN(str)) {</span></a>
<a name="5940"><span class="lineNum">    5940 </span><span class="lineCov">         12 :                                 RETURN_LONG(0);</span></a>
<a name="5941"><span class="lineNum">    5941 </span>            :                         }</a>
<a name="5942"><span class="lineNum">    5942 </span>            :                         /* nothing to be done */</a>
<a name="5943"><span class="lineNum">    5943 </span><span class="lineCov">         15 :                         break;</span></a>
<a name="5944"><span class="lineNum">    5944 </span><span class="lineCov">         18 :                 default:</span></a>
<a name="5945"><span class="lineNum">    5945 </span><span class="lineCov">         18 :                         zend_argument_value_error(2, &quot;must be a valid format value&quot;);</span></a>
<a name="5946"><span class="lineNum">    5946 </span><span class="lineCov">         18 :                         RETURN_THROWS();</span></a>
<a name="5947"><span class="lineNum">    5947 </span>            :         }</a>
<a name="5948"><span class="lineNum">    5948 </span>            : </a>
<a name="5949"><span class="lineNum">    5949 </span><span class="lineCov">         60 :         if (char_list) {</span></a>
<a name="5950"><span class="lineNum">    5950 </span><span class="lineCov">         45 :                 php_charmask((const unsigned char *) char_list, char_list_len, ch);</span></a>
<a name="5951"><span class="lineNum">    5951 </span>            :         }</a>
<a name="5952"><span class="lineNum">    5952 </span>            : </a>
<a name="5953"><span class="lineNum">    5953 </span><span class="lineCov">         60 :         p = ZSTR_VAL(str);</span></a>
<a name="5954"><span class="lineNum">    5954 </span><span class="lineCov">         60 :         e = ZSTR_VAL(str) + ZSTR_LEN(str);</span></a>
<a name="5955"><span class="lineNum">    5955 </span>            : </a>
<a name="5956"><span class="lineNum">    5956 </span>            :         /* first character cannot be ' or -, unless explicitly allowed by the user */</a>
<a name="5957"><span class="lineNum">    5957 </span><span class="lineCov">         60 :         if ((*p == '\'' &amp;&amp; (!char_list || !ch['\''])) || (*p == '-' &amp;&amp; (!char_list || !ch['-']))) {</span></a>
<a name="5958"><span class="lineNum">    5958 </span><span class="lineCov">          6 :                 p++;</span></a>
<a name="5959"><span class="lineNum">    5959 </span>            :         }</a>
<a name="5960"><span class="lineNum">    5960 </span>            :         /* last character cannot be -, unless explicitly allowed by the user */</a>
<a name="5961"><span class="lineNum">    5961 </span><span class="lineCov">         60 :         if (*(e - 1) == '-' &amp;&amp; (!char_list || !ch['-'])) {</span></a>
<a name="5962"><span class="lineNum">    5962 </span><span class="lineCov">          3 :                 e--;</span></a>
<a name="5963"><span class="lineNum">    5963 </span>            :         }</a>
<a name="5964"><span class="lineNum">    5964 </span>            : </a>
<a name="5965"><span class="lineNum">    5965 </span><span class="lineCov">        483 :         while (p &lt; e) {</span></a>
<a name="5966"><span class="lineNum">    5966 </span><span class="lineCov">        423 :                 s = p;</span></a>
<a name="5967"><span class="lineNum">    5967 </span><span class="lineCov">       1269 :                 while (p &lt; e &amp;&amp; (isalpha((unsigned char)*p) || (char_list &amp;&amp; ch[(unsigned char)*p]) || *p == '\'' || *p == '-')) {</span></a>
<a name="5968"><span class="lineNum">    5968 </span><span class="lineCov">        846 :                         p++;</span></a>
<a name="5969"><span class="lineNum">    5969 </span>            :                 }</a>
<a name="5970"><span class="lineNum">    5970 </span><span class="lineCov">        423 :                 if (p &gt; s) {</span></a>
<a name="5971"><span class="lineNum">    5971 </span><span class="lineCov">        279 :                         switch (type)</span></a>
<a name="5972"><span class="lineNum">    5972 </span>            :                         {</a>
<a name="5973"><span class="lineNum">    5973 </span><span class="lineCov">         87 :                                 case 1:</span></a>
<a name="5974"><span class="lineNum">    5974 </span><span class="lineCov">         87 :                                         add_next_index_stringl(return_value, s, p - s);</span></a>
<a name="5975"><span class="lineNum">    5975 </span><span class="lineCov">         87 :                                         break;</span></a>
<a name="5976"><span class="lineNum">    5976 </span><span class="lineCov">        105 :                                 case 2:</span></a>
<a name="5977"><span class="lineNum">    5977 </span><span class="lineCov">        105 :                                         add_index_stringl(return_value, (s - ZSTR_VAL(str)), s, p - s);</span></a>
<a name="5978"><span class="lineNum">    5978 </span><span class="lineCov">        105 :                                         break;</span></a>
<a name="5979"><span class="lineNum">    5979 </span><span class="lineCov">         87 :                                 default:</span></a>
<a name="5980"><span class="lineNum">    5980 </span><span class="lineCov">         87 :                                         word_count++;</span></a>
<a name="5981"><span class="lineNum">    5981 </span><span class="lineCov">         87 :                                         break;</span></a>
<a name="5982"><span class="lineNum">    5982 </span>            :                         }</a>
<a name="5983"><span class="lineNum">    5983 </span><span class="lineCov">        144 :                 }</span></a>
<a name="5984"><span class="lineNum">    5984 </span><span class="lineCov">        423 :                 p++;</span></a>
<a name="5985"><span class="lineNum">    5985 </span>            :         }</a>
<a name="5986"><span class="lineNum">    5986 </span>            : </a>
<a name="5987"><span class="lineNum">    5987 </span><span class="lineCov">         60 :         if (!type) {</span></a>
<a name="5988"><span class="lineNum">    5988 </span><span class="lineCov">         15 :                 RETURN_LONG(word_count);</span></a>
<a name="5989"><span class="lineNum">    5989 </span>            :         }</a>
<a name="5990"><span class="lineNum">    5990 </span>            : }</a>
<a name="5991"><span class="lineNum">    5991 </span>            : </a>
<a name="5992"><span class="lineNum">    5992 </span>            : /* }}} */</a>
<a name="5993"><span class="lineNum">    5993 </span>            : </a>
<a name="5994"><span class="lineNum">    5994 </span>            : /* {{{ Convert a string to an array. If split_length is specified, break the string down into chunks each split_length characters long. */</a>
<a name="5995"><span class="lineNum">    5995 </span><span class="lineCov">        396 : PHP_FUNCTION(str_split)</span></a>
<a name="5996"><span class="lineNum">    5996 </span>            : {</a>
<a name="5997"><span class="lineNum">    5997 </span>            :         zend_string *str;</a>
<a name="5998"><span class="lineNum">    5998 </span><span class="lineCov">        396 :         zend_long split_length = 1;</span></a>
<a name="5999"><span class="lineNum">    5999 </span>            :         const char *p;</a>
<a name="6000"><span class="lineNum">    6000 </span>            :         size_t n_reg_segments;</a>
<a name="6001"><span class="lineNum">    6001 </span>            : </a>
<a name="6002"><span class="lineNum">    6002 </span><span class="lineCov">        396 :         ZEND_PARSE_PARAMETERS_START(1, 2)</span></a>
<a name="6003"><span class="lineNum">    6003 </span><span class="lineCov">        708 :                 Z_PARAM_STR(str)</span></a>
<a name="6004"><span class="lineNum">    6004 </span><span class="lineCov">        348 :                 Z_PARAM_OPTIONAL</span></a>
<a name="6005"><span class="lineNum">    6005 </span><span class="lineCov">        492 :                 Z_PARAM_LONG(split_length)</span></a>
<a name="6006"><span class="lineNum">    6006 </span><span class="lineCov">        396 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="6007"><span class="lineNum">    6007 </span>            : </a>
<a name="6008"><span class="lineNum">    6008 </span><span class="lineCov">        348 :         if (split_length &lt;= 0) {</span></a>
<a name="6009"><span class="lineNum">    6009 </span><span class="lineCov">         21 :                 zend_argument_value_error(2, &quot;must be greater than 0&quot;);</span></a>
<a name="6010"><span class="lineNum">    6010 </span><span class="lineCov">         21 :                 RETURN_THROWS();</span></a>
<a name="6011"><span class="lineNum">    6011 </span>            :         }</a>
<a name="6012"><span class="lineNum">    6012 </span>            : </a>
<a name="6013"><span class="lineNum">    6013 </span><span class="lineCov">        327 :         if (0 == ZSTR_LEN(str) || (size_t)split_length &gt;= ZSTR_LEN(str)) {</span></a>
<a name="6014"><span class="lineNum">    6014 </span><span class="lineCov">         42 :                 array_init_size(return_value, 1);</span></a>
<a name="6015"><span class="lineNum">    6015 </span><span class="lineCov">         42 :                 add_next_index_stringl(return_value, ZSTR_VAL(str), ZSTR_LEN(str));</span></a>
<a name="6016"><span class="lineNum">    6016 </span><span class="lineCov">         42 :                 return;</span></a>
<a name="6017"><span class="lineNum">    6017 </span>            :         }</a>
<a name="6018"><span class="lineNum">    6018 </span>            : </a>
<a name="6019"><span class="lineNum">    6019 </span><span class="lineCov">        285 :         array_init_size(return_value, (uint32_t)(((ZSTR_LEN(str) - 1) / split_length) + 1));</span></a>
<a name="6020"><span class="lineNum">    6020 </span>            : </a>
<a name="6021"><span class="lineNum">    6021 </span><span class="lineCov">        285 :         n_reg_segments = ZSTR_LEN(str) / split_length;</span></a>
<a name="6022"><span class="lineNum">    6022 </span><span class="lineCov">        285 :         p = ZSTR_VAL(str);</span></a>
<a name="6023"><span class="lineNum">    6023 </span>            : </a>
<a name="6024"><span class="lineNum">    6024 </span><span class="lineCov">      50760 :         while (n_reg_segments-- &gt; 0) {</span></a>
<a name="6025"><span class="lineNum">    6025 </span><span class="lineCov">      50475 :                 add_next_index_stringl(return_value, p, split_length);</span></a>
<a name="6026"><span class="lineNum">    6026 </span><span class="lineCov">      50475 :                 p += split_length;</span></a>
<a name="6027"><span class="lineNum">    6027 </span>            :         }</a>
<a name="6028"><span class="lineNum">    6028 </span>            : </a>
<a name="6029"><span class="lineNum">    6029 </span><span class="lineCov">        285 :         if (p != (ZSTR_VAL(str) + ZSTR_LEN(str))) {</span></a>
<a name="6030"><span class="lineNum">    6030 </span><span class="lineCov">         75 :                 add_next_index_stringl(return_value, p, (ZSTR_VAL(str) + ZSTR_LEN(str) - p));</span></a>
<a name="6031"><span class="lineNum">    6031 </span>            :         }</a>
<a name="6032"><span class="lineNum">    6032 </span>            : }</a>
<a name="6033"><span class="lineNum">    6033 </span>            : /* }}} */</a>
<a name="6034"><span class="lineNum">    6034 </span>            : </a>
<a name="6035"><span class="lineNum">    6035 </span>            : /* {{{ Search a string for any of a set of characters */</a>
<a name="6036"><span class="lineNum">    6036 </span><span class="lineCov">        102 : PHP_FUNCTION(strpbrk)</span></a>
<a name="6037"><span class="lineNum">    6037 </span>            : {</a>
<a name="6038"><span class="lineNum">    6038 </span>            :         zend_string *haystack, *char_list;</a>
<a name="6039"><span class="lineNum">    6039 </span>            :         const char *haystack_ptr, *cl_ptr;</a>
<a name="6040"><span class="lineNum">    6040 </span>            : </a>
<a name="6041"><span class="lineNum">    6041 </span><span class="lineCov">        102 :         ZEND_PARSE_PARAMETERS_START(2, 2)</span></a>
<a name="6042"><span class="lineNum">    6042 </span><span class="lineCov">        108 :                 Z_PARAM_STR(haystack)</span></a>
<a name="6043"><span class="lineNum">    6043 </span><span class="lineCov">        102 :                 Z_PARAM_STR(char_list)</span></a>
<a name="6044"><span class="lineNum">    6044 </span><span class="lineCov">        102 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="6045"><span class="lineNum">    6045 </span>            : </a>
<a name="6046"><span class="lineNum">    6046 </span><span class="lineCov">         51 :         if (!ZSTR_LEN(char_list)) {</span></a>
<a name="6047"><span class="lineNum">    6047 </span><span class="lineCov">          6 :                 zend_argument_value_error(2, &quot;must be a non-empty string&quot;);</span></a>
<a name="6048"><span class="lineNum">    6048 </span><span class="lineCov">          6 :                 RETURN_THROWS();</span></a>
<a name="6049"><span class="lineNum">    6049 </span>            :         }</a>
<a name="6050"><span class="lineNum">    6050 </span>            : </a>
<a name="6051"><span class="lineNum">    6051 </span><span class="lineCov">        288 :         for (haystack_ptr = ZSTR_VAL(haystack); haystack_ptr &lt; (ZSTR_VAL(haystack) + ZSTR_LEN(haystack)); ++haystack_ptr) {</span></a>
<a name="6052"><span class="lineNum">    6052 </span><span class="lineCov">        684 :                 for (cl_ptr = ZSTR_VAL(char_list); cl_ptr &lt; (ZSTR_VAL(char_list) + ZSTR_LEN(char_list)); ++cl_ptr) {</span></a>
<a name="6053"><span class="lineNum">    6053 </span><span class="lineCov">        441 :                         if (*cl_ptr == *haystack_ptr) {</span></a>
<a name="6054"><span class="lineNum">    6054 </span><span class="lineCov">         60 :                                 RETURN_STRINGL(haystack_ptr, (ZSTR_VAL(haystack) + ZSTR_LEN(haystack) - haystack_ptr));</span></a>
<a name="6055"><span class="lineNum">    6055 </span>            :                         }</a>
<a name="6056"><span class="lineNum">    6056 </span>            :                 }</a>
<a name="6057"><span class="lineNum">    6057 </span>            :         }</a>
<a name="6058"><span class="lineNum">    6058 </span>            : </a>
<a name="6059"><span class="lineNum">    6059 </span><span class="lineCov">         15 :         RETURN_FALSE;</span></a>
<a name="6060"><span class="lineNum">    6060 </span>            : }</a>
<a name="6061"><span class="lineNum">    6061 </span>            : /* }}} */</a>
<a name="6062"><span class="lineNum">    6062 </span>            : </a>
<a name="6063"><span class="lineNum">    6063 </span>            : /* {{{ Binary safe optionally case insensitive comparison of 2 strings from an offset, up to length characters */</a>
<a name="6064"><span class="lineNum">    6064 </span><span class="lineCov">        126 : PHP_FUNCTION(substr_compare)</span></a>
<a name="6065"><span class="lineNum">    6065 </span>            : {</a>
<a name="6066"><span class="lineNum">    6066 </span>            :         zend_string *s1, *s2;</a>
<a name="6067"><span class="lineNum">    6067 </span><span class="lineCov">        126 :         zend_long offset, len=0;</span></a>
<a name="6068"><span class="lineNum">    6068 </span><span class="lineCov">        126 :         bool len_is_default=1;</span></a>
<a name="6069"><span class="lineNum">    6069 </span><span class="lineCov">        126 :         bool cs=0;</span></a>
<a name="6070"><span class="lineNum">    6070 </span>            :         size_t cmp_len;</a>
<a name="6071"><span class="lineNum">    6071 </span>            : </a>
<a name="6072"><span class="lineNum">    6072 </span><span class="lineCov">        126 :         ZEND_PARSE_PARAMETERS_START(3, 5)</span></a>
<a name="6073"><span class="lineNum">    6073 </span><span class="lineCov">        180 :                 Z_PARAM_STR(s1)</span></a>
<a name="6074"><span class="lineNum">    6074 </span><span class="lineCov">        162 :                 Z_PARAM_STR(s2)</span></a>
<a name="6075"><span class="lineNum">    6075 </span><span class="lineCov">        162 :                 Z_PARAM_LONG(offset)</span></a>
<a name="6076"><span class="lineNum">    6076 </span><span class="lineCov">         81 :                 Z_PARAM_OPTIONAL</span></a>
<a name="6077"><span class="lineNum">    6077 </span><span class="lineCov">        147 :                 Z_PARAM_LONG_OR_NULL(len, len_is_default)</span></a>
<a name="6078"><span class="lineNum">    6078 </span><span class="lineCov">         90 :                 Z_PARAM_BOOL(cs)</span></a>
<a name="6079"><span class="lineNum">    6079 </span><span class="lineCov">        126 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="6080"><span class="lineNum">    6080 </span>            : </a>
<a name="6081"><span class="lineNum">    6081 </span><span class="lineCov">         81 :         if (!len_is_default &amp;&amp; len &lt;= 0) {</span></a>
<a name="6082"><span class="lineNum">    6082 </span><span class="lineCov">         15 :                 if (len == 0) {</span></a>
<a name="6083"><span class="lineNum">    6083 </span><span class="lineCov">          9 :                         RETURN_LONG(0L);</span></a>
<a name="6084"><span class="lineNum">    6084 </span>            :                 } else {</a>
<a name="6085"><span class="lineNum">    6085 </span><span class="lineCov">          6 :                         zend_argument_value_error(4, &quot;must be greater than or equal to 0&quot;);</span></a>
<a name="6086"><span class="lineNum">    6086 </span><span class="lineCov">          6 :                         RETURN_THROWS();</span></a>
<a name="6087"><span class="lineNum">    6087 </span>            :                 }</a>
<a name="6088"><span class="lineNum">    6088 </span>            :         }</a>
<a name="6089"><span class="lineNum">    6089 </span>            : </a>
<a name="6090"><span class="lineNum">    6090 </span><span class="lineCov">         66 :         if (offset &lt; 0) {</span></a>
<a name="6091"><span class="lineNum">    6091 </span><span class="lineCov">         12 :                 offset = ZSTR_LEN(s1) + offset;</span></a>
<a name="6092"><span class="lineNum">    6092 </span><span class="lineCov">         12 :                 offset = (offset &lt; 0) ? 0 : offset;</span></a>
<a name="6093"><span class="lineNum">    6093 </span>            :         }</a>
<a name="6094"><span class="lineNum">    6094 </span>            : </a>
<a name="6095"><span class="lineNum">    6095 </span><span class="lineCov">         66 :         if ((size_t)offset &gt; ZSTR_LEN(s1)) {</span></a>
<a name="6096"><span class="lineNum">    6096 </span><span class="lineCov">          3 :                 zend_argument_value_error(3, &quot;must be contained in argument #1 ($main_str)&quot;);</span></a>
<a name="6097"><span class="lineNum">    6097 </span><span class="lineCov">          3 :                 RETURN_THROWS();</span></a>
<a name="6098"><span class="lineNum">    6098 </span>            :         }</a>
<a name="6099"><span class="lineNum">    6099 </span>            : </a>
<a name="6100"><span class="lineNum">    6100 </span><span class="lineCov">         63 :         cmp_len = len ? (size_t)len : MAX(ZSTR_LEN(s2), (ZSTR_LEN(s1) - offset));</span></a>
<a name="6101"><span class="lineNum">    6101 </span>            : </a>
<a name="6102"><span class="lineNum">    6102 </span><span class="lineCov">         63 :         if (!cs) {</span></a>
<a name="6103"><span class="lineNum">    6103 </span><span class="lineCov">         51 :                 RETURN_LONG(zend_binary_strncmp(ZSTR_VAL(s1) + offset, (ZSTR_LEN(s1) - offset), ZSTR_VAL(s2), ZSTR_LEN(s2), cmp_len));</span></a>
<a name="6104"><span class="lineNum">    6104 </span>            :         } else {</a>
<a name="6105"><span class="lineNum">    6105 </span><span class="lineCov">         12 :                 RETURN_LONG(zend_binary_strncasecmp_l(ZSTR_VAL(s1) + offset, (ZSTR_LEN(s1) - offset), ZSTR_VAL(s2), ZSTR_LEN(s2), cmp_len));</span></a>
<a name="6106"><span class="lineNum">    6106 </span>            :         }</a>
<a name="6107"><span class="lineNum">    6107 </span>            : }</a>
<a name="6108"><span class="lineNum">    6108 </span>            : /* }}} */</a>
<a name="6109"><span class="lineNum">    6109 </span>            : </a>
<a name="6110"><span class="lineNum">    6110 </span>            : /* {{{ */</a>
<a name="6111"><span class="lineNum">    6111 </span><span class="lineCov">          9 : static zend_string *php_utf8_encode(const char *s, size_t len)</span></a>
<a name="6112"><span class="lineNum">    6112 </span>            : {</a>
<a name="6113"><span class="lineNum">    6113 </span><span class="lineCov">          9 :         size_t pos = len;</span></a>
<a name="6114"><span class="lineNum">    6114 </span>            :         zend_string *str;</a>
<a name="6115"><span class="lineNum">    6115 </span>            :         unsigned char c;</a>
<a name="6116"><span class="lineNum">    6116 </span>            : </a>
<a name="6117"><span class="lineNum">    6117 </span><span class="lineCov">          9 :         str = zend_string_safe_alloc(len, 2, 0, 0);</span></a>
<a name="6118"><span class="lineNum">    6118 </span><span class="lineCov">          9 :         ZSTR_LEN(str) = 0;</span></a>
<a name="6119"><span class="lineNum">    6119 </span><span class="lineCov">         18 :         while (pos &gt; 0) {</span></a>
<a name="6120"><span class="lineNum">    6120 </span>            :                 /* The lower 256 codepoints of Unicode are identical to Latin-1,</a>
<a name="6121"><span class="lineNum">    6121 </span>            :                  * so we don't need to do any mapping here. */</a>
<a name="6122"><span class="lineNum">    6122 </span><span class="lineCov">          9 :                 c = (unsigned char)(*s);</span></a>
<a name="6123"><span class="lineNum">    6123 </span><span class="lineCov">          9 :                 if (c &lt; 0x80) {</span></a>
<a name="6124"><span class="lineNum">    6124 </span><span class="lineNoCov">          0 :                         ZSTR_VAL(str)[ZSTR_LEN(str)++] = (char) c;</span></a>
<a name="6125"><span class="lineNum">    6125 </span>            :                 /* We only account for the single-byte and two-byte cases because</a>
<a name="6126"><span class="lineNum">    6126 </span>            :                  * we're only dealing with the first 256 Unicode codepoints. */</a>
<a name="6127"><span class="lineNum">    6127 </span>            :                 } else {</a>
<a name="6128"><span class="lineNum">    6128 </span><span class="lineCov">          9 :                         ZSTR_VAL(str)[ZSTR_LEN(str)++] = (0xc0 | (c &gt;&gt; 6));</span></a>
<a name="6129"><span class="lineNum">    6129 </span><span class="lineCov">          9 :                         ZSTR_VAL(str)[ZSTR_LEN(str)++] = (0x80 | (c &amp; 0x3f));</span></a>
<a name="6130"><span class="lineNum">    6130 </span>            :                 }</a>
<a name="6131"><span class="lineNum">    6131 </span><span class="lineCov">          9 :                 pos--;</span></a>
<a name="6132"><span class="lineNum">    6132 </span><span class="lineCov">          9 :                 s++;</span></a>
<a name="6133"><span class="lineNum">    6133 </span>            :         }</a>
<a name="6134"><span class="lineNum">    6134 </span><span class="lineCov">          9 :         ZSTR_VAL(str)[ZSTR_LEN(str)] = '\0';</span></a>
<a name="6135"><span class="lineNum">    6135 </span><span class="lineCov">          9 :         str = zend_string_truncate(str, ZSTR_LEN(str), 0);</span></a>
<a name="6136"><span class="lineNum">    6136 </span><span class="lineCov">          9 :         return str;</span></a>
<a name="6137"><span class="lineNum">    6137 </span>            : }</a>
<a name="6138"><span class="lineNum">    6138 </span>            : /* }}} */</a>
<a name="6139"><span class="lineNum">    6139 </span>            : </a>
<a name="6140"><span class="lineNum">    6140 </span>            : /* {{{ */</a>
<a name="6141"><span class="lineNum">    6141 </span><span class="lineCov">         24 : static zend_string *php_utf8_decode(const char *s, size_t len)</span></a>
<a name="6142"><span class="lineNum">    6142 </span>            : {</a>
<a name="6143"><span class="lineNum">    6143 </span><span class="lineCov">         24 :         size_t pos = 0;</span></a>
<a name="6144"><span class="lineNum">    6144 </span>            :         unsigned int c;</a>
<a name="6145"><span class="lineNum">    6145 </span>            :         zend_string *str;</a>
<a name="6146"><span class="lineNum">    6146 </span>            : </a>
<a name="6147"><span class="lineNum">    6147 </span><span class="lineCov">         24 :         str = zend_string_alloc(len, 0);</span></a>
<a name="6148"><span class="lineNum">    6148 </span><span class="lineCov">         24 :         ZSTR_LEN(str) = 0;</span></a>
<a name="6149"><span class="lineNum">    6149 </span><span class="lineCov">         93 :         while (pos &lt; len) {</span></a>
<a name="6150"><span class="lineNum">    6150 </span><span class="lineCov">         69 :                 int status = FAILURE;</span></a>
<a name="6151"><span class="lineNum">    6151 </span><span class="lineCov">         69 :                 c = php_next_utf8_char((const unsigned char*)s, (size_t) len, &amp;pos, &amp;status);</span></a>
<a name="6152"><span class="lineNum">    6152 </span>            : </a>
<a name="6153"><span class="lineNum">    6153 </span>            :                 /* The lower 256 codepoints of Unicode are identical to Latin-1,</a>
<a name="6154"><span class="lineNum">    6154 </span>            :                  * so we don't need to do any mapping here beyond replacing non-Latin-1</a>
<a name="6155"><span class="lineNum">    6155 </span>            :                  * characters. */</a>
<a name="6156"><span class="lineNum">    6156 </span><span class="lineCov">         69 :                 if (status == FAILURE || c &gt; 0xFFU) {</span></a>
<a name="6157"><span class="lineNum">    6157 </span><span class="lineCov">         24 :                         c = '?';</span></a>
<a name="6158"><span class="lineNum">    6158 </span>            :                 }</a>
<a name="6159"><span class="lineNum">    6159 </span>            : </a>
<a name="6160"><span class="lineNum">    6160 </span><span class="lineCov">         69 :                 ZSTR_VAL(str)[ZSTR_LEN(str)++] = c;</span></a>
<a name="6161"><span class="lineNum">    6161 </span>            :         }</a>
<a name="6162"><span class="lineNum">    6162 </span><span class="lineCov">         24 :         ZSTR_VAL(str)[ZSTR_LEN(str)] = '\0';</span></a>
<a name="6163"><span class="lineNum">    6163 </span><span class="lineCov">         24 :         if (ZSTR_LEN(str) &lt; len) {</span></a>
<a name="6164"><span class="lineNum">    6164 </span><span class="lineCov">         30 :                 str = zend_string_truncate(str, ZSTR_LEN(str), 0);</span></a>
<a name="6165"><span class="lineNum">    6165 </span>            :         }</a>
<a name="6166"><span class="lineNum">    6166 </span>            : </a>
<a name="6167"><span class="lineNum">    6167 </span><span class="lineCov">         24 :         return str;</span></a>
<a name="6168"><span class="lineNum">    6168 </span>            : }</a>
<a name="6169"><span class="lineNum">    6169 </span>            : /* }}} */</a>
<a name="6170"><span class="lineNum">    6170 </span>            : </a>
<a name="6171"><span class="lineNum">    6171 </span>            : /* {{{ Encodes an ISO-8859-1 string to UTF-8 */</a>
<a name="6172"><span class="lineNum">    6172 </span><span class="lineCov">         60 : PHP_FUNCTION(utf8_encode)</span></a>
<a name="6173"><span class="lineNum">    6173 </span>            : {</a>
<a name="6174"><span class="lineNum">    6174 </span>            :         char *arg;</a>
<a name="6175"><span class="lineNum">    6175 </span>            :         size_t arg_len;</a>
<a name="6176"><span class="lineNum">    6176 </span>            : </a>
<a name="6177"><span class="lineNum">    6177 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="6178"><span class="lineNum">    6178 </span><span class="lineCov">         24 :                 Z_PARAM_STRING(arg, arg_len)</span></a>
<a name="6179"><span class="lineNum">    6179 </span><span class="lineCov">         60 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="6180"><span class="lineNum">    6180 </span>            : </a>
<a name="6181"><span class="lineNum">    6181 </span><span class="lineCov">         18 :         RETURN_STR(php_utf8_encode(arg, arg_len));</span></a>
<a name="6182"><span class="lineNum">    6182 </span>            : }</a>
<a name="6183"><span class="lineNum">    6183 </span>            : /* }}} */</a>
<a name="6184"><span class="lineNum">    6184 </span>            : </a>
<a name="6185"><span class="lineNum">    6185 </span>            : /* {{{ Converts a UTF-8 encoded string to ISO-8859-1 */</a>
<a name="6186"><span class="lineNum">    6186 </span><span class="lineCov">         75 : PHP_FUNCTION(utf8_decode)</span></a>
<a name="6187"><span class="lineNum">    6187 </span>            : {</a>
<a name="6188"><span class="lineNum">    6188 </span>            :         char *arg;</a>
<a name="6189"><span class="lineNum">    6189 </span>            :         size_t arg_len;</a>
<a name="6190"><span class="lineNum">    6190 </span>            : </a>
<a name="6191"><span class="lineNum">    6191 </span><span class="lineCov">         75 :         ZEND_PARSE_PARAMETERS_START(1, 1)</span></a>
<a name="6192"><span class="lineNum">    6192 </span><span class="lineCov">         54 :                 Z_PARAM_STRING(arg, arg_len)</span></a>
<a name="6193"><span class="lineNum">    6193 </span><span class="lineCov">         75 :         ZEND_PARSE_PARAMETERS_END();</span></a>
<a name="6194"><span class="lineNum">    6194 </span>            : </a>
<a name="6195"><span class="lineNum">    6195 </span><span class="lineCov">         48 :         RETURN_STR(php_utf8_decode(arg, arg_len));</span></a>
<a name="6196"><span class="lineNum">    6196 </span>            : }</a>
<a name="6197"><span class="lineNum">    6197 </span>            : /* }}} */</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.14</a></td></tr>
  </table>
  <br>

</body>
</html>
