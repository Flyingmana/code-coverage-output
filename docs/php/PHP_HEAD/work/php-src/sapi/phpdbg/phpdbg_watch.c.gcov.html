<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - tests.info - /work/php-src/sapi/phpdbg/phpdbg_watch.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">work/php-src/sapi/phpdbg</a> - phpdbg_watch.c<span style="font-size: 80%;"> (source / <a href="phpdbg_watch.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">tests.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">675</td>
            <td class="headerCovTableEntry">774</td>
            <td class="headerCovTableEntryMed">87.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-11-29 14:13:02</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">54</td>
            <td class="headerCovTableEntry">58</td>
            <td class="headerCovTableEntryHi">93.1 %</td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<a name="2"><span class="lineNum">       2 </span>            :    +----------------------------------------------------------------------+</a>
<a name="3"><span class="lineNum">       3 </span>            :    | Copyright (c) The PHP Group                                          |</a>
<a name="4"><span class="lineNum">       4 </span>            :    +----------------------------------------------------------------------+</a>
<a name="5"><span class="lineNum">       5 </span>            :    | This source file is subject to version 3.01 of the PHP license,      |</a>
<a name="6"><span class="lineNum">       6 </span>            :    | that is bundled with this package in the file LICENSE, and is        |</a>
<a name="7"><span class="lineNum">       7 </span>            :    | available through the world-wide-web at the following url:           |</a>
<a name="8"><span class="lineNum">       8 </span>            :    | https://www.php.net/license/3_01.txt                                 |</a>
<a name="9"><span class="lineNum">       9 </span>            :    | If you did not receive a copy of the PHP license and are unable to   |</a>
<a name="10"><span class="lineNum">      10 </span>            :    | obtain it through the world-wide-web, please send a note to          |</a>
<a name="11"><span class="lineNum">      11 </span>            :    | license@php.net so we can mail you a copy immediately.               |</a>
<a name="12"><span class="lineNum">      12 </span>            :    +----------------------------------------------------------------------+</a>
<a name="13"><span class="lineNum">      13 </span>            :    | Authors: Felipe Pena &lt;felipe@php.net&gt;                                |</a>
<a name="14"><span class="lineNum">      14 </span>            :    | Authors: Joe Watkins &lt;joe.watkins@live.co.uk&gt;                        |</a>
<a name="15"><span class="lineNum">      15 </span>            :    | Authors: Bob Weinand &lt;bwoebi@php.net&gt;                                |</a>
<a name="16"><span class="lineNum">      16 </span>            :    +----------------------------------------------------------------------+</a>
<a name="17"><span class="lineNum">      17 </span>            : */</a>
<a name="18"><span class="lineNum">      18 </span>            : </a>
<a name="19"><span class="lineNum">      19 </span>            : /* Some information for the reader...</a>
<a name="20"><span class="lineNum">      20 </span>            :  *</a>
<a name="21"><span class="lineNum">      21 </span>            :  * The main structure managing the direct observations is the watchpoint (phpdbg_watchpoint_t). There are several types of watchpoints currently:</a>
<a name="22"><span class="lineNum">      22 </span>            :  * WATCH_ON_BUCKET: a watchpoint on a Bucket element, used to monitor values inside HashTables (largely handled equivalently to WATCH_ON_ZVAL, it just monitors also for IS_UNDEF and key changes)</a>
<a name="23"><span class="lineNum">      23 </span>            :  * WATCH_ON_ZVAL: a watchpoint on a bare zval (&amp;zend_reference.val, zval.value.indirect)</a>
<a name="24"><span class="lineNum">      24 </span>            :  * WATCH_ON_STR: a watchpoint on a zend_string (put on &amp;ZSTR_LEN() in order to not watch refcount/hash)</a>
<a name="25"><span class="lineNum">      25 </span>            :  * WATCH_ON_HASHTABLE: a watchpoint on a HashTable (currently only used to observe size changes, put after flags in order to not watch refcount)</a>
<a name="26"><span class="lineNum">      26 </span>            :  * WATCH_ON_REFCOUNTED: a watchpoint on a zend_refcounted, observes the refcount and serves as reference pointer in the custom efree handler</a>
<a name="27"><span class="lineNum">      27 </span>            :  * WATCH_ON_HASHDATA: special watchpoint to watch for HT_GET_DATA_ADDR(ht) being efree()'d to be able to properly relocate Bucket watches</a>
<a name="28"><span class="lineNum">      28 </span>            :  *</a>
<a name="29"><span class="lineNum">      29 </span>            :  * Watch elements are either simple, recursive or implicit (PHPDBG_WATCH_* flags)</a>
<a name="30"><span class="lineNum">      30 </span>            :  * Simple means that a particular watchpoint was explicitly defined</a>
<a name="31"><span class="lineNum">      31 </span>            :  * Recursive watch elements are created recursively (recursive root flag is to distinguish the root element easily from its children recursive elements)</a>
<a name="32"><span class="lineNum">      32 </span>            :  * Implicit  watch elements are implicitly created on all ancestors of simple or recursive watch elements</a>
<a name="33"><span class="lineNum">      33 </span>            :  * Recursive and (simple or implicit) watch elements are mutually exclusive</a>
<a name="34"><span class="lineNum">      34 </span>            :  * Array/Object to distinguish watch elements on arrays</a>
<a name="35"><span class="lineNum">      35 </span>            :  *</a>
<a name="36"><span class="lineNum">      36 </span>            :  * Watch elements all contain a reference to a watchpoint (except if scheduled for recreation); a &quot;watch&quot; is a watch element created by the user with a specific id</a>
<a name="37"><span class="lineNum">      37 </span>            :  * Each watch has its independent structure of watch elements, watchpoints are responsible for managing collisions and preventing pointers being watched multiple times</a>
<a name="38"><span class="lineNum">      38 </span>            :  *</a>
<a name="39"><span class="lineNum">      39 </span>            :  * PHPDBG_G(watchpoint_tree) contains all watchpoints identified by the watch target address</a>
<a name="40"><span class="lineNum">      40 </span>            :  * PHPDBG_G(watch_HashTables) contains the addresses of parent_containers of watch elements</a>
<a name="41"><span class="lineNum">      41 </span>            :  * PHPDBG_G(watch_elements) contains all directly defined watch elements (i.e. those which have an individual id)</a>
<a name="42"><span class="lineNum">      42 </span>            :  * PHPDBG_G(watch_collisions) is indexed by a zend_refcounted * pointer (phpdbg_watchpoint_t.ref). It stores information about collisions (everything which contains a zend_refcounted * may be referenced by multiple watches)</a>
<a name="43"><span class="lineNum">      43 </span>            :  * PHPDBG_G(watch_free) is a set of pointers to watch for being freed (like HashTables referenced by phpdbg_watch_element.parent_container)</a>
<a name="44"><span class="lineNum">      44 </span>            :  * PHPDBG_G(watch_recreation) is the list of watch elements whose watchpoint has been removed (via efree() for example) and needs to be recreated</a>
<a name="45"><span class="lineNum">      45 </span>            :  * PHPDBG_G(watchlist_mem) is the list of unprotected memory pages; used to watch which pages need their PROT_WRITE attribute removed after checking</a>
<a name="46"><span class="lineNum">      46 </span>            :  *</a>
<a name="47"><span class="lineNum">      47 </span>            :  * Watching on addresses:</a>
<a name="48"><span class="lineNum">      48 </span>            :  * * Address and size are transformed into memory page aligned address and size</a>
<a name="49"><span class="lineNum">      49 </span>            :  * * mprotect() enables or disables them (depending on flags) - Windows has a transparent compatibility layer in phpdbg_win.c</a>
<a name="50"><span class="lineNum">      50 </span>            :  * * segfault handler stores the address of the page and marks it again as writable</a>
<a name="51"><span class="lineNum">      51 </span>            :  * * later watchpoints pointing inside these pages are compared against their current value and eventually reactivated (or deleted)</a>
<a name="52"><span class="lineNum">      52 </span>            :  *</a>
<a name="53"><span class="lineNum">      53 </span>            :  * Creating a watch:</a>
<a name="54"><span class="lineNum">      54 </span>            :  * * Implicit watch elements for each element in the hierarchy (starting from base, which typically is current symbol table) except the last one</a>
<a name="55"><span class="lineNum">      55 </span>            :  * * Create a watch element with either simple flag or recursive [+ root] flags</a>
<a name="56"><span class="lineNum">      56 </span>            :  * * If the element has recursive flag, create elements recursively for every referenced HashTable and zval</a>
<a name="57"><span class="lineNum">      57 </span>            :  *</a>
<a name="58"><span class="lineNum">      58 </span>            :  * Creating a watch element:</a>
<a name="59"><span class="lineNum">      59 </span>            :  * * For each watch element a related watchpoint is created, if there's none yet; add itself then into the list of parents of that watchpoint</a>
<a name="60"><span class="lineNum">      60 </span>            :  * * If the watch has a parent_container, add itself also into a phpdbg_watch_ht_info (inside PHPDBG_G(watch_HashTables)) [and creates it if not yet existing]</a>
<a name="61"><span class="lineNum">      61 </span>            :  *</a>
<a name="62"><span class="lineNum">      62 </span>            :  * Creation of watchpoints:</a>
<a name="63"><span class="lineNum">      63 </span>            :  * * Watchpoints create a watch collision for each refcounted or indirect on the zval (if type is WATCH_ON_BUCKET or WATCH_ON_ZVAL)</a>
<a name="64"><span class="lineNum">      64 </span>            :  * * Backs the current value of the watched pointer up</a>
<a name="65"><span class="lineNum">      65 </span>            :  * * Installs the watchpoint in PHPDBG_G(watchpoint_tree) and activates it (activation of a watchpoint = remove PROT_WRITE from the pages the watched pointer resides on)</a>
<a name="66"><span class="lineNum">      66 </span>            :  *</a>
<a name="67"><span class="lineNum">      67 </span>            :  * Watch collisions:</a>
<a name="68"><span class="lineNum">      68 </span>            :  * * Manages a watchpoint on the refcount (WATCH_ON_REFCOUNTED) or indirect zval (WATCH_ON_ZVAL)</a>
<a name="69"><span class="lineNum">      69 </span>            :  * * Guarantees that every pointer is watched at most once (by having a pointer to collision mapping in PHPDBG_G(watch_collisions), which have the unique watchpoints for the respective collision)</a>
<a name="70"><span class="lineNum">      70 </span>            :  * * Contains a list of parents, i.e. which watchpoints reference it (via watch-&gt;ref)</a>
<a name="71"><span class="lineNum">      71 </span>            :  * * If no watchpoint is referencing it anymore, the watch collision and its associated watchpoints (phpdbg_watch_collision.ref/reference) are removed</a>
<a name="72"><span class="lineNum">      72 </span>            :  *</a>
<a name="73"><span class="lineNum">      73 </span>            :  * Deleting a watch:</a>
<a name="74"><span class="lineNum">      74 </span>            :  * * Watches are stored by an id in PHPDBG_G(watch_elements); the associated watch element is then deleted</a>
<a name="75"><span class="lineNum">      75 </span>            :  * * Deletes all parent and children implicit watch elements</a>
<a name="76"><span class="lineNum">      76 </span>            :  *</a>
<a name="77"><span class="lineNum">      77 </span>            :  * Deleting a watch element:</a>
<a name="78"><span class="lineNum">      78 </span>            :  * * Removes itself from the parent list of the associated watchpoints; if that parent list is empty, also delete the watchpoint</a>
<a name="79"><span class="lineNum">      79 </span>            :  * * Removes itself from the related phpdbg_watch_ht_info if it has a parent_container</a>
<a name="80"><span class="lineNum">      80 </span>            :  *</a>
<a name="81"><span class="lineNum">      81 </span>            :  * Deleting a watchpoint:</a>
<a name="82"><span class="lineNum">      82 </span>            :  * * Remove itself from watch collisions this watchpoint participates in</a>
<a name="83"><span class="lineNum">      83 </span>            :  * * Removes the watchpoint from PHPDBG_G(watchpoint_tree) and deactivates it (deactivation of a watchpoint = add PROT_WRITE to the pages the watched pointer resides on)</a>
<a name="84"><span class="lineNum">      84 </span>            :  *</a>
<a name="85"><span class="lineNum">      85 </span>            :  * A watched pointer is efree()'d:</a>
<a name="86"><span class="lineNum">      86 </span>            :  * * Needs immediate action as we else may run into dereferencing a pointer into freed memory</a>
<a name="87"><span class="lineNum">      87 </span>            :  * * Deletes the associated watchpoint, and for each watch element, if recursive, all its children elements</a>
<a name="88"><span class="lineNum">      88 </span>            :  * * If the its watch elements are implicit, recursive roots or simple, they and all their children are dissociated from their watchpoints (i.e. removed from the watchpoint, if no other element is referencing it, it is deleted); adds these elements to PHPDBG_G(watch_recreation)</a>
<a name="89"><span class="lineNum">      89 </span>            :  *</a>
<a name="90"><span class="lineNum">      90 </span>            :  * Recreating watchpoints:</a>
<a name="91"><span class="lineNum">      91 </span>            :  * * Upon each opcode, PHPDBG_G(watch_recreation) is checked and all its elements are searched for whether the watch is still reachable via the tree given by its implicits</a>
<a name="92"><span class="lineNum">      92 </span>            :  * * In case they are not reachable, the watch is deleted (and thus all the related watch elements), else a new watchpoint is created for all the watch elements</a>
<a name="93"><span class="lineNum">      93 </span>            :  * * The old and new values of the watches are compared and shown if changed</a>
<a name="94"><span class="lineNum">      94 </span>            :  *</a>
<a name="95"><span class="lineNum">      95 </span>            :  * Comparing watchpoints:</a>
<a name="96"><span class="lineNum">      96 </span>            :  * * The old and new values of the watches are compared and shown if changed</a>
<a name="97"><span class="lineNum">      97 </span>            :  * * If changed, it is checked whether the refcounted/indirect changed and watch collisions removed or created accordingly</a>
<a name="98"><span class="lineNum">      98 </span>            :  * * If a zval/bucket watchpoint is recursive, watch elements are added or removed accordingly</a>
<a name="99"><span class="lineNum">      99 </span>            :  * * If an array watchpoint is recursive, new array watchpoints are added if there are new ones in the array</a>
<a name="100"><span class="lineNum">     100 </span>            :  * * If the watch (element with an id) is not reachable anymore due to changes in implicits, the watch is removed</a>
<a name="101"><span class="lineNum">     101 </span>            :  */</a>
<a name="102"><span class="lineNum">     102 </span>            : </a>
<a name="103"><span class="lineNum">     103 </span>            : #include &quot;zend.h&quot;</a>
<a name="104"><span class="lineNum">     104 </span>            : #include &quot;phpdbg.h&quot;</a>
<a name="105"><span class="lineNum">     105 </span>            : #include &quot;phpdbg_btree.h&quot;</a>
<a name="106"><span class="lineNum">     106 </span>            : #include &quot;phpdbg_watch.h&quot;</a>
<a name="107"><span class="lineNum">     107 </span>            : #include &quot;phpdbg_utils.h&quot;</a>
<a name="108"><span class="lineNum">     108 </span>            : #include &quot;phpdbg_prompt.h&quot;</a>
<a name="109"><span class="lineNum">     109 </span>            : #ifndef _WIN32</a>
<a name="110"><span class="lineNum">     110 </span>            : # include &lt;unistd.h&gt;</a>
<a name="111"><span class="lineNum">     111 </span>            : # include &lt;sys/mman.h&gt;</a>
<a name="112"><span class="lineNum">     112 </span>            : #endif</a>
<a name="113"><span class="lineNum">     113 </span>            : </a>
<a name="114"><span class="lineNum">     114 </span>            : #ifdef HAVE_USERFAULTFD_WRITEFAULT</a>
<a name="115"><span class="lineNum">     115 </span>            : # include &lt;pthread.h&gt;</a>
<a name="116"><span class="lineNum">     116 </span>            : # include &lt;linux/userfaultfd.h&gt;</a>
<a name="117"><span class="lineNum">     117 </span>            : # include &lt;sys/ioctl.h&gt;</a>
<a name="118"><span class="lineNum">     118 </span>            : # include &lt;sys/syscall.h&gt;</a>
<a name="119"><span class="lineNum">     119 </span>            : #endif</a>
<a name="120"><span class="lineNum">     120 </span>            : </a>
<a name="121"><span class="lineNum">     121 </span>            : ZEND_EXTERN_MODULE_GLOBALS(phpdbg)</a>
<a name="122"><span class="lineNum">     122 </span>            : </a>
<a name="123"><span class="lineNum">     123 </span>            : const phpdbg_command_t phpdbg_watch_commands[] = {</a>
<a name="124"><span class="lineNum">     124 </span>            :         PHPDBG_COMMAND_D_EX(array,      &quot;create watchpoint on an array&quot;, 'a', watch_array,     &amp;phpdbg_prompt_commands[24], &quot;s&quot;, 0),</a>
<a name="125"><span class="lineNum">     125 </span>            :         PHPDBG_COMMAND_D_EX(delete,     &quot;delete watchpoint&quot;,             'd', watch_delete,    &amp;phpdbg_prompt_commands[24], &quot;n&quot;, 0),</a>
<a name="126"><span class="lineNum">     126 </span>            :         PHPDBG_COMMAND_D_EX(recursive,  &quot;create recursive watchpoints&quot;,  'r', watch_recursive, &amp;phpdbg_prompt_commands[24], &quot;s&quot;, 0),</a>
<a name="127"><span class="lineNum">     127 </span>            :         PHPDBG_END_COMMAND</a>
<a name="128"><span class="lineNum">     128 </span>            : };</a>
<a name="129"><span class="lineNum">     129 </span>            : </a>
<a name="130"><span class="lineNum">     130 </span>            : #define HT_FROM_ZVP(zvp) (Z_TYPE_P(zvp) == IS_OBJECT ? Z_OBJPROP_P(zvp) : Z_TYPE_P(zvp) == IS_ARRAY ? Z_ARRVAL_P(zvp) : NULL)</a>
<a name="131"><span class="lineNum">     131 </span>            : </a>
<a name="132"><span class="lineNum">     132 </span>            : #define HT_WATCH_OFFSET (sizeof(zend_refcounted *) + sizeof(uint32_t)) /* we are not interested in gc and flags */</a>
<a name="133"><span class="lineNum">     133 </span>            : #define HT_PTR_HT(ptr) ((HashTable *) (((char *) (ptr)) - HT_WATCH_OFFSET))</a>
<a name="134"><span class="lineNum">     134 </span>            : #define HT_WATCH_HT(watch) HT_PTR_HT((watch)-&gt;addr.ptr)</a>
<a name="135"><span class="lineNum">     135 </span>            : </a>
<a name="136"><span class="lineNum">     136 </span>            : /* ### PRINTING POINTER DIFFERENCES ### */</a>
<a name="137"><span class="lineNum">     137 </span><span class="lineCov">        192 : bool phpdbg_check_watch_diff(phpdbg_watchtype type, void *oldPtr, void *newPtr) {</span></a>
<a name="138"><span class="lineNum">     138 </span><span class="lineCov">        192 :         switch (type) {</span></a>
<a name="139"><span class="lineNum">     139 </span><span class="lineCov">         78 :                 case WATCH_ON_BUCKET:</span></a>
<a name="140"><span class="lineNum">     140 </span><span class="lineCov">         78 :                         if (memcmp(&amp;((Bucket *) oldPtr)-&gt;h, &amp;((Bucket *) newPtr)-&gt;h, sizeof(Bucket) - sizeof(zval) /* key/val comparison */) != 0) {</span></a>
<a name="141"><span class="lineNum">     141 </span><span class="lineCov">         12 :                                 return 2;</span></a>
<a name="142"><span class="lineNum">     142 </span>            :                         }</a>
<a name="143"><span class="lineNum">     143 </span>            :                         /* TODO: Is this intentional? */</a>
<a name="144"><span class="lineNum">     144 </span>            :                         ZEND_FALLTHROUGH;</a>
<a name="145"><span class="lineNum">     145 </span>            :                 case WATCH_ON_ZVAL:</a>
<a name="146"><span class="lineNum">     146 </span><span class="lineCov">        123 :                         return memcmp(oldPtr, newPtr, sizeof(zend_value) + sizeof(uint32_t) /* value + typeinfo */) != 0;</span></a>
<a name="147"><span class="lineNum">     147 </span><span class="lineCov">         12 :                 case WATCH_ON_HASHTABLE:</span></a>
<a name="148"><span class="lineNum">     148 </span><span class="lineCov">         12 :                         return zend_hash_num_elements(HT_PTR_HT(oldPtr)) != zend_hash_num_elements(HT_PTR_HT(newPtr));</span></a>
<a name="149"><span class="lineNum">     149 </span><span class="lineCov">         36 :                 case WATCH_ON_REFCOUNTED:</span></a>
<a name="150"><span class="lineNum">     150 </span><span class="lineCov">         36 :                         return memcmp(oldPtr, newPtr, sizeof(uint32_t) /* no zend_refcounted metadata info */) != 0;</span></a>
<a name="151"><span class="lineNum">     151 </span><span class="lineCov">          9 :                 case WATCH_ON_STR:</span></a>
<a name="152"><span class="lineNum">     152 </span><span class="lineCov">          9 :                         return memcmp(oldPtr, newPtr, *(size_t *) oldPtr + XtOffsetOf(zend_string, val) - XtOffsetOf(zend_string, len)) != 0;</span></a>
<a name="153"><span class="lineNum">     153 </span><span class="lineNoCov">          0 :                 case WATCH_ON_HASHDATA:</span></a>
<a name="154"><span class="lineNum">     154 </span><span class="lineNoCov">          0 :                         ZEND_UNREACHABLE();</span></a>
<a name="155"><span class="lineNum">     155 </span>            :         }</a>
<a name="156"><span class="lineNum">     156 </span><span class="lineNoCov">          0 :         return 0;</span></a>
<a name="157"><span class="lineNum">     157 </span>            : }</a>
<a name="158"><span class="lineNum">     158 </span>            : </a>
<a name="159"><span class="lineNum">     159 </span><span class="lineCov">         51 : void phpdbg_print_watch_diff(phpdbg_watchtype type, zend_string *name, void *oldPtr, void *newPtr) {</span></a>
<a name="160"><span class="lineNum">     160 </span>            :         int32_t elementDiff;</a>
<a name="161"><span class="lineNum">     161 </span>            : </a>
<a name="162"><span class="lineNum">     162 </span><span class="lineCov">         51 :         PHPDBG_G(watchpoint_hit) = 1;</span></a>
<a name="163"><span class="lineNum">     163 </span>            : </a>
<a name="164"><span class="lineNum">     164 </span><span class="lineCov">         51 :         phpdbg_notice(&quot;Breaking on watchpoint %.*s&quot;, (int) ZSTR_LEN(name), ZSTR_VAL(name));</span></a>
<a name="165"><span class="lineNum">     165 </span>            : </a>
<a name="166"><span class="lineNum">     166 </span><span class="lineCov">         51 :         switch (type) {</span></a>
<a name="167"><span class="lineNum">     167 </span><span class="lineCov">         39 :                 case WATCH_ON_BUCKET:</span></a>
<a name="168"><span class="lineNum">     168 </span>            :                 case WATCH_ON_ZVAL:</a>
<a name="169"><span class="lineNum">     169 </span><span class="lineCov">         39 :                         if (Z_REFCOUNTED_P((zval *) oldPtr)) {</span></a>
<a name="170"><span class="lineNum">     170 </span><span class="lineCov">         12 :                                 phpdbg_writeln(&quot;Old value inaccessible or destroyed&quot;);</span></a>
<a name="171"><span class="lineNum">     171 </span><span class="lineCov">         27 :                         } else if (Z_TYPE_P((zval *) oldPtr) == IS_INDIRECT) {</span></a>
<a name="172"><span class="lineNum">     172 </span><span class="lineNoCov">          0 :                                 phpdbg_writeln(&quot;Old value inaccessible or destroyed (was indirect)&quot;);</span></a>
<a name="173"><span class="lineNum">     173 </span>            :                         } else {</a>
<a name="174"><span class="lineNum">     174 </span><span class="lineCov">         27 :                                 phpdbg_out(&quot;Old value: &quot;);</span></a>
<a name="175"><span class="lineNum">     175 </span><span class="lineCov">         27 :                                 zend_print_flat_zval_r((zval *) oldPtr);</span></a>
<a name="176"><span class="lineNum">     176 </span><span class="lineCov">         27 :                                 phpdbg_out(&quot;\n&quot;);</span></a>
<a name="177"><span class="lineNum">     177 </span>            :                         }</a>
<a name="178"><span class="lineNum">     178 </span>            : </a>
<a name="179"><span class="lineNum">     179 </span><span class="lineCov">         87 :                         while (Z_TYPE_P((zval *) newPtr) == IS_INDIRECT) {</span></a>
<a name="180"><span class="lineNum">     180 </span><span class="lineCov">          9 :                                 newPtr = Z_INDIRECT_P((zval *) newPtr);</span></a>
<a name="181"><span class="lineNum">     181 </span>            :                         }</a>
<a name="182"><span class="lineNum">     182 </span>            : </a>
<a name="183"><span class="lineNum">     183 </span><span class="lineCov">         39 :                         phpdbg_out(&quot;New value%s: &quot;, Z_ISREF_P((zval *) newPtr) ? &quot; (reference)&quot; : &quot;&quot;);</span></a>
<a name="184"><span class="lineNum">     184 </span><span class="lineCov">         39 :                         zend_print_flat_zval_r((zval *) newPtr);</span></a>
<a name="185"><span class="lineNum">     185 </span><span class="lineCov">         39 :                         phpdbg_out(&quot;\n&quot;);</span></a>
<a name="186"><span class="lineNum">     186 </span><span class="lineCov">         39 :                         break;</span></a>
<a name="187"><span class="lineNum">     187 </span>            : </a>
<a name="188"><span class="lineNum">     188 </span><span class="lineCov">          6 :                 case WATCH_ON_HASHTABLE:</span></a>
<a name="189"><span class="lineNum">     189 </span><span class="lineCov">          6 :                         elementDiff = zend_hash_num_elements(HT_PTR_HT(oldPtr)) - zend_hash_num_elements(HT_PTR_HT(newPtr));</span></a>
<a name="190"><span class="lineNum">     190 </span><span class="lineCov">          6 :                         if (elementDiff &gt; 0) {</span></a>
<a name="191"><span class="lineNum">     191 </span><span class="lineNoCov">          0 :                                 phpdbg_writeln(&quot;%d elements were removed from the array&quot;, (int) elementDiff);</span></a>
<a name="192"><span class="lineNum">     192 </span><span class="lineCov">          6 :                         } else if (elementDiff &lt; 0) {</span></a>
<a name="193"><span class="lineNum">     193 </span><span class="lineCov">          6 :                                 phpdbg_writeln(&quot;%d elements were added to the array&quot;, (int) -elementDiff);</span></a>
<a name="194"><span class="lineNum">     194 </span>            :                         }</a>
<a name="195"><span class="lineNum">     195 </span><span class="lineCov">          6 :                         break;</span></a>
<a name="196"><span class="lineNum">     196 </span>            : </a>
<a name="197"><span class="lineNum">     197 </span><span class="lineNoCov">          0 :                 case WATCH_ON_REFCOUNTED:</span></a>
<a name="198"><span class="lineNum">     198 </span><span class="lineNoCov">          0 :                         phpdbg_writeln(&quot;Old refcount: %d&quot;, GC_REFCOUNT((zend_refcounted *) oldPtr));</span></a>
<a name="199"><span class="lineNum">     199 </span><span class="lineNoCov">          0 :                         phpdbg_writeln(&quot;New refcount: %d&quot;, GC_REFCOUNT((zend_refcounted *) newPtr));</span></a>
<a name="200"><span class="lineNum">     200 </span><span class="lineNoCov">          0 :                         break;</span></a>
<a name="201"><span class="lineNum">     201 </span>            : </a>
<a name="202"><span class="lineNum">     202 </span><span class="lineCov">          6 :                 case WATCH_ON_STR:</span></a>
<a name="203"><span class="lineNum">     203 </span><span class="lineCov">          6 :                         phpdbg_out(&quot;Old value: &quot;);</span></a>
<a name="204"><span class="lineNum">     204 </span><span class="lineCov">          6 :                         zend_write((char *) oldPtr + XtOffsetOf(zend_string, val) - XtOffsetOf(zend_string, len), *(size_t *) oldPtr);</span></a>
<a name="205"><span class="lineNum">     205 </span><span class="lineCov">          6 :                         phpdbg_out(&quot;\n&quot;);</span></a>
<a name="206"><span class="lineNum">     206 </span>            : </a>
<a name="207"><span class="lineNum">     207 </span><span class="lineCov">          6 :                         phpdbg_out(&quot;New value: &quot;);</span></a>
<a name="208"><span class="lineNum">     208 </span><span class="lineCov">          6 :                         zend_write((char *) newPtr + XtOffsetOf(zend_string, val) - XtOffsetOf(zend_string, len), *(size_t *) newPtr);</span></a>
<a name="209"><span class="lineNum">     209 </span><span class="lineCov">          6 :                         phpdbg_out(&quot;\n&quot;);</span></a>
<a name="210"><span class="lineNum">     210 </span><span class="lineCov">          6 :                         break;</span></a>
<a name="211"><span class="lineNum">     211 </span>            : </a>
<a name="212"><span class="lineNum">     212 </span><span class="lineNoCov">          0 :                 case WATCH_ON_HASHDATA:</span></a>
<a name="213"><span class="lineNum">     213 </span><span class="lineNoCov">          0 :                         ZEND_UNREACHABLE();</span></a>
<a name="214"><span class="lineNum">     214 </span>            :         }</a>
<a name="215"><span class="lineNum">     215 </span><span class="lineCov">         51 : }</span></a>
<a name="216"><span class="lineNum">     216 </span>            : </a>
<a name="217"><span class="lineNum">     217 </span>            : /* ### LOW LEVEL WATCHPOINT HANDLING ### */</a>
<a name="218"><span class="lineNum">     218 </span><span class="lineCov">        213 : static phpdbg_watchpoint_t *phpdbg_check_for_watchpoint(phpdbg_btree *tree, void *addr) {</span></a>
<a name="219"><span class="lineNum">     219 </span>            :         phpdbg_watchpoint_t *watch;</a>
<a name="220"><span class="lineNum">     220 </span><span class="lineCov">        213 :         phpdbg_btree_result *result = phpdbg_btree_find_closest(tree, (zend_ulong) phpdbg_get_page_boundary(addr) + phpdbg_pagesize - 1);</span></a>
<a name="221"><span class="lineNum">     221 </span>            : </a>
<a name="222"><span class="lineNum">     222 </span><span class="lineCov">        213 :         if (result == NULL) {</span></a>
<a name="223"><span class="lineNum">     223 </span><span class="lineNoCov">          0 :                 return NULL;</span></a>
<a name="224"><span class="lineNum">     224 </span>            :         }</a>
<a name="225"><span class="lineNum">     225 </span>            : </a>
<a name="226"><span class="lineNum">     226 </span><span class="lineCov">        213 :         watch = result-&gt;ptr;</span></a>
<a name="227"><span class="lineNum">     227 </span>            : </a>
<a name="228"><span class="lineNum">     228 </span>            :         /* check if that addr is in a mprotect()'ed memory area */</a>
<a name="229"><span class="lineNum">     229 </span><span class="lineCov">        852 :         if ((char *) phpdbg_get_page_boundary(watch-&gt;addr.ptr) &gt; (char *) addr || (char *) phpdbg_get_page_boundary(watch-&gt;addr.ptr) + phpdbg_get_total_page_size(watch-&gt;addr.ptr, watch-&gt;size) &lt; (char *) addr) {</span></a>
<a name="230"><span class="lineNum">     230 </span>            :                 /* failure */</a>
<a name="231"><span class="lineNum">     231 </span><span class="lineNoCov">          0 :                 return NULL;</span></a>
<a name="232"><span class="lineNum">     232 </span>            :         }</a>
<a name="233"><span class="lineNum">     233 </span>            : </a>
<a name="234"><span class="lineNum">     234 </span><span class="lineCov">        213 :         return watch;</span></a>
<a name="235"><span class="lineNum">     235 </span>            : }</a>
<a name="236"><span class="lineNum">     236 </span>            : </a>
<a name="237"><span class="lineNum">     237 </span><span class="lineCov">        606 : static void phpdbg_change_watchpoint_access(phpdbg_watchpoint_t *watch, int access) {</span></a>
<a name="238"><span class="lineNum">     238 </span><span class="lineCov">        606 :         void *page_addr = phpdbg_get_page_boundary(watch-&gt;addr.ptr);</span></a>
<a name="239"><span class="lineNum">     239 </span><span class="lineCov">        606 :         size_t size = phpdbg_get_total_page_size(watch-&gt;addr.ptr, watch-&gt;size);</span></a>
<a name="240"><span class="lineNum">     240 </span>            : #ifdef HAVE_USERFAULTFD_WRITEFAULT</a>
<a name="241"><span class="lineNum">     241 </span>            :         if (PHPDBG_G(watch_userfaultfd)) {</a>
<a name="242"><span class="lineNum">     242 </span>            :                 struct uffdio_range range = {</a>
<a name="243"><span class="lineNum">     243 </span>            :                         .start = (__u64)(uintptr_t) page_addr,</a>
<a name="244"><span class="lineNum">     244 </span>            :                         .len = size</a>
<a name="245"><span class="lineNum">     245 </span>            :                 };</a>
<a name="246"><span class="lineNum">     246 </span>            :                 if (access == PROT_READ) {</a>
<a name="247"><span class="lineNum">     247 </span>            :                         struct uffdio_register reg = {</a>
<a name="248"><span class="lineNum">     248 </span>            :                                 .mode = UFFDIO_REGISTER_MODE_WP,</a>
<a name="249"><span class="lineNum">     249 </span>            :                                 .range = range</a>
<a name="250"><span class="lineNum">     250 </span>            :                         };</a>
<a name="251"><span class="lineNum">     251 </span>            :                         struct uffdio_writeprotect protect = {</a>
<a name="252"><span class="lineNum">     252 </span>            :                                 .mode = UFFDIO_WRITEPROTECT_MODE_WP,</a>
<a name="253"><span class="lineNum">     253 </span>            :                                 .range = range</a>
<a name="254"><span class="lineNum">     254 </span>            :                         };</a>
<a name="255"><span class="lineNum">     255 </span>            :                         ioctl(PHPDBG_G(watch_userfaultfd), UFFDIO_REGISTER,  &amp;reg);</a>
<a name="256"><span class="lineNum">     256 </span>            :                         ioctl(PHPDBG_G(watch_userfaultfd), UFFDIO_WRITEPROTECT,  &amp;protect);</a>
<a name="257"><span class="lineNum">     257 </span>            :                 } else {</a>
<a name="258"><span class="lineNum">     258 </span>            :                         struct uffdio_register reg = {</a>
<a name="259"><span class="lineNum">     259 </span>            :                                 .mode = UFFDIO_REGISTER_MODE_WP,</a>
<a name="260"><span class="lineNum">     260 </span>            :                                 .range = range</a>
<a name="261"><span class="lineNum">     261 </span>            :                         };</a>
<a name="262"><span class="lineNum">     262 </span>            :                         ioctl(PHPDBG_G(watch_userfaultfd), UFFDIO_UNREGISTER,  &amp;reg);</a>
<a name="263"><span class="lineNum">     263 </span>            :                 }</a>
<a name="264"><span class="lineNum">     264 </span>            :         } else</a>
<a name="265"><span class="lineNum">     265 </span>            : #endif</a>
<a name="266"><span class="lineNum">     266 </span>            :         /* pagesize is assumed to be in the range of 2^x */</a>
<a name="267"><span class="lineNum">     267 </span>            :         {</a>
<a name="268"><span class="lineNum">     268 </span><span class="lineCov">        606 :                 mprotect(page_addr, size, access);</span></a>
<a name="269"><span class="lineNum">     269 </span>            :         }</a>
<a name="270"><span class="lineNum">     270 </span><span class="lineCov">        606 : }</span></a>
<a name="271"><span class="lineNum">     271 </span>            : </a>
<a name="272"><span class="lineNum">     272 </span><span class="lineCov">        222 : static inline void phpdbg_activate_watchpoint(phpdbg_watchpoint_t *watch) {</span></a>
<a name="273"><span class="lineNum">     273 </span><span class="lineCov">        222 :         phpdbg_change_watchpoint_access(watch, PROT_READ);</span></a>
<a name="274"><span class="lineNum">     274 </span><span class="lineCov">        222 : }</span></a>
<a name="275"><span class="lineNum">     275 </span>            : </a>
<a name="276"><span class="lineNum">     276 </span><span class="lineCov">        384 : static inline void phpdbg_deactivate_watchpoint(phpdbg_watchpoint_t *watch) {</span></a>
<a name="277"><span class="lineNum">     277 </span><span class="lineCov">        384 :         phpdbg_change_watchpoint_access(watch, PROT_READ | PROT_WRITE);</span></a>
<a name="278"><span class="lineNum">     278 </span><span class="lineCov">        384 : }</span></a>
<a name="279"><span class="lineNum">     279 </span>            : </a>
<a name="280"><span class="lineNum">     280 </span>            : /* Note that consecutive pages need to be merged in order to avoid watchpoints spanning page boundaries to have part of their data in the one page, part in the other page */</a>
<a name="281"><span class="lineNum">     281 </span>            : #ifdef _WIN32</a>
<a name="282"><span class="lineNum">     282 </span>            : int phpdbg_watchpoint_segfault_handler(void *addr) {</a>
<a name="283"><span class="lineNum">     283 </span>            : #else</a>
<a name="284"><span class="lineNum">     284 </span><span class="lineCov">        213 : int phpdbg_watchpoint_segfault_handler(siginfo_t *info, void *context) {</span></a>
<a name="285"><span class="lineNum">     285 </span>            : #endif</a>
<a name="286"><span class="lineNum">     286 </span>            : </a>
<a name="287"><span class="lineNum">     287 </span><span class="lineCov">        213 :         void *page = phpdbg_get_page_boundary(</span></a>
<a name="288"><span class="lineNum">     288 </span>            : #ifdef _WIN32</a>
<a name="289"><span class="lineNum">     289 </span>            :                 addr</a>
<a name="290"><span class="lineNum">     290 </span>            : #else</a>
<a name="291"><span class="lineNum">     291 </span>            :                 info-&gt;si_addr</a>
<a name="292"><span class="lineNum">     292 </span>            : #endif</a>
<a name="293"><span class="lineNum">     293 </span>            :         );</a>
<a name="294"><span class="lineNum">     294 </span>            : </a>
<a name="295"><span class="lineNum">     295 </span>            :         /* perhaps unnecessary, but check to be sure to not conflict with other segfault handlers */</a>
<a name="296"><span class="lineNum">     296 </span><span class="lineCov">        213 :         if (phpdbg_check_for_watchpoint(&amp;PHPDBG_G(watchpoint_tree), page) == NULL) {</span></a>
<a name="297"><span class="lineNum">     297 </span><span class="lineNoCov">          0 :                 return FAILURE;</span></a>
<a name="298"><span class="lineNum">     298 </span>            :         }</a>
<a name="299"><span class="lineNum">     299 </span>            : </a>
<a name="300"><span class="lineNum">     300 </span>            :         /* re-enable writing */</a>
<a name="301"><span class="lineNum">     301 </span><span class="lineCov">        213 :         mprotect(page, phpdbg_pagesize, PROT_READ | PROT_WRITE);</span></a>
<a name="302"><span class="lineNum">     302 </span>            : </a>
<a name="303"><span class="lineNum">     303 </span><span class="lineCov">        213 :         zend_hash_index_add_empty_element(PHPDBG_G(watchlist_mem), (zend_ulong) page);</span></a>
<a name="304"><span class="lineNum">     304 </span>            : </a>
<a name="305"><span class="lineNum">     305 </span><span class="lineCov">        213 :         return SUCCESS;</span></a>
<a name="306"><span class="lineNum">     306 </span>            : }</a>
<a name="307"><span class="lineNum">     307 </span>            : </a>
<a name="308"><span class="lineNum">     308 </span>            : #ifdef HAVE_USERFAULTFD_WRITEFAULT</a>
<a name="309"><span class="lineNum">     309 </span>            : void *phpdbg_watchpoint_userfaultfd_thread(void *phpdbg_globals) {</a>
<a name="310"><span class="lineNum">     310 </span>            :         pthread_setcanceltype(PTHREAD_CANCEL_ASYNCHRONOUS, NULL);</a>
<a name="311"><span class="lineNum">     311 </span>            :         zend_phpdbg_globals *globals = (zend_phpdbg_globals *) phpdbg_globals;</a>
<a name="312"><span class="lineNum">     312 </span>            : </a>
<a name="313"><span class="lineNum">     313 </span>            :         struct uffd_msg fault_msg = {0};</a>
<a name="314"><span class="lineNum">     314 </span>            :         while (read(globals-&gt;watch_userfaultfd, &amp;fault_msg, sizeof(fault_msg)) == sizeof(fault_msg)) {</a>
<a name="315"><span class="lineNum">     315 </span>            :         void *page = phpdbg_get_page_boundary((char *)(uintptr_t) fault_msg.arg.pagefault.address);</a>
<a name="316"><span class="lineNum">     316 </span>            :                 zend_hash_index_add_empty_element(globals-&gt;watchlist_mem, (zend_ulong) page);</a>
<a name="317"><span class="lineNum">     317 </span>            :                 struct uffdio_writeprotect unprotect = {</a>
<a name="318"><span class="lineNum">     318 </span>            :                         .mode = 0,</a>
<a name="319"><span class="lineNum">     319 </span>            :                         .range = {</a>
<a name="320"><span class="lineNum">     320 </span>            :                                 .start = (__u64)(uintptr_t) page,</a>
<a name="321"><span class="lineNum">     321 </span>            :                                 .len = phpdbg_pagesize</a>
<a name="322"><span class="lineNum">     322 </span>            :                         }</a>
<a name="323"><span class="lineNum">     323 </span>            :                 };</a>
<a name="324"><span class="lineNum">     324 </span>            :                 ioctl(globals-&gt;watch_userfaultfd, UFFDIO_WRITEPROTECT, &amp;unprotect);</a>
<a name="325"><span class="lineNum">     325 </span>            :         }</a>
<a name="326"><span class="lineNum">     326 </span>            : </a>
<a name="327"><span class="lineNum">     327 </span>            :         return NULL;</a>
<a name="328"><span class="lineNum">     328 </span>            : }</a>
<a name="329"><span class="lineNum">     329 </span>            : #endif</a>
<a name="330"><span class="lineNum">     330 </span>            : </a>
<a name="331"><span class="lineNum">     331 </span>            : /* ### REGISTER WATCHPOINT ### To be used only by watch element and collision managers ### */</a>
<a name="332"><span class="lineNum">     332 </span><span class="lineCov">        222 : static inline void phpdbg_store_watchpoint_btree(phpdbg_watchpoint_t *watch) {</span></a>
<a name="333"><span class="lineNum">     333 </span>            :         phpdbg_btree_result *res;</a>
<a name="334"><span class="lineNum">     334 </span><span class="lineCov">        222 :         ZEND_ASSERT((res = phpdbg_btree_find(&amp;PHPDBG_G(watchpoint_tree), (zend_ulong) watch-&gt;addr.ptr)) == NULL || res-&gt;ptr == watch);</span></a>
<a name="335"><span class="lineNum">     335 </span><span class="lineCov">        222 :         phpdbg_btree_insert(&amp;PHPDBG_G(watchpoint_tree), (zend_ulong) watch-&gt;addr.ptr, watch);</span></a>
<a name="336"><span class="lineNum">     336 </span><span class="lineCov">        222 : }</span></a>
<a name="337"><span class="lineNum">     337 </span>            : </a>
<a name="338"><span class="lineNum">     338 </span><span class="lineCov">        246 : static inline void phpdbg_remove_watchpoint_btree(phpdbg_watchpoint_t *watch) {</span></a>
<a name="339"><span class="lineNum">     339 </span><span class="lineCov">        246 :         phpdbg_btree_delete(&amp;PHPDBG_G(watchpoint_tree), (zend_ulong) watch-&gt;addr.ptr);</span></a>
<a name="340"><span class="lineNum">     340 </span><span class="lineCov">        246 : }</span></a>
<a name="341"><span class="lineNum">     341 </span>            : </a>
<a name="342"><span class="lineNum">     342 </span>            : /* ### SET WATCHPOINT ADDR ### To be used only by watch element and collision managers ### */</a>
<a name="343"><span class="lineNum">     343 </span><span class="lineCov">        219 : void phpdbg_set_addr_watchpoint(void *addr, size_t size, phpdbg_watchpoint_t *watch) {</span></a>
<a name="344"><span class="lineNum">     344 </span><span class="lineCov">        219 :         watch-&gt;addr.ptr = addr;</span></a>
<a name="345"><span class="lineNum">     345 </span><span class="lineCov">        219 :         watch-&gt;size = size;</span></a>
<a name="346"><span class="lineNum">     346 </span><span class="lineCov">        219 :         watch-&gt;ref = NULL;</span></a>
<a name="347"><span class="lineNum">     347 </span><span class="lineCov">        219 :         watch-&gt;coll = NULL;</span></a>
<a name="348"><span class="lineNum">     348 </span><span class="lineCov">        219 :         zend_hash_init(&amp;watch-&gt;elements, 8, brml, NULL, 0);</span></a>
<a name="349"><span class="lineNum">     349 </span><span class="lineCov">        219 : }</span></a>
<a name="350"><span class="lineNum">     350 </span>            : </a>
<a name="351"><span class="lineNum">     351 </span><span class="lineCov">         27 : void phpdbg_set_zval_watchpoint(zval *zv, phpdbg_watchpoint_t *watch) {</span></a>
<a name="352"><span class="lineNum">     352 </span><span class="lineCov">         27 :         phpdbg_set_addr_watchpoint(zv, sizeof(zval) - sizeof(uint32_t), watch);</span></a>
<a name="353"><span class="lineNum">     353 </span><span class="lineCov">         27 :         watch-&gt;type = WATCH_ON_ZVAL;</span></a>
<a name="354"><span class="lineNum">     354 </span><span class="lineCov">         27 : }</span></a>
<a name="355"><span class="lineNum">     355 </span>            : </a>
<a name="356"><span class="lineNum">     356 </span><span class="lineCov">         69 : void phpdbg_set_bucket_watchpoint(Bucket *bucket, phpdbg_watchpoint_t *watch) {</span></a>
<a name="357"><span class="lineNum">     357 </span><span class="lineCov">         69 :         phpdbg_set_addr_watchpoint(bucket, sizeof(Bucket), watch);</span></a>
<a name="358"><span class="lineNum">     358 </span><span class="lineCov">         69 :         watch-&gt;type = WATCH_ON_BUCKET;</span></a>
<a name="359"><span class="lineNum">     359 </span><span class="lineCov">         69 : }</span></a>
<a name="360"><span class="lineNum">     360 </span>            : </a>
<a name="361"><span class="lineNum">     361 </span><span class="lineCov">         15 : void phpdbg_set_ht_watchpoint(HashTable *ht, phpdbg_watchpoint_t *watch) {</span></a>
<a name="362"><span class="lineNum">     362 </span><span class="lineCov">         15 :         phpdbg_set_addr_watchpoint(((char *) ht) + HT_WATCH_OFFSET, sizeof(HashTable) - HT_WATCH_OFFSET, watch);</span></a>
<a name="363"><span class="lineNum">     363 </span><span class="lineCov">         15 :         watch-&gt;type = WATCH_ON_HASHTABLE;</span></a>
<a name="364"><span class="lineNum">     364 </span><span class="lineCov">         15 : }</span></a>
<a name="365"><span class="lineNum">     365 </span>            : </a>
<a name="366"><span class="lineNum">     366 </span><span class="lineCov">        207 : void phpdbg_watch_backup_data(phpdbg_watchpoint_t *watch) {</span></a>
<a name="367"><span class="lineNum">     367 </span><span class="lineCov">        207 :         switch (watch-&gt;type) {</span></a>
<a name="368"><span class="lineNum">     368 </span><span class="lineCov">        174 :                 case WATCH_ON_BUCKET:</span></a>
<a name="369"><span class="lineNum">     369 </span>            :                 case WATCH_ON_ZVAL:</a>
<a name="370"><span class="lineNum">     370 </span>            :                 case WATCH_ON_REFCOUNTED:</a>
<a name="371"><span class="lineNum">     371 </span><span class="lineCov">        174 :                         memcpy(&amp;watch-&gt;backup, watch-&gt;addr.ptr, watch-&gt;size);</span></a>
<a name="372"><span class="lineNum">     372 </span><span class="lineCov">        174 :                         break;</span></a>
<a name="373"><span class="lineNum">     373 </span><span class="lineCov">         15 :                 case WATCH_ON_STR:</span></a>
<a name="374"><span class="lineNum">     374 </span><span class="lineCov">         15 :                         if (watch-&gt;backup.str) {</span></a>
<a name="375"><span class="lineNum">     375 </span><span class="lineCov">          6 :                                 zend_string_release(watch-&gt;backup.str);</span></a>
<a name="376"><span class="lineNum">     376 </span>            :                         }</a>
<a name="377"><span class="lineNum">     377 </span><span class="lineCov">         15 :                         watch-&gt;backup.str = zend_string_init((char *) watch-&gt;addr.ptr + XtOffsetOf(zend_string, val) - XtOffsetOf(zend_string, len), *(size_t *) watch-&gt;addr.ptr, 1);</span></a>
<a name="378"><span class="lineNum">     378 </span>            :                         GC_MAKE_PERSISTENT_LOCAL(watch-&gt;backup.str);</a>
<a name="379"><span class="lineNum">     379 </span><span class="lineCov">         15 :                         break;</span></a>
<a name="380"><span class="lineNum">     380 </span><span class="lineCov">         18 :                 case WATCH_ON_HASHTABLE:</span></a>
<a name="381"><span class="lineNum">     381 </span><span class="lineCov">         18 :                         memcpy((char *) &amp;watch-&gt;backup + HT_WATCH_OFFSET, watch-&gt;addr.ptr, watch-&gt;size);</span></a>
<a name="382"><span class="lineNum">     382 </span><span class="lineCov">         18 :                 case WATCH_ON_HASHDATA:</span></a>
<a name="383"><span class="lineNum">     383 </span><span class="lineCov">         18 :                         break;</span></a>
<a name="384"><span class="lineNum">     384 </span>            :         }</a>
<a name="385"><span class="lineNum">     385 </span><span class="lineCov">        207 : }</span></a>
<a name="386"><span class="lineNum">     386 </span>            : </a>
<a name="387"><span class="lineNum">     387 </span>            : /* ### MANAGE WATCH COLLISIONS ### To be used only by watch element manager and memory differ ### */</a>
<a name="388"><span class="lineNum">     388 </span>            : /* watch collisions are responsible for having only one watcher on a given refcounted/refval and having a mapping back to the parent zvals */</a>
<a name="389"><span class="lineNum">     389 </span><span class="lineCov">        150 : void phpdbg_delete_watch_collision(phpdbg_watchpoint_t *watch) {</span></a>
<a name="390"><span class="lineNum">     390 </span>            :         phpdbg_watch_collision *coll;</a>
<a name="391"><span class="lineNum">     391 </span><span class="lineCov">        300 :         if ((coll = zend_hash_index_find_ptr(&amp;PHPDBG_G(watch_collisions), (zend_ulong) watch-&gt;ref))) {</span></a>
<a name="392"><span class="lineNum">     392 </span><span class="lineCov">         72 :                 zend_hash_index_del(&amp;coll-&gt;parents, (zend_ulong) watch);</span></a>
<a name="393"><span class="lineNum">     393 </span><span class="lineCov">         72 :                 if (zend_hash_num_elements(&amp;coll-&gt;parents) == 0) {</span></a>
<a name="394"><span class="lineNum">     394 </span><span class="lineCov">         63 :                         phpdbg_remove_watchpoint_btree(&amp;coll-&gt;ref);</span></a>
<a name="395"><span class="lineNum">     395 </span><span class="lineCov">         63 :                         phpdbg_deactivate_watchpoint(&amp;coll-&gt;ref);</span></a>
<a name="396"><span class="lineNum">     396 </span>            : </a>
<a name="397"><span class="lineNum">     397 </span><span class="lineCov">         63 :                         if (coll-&gt;ref.type == WATCH_ON_ZVAL) {</span></a>
<a name="398"><span class="lineNum">     398 </span><span class="lineCov">         18 :                                 phpdbg_delete_watch_collision(&amp;coll-&gt;ref);</span></a>
<a name="399"><span class="lineNum">     399 </span><span class="lineCov">         45 :                         } else if (coll-&gt;reference.addr.ptr) {</span></a>
<a name="400"><span class="lineNum">     400 </span><span class="lineCov">         18 :                                 phpdbg_remove_watchpoint_btree(&amp;coll-&gt;reference);</span></a>
<a name="401"><span class="lineNum">     401 </span><span class="lineCov">         18 :                                 phpdbg_deactivate_watchpoint(&amp;coll-&gt;reference);</span></a>
<a name="402"><span class="lineNum">     402 </span><span class="lineCov">         18 :                                 phpdbg_delete_watch_collision(&amp;coll-&gt;reference);</span></a>
<a name="403"><span class="lineNum">     403 </span><span class="lineCov">         18 :                                 if (coll-&gt;reference.type == WATCH_ON_STR) {</span></a>
<a name="404"><span class="lineNum">     404 </span><span class="lineCov">          9 :                                         zend_string_release(coll-&gt;reference.backup.str);</span></a>
<a name="405"><span class="lineNum">     405 </span>            :                                 }</a>
<a name="406"><span class="lineNum">     406 </span>            :                         }</a>
<a name="407"><span class="lineNum">     407 </span>            : </a>
<a name="408"><span class="lineNum">     408 </span><span class="lineCov">         63 :                         zend_hash_index_del(&amp;PHPDBG_G(watch_collisions), (zend_ulong) watch-&gt;ref);</span></a>
<a name="409"><span class="lineNum">     409 </span><span class="lineCov">         63 :                         zend_hash_destroy(&amp;coll-&gt;parents);</span></a>
<a name="410"><span class="lineNum">     410 </span><span class="lineCov">         63 :                         efree(coll);</span></a>
<a name="411"><span class="lineNum">     411 </span>            :                 }</a>
<a name="412"><span class="lineNum">     412 </span>            :         }</a>
<a name="413"><span class="lineNum">     413 </span><span class="lineCov">        150 : }</span></a>
<a name="414"><span class="lineNum">     414 </span>            : </a>
<a name="415"><span class="lineNum">     415 </span><span class="lineCov">        123 : void phpdbg_update_watch_ref(phpdbg_watchpoint_t *watch) {</span></a>
<a name="416"><span class="lineNum">     416 </span>            :         phpdbg_watch_collision *coll;</a>
<a name="417"><span class="lineNum">     417 </span>            : </a>
<a name="418"><span class="lineNum">     418 </span><span class="lineCov">        123 :         ZEND_ASSERT(watch-&gt;type == WATCH_ON_ZVAL || watch-&gt;type == WATCH_ON_BUCKET);</span></a>
<a name="419"><span class="lineNum">     419 </span><span class="lineCov">        123 :         if (Z_REFCOUNTED_P(watch-&gt;addr.zv)) {</span></a>
<a name="420"><span class="lineNum">     420 </span><span class="lineCov">         54 :                 if (Z_COUNTED_P(watch-&gt;addr.zv) == watch-&gt;ref) {</span></a>
<a name="421"><span class="lineNum">     421 </span><span class="lineNoCov">          0 :                         return;</span></a>
<a name="422"><span class="lineNum">     422 </span>            :                 }</a>
<a name="423"><span class="lineNum">     423 </span>            : </a>
<a name="424"><span class="lineNum">     424 </span><span class="lineCov">         54 :                 if (watch-&gt;ref != NULL) {</span></a>
<a name="425"><span class="lineNum">     425 </span><span class="lineCov">          6 :                         phpdbg_delete_watch_collision(watch);</span></a>
<a name="426"><span class="lineNum">     426 </span>            :                 }</a>
<a name="427"><span class="lineNum">     427 </span>            : </a>
<a name="428"><span class="lineNum">     428 </span><span class="lineCov">         54 :                 watch-&gt;ref = Z_COUNTED_P(watch-&gt;addr.zv);</span></a>
<a name="429"><span class="lineNum">     429 </span>            : </a>
<a name="430"><span class="lineNum">     430 </span><span class="lineCov">        108 :                 if (!(coll = zend_hash_index_find_ptr(&amp;PHPDBG_G(watch_collisions), (zend_ulong) watch-&gt;ref))) {</span></a>
<a name="431"><span class="lineNum">     431 </span><span class="lineCov">         45 :                         coll = emalloc(sizeof(*coll));</span></a>
<a name="432"><span class="lineNum">     432 </span><span class="lineCov">         45 :                         coll-&gt;ref.type = WATCH_ON_REFCOUNTED;</span></a>
<a name="433"><span class="lineNum">     433 </span><span class="lineCov">         45 :                         phpdbg_set_addr_watchpoint(Z_COUNTED_P(watch-&gt;addr.zv), sizeof(uint32_t), &amp;coll-&gt;ref);</span></a>
<a name="434"><span class="lineNum">     434 </span><span class="lineCov">         45 :                         coll-&gt;ref.coll = coll;</span></a>
<a name="435"><span class="lineNum">     435 </span><span class="lineCov">         45 :                         phpdbg_store_watchpoint_btree(&amp;coll-&gt;ref);</span></a>
<a name="436"><span class="lineNum">     436 </span><span class="lineCov">         45 :                         phpdbg_activate_watchpoint(&amp;coll-&gt;ref);</span></a>
<a name="437"><span class="lineNum">     437 </span><span class="lineCov">         45 :                         phpdbg_watch_backup_data(&amp;coll-&gt;ref);</span></a>
<a name="438"><span class="lineNum">     438 </span>            : </a>
<a name="439"><span class="lineNum">     439 </span><span class="lineCov">         90 :                         if (Z_ISREF_P(watch-&gt;addr.zv)) {</span></a>
<a name="440"><span class="lineNum">     440 </span><span class="lineCov">          9 :                                 phpdbg_set_zval_watchpoint(Z_REFVAL_P(watch-&gt;addr.zv), &amp;coll-&gt;reference);</span></a>
<a name="441"><span class="lineNum">     441 </span><span class="lineCov">          9 :                                 coll-&gt;reference.coll = coll;</span></a>
<a name="442"><span class="lineNum">     442 </span><span class="lineCov">          9 :                                 phpdbg_update_watch_ref(&amp;coll-&gt;reference);</span></a>
<a name="443"><span class="lineNum">     443 </span><span class="lineCov">          9 :                                 phpdbg_store_watchpoint_btree(&amp;coll-&gt;reference);</span></a>
<a name="444"><span class="lineNum">     444 </span><span class="lineCov">          9 :                                 phpdbg_activate_watchpoint(&amp;coll-&gt;reference);</span></a>
<a name="445"><span class="lineNum">     445 </span><span class="lineCov">          9 :                                 phpdbg_watch_backup_data(&amp;coll-&gt;reference);</span></a>
<a name="446"><span class="lineNum">     446 </span><span class="lineCov">         72 :                         } else if (Z_TYPE_P(watch-&gt;addr.zv) == IS_STRING) {</span></a>
<a name="447"><span class="lineNum">     447 </span><span class="lineCov">          9 :                                 coll-&gt;reference.type = WATCH_ON_STR;</span></a>
<a name="448"><span class="lineNum">     448 </span><span class="lineCov">          9 :                                 phpdbg_set_addr_watchpoint(&amp;Z_STRLEN_P(watch-&gt;addr.zv), XtOffsetOf(zend_string, val) - XtOffsetOf(zend_string, len) + Z_STRLEN_P(watch-&gt;addr.zv) + 1, &amp;coll-&gt;reference);</span></a>
<a name="449"><span class="lineNum">     449 </span><span class="lineCov">          9 :                                 coll-&gt;reference.coll = coll;</span></a>
<a name="450"><span class="lineNum">     450 </span><span class="lineCov">          9 :                                 phpdbg_store_watchpoint_btree(&amp;coll-&gt;reference);</span></a>
<a name="451"><span class="lineNum">     451 </span><span class="lineCov">          9 :                                 phpdbg_activate_watchpoint(&amp;coll-&gt;reference);</span></a>
<a name="452"><span class="lineNum">     452 </span><span class="lineCov">          9 :                                 coll-&gt;reference.backup.str = NULL;</span></a>
<a name="453"><span class="lineNum">     453 </span><span class="lineCov">          9 :                                 phpdbg_watch_backup_data(&amp;coll-&gt;reference);</span></a>
<a name="454"><span class="lineNum">     454 </span>            :                         } else {</a>
<a name="455"><span class="lineNum">     455 </span><span class="lineCov">         27 :                                 coll-&gt;reference.addr.ptr = NULL;</span></a>
<a name="456"><span class="lineNum">     456 </span>            :                         }</a>
<a name="457"><span class="lineNum">     457 </span>            : </a>
<a name="458"><span class="lineNum">     458 </span><span class="lineCov">         45 :                         zend_hash_init(&amp;coll-&gt;parents, 8, shitty stupid parameter, NULL, 0);</span></a>
<a name="459"><span class="lineNum">     459 </span><span class="lineCov">         45 :                         zend_hash_index_add_ptr(&amp;PHPDBG_G(watch_collisions), (zend_ulong) watch-&gt;ref, coll);</span></a>
<a name="460"><span class="lineNum">     460 </span>            :                 }</a>
<a name="461"><span class="lineNum">     461 </span><span class="lineCov">         54 :                 zend_hash_index_add_ptr(&amp;coll-&gt;parents, (zend_long) watch, watch);</span></a>
<a name="462"><span class="lineNum">     462 </span><span class="lineCov">        138 :         } else if (Z_TYPE_P(watch-&gt;addr.zv) == IS_INDIRECT) {</span></a>
<a name="463"><span class="lineNum">     463 </span><span class="lineCov">         18 :                 if ((zend_refcounted *) Z_INDIRECT_P(watch-&gt;addr.zv) == watch-&gt;ref) {</span></a>
<a name="464"><span class="lineNum">     464 </span><span class="lineNoCov">          0 :                         return;</span></a>
<a name="465"><span class="lineNum">     465 </span>            :                 }</a>
<a name="466"><span class="lineNum">     466 </span>            : </a>
<a name="467"><span class="lineNum">     467 </span><span class="lineCov">         18 :                 if (watch-&gt;ref != NULL) {</span></a>
<a name="468"><span class="lineNum">     468 </span><span class="lineCov">          9 :                         phpdbg_delete_watch_collision(watch);</span></a>
<a name="469"><span class="lineNum">     469 </span>            :                 }</a>
<a name="470"><span class="lineNum">     470 </span>            : </a>
<a name="471"><span class="lineNum">     471 </span><span class="lineCov">         18 :                 watch-&gt;ref = (zend_refcounted *) Z_INDIRECT_P(watch-&gt;addr.zv);</span></a>
<a name="472"><span class="lineNum">     472 </span>            : </a>
<a name="473"><span class="lineNum">     473 </span><span class="lineCov">         36 :                 if (!(coll = zend_hash_index_find_ptr(&amp;PHPDBG_G(watch_collisions), (zend_ulong) watch-&gt;ref))) {</span></a>
<a name="474"><span class="lineNum">     474 </span><span class="lineCov">         18 :                         coll = emalloc(sizeof(*coll));</span></a>
<a name="475"><span class="lineNum">     475 </span><span class="lineCov">         18 :                         phpdbg_set_zval_watchpoint(Z_INDIRECT_P(watch-&gt;addr.zv), &amp;coll-&gt;ref);</span></a>
<a name="476"><span class="lineNum">     476 </span><span class="lineCov">         18 :                         coll-&gt;ref.coll = coll;</span></a>
<a name="477"><span class="lineNum">     477 </span><span class="lineCov">         18 :                         phpdbg_update_watch_ref(&amp;coll-&gt;ref);</span></a>
<a name="478"><span class="lineNum">     478 </span><span class="lineCov">         18 :                         phpdbg_store_watchpoint_btree(&amp;coll-&gt;ref);</span></a>
<a name="479"><span class="lineNum">     479 </span><span class="lineCov">         18 :                         phpdbg_activate_watchpoint(&amp;coll-&gt;ref);</span></a>
<a name="480"><span class="lineNum">     480 </span><span class="lineCov">         18 :                         phpdbg_watch_backup_data(&amp;coll-&gt;ref);</span></a>
<a name="481"><span class="lineNum">     481 </span>            : </a>
<a name="482"><span class="lineNum">     482 </span><span class="lineCov">         18 :                         zend_hash_init(&amp;coll-&gt;parents, 8, shitty stupid parameter, NULL, 0);</span></a>
<a name="483"><span class="lineNum">     483 </span><span class="lineCov">         18 :                         zend_hash_index_add_ptr(&amp;PHPDBG_G(watch_collisions), (zend_ulong) watch-&gt;ref, coll);</span></a>
<a name="484"><span class="lineNum">     484 </span>            :                 }</a>
<a name="485"><span class="lineNum">     485 </span><span class="lineCov">         18 :                 zend_hash_index_add_ptr(&amp;coll-&gt;parents, (zend_long) watch, watch);</span></a>
<a name="486"><span class="lineNum">     486 </span><span class="lineCov">         51 :         } else if (watch-&gt;ref) {</span></a>
<a name="487"><span class="lineNum">     487 </span><span class="lineNoCov">          0 :                 phpdbg_delete_watch_collision(watch);</span></a>
<a name="488"><span class="lineNum">     488 </span><span class="lineNoCov">          0 :                 watch-&gt;ref = NULL;</span></a>
<a name="489"><span class="lineNum">     489 </span>            :         }</a>
<a name="490"><span class="lineNum">     490 </span>            : }</a>
<a name="491"><span class="lineNum">     491 </span>            : </a>
<a name="492"><span class="lineNum">     492 </span>            : /* ### MANAGE WATCH ELEMENTS ### */</a>
<a name="493"><span class="lineNum">     493 </span>            : /* watchpoints must be unique per element. Only one watchpoint may point to one element. But many elements may point to one watchpoint. */</a>
<a name="494"><span class="lineNum">     494 </span>            : void phpdbg_recurse_watch_element(phpdbg_watch_element *element);</a>
<a name="495"><span class="lineNum">     495 </span>            : void phpdbg_remove_watch_element_recursively(phpdbg_watch_element *element);</a>
<a name="496"><span class="lineNum">     496 </span>            : void phpdbg_free_watch_element(phpdbg_watch_element *element);</a>
<a name="497"><span class="lineNum">     497 </span>            : void phpdbg_remove_watchpoint(phpdbg_watchpoint_t *watch);</a>
<a name="498"><span class="lineNum">     498 </span>            : void phpdbg_watch_parent_ht(phpdbg_watch_element *element);</a>
<a name="499"><span class="lineNum">     499 </span>            : </a>
<a name="500"><span class="lineNum">     500 </span><span class="lineCov">         84 : phpdbg_watch_element *phpdbg_add_watch_element(phpdbg_watchpoint_t *watch, phpdbg_watch_element *element) {</span></a>
<a name="501"><span class="lineNum">     501 </span>            :         phpdbg_btree_result *res;</a>
<a name="502"><span class="lineNum">     502 </span><span class="lineCov">         84 :         if ((res = phpdbg_btree_find(&amp;PHPDBG_G(watchpoint_tree), (zend_ulong) watch-&gt;addr.ptr)) == NULL) {</span></a>
<a name="503"><span class="lineNum">     503 </span><span class="lineCov">         75 :                 phpdbg_watchpoint_t *mem = emalloc(sizeof(*mem));</span></a>
<a name="504"><span class="lineNum">     504 </span><span class="lineCov">         75 :                 *mem = *watch;</span></a>
<a name="505"><span class="lineNum">     505 </span><span class="lineCov">         75 :                 watch = mem;</span></a>
<a name="506"><span class="lineNum">     506 </span><span class="lineCov">         75 :                 phpdbg_store_watchpoint_btree(watch);</span></a>
<a name="507"><span class="lineNum">     507 </span><span class="lineCov">         75 :                 if (watch-&gt;type == WATCH_ON_ZVAL || watch-&gt;type == WATCH_ON_BUCKET) {</span></a>
<a name="508"><span class="lineNum">     508 </span><span class="lineCov">         60 :                         phpdbg_update_watch_ref(watch);</span></a>
<a name="509"><span class="lineNum">     509 </span>            :                 }</a>
<a name="510"><span class="lineNum">     510 </span><span class="lineCov">         75 :                 phpdbg_activate_watchpoint(watch);</span></a>
<a name="511"><span class="lineNum">     511 </span><span class="lineCov">         75 :                 phpdbg_watch_backup_data(watch);</span></a>
<a name="512"><span class="lineNum">     512 </span>            :         } else {</a>
<a name="513"><span class="lineNum">     513 </span>            :                 phpdbg_watch_element *old_element;</a>
<a name="514"><span class="lineNum">     514 </span><span class="lineCov">          9 :                 watch = res-&gt;ptr;</span></a>
<a name="515"><span class="lineNum">     515 </span><span class="lineCov">         18 :                 if ((old_element = zend_hash_find_ptr(&amp;watch-&gt;elements, element-&gt;str))) {</span></a>
<a name="516"><span class="lineNum">     516 </span><span class="lineNoCov">          0 :                         phpdbg_free_watch_element(element);</span></a>
<a name="517"><span class="lineNum">     517 </span><span class="lineNoCov">          0 :                         return old_element;</span></a>
<a name="518"><span class="lineNum">     518 </span>            :                 }</a>
<a name="519"><span class="lineNum">     519 </span>            :         }</a>
<a name="520"><span class="lineNum">     520 </span>            : </a>
<a name="521"><span class="lineNum">     521 </span><span class="lineCov">         84 :         element-&gt;watch = watch;</span></a>
<a name="522"><span class="lineNum">     522 </span><span class="lineCov">         84 :         zend_hash_add_ptr(&amp;watch-&gt;elements, element-&gt;str, element);</span></a>
<a name="523"><span class="lineNum">     523 </span>            : </a>
<a name="524"><span class="lineNum">     524 </span><span class="lineCov">         84 :         if (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE) {</span></a>
<a name="525"><span class="lineNum">     525 </span><span class="lineCov">         36 :                 phpdbg_recurse_watch_element(element);</span></a>
<a name="526"><span class="lineNum">     526 </span>            :         }</a>
<a name="527"><span class="lineNum">     527 </span>            : </a>
<a name="528"><span class="lineNum">     528 </span><span class="lineCov">         84 :         return element;</span></a>
<a name="529"><span class="lineNum">     529 </span>            : }</a>
<a name="530"><span class="lineNum">     530 </span>            : </a>
<a name="531"><span class="lineNum">     531 </span><span class="lineCov">         69 : phpdbg_watch_element *phpdbg_add_bucket_watch_element(Bucket *bucket, phpdbg_watch_element *element) {</span></a>
<a name="532"><span class="lineNum">     532 </span>            :         phpdbg_watchpoint_t watch;</a>
<a name="533"><span class="lineNum">     533 </span><span class="lineCov">         69 :         phpdbg_set_bucket_watchpoint(bucket, &amp;watch);</span></a>
<a name="534"><span class="lineNum">     534 </span><span class="lineCov">         69 :         element = phpdbg_add_watch_element(&amp;watch, element);</span></a>
<a name="535"><span class="lineNum">     535 </span><span class="lineCov">         69 :         phpdbg_watch_parent_ht(element);</span></a>
<a name="536"><span class="lineNum">     536 </span><span class="lineCov">         69 :         return element;</span></a>
<a name="537"><span class="lineNum">     537 </span>            : }</a>
<a name="538"><span class="lineNum">     538 </span>            : </a>
<a name="539"><span class="lineNum">     539 </span><span class="lineCov">         15 : phpdbg_watch_element *phpdbg_add_ht_watch_element(zval *zv, phpdbg_watch_element *element) {</span></a>
<a name="540"><span class="lineNum">     540 </span>            :         phpdbg_watchpoint_t watch;</a>
<a name="541"><span class="lineNum">     541 </span><span class="lineCov">         30 :         HashTable *ht = HT_FROM_ZVP(zv);</span></a>
<a name="542"><span class="lineNum">     542 </span>            : </a>
<a name="543"><span class="lineNum">     543 </span><span class="lineCov">         15 :         if (!ht) {</span></a>
<a name="544"><span class="lineNum">     544 </span><span class="lineNoCov">          0 :                 return NULL;</span></a>
<a name="545"><span class="lineNum">     545 </span>            :         }</a>
<a name="546"><span class="lineNum">     546 </span>            : </a>
<a name="547"><span class="lineNum">     547 </span><span class="lineCov">         15 :         element-&gt;flags |= Z_TYPE_P(zv) == IS_ARRAY ? PHPDBG_WATCH_ARRAY : PHPDBG_WATCH_OBJECT;</span></a>
<a name="548"><span class="lineNum">     548 </span><span class="lineCov">         15 :         phpdbg_set_ht_watchpoint(ht, &amp;watch);</span></a>
<a name="549"><span class="lineNum">     549 </span><span class="lineCov">         15 :         return phpdbg_add_watch_element(&amp;watch, element);</span></a>
<a name="550"><span class="lineNum">     550 </span>            : }</a>
<a name="551"><span class="lineNum">     551 </span>            : </a>
<a name="552"><span class="lineNum">     552 </span><span class="lineCov">         24 : bool phpdbg_is_recursively_watched(void *ptr, phpdbg_watch_element *element) {</span></a>
<a name="553"><span class="lineNum">     553 </span><span class="lineCov">         24 :         phpdbg_watch_element *next = element;</span></a>
<a name="554"><span class="lineNum">     554 </span>            :         do {</a>
<a name="555"><span class="lineNum">     555 </span><span class="lineCov">         39 :                 element = next;</span></a>
<a name="556"><span class="lineNum">     556 </span><span class="lineCov">         39 :                 if (element-&gt;watch-&gt;addr.ptr == ptr) {</span></a>
<a name="557"><span class="lineNum">     557 </span><span class="lineNoCov">          0 :                         return 1;</span></a>
<a name="558"><span class="lineNum">     558 </span>            :                 }</a>
<a name="559"><span class="lineNum">     559 </span><span class="lineCov">         39 :                 next = element-&gt;parent;</span></a>
<a name="560"><span class="lineNum">     560 </span><span class="lineCov">         39 :         } while (!(element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT));</span></a>
<a name="561"><span class="lineNum">     561 </span>            : </a>
<a name="562"><span class="lineNum">     562 </span><span class="lineCov">         24 :         return 0;</span></a>
<a name="563"><span class="lineNum">     563 </span>            : }</a>
<a name="564"><span class="lineNum">     564 </span>            : </a>
<a name="565"><span class="lineNum">     565 </span><span class="lineCov">         15 : void phpdbg_add_recursive_watch_from_ht(phpdbg_watch_element *element, zend_long idx, zend_string *str, zval *zv) {</span></a>
<a name="566"><span class="lineNum">     566 </span>            :         phpdbg_watch_element *child;</a>
<a name="567"><span class="lineNum">     567 </span><span class="lineCov">         15 :         if (phpdbg_is_recursively_watched(zv, element)) {</span></a>
<a name="568"><span class="lineNum">     568 </span><span class="lineNoCov">          0 :                 return;</span></a>
<a name="569"><span class="lineNum">     569 </span>            :         }</a>
<a name="570"><span class="lineNum">     570 </span>            : </a>
<a name="571"><span class="lineNum">     571 </span><span class="lineCov">         15 :         child = emalloc(sizeof(*child));</span></a>
<a name="572"><span class="lineNum">     572 </span><span class="lineCov">         15 :         child-&gt;flags = PHPDBG_WATCH_RECURSIVE;</span></a>
<a name="573"><span class="lineNum">     573 </span><span class="lineCov">         15 :         if (str) {</span></a>
<a name="574"><span class="lineNum">     574 </span><span class="lineCov">          3 :                 child-&gt;str = strpprintf(0, (element-&gt;flags &amp; PHPDBG_WATCH_ARRAY) ? &quot;%.*s[%s]&quot; : &quot;%.*s-&gt;%s&quot;, (int) ZSTR_LEN(element-&gt;str) - 2, ZSTR_VAL(element-&gt;str), phpdbg_get_property_key(ZSTR_VAL(str)));</span></a>
<a name="575"><span class="lineNum">     575 </span>            :         } else {</a>
<a name="576"><span class="lineNum">     576 </span><span class="lineCov">         12 :                 child-&gt;str = strpprintf(0, (element-&gt;flags &amp; PHPDBG_WATCH_ARRAY) ? &quot;%.*s[&quot; ZEND_LONG_FMT &quot;]&quot; : &quot;%.*s-&gt;&quot; ZEND_LONG_FMT, (int) ZSTR_LEN(element-&gt;str) - 2, ZSTR_VAL(element-&gt;str), idx);</span></a>
<a name="577"><span class="lineNum">     577 </span>            :         }</a>
<a name="578"><span class="lineNum">     578 </span><span class="lineCov">         15 :         if (!str) {</span></a>
<a name="579"><span class="lineNum">     579 </span><span class="lineCov">         12 :                 str = zend_long_to_str(idx); // TODO: hack, use proper int handling for name in parent</span></a>
<a name="580"><span class="lineNum">     580 </span><span class="lineCov">          3 :         } else { str = zend_string_copy(str); }</span></a>
<a name="581"><span class="lineNum">     581 </span><span class="lineCov">         15 :         child-&gt;name_in_parent = str;</span></a>
<a name="582"><span class="lineNum">     582 </span><span class="lineCov">         15 :         child-&gt;parent = element;</span></a>
<a name="583"><span class="lineNum">     583 </span><span class="lineCov">         15 :         child-&gt;child = NULL;</span></a>
<a name="584"><span class="lineNum">     584 </span><span class="lineCov">         15 :         child-&gt;parent_container = HT_WATCH_HT(element-&gt;watch);</span></a>
<a name="585"><span class="lineNum">     585 </span><span class="lineCov">         15 :         zend_hash_add_ptr(&amp;element-&gt;child_container, child-&gt;str, child);</span></a>
<a name="586"><span class="lineNum">     586 </span><span class="lineCov">         15 :         phpdbg_add_bucket_watch_element((Bucket *) zv, child);</span></a>
<a name="587"><span class="lineNum">     587 </span>            : }</a>
<a name="588"><span class="lineNum">     588 </span>            : </a>
<a name="589"><span class="lineNum">     589 </span><span class="lineCov">         54 : void phpdbg_recurse_watch_element(phpdbg_watch_element *element) {</span></a>
<a name="590"><span class="lineNum">     590 </span>            :         phpdbg_watch_element *child;</a>
<a name="591"><span class="lineNum">     591 </span>            :         zval *zv;</a>
<a name="592"><span class="lineNum">     592 </span>            : </a>
<a name="593"><span class="lineNum">     593 </span><span class="lineCov">         54 :         if (element-&gt;watch-&gt;type == WATCH_ON_ZVAL || element-&gt;watch-&gt;type == WATCH_ON_BUCKET) {</span></a>
<a name="594"><span class="lineNum">     594 </span><span class="lineCov">         45 :                 zv = element-&gt;watch-&gt;addr.zv;</span></a>
<a name="595"><span class="lineNum">     595 </span><span class="lineCov">         99 :                 while (Z_TYPE_P(zv) == IS_INDIRECT) {</span></a>
<a name="596"><span class="lineNum">     596 </span><span class="lineCov">          9 :                         zv = Z_INDIRECT_P(zv);</span></a>
<a name="597"><span class="lineNum">     597 </span>            :                 }</a>
<a name="598"><span class="lineNum">     598 </span><span class="lineCov">         45 :                 ZVAL_DEREF(zv);</span></a>
<a name="599"><span class="lineNum">     599 </span>            : </a>
<a name="600"><span class="lineNum">     600 </span><span class="lineCov">         45 :                 if (element-&gt;child) {</span></a>
<a name="601"><span class="lineNum">     601 </span><span class="lineCov">          3 :                         phpdbg_remove_watch_element_recursively(element-&gt;child);</span></a>
<a name="602"><span class="lineNum">     602 </span>            :                 }</a>
<a name="603"><span class="lineNum">     603 </span>            : </a>
<a name="604"><span class="lineNum">     604 </span><span class="lineCov">         81 :                 if ((Z_TYPE_P(zv) != IS_ARRAY &amp;&amp; Z_TYPE_P(zv) != IS_OBJECT)</span></a>
<a name="605"><span class="lineNum">     605 </span><span class="lineCov">         18 :                     || phpdbg_is_recursively_watched(HT_WATCH_OFFSET + (char *) HT_FROM_ZVP(zv), element)) {</span></a>
<a name="606"><span class="lineNum">     606 </span><span class="lineCov">         36 :                         if (element-&gt;child) {</span></a>
<a name="607"><span class="lineNum">     607 </span><span class="lineNoCov">          0 :                                 phpdbg_free_watch_element(element-&gt;child);</span></a>
<a name="608"><span class="lineNum">     608 </span><span class="lineNoCov">          0 :                                 element-&gt;child = NULL;</span></a>
<a name="609"><span class="lineNum">     609 </span>            :                         }</a>
<a name="610"><span class="lineNum">     610 </span><span class="lineCov">         36 :                         return;</span></a>
<a name="611"><span class="lineNum">     611 </span>            :                 }</a>
<a name="612"><span class="lineNum">     612 </span>            : </a>
<a name="613"><span class="lineNum">     613 </span><span class="lineCov">          9 :                 if (element-&gt;child) {</span></a>
<a name="614"><span class="lineNum">     614 </span><span class="lineCov">          3 :                         child = element-&gt;child;</span></a>
<a name="615"><span class="lineNum">     615 </span>            :                 } else {</a>
<a name="616"><span class="lineNum">     616 </span><span class="lineCov">          6 :                         child = emalloc(sizeof(*child));</span></a>
<a name="617"><span class="lineNum">     617 </span><span class="lineCov">          6 :                         child-&gt;flags = PHPDBG_WATCH_RECURSIVE;</span></a>
<a name="618"><span class="lineNum">     618 </span><span class="lineCov">          6 :                         child-&gt;str = strpprintf(0, &quot;%.*s[]&quot;, (int) ZSTR_LEN(element-&gt;str), ZSTR_VAL(element-&gt;str));</span></a>
<a name="619"><span class="lineNum">     619 </span><span class="lineCov">          6 :                         child-&gt;name_in_parent = NULL;</span></a>
<a name="620"><span class="lineNum">     620 </span><span class="lineCov">          6 :                         child-&gt;parent = element;</span></a>
<a name="621"><span class="lineNum">     621 </span><span class="lineCov">          6 :                         child-&gt;child = NULL;</span></a>
<a name="622"><span class="lineNum">     622 </span><span class="lineCov">          6 :                         element-&gt;child = child;</span></a>
<a name="623"><span class="lineNum">     623 </span>            :                 }</a>
<a name="624"><span class="lineNum">     624 </span><span class="lineCov">          9 :                 zend_hash_init(&amp;child-&gt;child_container, 8, NULL, NULL, 0);</span></a>
<a name="625"><span class="lineNum">     625 </span><span class="lineCov">          9 :                 phpdbg_add_ht_watch_element(zv, child);</span></a>
<a name="626"><span class="lineNum">     626 </span><span class="lineCov">          9 :         } else if (zend_hash_num_elements(&amp;element-&gt;child_container) == 0) {</span></a>
<a name="627"><span class="lineNum">     627 </span>            :                 zend_string *str;</a>
<a name="628"><span class="lineNum">     628 </span>            :                 zend_long idx;</a>
<a name="629"><span class="lineNum">     629 </span>            : </a>
<a name="630"><span class="lineNum">     630 </span><span class="lineCov">          9 :                 ZEND_ASSERT(element-&gt;watch-&gt;type == WATCH_ON_HASHTABLE);</span></a>
<a name="631"><span class="lineNum">     631 </span><span class="lineCov">         33 :                 ZEND_HASH_FOREACH_KEY_VAL(HT_WATCH_HT(element-&gt;watch), idx, str, zv) {</span></a>
<a name="632"><span class="lineNum">     632 </span><span class="lineCov">         12 :                         phpdbg_add_recursive_watch_from_ht(element, idx, str, zv);</span></a>
<a name="633"><span class="lineNum">     633 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="634"><span class="lineNum">     634 </span>            :         }</a>
<a name="635"><span class="lineNum">     635 </span>            : }</a>
<a name="636"><span class="lineNum">     636 </span>            : </a>
<a name="637"><span class="lineNum">     637 </span><span class="lineCov">         87 : void phpdbg_watch_parent_ht(phpdbg_watch_element *element) {</span></a>
<a name="638"><span class="lineNum">     638 </span><span class="lineCov">         87 :         if (element-&gt;watch-&gt;type == WATCH_ON_BUCKET) {</span></a>
<a name="639"><span class="lineNum">     639 </span>            :                 phpdbg_btree_result *res;</a>
<a name="640"><span class="lineNum">     640 </span>            :                 HashPosition pos;</a>
<a name="641"><span class="lineNum">     641 </span>            :                 phpdbg_watch_ht_info *hti;</a>
<a name="642"><span class="lineNum">     642 </span><span class="lineCov">         87 :                 ZEND_ASSERT(element-&gt;parent_container);</span></a>
<a name="643"><span class="lineNum">     643 </span><span class="lineCov">         87 :                 if (!(res = phpdbg_btree_find(&amp;PHPDBG_G(watch_HashTables), (zend_ulong) element-&gt;parent_container))) {</span></a>
<a name="644"><span class="lineNum">     644 </span><span class="lineCov">         54 :                         hti = emalloc(sizeof(*hti));</span></a>
<a name="645"><span class="lineNum">     645 </span><span class="lineCov">         54 :                         hti-&gt;ht = element-&gt;parent_container;</span></a>
<a name="646"><span class="lineNum">     646 </span>            : </a>
<a name="647"><span class="lineNum">     647 </span><span class="lineCov">         54 :                         zend_hash_init(&amp;hti-&gt;watches, 0, grrrrr, ZVAL_PTR_DTOR, 0);</span></a>
<a name="648"><span class="lineNum">     648 </span><span class="lineCov">         54 :                         phpdbg_btree_insert(&amp;PHPDBG_G(watch_HashTables), (zend_ulong) hti-&gt;ht, hti);</span></a>
<a name="649"><span class="lineNum">     649 </span>            : </a>
<a name="650"><span class="lineNum">     650 </span><span class="lineCov">         54 :                         phpdbg_set_addr_watchpoint(HT_GET_DATA_ADDR(hti-&gt;ht), HT_HASH_SIZE(hti-&gt;ht-&gt;nTableMask), &amp;hti-&gt;hash_watch);</span></a>
<a name="651"><span class="lineNum">     651 </span><span class="lineCov">         54 :                         hti-&gt;hash_watch.type = WATCH_ON_HASHDATA;</span></a>
<a name="652"><span class="lineNum">     652 </span><span class="lineCov">         54 :                         phpdbg_store_watchpoint_btree(&amp;hti-&gt;hash_watch);</span></a>
<a name="653"><span class="lineNum">     653 </span><span class="lineCov">         54 :                         phpdbg_activate_watchpoint(&amp;hti-&gt;hash_watch);</span></a>
<a name="654"><span class="lineNum">     654 </span>            :                 } else {</a>
<a name="655"><span class="lineNum">     655 </span><span class="lineCov">         33 :                         hti = (phpdbg_watch_ht_info *) res-&gt;ptr;</span></a>
<a name="656"><span class="lineNum">     656 </span>            :                 }</a>
<a name="657"><span class="lineNum">     657 </span>            : </a>
<a name="658"><span class="lineNum">     658 </span><span class="lineCov">         87 :                 zend_hash_internal_pointer_end_ex(hti-&gt;ht, &amp;pos);</span></a>
<a name="659"><span class="lineNum">     659 </span><span class="lineCov">         87 :                 hti-&gt;last = hti-&gt;ht-&gt;arData + pos;</span></a>
<a name="660"><span class="lineNum">     660 </span><span class="lineCov">         87 :                 hti-&gt;last_str = hti-&gt;last-&gt;key;</span></a>
<a name="661"><span class="lineNum">     661 </span><span class="lineCov">         87 :                 hti-&gt;last_idx = hti-&gt;last-&gt;h;</span></a>
<a name="662"><span class="lineNum">     662 </span>            : </a>
<a name="663"><span class="lineNum">     663 </span><span class="lineCov">         87 :                 zend_hash_add_ptr(&amp;hti-&gt;watches, element-&gt;name_in_parent, element);</span></a>
<a name="664"><span class="lineNum">     664 </span>            :         }</a>
<a name="665"><span class="lineNum">     665 </span><span class="lineCov">         87 : }</span></a>
<a name="666"><span class="lineNum">     666 </span>            : </a>
<a name="667"><span class="lineNum">     667 </span><span class="lineCov">         90 : void phpdbg_unwatch_parent_ht(phpdbg_watch_element *element) {</span></a>
<a name="668"><span class="lineNum">     668 </span><span class="lineCov">         90 :         if (element-&gt;watch-&gt;type == WATCH_ON_BUCKET) {</span></a>
<a name="669"><span class="lineNum">     669 </span><span class="lineCov">         75 :                 phpdbg_btree_result *res = phpdbg_btree_find(&amp;PHPDBG_G(watch_HashTables), (zend_ulong) element-&gt;parent_container);</span></a>
<a name="670"><span class="lineNum">     670 </span><span class="lineCov">         75 :                 ZEND_ASSERT(element-&gt;parent_container);</span></a>
<a name="671"><span class="lineNum">     671 </span><span class="lineCov">         75 :                 if (res) {</span></a>
<a name="672"><span class="lineNum">     672 </span><span class="lineCov">         66 :                         phpdbg_watch_ht_info *hti = res-&gt;ptr;</span></a>
<a name="673"><span class="lineNum">     673 </span>            : </a>
<a name="674"><span class="lineNum">     674 </span><span class="lineCov">         66 :                         if (zend_hash_num_elements(&amp;hti-&gt;watches) == 1) {</span></a>
<a name="675"><span class="lineNum">     675 </span><span class="lineCov">         54 :                                 zend_hash_destroy(&amp;hti-&gt;watches);</span></a>
<a name="676"><span class="lineNum">     676 </span><span class="lineCov">         54 :                                 phpdbg_btree_delete(&amp;PHPDBG_G(watch_HashTables), (zend_ulong) hti-&gt;ht);</span></a>
<a name="677"><span class="lineNum">     677 </span><span class="lineCov">         54 :                                 phpdbg_remove_watchpoint_btree(&amp;hti-&gt;hash_watch);</span></a>
<a name="678"><span class="lineNum">     678 </span><span class="lineCov">         54 :                                 phpdbg_deactivate_watchpoint(&amp;hti-&gt;hash_watch);</span></a>
<a name="679"><span class="lineNum">     679 </span><span class="lineCov">         54 :                                 efree(hti);</span></a>
<a name="680"><span class="lineNum">     680 </span>            :                         } else {</a>
<a name="681"><span class="lineNum">     681 </span><span class="lineCov">         12 :                                 zend_hash_del(&amp;hti-&gt;watches, element-&gt;name_in_parent);</span></a>
<a name="682"><span class="lineNum">     682 </span>            :                         }</a>
<a name="683"><span class="lineNum">     683 </span>            :                 }</a>
<a name="684"><span class="lineNum">     684 </span>            :         }</a>
<a name="685"><span class="lineNum">     685 </span><span class="lineCov">         90 : }</span></a>
<a name="686"><span class="lineNum">     686 </span>            : </a>
<a name="687"><span class="lineNum">     687 </span>            : /* ### DE/QUEUE WATCH ELEMENTS ### to be used by watch element manager only */</a>
<a name="688"><span class="lineNum">     688 </span>            : /* implicit watchpoints may change (especially because of separation); elements updated by remove &amp; re-add etc.; thus we need to wait a little bit (until next opcode) and then compare whether the watchpoint still exists and if not, remove it */</a>
<a name="689"><span class="lineNum">     689 </span>            : </a>
<a name="690"><span class="lineNum">     690 </span>            : void phpdbg_dissociate_watch_element(phpdbg_watch_element *element, phpdbg_watch_element *until);</a>
<a name="691"><span class="lineNum">     691 </span>            : void phpdbg_free_watch_element_tree(phpdbg_watch_element *element);</a>
<a name="692"><span class="lineNum">     692 </span>            : </a>
<a name="693"><span class="lineNum">     693 </span><span class="lineCov">         48 : void phpdbg_queue_element_for_recreation(phpdbg_watch_element *element) {</span></a>
<a name="694"><span class="lineNum">     694 </span>            :         /* store lowermost element */</a>
<a name="695"><span class="lineNum">     695 </span>            :         phpdbg_watch_element *prev;</a>
<a name="696"><span class="lineNum">     696 </span>            : </a>
<a name="697"><span class="lineNum">     697 </span><span class="lineCov">         96 :         if ((prev = zend_hash_find_ptr(&amp;PHPDBG_G(watch_recreation), element-&gt;str))) {</span></a>
<a name="698"><span class="lineNum">     698 </span><span class="lineCov">          3 :                 phpdbg_watch_element *child = prev;</span></a>
<a name="699"><span class="lineNum">     699 </span>            :                 do {</a>
<a name="700"><span class="lineNum">     700 </span><span class="lineCov">          3 :                         if (child == element) {</span></a>
<a name="701"><span class="lineNum">     701 </span><span class="lineNoCov">          0 :                                 return;</span></a>
<a name="702"><span class="lineNum">     702 </span>            :                         }</a>
<a name="703"><span class="lineNum">     703 </span><span class="lineCov">          3 :                         child = child-&gt;child;</span></a>
<a name="704"><span class="lineNum">     704 </span><span class="lineCov">          3 :                 } while (child);</span></a>
<a name="705"><span class="lineNum">     705 </span>            :         }</a>
<a name="706"><span class="lineNum">     706 </span><span class="lineCov">         48 :         zend_hash_update_ptr(&amp;PHPDBG_G(watch_recreation), element-&gt;str, element);</span></a>
<a name="707"><span class="lineNum">     707 </span>            : </a>
<a name="708"><span class="lineNum">     708 </span>            :         /* dissociate from watchpoint to avoid dangling memory watches */</a>
<a name="709"><span class="lineNum">     709 </span><span class="lineCov">         48 :         phpdbg_dissociate_watch_element(element, prev);</span></a>
<a name="710"><span class="lineNum">     710 </span>            : </a>
<a name="711"><span class="lineNum">     711 </span><span class="lineCov">         48 :         if (!element-&gt;parent) {</span></a>
<a name="712"><span class="lineNum">     712 </span>            :                 /* HERE BE DRAGONS; i.e. we assume HashTable is directly allocated via emalloc() ... (which *should be* the case for every user-accessible array and symbol tables) */</a>
<a name="713"><span class="lineNum">     713 </span><span class="lineCov">         36 :                 zend_hash_index_add_empty_element(&amp;PHPDBG_G(watch_free), (zend_ulong) element-&gt;parent_container);</span></a>
<a name="714"><span class="lineNum">     714 </span>            :         }</a>
<a name="715"><span class="lineNum">     715 </span>            : }</a>
<a name="716"><span class="lineNum">     716 </span>            : </a>
<a name="717"><span class="lineNum">     717 </span><span class="lineCov">         21 : bool phpdbg_try_re_adding_watch_element(zval *parent, phpdbg_watch_element *element) {</span></a>
<a name="718"><span class="lineNum">     718 </span>            :         zval *zv;</a>
<a name="719"><span class="lineNum">     719 </span><span class="lineCov">         42 :         HashTable *ht = HT_FROM_ZVP(parent);</span></a>
<a name="720"><span class="lineNum">     720 </span>            : </a>
<a name="721"><span class="lineNum">     721 </span><span class="lineCov">         21 :         if (!ht) {</span></a>
<a name="722"><span class="lineNum">     722 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="723"><span class="lineNum">     723 </span><span class="lineCov">         21 :         } else if (element-&gt;flags &amp; (PHPDBG_WATCH_ARRAY | PHPDBG_WATCH_OBJECT)) {</span></a>
<a name="724"><span class="lineNum">     724 </span><span class="lineCov">          3 :                 char *htPtr = ((char *) ht) + HT_WATCH_OFFSET;</span></a>
<a name="725"><span class="lineNum">     725 </span><span class="lineCov">          3 :                 char *oldPtr = ((char *) &amp;element-&gt;backup.ht) + HT_WATCH_OFFSET;</span></a>
<a name="726"><span class="lineNum">     726 </span><span class="lineCov">          3 :                 if (phpdbg_check_watch_diff(WATCH_ON_HASHTABLE, oldPtr, htPtr)) {</span></a>
<a name="727"><span class="lineNum">     727 </span><span class="lineCov">          3 :                         phpdbg_print_watch_diff(WATCH_ON_HASHTABLE, element-&gt;str, oldPtr, htPtr);</span></a>
<a name="728"><span class="lineNum">     728 </span>            :                 }</a>
<a name="729"><span class="lineNum">     729 </span>            : </a>
<a name="730"><span class="lineNum">     730 </span><span class="lineCov">          3 :                 phpdbg_add_ht_watch_element(parent, element);</span></a>
<a name="731"><span class="lineNum">     731 </span><span class="lineCov">         36 :         } else if ((zv = zend_symtable_find(ht, element-&gt;name_in_parent))) {</span></a>
<a name="732"><span class="lineNum">     732 </span><span class="lineCov">         18 :                 if (element-&gt;flags &amp; PHPDBG_WATCH_IMPLICIT) {</span></a>
<a name="733"><span class="lineNum">     733 </span><span class="lineCov">          6 :                         zval *next = zv;</span></a>
<a name="734"><span class="lineNum">     734 </span>            : </a>
<a name="735"><span class="lineNum">     735 </span><span class="lineCov">         18 :                         while (Z_TYPE_P(next) == IS_INDIRECT) {</span></a>
<a name="736"><span class="lineNum">     736 </span><span class="lineCov">          6 :                                 next = Z_INDIRECT_P(next);</span></a>
<a name="737"><span class="lineNum">     737 </span>            :                         }</a>
<a name="738"><span class="lineNum">     738 </span><span class="lineCov">          6 :                         if (Z_ISREF_P(next)) {</span></a>
<a name="739"><span class="lineNum">     739 </span><span class="lineNoCov">          0 :                                 next = Z_REFVAL_P(next);</span></a>
<a name="740"><span class="lineNum">     740 </span>            :                         }</a>
<a name="741"><span class="lineNum">     741 </span>            : </a>
<a name="742"><span class="lineNum">     742 </span><span class="lineCov">          6 :                         if (!phpdbg_try_re_adding_watch_element(next, element-&gt;child)) {</span></a>
<a name="743"><span class="lineNum">     743 </span><span class="lineNoCov">          0 :                                 return 0;</span></a>
<a name="744"><span class="lineNum">     744 </span>            :                         }</a>
<a name="745"><span class="lineNum">     745 </span><span class="lineCov">         12 :                 } else if (phpdbg_check_watch_diff(WATCH_ON_ZVAL, &amp;element-&gt;backup.zv, zv)) {</span></a>
<a name="746"><span class="lineNum">     746 </span><span class="lineCov">          9 :                         phpdbg_print_watch_diff(WATCH_ON_ZVAL, element-&gt;str, &amp;element-&gt;backup.zv, zv);</span></a>
<a name="747"><span class="lineNum">     747 </span>            :                 }</a>
<a name="748"><span class="lineNum">     748 </span>            : </a>
<a name="749"><span class="lineNum">     749 </span><span class="lineCov">         18 :                 element-&gt;parent_container = ht;</span></a>
<a name="750"><span class="lineNum">     750 </span><span class="lineCov">         18 :                 phpdbg_add_bucket_watch_element((Bucket *) zv, element);</span></a>
<a name="751"><span class="lineNum">     751 </span><span class="lineCov">         18 :                 phpdbg_watch_parent_ht(element);</span></a>
<a name="752"><span class="lineNum">     752 </span>            :         } else {</a>
<a name="753"><span class="lineNum">     753 </span><span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="754"><span class="lineNum">     754 </span>            :         }</a>
<a name="755"><span class="lineNum">     755 </span>            : </a>
<a name="756"><span class="lineNum">     756 </span><span class="lineCov">         21 :         return 1;</span></a>
<a name="757"><span class="lineNum">     757 </span>            : }</a>
<a name="758"><span class="lineNum">     758 </span>            : </a>
<a name="759"><span class="lineNum">     759 </span><span class="lineCov">         30 : void phpdbg_automatic_dequeue_free(phpdbg_watch_element *element) {</span></a>
<a name="760"><span class="lineNum">     760 </span><span class="lineCov">         30 :         phpdbg_watch_element *child = element;</span></a>
<a name="761"><span class="lineNum">     761 </span><span class="lineCov">         42 :         while (child-&gt;child &amp;&amp; !(child-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT)) {</span></a>
<a name="762"><span class="lineNum">     762 </span><span class="lineCov">         12 :                 child = child-&gt;child;</span></a>
<a name="763"><span class="lineNum">     763 </span>            :         }</a>
<a name="764"><span class="lineNum">     764 </span><span class="lineCov">         30 :         PHPDBG_G(watchpoint_hit) = 1;</span></a>
<a name="765"><span class="lineNum">     765 </span><span class="lineCov">         30 :         if (zend_hash_index_del(&amp;PHPDBG_G(watch_elements), child-&gt;id) == SUCCESS) {</span></a>
<a name="766"><span class="lineNum">     766 </span><span class="lineCov">         27 :                 phpdbg_notice(&quot;%.*s has been removed, removing watchpoint%s&quot;, (int) ZSTR_LEN(child-&gt;str), ZSTR_VAL(child-&gt;str), (child-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT) ? &quot; recursively&quot; : &quot;&quot;);</span></a>
<a name="767"><span class="lineNum">     767 </span>            :         }</a>
<a name="768"><span class="lineNum">     768 </span><span class="lineCov">         30 :         phpdbg_free_watch_element_tree(element);</span></a>
<a name="769"><span class="lineNum">     769 </span><span class="lineCov">         30 : }</span></a>
<a name="770"><span class="lineNum">     770 </span>            : </a>
<a name="771"><span class="lineNum">     771 </span><span class="lineCov">        141 : void phpdbg_dequeue_elements_for_recreation(void) {</span></a>
<a name="772"><span class="lineNum">     772 </span>            :         phpdbg_watch_element *element;</a>
<a name="773"><span class="lineNum">     773 </span>            : </a>
<a name="774"><span class="lineNum">     774 </span><span class="lineCov">        171 :         ZEND_HASH_MAP_FOREACH_PTR(&amp;PHPDBG_G(watch_recreation), element) {</span></a>
<a name="775"><span class="lineNum">     775 </span><span class="lineCov">         15 :                 ZEND_ASSERT(element-&gt;flags &amp; (PHPDBG_WATCH_IMPLICIT | PHPDBG_WATCH_RECURSIVE_ROOT | PHPDBG_WATCH_SIMPLE));</span></a>
<a name="776"><span class="lineNum">     776 </span><span class="lineCov">         30 :                 if (element-&gt;parent || zend_hash_index_find(&amp;PHPDBG_G(watch_free), (zend_ulong) element-&gt;parent_container)) {</span></a>
<a name="777"><span class="lineNum">     777 </span><span class="lineCov">         15 :                         zval _zv, *zv = &amp;_zv;</span></a>
<a name="778"><span class="lineNum">     778 </span><span class="lineCov">         15 :                         if (element-&gt;parent) {</span></a>
<a name="779"><span class="lineNum">     779 </span><span class="lineCov">          6 :                                 ZEND_ASSERT(element-&gt;parent-&gt;watch-&gt;type == WATCH_ON_ZVAL || element-&gt;parent-&gt;watch-&gt;type == WATCH_ON_BUCKET);</span></a>
<a name="780"><span class="lineNum">     780 </span><span class="lineCov">          6 :                                 zv = element-&gt;parent-&gt;watch-&gt;addr.zv;</span></a>
<a name="781"><span class="lineNum">     781 </span><span class="lineCov">         15 :                                 while (Z_TYPE_P(zv) == IS_INDIRECT) {</span></a>
<a name="782"><span class="lineNum">     782 </span><span class="lineCov">          3 :                                         zv = Z_INDIRECT_P(zv);</span></a>
<a name="783"><span class="lineNum">     783 </span>            :                                 }</a>
<a name="784"><span class="lineNum">     784 </span><span class="lineCov">          6 :                                 ZVAL_DEREF(zv);</span></a>
<a name="785"><span class="lineNum">     785 </span>            :                         } else {</a>
<a name="786"><span class="lineNum">     786 </span><span class="lineCov">          9 :                                 ZVAL_ARR(zv, element-&gt;parent_container);</span></a>
<a name="787"><span class="lineNum">     787 </span>            :                         }</a>
<a name="788"><span class="lineNum">     788 </span><span class="lineCov">         15 :                         if (!phpdbg_try_re_adding_watch_element(zv, element)) {</span></a>
<a name="789"><span class="lineNum">     789 </span><span class="lineNoCov">          0 :                                 phpdbg_automatic_dequeue_free(element);</span></a>
<a name="790"><span class="lineNum">     790 </span>            :                         }</a>
<a name="791"><span class="lineNum">     791 </span>            :                 } else {</a>
<a name="792"><span class="lineNum">     792 </span><span class="lineNoCov">          0 :                         phpdbg_automatic_dequeue_free(element);</span></a>
<a name="793"><span class="lineNum">     793 </span>            :                 }</a>
<a name="794"><span class="lineNum">     794 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="795"><span class="lineNum">     795 </span>            : </a>
<a name="796"><span class="lineNum">     796 </span><span class="lineCov">        141 :         zend_hash_clean(&amp;PHPDBG_G(watch_recreation));</span></a>
<a name="797"><span class="lineNum">     797 </span><span class="lineCov">        141 :         zend_hash_clean(&amp;PHPDBG_G(watch_free));</span></a>
<a name="798"><span class="lineNum">     798 </span><span class="lineCov">        141 : }</span></a>
<a name="799"><span class="lineNum">     799 </span>            : </a>
<a name="800"><span class="lineNum">     800 </span>            : /* ### WATCH ELEMENT DELETION ### only use phpdbg_remove_watch_element from the exterior */</a>
<a name="801"><span class="lineNum">     801 </span>            : void phpdbg_clean_watch_element(phpdbg_watch_element *element);</a>
<a name="802"><span class="lineNum">     802 </span>            : </a>
<a name="803"><span class="lineNum">     803 </span><span class="lineCov">         66 : void phpdbg_free_watch_element(phpdbg_watch_element *element) {</span></a>
<a name="804"><span class="lineNum">     804 </span><span class="lineCov">         66 :         zend_string_release(element-&gt;str);</span></a>
<a name="805"><span class="lineNum">     805 </span><span class="lineCov">         66 :         if (element-&gt;name_in_parent) {</span></a>
<a name="806"><span class="lineNum">     806 </span><span class="lineCov">         57 :                 zend_string_release(element-&gt;name_in_parent);</span></a>
<a name="807"><span class="lineNum">     807 </span>            :         }</a>
<a name="808"><span class="lineNum">     808 </span><span class="lineCov">         66 :         efree(element);</span></a>
<a name="809"><span class="lineNum">     809 </span><span class="lineCov">         66 : }</span></a>
<a name="810"><span class="lineNum">     810 </span>            : </a>
<a name="811"><span class="lineNum">     811 </span>            : /* note: does *not* free the passed element, only clean */</a>
<a name="812"><span class="lineNum">     812 </span><span class="lineCov">         36 : void phpdbg_remove_watch_element_recursively(phpdbg_watch_element *element) {</span></a>
<a name="813"><span class="lineNum">     813 </span><span class="lineCov">         36 :         if (element-&gt;child) {</span></a>
<a name="814"><span class="lineNum">     814 </span><span class="lineCov">          6 :                 phpdbg_remove_watch_element_recursively(element-&gt;child);</span></a>
<a name="815"><span class="lineNum">     815 </span><span class="lineCov">          6 :                 phpdbg_free_watch_element(element-&gt;child);</span></a>
<a name="816"><span class="lineNum">     816 </span><span class="lineCov">          6 :                 element-&gt;child = NULL;</span></a>
<a name="817"><span class="lineNum">     817 </span><span class="lineCov">         30 :         } else if (element-&gt;flags &amp; (PHPDBG_WATCH_ARRAY | PHPDBG_WATCH_OBJECT)) {</span></a>
<a name="818"><span class="lineNum">     818 </span>            :                 phpdbg_watch_element *child;</a>
<a name="819"><span class="lineNum">     819 </span><span class="lineCov">         33 :                 ZEND_HASH_MAP_FOREACH_PTR(&amp;element-&gt;child_container, child) {</span></a>
<a name="820"><span class="lineNum">     820 </span><span class="lineCov">         12 :                         phpdbg_remove_watch_element_recursively(child);</span></a>
<a name="821"><span class="lineNum">     821 </span><span class="lineCov">         12 :                         phpdbg_free_watch_element(child);</span></a>
<a name="822"><span class="lineNum">     822 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="823"><span class="lineNum">     823 </span><span class="lineCov">          9 :                 zend_hash_destroy(&amp;element-&gt;child_container);</span></a>
<a name="824"><span class="lineNum">     824 </span>            :         }</a>
<a name="825"><span class="lineNum">     825 </span>            : </a>
<a name="826"><span class="lineNum">     826 </span><span class="lineCov">         36 :         phpdbg_clean_watch_element(element);</span></a>
<a name="827"><span class="lineNum">     827 </span><span class="lineCov">         36 : }</span></a>
<a name="828"><span class="lineNum">     828 </span>            : </a>
<a name="829"><span class="lineNum">     829 </span>            : /* remove single watch (i.e. manual unset) or implicit removed */</a>
<a name="830"><span class="lineNum">     830 </span><span class="lineNoCov">          0 : void phpdbg_remove_watch_element(phpdbg_watch_element *element) {</span></a>
<a name="831"><span class="lineNum">     831 </span><span class="lineNoCov">          0 :         phpdbg_watch_element *parent = element-&gt;parent, *child = element-&gt;child;</span></a>
<a name="832"><span class="lineNum">     832 </span><span class="lineNoCov">          0 :         while (parent) {</span></a>
<a name="833"><span class="lineNum">     833 </span><span class="lineNoCov">          0 :                 phpdbg_watch_element *cur = parent;</span></a>
<a name="834"><span class="lineNum">     834 </span><span class="lineNoCov">          0 :                 parent = parent-&gt;parent;</span></a>
<a name="835"><span class="lineNum">     835 </span><span class="lineNoCov">          0 :                 phpdbg_clean_watch_element(cur);</span></a>
<a name="836"><span class="lineNum">     836 </span><span class="lineNoCov">          0 :                 phpdbg_free_watch_element(cur);</span></a>
<a name="837"><span class="lineNum">     837 </span>            :         }</a>
<a name="838"><span class="lineNum">     838 </span><span class="lineNoCov">          0 :         while (child) {</span></a>
<a name="839"><span class="lineNum">     839 </span><span class="lineNoCov">          0 :                 phpdbg_watch_element *cur = child;</span></a>
<a name="840"><span class="lineNum">     840 </span><span class="lineNoCov">          0 :                 child = child-&gt;child;</span></a>
<a name="841"><span class="lineNum">     841 </span><span class="lineNoCov">          0 :                 if (cur-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT) {</span></a>
<a name="842"><span class="lineNum">     842 </span><span class="lineNoCov">          0 :                         phpdbg_remove_watch_element_recursively(cur);</span></a>
<a name="843"><span class="lineNum">     843 </span><span class="lineNoCov">          0 :                         child = NULL;</span></a>
<a name="844"><span class="lineNum">     844 </span>            :                 } else {</a>
<a name="845"><span class="lineNum">     845 </span><span class="lineNoCov">          0 :                         phpdbg_clean_watch_element(cur);</span></a>
<a name="846"><span class="lineNum">     846 </span>            :                 }</a>
<a name="847"><span class="lineNum">     847 </span><span class="lineNoCov">          0 :                 phpdbg_free_watch_element(cur);</span></a>
<a name="848"><span class="lineNum">     848 </span>            :         }</a>
<a name="849"><span class="lineNum">     849 </span><span class="lineNoCov">          0 :         if (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT) {</span></a>
<a name="850"><span class="lineNum">     850 </span><span class="lineNoCov">          0 :                 phpdbg_remove_watch_element_recursively(element);</span></a>
<a name="851"><span class="lineNum">     851 </span>            :         } else {</a>
<a name="852"><span class="lineNum">     852 </span><span class="lineNoCov">          0 :                 phpdbg_clean_watch_element(element);</span></a>
<a name="853"><span class="lineNum">     853 </span>            :         }</a>
<a name="854"><span class="lineNum">     854 </span><span class="lineNoCov">          0 :         zend_hash_index_del(&amp;PHPDBG_G(watch_elements), element-&gt;id);</span></a>
<a name="855"><span class="lineNum">     855 </span><span class="lineNoCov">          0 :         phpdbg_free_watch_element(element);</span></a>
<a name="856"><span class="lineNum">     856 </span><span class="lineNoCov">          0 : }</span></a>
<a name="857"><span class="lineNum">     857 </span>            : </a>
<a name="858"><span class="lineNum">     858 </span><span class="lineCov">         45 : void phpdbg_backup_watch_element(phpdbg_watch_element *element) {</span></a>
<a name="859"><span class="lineNum">     859 </span><span class="lineCov">         45 :         memcpy(&amp;element-&gt;backup, &amp;element-&gt;watch-&gt;backup, /* element-&gt;watch-&gt;size */ sizeof(element-&gt;backup));</span></a>
<a name="860"><span class="lineNum">     860 </span><span class="lineCov">         45 : }</span></a>
<a name="861"><span class="lineNum">     861 </span>            : </a>
<a name="862"><span class="lineNum">     862 </span>            : /* until argument to prevent double remove of children elements */</a>
<a name="863"><span class="lineNum">     863 </span><span class="lineCov">         48 : void phpdbg_dissociate_watch_element(phpdbg_watch_element *element, phpdbg_watch_element *until) {</span></a>
<a name="864"><span class="lineNum">     864 </span><span class="lineCov">         48 :         phpdbg_watch_element *child = element;</span></a>
<a name="865"><span class="lineNum">     865 </span><span class="lineCov">         48 :         ZEND_ASSERT((element-&gt;flags &amp; (PHPDBG_WATCH_RECURSIVE_ROOT | PHPDBG_WATCH_RECURSIVE)) != PHPDBG_WATCH_RECURSIVE);</span></a>
<a name="866"><span class="lineNum">     866 </span>            : </a>
<a name="867"><span class="lineNum">     867 </span><span class="lineCov">         48 :         if (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT) {</span></a>
<a name="868"><span class="lineNum">     868 </span><span class="lineCov">         12 :                 phpdbg_backup_watch_element(element);</span></a>
<a name="869"><span class="lineNum">     869 </span><span class="lineCov">         12 :                 phpdbg_remove_watch_element_recursively(element);</span></a>
<a name="870"><span class="lineNum">     870 </span><span class="lineCov">         12 :                 return;</span></a>
<a name="871"><span class="lineNum">     871 </span>            :         }</a>
<a name="872"><span class="lineNum">     872 </span>            : </a>
<a name="873"><span class="lineNum">     873 </span><span class="lineCov">         51 :         while (child-&gt;child != until) {</span></a>
<a name="874"><span class="lineNum">     874 </span><span class="lineCov">         15 :                 child = child-&gt;child;</span></a>
<a name="875"><span class="lineNum">     875 </span><span class="lineCov">         15 :                 if (child-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT) {</span></a>
<a name="876"><span class="lineNum">     876 </span><span class="lineNoCov">          0 :                         phpdbg_backup_watch_element(child);</span></a>
<a name="877"><span class="lineNum">     877 </span><span class="lineNoCov">          0 :                         phpdbg_remove_watch_element_recursively(child);</span></a>
<a name="878"><span class="lineNum">     878 </span><span class="lineNoCov">          0 :                         child-&gt;child = NULL;</span></a>
<a name="879"><span class="lineNum">     879 </span><span class="lineNoCov">          0 :                         break;</span></a>
<a name="880"><span class="lineNum">     880 </span>            :                 }</a>
<a name="881"><span class="lineNum">     881 </span><span class="lineCov">         15 :                 if (child-&gt;child == NULL || (child-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT)) {</span></a>
<a name="882"><span class="lineNum">     882 </span><span class="lineCov">         15 :                         phpdbg_backup_watch_element(child);</span></a>
<a name="883"><span class="lineNum">     883 </span>            :                 }</a>
<a name="884"><span class="lineNum">     884 </span><span class="lineCov">         15 :                 phpdbg_clean_watch_element(child);</span></a>
<a name="885"><span class="lineNum">     885 </span>            :         }</a>
<a name="886"><span class="lineNum">     886 </span>            :         /* element needs to be removed last! */</a>
<a name="887"><span class="lineNum">     887 </span><span class="lineCov">         36 :         if (element-&gt;child == NULL) {</span></a>
<a name="888"><span class="lineNum">     888 </span><span class="lineCov">         18 :                 phpdbg_backup_watch_element(element);</span></a>
<a name="889"><span class="lineNum">     889 </span>            :         }</a>
<a name="890"><span class="lineNum">     890 </span><span class="lineCov">         36 :         phpdbg_clean_watch_element(element);</span></a>
<a name="891"><span class="lineNum">     891 </span>            : }</a>
<a name="892"><span class="lineNum">     892 </span>            : </a>
<a name="893"><span class="lineNum">     893 </span>            : /* unlike phpdbg_remove_watch_element this *only* frees and does not clean up element + children! Only use after previous cleanup (e.g. phpdbg_dissociate_watch_element) */</a>
<a name="894"><span class="lineNum">     894 </span><span class="lineCov">         30 : void phpdbg_free_watch_element_tree(phpdbg_watch_element *element) {</span></a>
<a name="895"><span class="lineNum">     895 </span><span class="lineCov">         30 :         phpdbg_watch_element *parent = element-&gt;parent, *child = element-&gt;child;</span></a>
<a name="896"><span class="lineNum">     896 </span><span class="lineCov">         33 :         while (parent) {</span></a>
<a name="897"><span class="lineNum">     897 </span><span class="lineCov">          3 :                 phpdbg_watch_element *cur = parent;</span></a>
<a name="898"><span class="lineNum">     898 </span><span class="lineCov">          3 :                 parent = parent-&gt;parent;</span></a>
<a name="899"><span class="lineNum">     899 </span><span class="lineCov">          3 :                 phpdbg_clean_watch_element(cur);</span></a>
<a name="900"><span class="lineNum">     900 </span><span class="lineCov">          3 :                 phpdbg_free_watch_element(cur);</span></a>
<a name="901"><span class="lineNum">     901 </span>            :         }</a>
<a name="902"><span class="lineNum">     902 </span><span class="lineCov">         42 :         while (child) {</span></a>
<a name="903"><span class="lineNum">     903 </span><span class="lineCov">         12 :                 phpdbg_watch_element *cur = child;</span></a>
<a name="904"><span class="lineNum">     904 </span><span class="lineCov">         12 :                 child = child-&gt;child;</span></a>
<a name="905"><span class="lineNum">     905 </span><span class="lineCov">         12 :                 phpdbg_free_watch_element(cur);</span></a>
<a name="906"><span class="lineNum">     906 </span>            :         }</a>
<a name="907"><span class="lineNum">     907 </span><span class="lineCov">         30 :         phpdbg_free_watch_element(element);</span></a>
<a name="908"><span class="lineNum">     908 </span><span class="lineCov">         30 : }</span></a>
<a name="909"><span class="lineNum">     909 </span>            : </a>
<a name="910"><span class="lineNum">     910 </span><span class="lineCov">         51 : void phpdbg_update_watch_element_watch(phpdbg_watch_element *element) {</span></a>
<a name="911"><span class="lineNum">     911 </span><span class="lineCov">         51 :         if (element-&gt;flags &amp; PHPDBG_WATCH_IMPLICIT) {</span></a>
<a name="912"><span class="lineNum">     912 </span><span class="lineCov">         18 :                 phpdbg_watch_element *child = element-&gt;child;</span></a>
<a name="913"><span class="lineNum">     913 </span><span class="lineCov">         18 :                 while (child-&gt;flags &amp; PHPDBG_WATCH_IMPLICIT) {</span></a>
<a name="914"><span class="lineNum">     914 </span><span class="lineNoCov">          0 :                         child = child-&gt;child;</span></a>
<a name="915"><span class="lineNum">     915 </span>            :                 }</a>
<a name="916"><span class="lineNum">     916 </span>            : </a>
<a name="917"><span class="lineNum">     917 </span><span class="lineCov">         18 :                 ZEND_ASSERT(element-&gt;watch-&gt;type == WATCH_ON_ZVAL || element-&gt;watch-&gt;type == WATCH_ON_BUCKET);</span></a>
<a name="918"><span class="lineNum">     918 </span><span class="lineCov">         18 :                 phpdbg_queue_element_for_recreation(element);</span></a>
<a name="919"><span class="lineNum">     919 </span><span class="lineCov">         33 :         } else if (element-&gt;flags &amp; (PHPDBG_WATCH_RECURSIVE_ROOT | PHPDBG_WATCH_SIMPLE)) {</span></a>
<a name="920"><span class="lineNum">     920 </span><span class="lineCov">         30 :                 phpdbg_queue_element_for_recreation(element);</span></a>
<a name="921"><span class="lineNum">     921 </span><span class="lineCov">          3 :         } else if (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE) {</span></a>
<a name="922"><span class="lineNum">     922 </span><span class="lineCov">          3 :                 phpdbg_remove_watch_element_recursively(element);</span></a>
<a name="923"><span class="lineNum">     923 </span><span class="lineCov">          3 :                 if (element-&gt;parent-&gt;flags &amp; (PHPDBG_WATCH_OBJECT | PHPDBG_WATCH_ARRAY)) {</span></a>
<a name="924"><span class="lineNum">     924 </span><span class="lineCov">          3 :                         zend_hash_del(&amp;element-&gt;parent-&gt;child_container, element-&gt;str);</span></a>
<a name="925"><span class="lineNum">     925 </span>            :                 } else {</a>
<a name="926"><span class="lineNum">     926 </span><span class="lineNoCov">          0 :                         element-&gt;parent-&gt;child = NULL;</span></a>
<a name="927"><span class="lineNum">     927 </span>            :                 }</a>
<a name="928"><span class="lineNum">     928 </span><span class="lineCov">          3 :                 phpdbg_free_watch_element(element);</span></a>
<a name="929"><span class="lineNum">     929 </span>            :         }</a>
<a name="930"><span class="lineNum">     930 </span><span class="lineCov">         51 : }</span></a>
<a name="931"><span class="lineNum">     931 </span>            : </a>
<a name="932"><span class="lineNum">     932 </span><span class="lineCov">         39 : void phpdbg_update_watch_collision_elements(phpdbg_watchpoint_t *watch) {</span></a>
<a name="933"><span class="lineNum">     933 </span>            :         phpdbg_watchpoint_t *parent;</a>
<a name="934"><span class="lineNum">     934 </span>            :         phpdbg_watch_element *element;</a>
<a name="935"><span class="lineNum">     935 </span>            : </a>
<a name="936"><span class="lineNum">     936 </span><span class="lineCov">        123 :         ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;coll-&gt;parents, parent) {</span></a>
<a name="937"><span class="lineNum">     937 </span><span class="lineCov">         39 :                 if (parent-&gt;coll) {</span></a>
<a name="938"><span class="lineNum">     938 </span><span class="lineCov">         15 :                         phpdbg_update_watch_collision_elements(parent);</span></a>
<a name="939"><span class="lineNum">     939 </span>            :                 } else {</a>
<a name="940"><span class="lineNum">     940 </span><span class="lineCov">         72 :                         ZEND_HASH_MAP_FOREACH_PTR(&amp;parent-&gt;elements, element) {</span></a>
<a name="941"><span class="lineNum">     941 </span><span class="lineCov">         24 :                                 phpdbg_update_watch_element_watch(element);</span></a>
<a name="942"><span class="lineNum">     942 </span>            :                         } ZEND_HASH_FOREACH_END();</a>
<a name="943"><span class="lineNum">     943 </span>            :                 }</a>
<a name="944"><span class="lineNum">     944 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="945"><span class="lineNum">     945 </span><span class="lineCov">         39 : }</span></a>
<a name="946"><span class="lineNum">     946 </span>            : </a>
<a name="947"><span class="lineNum">     947 </span><span class="lineCov">         99 : void phpdbg_remove_watchpoint(phpdbg_watchpoint_t *watch) {</span></a>
<a name="948"><span class="lineNum">     948 </span>            :         phpdbg_watch_element *element;</a>
<a name="949"><span class="lineNum">     949 </span>            : </a>
<a name="950"><span class="lineNum">     950 </span><span class="lineCov">         99 :         phpdbg_remove_watchpoint_btree(watch);</span></a>
<a name="951"><span class="lineNum">     951 </span><span class="lineCov">         99 :         phpdbg_deactivate_watchpoint(watch);</span></a>
<a name="952"><span class="lineNum">     952 </span><span class="lineCov">         99 :         phpdbg_delete_watch_collision(watch);</span></a>
<a name="953"><span class="lineNum">     953 </span>            : </a>
<a name="954"><span class="lineNum">     954 </span><span class="lineCov">         99 :         if (watch-&gt;coll) {</span></a>
<a name="955"><span class="lineNum">     955 </span><span class="lineCov">         24 :                 phpdbg_update_watch_collision_elements(watch);</span></a>
<a name="956"><span class="lineNum">     956 </span><span class="lineCov">         24 :                 return;</span></a>
<a name="957"><span class="lineNum">     957 </span>            :         }</a>
<a name="958"><span class="lineNum">     958 </span>            : </a>
<a name="959"><span class="lineNum">     959 </span><span class="lineCov">         75 :         watch-&gt;elements.nNumOfElements++; /* dirty hack to avoid double free */</span></a>
<a name="960"><span class="lineNum">     960 </span><span class="lineCov">        117 :         ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;elements, element) {</span></a>
<a name="961"><span class="lineNum">     961 </span><span class="lineCov">         21 :                 phpdbg_update_watch_element_watch(element);</span></a>
<a name="962"><span class="lineNum">     962 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="963"><span class="lineNum">     963 </span><span class="lineCov">         75 :         zend_hash_destroy(&amp;watch-&gt;elements);</span></a>
<a name="964"><span class="lineNum">     964 </span>            : </a>
<a name="965"><span class="lineNum">     965 </span><span class="lineCov">         75 :         efree(watch);</span></a>
<a name="966"><span class="lineNum">     966 </span>            : }</a>
<a name="967"><span class="lineNum">     967 </span>            : </a>
<a name="968"><span class="lineNum">     968 </span><span class="lineCov">         90 : void phpdbg_clean_watch_element(phpdbg_watch_element *element) {</span></a>
<a name="969"><span class="lineNum">     969 </span><span class="lineCov">         90 :         HashTable *elements = &amp;element-&gt;watch-&gt;elements;</span></a>
<a name="970"><span class="lineNum">     970 </span><span class="lineCov">         90 :         phpdbg_unwatch_parent_ht(element);</span></a>
<a name="971"><span class="lineNum">     971 </span><span class="lineCov">         90 :         zend_hash_del(elements, element-&gt;str);</span></a>
<a name="972"><span class="lineNum">     972 </span><span class="lineCov">         90 :         if (zend_hash_num_elements(elements) == 0) {</span></a>
<a name="973"><span class="lineNum">     973 </span><span class="lineCov">         54 :                 phpdbg_remove_watchpoint(element-&gt;watch);</span></a>
<a name="974"><span class="lineNum">     974 </span>            :         }</a>
<a name="975"><span class="lineNum">     975 </span><span class="lineCov">         90 : }</span></a>
<a name="976"><span class="lineNum">     976 </span>            : </a>
<a name="977"><span class="lineNum">     977 </span>            : /* TODO: compile a name of all hit watchpoints (ids ??) */</a>
<a name="978"><span class="lineNum">     978 </span><span class="lineCov">         63 : zend_string *phpdbg_watchpoint_change_collision_name(phpdbg_watchpoint_t *watch) {</span></a>
<a name="979"><span class="lineNum">     979 </span>            :         phpdbg_watchpoint_t *parent;</a>
<a name="980"><span class="lineNum">     980 </span>            :         phpdbg_watch_element *element;</a>
<a name="981"><span class="lineNum">     981 </span><span class="lineCov">         63 :         zend_string *name = NULL;</span></a>
<a name="982"><span class="lineNum">     982 </span><span class="lineCov">         63 :         if (watch-&gt;coll) {</span></a>
<a name="983"><span class="lineNum">     983 </span><span class="lineCov">         54 :                 ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;coll-&gt;parents, parent) {</span></a>
<a name="984"><span class="lineNum">     984 </span><span class="lineCov">         18 :                         if (name) {</span></a>
<a name="985"><span class="lineNum">     985 </span>            :                                 zend_string_release(name);</a>
<a name="986"><span class="lineNum">     986 </span>            :                         }</a>
<a name="987"><span class="lineNum">     987 </span><span class="lineCov">         18 :                         name = phpdbg_watchpoint_change_collision_name(parent);</span></a>
<a name="988"><span class="lineNum">     988 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="989"><span class="lineNum">     989 </span><span class="lineCov">         18 :                 return name;</span></a>
<a name="990"><span class="lineNum">     990 </span>            :         }</a>
<a name="991"><span class="lineNum">     991 </span><span class="lineCov">        144 :         ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;elements, element) {</span></a>
<a name="992"><span class="lineNum">     992 </span><span class="lineCov">         48 :                 if (element-&gt;flags &amp; PHPDBG_WATCH_IMPLICIT) {</span></a>
<a name="993"><span class="lineNum">     993 </span><span class="lineCov">         12 :                         if ((watch-&gt;type == WATCH_ON_ZVAL || watch-&gt;type == WATCH_ON_BUCKET) &amp;&amp; Z_TYPE(watch-&gt;backup.zv) &gt; IS_STRING) {</span></a>
<a name="994"><span class="lineNum">     994 </span><span class="lineCov">          6 :                                 phpdbg_update_watch_element_watch(element-&gt;child);</span></a>
<a name="995"><span class="lineNum">     995 </span>            :                         }</a>
<a name="996"><span class="lineNum">     996 </span><span class="lineCov">          6 :                         continue;</span></a>
<a name="997"><span class="lineNum">     997 </span>            :                 }</a>
<a name="998"><span class="lineNum">     998 </span><span class="lineCov">         42 :                 name = element-&gt;str;</span></a>
<a name="999"><span class="lineNum">     999 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="1000"><span class="lineNum">    1000 </span>            : </a>
<a name="1001"><span class="lineNum">    1001 </span><span class="lineCov">         84 :         return name ? zend_string_copy(name) : NULL;</span></a>
<a name="1002"><span class="lineNum">    1002 </span>            : }</a>
<a name="1003"><span class="lineNum">    1003 </span>            : </a>
<a name="1004"><span class="lineNum">    1004 </span>            : /* ### WATCHING FOR CHANGES ### */</a>
<a name="1005"><span class="lineNum">    1005 </span>            : /* TODO: enforce order: first parents, then children, in order to avoid false positives */</a>
<a name="1006"><span class="lineNum">    1006 </span><span class="lineCov">        192 : void phpdbg_check_watchpoint(phpdbg_watchpoint_t *watch) {</span></a>
<a name="1007"><span class="lineNum">    1007 </span><span class="lineCov">        192 :         zend_string *name = NULL;</span></a>
<a name="1008"><span class="lineNum">    1008 </span>            :         void *comparePtr;</a>
<a name="1009"><span class="lineNum">    1009 </span>            : </a>
<a name="1010"><span class="lineNum">    1010 </span><span class="lineCov">        192 :         if (watch-&gt;type == WATCH_ON_HASHTABLE) {</span></a>
<a name="1011"><span class="lineNum">    1011 </span>            :                 phpdbg_watch_element *element;</a>
<a name="1012"><span class="lineNum">    1012 </span>            :                 zend_string *str;</a>
<a name="1013"><span class="lineNum">    1013 </span>            :                 zend_long idx;</a>
<a name="1014"><span class="lineNum">    1014 </span>            :                 zval *zv;</a>
<a name="1015"><span class="lineNum">    1015 </span><span class="lineCov">         18 :                 ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;elements, element) {</span></a>
<a name="1016"><span class="lineNum">    1016 </span><span class="lineCov">          9 :                         if (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE) {</span></a>
<a name="1017"><span class="lineNum">    1017 </span><span class="lineCov">          9 :                                 phpdbg_btree_result *res = phpdbg_btree_find(&amp;PHPDBG_G(watch_HashTables), (zend_ulong) HT_WATCH_HT(watch));</span></a>
<a name="1018"><span class="lineNum">    1018 </span><span class="lineCov">          9 :                                 phpdbg_watch_ht_info *hti = res ? res-&gt;ptr : NULL;</span></a>
<a name="1019"><span class="lineNum">    1019 </span>            : </a>
<a name="1020"><span class="lineNum">    1020 </span><span class="lineCov">         24 :                                 ZEND_HASH_REVERSE_FOREACH_KEY_VAL(HT_WATCH_HT(watch), idx, str, zv) {</span></a>
<a name="1021"><span class="lineNum">    1021 </span><span class="lineCov">         12 :                                         if (!str) {</span></a>
<a name="1022"><span class="lineNum">    1022 </span><span class="lineCov">         12 :                                                 str = zend_long_to_str(idx); // TODO: hack, use proper int handling for name in parent</span></a>
<a name="1023"><span class="lineNum">    1023 </span>            :                                         } else {</a>
<a name="1024"><span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                                                 str = zend_string_copy(str);</span></a>
<a name="1025"><span class="lineNum">    1025 </span>            :                                         }</a>
<a name="1026"><span class="lineNum">    1026 </span><span class="lineCov">         12 :                                         if (hti &amp;&amp; zend_hash_find(&amp;hti-&gt;watches, str)) {</span></a>
<a name="1027"><span class="lineNum">    1027 </span>            :                                                 zend_string_release(str);</a>
<a name="1028"><span class="lineNum">    1028 </span><span class="lineCov">          9 :                                                 break;</span></a>
<a name="1029"><span class="lineNum">    1029 </span>            :                                         }</a>
<a name="1030"><span class="lineNum">    1030 </span><span class="lineCov">          9 :                                         ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;elements, element) {</span></a>
<a name="1031"><span class="lineNum">    1031 </span><span class="lineCov">          3 :                                                 if (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE) {</span></a>
<a name="1032"><span class="lineNum">    1032 </span><span class="lineCov">          3 :                                                         phpdbg_add_recursive_watch_from_ht(element, idx, str, zv);</span></a>
<a name="1033"><span class="lineNum">    1033 </span>            :                                                 }</a>
<a name="1034"><span class="lineNum">    1034 </span>            :                                         } ZEND_HASH_FOREACH_END();</a>
<a name="1035"><span class="lineNum">    1035 </span><span class="lineCov">          3 :                                         phpdbg_notice(&quot;Element %.*s has been added to watchpoint&quot;, (int) ZSTR_LEN(str), ZSTR_VAL(str));</span></a>
<a name="1036"><span class="lineNum">    1036 </span>            :                                         zend_string_release(str);</a>
<a name="1037"><span class="lineNum">    1037 </span><span class="lineCov">          3 :                                         PHPDBG_G(watchpoint_hit) = 1;</span></a>
<a name="1038"><span class="lineNum">    1038 </span>            :                                 } ZEND_HASH_FOREACH_END();</a>
<a name="1039"><span class="lineNum">    1039 </span>            : </a>
<a name="1040"><span class="lineNum">    1040 </span><span class="lineCov">          9 :                                 break;</span></a>
<a name="1041"><span class="lineNum">    1041 </span>            :                         }</a>
<a name="1042"><span class="lineNum">    1042 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="1043"><span class="lineNum">    1043 </span>            :         }</a>
<a name="1044"><span class="lineNum">    1044 </span><span class="lineCov">        192 :         if (watch-&gt;type == WATCH_ON_HASHDATA) {</span></a>
<a name="1045"><span class="lineNum">    1045 </span><span class="lineCov">         27 :                 return;</span></a>
<a name="1046"><span class="lineNum">    1046 </span>            :         }</a>
<a name="1047"><span class="lineNum">    1047 </span>            : </a>
<a name="1048"><span class="lineNum">    1048 </span><span class="lineCov">        165 :         switch (watch-&gt;type) {</span></a>
<a name="1049"><span class="lineNum">    1049 </span><span class="lineCov">          9 :                 case WATCH_ON_STR:</span></a>
<a name="1050"><span class="lineNum">    1050 </span><span class="lineCov">          9 :                         comparePtr = &amp;ZSTR_LEN(watch-&gt;backup.str);</span></a>
<a name="1051"><span class="lineNum">    1051 </span><span class="lineCov">          9 :                         break;</span></a>
<a name="1052"><span class="lineNum">    1052 </span><span class="lineCov">          9 :                 case WATCH_ON_HASHTABLE:</span></a>
<a name="1053"><span class="lineNum">    1053 </span><span class="lineCov">          9 :                         comparePtr = (char *) &amp;watch-&gt;backup.ht + HT_WATCH_OFFSET;</span></a>
<a name="1054"><span class="lineNum">    1054 </span><span class="lineCov">          9 :                         break;</span></a>
<a name="1055"><span class="lineNum">    1055 </span><span class="lineCov">        147 :                 default:</span></a>
<a name="1056"><span class="lineNum">    1056 </span><span class="lineCov">        147 :                         comparePtr = &amp;watch-&gt;backup;</span></a>
<a name="1057"><span class="lineNum">    1057 </span>            :         }</a>
<a name="1058"><span class="lineNum">    1058 </span><span class="lineCov">        165 :         if (!phpdbg_check_watch_diff(watch-&gt;type, comparePtr, watch-&gt;addr.ptr)) {</span></a>
<a name="1059"><span class="lineNum">    1059 </span><span class="lineCov">        114 :                 return;</span></a>
<a name="1060"><span class="lineNum">    1060 </span>            :         }</a>
<a name="1061"><span class="lineNum">    1061 </span><span class="lineCov">         51 :         if (watch-&gt;type == WATCH_ON_REFCOUNTED &amp;&amp; !(PHPDBG_G(flags) &amp; PHPDBG_SHOW_REFCOUNTS)) {</span></a>
<a name="1062"><span class="lineNum">    1062 </span><span class="lineCov">          3 :                 phpdbg_watch_backup_data(watch);</span></a>
<a name="1063"><span class="lineNum">    1063 </span><span class="lineCov">          3 :                 return;</span></a>
<a name="1064"><span class="lineNum">    1064 </span>            :         }</a>
<a name="1065"><span class="lineNum">    1065 </span><span class="lineCov">         48 :         if (watch-&gt;type == WATCH_ON_BUCKET) {</span></a>
<a name="1066"><span class="lineNum">    1066 </span><span class="lineCov">         42 :                 if (watch-&gt;backup.bucket.key != watch-&gt;addr.bucket-&gt;key || (watch-&gt;backup.bucket.key != NULL &amp;&amp; watch-&gt;backup.bucket.h != watch-&gt;addr.bucket-&gt;h)) {</span></a>
<a name="1067"><span class="lineNum">    1067 </span><span class="lineCov">         12 :                         phpdbg_watch_element *element = NULL;</span></a>
<a name="1068"><span class="lineNum">    1068 </span>            :                         zval *new;</a>
<a name="1069"><span class="lineNum">    1069 </span>            : </a>
<a name="1070"><span class="lineNum">    1070 </span><span class="lineCov">         27 :                         ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;elements, element) {</span></a>
<a name="1071"><span class="lineNum">    1071 </span><span class="lineCov">         12 :                                 break;</span></a>
<a name="1072"><span class="lineNum">    1072 </span>            :                         } ZEND_HASH_FOREACH_END();</a>
<a name="1073"><span class="lineNum">    1073 </span>            : </a>
<a name="1074"><span class="lineNum">    1074 </span><span class="lineCov">         12 :                         ZEND_ASSERT(element); /* elements must be non-empty */</span></a>
<a name="1075"><span class="lineNum">    1075 </span><span class="lineCov">         12 :                         new = zend_symtable_find(element-&gt;parent_container, element-&gt;name_in_parent);</span></a>
<a name="1076"><span class="lineNum">    1076 </span>            : </a>
<a name="1077"><span class="lineNum">    1077 </span><span class="lineCov">         12 :                         if (!new) {</span></a>
<a name="1078"><span class="lineNum">    1078 </span>            :                                 /* dequeuing will take care of appropriate notification about removal */</a>
<a name="1079"><span class="lineNum">    1079 </span><span class="lineNoCov">          0 :                                 phpdbg_remove_watchpoint(watch);</span></a>
<a name="1080"><span class="lineNum">    1080 </span><span class="lineNoCov">          0 :                                 return;</span></a>
<a name="1081"><span class="lineNum">    1081 </span>            :                         }</a>
<a name="1082"><span class="lineNum">    1082 </span>            : </a>
<a name="1083"><span class="lineNum">    1083 </span><span class="lineCov">         12 :                         phpdbg_remove_watchpoint_btree(watch);</span></a>
<a name="1084"><span class="lineNum">    1084 </span><span class="lineCov">         12 :                         phpdbg_deactivate_watchpoint(watch);</span></a>
<a name="1085"><span class="lineNum">    1085 </span><span class="lineCov">         12 :                         watch-&gt;addr.zv = new;</span></a>
<a name="1086"><span class="lineNum">    1086 </span><span class="lineCov">         12 :                         phpdbg_store_watchpoint_btree(watch);</span></a>
<a name="1087"><span class="lineNum">    1087 </span><span class="lineCov">         12 :                         phpdbg_activate_watchpoint(watch);</span></a>
<a name="1088"><span class="lineNum">    1088 </span>            : </a>
<a name="1089"><span class="lineNum">    1089 </span><span class="lineCov">         12 :                         if (!phpdbg_check_watch_diff(WATCH_ON_ZVAL, &amp;watch-&gt;backup.bucket.val, watch-&gt;addr.ptr)) {</span></a>
<a name="1090"><span class="lineNum">    1090 </span><span class="lineCov">          3 :                                 phpdbg_watch_backup_data(watch);</span></a>
<a name="1091"><span class="lineNum">    1091 </span><span class="lineCov">          3 :                                 return;</span></a>
<a name="1092"><span class="lineNum">    1092 </span>            :                         }</a>
<a name="1093"><span class="lineNum">    1093 </span><span class="lineCov">         42 :                 } else if (Z_TYPE_P(watch-&gt;addr.zv) == IS_UNDEF) {</span></a>
<a name="1094"><span class="lineNum">    1094 </span>            :                         /* dequeuing will take care of appropriate notification about removal */</a>
<a name="1095"><span class="lineNum">    1095 </span><span class="lineNoCov">          0 :                         phpdbg_remove_watchpoint(watch);</span></a>
<a name="1096"><span class="lineNum">    1096 </span><span class="lineNoCov">          0 :                         return;</span></a>
<a name="1097"><span class="lineNum">    1097 </span>            :                 }</a>
<a name="1098"><span class="lineNum">    1098 </span>            :         }</a>
<a name="1099"><span class="lineNum">    1099 </span>            : </a>
<a name="1100"><span class="lineNum">    1100 </span><span class="lineCov">         45 :         name = phpdbg_watchpoint_change_collision_name(watch);</span></a>
<a name="1101"><span class="lineNum">    1101 </span>            : </a>
<a name="1102"><span class="lineNum">    1102 </span><span class="lineCov">         45 :         if (name) {</span></a>
<a name="1103"><span class="lineNum">    1103 </span><span class="lineCov">         39 :                 phpdbg_print_watch_diff(watch-&gt;type, name, comparePtr, watch-&gt;addr.ptr);</span></a>
<a name="1104"><span class="lineNum">    1104 </span>            :                 zend_string_release(name);</a>
<a name="1105"><span class="lineNum">    1105 </span>            :         }</a>
<a name="1106"><span class="lineNum">    1106 </span>            : </a>
<a name="1107"><span class="lineNum">    1107 </span><span class="lineCov">         45 :         if (watch-&gt;type == WATCH_ON_ZVAL || watch-&gt;type == WATCH_ON_BUCKET) {</span></a>
<a name="1108"><span class="lineNum">    1108 </span>            :                 phpdbg_watch_element *element;</a>
<a name="1109"><span class="lineNum">    1109 </span><span class="lineCov">         36 :                 phpdbg_update_watch_ref(watch);</span></a>
<a name="1110"><span class="lineNum">    1110 </span><span class="lineCov">        105 :                 ZEND_HASH_MAP_FOREACH_PTR(&amp;watch-&gt;elements, element) {</span></a>
<a name="1111"><span class="lineNum">    1111 </span><span class="lineCov">         33 :                         if (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE) {</span></a>
<a name="1112"><span class="lineNum">    1112 </span><span class="lineCov">         18 :                                 phpdbg_recurse_watch_element(element);</span></a>
<a name="1113"><span class="lineNum">    1113 </span>            :                         }</a>
<a name="1114"><span class="lineNum">    1114 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="1115"><span class="lineNum">    1115 </span>            :         }</a>
<a name="1116"><span class="lineNum">    1116 </span>            : </a>
<a name="1117"><span class="lineNum">    1117 </span><span class="lineCov">         45 :         phpdbg_watch_backup_data(watch);</span></a>
<a name="1118"><span class="lineNum">    1118 </span>            : }</a>
<a name="1119"><span class="lineNum">    1119 </span>            : </a>
<a name="1120"><span class="lineNum">    1120 </span><span class="lineCov">        219 : void phpdbg_reenable_memory_watches(void) {</span></a>
<a name="1121"><span class="lineNum">    1121 </span>            :         zend_ulong page;</a>
<a name="1122"><span class="lineNum">    1122 </span>            :         phpdbg_btree_result *res;</a>
<a name="1123"><span class="lineNum">    1123 </span>            :         phpdbg_watchpoint_t *watch;</a>
<a name="1124"><span class="lineNum">    1124 </span>            : </a>
<a name="1125"><span class="lineNum">    1125 </span><span class="lineCov">        525 :         ZEND_HASH_MAP_FOREACH_NUM_KEY(PHPDBG_G(watchlist_mem), page) {</span></a>
<a name="1126"><span class="lineNum">    1126 </span>            :                 /* Disable writing again if there are any watchers on that page */</a>
<a name="1127"><span class="lineNum">    1127 </span><span class="lineCov">        153 :                 res = phpdbg_btree_find_closest(&amp;PHPDBG_G(watchpoint_tree), page + phpdbg_pagesize - 1);</span></a>
<a name="1128"><span class="lineNum">    1128 </span><span class="lineCov">        153 :                 if (res) {</span></a>
<a name="1129"><span class="lineNum">    1129 </span><span class="lineCov">        153 :                         watch = res-&gt;ptr;</span></a>
<a name="1130"><span class="lineNum">    1130 </span><span class="lineCov">        153 :                         if ((char *) page &lt; (char *) watch-&gt;addr.ptr + watch-&gt;size) {</span></a>
<a name="1131"><span class="lineNum">    1131 </span>            : #ifdef HAVE_USERFAULTFD_WRITEFAULT</a>
<a name="1132"><span class="lineNum">    1132 </span>            :                                 if (PHPDBG_G(watch_userfaultfd)) {</a>
<a name="1133"><span class="lineNum">    1133 </span>            :                                         struct uffdio_writeprotect protect = {</a>
<a name="1134"><span class="lineNum">    1134 </span>            :                                                 .mode = UFFDIO_WRITEPROTECT_MODE_WP,</a>
<a name="1135"><span class="lineNum">    1135 </span>            :                                                 .range = {</a>
<a name="1136"><span class="lineNum">    1136 </span>            :                                                         .start = (__u64) page,</a>
<a name="1137"><span class="lineNum">    1137 </span>            :                                                         .len = phpdbg_pagesize</a>
<a name="1138"><span class="lineNum">    1138 </span>            :                                                 }</a>
<a name="1139"><span class="lineNum">    1139 </span>            :                                         };</a>
<a name="1140"><span class="lineNum">    1140 </span>            :                                         ioctl(PHPDBG_G(watch_userfaultfd), UFFDIO_WRITEPROTECT,  &amp;protect);</a>
<a name="1141"><span class="lineNum">    1141 </span>            :                                 } else</a>
<a name="1142"><span class="lineNum">    1142 </span>            : #endif</a>
<a name="1143"><span class="lineNum">    1143 </span>            :                                 {</a>
<a name="1144"><span class="lineNum">    1144 </span><span class="lineCov">        150 :                                         mprotect((void *) page, phpdbg_pagesize, PROT_READ);</span></a>
<a name="1145"><span class="lineNum">    1145 </span>            :                                 }</a>
<a name="1146"><span class="lineNum">    1146 </span>            :                         }</a>
<a name="1147"><span class="lineNum">    1147 </span>            :                 }</a>
<a name="1148"><span class="lineNum">    1148 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="1149"><span class="lineNum">    1149 </span><span class="lineCov">        219 :         zend_hash_clean(PHPDBG_G(watchlist_mem));</span></a>
<a name="1150"><span class="lineNum">    1150 </span><span class="lineCov">        219 : }</span></a>
<a name="1151"><span class="lineNum">    1151 </span>            : </a>
<a name="1152"><span class="lineNum">    1152 </span><span class="lineCov">     322683 : int phpdbg_print_changed_zvals(void) {</span></a>
<a name="1153"><span class="lineNum">    1153 </span>            :         int ret;</a>
<a name="1154"><span class="lineNum">    1154 </span>            :         zend_ulong page;</a>
<a name="1155"><span class="lineNum">    1155 </span>            :         phpdbg_watchpoint_t *watch;</a>
<a name="1156"><span class="lineNum">    1156 </span>            :         phpdbg_btree_result *res;</a>
<a name="1157"><span class="lineNum">    1157 </span><span class="lineCov">     322683 :         HashTable *mem_list = NULL;</span></a>
<a name="1158"><span class="lineNum">    1158 </span>            : </a>
<a name="1159"><span class="lineNum">    1159 </span><span class="lineCov">     322683 :         if (zend_hash_num_elements(&amp;PHPDBG_G(watch_elements)) == 0) {</span></a>
<a name="1160"><span class="lineNum">    1160 </span><span class="lineCov">     322542 :                 return FAILURE;</span></a>
<a name="1161"><span class="lineNum">    1161 </span>            :         }</a>
<a name="1162"><span class="lineNum">    1162 </span>            : </a>
<a name="1163"><span class="lineNum">    1163 </span><span class="lineCov">        141 :         if (zend_hash_num_elements(PHPDBG_G(watchlist_mem)) &gt; 0) {</span></a>
<a name="1164"><span class="lineNum">    1164 </span>            :                 /* we must not add elements to the hashtable while iterating over it (resize =&gt; read into freed memory) */</a>
<a name="1165"><span class="lineNum">    1165 </span><span class="lineCov">         78 :                 mem_list = PHPDBG_G(watchlist_mem);</span></a>
<a name="1166"><span class="lineNum">    1166 </span><span class="lineCov">         78 :                 PHPDBG_G(watchlist_mem) = PHPDBG_G(watchlist_mem_backup);</span></a>
<a name="1167"><span class="lineNum">    1167 </span>            : </a>
<a name="1168"><span class="lineNum">    1168 </span><span class="lineCov">        324 :                 ZEND_HASH_MAP_FOREACH_NUM_KEY(mem_list, page) {</span></a>
<a name="1169"><span class="lineNum">    1169 </span><span class="lineCov">        123 :                         phpdbg_btree_position pos = phpdbg_btree_find_between(&amp;PHPDBG_G(watchpoint_tree), page, page + phpdbg_pagesize);</span></a>
<a name="1170"><span class="lineNum">    1170 </span>            : </a>
<a name="1171"><span class="lineNum">    1171 </span><span class="lineCov">        315 :                         while ((res = phpdbg_btree_next(&amp;pos))) {</span></a>
<a name="1172"><span class="lineNum">    1172 </span><span class="lineCov">        192 :                                 watch = res-&gt;ptr;</span></a>
<a name="1173"><span class="lineNum">    1173 </span><span class="lineCov">        192 :                                 phpdbg_check_watchpoint(watch);</span></a>
<a name="1174"><span class="lineNum">    1174 </span>            :                         }</a>
<a name="1175"><span class="lineNum">    1175 </span><span class="lineCov">        123 :                         if ((res = phpdbg_btree_find_closest(&amp;PHPDBG_G(watchpoint_tree), page - 1))) {</span></a>
<a name="1176"><span class="lineNum">    1176 </span><span class="lineCov">         60 :                                 watch = res-&gt;ptr;</span></a>
<a name="1177"><span class="lineNum">    1177 </span><span class="lineCov">         60 :                                 if ((char *) page &lt; (char *) watch-&gt;addr.ptr + watch-&gt;size) {</span></a>
<a name="1178"><span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                                         phpdbg_check_watchpoint(watch);</span></a>
<a name="1179"><span class="lineNum">    1179 </span>            :                                 }</a>
<a name="1180"><span class="lineNum">    1180 </span>            :                         }</a>
<a name="1181"><span class="lineNum">    1181 </span>            :                 } ZEND_HASH_FOREACH_END();</a>
<a name="1182"><span class="lineNum">    1182 </span>            :         }</a>
<a name="1183"><span class="lineNum">    1183 </span>            : </a>
<a name="1184"><span class="lineNum">    1184 </span><span class="lineCov">        141 :         phpdbg_dequeue_elements_for_recreation();</span></a>
<a name="1185"><span class="lineNum">    1185 </span>            : </a>
<a name="1186"><span class="lineNum">    1186 </span><span class="lineCov">        141 :         phpdbg_reenable_memory_watches();</span></a>
<a name="1187"><span class="lineNum">    1187 </span>            : </a>
<a name="1188"><span class="lineNum">    1188 </span><span class="lineCov">        141 :         if (mem_list) {</span></a>
<a name="1189"><span class="lineNum">    1189 </span><span class="lineCov">         78 :                 PHPDBG_G(watchlist_mem) = mem_list;</span></a>
<a name="1190"><span class="lineNum">    1190 </span><span class="lineCov">         78 :                 phpdbg_reenable_memory_watches();</span></a>
<a name="1191"><span class="lineNum">    1191 </span>            :         }</a>
<a name="1192"><span class="lineNum">    1192 </span>            : </a>
<a name="1193"><span class="lineNum">    1193 </span><span class="lineCov">        141 :         ret = PHPDBG_G(watchpoint_hit) ? SUCCESS : FAILURE;</span></a>
<a name="1194"><span class="lineNum">    1194 </span><span class="lineCov">        141 :         PHPDBG_G(watchpoint_hit) = 0;</span></a>
<a name="1195"><span class="lineNum">    1195 </span>            : </a>
<a name="1196"><span class="lineNum">    1196 </span><span class="lineCov">        141 :         return ret;</span></a>
<a name="1197"><span class="lineNum">    1197 </span>            : }</a>
<a name="1198"><span class="lineNum">    1198 </span>            : </a>
<a name="1199"><span class="lineNum">    1199 </span><span class="lineCov">    1454490 : void phpdbg_watch_efree(void *ptr) {</span></a>
<a name="1200"><span class="lineNum">    1200 </span>            :         phpdbg_btree_result *result;</a>
<a name="1201"><span class="lineNum">    1201 </span>            : </a>
<a name="1202"><span class="lineNum">    1202 </span>            :         /* only do expensive checks if there are any watches at all */</a>
<a name="1203"><span class="lineNum">    1203 </span><span class="lineCov">    1454490 :         if (zend_hash_num_elements(&amp;PHPDBG_G(watch_elements))) {</span></a>
<a name="1204"><span class="lineNum">    1204 </span><span class="lineCov">       2538 :                 if ((result = phpdbg_btree_find(&amp;PHPDBG_G(watchpoint_tree), (zend_ulong) ptr))) {</span></a>
<a name="1205"><span class="lineNum">    1205 </span><span class="lineCov">         45 :                         phpdbg_watchpoint_t *watch = result-&gt;ptr;</span></a>
<a name="1206"><span class="lineNum">    1206 </span><span class="lineCov">         45 :                         if (watch-&gt;type != WATCH_ON_HASHDATA) {</span></a>
<a name="1207"><span class="lineNum">    1207 </span><span class="lineCov">         24 :                                 phpdbg_remove_watchpoint(watch);</span></a>
<a name="1208"><span class="lineNum">    1208 </span>            :                         } else {</a>
<a name="1209"><span class="lineNum">    1209 </span>            :                                 /* remove all linked watchpoints, they will be dissociated from their elements */</a>
<a name="1210"><span class="lineNum">    1210 </span>            :                                 phpdbg_watch_element *element;</a>
<a name="1211"><span class="lineNum">    1211 </span><span class="lineCov">         21 :                                 phpdbg_watch_ht_info *hti = (phpdbg_watch_ht_info *) watch;</span></a>
<a name="1212"><span class="lineNum">    1212 </span>            : </a>
<a name="1213"><span class="lineNum">    1213 </span><span class="lineCov">         42 :                                 ZEND_HASH_MAP_FOREACH_PTR(&amp;hti-&gt;watches, element) {</span></a>
<a name="1214"><span class="lineNum">    1214 </span><span class="lineCov">         21 :                                         zend_ulong num = zend_hash_num_elements(&amp;hti-&gt;watches);</span></a>
<a name="1215"><span class="lineNum">    1215 </span><span class="lineCov">         21 :                                         phpdbg_remove_watchpoint(element-&gt;watch);</span></a>
<a name="1216"><span class="lineNum">    1216 </span><span class="lineCov">         21 :                                         if (num == 1) { /* prevent access into freed memory */</span></a>
<a name="1217"><span class="lineNum">    1217 </span><span class="lineCov">         21 :                                                 break;</span></a>
<a name="1218"><span class="lineNum">    1218 </span>            :                                         }</a>
<a name="1219"><span class="lineNum">    1219 </span>            :                                 } ZEND_HASH_FOREACH_END();</a>
<a name="1220"><span class="lineNum">    1220 </span>            :                         }</a>
<a name="1221"><span class="lineNum">    1221 </span>            :                 }</a>
<a name="1222"><span class="lineNum">    1222 </span>            : </a>
<a name="1223"><span class="lineNum">    1223 </span>            :                 /* special case watchpoints as they aren't on ptr but on ptr + HT_WATCH_OFFSET */</a>
<a name="1224"><span class="lineNum">    1224 </span><span class="lineCov">       2538 :                 if ((result = phpdbg_btree_find(&amp;PHPDBG_G(watchpoint_tree), HT_WATCH_OFFSET + (zend_ulong) ptr))) {</span></a>
<a name="1225"><span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                         phpdbg_watchpoint_t *watch = result-&gt;ptr;</span></a>
<a name="1226"><span class="lineNum">    1226 </span><span class="lineNoCov">          0 :                         if (watch-&gt;type == WATCH_ON_HASHTABLE) {</span></a>
<a name="1227"><span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                                 phpdbg_remove_watchpoint(watch);</span></a>
<a name="1228"><span class="lineNum">    1228 </span>            :                         }</a>
<a name="1229"><span class="lineNum">    1229 </span>            :                 }</a>
<a name="1230"><span class="lineNum">    1230 </span>            : </a>
<a name="1231"><span class="lineNum">    1231 </span><span class="lineCov">       2538 :                 zend_hash_index_del(&amp;PHPDBG_G(watch_free), (zend_ulong) ptr);</span></a>
<a name="1232"><span class="lineNum">    1232 </span>            :         }</a>
<a name="1233"><span class="lineNum">    1233 </span>            : </a>
<a name="1234"><span class="lineNum">    1234 </span><span class="lineCov">    1454490 :         if (PHPDBG_G(original_free_function)) {</span></a>
<a name="1235"><span class="lineNum">    1235 </span><span class="lineNoCov">          0 :                 PHPDBG_G(original_free_function)(ptr);</span></a>
<a name="1236"><span class="lineNum">    1236 </span>            :         }</a>
<a name="1237"><span class="lineNum">    1237 </span><span class="lineCov">    1454490 : }</span></a>
<a name="1238"><span class="lineNum">    1238 </span>            : </a>
<a name="1239"><span class="lineNum">    1239 </span>            : /* ### USER API ### */</a>
<a name="1240"><span class="lineNum">    1240 </span><span class="lineNoCov">          0 : void phpdbg_list_watchpoints(void) {</span></a>
<a name="1241"><span class="lineNum">    1241 </span>            :         phpdbg_watch_element *element;</a>
<a name="1242"><span class="lineNum">    1242 </span>            : </a>
<a name="1243"><span class="lineNum">    1243 </span><span class="lineNoCov">          0 :         ZEND_HASH_FOREACH_PTR(&amp;PHPDBG_G(watch_elements), element) {</span></a>
<a name="1244"><span class="lineNum">    1244 </span><span class="lineNoCov">          0 :                 phpdbg_writeln(&quot;%.*s (%s, %s)&quot;, (int) ZSTR_LEN(element-&gt;str), ZSTR_VAL(element-&gt;str), (element-&gt;flags &amp; (PHPDBG_WATCH_ARRAY|PHPDBG_WATCH_OBJECT)) ? &quot;array&quot; : &quot;variable&quot;, (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE) ? &quot;recursive&quot; : &quot;simple&quot;);</span></a>
<a name="1245"><span class="lineNum">    1245 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="1246"><span class="lineNum">    1246 </span><span class="lineNoCov">          0 : }</span></a>
<a name="1247"><span class="lineNum">    1247 </span>            : </a>
<a name="1248"><span class="lineNum">    1248 </span><span class="lineCov">         15 : static int phpdbg_create_simple_watchpoint(zval *zv, phpdbg_watch_element *element) {</span></a>
<a name="1249"><span class="lineNum">    1249 </span><span class="lineCov">         15 :         element-&gt;flags = PHPDBG_WATCH_SIMPLE;</span></a>
<a name="1250"><span class="lineNum">    1250 </span><span class="lineCov">         15 :         phpdbg_add_bucket_watch_element((Bucket *) zv, element);</span></a>
<a name="1251"><span class="lineNum">    1251 </span><span class="lineCov">         15 :         return SUCCESS;</span></a>
<a name="1252"><span class="lineNum">    1252 </span>            : }</a>
<a name="1253"><span class="lineNum">    1253 </span>            : </a>
<a name="1254"><span class="lineNum">    1254 </span><span class="lineCov">          3 : static int phpdbg_create_array_watchpoint(zval *zv, phpdbg_watch_element *element) {</span></a>
<a name="1255"><span class="lineNum">    1255 </span>            :         phpdbg_watch_element *new;</a>
<a name="1256"><span class="lineNum">    1256 </span>            :         zend_string *str;</a>
<a name="1257"><span class="lineNum">    1257 </span><span class="lineCov">          3 :         zval *orig_zv = zv;</span></a>
<a name="1258"><span class="lineNum">    1258 </span>            : </a>
<a name="1259"><span class="lineNum">    1259 </span><span class="lineCov">          3 :         ZVAL_DEREF(zv);</span></a>
<a name="1260"><span class="lineNum">    1260 </span><span class="lineCov">          3 :         if (Z_TYPE_P(zv) != IS_ARRAY &amp;&amp; Z_TYPE_P(zv) != IS_OBJECT) {</span></a>
<a name="1261"><span class="lineNum">    1261 </span><span class="lineNoCov">          0 :                 return FAILURE;</span></a>
<a name="1262"><span class="lineNum">    1262 </span>            :         }</a>
<a name="1263"><span class="lineNum">    1263 </span>            : </a>
<a name="1264"><span class="lineNum">    1264 </span><span class="lineCov">          3 :         new = ecalloc(1, sizeof(phpdbg_watch_element));</span></a>
<a name="1265"><span class="lineNum">    1265 </span>            : </a>
<a name="1266"><span class="lineNum">    1266 </span><span class="lineCov">          3 :         str = strpprintf(0, &quot;%.*s[]&quot;, (int) ZSTR_LEN(element-&gt;str), ZSTR_VAL(element-&gt;str));</span></a>
<a name="1267"><span class="lineNum">    1267 </span><span class="lineCov">          3 :         zend_string_release(element-&gt;str);</span></a>
<a name="1268"><span class="lineNum">    1268 </span><span class="lineCov">          3 :         element-&gt;str = str;</span></a>
<a name="1269"><span class="lineNum">    1269 </span><span class="lineCov">          3 :         element-&gt;flags = PHPDBG_WATCH_IMPLICIT;</span></a>
<a name="1270"><span class="lineNum">    1270 </span><span class="lineCov">          3 :         phpdbg_add_bucket_watch_element((Bucket *) orig_zv, element);</span></a>
<a name="1271"><span class="lineNum">    1271 </span><span class="lineCov">          3 :         element-&gt;child = new;</span></a>
<a name="1272"><span class="lineNum">    1272 </span>            : </a>
<a name="1273"><span class="lineNum">    1273 </span><span class="lineCov">          3 :         new-&gt;flags = PHPDBG_WATCH_SIMPLE;</span></a>
<a name="1274"><span class="lineNum">    1274 </span><span class="lineCov">          3 :         new-&gt;str = zend_string_copy(str);</span></a>
<a name="1275"><span class="lineNum">    1275 </span><span class="lineCov">          3 :         new-&gt;parent = element;</span></a>
<a name="1276"><span class="lineNum">    1276 </span><span class="lineCov">          3 :         phpdbg_add_ht_watch_element(zv, new);</span></a>
<a name="1277"><span class="lineNum">    1277 </span><span class="lineCov">          3 :         return SUCCESS;</span></a>
<a name="1278"><span class="lineNum">    1278 </span>            : }</a>
<a name="1279"><span class="lineNum">    1279 </span>            : </a>
<a name="1280"><span class="lineNum">    1280 </span><span class="lineCov">          9 : static int phpdbg_create_recursive_watchpoint(zval *zv, phpdbg_watch_element *element) {</span></a>
<a name="1281"><span class="lineNum">    1281 </span><span class="lineCov">          9 :         element-&gt;flags = PHPDBG_WATCH_RECURSIVE | PHPDBG_WATCH_RECURSIVE_ROOT;</span></a>
<a name="1282"><span class="lineNum">    1282 </span><span class="lineCov">          9 :         element-&gt;child = NULL;</span></a>
<a name="1283"><span class="lineNum">    1283 </span><span class="lineCov">          9 :         phpdbg_add_bucket_watch_element((Bucket *) zv, element);</span></a>
<a name="1284"><span class="lineNum">    1284 </span><span class="lineCov">          9 :         return SUCCESS;</span></a>
<a name="1285"><span class="lineNum">    1285 </span>            : }</a>
<a name="1286"><span class="lineNum">    1286 </span>            : </a>
<a name="1287"><span class="lineNum">    1287 </span>            : typedef struct { int (*callback)(zval *zv, phpdbg_watch_element *); zend_string *str; } phpdbg_watch_parse_struct;</a>
<a name="1288"><span class="lineNum">    1288 </span>            : </a>
<a name="1289"><span class="lineNum">    1289 </span><span class="lineCov">         27 : static int phpdbg_watchpoint_parse_wrapper(char *name, size_t namelen, char *key, size_t keylen, HashTable *parent, zval *zv, phpdbg_watch_parse_struct *info) {</span></a>
<a name="1290"><span class="lineNum">    1290 </span>            :         int ret;</a>
<a name="1291"><span class="lineNum">    1291 </span><span class="lineCov">         27 :         phpdbg_watch_element *element = ecalloc(1, sizeof(phpdbg_watch_element));</span></a>
<a name="1292"><span class="lineNum">    1292 </span><span class="lineCov">         27 :         element-&gt;str = zend_string_init(name, namelen, 0);</span></a>
<a name="1293"><span class="lineNum">    1293 </span><span class="lineCov">         27 :         element-&gt;name_in_parent = zend_string_init(key, keylen, 0);</span></a>
<a name="1294"><span class="lineNum">    1294 </span><span class="lineCov">         27 :         element-&gt;parent_container = parent;</span></a>
<a name="1295"><span class="lineNum">    1295 </span><span class="lineCov">         27 :         element-&gt;parent = PHPDBG_G(watch_tmp);</span></a>
<a name="1296"><span class="lineNum">    1296 </span><span class="lineCov">         27 :         element-&gt;child = NULL;</span></a>
<a name="1297"><span class="lineNum">    1297 </span>            : </a>
<a name="1298"><span class="lineNum">    1298 </span><span class="lineCov">         27 :         ret = info-&gt;callback(zv, element);</span></a>
<a name="1299"><span class="lineNum">    1299 </span>            : </a>
<a name="1300"><span class="lineNum">    1300 </span><span class="lineCov">         27 :         efree(name);</span></a>
<a name="1301"><span class="lineNum">    1301 </span><span class="lineCov">         27 :         efree(key);</span></a>
<a name="1302"><span class="lineNum">    1302 </span>            : </a>
<a name="1303"><span class="lineNum">    1303 </span><span class="lineCov">         27 :         if (ret != SUCCESS) {</span></a>
<a name="1304"><span class="lineNum">    1304 </span><span class="lineNoCov">          0 :                 phpdbg_remove_watch_element(element);</span></a>
<a name="1305"><span class="lineNum">    1305 </span>            :         } else {</a>
<a name="1306"><span class="lineNum">    1306 </span><span class="lineCov">         27 :                 if (PHPDBG_G(watch_tmp)) {</span></a>
<a name="1307"><span class="lineNum">    1307 </span><span class="lineCov">          9 :                         PHPDBG_G(watch_tmp)-&gt;child = element;</span></a>
<a name="1308"><span class="lineNum">    1308 </span>            :                 }</a>
<a name="1309"><span class="lineNum">    1309 </span>            : </a>
<a name="1310"><span class="lineNum">    1310 </span><span class="lineCov">         27 :                 if (element-&gt;child) {</span></a>
<a name="1311"><span class="lineNum">    1311 </span><span class="lineCov">          3 :                         element = element-&gt;child;</span></a>
<a name="1312"><span class="lineNum">    1312 </span>            :                 }</a>
<a name="1313"><span class="lineNum">    1313 </span>            : </a>
<a name="1314"><span class="lineNum">    1314 </span>            :                 /* work around missing API for extending an array with a new element, and getting its index */</a>
<a name="1315"><span class="lineNum">    1315 </span>            :                 zend_hash_next_index_insert_ptr(&amp;PHPDBG_G(watch_elements), element);</a>
<a name="1316"><span class="lineNum">    1316 </span><span class="lineCov">         27 :                 element-&gt;id = PHPDBG_G(watch_elements).nNextFreeElement - 1;</span></a>
<a name="1317"><span class="lineNum">    1317 </span>            : </a>
<a name="1318"><span class="lineNum">    1318 </span><span class="lineCov">         27 :                 phpdbg_notice(&quot;Added%s watchpoint #%u for %.*s&quot;, (element-&gt;flags &amp; PHPDBG_WATCH_RECURSIVE_ROOT) ? &quot; recursive&quot; : &quot;&quot;, element-&gt;id, (int) ZSTR_LEN(element-&gt;str), ZSTR_VAL(element-&gt;str));</span></a>
<a name="1319"><span class="lineNum">    1319 </span>            :         }</a>
<a name="1320"><span class="lineNum">    1320 </span>            : </a>
<a name="1321"><span class="lineNum">    1321 </span><span class="lineCov">         27 :         PHPDBG_G(watch_tmp) = NULL;</span></a>
<a name="1322"><span class="lineNum">    1322 </span>            : </a>
<a name="1323"><span class="lineNum">    1323 </span><span class="lineCov">         27 :         return ret;</span></a>
<a name="1324"><span class="lineNum">    1324 </span>            : }</a>
<a name="1325"><span class="lineNum">    1325 </span>            : </a>
<a name="1326"><span class="lineNum">    1326 </span><span class="lineNoCov">          0 : PHPDBG_API int phpdbg_watchpoint_parse_input(char *input, size_t len, HashTable *parent, size_t i, phpdbg_watch_parse_struct *info, bool silent) {</span></a>
<a name="1327"><span class="lineNum">    1327 </span><span class="lineNoCov">          0 :         return phpdbg_parse_variable_with_arg(input, len, parent, i, (phpdbg_parse_var_with_arg_func) phpdbg_watchpoint_parse_wrapper, NULL, 0, info);</span></a>
<a name="1328"><span class="lineNum">    1328 </span>            : }</a>
<a name="1329"><span class="lineNum">    1329 </span>            : </a>
<a name="1330"><span class="lineNum">    1330 </span><span class="lineCov">          9 : static int phpdbg_watchpoint_parse_step(char *name, size_t namelen, char *key, size_t keylen, HashTable *parent, zval *zv, phpdbg_watch_parse_struct *info) {</span></a>
<a name="1331"><span class="lineNum">    1331 </span>            :         phpdbg_watch_element *element;</a>
<a name="1332"><span class="lineNum">    1332 </span>            : </a>
<a name="1333"><span class="lineNum">    1333 </span>            :         /* do not install watch elements for references */</a>
<a name="1334"><span class="lineNum">    1334 </span><span class="lineCov">          9 :         if (PHPDBG_G(watch_tmp) &amp;&amp; Z_ISREF_P(PHPDBG_G(watch_tmp)-&gt;watch-&gt;addr.zv) &amp;&amp; Z_REFVAL_P(PHPDBG_G(watch_tmp)-&gt;watch-&gt;addr.zv) == zv) {</span></a>
<a name="1335"><span class="lineNum">    1335 </span><span class="lineNoCov">          0 :                 efree(name);</span></a>
<a name="1336"><span class="lineNum">    1336 </span><span class="lineNoCov">          0 :                 efree(key);</span></a>
<a name="1337"><span class="lineNum">    1337 </span><span class="lineNoCov">          0 :                 return SUCCESS;</span></a>
<a name="1338"><span class="lineNum">    1338 </span>            :         }</a>
<a name="1339"><span class="lineNum">    1339 </span>            : </a>
<a name="1340"><span class="lineNum">    1340 </span><span class="lineCov">          9 :         element = ecalloc(1, sizeof(phpdbg_watch_element));</span></a>
<a name="1341"><span class="lineNum">    1341 </span><span class="lineCov">          9 :         element-&gt;flags = PHPDBG_WATCH_IMPLICIT;</span></a>
<a name="1342"><span class="lineNum">    1342 </span><span class="lineCov">         18 :         element-&gt;str = zend_string_copy(info-&gt;str);</span></a>
<a name="1343"><span class="lineNum">    1343 </span><span class="lineCov">          9 :         element-&gt;name_in_parent = zend_string_init(key, keylen, 0);</span></a>
<a name="1344"><span class="lineNum">    1344 </span><span class="lineCov">          9 :         element-&gt;parent_container = parent;</span></a>
<a name="1345"><span class="lineNum">    1345 </span><span class="lineCov">          9 :         element-&gt;parent = PHPDBG_G(watch_tmp);</span></a>
<a name="1346"><span class="lineNum">    1346 </span><span class="lineCov">          9 :         element = phpdbg_add_bucket_watch_element((Bucket *) zv, element);</span></a>
<a name="1347"><span class="lineNum">    1347 </span>            : </a>
<a name="1348"><span class="lineNum">    1348 </span><span class="lineCov">          9 :         efree(name);</span></a>
<a name="1349"><span class="lineNum">    1349 </span><span class="lineCov">          9 :         efree(key);</span></a>
<a name="1350"><span class="lineNum">    1350 </span>            : </a>
<a name="1351"><span class="lineNum">    1351 </span><span class="lineCov">          9 :         if (PHPDBG_G(watch_tmp)) {</span></a>
<a name="1352"><span class="lineNum">    1352 </span><span class="lineNoCov">          0 :                 PHPDBG_G(watch_tmp)-&gt;child = element;</span></a>
<a name="1353"><span class="lineNum">    1353 </span>            :         }</a>
<a name="1354"><span class="lineNum">    1354 </span><span class="lineCov">          9 :         PHPDBG_G(watch_tmp) = element;</span></a>
<a name="1355"><span class="lineNum">    1355 </span>            : </a>
<a name="1356"><span class="lineNum">    1356 </span><span class="lineCov">          9 :         return SUCCESS;</span></a>
<a name="1357"><span class="lineNum">    1357 </span>            : }</a>
<a name="1358"><span class="lineNum">    1358 </span>            : </a>
<a name="1359"><span class="lineNum">    1359 </span><span class="lineCov">         27 : static int phpdbg_watchpoint_parse_symtables(char *input, size_t len, int (*callback)(zval *, phpdbg_watch_element *)) {</span></a>
<a name="1360"><span class="lineNum">    1360 </span><span class="lineCov">         27 :         zend_class_entry *scope = zend_get_executed_scope();</span></a>
<a name="1361"><span class="lineNum">    1361 </span>            :         phpdbg_watch_parse_struct info;</a>
<a name="1362"><span class="lineNum">    1362 </span>            :         int ret;</a>
<a name="1363"><span class="lineNum">    1363 </span>            : </a>
<a name="1364"><span class="lineNum">    1364 </span><span class="lineCov">         27 :         if (scope &amp;&amp; len &gt;= 5 &amp;&amp; !memcmp(&quot;$this&quot;, input, 5)) {</span></a>
<a name="1365"><span class="lineNum">    1365 </span><span class="lineNoCov">          0 :                 zend_hash_str_add(EG(current_execute_data)-&gt;symbol_table, ZEND_STRL(&quot;this&quot;), &amp;EG(current_execute_data)-&gt;This);</span></a>
<a name="1366"><span class="lineNum">    1366 </span>            :         }</a>
<a name="1367"><span class="lineNum">    1367 </span>            : </a>
<a name="1368"><span class="lineNum">    1368 </span><span class="lineCov">         27 :         if (callback == phpdbg_create_array_watchpoint) {</span></a>
<a name="1369"><span class="lineNum">    1369 </span><span class="lineCov">          3 :                 info.str = strpprintf(0, &quot;%.*s[]&quot;, (int) len, input);</span></a>
<a name="1370"><span class="lineNum">    1370 </span>            :         } else {</a>
<a name="1371"><span class="lineNum">    1371 </span><span class="lineCov">         24 :                 info.str = zend_string_init(input, len, 0);</span></a>
<a name="1372"><span class="lineNum">    1372 </span>            :         }</a>
<a name="1373"><span class="lineNum">    1373 </span><span class="lineCov">         27 :         info.callback = callback;</span></a>
<a name="1374"><span class="lineNum">    1374 </span>            : </a>
<a name="1375"><span class="lineNum">    1375 </span><span class="lineCov">         27 :         if (phpdbg_is_auto_global(input, len) &amp;&amp; phpdbg_watchpoint_parse_input(input, len, &amp;EG(symbol_table), 0, &amp;info, 1) != FAILURE) {</span></a>
<a name="1376"><span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                 zend_string_release(info.str);</span></a>
<a name="1377"><span class="lineNum">    1377 </span><span class="lineNoCov">          0 :                 return SUCCESS;</span></a>
<a name="1378"><span class="lineNum">    1378 </span>            :         }</a>
<a name="1379"><span class="lineNum">    1379 </span>            : </a>
<a name="1380"><span class="lineNum">    1380 </span><span class="lineCov">         27 :         ret = phpdbg_parse_variable_with_arg(input, len, EG(current_execute_data)-&gt;symbol_table, 0, (phpdbg_parse_var_with_arg_func) phpdbg_watchpoint_parse_wrapper, (phpdbg_parse_var_with_arg_func) phpdbg_watchpoint_parse_step, 0, &amp;info);</span></a>
<a name="1381"><span class="lineNum">    1381 </span>            : </a>
<a name="1382"><span class="lineNum">    1382 </span><span class="lineCov">         27 :         zend_string_release(info.str);</span></a>
<a name="1383"><span class="lineNum">    1383 </span><span class="lineCov">         27 :         return ret;</span></a>
<a name="1384"><span class="lineNum">    1384 </span>            : }</a>
<a name="1385"><span class="lineNum">    1385 </span>            : </a>
<a name="1386"><span class="lineNum">    1386 </span><span class="lineNoCov">          0 : PHPDBG_WATCH(delete) /* {{{ */</span></a>
<a name="1387"><span class="lineNum">    1387 </span>            : {</a>
<a name="1388"><span class="lineNum">    1388 </span>            :         phpdbg_watch_element *element;</a>
<a name="1389"><span class="lineNum">    1389 </span><span class="lineNoCov">          0 :         switch (param-&gt;type) {</span></a>
<a name="1390"><span class="lineNum">    1390 </span><span class="lineNoCov">          0 :                 case NUMERIC_PARAM:</span></a>
<a name="1391"><span class="lineNum">    1391 </span><span class="lineNoCov">          0 :                         if ((element = zend_hash_index_find_ptr(&amp;PHPDBG_G(watch_elements), param-&gt;num))) {</span></a>
<a name="1392"><span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                                 phpdbg_remove_watch_element(element);</span></a>
<a name="1393"><span class="lineNum">    1393 </span><span class="lineNoCov">          0 :                                 phpdbg_notice(&quot;Removed watchpoint %d&quot;, (int) param-&gt;num);</span></a>
<a name="1394"><span class="lineNum">    1394 </span>            :                         } else {</a>
<a name="1395"><span class="lineNum">    1395 </span><span class="lineNoCov">          0 :                                 phpdbg_error(&quot;Nothing was deleted, no corresponding watchpoint found&quot;);</span></a>
<a name="1396"><span class="lineNum">    1396 </span>            :                         }</a>
<a name="1397"><span class="lineNum">    1397 </span><span class="lineNoCov">          0 :                         break;</span></a>
<a name="1398"><span class="lineNum">    1398 </span>            : </a>
<a name="1399"><span class="lineNum">    1399 </span><span class="lineNoCov">          0 :                 phpdbg_default_switch_case();</span></a>
<a name="1400"><span class="lineNum">    1400 </span>            :         }</a>
<a name="1401"><span class="lineNum">    1401 </span>            : </a>
<a name="1402"><span class="lineNum">    1402 </span><span class="lineNoCov">          0 :         return SUCCESS;</span></a>
<a name="1403"><span class="lineNum">    1403 </span>            : } /* }}} */</a>
<a name="1404"><span class="lineNum">    1404 </span>            : </a>
<a name="1405"><span class="lineNum">    1405 </span><span class="lineCov">         15 : int phpdbg_create_var_watchpoint(char *input, size_t len) {</span></a>
<a name="1406"><span class="lineNum">    1406 </span><span class="lineCov">         15 :         if (phpdbg_rebuild_symtable() == FAILURE) {</span></a>
<a name="1407"><span class="lineNum">    1407 </span><span class="lineNoCov">          0 :                 return FAILURE;</span></a>
<a name="1408"><span class="lineNum">    1408 </span>            :         }</a>
<a name="1409"><span class="lineNum">    1409 </span>            : </a>
<a name="1410"><span class="lineNum">    1410 </span><span class="lineCov">         15 :         return phpdbg_watchpoint_parse_symtables(input, len, phpdbg_create_simple_watchpoint);</span></a>
<a name="1411"><span class="lineNum">    1411 </span>            : }</a>
<a name="1412"><span class="lineNum">    1412 </span>            : </a>
<a name="1413"><span class="lineNum">    1413 </span><span class="lineCov">          9 : PHPDBG_WATCH(recursive) /* {{{ */</span></a>
<a name="1414"><span class="lineNum">    1414 </span>            : {</a>
<a name="1415"><span class="lineNum">    1415 </span><span class="lineCov">          9 :         if (phpdbg_rebuild_symtable() == FAILURE) {</span></a>
<a name="1416"><span class="lineNum">    1416 </span><span class="lineNoCov">          0 :                 return SUCCESS;</span></a>
<a name="1417"><span class="lineNum">    1417 </span>            :         }</a>
<a name="1418"><span class="lineNum">    1418 </span>            : </a>
<a name="1419"><span class="lineNum">    1419 </span><span class="lineCov">          9 :         switch (param-&gt;type) {</span></a>
<a name="1420"><span class="lineNum">    1420 </span><span class="lineCov">          9 :                 case STR_PARAM:</span></a>
<a name="1421"><span class="lineNum">    1421 </span><span class="lineCov">          9 :                         phpdbg_watchpoint_parse_symtables(param-&gt;str, param-&gt;len, phpdbg_create_recursive_watchpoint);</span></a>
<a name="1422"><span class="lineNum">    1422 </span><span class="lineCov">          9 :                         break;</span></a>
<a name="1423"><span class="lineNum">    1423 </span>            : </a>
<a name="1424"><span class="lineNum">    1424 </span><span class="lineNoCov">          0 :                 phpdbg_default_switch_case();</span></a>
<a name="1425"><span class="lineNum">    1425 </span>            :         }</a>
<a name="1426"><span class="lineNum">    1426 </span>            : </a>
<a name="1427"><span class="lineNum">    1427 </span><span class="lineCov">          9 :         return SUCCESS;</span></a>
<a name="1428"><span class="lineNum">    1428 </span>            : } /* }}} */</a>
<a name="1429"><span class="lineNum">    1429 </span>            : </a>
<a name="1430"><span class="lineNum">    1430 </span><span class="lineCov">          3 : PHPDBG_WATCH(array) /* {{{ */</span></a>
<a name="1431"><span class="lineNum">    1431 </span>            : {</a>
<a name="1432"><span class="lineNum">    1432 </span><span class="lineCov">          3 :         if (phpdbg_rebuild_symtable() == FAILURE) {</span></a>
<a name="1433"><span class="lineNum">    1433 </span><span class="lineNoCov">          0 :                 return SUCCESS;</span></a>
<a name="1434"><span class="lineNum">    1434 </span>            :         }</a>
<a name="1435"><span class="lineNum">    1435 </span>            : </a>
<a name="1436"><span class="lineNum">    1436 </span><span class="lineCov">          3 :         switch (param-&gt;type) {</span></a>
<a name="1437"><span class="lineNum">    1437 </span><span class="lineCov">          3 :                 case STR_PARAM:</span></a>
<a name="1438"><span class="lineNum">    1438 </span><span class="lineCov">          3 :                         phpdbg_watchpoint_parse_symtables(param-&gt;str, param-&gt;len, phpdbg_create_array_watchpoint);</span></a>
<a name="1439"><span class="lineNum">    1439 </span><span class="lineCov">          3 :                         break;</span></a>
<a name="1440"><span class="lineNum">    1440 </span>            : </a>
<a name="1441"><span class="lineNum">    1441 </span><span class="lineNoCov">          0 :                 phpdbg_default_switch_case();</span></a>
<a name="1442"><span class="lineNum">    1442 </span>            :         }</a>
<a name="1443"><span class="lineNum">    1443 </span>            : </a>
<a name="1444"><span class="lineNum">    1444 </span><span class="lineCov">          3 :         return SUCCESS;</span></a>
<a name="1445"><span class="lineNum">    1445 </span>            : } /* }}} */</a>
<a name="1446"><span class="lineNum">    1446 </span>            : </a>
<a name="1447"><span class="lineNum">    1447 </span>            : </a>
<a name="1448"><span class="lineNum">    1448 </span><span class="lineCov">        286 : void phpdbg_setup_watchpoints(void) {</span></a>
<a name="1449"><span class="lineNum">    1449 </span>            : #if defined(_SC_PAGE_SIZE)</a>
<a name="1450"><span class="lineNum">    1450 </span><span class="lineCov">        286 :         phpdbg_pagesize = sysconf(_SC_PAGE_SIZE);</span></a>
<a name="1451"><span class="lineNum">    1451 </span>            : #elif defined(_SC_PAGESIZE)</a>
<a name="1452"><span class="lineNum">    1452 </span>            :         phpdbg_pagesize = sysconf(_SC_PAGESIZE);</a>
<a name="1453"><span class="lineNum">    1453 </span>            : #elif defined(_SC_NUTC_OS_PAGESIZE)</a>
<a name="1454"><span class="lineNum">    1454 </span>            :         phpdbg_pagesize = sysconf(_SC_NUTC_OS_PAGESIZE);</a>
<a name="1455"><span class="lineNum">    1455 </span>            : #else</a>
<a name="1456"><span class="lineNum">    1456 </span>            :         phpdbg_pagesize = 4096; /* common pagesize */</a>
<a name="1457"><span class="lineNum">    1457 </span>            : #endif</a>
<a name="1458"><span class="lineNum">    1458 </span>            : </a>
<a name="1459"><span class="lineNum">    1459 </span><span class="lineCov">        286 :         phpdbg_btree_init(&amp;PHPDBG_G(watchpoint_tree), sizeof(void *) * 8);</span></a>
<a name="1460"><span class="lineNum">    1460 </span><span class="lineCov">        286 :         phpdbg_btree_init(&amp;PHPDBG_G(watch_HashTables), sizeof(void *) * 8);</span></a>
<a name="1461"><span class="lineNum">    1461 </span><span class="lineCov">        286 :         zend_hash_init(&amp;PHPDBG_G(watch_elements), 8, NULL, NULL, 0);</span></a>
<a name="1462"><span class="lineNum">    1462 </span><span class="lineCov">        286 :         zend_hash_init(&amp;PHPDBG_G(watch_collisions), 8, NULL, NULL, 0);</span></a>
<a name="1463"><span class="lineNum">    1463 </span><span class="lineCov">        286 :         zend_hash_init(&amp;PHPDBG_G(watch_recreation), 8, NULL, NULL, 0);</span></a>
<a name="1464"><span class="lineNum">    1464 </span><span class="lineCov">        286 :         zend_hash_init(&amp;PHPDBG_G(watch_free), 8, NULL, NULL, 0);</span></a>
<a name="1465"><span class="lineNum">    1465 </span>            : </a>
<a name="1466"><span class="lineNum">    1466 </span>            :         /* put these on a separate page, to avoid conflicts with other memory */</a>
<a name="1467"><span class="lineNum">    1467 </span><span class="lineCov">        286 :         PHPDBG_G(watchlist_mem) = malloc(phpdbg_pagesize &gt; sizeof(HashTable) ? phpdbg_pagesize : sizeof(HashTable));</span></a>
<a name="1468"><span class="lineNum">    1468 </span><span class="lineCov">        286 :         zend_hash_init(PHPDBG_G(watchlist_mem), phpdbg_pagesize / (sizeof(Bucket) + sizeof(uint32_t)), NULL, NULL, 1);</span></a>
<a name="1469"><span class="lineNum">    1469 </span><span class="lineCov">        286 :         PHPDBG_G(watchlist_mem_backup) = malloc(phpdbg_pagesize &gt; sizeof(HashTable) ? phpdbg_pagesize : sizeof(HashTable));</span></a>
<a name="1470"><span class="lineNum">    1470 </span><span class="lineCov">        286 :         zend_hash_init(PHPDBG_G(watchlist_mem_backup), phpdbg_pagesize / (sizeof(Bucket) + sizeof(uint32_t)), NULL, NULL, 1);</span></a>
<a name="1471"><span class="lineNum">    1471 </span>            : </a>
<a name="1472"><span class="lineNum">    1472 </span><span class="lineCov">        286 :         PHPDBG_G(watch_tmp) = NULL;</span></a>
<a name="1473"><span class="lineNum">    1473 </span>            : </a>
<a name="1474"><span class="lineNum">    1474 </span>            : #ifdef HAVE_USERFAULTFD_WRITEFAULT</a>
<a name="1475"><span class="lineNum">    1475 </span>            :         PHPDBG_G(watch_userfaultfd) = syscall(SYS_userfaultfd, O_CLOEXEC);</a>
<a name="1476"><span class="lineNum">    1476 </span>            :         if (PHPDBG_G(watch_userfaultfd) &lt; 0) {</a>
<a name="1477"><span class="lineNum">    1477 </span>            :                 PHPDBG_G(watch_userfaultfd) = 0;</a>
<a name="1478"><span class="lineNum">    1478 </span>            :         } else {</a>
<a name="1479"><span class="lineNum">    1479 </span>            :                 struct uffdio_api userfaultfd_features = {0};</a>
<a name="1480"><span class="lineNum">    1480 </span>            :                 userfaultfd_features.api = UFFD_API;</a>
<a name="1481"><span class="lineNum">    1481 </span>            :                 userfaultfd_features.features = UFFD_FEATURE_PAGEFAULT_FLAG_WP;</a>
<a name="1482"><span class="lineNum">    1482 </span>            :                 ioctl(PHPDBG_G(watch_userfaultfd), UFFDIO_API, &amp;userfaultfd_features);</a>
<a name="1483"><span class="lineNum">    1483 </span>            :                 if (userfaultfd_features.features &amp; UFFD_FEATURE_PAGEFAULT_FLAG_WP) {</a>
<a name="1484"><span class="lineNum">    1484 </span>            :                         pthread_create(&amp;PHPDBG_G(watch_userfault_thread), NULL, phpdbg_watchpoint_userfaultfd_thread, ZEND_MODULE_GLOBALS_BULK(phpdbg));</a>
<a name="1485"><span class="lineNum">    1485 </span>            :                 } else {</a>
<a name="1486"><span class="lineNum">    1486 </span>            :                         PHPDBG_G(watch_userfaultfd) = 0;</a>
<a name="1487"><span class="lineNum">    1487 </span>            :                 }</a>
<a name="1488"><span class="lineNum">    1488 </span>            :         }</a>
<a name="1489"><span class="lineNum">    1489 </span>            : #endif</a>
<a name="1490"><span class="lineNum">    1490 </span><span class="lineCov">        286 : }</span></a>
<a name="1491"><span class="lineNum">    1491 </span>            : </a>
<a name="1492"><span class="lineNum">    1492 </span><span class="lineCov">        286 : void phpdbg_destroy_watchpoints(void) {</span></a>
<a name="1493"><span class="lineNum">    1493 </span>            :         phpdbg_watch_element *element;</a>
<a name="1494"><span class="lineNum">    1494 </span>            : </a>
<a name="1495"><span class="lineNum">    1495 </span>            :         /* unconditionally free all remaining elements to avoid memory leaks */</a>
<a name="1496"><span class="lineNum">    1496 </span><span class="lineCov">        346 :         ZEND_HASH_MAP_FOREACH_PTR(&amp;PHPDBG_G(watch_recreation), element) {</span></a>
<a name="1497"><span class="lineNum">    1497 </span><span class="lineCov">         30 :                 phpdbg_automatic_dequeue_free(element);</span></a>
<a name="1498"><span class="lineNum">    1498 </span>            :         } ZEND_HASH_FOREACH_END();</a>
<a name="1499"><span class="lineNum">    1499 </span>            : </a>
<a name="1500"><span class="lineNum">    1500 </span>            :         /* upon fatal errors etc. (i.e. CG(unclean_shutdown) == 1), some watchpoints may still be active. Ensure memory is not watched anymore for next run. Do not care about memory freeing here, shutdown is unclean and near anyway. */</a>
<a name="1501"><span class="lineNum">    1501 </span><span class="lineCov">        286 :     phpdbg_purge_watchpoint_tree();</span></a>
<a name="1502"><span class="lineNum">    1502 </span>            : </a>
<a name="1503"><span class="lineNum">    1503 </span>            : #ifdef HAVE_USERFAULTFD_WRITEFAULT</a>
<a name="1504"><span class="lineNum">    1504 </span>            :         if (PHPDBG_G(watch_userfaultfd)) {</a>
<a name="1505"><span class="lineNum">    1505 </span>            :                 pthread_cancel(PHPDBG_G(watch_userfault_thread));</a>
<a name="1506"><span class="lineNum">    1506 </span>            :                 close(PHPDBG_G(watch_userfaultfd));</a>
<a name="1507"><span class="lineNum">    1507 </span>            :         }</a>
<a name="1508"><span class="lineNum">    1508 </span>            : #endif</a>
<a name="1509"><span class="lineNum">    1509 </span>            : </a>
<a name="1510"><span class="lineNum">    1510 </span><span class="lineCov">        286 :         zend_hash_destroy(&amp;PHPDBG_G(watch_elements)); PHPDBG_G(watch_elements).nNumOfElements = 0; /* phpdbg_watch_efree() is checking against this arrays size */</span></a>
<a name="1511"><span class="lineNum">    1511 </span><span class="lineCov">        286 :         zend_hash_destroy(&amp;PHPDBG_G(watch_recreation));</span></a>
<a name="1512"><span class="lineNum">    1512 </span><span class="lineCov">        286 :         zend_hash_destroy(&amp;PHPDBG_G(watch_free));</span></a>
<a name="1513"><span class="lineNum">    1513 </span><span class="lineCov">        286 :         zend_hash_destroy(&amp;PHPDBG_G(watch_collisions));</span></a>
<a name="1514"><span class="lineNum">    1514 </span><span class="lineCov">        286 :         zend_hash_destroy(PHPDBG_G(watchlist_mem));</span></a>
<a name="1515"><span class="lineNum">    1515 </span><span class="lineCov">        286 :         free(PHPDBG_G(watchlist_mem));</span></a>
<a name="1516"><span class="lineNum">    1516 </span><span class="lineCov">        286 :         zend_hash_destroy(PHPDBG_G(watchlist_mem_backup));</span></a>
<a name="1517"><span class="lineNum">    1517 </span><span class="lineCov">        286 :         free(PHPDBG_G(watchlist_mem_backup));</span></a>
<a name="1518"><span class="lineNum">    1518 </span><span class="lineCov">        286 : }</span></a>
<a name="1519"><span class="lineNum">    1519 </span>            : </a>
<a name="1520"><span class="lineNum">    1520 </span><span class="lineCov">        572 : void phpdbg_purge_watchpoint_tree(void) {</span></a>
<a name="1521"><span class="lineNum">    1521 </span>            :         phpdbg_btree_position pos;</a>
<a name="1522"><span class="lineNum">    1522 </span>            :         phpdbg_btree_result *res;</a>
<a name="1523"><span class="lineNum">    1523 </span>            : </a>
<a name="1524"><span class="lineNum">    1524 </span><span class="lineCov">        572 :         pos = phpdbg_btree_find_between(&amp;PHPDBG_G(watchpoint_tree), 0, -1);</span></a>
<a name="1525"><span class="lineNum">    1525 </span><span class="lineCov">        710 :         while ((res = phpdbg_btree_next(&amp;pos))) {</span></a>
<a name="1526"><span class="lineNum">    1526 </span><span class="lineCov">        138 :                 phpdbg_deactivate_watchpoint(res-&gt;ptr);</span></a>
<a name="1527"><span class="lineNum">    1527 </span>            :         }</a>
<a name="1528"><span class="lineNum">    1528 </span><span class="lineCov">        572 : }</span></a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.14</a></td></tr>
  </table>
  <br>

</body>
</html>
